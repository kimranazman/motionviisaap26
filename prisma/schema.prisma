// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// Enums
enum InitiativeStatus {
  NOT_STARTED
  IN_PROGRESS
  ON_HOLD
  AT_RISK
  COMPLETED
  CANCELLED
}

enum Objective {
  OBJ1_SCALE_EVENTS
  OBJ2_BUILD_AI_TRAINING
}

enum Department {
  BIZ_DEV
  OPERATIONS
  FINANCE
  MARKETING
}

enum TeamMember {
  KHAIRUL
  AZLAN
  IZYANI
}

// Models
model Initiative {
  id                    String           @id @default(cuid())
  sequenceNumber        Int              @unique
  objective             Objective
  keyResult             String           @db.VarChar(20)
  department            Department
  title                 String           @db.VarChar(500)
  monthlyObjective      String?          @db.Text
  weeklyTasks           String?          @db.Text
  startDate             DateTime
  endDate               DateTime
  resourcesFinancial    Decimal?         @db.Decimal(12, 2)
  resourcesNonFinancial String?          @db.Text
  personInCharge        TeamMember?
  accountable           TeamMember?
  status                InitiativeStatus @default(NOT_STARTED)
  remarks               String?          @db.Text
  position              Int              @default(0) // For Kanban ordering

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  comments Comment[]
  projects Project[] // Projects linked to this KRI (v1.2)

  @@index([status])
  @@index([department])
  @@index([objective])
  @@index([personInCharge])
  @@index([startDate, endDate])
  @@map("initiatives")
}

model Comment {
  id           String     @id @default(cuid())
  content      String     @db.Text
  userId       String     @map("user_id")
  user         User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  initiativeId String
  initiative   Initiative @relation(fields: [initiativeId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([initiativeId])
  @@index([userId])
  @@index([createdAt])
  @@map("comments")
}

model Event {
  id        String    @id @default(cuid())
  name      String    @db.VarChar(255)
  client    String    @db.VarChar(255)
  eventDate DateTime?
  revenue   Decimal?  @db.Decimal(12, 2)
  cost      Decimal?  @db.Decimal(12, 2)
  status    String    @db.VarChar(50)
  remarks   String?   @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([eventDate])
  @@index([status])
  @@map("events")
}

// Industry events to attend for networking/business development
enum EventPriority {
  TIER_1
  TIER_2
  TIER_3
  ENERGY
}

enum EventCategory {
  EVENTS
  AI_TRAINING
  BOTH
}

enum EventStatus {
  PLANNED
  REGISTERED
  ATTENDED
  CANCELLED
  SKIPPED
}

model EventToAttend {
  id              String        @id @default(cuid())
  priority        EventPriority
  name            String        @db.VarChar(255)
  category        EventCategory
  eventDate       String        @db.VarChar(100) // Flexible date format from Excel
  location        String        @db.VarChar(255)
  estimatedCost   Decimal?      @db.Decimal(12, 2)
  whyAttend       String?       @db.Text
  targetCompanies String?       @db.Text
  actionRequired  String?       @db.VarChar(255)
  status          EventStatus   @default(PLANNED)
  remarks         String?       @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([priority])
  @@index([category])
  @@index([status])
  @@map("events_to_attend")
}

// ============================================================
// Auth.js Models
// ============================================================

enum UserRole {
  ADMIN
  EDITOR
  VIEWER
}

// ============================================================
// CRM & Project Financials Enums (v1.2)
// ============================================================

// Pipeline stages for new business deals
enum DealStage {
  LEAD
  QUALIFIED
  PROPOSAL
  NEGOTIATION
  WON
  LOST
}

// Pipeline stages for repeat client opportunities
enum PotentialStage {
  POTENTIAL
  CONFIRMED
  CANCELLED
}

// Project lifecycle status
enum ProjectStatus {
  DRAFT
  ACTIVE
  COMPLETED
  CANCELLED
}

// Document categories for project files (v1.3)
enum DocumentCategory {
  RECEIPT
  INVOICE
  OTHER
}

// Document AI analysis status (v1.3 - AI Document Intelligence)
enum DocumentAIStatus {
  PENDING // Document uploaded but not yet analyzed by AI
  ANALYZED // AI has extracted data, awaiting user review
  IMPORTED // User confirmed and data imported to costs/revenue
  FAILED // AI analysis failed (unparseable document)
}

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String?   @unique
  emailVerified DateTime? @map("email_verified")
  image         String?
  role          UserRole  @default(VIEWER)

  accounts    Account[]
  sessions    Session[]
  comments    Comment[]
  documents   Document[]
  preferences UserPreferences?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("users")
}

model Account {
  id                String  @id @default(cuid())
  userId            String  @map("user_id")
  type              String
  provider          String
  providerAccountId String  @map("provider_account_id")
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique @map("session_token")
  userId       String   @map("user_id")
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

// ============================================================
// CRM & Project Financials Models (v1.2)
// ============================================================

// Company (client organization)
model Company {
  id       String  @id @default(cuid())
  name     String  @db.VarChar(255)
  industry String? @db.VarChar(100)
  website  String? @db.VarChar(255)
  address  String? @db.Text
  phone    String? @db.VarChar(50)
  notes    String? @db.Text

  contacts   Contact[]
  deals      Deal[]
  potentials PotentialProject[]
  projects   Project[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([name])
  @@map("companies")
}

// Contact (person at a company)
model Contact {
  id        String  @id @default(cuid())
  companyId String  @map("company_id")
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  name      String  @db.VarChar(255)
  email     String? @db.VarChar(255)
  phone     String? @db.VarChar(50)
  role      String? @db.VarChar(100)
  isPrimary Boolean @default(false) @map("is_primary")

  deals      Deal[]
  potentials PotentialProject[]
  projects   Project[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([companyId])
  @@map("contacts")
}

// Deal (new business pipeline opportunity)
model Deal {
  id          String   @id @default(cuid())
  title       String   @db.VarChar(255)
  description String?  @db.Text
  value       Decimal? @db.Decimal(12, 2)

  stage          DealStage @default(LEAD)
  stageChangedAt DateTime  @default(now()) @map("stage_changed_at")
  lostReason     String?   @map("lost_reason") @db.Text

  companyId String  @map("company_id")
  company   Company @relation(fields: [companyId], references: [id])

  contactId String?  @map("contact_id")
  contact   Contact? @relation(fields: [contactId], references: [id])

  // Link to created project (set when stage moves to WON)
  projectId String?  @unique @map("project_id")
  project   Project? @relation("DealToProject", fields: [projectId], references: [id])

  position Int @default(0) // Kanban ordering within stage

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([companyId])
  @@index([contactId])
  @@index([stage])
  @@map("deals")
}

// PotentialProject (repeat client pipeline opportunity)
model PotentialProject {
  id             String   @id @default(cuid())
  title          String   @db.VarChar(255)
  description    String?  @db.Text
  estimatedValue Decimal? @map("estimated_value") @db.Decimal(12, 2)

  stage          PotentialStage @default(POTENTIAL)
  stageChangedAt DateTime       @default(now()) @map("stage_changed_at")

  companyId String  @map("company_id")
  company   Company @relation(fields: [companyId], references: [id])

  contactId String?  @map("contact_id")
  contact   Contact? @relation(fields: [contactId], references: [id])

  // Link to created project (set when stage moves to CONFIRMED)
  projectId String?  @unique @map("project_id")
  project   Project? @relation("PotentialToProject", fields: [projectId], references: [id])

  position Int @default(0) // Kanban ordering within stage

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([companyId])
  @@index([contactId])
  @@index([stage])
  @@map("potential_projects")
}

// Project (actual work being delivered)
model Project {
  id               String        @id @default(cuid())
  title            String        @db.VarChar(255)
  description      String?       @db.Text
  revenue          Decimal?      @db.Decimal(12, 2) // Actual revenue from AI invoices
  potentialRevenue Decimal?      @map("potential_revenue") @db.Decimal(12, 2) // From deal/potential conversion
  status           ProjectStatus @default(DRAFT)
  startDate        DateTime?     @map("start_date")
  endDate          DateTime?     @map("end_date")

  companyId String  @map("company_id")
  company   Company @relation(fields: [companyId], references: [id])

  contactId String?  @map("contact_id")
  contact   Contact? @relation(fields: [contactId], references: [id])

  // Optional: Link back to source deal (if created from pipeline)
  sourceDeal Deal? @relation("DealToProject")

  // Optional: Link back to source potential (if created from repeat client)
  sourcePotential PotentialProject? @relation("PotentialToProject")

  // Optional: Link to KRI (initiative)
  initiativeId String?     @map("initiative_id")
  initiative   Initiative? @relation(fields: [initiativeId], references: [id])

  costs     Cost[]
  documents Document[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([companyId])
  @@index([contactId])
  @@index([initiativeId])
  @@index([status])
  @@map("projects")
}

// CostCategory (lookup table for cost classification)
model CostCategory {
  id          String  @id @default(cuid())
  name        String  @unique @db.VarChar(50)
  description String? @db.VarChar(255)
  sortOrder   Int     @default(0) @map("sort_order")
  isActive    Boolean @default(true) @map("is_active")

  costs Cost[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("cost_categories")
}

// Cost (line item expense on a project)
model Cost {
  id          String   @id @default(cuid())
  description String   @db.VarChar(500)
  amount      Decimal  @db.Decimal(12, 2)
  date        DateTime @default(now())

  projectId String  @map("project_id")
  project   Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  categoryId String       @map("category_id")
  category   CostCategory @relation(fields: [categoryId], references: [id])

  // Receipt file path (stored on filesystem, not in DB)
  receiptPath String? @map("receipt_path") @db.VarChar(500)

  // AI import tracking
  aiImported Boolean @default(false) @map("ai_imported")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([projectId])
  @@index([categoryId])
  @@index([date])
  @@map("costs")
}

// ============================================================
// Document Management & Dashboard Customization (v1.3)
// ============================================================

// Document (file attached to a project)
model Document {
  id        String  @id @default(cuid())
  projectId String  @map("project_id")
  project   Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  filename    String           @db.VarChar(255) // Original filename for display
  storagePath String           @db.VarChar(500) // Relative path: projects/{id}/{uuid}.ext
  mimeType    String           @db.VarChar(100)
  size        Int // File size in bytes
  category    DocumentCategory @default(OTHER)

  // AI Document Intelligence (v1.3 - Phase 25)
  aiStatus     DocumentAIStatus @default(PENDING) @map("ai_status")
  aiAnalyzedAt DateTime?        @map("ai_analyzed_at")

  uploadedById String @map("uploaded_by_id")
  uploadedBy   User   @relation(fields: [uploadedById], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([projectId])
  @@index([category])
  @@index([aiStatus])
  @@map("documents")
}

// UserPreferences (one-to-one with User for dashboard/filter settings)
model UserPreferences {
  id     String @id @default(cuid())
  userId String @unique @map("user_id")
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  dashboardLayout Json? @db.Json
  dateFilter      Json? @db.Json

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("user_preferences")
}

// AdminDefaults (singleton for system-wide dashboard defaults)
model AdminDefaults {
  id String @id @default(cuid())

  dashboardLayout Json @db.Json
  widgetRoles     Json @db.Json

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("admin_defaults")
}
