// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// Enums
enum InitiativeStatus {
  NOT_STARTED
  IN_PROGRESS
  ON_HOLD
  AT_RISK
  COMPLETED
  CANCELLED
}

enum Objective {
  OBJ1_SCALE_EVENTS
  OBJ2_BUILD_AI_TRAINING
}

enum InitiativeDepartment {
  BIZ_DEV
  OPERATIONS
  FINANCE
  MARKETING
}

enum TeamMember {
  KHAIRUL
  AZLAN
  IZYANI
}

// Models
model Initiative {
  id                    String               @id @default(cuid())
  sequenceNumber        Int                  @unique
  objective             Objective
  department            InitiativeDepartment
  title                 String               @db.VarChar(500)
  startDate             DateTime
  endDate               DateTime
  personInCharge        TeamMember?
  accountable           TeamMember?
  status                InitiativeStatus     @default(NOT_STARTED)
  remarks               String?              @db.Text
  position              Int                  @default(0) // For Kanban ordering

  // v2.0: FK to KeyResult (replaces keyResult string field)
  keyResultId String?    @map("key_result_id")
  keyResult   KeyResult? @relation(fields: [keyResultId], references: [id])

  // v2.0: Budget and resources fields
  budget    String? @db.VarChar(255)
  resources String? @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  comments Comment[]
  projects Project[] // Projects linked to this KRI (v1.2)

  @@index([status])
  @@index([department])
  @@index([objective])
  @@index([personInCharge])
  @@index([startDate, endDate])
  @@index([keyResultId])
  @@map("initiatives")
}

model Comment {
  id           String     @id @default(cuid())
  content      String     @db.Text
  userId       String     @map("user_id")
  user         User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  initiativeId String
  initiative   Initiative @relation(fields: [initiativeId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([initiativeId])
  @@index([userId])
  @@index([createdAt])
  @@map("comments")
}

model Event {
  id        String    @id @default(cuid())
  name      String    @db.VarChar(255)
  client    String    @db.VarChar(255)
  eventDate DateTime?
  revenue   Decimal?  @db.Decimal(12, 2)
  cost      Decimal?  @db.Decimal(12, 2)
  status    String    @db.VarChar(50)
  remarks   String?   @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([eventDate])
  @@index([status])
  @@map("events")
}

// Industry events to attend for networking/business development
enum EventPriority {
  TIER_1
  TIER_2
  TIER_3
  ENERGY
}

enum EventCategory {
  EVENTS
  AI_TRAINING
  BOTH
}

enum EventStatus {
  PLANNED
  REGISTERED
  ATTENDED
  CANCELLED
  SKIPPED
}

model EventToAttend {
  id              String        @id @default(cuid())
  priority        EventPriority
  name            String        @db.VarChar(255)
  category        EventCategory
  eventDate       String        @db.VarChar(100) // Flexible date format from Excel
  location        String        @db.VarChar(255)
  estimatedCost   Decimal?      @db.Decimal(12, 2)
  whyAttend       String?       @db.Text
  targetCompanies String?       @db.Text
  actionRequired  String?       @db.VarChar(255)
  status          EventStatus   @default(PLANNED)
  remarks         String?       @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([priority])
  @@index([category])
  @@index([status])
  @@map("events_to_attend")
}

// ============================================================
// Auth.js Models
// ============================================================

enum UserRole {
  ADMIN
  EDITOR
  VIEWER
}

// ============================================================
// CRM & Project Financials Enums (v1.2)
// ============================================================

// Pipeline stages for new business deals
enum DealStage {
  LEAD
  QUALIFIED
  PROPOSAL
  NEGOTIATION
  WON
  LOST
}

// Pipeline stages for repeat client opportunities
enum PotentialStage {
  POTENTIAL
  CONFIRMED
  CANCELLED
}

// Project lifecycle status
enum ProjectStatus {
  DRAFT
  ACTIVE
  COMPLETED
  CANCELLED
}

// Document categories for project files (v1.3)
enum DocumentCategory {
  RECEIPT
  INVOICE
  OTHER
}

// Document AI analysis status (v1.3 - AI Document Intelligence)
enum DocumentAIStatus {
  PENDING // Document uploaded but not yet analyzed by AI
  ANALYZED // AI has extracted data, awaiting user review
  IMPORTED // User confirmed and data imported to costs/revenue
  FAILED // AI analysis failed (unparseable document)
}

// ============================================================
// v1.4 Enums - Intelligent Automation & Organization
// ============================================================

enum PaymentTerms {
  IMMEDIATE
  NET_7
  NET_15
  NET_30
  NET_45
  NET_60
  NET_90
}

enum TaskStatus {
  TODO
  IN_PROGRESS
  DONE
}

enum TaskPriority {
  LOW
  MEDIUM
  HIGH
}

enum ActivityEntityType {
  DEAL
  POTENTIAL
  PROJECT
}

enum ActivityAction {
  CREATED
  UPDATED
  STAGE_CHANGED
  TITLE_SYNCED
  REVENUE_UPDATED
  STATUS_CHANGED
  CONVERTED
}

// ============================================================
// v2.0 Enums - OKR Restructure & Support Tasks
// ============================================================

enum MetricType {
  REVENUE
  COUNT
}

enum KeyResultStatus {
  NOT_STARTED
  ON_TRACK
  AT_RISK
  BEHIND
  ACHIEVED
}

enum SupportTaskCategory {
  DESIGN_CREATIVE
  BUSINESS_ADMIN
  TALENTA_IDEAS
  OPERATIONS
}

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String?   @unique
  emailVerified DateTime? @map("email_verified")
  image         String?
  role          UserRole  @default(VIEWER)

  accounts     Account[]
  sessions     Session[]
  comments     Comment[]
  documents    Document[]
  preferences  UserPreferences?
  taskComments TaskComment[]
  activityLogs ActivityLog[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("users")
}

model Account {
  id                String  @id @default(cuid())
  userId            String  @map("user_id")
  type              String
  provider          String
  providerAccountId String  @map("provider_account_id")
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique @map("session_token")
  userId       String   @map("user_id")
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

// ============================================================
// CRM & Project Financials Models (v1.2)
// ============================================================

// Company (client organization)
model Company {
  id       String  @id @default(cuid())
  name     String  @db.VarChar(255)
  industry String? @db.VarChar(100)
  website  String? @db.VarChar(255)
  address  String? @db.Text
  phone    String? @db.VarChar(50)
  notes    String? @db.Text

  contacts    Contact[]
  deals       Deal[]
  potentials  PotentialProject[]
  projects    Project[]
  departments Department[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([name])
  @@map("companies")
}

// Contact (person at a company)
model Contact {
  id        String  @id @default(cuid())
  companyId String  @map("company_id")
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  name      String  @db.VarChar(255)
  email     String? @db.VarChar(255)
  phone     String? @db.VarChar(50)
  role      String? @db.VarChar(100)
  isPrimary Boolean @default(false) @map("is_primary")

  departmentId String?     @map("department_id")
  department   Department? @relation(fields: [departmentId], references: [id])

  deals      Deal[]
  potentials PotentialProject[]
  projects   Project[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([companyId])
  @@index([departmentId])
  @@map("contacts")
}

// Deal (new business pipeline opportunity)
model Deal {
  id          String   @id @default(cuid())
  title       String   @db.VarChar(255)
  description String?  @db.Text
  value       Decimal? @db.Decimal(12, 2)

  stage          DealStage @default(LEAD)
  stageChangedAt DateTime  @default(now()) @map("stage_changed_at")
  lostReason     String?   @map("lost_reason") @db.Text

  companyId String  @map("company_id")
  company   Company @relation(fields: [companyId], references: [id])

  contactId String?  @map("contact_id")
  contact   Contact? @relation(fields: [contactId], references: [id])

  departmentId String?     @map("department_id")
  department   Department? @relation(fields: [departmentId], references: [id])

  // Link to created project (set when stage moves to WON)
  projectId String?  @unique @map("project_id")
  project   Project? @relation("DealToProject", fields: [projectId], references: [id])

  position   Int     @default(0) // Kanban ordering within stage
  isArchived Boolean @default(false) @map("is_archived")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([companyId])
  @@index([contactId])
  @@index([departmentId])
  @@index([stage])
  @@index([isArchived])
  @@map("deals")
}

// PotentialProject (repeat client pipeline opportunity)
model PotentialProject {
  id             String   @id @default(cuid())
  title          String   @db.VarChar(255)
  description    String?  @db.Text
  estimatedValue Decimal? @map("estimated_value") @db.Decimal(12, 2)

  stage          PotentialStage @default(POTENTIAL)
  stageChangedAt DateTime       @default(now()) @map("stage_changed_at")

  companyId String  @map("company_id")
  company   Company @relation(fields: [companyId], references: [id])

  contactId String?  @map("contact_id")
  contact   Contact? @relation(fields: [contactId], references: [id])

  departmentId String?     @map("department_id")
  department   Department? @relation(fields: [departmentId], references: [id])

  // Link to created project (set when stage moves to CONFIRMED)
  projectId String?  @unique @map("project_id")
  project   Project? @relation("PotentialToProject", fields: [projectId], references: [id])

  position   Int     @default(0) // Kanban ordering within stage
  isArchived Boolean @default(false) @map("is_archived")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([companyId])
  @@index([contactId])
  @@index([departmentId])
  @@index([stage])
  @@index([isArchived])
  @@map("potential_projects")
}

// Project (actual work being delivered)
model Project {
  id               String        @id @default(cuid())
  title            String        @db.VarChar(255)
  description      String?       @db.Text
  revenue          Decimal?      @db.Decimal(12, 2) // Actual revenue from AI invoices
  potentialRevenue Decimal?      @map("potential_revenue") @db.Decimal(12, 2) // From deal/potential conversion
  status           ProjectStatus @default(DRAFT)
  startDate        DateTime?     @map("start_date")
  endDate          DateTime?     @map("end_date")

  isArchived Boolean @default(false) @map("is_archived")

  isInternal     Boolean @default(false) @map("is_internal")
  internalEntity String? @map("internal_entity") @db.VarChar(50)

  companyId String?  @map("company_id")
  company   Company? @relation(fields: [companyId], references: [id])

  contactId String?  @map("contact_id")
  contact   Contact? @relation(fields: [contactId], references: [id])

  // Optional: Link back to source deal (if created from pipeline)
  sourceDeal Deal? @relation("DealToProject")

  // Optional: Link back to source potential (if created from repeat client)
  sourcePotential PotentialProject? @relation("PotentialToProject")

  // Optional: Link to KRI (initiative)
  initiativeId String?     @map("initiative_id")
  initiative   Initiative? @relation(fields: [initiativeId], references: [id])

  costs        Cost[]
  documents    Document[]
  deliverables Deliverable[]
  tasks        Task[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([companyId])
  @@index([contactId])
  @@index([initiativeId])
  @@index([status])
  @@index([isArchived])
  @@index([isInternal])
  @@map("projects")
}

// CostCategory (lookup table for cost classification)
model CostCategory {
  id          String  @id @default(cuid())
  name        String  @unique @db.VarChar(50)
  description String? @db.VarChar(255)
  sortOrder   Int     @default(0) @map("sort_order")
  isActive    Boolean @default(true) @map("is_active")

  costs Cost[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("cost_categories")
}

// Cost (line item expense on a project)
model Cost {
  id          String   @id @default(cuid())
  description String   @db.VarChar(500)
  amount      Decimal  @db.Decimal(12, 2)
  date        DateTime @default(now())

  projectId String  @map("project_id")
  project   Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  categoryId String       @map("category_id")
  category   CostCategory @relation(fields: [categoryId], references: [id])

  // Receipt file path (stored on filesystem, not in DB)
  receiptPath String? @map("receipt_path") @db.VarChar(500)

  // AI import tracking
  aiImported Boolean @default(false) @map("ai_imported")

  // AI embedding for semantic matching (1536 floats for text-embedding-3-small)
  embedding Json? @db.Json

  // AI-assigned normalized item name for price comparison
  normalizedItem String? @map("normalized_item") @db.VarChar(100)

  supplierId String?   @map("supplier_id")
  supplier   Supplier? @relation(fields: [supplierId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([projectId])
  @@index([categoryId])
  @@index([date])
  @@index([supplierId])
  @@index([normalizedItem])
  @@map("costs")
}

// ============================================================
// Document Management & Dashboard Customization (v1.3)
// ============================================================

// Document (file attached to a project)
model Document {
  id        String  @id @default(cuid())
  projectId String  @map("project_id")
  project   Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  filename    String           @db.VarChar(255) // Original filename for display
  storagePath String           @db.VarChar(500) // Relative path: projects/{id}/{uuid}.ext
  mimeType    String           @db.VarChar(100)
  size        Int // File size in bytes
  category    DocumentCategory @default(OTHER)

  // AI Document Intelligence (v1.3 - Phase 25)
  aiStatus     DocumentAIStatus @default(PENDING) @map("ai_status")
  aiAnalyzedAt DateTime?        @map("ai_analyzed_at")

  uploadedById String @map("uploaded_by_id")
  uploadedBy   User   @relation(fields: [uploadedById], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([projectId])
  @@index([category])
  @@index([aiStatus])
  @@map("documents")
}

// UserPreferences (one-to-one with User for dashboard/filter settings)
model UserPreferences {
  id     String @id @default(cuid())
  userId String @unique @map("user_id")
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  dashboardLayout Json?  @db.Json
  dateFilter      Json?  @db.Json
  detailViewMode  String @default("dialog") @map("detail_view_mode") @db.VarChar(20)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("user_preferences")
}

// AdminDefaults (singleton for system-wide dashboard defaults)
model AdminDefaults {
  id String @id @default(cuid())

  dashboardLayout Json @db.Json
  widgetRoles     Json @db.Json

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("admin_defaults")
}

// ============================================================
// v1.4 Models - Intelligent Automation & Organization
// ============================================================

// Supplier (vendor organization for cost tracking)
model Supplier {
  id   String @id @default(cuid())
  name String @db.VarChar(255)

  // Contact info
  email         String? @db.VarChar(255)
  phone         String? @db.VarChar(50)
  address       String? @db.Text
  website       String? @db.VarChar(255)
  contactPerson String? @map("contact_person") @db.VarChar(255)

  // Credit terms
  acceptsCredit Boolean       @default(false) @map("accepts_credit")
  paymentTerms  PaymentTerms? @map("payment_terms")

  notes String? @db.Text

  // Relations
  costs Cost[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([name])
  @@map("suppliers")
}

// Department (subdivision within a company)
model Department {
  id          String  @id @default(cuid())
  name        String  @db.VarChar(255)
  description String? @db.Text

  companyId String  @map("company_id")
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  contacts   Contact[]
  deals      Deal[]
  potentials PotentialProject[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([companyId, name])
  @@index([companyId])
  @@map("departments")
}

// Deliverable (line item within a project)
model Deliverable {
  id          String   @id @default(cuid())
  title       String   @db.VarChar(500)
  description String?  @db.Text
  value       Decimal? @db.Decimal(12, 2)
  sortOrder   Int      @default(0) @map("sort_order")

  projectId String  @map("project_id")
  project   Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  aiExtracted Boolean @default(false) @map("ai_extracted")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([projectId])
  @@map("deliverables")
}

// Task (work item within a project with subtask hierarchy)
model Task {
  id          String  @id @default(cuid())
  title       String  @db.VarChar(500)
  description String? @db.Text

  status   TaskStatus   @default(TODO)
  priority TaskPriority @default(MEDIUM)
  dueDate  DateTime?    @map("due_date")

  assignee TeamMember?

  projectId String  @map("project_id")
  project   Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  // Self-referencing for subtasks (up to 5 levels)
  parentId String? @map("parent_id")
  parent   Task?   @relation("TaskSubtasks", fields: [parentId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  children Task[]  @relation("TaskSubtasks")

  depth     Int @default(0)
  sortOrder Int @default(0) @map("sort_order")

  comments TaskComment[]
  tags     TaskTag[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([projectId])
  @@index([parentId])
  @@index([status])
  @@index([assignee])
  @@index([dueDate])
  @@map("tasks")
}

// TaskComment (comment on a task)
model TaskComment {
  id      String @id @default(cuid())
  content String @db.Text

  taskId String @map("task_id")
  task   Task   @relation(fields: [taskId], references: [id], onDelete: Cascade)

  userId String @map("user_id")
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([taskId])
  @@index([userId])
  @@map("task_comments")
}

// Tag (label for categorizing tasks)
model Tag {
  id    String @id @default(cuid())
  name  String @unique @db.VarChar(50)
  color String @default("#6B7280") @db.VarChar(7)

  tasks TaskTag[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("tags")
}

// TaskTag (join table for task-tag relationship)
model TaskTag {
  id String @id @default(cuid())

  taskId String @map("task_id")
  task   Task   @relation(fields: [taskId], references: [id], onDelete: Cascade)

  tagId String @map("tag_id")
  tag   Tag    @relation(fields: [tagId], references: [id], onDelete: Cascade)

  inherited Boolean @default(false)

  createdAt DateTime @default(now())

  @@unique([taskId, tagId])
  @@index([taskId])
  @@index([tagId])
  @@map("task_tags")
}

// ActivityLog (polymorphic activity tracking)
model ActivityLog {
  id String @id @default(cuid())

  entityType ActivityEntityType @map("entity_type")
  entityId   String             @map("entity_id")

  action   ActivityAction
  field    String?        @db.VarChar(50)
  oldValue String?        @map("old_value") @db.Text
  newValue String?        @map("new_value") @db.Text

  userId String? @map("user_id")
  user   User?   @relation(fields: [userId], references: [id])

  createdAt DateTime @default(now())

  @@index([entityType, entityId])
  @@index([createdAt])
  @@index([userId])
  @@map("activity_logs")
}

// ============================================================
// v2.0 Models - OKR Restructure & Support Tasks
// ============================================================

// KeyResult (measurable outcome under an Objective)
model KeyResult {
  id           String          @id @default(cuid())
  krId         String          @unique @db.VarChar(20) // "KR1.1", "KR2.3"
  objective    Objective // Reuse existing Objective enum
  description  String          @db.VarChar(500)
  metricType   MetricType
  target       Decimal         @db.Decimal(12, 2)
  actual       Decimal         @default(0) @db.Decimal(12, 2)
  unit         String          @db.VarChar(50) // "RM", "clients", "programs"
  progress     Decimal         @default(0) @db.Decimal(5, 2) // 0.00 - 100.00
  deadline     String          @db.VarChar(50) // Flexible format: "Q4 2026", "Dec 2026"
  status       KeyResultStatus @default(NOT_STARTED)
  owner        String          @db.VarChar(100) // String per requirements, not TeamMember enum
  howWeMeasure String?         @map("how_we_measure") @db.Text
  notes        String?         @db.Text
  weight       Decimal         @default(1) @db.Decimal(5, 2) // For weighted objective rollup

  // Relations
  initiatives      Initiative[]
  supportTaskLinks SupportTaskKeyResult[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([objective])
  @@index([status])
  @@map("key_results")
}

// SupportTask (recurring operational task linked to key results)
model SupportTask {
  id        String              @id @default(cuid())
  taskId    String              @unique @db.VarChar(20) // "ST-001"
  category  SupportTaskCategory
  task      String              @db.VarChar(500)
  owner     String              @db.VarChar(100) // String per requirements
  frequency String?             @db.VarChar(50) // "Weekly", "Monthly" -- too many variations for enum
  priority  TaskPriority        @default(MEDIUM) // Reuse existing TaskPriority enum
  notes     String?             @db.Text

  // Relations
  keyResultLinks SupportTaskKeyResult[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([category])
  @@index([priority])
  @@map("support_tasks")
}

// SupportTaskKeyResult (join table: many-to-many between SupportTask and KeyResult)
model SupportTaskKeyResult {
  id String @id @default(cuid())

  supportTaskId String      @map("support_task_id")
  supportTask   SupportTask @relation(fields: [supportTaskId], references: [id], onDelete: Cascade)

  keyResultId String    @map("key_result_id")
  keyResult   KeyResult @relation(fields: [keyResultId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@unique([supportTaskId, keyResultId])
  @@index([supportTaskId])
  @@index([keyResultId])
  @@map("support_task_key_results")
}
