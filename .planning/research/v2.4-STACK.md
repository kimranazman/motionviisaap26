# Stack Research: v2.4 Settings, Sidebar & Bug Fixes

**Domain:** Sidebar UX enhancements, settings persistence, and project editing rules for an existing Next.js 14 app
**Researched:** 2026-01-28
**Confidence:** HIGH

## Executive Summary

v2.4 adds six features to an existing, mature codebase (67 phases, 44K+ LOC). The critical finding is that **zero new npm packages are needed**. Every feature can be built with already-installed dependencies:

- **Drag-and-drop reordering** -- `@dnd-kit/core@6.3.1` + `@dnd-kit/sortable@10.0.0` already installed and battle-tested across 12 files (Kanban boards, pipeline, tasks, potential projects)
- **Nested sidebar links** -- `@radix-ui/react-collapsible@1.1.12` already used in `nav-group.tsx` for group collapse/expand
- **Settings save with visual feedback** -- `sonner@2.0.7` already used for toast notifications throughout the app
- **Schema additions** -- `prisma@6.19.2` already handles JSON fields in UserPreferences; just add new fields
- **Revenue widget changes** -- Pure query changes, no library needed

This is a **code-only milestone** -- all work is application logic, not infrastructure.

## Recommended Stack

### Core Technologies (Already Installed -- No Changes)

| Technology | Installed Version | Purpose in v2.4 | Status |
|------------|-------------------|------------------|--------|
| Next.js (App Router) | 14.2.28 | Page routing, API routes, Server Components | Already installed |
| Prisma | 6.19.2 | Schema changes for new UserPreferences fields | Already installed |
| MariaDB | (server) | Persistent storage for preferences, field config | Already configured |
| Tailwind CSS | 3.4.1 | All UI styling | Already installed |
| TypeScript | 5.x | Type safety across all new code | Already installed |

### Libraries Used Per Feature

#### Feature 1: Sidebar Drag-and-Drop Reordering

| Library | Installed Version | Usage | Confidence |
|---------|-------------------|-------|------------|
| `@dnd-kit/core` | 6.3.1 | DndContext, sensors, collision detection | HIGH -- same pattern used in kanban-board.tsx |
| `@dnd-kit/sortable` | 10.0.0 | SortableContext, useSortable, verticalListSortingStrategy, arrayMove | HIGH -- identical to initiative reorder |
| `@dnd-kit/utilities` | 3.2.2 | CSS transform utilities for drag handle | HIGH -- already a dependency |

**Existing pattern to replicate:** `src/components/kanban/kanban-board.tsx` lines 1-25 show exact imports. The sidebar reorder in Settings will use `verticalListSortingStrategy` since nav items are a vertical list. The `arrayMove` utility handles the reorder logic. Persist the ordered array to `UserPreferences.navItemOrder` (new JSON field).

**Sensor configuration to copy:**
```typescript
// From kanban-board.tsx -- proven pattern in this codebase
const mouseSensor = useSensor(MouseSensor, {
  activationConstraint: { distance: 5 },
})
const touchSensor = useSensor(TouchSensor, {
  activationConstraint: { delay: 250, tolerance: 5 },
})
const keyboardSensor = useSensor(KeyboardSensor, {
  coordinateGetter: sortableKeyboardCoordinates,
})
```

#### Feature 2: Nested Sidebar Links (Company > Departments/Contacts)

| Library | Installed Version | Usage | Confidence |
|---------|-------------------|-------|------------|
| `@radix-ui/react-collapsible` | 1.1.12 | Nested collapsible sections within nav groups | HIGH -- already used in NavGroupComponent |
| `lucide-react` | 0.562.0 | ChevronRight icon for expand/collapse indicator | HIGH -- already used in nav-group.tsx |

**Existing pattern to extend:** `src/components/layout/nav-group.tsx` already uses `Collapsible` with `CollapsibleTrigger` + `CollapsibleContent` for group-level collapse. The nested links feature adds a second nesting level within individual nav items (e.g., "Companies" expands to show "Departments" and "Contacts" as indented sub-items).

**Data model change:** Extend `NavItem` in `nav-config.ts` to support optional `children: NavItem[]`. The sidebar renders children with increased left padding (e.g., `pl-10` instead of `px-3`). Collapse state stored in `localStorage` (same as group collapse via `use-nav-collapse-state`).

#### Feature 3: Settings Save with Visual Feedback

| Library | Installed Version | Usage | Confidence |
|---------|-------------------|-------|------------|
| `sonner` | 2.0.7 | `toast.success()` for save confirmation | HIGH -- used in 5+ components already |
| `@radix-ui/react-switch` | 1.2.6 | Toggle switches (already in settings page) | HIGH -- unchanged |

**Current problem:** `use-nav-visibility.ts` fires API calls on every toggle (`toggleItem` does fire-and-forget PATCH). The autoReveal callback at line 73-100 re-shows hidden items whenever pathname changes, which includes tab switches within a page (e.g., switching between tabs on a project detail page triggers `pathname` change, re-revealing the hidden item).

**Fix approach -- no new libraries needed:**
1. **Batch save pattern:** Accumulate changes in local state, show a "Save" button when dirty, PATCH on click. Confirm with `toast.success('Settings saved')`.
2. **autoReveal fix:** Guard against sub-path matches. Currently `pathname.startsWith(href)` matches `/projects/abc` against `/projects`, which is correct for direct navigation but fires on every tab change within `/projects/[id]`. Solution: only autoReveal when the pathname root changes (compare previous vs current base path), not on every pathname change.

#### Feature 4: Completed Projects Remain Editable

| Library | Version | Usage | Confidence |
|---------|---------|-------|------------|
| (none needed) | -- | Pure logic change: remove `isReadOnly` / `disabled` conditions tied to COMPLETED status | HIGH |

**Current state:** Searching the codebase for `COMPLETED` + `readOnly`/`disabled` patterns reveals that the pipeline (`deal-detail-sheet.tsx`) and potential projects (`potential-detail-sheet.tsx`) have explicit `isReadOnly` patterns for CONVERTED/LOST states. However, the Project detail sheet (`project-detail-sheet.tsx`) does NOT have an explicit COMPLETED read-only guard in the first 100 lines examined. The restriction may be in a different location or may be implemented differently (e.g., status-based field disabling in the form).

**Action needed:** Audit `project-detail-sheet.tsx` fully and any project edit API routes for COMPLETED status guards. Remove or relax them. This is pure application logic, zero library impact.

#### Feature 5: Admin Field Visibility for Internal Projects

| Library | Version | Usage | Confidence |
|---------|---------|-------|------------|
| Prisma | 6.19.2 | New `AdminDefaults` field or new model for field config | HIGH |
| `@radix-ui/react-switch` | 1.2.6 | Toggle switches in admin settings UI | HIGH -- already used |

**Schema approach:** Add a `hiddenFieldsInternal` JSON field to the existing `AdminDefaults` model (already exists for dashboard layout defaults). Store an array of field keys like `["revenue", "potentialRevenue", "pipeline"]`. The project detail sheet conditionally hides these fields when `project.isInternal === true`.

**No new library needed.** The admin settings page uses the same Switch component pattern from the existing Settings page.

#### Feature 6: Dashboard Revenue Widget with potentialRevenue

| Library | Version | Usage | Confidence |
|---------|---------|-------|------------|
| (none needed) | -- | Pure query/data change | HIGH |

**Current state:** The revenue widget (`revenue-target.tsx`) gets data from KeyResult model's `metricType: 'REVENUE'` records (via `page.tsx` lines 39-55). The `potentialRevenue` field on Project is NOT currently included in this calculation.

**Change needed:** In the dashboard data fetching (either `page.tsx` or `api/dashboard/stats/route.ts`), add a query to sum `potentialRevenue` from projects where `status = 'CONFIRMED'` (or whatever "confirmed potential" means in the business logic). Add this as a new line item in `revenueBreakdown` or as a separate metric. Pure Prisma query + component prop changes.

## Schema Changes Required

```prisma
model UserPreferences {
  // Existing fields...
  hiddenNavItems  Json?  @map("hidden_nav_items") @db.Json

  // NEW: Ordered list of nav hrefs (null = default order from nav-config.ts)
  navItemOrder    Json?  @map("nav_item_order") @db.Json
}

model AdminDefaults {
  // Existing fields...
  dashboardLayout Json @db.Json

  // NEW: Fields hidden for internal projects
  hiddenFieldsInternal Json? @map("hidden_fields_internal") @db.Json
}
```

Both are nullable JSON fields, so `prisma db push` handles them non-destructively on existing rows.

## API Changes Required

| Endpoint | Change | Details |
|----------|--------|---------|
| `PATCH /api/user/preferences` | Add `navItemOrder` field | Same upsert pattern, add to body parsing |
| `GET /api/user/preferences` | Return `navItemOrder` | Add to response object |
| `GET /api/admin/defaults` | Return `hiddenFieldsInternal` | New field in response |
| `PATCH /api/admin/defaults` | Accept `hiddenFieldsInternal` | New field in update |
| Dashboard data fetch | Include potentialRevenue sum | New Prisma aggregate query |

## Installation

```bash
# No new packages to install. All dependencies are already present:
# - @dnd-kit/core@6.3.1
# - @dnd-kit/sortable@10.0.0
# - @dnd-kit/utilities@3.2.2
# - @radix-ui/react-collapsible@1.1.12
# - @radix-ui/react-switch@1.2.6
# - sonner@2.0.7
# - prisma@6.19.2

# Only schema change needed:
npx prisma db push
```

## Alternatives Considered

| Feature | Recommended | Alternative | Why Not Alternative |
|---------|-------------|-------------|---------------------|
| Drag-and-drop | @dnd-kit (installed) | react-beautiful-dnd | Deprecated/unmaintained. @dnd-kit already in codebase with proven patterns. |
| Drag-and-drop | @dnd-kit (installed) | HTML5 native drag | No accessibility, no touch support, no sortable strategy. @dnd-kit already works. |
| Nested nav | Radix Collapsible (installed) | Headless UI Disclosure | Different ecosystem. Radix already used throughout. Collapsible already in nav-group. |
| Toast feedback | sonner (installed) | react-hot-toast | sonner already imported in 5+ components. Consistent UX. |
| Field visibility | JSON field in AdminDefaults | Separate FieldConfig table | Over-engineering. A simple JSON array of hidden field keys is sufficient for ~5 fields. |
| Nav order storage | JSON in UserPreferences | Separate NavOrder table | Over-engineering for an ordered array of ~20 items. Same pattern as hiddenNavItems and dashboardLayout. |
| Settings persistence | Explicit save button | Debounced auto-save | Save button provides clearer user feedback and avoids the current problem (too-aggressive persistence). User explicitly requested save button. |

## What NOT to Use

| Avoid | Why | Use Instead |
|-------|-----|-------------|
| `react-beautiful-dnd` | Deprecated by Atlassian in 2024. No React 18+ support. | `@dnd-kit` (already installed) |
| `react-sortable-hoc` | Deprecated, uses legacy React patterns (findDOMNode). | `@dnd-kit/sortable` (already installed) |
| `framer-motion` for drag | Overkill for list reordering; would add 150KB+ bundle. | `@dnd-kit` with CSS transitions |
| New state management (Zustand/Jotai) | The codebase uses React hooks + fetch for all state. Adding a state library for one feature breaks consistency. | Continue with `useState` + API fetch pattern |
| localStorage for nav order | Nav order should persist across devices/browsers. Current pattern stores user prefs in DB via UserPreferences model. | Prisma UserPreferences JSON field |
| Auto-save with debounce | The user explicitly wants a save button. Auto-save caused the original autoReveal bug (fire-and-forget writes). | Explicit save button with dirty tracking |

## Patterns to Follow (from existing codebase)

### Pattern 1: DnD Sortable List (from kanban-board.tsx)

```typescript
// Proven pattern used in 8+ files
import { DndContext, DragOverlay, useSensor, useSensors, MouseSensor, TouchSensor, KeyboardSensor } from '@dnd-kit/core'
import { SortableContext, useSortable, verticalListSortingStrategy, arrayMove, sortableKeyboardCoordinates } from '@dnd-kit/sortable'
import { CSS } from '@dnd-kit/utilities'

// Each draggable item uses useSortable hook
function SortableNavItem({ id, ...props }) {
  const { attributes, listeners, setNodeRef, transform, transition, isDragging } = useSortable({ id })
  const style = { transform: CSS.Transform.toString(transform), transition }
  // ... render with ref, style, listeners
}
```

### Pattern 2: Preferences Persistence (from use-nav-visibility.ts)

```typescript
// Current: fire-and-forget (causes bugs)
fetch('/api/user/preferences', { method: 'PATCH', body: JSON.stringify({ hiddenNavItems: next }) })

// v2.4: Batch with explicit save
const [dirty, setDirty] = useState(false)
const [pendingChanges, setPendingChanges] = useState({})

async function save() {
  await fetch('/api/user/preferences', { method: 'PATCH', body: JSON.stringify(pendingChanges) })
  toast.success('Settings saved')
  setDirty(false)
}
```

### Pattern 3: JSON Field in UserPreferences (from dashboardLayout)

```typescript
// Existing pattern: nullable JSON fields with sensible defaults
const prefs = await prisma.userPreferences.findUnique({ where: { userId } })
const navOrder = (prefs?.navItemOrder as string[]) ?? null  // null = use default from nav-config.ts
```

### Pattern 4: Admin Config (from AdminDefaults model)

```typescript
// Existing singleton pattern for admin-level settings
const defaults = await prisma.adminDefaults.findFirst()
const hiddenFields = (defaults?.hiddenFieldsInternal as string[]) ?? []
```

## Version Compatibility

| Package | Version | Compatible With | Notes |
|---------|---------|-----------------|-------|
| `@dnd-kit/core` | 6.3.1 | `@dnd-kit/sortable@10.0.0` | Already working together in this codebase |
| `@dnd-kit/sortable` | 10.0.0 | React 18 | Major version, but already installed and functional |
| `@radix-ui/react-collapsible` | 1.1.12 | React 18, Radix ecosystem | All Radix packages at compatible versions |
| `sonner` | 2.0.7 | Next.js 14, React 18 | Working throughout the app |
| `prisma` | 6.19.2 | MariaDB | Already configured with JSON field support |

No version bumps or compatibility concerns. All packages are at their current installed versions.

## Complexity Assessment by Feature

| Feature | Library Work | Schema Work | UI Work | Total Effort |
|---------|-------------|-------------|---------|--------------|
| Fix autoReveal persistence | None | None | Refactor hook logic | Low |
| Save button with feedback | None | None | Add button + toast | Low |
| Nested sidebar links | None | Extend NavItem type | New nested component | Medium |
| Sidebar drag-and-drop reorder | None (dnd-kit exists) | Add navItemOrder JSON field | New DnD settings section | Medium |
| Completed projects editable | None | None | Remove guard conditions | Low |
| Admin field visibility | None | Add hiddenFieldsInternal JSON field | Admin config UI + conditional rendering | Medium |
| Revenue widget potentialRevenue | None | None | Query change + display | Low |

## Sources

- **Codebase inspection (HIGH confidence):** Direct reading of `package.json`, `schema.prisma`, `nav-config.ts`, `sidebar.tsx`, `nav-group.tsx`, `use-nav-visibility.ts`, `settings/page.tsx`, `kanban-board.tsx`, `revenue-target.tsx`, `page.tsx` (dashboard), `api/user/preferences/route.ts`
- **Installed package verification (HIGH confidence):** Version numbers verified from `node_modules/*/package.json` for @dnd-kit/core (6.3.1), @dnd-kit/sortable (10.0.0), @radix-ui/react-collapsible (1.1.12), sonner (2.0.7)
- **@dnd-kit/sortable v10 API (HIGH confidence):** Verified exports from `node_modules/@dnd-kit/sortable/dist/index.d.ts` -- confirms `SortableContext`, `useSortable`, `verticalListSortingStrategy`, `arrayMove` all present
- **Existing usage patterns (HIGH confidence):** @dnd-kit used in 12 files across kanban, pipeline, potential projects, and task views. Sonner toast used in 5+ component files. Collapsible used in 7 files.

---
*Stack research for: v2.4 Settings, Sidebar & Bug Fixes*
*Researched: 2026-01-28*
