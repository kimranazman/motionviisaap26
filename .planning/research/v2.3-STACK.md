# Technology Stack: v2.3 CRM & UX Improvements

**Project:** SAAP 2026v2
**Researched:** 2026-01-28
**Overall confidence:** HIGH

---

## Recommended Stack

### No New Dependencies Required

v2.3 features are buildable entirely with the existing stack. No new npm packages are needed. This is a significant finding -- every feature maps to patterns already established in the codebase.

| Feature | Existing Technology | Why Sufficient |
|---------|-------------------|----------------|
| Modal scroll/expand fixes | `@radix-ui/react-dialog@1.1.15`, `@radix-ui/react-scroll-area@1.2.10`, Tailwind CSS | Dialog component already has `overflow-y-auto`; needs structural CSS fixes, not new libraries |
| Sidebar nav customization | Prisma `UserPreferences.Json`, existing `/api/user/preferences` API, React Context | Pattern already proven by `detailViewMode` and `dashboardLayout` -- same shape, different field |
| CRM standalone pages | Next.js App Router, Prisma, shadcn `Table`/`Select`/`Input` | Standard CRUD pages using existing patterns from `/companies`, `/suppliers` |
| Add Task on /tasks | shadcn `Dialog`, Prisma `Task` model, existing combobox (`cmdk`) | Same pattern as existing task creation inside project detail |
| Internal project flag | Prisma schema (`Boolean`), shadcn `Switch` | Single field addition to `Project` model |
| Line item pricing history | Prisma schema (new `InvoiceLineItem` model), shadcn `Table`/`Tabs` | New model + two query views; UI from existing table patterns |

---

## Core Framework (Unchanged)

| Technology | Version | Purpose | Status |
|------------|---------|---------|--------|
| Next.js | 14.2.28 | App Router, API routes, SSR | Keep -- stable, battle-tested in 61 phases |
| React | 18.x | UI rendering | Keep -- no reason to upgrade to 19 mid-project |
| TypeScript | 5.x | Type safety | Keep |
| Prisma | 6.19.2 | ORM, migrations, type-safe queries | Keep |
| MariaDB/MySQL | (server) | Database | Keep |
| Tailwind CSS | 3.4.1 | Utility-first styling | Keep |
| NextAuth.js | 5.0.0-beta.30 | Authentication, session | Keep |

### UI Components (Unchanged)

| Library | Version | Purpose | v2.3 Usage |
|---------|---------|---------|------------|
| `@radix-ui/react-dialog` | 1.1.15 | Dialog/Sheet primitives | Fix scroll, expand-to-page |
| `@radix-ui/react-scroll-area` | 1.2.10 | Custom scrollbars in detail views | Existing pattern, no changes |
| `@radix-ui/react-select` | 2.2.6 | Dropdowns | Filter selects on new pages |
| `@radix-ui/react-tabs` | 1.1.13 | Tab navigation | By-item / by-client toggle on pricing history |
| `@radix-ui/react-switch` | 1.2.6 | Toggle switches | Internal project flag, sidebar item toggles |
| `@radix-ui/react-collapsible` | 1.1.12 | Collapsible sections | Already used in sidebar nav groups |
| `cmdk` | 1.1.1 | Command/combobox | Project linking in task creation |
| `lucide-react` | 0.562.0 | Icons | Icons for new pages/features |
| `sonner` | 2.0.7 | Toast notifications | Success/error feedback |
| `recharts` | 3.6.0 | Charts | Pricing trend sparklines (optional) |

---

## Feature-Specific Stack Decisions

### 1. Modal Scroll & Expand-to-Page Fixes

**Problem:** The current `DialogContent` in `src/components/ui/dialog.tsx` already has `overflow-y-auto` and `max-h-[85vh]` on desktop, but:
- The `overflow-y-auto` is on the content wrapper, not on a scrollable body section
- The content and header are both in the same scroll container (header scrolls away)
- The expand-to-page pattern in `DetailView` works but needs consistent application

**Stack decision:** Pure CSS/Tailwind fixes on existing Radix components. No new libraries.

**Approach -- verified against Radix docs and shadcn issues:**

| Fix | What to Change | Confidence |
|-----|---------------|------------|
| Sticky header in dialog | Add `sticky top-0 z-10 bg-background` to `DialogHeader`, ensure body is the scroll container | HIGH -- standard CSS pattern |
| Consistent max-height | Ensure all detail modals use `DetailView` wrapper (some bypass it) | HIGH -- audit existing modals |
| Scrollbar gutter stability | Add `scrollbar-gutter: stable` to `html` in global CSS | HIGH -- prevents layout shift when dialogs open |
| Mobile bottom sheet scroll | Already works via `h-[calc(100vh-2rem)]` in dialog.tsx | HIGH -- verified in code |

**What NOT to use:**
- `body-scroll-lock` package -- unnecessary; Radix handles this via `react-remove-scroll` (already a transitive dep)
- `react-modal` or any alternative modal library -- Radix Dialog is correct and already deeply integrated
- Radix Themes 3.0 -- would require major UI overhaul; the scrollable overlay default is achievable with CSS today

**Key technical detail (HIGH confidence -- from Radix docs and shadcn/ui Issue #16):**
The recommended Radix pattern for scrollable dialogs is: make DialogOverlay the scroll container (`overflow-y: auto`, `display: grid`, `place-items: center`) and nest DialogContent inside it. However, the existing SAAP pattern (scroll inside content) is equally valid for the `DetailView` use case since header/footer are pinned. The `DetailView` already uses `ScrollArea` for the body -- the fix is ensuring ALL detail modals consistently use `DetailView` rather than raw `Dialog`/`Sheet`.

**Source hierarchy:**
- [Radix Dialog docs](https://www.radix-ui.com/primitives/docs/components/dialog) -- HIGH confidence
- [shadcn/ui Issue #16](https://github.com/shadcn-ui/ui/issues/16) -- HIGH confidence
- [shadcn/ui PR #8103](https://github.com/shadcn-ui/ui/pull/8103) -- HIGH confidence

---

### 2. Customizable Sidebar Navigation

**Problem:** Users want to show/hide specific sidebar links. The current sidebar renders all items from a static `nav-config.ts`. Collapse state is persisted via localStorage (`sidebar-collapse-state`), but link visibility is not customizable.

**Stack decision:** Extend existing `UserPreferences` model with a `sidebarConfig` JSON field. Use the same React Context + API pattern already established for `detailViewMode` and `dashboardLayout`.

**Persistence layer -- three options evaluated:**

| Option | Pros | Cons | Verdict |
|--------|------|------|---------|
| **A. UserPreferences JSON field (DB)** | Cross-device sync, existing API pattern, works with SSR | Extra API call on load | **Use this** |
| B. localStorage only | Fast, no API call | Device-specific, lost on clear | Already used for collapse -- insufficient for visibility |
| C. Cookie-based (shadcn SidebarProvider) | SSR-friendly | Not per-user, 4KB limit | Wrong pattern for per-item visibility |

**Implementation pattern (HIGH confidence -- mirrors existing `detailViewMode` pattern):**

```
UserPreferences model:
  + sidebarConfig  Json?  @db.Json   // New field

JSON shape:
{
  hiddenItems: string[]  // Array of href paths to hide, e.g. ["/events", "/supplier-items"]
}
```

**Why `hiddenItems` array instead of full visibility map:**
- Default is "show all" -- empty/null means everything visible
- Only stores overrides (hidden items), not the full config
- Adding new nav items in future versions automatically shows them
- Simpler merge logic when nav-config changes between versions

**API:** Extend existing `PATCH /api/user/preferences` with `sidebarConfig` field -- same fire-and-forget pattern as `detailViewMode`.

**Context:** Create `SidebarConfigProvider` (or extend existing preference loading) to hydrate `hiddenItems` on mount. The sidebar component filters `navGroups` and `topLevelItems` against the hidden list.

**Settings UI:** Add a section in `/settings` page with checkboxes/switches for each nav item. Use `@radix-ui/react-switch` (already installed) for toggles.

**What NOT to use:**
- Zustand -- overkill for a single JSON preference; React Context + fetch is the established pattern
- shadcn's `SidebarProvider` with cookie persistence -- designed for open/close state, not per-item visibility
- Drag-and-drop reordering -- scope creep; show/hide is sufficient for v2.3

**Source hierarchy:**
- Existing codebase patterns (`detail-view-context.tsx`, `use-nav-collapse-state.ts`) -- HIGH confidence
- [shadcn Sidebar docs](https://ui.shadcn.com/docs/components/sidebar) -- MEDIUM confidence (for shadcn sidebar component patterns, but SAAP uses a custom sidebar)

---

### 3. Standalone CRM Pages (Departments & Contacts)

**Problem:** Departments and Contacts are currently only accessible through company detail views. Users need standalone pages with filtering by company.

**Stack decision:** Standard Next.js App Router pages using existing patterns. No new libraries.

| Component | Technology | Pattern Source |
|-----------|-----------|----------------|
| Page route | `src/app/(dashboard)/departments/page.tsx` | Same as `/companies`, `/suppliers` |
| Data table | shadcn `Table` + filter toolbar | Same as `supplier-items-table.tsx` |
| Company filter | shadcn `Select` with combobox | Same as existing filter patterns |
| Detail view | `DetailView` wrapper | Same as `company-detail-modal.tsx` |
| Create/Edit form | shadcn `Dialog` with form fields | Same as existing CRUD patterns |

**Nav config update:** Add items to the CRM group in `nav-config.ts`:
```typescript
{ name: 'Departments', href: '/departments', icon: Building },
{ name: 'Contacts', href: '/contacts', icon: UserCircle },
```

**Prisma queries:** Already have `Department` and `Contact` models with company relations. Use `include: { company: true }` for display, `where: { companyId }` for filtering.

---

### 4. Add Task Button on /tasks Page

**Problem:** The cross-project `/tasks` page shows tasks across all projects but has no way to create new tasks -- users must navigate to a specific project first.

**Stack decision:** Reuse existing task creation pattern from project detail, but wrap it in a Dialog with a project selector (combobox using `cmdk`).

| Component | Technology | Notes |
|-----------|-----------|-------|
| Add Task dialog | shadcn `Dialog` | Standard form dialog |
| Project selector | `cmdk` Command component | Already used for combobox elsewhere |
| Form fields | shadcn `Input`, `Select`, `Textarea` | Standard task fields |
| API endpoint | Existing `POST /api/projects/[id]/tasks` | No new endpoint needed |

**What NOT to use:**
- A separate `/api/tasks` endpoint that accepts projectId in the body -- reuse the existing per-project endpoint to maintain authorization consistency

---

### 5. Internal Project Flag

**Problem:** Projects currently require an external company (FK to `Company`). Internal projects (Motionvii / Talenta) need a way to be marked without a real external client.

**Stack decision:** Add an `isInternal` boolean and an `internalEntity` enum to the `Project` model.

**Schema addition (HIGH confidence -- straightforward Prisma change):**

```prisma
enum InternalEntity {
  MOTIONVII
  TALENTA
}

model Project {
  // ... existing fields ...
  isInternal      Boolean         @default(false) @map("is_internal")
  internalEntity  InternalEntity? @map("internal_entity")
  companyId       String?         @map("company_id")  // Make nullable
  company         Company?        @relation(...)       // Make optional
}
```

**Key design decision:** Make `companyId` nullable rather than creating dummy company records. This is cleaner because:
- No fake data in the companies table
- Queries can filter `WHERE isInternal = true` without joins
- UI shows "Motionvii" or "Talenta" badge instead of company name
- Existing company-required validation moves to form-level (required when `isInternal` is false)

**UI:** shadcn `Switch` for the toggle, shadcn `RadioGroup` or `Select` for Motionvii vs Talenta choice. Conditionally show/hide company selector based on toggle.

---

### 6. Line Item Pricing History

**Problem:** The current system tracks costs as lump sums. AI invoice parsing extracts `quantity` and `unitPrice` in the `InvoiceLineItem` TypeScript interface, but these are NOT persisted to the database -- only `amount` (lump sum) is saved to the `Cost` table. The existing `/supplier-items` page shows price comparison by `normalizedItem` but without quantity/unit price granularity.

**This is the most significant schema change in v2.3.**

**Stack decision:** New `InvoiceLineItem` Prisma model to persist quantity/unit price from AI extraction, plus new query endpoints for by-item and by-client views.

#### New Prisma Model

```prisma
model InvoiceLineItem {
  id          String   @id @default(cuid())

  // Source document
  documentId  String   @map("document_id")
  document    Document @relation(fields: [documentId], references: [id], onDelete: Cascade)

  // Line item data
  description     String   @db.VarChar(500)
  normalizedItem  String?  @map("normalized_item") @db.VarChar(100)
  quantity        Decimal  @db.Decimal(12, 4)  // 4 decimal places for fractional units
  unitPrice       Decimal  @map("unit_price") @db.Decimal(12, 2)
  lineTotal       Decimal  @map("line_total") @db.Decimal(12, 2)

  // Context
  projectId   String   @map("project_id")
  project     Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  supplierId  String?  @map("supplier_id")
  supplier    Supplier? @relation(fields: [supplierId], references: [id])

  // AI metadata
  confidence  String   @default("HIGH") @db.VarChar(10)
  aiExtracted Boolean  @default(true) @map("ai_extracted")

  invoiceDate DateTime? @map("invoice_date")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([normalizedItem])
  @@index([projectId])
  @@index([documentId])
  @@index([supplierId])
  @@index([invoiceDate])
  @@map("invoice_line_items")
}
```

**Why a separate model instead of adding quantity/unitPrice to `Cost`:**

| Approach | Pros | Cons | Verdict |
|----------|------|------|---------|
| **A. New `InvoiceLineItem` model** | Clean separation of concerns; `Cost` is for expenses, `InvoiceLineItem` is for revenue line items; doesn't break existing cost workflows | Two tables to query for price comparison | **Use this** |
| B. Add fields to `Cost` model | Simpler schema | Conflates expenses (costs) with revenue (invoices); `Cost` is for supplier expenses, invoices are client revenue documents; breaks existing semantics | Reject |
| C. Add fields to `Deliverable` model | Deliverables already have `value` field | Deliverables are project scope items, not invoice line items; one deliverable might appear on multiple invoices with different prices | Reject |

**Critical clarification on data flow:**

The existing system has two document types:
1. **Invoices** (from clients) -- revenue documents, parsed by AI, line items have quantity/unitPrice
2. **Receipts** (from suppliers) -- expense documents, parsed by AI, items become `Cost` records

For pricing history, we need BOTH views:
- **Client-side (revenue):** "What has Client X been charged for Item Y?" -- from `InvoiceLineItem` joined with `Project.company`
- **Supplier-side (costs):** "What has Supplier Z charged us for Item Y?" -- from `Cost` with `normalizedItem` (existing)

The new `InvoiceLineItem` model covers the client-side view. For supplier-side, the existing `Cost` model already has `normalizedItem` and `amount`. Adding `quantity` and `unitPrice` to `Cost` would be valuable for supplier price comparison, but is a separate concern.

**Recommendation:** Add `quantity` and `unitPrice` fields to `Cost` model AS WELL, but as nullable optional fields (backward compatible). This gives full by-item pricing for both revenue and expense sides.

```prisma
model Cost {
  // ... existing fields ...
  quantity   Decimal? @db.Decimal(12, 4)   // NEW: optional, for granular price tracking
  unitPrice  Decimal? @map("unit_price") @db.Decimal(12, 2)  // NEW: optional
}
```

#### API Endpoints

| Endpoint | Purpose | Query Pattern |
|----------|---------|---------------|
| `GET /api/pricing-history/by-item?item=X` | All prices for normalized item X across all clients/suppliers | `InvoiceLineItem WHERE normalizedItem = X` + `Cost WHERE normalizedItem = X` |
| `GET /api/pricing-history/by-client?companyId=X` | All line items charged to company X | `InvoiceLineItem WHERE project.companyId = X` |
| `GET /api/pricing-history/by-supplier?supplierId=X` | All costs from supplier X with quantity detail | `Cost WHERE supplierId = X AND quantity IS NOT NULL` |

#### AI Import Update

The invoice import flow (`/api/ai/import/invoice` and `ai-auto-import.ts`) must be updated to:
1. Create `InvoiceLineItem` records (not just update revenue)
2. Persist `quantity` and `unitPrice` from AI extraction
3. Match `normalizedItem` using the same AI categorization as costs

**This is the highest-risk change in v2.3** because it modifies the AI import pipeline.

#### UI Components

| View | Component | Technology |
|------|-----------|-----------|
| By-item pricing table | `PricingHistoryByItem` | shadcn `Table` with date sorting, sparkline trend via `recharts` |
| By-client pricing table | `PricingHistoryByClient` | shadcn `Table` grouped by normalized item |
| View toggle | `Tabs` component | `@radix-ui/react-tabs` (already installed) |
| Item search | Combobox | `cmdk` (already installed) |

---

## Schema Migration Summary

All Prisma schema changes for v2.3:

```prisma
// 1. New enum
enum InternalEntity {
  MOTIONVII
  TALENTA
}

// 2. Project model changes
model Project {
  isInternal      Boolean         @default(false) @map("is_internal")
  internalEntity  InternalEntity? @map("internal_entity")
  companyId       String?         @map("company_id")  // Changed: now nullable
  company         Company?        @relation(...)       // Changed: now optional
  invoiceLineItems InvoiceLineItem[]  // New relation
}

// 3. Cost model additions (backward-compatible nullable fields)
model Cost {
  quantity   Decimal? @db.Decimal(12, 4)
  unitPrice  Decimal? @map("unit_price") @db.Decimal(12, 2)
}

// 4. New InvoiceLineItem model (see full definition above)

// 5. Document model addition
model Document {
  invoiceLineItems InvoiceLineItem[]  // New relation
}

// 6. Supplier model addition
model Supplier {
  invoiceLineItems InvoiceLineItem[]  // New relation
}

// 7. UserPreferences model addition
model UserPreferences {
  sidebarConfig Json? @map("sidebar_config") @db.Json  // New field
}
```

**Migration risk:** LOW for all except `Project.companyId` becoming nullable. Existing projects all have companies, so the data migration is safe. The constraint change needs careful handling:
- Run `prisma db push` or generate a migration
- No data backfill needed (all existing projects have companies)
- Form validation enforces company requirement for non-internal projects

---

## Alternatives Considered

| Category | Recommended | Alternative | Why Not |
|----------|-------------|-------------|---------|
| Modal fix | CSS/Tailwind on existing Radix | Install `react-modal` or `@headlessui/dialog` | Already deeply integrated with Radix; switching costs far exceed CSS fixes |
| Sidebar persistence | DB via `UserPreferences` JSON | localStorage only | Need cross-device sync; already have the API pattern |
| Sidebar persistence | DB via `UserPreferences` JSON | Dedicated `UserSidebarConfig` table | Over-normalized for a simple JSON preference |
| Pricing history model | New `InvoiceLineItem` model | Add to existing `Cost` model | Conflates revenue line items with expense costs |
| Internal project | `isInternal` boolean + `internalEntity` enum | Create dummy "Motionvii" and "Talenta" companies | Pollutes real CRM data with fake companies |
| Task creation UI | Dialog with project combobox | Inline form on /tasks page | Dialog is the established pattern; inline would be inconsistent |
| State management | React Context + fetch | Zustand / Jotai / Redux | Only 3 users; React Context is sufficient and already the pattern |

---

## What NOT to Install

These were evaluated and explicitly rejected:

| Package | Why Considered | Why Rejected |
|---------|---------------|--------------|
| `zustand` | Sidebar state management | React Context + API is already established; 3 users don't need client-state optimization |
| `@tanstack/react-table` | Pricing history tables | Existing shadcn Table + manual filtering works fine at this data scale; adding TanStack Table mid-project introduces a parallel pattern |
| `body-scroll-lock` | Modal scroll fix | Radix's built-in `react-remove-scroll` handles this; CSS fixes are sufficient |
| `vaul` | Better drawer/sheet component | Already have a working Sheet component with resize; switching adds risk |
| `@radix-ui/react-checkbox` | Sidebar item toggles | `@radix-ui/react-switch` (already installed) is more appropriate for on/off toggles |
| `swr` or `@tanstack/react-query` | API data fetching | Existing fetch-in-useEffect pattern is consistent across the codebase; adding a data fetching library mid-project fragments the codebase |

---

## Installation

```bash
# No new packages to install for v2.3
# All features buildable with existing dependencies

# Only Prisma schema changes and migration:
npx prisma db push
# or
npx prisma migrate dev --name v2.3-crm-ux-improvements
```

---

## Confidence Assessment

| Area | Confidence | Reason |
|------|------------|--------|
| Modal scroll fixes | HIGH | Verified against Radix docs, shadcn issues, and existing codebase; CSS-only changes |
| Sidebar customization | HIGH | Exact same pattern as existing `detailViewMode` persistence; proven in codebase |
| CRM standalone pages | HIGH | Copy-paste pattern from existing CRUD pages |
| Add Task button | HIGH | Existing task creation pattern + project combobox |
| Internal project flag | HIGH | Simple schema change + conditional UI |
| Line item pricing history | MEDIUM | New data model is sound, but AI import pipeline modification carries integration risk |
| Schema migration safety | HIGH | All changes are additive or nullable; no data loss scenarios |

---

## Sources

### HIGH Confidence (Official Documentation)
- [Radix Dialog Primitives](https://www.radix-ui.com/primitives/docs/components/dialog) -- scroll behavior, modal prop, overlay patterns
- [Radix Scroll Area](https://www.radix-ui.com/primitives/docs/components/scroll-area) -- viewport/scrollbar structure
- [shadcn/ui Sidebar](https://ui.shadcn.com/docs/components/sidebar) -- SidebarProvider persistence patterns

### HIGH Confidence (Issue Trackers)
- [shadcn/ui Issue #16: Dialog Overflow](https://github.com/shadcn-ui/ui/issues/16) -- canonical dialog scroll discussion
- [shadcn/ui PR #8103: Dialog vertical scroll fix](https://github.com/shadcn-ui/ui/pull/8103) -- the CSS fix approach
- [shadcn/ui Issue #6988: Body scroll lock](https://github.com/shadcn-ui/ui/issues/6988) -- body scroll blocking in Dialog/Popover

### MEDIUM Confidence (Community + Official)
- [Radix Primitives Discussion #1586](https://github.com/radix-ui/primitives/discussions/1586) -- react-remove-scroll shifting fixed headers
- [Redgate: ER Diagram for Invoice Management](https://www.red-gate.com/blog/erd-for-invoice-management) -- invoice line item schema patterns
- [Vertabelo: Billing System Database Model](https://vertabelo.com/blog/billing-system-database-model/) -- billing schema design patterns

### Codebase (Verified)
- `src/components/ui/dialog.tsx` -- current DialogContent with overflow-y-auto
- `src/components/ui/detail-view.tsx` -- DetailView wrapper with ScrollArea pattern
- `src/components/ui/sheet.tsx` -- Sheet with resizable pattern
- `src/lib/detail-view-context.tsx` -- DB-persisted preference via Context pattern
- `src/lib/hooks/use-nav-collapse-state.ts` -- localStorage sidebar collapse
- `src/lib/nav-config.ts` -- Static nav configuration
- `src/app/api/user/preferences/route.ts` -- Upsert preference API
- `src/types/ai-extraction.ts` -- InvoiceLineItem type with quantity/unitPrice
- `src/app/api/ai/import/invoice/route.ts` -- Current import (no line item persistence)
- `src/app/api/supplier-items/route.ts` -- Price comparison queries
- `prisma/schema.prisma` -- Full schema with UserPreferences, Cost, Document models
