# Domain Pitfalls: Collapsible Navigation, Cross-Project Tasks, Member Workload (v2.1)

**Domain:** Sidebar navigation refactoring, cross-project task aggregation, team workload dashboards
**Project:** SAAP 2026 v2
**Context:** Adding collapsible sidebar groups, a cross-project task page with table+kanban toggle, and per-member workload dashboards to an existing Next.js 14 app with Prisma/MariaDB, 3 hardcoded team members, and duplicated desktop/mobile navigation components.
**Researched:** 2026-01-27
**Confidence:** HIGH (verified against codebase analysis -- sidebar.tsx, mobile-sidebar.tsx, mobile-nav.tsx, schema.prisma, kanban-board.tsx, team-workload.tsx)

---

## Critical Pitfalls

Mistakes that cause rewrites or major architectural issues.

### Pitfall 1: Navigation Source Duplication -- Desktop and Mobile Drift Further Apart

**What goes wrong:** The codebase already has THREE navigation components with separately defined link arrays that have drifted out of sync. Adding collapsible groups to the desktop sidebar without a shared navigation data source will worsen this problem, making every future nav change require edits in 3 files with high risk of missed updates.

**Why it happens:** The current state is:
- `sidebar.tsx` (lines 26-35): Inline `navigation` array with 8 items, plus CRM links hardcoded individually (lines 80-151) including "Price Comparison"
- `mobile-sidebar.tsx` (lines 28-45): Separate `navigation` array (8 items) and `crmNavigation` array (5 items) -- **missing "Price Comparison"** (the `Scale` icon is not even imported)
- `mobile-nav.tsx` (lines 8-13): Bottom nav bar with only 4 items (Dashboard, Initiatives, CRM, Events)

The "Price Comparison" link is already missing from mobile-sidebar.tsx. When collapsible groups are added, the temptation is to restructure only `sidebar.tsx` and leave the mobile components as-is, worsening drift.

**Why it happens:** Each component was built independently. The desktop sidebar (`sidebar.tsx`) hardcodes CRM links individually (not as an array), while the mobile sidebar (`mobile-sidebar.tsx`) uses an array for CRM items but with a different set. There is no shared navigation configuration.

**Consequences:** Users on mobile cannot access Price Comparison. Any new nav item added to one component but not the others creates an access gap. Testing all three surfaces for every nav change is error-prone.

**Prevention:**
1. **Create a single navigation configuration file** (`src/lib/navigation.ts` or `src/config/navigation.ts`) that defines all nav items with their groups, icons, href, and role requirements
2. **Both sidebar components consume the same config.** Desktop sidebar renders groups as collapsible sections; mobile sidebar renders as flat list with section headers (current pattern); mobile bottom nav renders a curated subset
3. **Fix the existing bug first:** Add "Price Comparison" to `mobile-sidebar.tsx` crmNavigation array before any refactoring
4. **Use TypeScript to enforce structure:** Define a `NavGroup` type that both components must consume, so adding a link in one place automatically adds it everywhere

**Warning signs:**
- Modifying sidebar.tsx without checking mobile-sidebar.tsx
- New links appearing on desktop but not mobile
- CRM section in desktop sidebar using individual `<Link>` elements instead of mapping over an array

**Detection:** Diff the href values across all three navigation components. Any mismatch is a bug.

**Phase to address:** Phase 1 (Collapsible Navigation). This is the first thing to fix -- unify the data source before restructuring the rendering.

---

### Pitfall 2: Cross-Project Task Query N+1 or Cartesian Explosion

**What goes wrong:** The existing task API is scoped to a single project (`GET /api/projects/[id]/tasks`). Building a cross-project task view requires fetching tasks across ALL projects. The naive approach -- fetching each project's tasks separately -- creates N+1 queries. The alternative -- a single Prisma query with deep includes -- risks returning a cartesian product of tasks x tags x comments that balloons response size.

**Why it happens:** The current `prisma.task.findMany({ where: { projectId: id } })` pattern (in `src/app/api/projects/[id]/tasks/route.ts`) is designed for single-project context. It includes `tags: { include: { tag: true } }` and `_count: { select: { children: true, comments: true } }`. When this runs across ALL projects with no projectId filter, the response includes every task in the system with all their tags and child counts.

Additionally, the Task model has a self-referencing parent-child relationship (`parentId` FK) with up to 5 levels of depth. Cross-project queries must decide: do you show root tasks only? Do you flatten the hierarchy? Do you include subtasks? Each choice has different performance characteristics.

**Consequences:** Slow page loads, excessive memory usage, potential MariaDB query timeout on NAS deployment.

**Prevention:**
1. **Create a dedicated cross-project tasks endpoint** (`/api/tasks` without the project scope) with pagination, filtering (by assignee, status, project, due date), and lean includes
2. **Fetch root tasks only by default** (`where: { parentId: null }`) -- show subtask counts but do not load full subtree. Load children on-demand when a task row is expanded
3. **Use `select` to fetch only needed fields** -- for a table/kanban view you need id, title, status, priority, assignee, dueDate, project.title -- not description, comments, or full tag objects
4. **Add server-side pagination** -- even with ~50 projects, task counts can grow. Use cursor-based pagination or limit+offset
5. **Add database indexes** -- the Task table already has `@@index([assignee])`, `@@index([status])`, and `@@index([dueDate])` which will support common cross-project filters

**Warning signs:**
- API response time >500ms for the tasks endpoint
- Response payload >50KB for a task list
- Frontend fetching tasks from multiple project endpoints in a loop
- Prisma query logs showing multiple SELECT statements for a single page load

**Detection:** Enable Prisma query logging during development. Count the number of SQL statements per page load.

**Phase to address:** Phase 2 (Cross-Project Task View). Design the API before building any UI.

---

### Pitfall 3: Table-Kanban View Toggle Losing DnD State or Causing Stale Renders

**What goes wrong:** When toggling between table and kanban views, the `DndContext` from @dnd-kit must be properly mounted/unmounted. If a user initiates a drag in kanban view and the component unmounts (view toggle, navigation, data refresh), orphaned drag state causes crashes, incorrect card positions, or frozen UI. Additionally, if both views share the same data source but maintain separate local state copies, edits in one view do not reflect in the other.

**Why it happens:** The existing `kanban-board.tsx` manages drag state (`activeId`, `isDragging`), item positions, and optimistic updates as local `useState`. This pattern works when the kanban is the only view. When a table view is added alongside it with a toggle, two problems emerge:
1. **DndContext lifecycle:** Toggling away from kanban while `isDragging === true` unmounts the `DndContext` without calling `onDragEnd`, leaving state dirty
2. **Data divergence:** If the table view has its own state (e.g., inline editing, sorting), and the kanban has its own state, switching between them after making changes in one shows stale data in the other

The existing kanban board uses `initialData` as a prop and manages all mutations locally with `setInitiatives`. This pattern means the parent page component must be the single source of truth for data, not each view.

**Consequences:** Cards appear in wrong columns after view toggle. Edits made in table view not visible in kanban. Browser console errors about unmounted component state updates.

**Prevention:**
1. **Lift state to the parent page component.** The cross-project tasks page owns the task data array. Both table and kanban views receive data as props and emit events for mutations. Neither view maintains its own copy of the data
2. **Guard DnD unmount:** Before toggling views, check if `isDragging` is true. If so, either block the toggle or cancel the drag programmatically via `DndContext`'s `cancelDrop` or by resetting `activeId` before unmount
3. **Use a single mutation API.** Both views call the same update function (passed as prop) which updates the shared state and persists to the server. No separate fetch/update logic per view
4. **Remount DndContext cleanly:** Use a key prop on the DndContext wrapper that changes when switching to kanban view, forcing a clean mount: `<div key={viewMode === 'kanban' ? 'kanban' : 'none'}>`

**Warning signs:**
- `useState` for task data inside both the table and kanban child components
- React warning: "Can't perform a React state update on an unmounted component"
- Cards in wrong position after toggling views
- Table showing different task status than kanban for the same task

**Detection:** Toggle rapidly between views while a drag is in progress. Edit a task in table view, toggle to kanban, verify the change is visible.

**Phase to address:** Phase 2 (Cross-Project Task View). Architecture decision on state ownership must be made before building either view.

---

### Pitfall 4: Owner/Assignee Field Type Mismatch Across Models Breaks Workload Aggregation

**What goes wrong:** Building a per-member workload dashboard requires aggregating work items across multiple models. But the "owner" field is stored differently in each model, making unified queries impossible without normalization:

| Model | Field | Type | Values |
|-------|-------|------|--------|
| `Initiative` | `personInCharge` | `TeamMember?` (enum) | `KHAIRUL`, `AZLAN`, `IZYANI`, `null` |
| `Task` | `assignee` | `TeamMember?` (enum) | `KHAIRUL`, `AZLAN`, `IZYANI`, `null` |
| `KeyResult` | `owner` | `String` (VarChar 100) | Free text -- could be "Khairul", "KHAIRUL", "khairul" |
| `SupportTask` | `owner` | `String` (VarChar 100) | Free text -- could be "Khairul", "KHAIRUL", "khairul" |

The Initiative and Task models use the `TeamMember` enum (case-sensitive, uppercase). KeyResult and SupportTask use free-text strings. The existing `formatTeamMember()` utility in `utils.ts` maps enum values to display names but cannot handle arbitrary strings.

**Why it happens:** The schema comment on KeyResult.owner explicitly says: `// String per requirements, not TeamMember enum`. This was a deliberate design decision (owners might include external stakeholders). But for workload dashboards, you need to aggregate across all four models by person, and `"KHAIRUL"` (enum) !== `"Khairul"` (string) in a query.

**Consequences:** Workload dashboard shows a member with 0 key results or 0 support tasks when they actually have several. Or worse, shows "Khairul" and "KHAIRUL" as separate people.

**Prevention:**
1. **Normalize on read, not on write.** When aggregating for workload, apply `.toUpperCase()` to string owner fields before grouping. MariaDB's default collation (`utf8mb4_general_ci`) is case-insensitive for LIKE/= comparisons, but Prisma's `groupBy` may return the original casing
2. **Create a server-side aggregation function** that queries each model separately and merges results by normalized name. Do NOT try to write a single cross-model query
3. **Map known owners explicitly:** Since there are only 3 team members, create a mapping function: `normalizeOwner(name: string): TeamMember | null` that handles known variations ("Khairul" -> "KHAIRUL", "azlan" -> "AZLAN", etc.)
4. **Show unrecognized owners clearly:** If KeyResult.owner contains "External Vendor", the workload dashboard should show this under an "Other" category, not silently drop it
5. **Long-term: Consider migrating KeyResult.owner and SupportTask.owner** to the TeamMember enum with an optional freetext fallback, but this is a schema change and should not block v2.1

**Warning signs:**
- Dashboard showing member with 0 items in a category they definitely own
- Same person appearing twice with different name casing
- Total workload count not matching sum of individual model counts
- `groupBy` results containing unexpected owner values

**Detection:** Query `SELECT DISTINCT owner FROM key_results` and `SELECT DISTINCT owner FROM support_tasks` in MariaDB. Compare with TeamMember enum values.

**Phase to address:** Phase 3 (Workload Dashboard). Must design the normalization strategy before writing any aggregation queries.

---

## Moderate Pitfalls

Mistakes that cause delays, technical debt, or confusing UX.

### Pitfall 5: Sidebar Collapse State -- localStorage Hydration Flash

**What goes wrong:** Storing sidebar collapse state in localStorage causes a visible flash on page load. The server renders the sidebar expanded (it has no localStorage access), then the client hydrates and reads localStorage to discover it should be collapsed, causing a jarring visual shift.

**Why it happens:** Next.js App Router uses server-side rendering. The dashboard layout (`src/app/(dashboard)/layout.tsx`) renders `<Sidebar />` and `<main className="md:pl-64">` on the server. If the user previously collapsed the sidebar, the server does not know this. On hydration, the sidebar jumps from expanded to collapsed, and the main content area shifts from `pl-64` to a smaller padding.

The current codebase uses localStorage only in `sheet.tsx` (for the mobile sidebar's open/close via Radix Sheet). The desktop sidebar has NO collapse state at all -- it is always expanded. Adding collapse+persistence introduces this hydration issue.

**Prevention:**
1. **Use cookies instead of localStorage** for sidebar state. Cookies are sent with every request and readable server-side. The shadcn/ui Sidebar component recommends this pattern: `const defaultOpen = cookieStore.get("sidebar_state")?.value === "true"` in the server component
2. **Alternatively, accept the flash** with a CSS trick: render the sidebar with `opacity-0` on initial load and transition to `opacity-100` after hydration. This hides the flash at the cost of a brief invisible sidebar (~50ms)
3. **Do NOT use shadcn/ui's SidebarProvider pattern** if targeting Next.js 16+ in the future, as it has a known blocking route issue. Cookies work but require careful Suspense boundary handling in Next.js 16
4. **Keep it simple for 3 users:** A controlled `useState` in the layout with no persistence is the simplest option. With only 3 users on an internal tool, re-expanding after page refresh is a minor inconvenience

**Warning signs:**
- Sidebar jumps from expanded to collapsed on page load
- `md:pl-64` on main content flickers to a different value
- Hydration mismatch warnings in browser console
- Users complaining about "sidebar keeps resetting"

**Detection:** Set sidebar to collapsed, hard-refresh the page, watch for layout shift.

**Phase to address:** Phase 1 (Collapsible Navigation). Decide persistence strategy before implementing collapse.

---

### Pitfall 6: Collapsible Groups Active State -- Child Link Active but Group Collapsed

**What goes wrong:** User navigates to `/supplier-items` (Price Comparison) via direct URL or bookmark. The sidebar renders with the CRM group collapsed because of saved preference. The user sees NO active link highlighted, cannot tell which section they are in, and the sidebar provides no navigation context.

**Why it happens:** Collapsible groups hide their children when collapsed. The `isActive` logic (currently `pathname === item.href || pathname.startsWith(item.href)`) runs inside the collapsed section and is invisible. The group header has no indication that one of its children is active.

**Consequences:** Users lose navigation context. They do not know which section contains the current page. They must expand every group to find the active link.

**Prevention:**
1. **Auto-expand the group containing the active link.** On mount and on route change, check if any child link in a collapsed group matches the current pathname. If so, expand that group
2. **Show active indicator on group header.** Even when collapsed, show a subtle dot or highlight on the group header if any child is active. Example: "CRM" header shows a blue dot when the current page is under CRM
3. **Store expand state per-group, not as single boolean.** Each group (Main, CRM, Admin) needs independent expand/collapse state. Collapsing CRM should not collapse Admin
4. **Initialize from route:** On first render, compute which groups should be open based on current pathname, then allow user to manually collapse/expand

**Warning signs:**
- Navigating to a page shows no active link in sidebar
- All groups collapsed on initial page load despite being on a nested page
- User has to click through groups to find where they are

**Detection:** Navigate directly to `/supplier-items` (a deep CRM link). Verify the CRM group is expanded and Price Comparison is highlighted.

**Phase to address:** Phase 1 (Collapsible Navigation). Active state logic must account for collapsed groups.

---

### Pitfall 7: Cross-Project Kanban Column Definition Mismatch

**What goes wrong:** The existing initiatives kanban board (`kanban-board.tsx`) uses consolidated columns that map multiple statuses to single columns (e.g., ON_HOLD + AT_RISK -> "Needs Attention", COMPLETED + CANCELLED -> "Done"). The Task model uses a completely different status enum (`TODO`, `IN_PROGRESS`, `DONE`) with only 3 values. If the cross-project task kanban reuses the initiative kanban's column structure, the mapping is wrong. If it defines new columns, the UX is inconsistent.

**Why it happens:**
- Initiative statuses: `NOT_STARTED`, `IN_PROGRESS`, `ON_HOLD`, `AT_RISK`, `COMPLETED`, `CANCELLED` (6 statuses -> 4 columns)
- Task statuses: `TODO`, `IN_PROGRESS`, `DONE` (3 statuses -> 3 columns naturally)

The column definitions, status-to-column mappings, and column-to-status mappings are all hardcoded constants in `kanban-board.tsx`. They cannot be reused for tasks without modification.

**Consequences:** Drag-and-drop updates tasks to wrong status. "Needs Attention" column has no meaning for tasks. Users confused by different column layouts across kanban views.

**Prevention:**
1. **Define task-specific kanban columns** that map to TaskStatus enum: "To Do" (TODO), "In Progress" (IN_PROGRESS), "Done" (DONE). Do NOT try to reuse the initiative kanban column config
2. **Extract a reusable KanbanBoard component** that accepts column configuration as props, not hardcoded constants. The existing kanban board is tightly coupled to Initiative types. Build a generic wrapper: `<ConfigurableKanban columns={taskColumns} items={tasks} />`
3. **Or build the task kanban from scratch** using the same @dnd-kit patterns but with task-specific column/status mappings. Given that the existing kanban is 586 lines with initiative-specific logic throughout, extraction may be more work than a purpose-built component
4. **Include task priority as a visual element** in kanban cards (HIGH/MEDIUM/LOW) since tasks have priority but initiatives do not, making cards visually distinct

**Warning signs:**
- Importing COLUMNS or STATUS_TO_COLUMN from the initiative kanban for task use
- Task dragged to "Needs Attention" column (does not exist in Task model)
- Task kanban showing 4 columns when Task has only 3 statuses

**Detection:** Review column configuration in the task kanban. Verify each column maps to a valid TaskStatus value.

**Phase to address:** Phase 2 (Cross-Project Task View). Column configuration should be defined during component planning.

---

### Pitfall 8: Workload Dashboard Double-Counting from Task Hierarchy

**What goes wrong:** The Task model supports 5 levels of subtask nesting (parent-child self-reference). When counting tasks per assignee for workload, counting ALL tasks includes both parent tasks and their subtasks. If a parent task has 3 subtasks and all are assigned to KHAIRUL, the workload shows 4 tasks (1 parent + 3 children) when functionally it represents 1 work item with 3 sub-items.

**Why it happens:** A simple `groupBy` on assignee counts every row in the Task table:
```
SELECT assignee, COUNT(*) FROM tasks GROUP BY assignee
```
This counts parent and children equally. Some teams want this (each subtask is independent work). Others want only root tasks counted (subtasks are breakdowns of the parent). The correct answer depends on how SAAP uses subtasks.

Additionally, the `depth` field (0-4) and `parentId` allow filtering, but the semantics must be defined: does "workload" mean "number of top-level tasks assigned" or "total items including subtasks"?

**Consequences:** Workload appears inflated for members who use subtasks. Members who create flat task lists appear to have less work than those who break tasks into subtasks. Misleading workload comparison.

**Prevention:**
1. **Count root tasks only by default** (`where: { parentId: null }`). Show subtask count as supplementary info ("12 tasks, 34 subtasks")
2. **Or weight by depth:** Root tasks count as 1, depth-1 subtasks count as 0.5, deeper as 0.25. This is more complex but more accurate
3. **Simplest approach for 3 users:** Count only root-level tasks per project per person. Display as "X tasks across Y projects." Subtask breakdown is a detail view, not a summary metric
4. **Let the dashboard show both views:** A toggle between "tasks assigned" (all) and "work items" (root only). Label clearly

**Warning signs:**
- One member showing 50 tasks when others show 10 (likely subtask inflation)
- Workload numbers not matching intuition
- Users asking "why does it say I have 50 tasks?"

**Detection:** Compare `COUNT(*) WHERE assignee = 'X'` vs `COUNT(*) WHERE assignee = 'X' AND parentId IS NULL` for each member.

**Phase to address:** Phase 3 (Workload Dashboard). Define counting semantics during planning.

---

### Pitfall 9: Workload Dashboard Missing Unassigned and Cross-Model Blind Spots

**What goes wrong:** The workload dashboard aggregates tasks by assignee but misses work items that are tracked in other models (initiatives, support tasks, key results). A team member's true workload includes initiatives they are personInCharge for, tasks assigned to them, support tasks they own, and key results they own. Showing only task count gives an incomplete picture.

**Why it happens:** Tasks are the most granular work item, so it seems natural to build workload around them. But the existing `team-workload.tsx` component already counts initiatives by `personInCharge` (it receives `data` from the dashboard page's `groupBy personInCharge` query). If the workload dashboard only counts tasks, it contradicts the existing dashboard widget.

The 3 team members have responsibilities across:
- Initiatives (personInCharge: TeamMember enum)
- Tasks (assignee: TeamMember enum)
- Key Results (owner: String -- see Pitfall 4)
- Support Tasks (owner: String -- see Pitfall 4)

**Consequences:** Dashboard shows a team member as "lightly loaded" when they actually own 5 key results and 10 support tasks but few project tasks. Management decisions based on incomplete data.

**Prevention:**
1. **Design the workload dashboard as a multi-model aggregate from the start.** Show separate counts per model: "3 initiatives, 12 tasks, 2 key results, 5 support tasks"
2. **Use a composite workload score** if needed: each work type has a weight (initiative = 5, task = 1, key result = 3, support task = 2). Total score gives relative workload. Make weights configurable
3. **At minimum, show categories separately:** A stacked bar or multi-metric card per member showing contribution from each model type
4. **Handle unassigned items:** Show a row/card for "Unassigned" items across all models. This surfaces work that nobody owns

**Warning signs:**
- Workload only showing tasks, ignoring initiatives
- Team member showing as idle when they own key results
- No "Unassigned" category visible

**Detection:** Query each model for items owned by each member. Compare totals with what the dashboard displays.

**Phase to address:** Phase 3 (Workload Dashboard). Decide scope of "workload" before building queries.

---

### Pitfall 10: Mobile Bottom Nav Overflow When Adding New Pages

**What goes wrong:** The mobile bottom navigation (`mobile-nav.tsx`) currently has exactly 4 items in a `grid-cols-4` layout. Adding new top-level pages (like a cross-project tasks page or workload dashboard) requires adding items to this bar, but 5+ items in a bottom nav become cramped and hard to tap on mobile.

**Why it happens:** The bottom nav was designed for 4 items. The grid layout is hardcoded to `grid-cols-4`. Adding a 5th item requires changing to `grid-cols-5`, which makes each item ~20% narrower. Mobile UX research consistently shows that bottom navigation bars work best with 3-5 items; beyond 5 is unusable.

Current items: Dashboard, Initiatives, CRM, Events. New candidates: Tasks (cross-project), Workload. That would be 6 items.

**Consequences:** Bottom nav items too small to tap. Icon-only navigation with no labels. Inconsistent with desktop navigation which shows everything.

**Prevention:**
1. **Do NOT add items to the bottom nav.** Keep it at 4 items as quick-access shortcuts. New pages are accessible via the mobile sidebar (hamburger menu) which already shows all links
2. **Replace one bottom nav item** if the new page is more important. For example, replace "Events" with "Tasks" if cross-project tasks is a primary workflow
3. **Use a "More" menu pattern** as the 5th item. Tapping "More" opens the mobile sidebar. This is the iOS/Material Design standard for overflow navigation
4. **Consider the bottom nav as curated, not comprehensive.** Desktop sidebar = full navigation. Mobile bottom nav = top 4 most-used pages. Mobile sidebar = everything else

**Warning signs:**
- Adding a 5th or 6th item to `mobileNavItems` array
- Grid changing to `grid-cols-5` or `grid-cols-6`
- Nav labels being removed to save space
- Touch targets smaller than 48x48px (WCAG minimum)

**Detection:** Test on a 320px-wide viewport. Verify all bottom nav items have labels and are tappable.

**Phase to address:** Phase 1 (Navigation refactoring). Decide bottom nav strategy as part of navigation unification.

---

## Minor Pitfalls

Mistakes that cause annoyance but are fixable.

### Pitfall 11: Collapsible Animation Jank from Content Height Changes

**What goes wrong:** The existing `Collapsible` component (`src/components/ui/collapsible.tsx`) uses `@radix-ui/react-collapsible` which animates height. If collapsible group content changes (e.g., badge counts update, new link added dynamically), the animation can jank because the target height was calculated before the content changed.

**Prevention:** Use CSS `grid-template-rows: 0fr / 1fr` transition pattern or Radix's built-in `data-state` attribute for CSS animations rather than JS-calculated heights. For nav groups with static content, this is unlikely to be a problem.

**Phase to address:** Phase 1, during implementation.

---

### Pitfall 12: Cross-Project Task Kanban Showing Too Many Projects

**What goes wrong:** The kanban view works well for a single project with 10-30 tasks. A cross-project view might show tasks from 50+ projects, resulting in 100+ cards across 3 columns. The kanban becomes an unscrollable wall of cards with no useful organization.

**Prevention:** Default to filtered views: show only the current user's tasks, or only tasks due this week. Provide progressive disclosure -- user starts filtered, expands as needed. For the table view, pagination handles this naturally. For kanban, limit visible cards per column (e.g., 20) with a "Show more" button.

**Phase to address:** Phase 2, during UI design.

---

### Pitfall 13: MariaDB GROUP BY with Prisma Quirks

**What goes wrong:** MariaDB's `ONLY_FULL_GROUP_BY` mode (enabled by default in modern versions) requires all selected columns to be in the GROUP BY clause or an aggregate function. Prisma's `groupBy` handles this correctly, but if you use `$queryRaw` for complex aggregations across models, you must manually ensure GROUP BY compliance.

**Prevention:** Prefer Prisma's type-safe `groupBy` over raw queries. If raw queries are needed for cross-model aggregation, test them against MariaDB directly before wrapping in Prisma. Note: MariaDB is configured as `provider = "mysql"` in the schema.

**Phase to address:** Phase 3, during query implementation.

---

## Technical Debt Patterns

| Shortcut | Immediate Benefit | Long-term Cost | When Acceptable |
|----------|-------------------|----------------|-----------------|
| Add collapsible groups to sidebar.tsx only, ignore mobile-sidebar.tsx | Ship faster | Mobile navigation diverges further; Price Comparison stays missing | Never -- fix the shared config first |
| Copy kanban-board.tsx and modify for tasks | Reuse existing drag-drop logic | Two near-identical 586-line components to maintain | Acceptable for v2.1 if you extract shared utilities; refactor to generic component in v2.2 |
| Count all tasks (including subtasks) for workload | Simpler query | Misleading workload numbers | Only if subtask usage is minimal; add parentId filter later |
| Skip cross-model aggregation, show only task workload | Faster to build | Incomplete workload picture | Acceptable for v2.1 MVP with plan to add initiative/KR/ST counts in v2.2 |
| localStorage for sidebar state | No cookie setup needed | Hydration flash on every page load | Acceptable for 3 internal users; use cookies if it annoys them |
| Hardcode 3 team members in workload dashboard | No member management UI needed | Adding a 4th member requires code change | Acceptable given `TeamMember` enum is already hardcoded; add member management in v3.0 |

---

## Performance Traps

| Trap | Symptoms | Prevention | When It Breaks |
|------|----------|------------|----------------|
| Cross-project task query without pagination | Slow page load, large JSON payload | Cursor pagination, limit 50 per page | When total tasks > 200 |
| Fetching full task tree for every project in workload | Multiple recursive queries | Count only root tasks, use `_count` aggregate | When projects > 20 with deep task trees |
| Re-mounting DndContext on every filter change | Drag state reset, animation jank | Stable key on DndContext, filter in render not in state | Immediately, on first filter interaction |
| workload dashboard querying 4 models sequentially | Waterfall of 4+ DB queries | Use `Promise.all` for parallel queries or combine into single server component | At 3 users this is ~100ms; matters at scale |
| Sidebar collapse animation on mobile with many groups | Janky animation on low-end devices | Use CSS transforms, avoid layout-triggering properties | On older phones with 5+ collapsible groups |

---

## UX Pitfalls

| Pitfall | User Impact | Better Approach |
|---------|-------------|-----------------|
| Collapsing all sidebar groups by default | Users cannot find any links | Default to all expanded; remember user preference |
| Kanban view as default for cross-project tasks | Overwhelming with 100+ cards | Default to table view; kanban is opt-in for focused views |
| Workload showing raw numbers without context | "12 tasks" means nothing without knowing capacity | Show percentage of team average, or relative bar chart (current pattern in team-workload.tsx is good) |
| Task table without project name column | Cannot tell which project a task belongs to | Always show project name in cross-project context; allow grouping by project |
| Kanban drag-drop changing project assignment | User expects to change status, accidentally changes project | Kanban columns = status only; project is not changeable via drag |
| Workload dashboard accessible only to admins | Team members want to see their own workload | Show personal workload to everyone; show team comparison to admins |
| Sidebar collapse button hard to find | Users do not discover they can collapse | Use the shadcn/ui pattern: trigger button + tooltip, or double-click sidebar edge |

---

## "Looks Done But Isn't" Checklist

Before considering each feature complete:

**Collapsible Navigation:**
- [ ] Single navigation config shared by sidebar.tsx, mobile-sidebar.tsx, and mobile-nav.tsx
- [ ] Price Comparison link present in mobile sidebar (existing bug fixed)
- [ ] Active link visible even when its group is collapsed (auto-expand or group indicator)
- [ ] Collapse state persists across page navigations (cookie or localStorage)
- [ ] No hydration flash when sidebar state is restored
- [ ] Admin section still role-gated when in collapsible group
- [ ] Keyboard accessible: Enter/Space toggles group, Tab navigates between groups
- [ ] Mobile sidebar hamburger menu still works alongside bottom nav

**Cross-Project Task View:**
- [ ] Dedicated API endpoint with pagination, NOT per-project fetches
- [ ] Table view shows: title, project name, status, priority, assignee, due date
- [ ] Table supports sorting by any column
- [ ] Table supports filtering by project, assignee, status, priority
- [ ] Kanban view has 3 columns matching TaskStatus (TODO, IN_PROGRESS, DONE)
- [ ] Kanban drag-drop updates task status, NOT project assignment
- [ ] View toggle preserves filters and scroll position
- [ ] Switching views does not lose unsaved edits
- [ ] DndContext properly cleaned up on view toggle
- [ ] Root tasks shown by default; subtasks expandable on demand
- [ ] Empty state for "No tasks across any project"
- [ ] Project name links to project detail page

**Per-Member Workload Dashboard:**
- [ ] Aggregates across initiatives, tasks, key results, and support tasks
- [ ] Owner field normalization handles case differences (KHAIRUL vs Khairul)
- [ ] Subtask counting strategy defined and documented
- [ ] Unassigned items visible as separate category
- [ ] Shows per-member breakdown by work type (initiative, task, KR, support task)
- [ ] Works with current 3 hardcoded team members
- [ ] Does not break if a 4th member is added to TeamMember enum
- [ ] Shows overdue items per member (tasks past due date, initiatives past end date)
- [ ] Personal view (own workload) available to all roles
- [ ] Team comparison view available to ADMIN/EDITOR roles

---

## Pitfall-to-Phase Mapping

| Pitfall | # | Severity | Prevention Phase | Verification |
|---------|---|----------|------------------|--------------|
| Navigation source duplication | 1 | CRITICAL | Phase 1: Collapsible Navigation | Verify all 3 nav components consume shared config; Price Comparison visible on mobile |
| Cross-project task N+1 queries | 2 | CRITICAL | Phase 2: Cross-Project Tasks API | Enable Prisma query logging; verify single query per page load |
| Table-kanban DnD state collision | 3 | CRITICAL | Phase 2: View toggle architecture | Toggle views during active drag; verify no crash or stale data |
| Owner field type mismatch | 4 | CRITICAL | Phase 3: Workload queries | Query distinct owners across all 4 models; verify all map to team members |
| Sidebar hydration flash | 5 | MODERATE | Phase 1: Persistence strategy | Hard refresh with collapsed state; measure layout shift |
| Active link in collapsed group | 6 | MODERATE | Phase 1: Collapse UX | Navigate to deep link via URL; verify group auto-expands |
| Kanban column mismatch | 7 | MODERATE | Phase 2: Kanban config | Verify columns match TaskStatus enum exactly |
| Task hierarchy double-counting | 8 | MODERATE | Phase 3: Counting strategy | Compare root-only vs all-tasks counts per member |
| Cross-model blind spots | 9 | MODERATE | Phase 3: Workload scope | Verify dashboard includes initiatives + tasks + KRs + STs |
| Mobile bottom nav overflow | 10 | MODERATE | Phase 1: Navigation planning | Test with 320px viewport; verify 4-item limit |
| Collapse animation jank | 11 | MINOR | Phase 1: Implementation | Test on low-end device; verify smooth animation |
| Kanban card overflow | 12 | MINOR | Phase 2: UI design | Load 100+ tasks; verify kanban is usable |
| MariaDB GROUP BY quirks | 13 | MINOR | Phase 3: Query testing | Test all groupBy queries against MariaDB directly |

---

## SAAP-Specific Context Notes

These pitfalls account for the specific SAAP constraints:

1. **3 hardcoded team members (KHAIRUL, AZLAN, IZYANI):** Workload is a very small aggregation problem. The risk is not performance but data accuracy (owner field mismatches across models).

2. **Mixed owner field types:** The deliberate schema decision to use String for KeyResult.owner and SupportTask.owner (to allow external stakeholders) creates a normalization burden for workload dashboards. This is the highest-risk data issue.

3. **NAS deployment:** Cross-project queries across all tasks should be fast even on NAS. The concern is response size, not query time, since the dataset is small.

4. **3 navigation components already diverged:** The Price Comparison link is already missing from mobile. Any navigation change that does not address the shared-config problem makes things worse.

5. **@dnd-kit v6.3.1 / v10.0.0 already in use:** The cross-project kanban can reuse the same library. However, @dnd-kit/core v6.3.1 and @dnd-kit/sortable v10.0.0 are from different major version lines, which may indicate a recent partial upgrade. Verify compatibility.

6. **Existing patterns to reuse:**
   - `team-workload.tsx`: Already shows per-member initiative counts with avatar + progress bar. Extend this pattern for multi-model workload
   - `kanban-board.tsx`: DnD patterns, collision detection, optimistic updates. Copy patterns, not the component itself
   - `Collapsible` (Radix): Already installed and exported from `ui/collapsible.tsx`. Use for sidebar groups

---

## Sources

### Navigation Patterns
- [shadcn/ui Sidebar component documentation](https://ui.shadcn.com/docs/components/sidebar)
- [shadcn/ui Sidebar blocks (pre-built patterns)](https://ui.shadcn.com/blocks/sidebar)
- [Next.js 16 SidebarProvider blocking route bug](https://github.com/shadcn-ui/ui/issues/9189)
- [Building a Collapsible Admin Sidebar -- DEV Community](https://dev.to/cristiansifuentes/building-a-collapsible-admin-sidebar-with-react-router-uselocation-pro-patterns-7im)
- [React responsive collapsible sidebar with Tailwind](https://reacthustle.com/blog/nextjs-react-responsive-collapsible-sidebar-tailwind)

### Cross-Project Queries / Prisma Performance
- [Prisma ORM Performance Optimization Tips 2025](https://www.urhoba.net/2025/11/prisma-orm-performance-optimization-tips.html)
- [Prisma Deep-Dive Handbook 2025](https://dev.to/mihir_bhadak/prisma-deep-dive-handbook-2025-from-zero-to-expert-1761)
- [Prisma multiple projects single database discussion](https://github.com/prisma/prisma/discussions/12350)

### Kanban / DnD Patterns
- [Build a Kanban board with dnd-kit and React -- LogRocket](https://blog.logrocket.com/build-kanban-board-dnd-kit-react/)
- [React DnD-kit + Tailwind + shadcn/ui Kanban](https://github.com/Georgegriff/react-dnd-kit-tailwind-shadcn-ui)
- [Drag and Drop Kanban Board in React with dnd-kit](https://plaintext-engineering.com/blog/drag-n-drop-kanban-board-react/)

### Case-Insensitive Matching / MariaDB
- [SQL Case-Insensitive Text Matching Tricks](https://alexanderobregon.substack.com/p/query-tricks-for-sql-case-insensitive)
- [MySQL Pattern Matching documentation](https://dev.mysql.com/doc/mysql-tutorial-excerpt/8.0/en/pattern-matching.html)
- [Use the Index Luke -- Case-Insensitive Search](https://use-the-index-luke.com/sql/where-clause/functions/case-insensitive-search)

### Codebase Analysis (PRIMARY SOURCE)
- `src/components/layout/sidebar.tsx` -- Desktop navigation with hardcoded CRM links
- `src/components/layout/mobile-sidebar.tsx` -- Mobile navigation missing Price Comparison
- `src/components/layout/mobile-nav.tsx` -- Bottom nav with 4 items in grid-cols-4
- `src/components/kanban/kanban-board.tsx` -- Initiative kanban with @dnd-kit, 4 consolidated columns
- `src/components/dashboard/team-workload.tsx` -- Existing workload widget with 3 hardcoded members
- `prisma/schema.prisma` -- Task (TeamMember enum assignee), KeyResult (String owner), SupportTask (String owner)
- `src/lib/utils.ts` -- formatTeamMember() only handles enum values

---
*Pitfalls research for: Collapsible Navigation, Cross-Project Task Views, Member Workload Dashboards (v2.1)*
*Researched: 2026-01-27*
