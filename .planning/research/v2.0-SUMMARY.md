# Project Research Summary: v2.0 OKR Restructure & Support Tasks

**Project:** SAAP 2026 v2.0
**Domain:** OKR data model restructure in existing Next.js/Prisma/MariaDB application
**Researched:** 2026-01-27
**Confidence:** HIGH

## Executive Summary

v2.0 is a **structural data model change**, not a feature addition. The core work promotes `keyResult` from a plain string field on Initiative to a first-class `KeyResult` model with metrics (target, actual, progress, unit, weight), introduces a new `SupportTask` model with many-to-many KR linkage, and replaces the initiative-level KPI system entirely. This is a breaking change that radiates outward from the schema into 22+ source files that reference `initiative.keyResult` as a string and 8 files that consume initiative-level KPI fields. The good news: **zero new npm packages are needed** -- the existing stack (Prisma 6.19.2, xlsx 0.18.5, Recharts 3.6.0, shadcn/ui) covers every requirement.

The recommended approach is a strict **schema-first, seed-second, UI-last** build order. The entire OKR dataset will be wiped and reseeded from a new Excel file (`MotionVii_SAAP_2026_v2.xlsx`) with 4 sheets. Since this is an internal tool for 3 users, the wipe-and-reseed strategy is acceptable and greatly simplifies migration. The seed must parse 6 Key Results, 37 Initiatives (restructured columns), and 30 Support Tasks with comma-separated KR linkages including the special "All KRs" value.

The top risks are: (1) the 22-file `keyResult` string-to-FK migration that must be updated atomically to avoid build failures, (2) cascade-delete behavior during seed wipe that could destroy comments and project links, (3) MariaDB-specific Prisma drift detection loops on FK migrations, and (4) premature removal of initiative KPI fields before KR-level replacements are built. All are manageable with the Expand-and-Contract migration pattern and careful FK ordering in the seed script.

## Key Findings

### Recommended Stack

**Zero new dependencies.** Every capability needed for v2.0 is already installed. See [v2.0-STACK.md](./v2.0-STACK.md) for full details.

**Core technologies (all existing):**
- **Prisma 6.19.2:** Schema migration via `prisma migrate dev`, new KeyResult/SupportTask models, explicit join table for M:N
- **xlsx (SheetJS) 0.18.5:** Parse 4-sheet v2 Excel file in rewritten seed script (existing pattern from v1 seed)
- **Recharts 3.6.0:** Revenue target dashboard widget using BarChart with ReferenceLine (3 existing chart components prove the pattern)
- **Widget Registry (custom):** Add `revenue-target` widget following 8 existing widget registrations
- **shadcn/ui:** Potentially add `checkbox` component via CLI for SupportTask UI, but no npm install required

**What NOT to install:** exceljs, @tanstack/react-table, zod, d3/victory. All would add complexity without value for this scope.

### Expected Features

**32 table-stakes features** define v2.0. See [v2.0-FEATURES.md](./v2.0-FEATURES.md) for the full inventory with complexity ratings.

**Must have (table stakes):**
- KeyResult as first-class model with target/actual/progress/unit/metricType fields (TS-01 to TS-08)
- Initiative linked to KeyResult via FK, KPI fields removed (TS-09 to TS-12)
- SupportTask model with category, frequency, priority, owner, M:N KR linkage (TS-13 to TS-18)
- Complete seed rewrite parsing 4 Excel sheets in FK-safe order (TS-19 to TS-23)
- OKR hierarchy UI showing KR-level metrics, progress bars, status badges (TS-24 to TS-28)
- Support Tasks page with category filtering (TS-29 to TS-32)
- Revenue target dashboard widget showing RM1M goal with Events/Training split (TS-31)

**Should have (differentiators, low effort):**
- D-01: Weighted objective rollup (weight field is table-stakes, rollup calculation adds value)
- D-04: Revenue widget dual-stream breakdown (Events RM800K + Training RM200K)
- D-06: Support task workload view by owner (capacity awareness for Azlan/Khairul)
- D-08: Support task linked-KR badge display
- D-09: Initiative manual progress field (fills empty Excel "Progress" column)
- D-11: Seed validation summary report

**Defer to v2.1+:**
- Auto-derive KR status from timeline (D-02) -- needs deadline parsing
- KR check-in history (D-03) -- adds model complexity
- Support task completion tracking (D-05) -- reference list is sufficient for now

**Anti-features (deliberately excluded):**
- No complex OKR scoring (Google 0-1 scale, Say/Do ratio) -- 3-person team, simple percentage suffices
- No check-in workflows with approval -- direct edit, trust the team
- No cascading/aligned OKRs -- single team, flat structure
- No OKR cycle management -- one annual cycle (2026)
- No support task CRUD -- read-only from seed, update Excel and reseed if needed
- No real-time KR progress from CRM -- manual updates, keep it human-driven

### Architecture Approach

The architecture transforms from a flat Initiative-centric OKR display (KR as a groupable string, KPIs on initiatives) to a proper relational hierarchy (Objective enum -> KeyResult model -> Initiative FK). Data flows change fundamentally: the objectives page queries from the KeyResult side with initiative includes instead of querying initiatives and grouping by string. Revenue calculation moves from a meaningless proxy (`completedInitiatives/total * 1M`) to real KR actual values. See [v2.0-ARCHITECTURE.md](./v2.0-ARCHITECTURE.md) for full component hierarchy, query changes, and TypeScript type updates.

**Major components and their changes:**

1. **Prisma Schema** -- 2 new models (KeyResult, SupportTask), 1 join table (SupportTaskKeyResult), 2 new enums (MetricType, SupportTaskCategory), Initiative loses 7 fields and gains 2
2. **Seed Script** -- Complete rewrite to parse 4 Excel sheets. Wipe order: join table -> SupportTask -> Initiative -> KeyResult. Create order: KeyResult -> Initiative -> SupportTask -> join links
3. **Grouping Utilities** -- `initiative-group-utils.ts` rewrites from string grouping to relation-based. `initiative-kpi-utils.ts` becomes obsolete (entire file)
4. **OKR Hierarchy UI** -- KeyResultGroup displays KR model metrics directly instead of aggregating initiative KPIs. InitiativeRow simplified (no KPI bar)
5. **Revenue Widget** -- New widget querying MetricType=REVENUE KRs, replaces proxy calculation in KPI cards
6. **Support Tasks UI** -- New page/section grouped by category with KR badge links
7. **API Layer** -- New CRUD routes for `/api/key-results` and `/api/support-tasks`, updated initiative routes (remove KPI, add keyResultId/budget)

### Critical Pitfalls

Top 5 pitfalls that could derail v2.0. See [v2.0-PITFALLS.md](./v2.0-PITFALLS.md) for all 18 pitfalls with full prevention strategies and file-level impact lists.

1. **C1: 22-file keyResult string-to-FK breakage** -- Every file using `initiative.keyResult` as a string breaks simultaneously when it becomes a relation. Prevention: two-pass refactor (add FK first, keep old string temporarily; update all 22 consumers; remove old field). Full file list in Pitfalls Appendix A.

2. **C2: Seed wipe cascades delete comments and project links** -- `initiative.deleteMany()` cascade-deletes comments. Projects lose their `initiativeId` link. Prevention: use `SET FOREIGN_KEY_CHECKS = 0` during wipe, delete in strict FK reverse order, back up before running.

3. **C3: MariaDB drift detection loop on FK migrations** -- Prisma generates redundant migrations that drop/recreate FKs on every run (known issue #11242). Prevention: use `--create-only`, batch all FK changes into one migration, verify SQL before applying.

4. **C4: Dropping KPI columns before replacement is built** -- 8 files consume initiative KPI fields. Removing from schema before KR-level metrics are ready crashes the app. Prevention: Expand-and-Contract pattern -- build KR metrics first, then remove initiative KPI fields in a separate migration.

5. **H5: Running `prisma migrate dev` on production NAS** -- Wipes all production data. Prevention: separate `.env` files, only use `prisma migrate deploy` in production, backup with `mysqldump` before deployment.

## Implications for Roadmap

Based on dependency analysis across all 4 research files, the build must follow a strict linear sequence for Phases 1-3 (everything downstream depends on schema and data), with Phases 4-6 parallelizable.

### Phase 1: Schema Migration
**Rationale:** Everything depends on the new data models. Cannot test anything without the schema.
**Delivers:** KeyResult model, SupportTask model, SupportTaskKeyResult join table, MetricType/SupportTaskCategory enums, Initiative field changes (add keyResultId/budget/resources, remove keyResult string + 5 KPI fields + monthlyObjective/weeklyTasks)
**Addresses:** TS-01 to TS-12 (KeyResult model), TS-13 to TS-18 (SupportTask model)
**Avoids:** C3 (MariaDB drift) by batching all FK changes into one migration with `--create-only` review. C4 (premature KPI removal) by using Expand-and-Contract if needed.
**Estimated effort:** Medium. Single migration file, but must be reviewed carefully before applying.

### Phase 2: Seed Script Rewrite
**Rationale:** Without data, no UI work can be tested. The seed is the bridge between schema and visible functionality.
**Delivers:** Complete wipe-and-reseed from `MotionVii_SAAP_2026_v2.xlsx`. 6 KeyResults, 37 Initiatives, 30 SupportTasks, SupportTask-KR linkages, EventsToAttend.
**Addresses:** TS-19 to TS-23 (seed migration), D-11 (validation summary)
**Avoids:** C2 (cascade deletes) by using FK_CHECKS=0 and strict deletion order. H2 ("All KRs" parsing) by building KR lookup map before processing SupportTasks. M5 (delimiter inconsistency) by aggressive normalization.
**Estimated effort:** High. Most code-intensive phase -- complete rewrite of seed.ts with 4-sheet parsing.

### Phase 3: API Layer + Utilities
**Rationale:** UI components need API endpoints. Utility functions must be updated before components can consume new data shapes.
**Delivers:** CRUD endpoints for KeyResult and SupportTask. Updated Initiative endpoints (remove KPI, add keyResultId/budget). Updated dashboard stats (real revenue from KRs). New grouping utils, KR progress calculation utility.
**Addresses:** New API routes, updated dashboard stats, utility layer overhaul
**Avoids:** H3 (grouping breakage) by normalizing at the API layer -- flatten `keyResult.code` to string in API responses during transition.
**Estimated effort:** Medium. Standard CRUD following existing patterns. Utility rewrite is the most thought-intensive part.

### Phase 4: OKR Hierarchy UI (parallelizable with 5 and 6)
**Rationale:** This is the primary user-facing change. The objectives page is the most-visited OKR view.
**Delivers:** KR-level metrics display (target/actual/progress/unit), objective rollup progress, simplified initiative rows, removed KPI progress bars.
**Addresses:** TS-24 to TS-28 (OKR hierarchy UI), D-01 (weighted rollup), D-07 (KR initiative count)
**Avoids:** C1 (22-file breakage) by working through the file list systematically -- schema/API first, utilities second, pages third, components last. M2 (stale KPI aggregation) by replacing `aggregateKpiTotals()` with direct KR metric display.
**Estimated effort:** Medium-High. Touches the most files (12+ components). Most visible to users.

### Phase 5: Support Tasks UI (parallelizable with 4 and 6)
**Rationale:** Independent of OKR hierarchy changes. New additive feature with no existing code to modify.
**Delivers:** Support Tasks page grouped by category, KR badge links, category filtering, sidebar navigation entry.
**Addresses:** TS-29 to TS-32 (support tasks page), D-06 (workload by owner), D-08 (KR badges)
**Avoids:** No critical pitfalls -- this is purely additive.
**Estimated effort:** Medium. New page following existing list view patterns.

### Phase 6: Revenue Target Widget (parallelizable with 4 and 5)
**Rationale:** Independent dashboard widget. Low risk, high visibility for RM1M revenue goal tracking.
**Delivers:** Revenue target widget with Events (RM800K) + Training (RM200K) breakdown. Replaces misleading proxy revenue calculation in KPI cards.
**Addresses:** TS-31 (revenue widget), D-04 (dual-stream breakdown), D-10 (objective revenue alignment)
**Avoids:** No critical pitfalls. Follows established widget registry pattern (8 existing widgets).
**Estimated effort:** Low. One widget component + registry entry + API data source.

### Phase 7: Cleanup and Polish
**Rationale:** After all features are built, clean up dead code and verify end-to-end.
**Delivers:** Remove obsolete `initiative-kpi-utils.ts`, clean up any remaining `keyResult` string references, update export API columns, verify all 22 files from C1 are migrated, verify all 8 files from C4 are cleaned.
**Addresses:** M3 (export column layout), L1-L4 (minor frontend cleanup), D-12 (seed idempotency guard)
**Avoids:** Lingering dead code paths that could confuse future development.
**Estimated effort:** Low. Mostly deletions and verifications.

### Phase Ordering Rationale

- **Phases 1-2 are strictly sequential.** Schema must exist before seed can populate data. Seed must run before any UI can be tested. This is the critical path.
- **Phase 3 bridges data and UI.** API endpoints must exist before components can fetch data. Utility functions must be updated before components import them.
- **Phases 4-6 are parallelizable.** OKR hierarchy UI, Support Tasks UI, and Revenue Widget are independent features that only share the Phase 1-3 foundation. If working with multiple developers, assign one phase each.
- **Phase 7 is a sweep pass.** Cleaning up after the main work is done prevents leaving dead code that masks bugs.
- **The Expand-and-Contract pattern** for C4 means Initiative KPI fields can coexist with new KR metrics during Phase 4 development. Remove only after Phase 4 is complete and verified. This might mean the actual column removal happens in Phase 7.

### Research Flags

**Phases likely needing deeper research during planning:**
- **Phase 2 (Seed Script):** Excel column mappings are estimated from context, not verified from the actual file. The seed script should validate headers. Read the actual Excel file before writing column index mappings.
- **Phase 4 (OKR Hierarchy UI):** The 22-file impact list from Pitfalls Appendix A should be treated as a checklist. Each file needs individual analysis during implementation.

**Phases with standard patterns (skip research-phase):**
- **Phase 1 (Schema):** Standard Prisma migration. Models are fully designed in STACK.md and ARCHITECTURE.md.
- **Phase 3 (API):** Standard CRUD following existing route patterns.
- **Phase 5 (Support Tasks UI):** New page following existing list view patterns. No novel patterns.
- **Phase 6 (Revenue Widget):** Follows existing widget registry pattern exactly. 8 precedent widgets.

## Confidence Assessment

| Area | Confidence | Notes |
|------|------------|-------|
| Stack | HIGH | Verified all existing packages cover requirements. Zero new dependencies confirmed against package.json. |
| Features | HIGH | Features derived from concrete Excel data (6 KRs, 37 initiatives, 30 support tasks) + established OKR patterns from Quantive, Viva Goals, Profit.co. |
| Architecture | HIGH | Based on direct codebase analysis of all affected files. Component hierarchy, query changes, and type updates mapped line-by-line. |
| Pitfalls | HIGH | 18 pitfalls identified from codebase analysis + verified Prisma/MariaDB documentation. File-level impact lists (22 files for C1, 8 files for C4) verified against source. |

**Overall confidence: HIGH**

All research files are based on direct codebase analysis and official documentation, not inference or community opinion. The main uncertainty is the exact Excel column mappings (estimated, not verified from the actual file).

### Gaps to Address

1. **Excel column mapping verification:** The v2 Excel file (`MotionVii_SAAP_2026_v2.xlsx`) column positions are estimated from project context. The seed script must read and validate actual headers before parsing rows. Address during Phase 2 implementation.

2. **KR actual value update mechanism:** How will users update KR.actual after initial seed? Recommended: simple PATCH endpoint with manual entry for v2.0 MVP. Auto-computation from project revenue is a v2.1+ enhancement.

3. **Project-initiative link preservation:** Wiping initiatives during seed destroys `Project.initiativeId` links. Acceptable for current state (few/no project-initiative links in use), but should be validated. If links exist, either preserve initiative IDs or clear links explicitly.

4. **SupportTaskCategory enum values:** STACK.md uses `DESIGN_CREATIVE, BUSINESS_ADMIN, TALENTA_IDEAS, OPERATIONS`. ARCHITECTURE.md uses `ADMIN_OPS, MARKETING_COMMS, LEARNING_DEV, FINANCIAL_TRACKING`. These need reconciliation against the actual Excel categories during Phase 1 implementation.

5. **Auto-status thresholds:** The progress-to-status mapping (e.g., gap > 25% = AT_RISK) needs product validation. For v2.0 MVP, manual status is recommended. Auto-status deferred to D-02.

## Data Inventory (from Excel)

| Entity | Count | Key Facts |
|--------|-------|-----------|
| Objectives | 2 | OBJ1: Scale Events, OBJ2: Build AI Training (enum, unchanged) |
| Key Results | 6 | 2 Revenue-type (KR1.1 RM800K, KR2.2 RM200K), 4 Count-type |
| Initiatives | 37 | Distributed across 6 KRs (4-8 per KR). Departments: Biz Dev, Operations, Marketing |
| Support Tasks | 30 | 4 categories. Azlan: 14 tasks (Design). Khairul: 16 tasks (Admin/Ops). |
| Revenue Target | RM 1,000,000 | Events 80% (RM800K) + AI Training 20% (RM200K) |

## Sources

### Primary (HIGH confidence)
- Direct codebase analysis: `prisma/schema.prisma`, `prisma/seed.ts`, all 22 files in Appendix A
- [Prisma Migrate Documentation](https://www.prisma.io/docs/orm/prisma-migrate)
- [Prisma Many-to-Many Relations](https://www.prisma.io/docs/orm/prisma-schema/data-model/relations/many-to-many-relations)
- [Prisma Seeding Documentation](https://www.prisma.io/docs/orm/prisma-migrate/workflows/seeding)
- [Prisma FK Drift Issues #11242, #10900](https://github.com/prisma/prisma/issues/11242)

### Secondary (MEDIUM confidence)
- [Microsoft Viva Goals - OKR Progress](https://learn.microsoft.com/en-us/viva/goals/track-okr-progress-status)
- [IBM OKR Measurement and Scoring](https://www.ibm.com/think/insights/okr-measurement-scoring)
- [Profit.co KR Weight Rollup](https://www.profit.co/answers/okrs/how-does-the-key-result-weight-roll-up-approach-work-based-on-equally-weighted-weighted-and-kpi-based-in-profit-co/)
- [Quantive OKR Tracking Best Practices](https://quantive.com/resources/articles/okr-tracking)
- [Perdoo Objective Progress Calculation](https://support.perdoo.com/en/articles/4898961-customize-how-progress-is-calculated-for-objectives)

### Detailed Research Files
- [v2.0-STACK.md](./v2.0-STACK.md) -- Stack analysis, schema model designs, seed execution strategy
- [v2.0-FEATURES.md](./v2.0-FEATURES.md) -- 32 table-stakes, 12 differentiators, 12 anti-features, data inventory
- [v2.0-ARCHITECTURE.md](./v2.0-ARCHITECTURE.md) -- Component hierarchy, data flow, query changes, build order, TypeScript types
- [v2.0-PITFALLS.md](./v2.0-PITFALLS.md) -- 4 critical, 5 high, 5 medium, 4 low pitfalls with file-level impact lists

---
*Research completed: 2026-01-27*
*Ready for roadmap: yes*
