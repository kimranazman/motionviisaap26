# Architecture: v1.5 Initiative Intelligence & Export

**Domain:** OKR/Initiative Management with KPI Tracking, Date Intelligence, Excel Export
**Project:** SAAP 2026 v2
**Researched:** 2026-01-26
**Confidence:** HIGH (existing codebase patterns thoroughly analyzed, all architecture decisions derive from existing conventions)

---

## 1. Executive Summary

v1.5 adds five capabilities to the existing initiatives system: (1) a "By Objective" hierarchical view, (2) KPI metrics per initiative, (3) linked project inline display, (4) date intelligence with flags, and (5) Excel export. The architecture must integrate with five existing view routes (`/initiatives`, `/kanban`, `/timeline`, `/calendar`) plus an initiative detail page (`/initiatives/[id]`).

**Key architectural insight:** The existing initiative views are separate sidebar routes, NOT tabs on the same page. The Kanban board has its own internal view toggle (Board vs. By Person) using `Tabs`. The "By Objective" view will be a NEW sidebar route (`/objectives`) that becomes the default strategic view, while `initiatives/` remains the flat list. This is the cleanest integration -- no refactoring of existing routes needed, and it follows the established pattern where each view is a top-level sidebar entry.

**Schema changes are additive only** -- 6 new nullable fields on the Initiative model. No breaking changes, no migrations that affect existing data.

**Zero new dependencies.** All components built from existing shadcn/ui, date-fns, Recharts, and xlsx.

---

## 2. Schema Changes

### 2.1 New Fields on Initiative Model

Add 6 new nullable fields to support manual KPI override:

```prisma
model Initiative {
  // ... existing fields unchanged ...

  // KPI fields (v1.5)
  kpiLabel          String?  @map("kpi_label") @db.VarChar(100)    // e.g., "Revenue Generated", "Events Delivered"
  kpiTarget         Decimal? @map("kpi_target") @db.Decimal(12, 2) // Target value
  kpiActual         Decimal? @map("kpi_actual") @db.Decimal(12, 2) // Actual value (manual override)
  kpiUnit           String?  @map("kpi_unit") @db.VarChar(20)      // e.g., "RM", "count", "%"
  kpiManualOverride Boolean  @default(false) @map("kpi_manual_override") // True = use kpiActual, False = auto-calculate

  // ... rest unchanged ...
}
```

### 2.2 Rationale for Each Field

| Field | Type | Why |
|-------|------|-----|
| `kpiLabel` | VarChar(100), nullable | Each initiative can have a different KPI name. "Revenue" for one, "Events Completed" for another. Nullable because not all initiatives need KPIs immediately. |
| `kpiTarget` | Decimal(12,2), nullable | Numeric target. Uses Decimal for currency consistency with existing `revenue`, `resourcesFinancial` fields. |
| `kpiActual` | Decimal(12,2), nullable | Manual override value. When `kpiManualOverride` is true, this takes precedence over auto-calculated values. |
| `kpiUnit` | VarChar(20), nullable | Display unit. Short string like "RM", "count", "%", "projects". Kept as free-text rather than enum for flexibility. |
| `kpiManualOverride` | Boolean, default false | Toggle between auto-calculated (from linked projects) and manually entered values. Defaults to auto-calculation. |

### 2.3 What We Do NOT Add

- **No new tables.** KPI data lives on Initiative directly. No separate KPI model, no metrics table. With ~28 initiatives and simple target/actual pairs, a separate table is over-engineering.
- **No KeyResult model.** Key Results remain the `keyResult` VarChar(20) field. With only ~6-8 KRs across 2 objectives, a separate model adds complexity without value. Grouping is done client-side via `groupBy`.
- **No schema changes to Project.** Linked project data is read via existing `Initiative.projects[]` relation using `initiativeId` FK on Project (already indexed).

### 2.4 Migration Strategy

```bash
# Single additive migration, no data loss risk
npx prisma db push
# OR for production:
npx prisma migrate dev --name add_initiative_kpi_fields
```

All new fields are nullable (except `kpiManualOverride` which has a default). Existing rows are unaffected.

---

## 3. Component Architecture

### 3.1 High-Level Component Map

```
src/
  app/(dashboard)/
    objectives/                    # NEW route: By Objective view
      page.tsx                     # Server Component (data fetch + serialize)
    initiatives/
      page.tsx                     # EXISTING (unchanged) - flat list
      [id]/page.tsx                # EXISTING (enhanced) - detail page
    kanban/page.tsx                # EXISTING (unchanged)
    timeline/page.tsx              # EXISTING (unchanged)
    calendar/page.tsx              # EXISTING (unchanged)

  app/api/
    initiatives/
      route.ts                    # EXISTING (enhanced) - add projects include
      [id]/route.ts               # EXISTING (enhanced) - add KPI fields to PATCH/PUT
      export/
        route.ts                  # NEW - Excel export endpoint

  components/
    objectives/                    # NEW feature directory
      objective-hierarchy.tsx      # Main client component (expand/collapse + view)
      objective-group.tsx          # Objective-level collapsible section
      key-result-group.tsx         # KR-level collapsible section
      initiative-row.tsx           # Initiative row within hierarchy
      kpi-inline.tsx               # Inline KPI progress display
      linked-projects-inline.tsx   # Inline project summary chips
      date-intelligence-badge.tsx  # Date flag badges (overdue, ending soon, etc.)
      hierarchy-summary-bar.tsx    # Top-level summary stats bar
      export-button.tsx            # Excel export trigger button

    initiatives/
      initiatives-list.tsx         # EXISTING (unchanged)
      initiative-form.tsx          # EXISTING (enhanced) - add KPI fields
      initiative-detail.tsx        # EXISTING (enhanced) - add KPI section + linked projects

  lib/
    initiative-date-utils.ts       # NEW - Date intelligence pure functions
    initiative-kpi-utils.ts        # NEW - KPI calculation pure functions
    initiative-group-utils.ts      # NEW - Grouping/hierarchy pure functions
```

### 3.2 Component Boundaries and Responsibilities

#### Server Components (Data Fetching)

| Component | Location | Responsibility |
|-----------|----------|----------------|
| `objectives/page.tsx` | Route | Fetch all initiatives with projects, serialize Decimals/Dates, pass to client |

**Data fetch pattern** (follows existing conventions in `kanban/page.tsx`, `timeline/page.tsx`):

```typescript
// src/app/(dashboard)/objectives/page.tsx
export const dynamic = 'force-dynamic'

async function getInitiativesWithProjects() {
  const initiatives = await prisma.initiative.findMany({
    orderBy: [{ objective: 'asc' }, { keyResult: 'asc' }, { sequenceNumber: 'asc' }],
    include: {
      projects: {
        select: {
          id: true,
          title: true,
          status: true,
          revenue: true,
          potentialRevenue: true,
          costs: {
            select: { amount: true },
          },
        },
        where: { isArchived: false },
      },
    },
  })

  // Serialize Decimals + Dates (established codebase pattern)
  return initiatives.map(i => ({
    ...i,
    startDate: i.startDate.toISOString(),
    endDate: i.endDate.toISOString(),
    createdAt: i.createdAt.toISOString(),
    updatedAt: i.updatedAt.toISOString(),
    resourcesFinancial: i.resourcesFinancial ? Number(i.resourcesFinancial) : null,
    kpiTarget: i.kpiTarget ? Number(i.kpiTarget) : null,
    kpiActual: i.kpiActual ? Number(i.kpiActual) : null,
    projects: i.projects.map(p => ({
      ...p,
      revenue: p.revenue ? Number(p.revenue) : null,
      potentialRevenue: p.potentialRevenue ? Number(p.potentialRevenue) : null,
      totalCost: p.costs.reduce((sum, c) => sum + Number(c.amount), 0),
    })),
  }))
}
```

#### Client Components (Interactive UI)

| Component | Props | State | Responsibility |
|-----------|-------|-------|----------------|
| `ObjectiveHierarchy` | `initiatives[]` | `expandedObjectives: Set<string>`, `expandedKRs: Set<string>`, `search`, `filters` | Top-level orchestrator. Groups data, manages expand state, renders hierarchy. |
| `ObjectiveGroup` | `objective`, `keyResults`, `metrics`, `isExpanded` | none (controlled) | Renders Objective header row with summary stats, Collapsible wrapper. |
| `KeyResultGroup` | `keyResult`, `initiatives[]`, `metrics`, `isExpanded` | none (controlled) | Renders KR header row with summary stats, Collapsible wrapper. |
| `InitiativeRow` | `initiative` (with projects, KPI data) | none | Renders single initiative row with inline KPI, projects, date badges. |
| `KpiInline` | `initiative` | none | Computes and renders KPI progress bar inline. |
| `LinkedProjectsInline` | `projects[]` | none | Renders project chips with status dots. |
| `DateIntelligenceBadge` | `startDate`, `endDate`, `status` | none | Renders date warning badges (overdue, ending soon, long duration). |
| `HierarchySummaryBar` | `initiatives[]` | none | Top bar with overall stats: total, by status, by objective. |
| `ExportButton` | none | `isExporting` | Triggers download from API route. |

### 3.3 Expand/Collapse State Pattern

**Follow the TaskTree pattern** from `src/components/projects/task-tree.tsx`:

```typescript
// In ObjectiveHierarchy (parent component)
const [expandedObjectives, setExpandedObjectives] = useState<Set<string>>(
  // Default: all expanded (matches TaskTree behavior of initializing with all IDs)
  new Set(OBJECTIVE_OPTIONS.map(o => o.value))
)
const [expandedKRs, setExpandedKRs] = useState<Set<string>>(
  new Set(uniqueKeyResults)
)

const toggleObjective = (obj: string) => {
  setExpandedObjectives(prev => {
    const next = new Set(prev)
    if (next.has(obj)) next.delete(obj)
    else next.add(obj)
    return next
  })
}

const toggleKR = (kr: string) => {
  setExpandedKRs(prev => {
    const next = new Set(prev)
    if (next.has(kr)) next.delete(kr)
    else next.add(kr)
    return next
  })
}
```

This pattern is directly lifted from the existing `task-tree.tsx` (lines 26-49) and provides consistent UX across the app.

### 3.4 Component Communication Diagram

```
objectives/page.tsx (Server)
  |
  | fetches + serializes data
  v
ObjectiveHierarchy (Client) ---------> ExportButton
  |                                        |
  | groups data, manages expand state      | onClick: window.open('/api/initiatives/export')
  |                                        v
  |---> HierarchySummaryBar          /api/initiatives/export (Server)
  |                                   |
  |---> ObjectiveGroup (per objective) | queries DB, generates XLSX
  |      |                             | returns binary Response
  |      |---> KeyResultGroup (per KR)
  |             |
  |             |---> InitiativeRow (per initiative)
  |                    |
  |                    |---> KpiInline
  |                    |---> LinkedProjectsInline
  |                    |---> DateIntelligenceBadge
  |
  |---> InitiativeDetailSheet (reuse from kanban/)
         |
         | opened on initiative click
         | fetches full detail via /api/initiatives/[id]
```

---

## 4. Data Flow

### 4.1 By Objective View Data Flow

```
1. User navigates to /objectives
2. Server Component fetches initiatives + projects from DB
3. Decimal/Date fields serialized to Number/String
4. Serialized array passed to ObjectiveHierarchy as prop
5. ObjectiveHierarchy groups data client-side:
   - useMemo: Group by objective -> Group by keyResult
   - useMemo: Calculate aggregate metrics per group
6. Renders hierarchy with collapsible sections
7. User clicks initiative row -> Opens InitiativeDetailSheet
8. Detail sheet fetches full initiative data via API
```

### 4.2 KPI Data Flow

```
Auto-calculated mode (kpiManualOverride = false):
1. Initiative has linked projects via projects[] relation
2. Server Component includes projects in fetch
3. Client-side KPI util calculates:
   - projectCount, completedCount from projects array
   - totalRevenue = sum(project.revenue)
   - totalCost = sum(project.costs.amount)
4. KpiInline renders Progress bar with calculated values

Manual override mode (kpiManualOverride = true):
1. Initiative has kpiTarget, kpiActual, kpiUnit set
2. KpiInline reads these directly (no project aggregation)
3. Renders Progress bar with manual values

KPI editing:
1. User opens initiative form (enhanced with KPI fields)
2. Toggle switch: "Manual KPI" enables/disables override
3. PATCH /api/initiatives/[id] saves KPI fields
4. On save, parent refreshes data
```

### 4.3 Excel Export Data Flow

```
1. User clicks ExportButton in hierarchy view
2. Button triggers: window.open('/api/initiatives/export')
   (OR: fetch() + blob download for better UX)
3. API route queries DB:
   - All initiatives with projects
   - Ordered by objective -> keyResult -> sequenceNumber
4. Builds row objects with formatted values:
   - Uses formatObjective(), formatDepartment(), etc. from lib/utils
   - Computes duration via differenceInDays from date-fns
   - Includes linked project count
5. xlsx.utils.json_to_sheet(rows) -> workbook -> buffer
6. Returns Response with Content-Disposition header
7. Browser auto-downloads .xlsx file
```

### 4.4 Date Intelligence Data Flow

```
1. Initiative dates (startDate, endDate) arrive as ISO strings
2. DateIntelligenceBadge parses dates:
   - isPast(endDate) && status !== COMPLETED -> "OVERDUE" badge
   - differenceInDays(endDate, today) <= 7 -> "ENDING SOON" badge
   - differenceInDays(endDate, startDate) > 180 -> "LONG DURATION" badge
   - endDate < startDate -> "INVALID DATES" badge
3. Overlap detection (at group level):
   - Within a KR group, check all initiative pairs
   - areIntervalsOverlapping(init1, init2) -> flag on both
   - Rendered as warning icon in InitiativeRow
4. All date logic is pure functions in lib/initiative-date-utils.ts
   (no side effects, easy to test)
```

---

## 5. API Design

### 5.1 New API Endpoint: Excel Export

```
GET /api/initiatives/export
```

**Location:** `src/app/api/initiatives/export/route.ts`

**Query parameters:**
| Param | Type | Default | Purpose |
|-------|------|---------|---------|
| `objective` | string | (all) | Filter by objective enum |
| `format` | `xlsx` or `csv` | `xlsx` | Output format |

**Response:**
- `200`: Binary file with `Content-Disposition: attachment; filename="..."` and appropriate MIME type
- `401`: Unauthorized (uses `requireAuth()` pattern)
- `500`: Server error

**Implementation pattern** (follows existing API conventions):

```typescript
// src/app/api/initiatives/export/route.ts
import { NextRequest } from 'next/server'
import prisma from '@/lib/prisma'
import { requireAuth } from '@/lib/auth-utils'
import * as XLSX from 'xlsx'
import { format } from 'date-fns'
import { formatObjective, formatDepartment, formatStatus, formatTeamMember } from '@/lib/utils'
import { differenceInDays } from 'date-fns'

export async function GET(request: NextRequest) {
  const { error } = await requireAuth()
  if (error) return error

  const searchParams = request.nextUrl.searchParams
  const objectiveFilter = searchParams.get('objective')
  const exportFormat = searchParams.get('format') || 'xlsx'

  const where = objectiveFilter ? { objective: objectiveFilter as any } : {}

  const initiatives = await prisma.initiative.findMany({
    where,
    include: {
      projects: {
        select: { id: true, status: true, revenue: true },
        where: { isArchived: false },
      },
    },
    orderBy: [
      { objective: 'asc' },
      { keyResult: 'asc' },
      { sequenceNumber: 'asc' },
    ],
  })

  const rows = initiatives.map(i => ({
    '#': i.sequenceNumber,
    'Objective': formatObjective(i.objective),
    'Key Result': i.keyResult,
    'Initiative': i.title,
    'Department': formatDepartment(i.department),
    'Status': formatStatus(i.status),
    'Owner': formatTeamMember(i.personInCharge),
    'Start Date': format(i.startDate, 'yyyy-MM-dd'),
    'End Date': format(i.endDate, 'yyyy-MM-dd'),
    'Duration (Days)': differenceInDays(i.endDate, i.startDate),
    'Linked Projects': i.projects.length,
    'Total Revenue': i.projects.reduce((sum, p) => sum + Number(p.revenue || 0), 0),
    'KPI Label': i.kpiLabel || '',
    'KPI Target': i.kpiTarget ? Number(i.kpiTarget) : '',
    'KPI Actual': i.kpiActual ? Number(i.kpiActual) : '',
    'KPI Unit': i.kpiUnit || '',
  }))

  const ws = XLSX.utils.json_to_sheet(rows)

  // Set column widths for readability
  ws['!cols'] = [
    { wch: 4 },   // #
    { wch: 25 },  // Objective
    { wch: 10 },  // Key Result
    { wch: 60 },  // Initiative
    { wch: 14 },  // Department
    { wch: 14 },  // Status
    { wch: 12 },  // Owner
    { wch: 12 },  // Start Date
    { wch: 12 },  // End Date
    { wch: 14 },  // Duration
    { wch: 14 },  // Linked Projects
    { wch: 14 },  // Total Revenue
    { wch: 20 },  // KPI Label
    { wch: 12 },  // KPI Target
    { wch: 12 },  // KPI Actual
    { wch: 8 },   // KPI Unit
  ]

  const wb = XLSX.utils.book_new()
  XLSX.utils.book_append_sheet(wb, ws, 'Initiatives')

  if (exportFormat === 'csv') {
    const csv = XLSX.utils.sheet_to_csv(ws)
    return new Response(csv, {
      headers: {
        'Content-Type': 'text/csv',
        'Content-Disposition': `attachment; filename="initiatives-${format(new Date(), 'yyyy-MM-dd')}.csv"`,
      },
    })
  }

  const buf = XLSX.write(wb, { type: 'buffer', bookType: 'xlsx' })
  return new Response(buf, {
    headers: {
      'Content-Type': 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
      'Content-Disposition': `attachment; filename="initiatives-${format(new Date(), 'yyyy-MM-dd')}.xlsx"`,
    },
  })
}
```

### 5.2 Enhanced Existing Endpoints

#### GET /api/initiatives (Enhanced)

Add optional `include=projects` query parameter to include linked projects:

```typescript
// When called from objectives page, include project summaries
const includeProjects = searchParams.get('include') === 'projects'

const initiatives = await prisma.initiative.findMany({
  where,
  orderBy: [{ sequenceNumber: 'asc' }],
  include: includeProjects ? {
    projects: {
      select: {
        id: true,
        title: true,
        status: true,
        revenue: true,
        costs: { select: { amount: true } },
      },
      where: { isArchived: false },
    },
  } : undefined,
})
```

**Note:** The server component for `/objectives` page should fetch directly via Prisma (not via API), following the established pattern in existing pages. The API enhancement is for potential client-side refetch scenarios.

#### PATCH /api/initiatives/[id] (Enhanced)

Add KPI fields to the allowed PATCH fields:

```typescript
// Add to existing PATCH handler body processing:
if (body.kpiLabel !== undefined) {
  updateData.kpiLabel = body.kpiLabel
}
if (body.kpiTarget !== undefined) {
  updateData.kpiTarget = body.kpiTarget
}
if (body.kpiActual !== undefined) {
  updateData.kpiActual = body.kpiActual
}
if (body.kpiUnit !== undefined) {
  updateData.kpiUnit = body.kpiUnit
}
if (body.kpiManualOverride !== undefined) {
  updateData.kpiManualOverride = body.kpiManualOverride
}
```

This follows the exact pattern already used for `status`, `position`, `remarks`, `personInCharge` (lines 108-121 of the existing handler).

#### PUT /api/initiatives/[id] (Enhanced)

Add KPI fields to the full update body:

```typescript
// Add to existing PUT handler data object:
kpiLabel: body.kpiLabel || null,
kpiTarget: body.kpiTarget || null,
kpiActual: body.kpiActual || null,
kpiUnit: body.kpiUnit || null,
kpiManualOverride: body.kpiManualOverride || false,
```

---

## 6. Build Order

### Phase Dependencies

```
                    Schema Migration
                         |
                         v
        +----------------+----------------+
        |                |                |
        v                v                v
   Utility Libs    API Enhancements   Sidebar Nav
   (date, kpi,     (PATCH KPI,        (add /objectives
    grouping)       export route)       link)
        |                |                |
        +--------+-------+               |
                 |                        |
                 v                        |
           ObjectiveHierarchy  <----------+
           (main view component)
                 |
        +--------+--------+--------+
        |        |        |        |
        v        v        v        v
   ObjectiveGroup  KpiInline  DateBadge  ExportButton
        |
        v
   KeyResultGroup
        |
        v
   InitiativeRow
        |
        v
   LinkedProjectsInline
```

### Recommended Build Sequence

**Step 1: Schema + Utilities (Foundation)**
- Add KPI fields to Prisma schema
- Run `prisma db push`
- Create `lib/initiative-date-utils.ts`
- Create `lib/initiative-kpi-utils.ts`
- Create `lib/initiative-group-utils.ts`

**Step 2: API Layer**
- Enhance PATCH/PUT with KPI fields
- Create `/api/initiatives/export/route.ts`

**Step 3: Leaf Components (No Dependencies)**
- `KpiInline` - renders progress bar from KPI data
- `DateIntelligenceBadge` - renders date warning badges
- `LinkedProjectsInline` - renders project chips
- `ExportButton` - triggers download

**Step 4: Hierarchy Components (Compose Leaf Components)**
- `InitiativeRow` - uses KpiInline, LinkedProjectsInline, DateIntelligenceBadge
- `KeyResultGroup` - collapsible section containing InitiativeRow items
- `ObjectiveGroup` - collapsible section containing KeyResultGroup items
- `HierarchySummaryBar` - top stats bar

**Step 5: Page Assembly**
- `ObjectiveHierarchy` - main orchestrator component
- `objectives/page.tsx` - server component with data fetch
- Add `/objectives` to sidebar navigation
- Add ExportButton to the page

**Step 6: Enhancement of Existing Components**
- Add KPI section to `initiative-form.tsx`
- Add KPI + linked projects display to `initiative-detail.tsx`
- Add KPI section to `initiative-detail-sheet.tsx` (kanban detail dialog)

---

## 7. Integration Points

### 7.1 Sidebar Navigation

Add `/objectives` as a new top-level nav item. Position it FIRST in the initiatives section since it is the primary strategic view.

```typescript
// src/components/layout/sidebar.tsx
const navigation = [
  { name: 'Dashboard', href: '/', icon: LayoutDashboard },
  { name: 'By Objective', href: '/objectives', icon: Target },  // NEW - primary strategic view
  { name: 'Timeline', href: '/timeline', icon: GanttChart },
  { name: 'Kanban', href: '/kanban', icon: KanbanSquare },
  { name: 'Calendar', href: '/calendar', icon: Calendar },
  { name: 'Initiatives', href: '/initiatives', icon: ListTodo },
  { name: 'Events to Attend', href: '/events', icon: Ticket },
]
```

**Rationale for new route vs. tabs-on-same-page:**
- Each existing view (List, Kanban, Timeline, Calendar) is a separate sidebar route with its own Server Component
- This is the established pattern -- Kanban fetches with `position` ordering, Timeline with `department` ordering, Calendar needs events too
- The Objectives view needs to fetch `projects` relation (not needed by other views), making it a distinct data requirement
- Adding it as a tab on `/initiatives` would require loading project data even when not needed, or a client-side fetch waterfall
- A separate route is cleaner, faster, and consistent

### 7.2 Initiative Detail Sheet Reuse

The `InitiativeDetailSheet` (from `src/components/kanban/initiative-detail-sheet.tsx`) is already a standalone Dialog component that fetches its own data when opened. It can be reused directly in the Objectives view:

```typescript
// In ObjectiveHierarchy
import { InitiativeDetailSheet } from '@/components/kanban/initiative-detail-sheet'

// State
const [selectedInitiative, setSelectedInitiative] = useState<Initiative | null>(null)
const [isSheetOpen, setIsSheetOpen] = useState(false)

// On row click
const handleInitiativeClick = (initiative: Initiative) => {
  setSelectedInitiative(initiative)
  setIsSheetOpen(true)
}
```

**Enhancement needed:** The existing `InitiativeDetailSheet` should be moved from `components/kanban/` to `components/shared/` or `components/initiatives/` since it is now used by multiple views. This is a file move + import update, no logic changes.

### 7.3 KPI Section in Existing Forms

The `InitiativeForm` component (used for create/edit in the flat list view) needs a new KPI section. This is an additive change -- add fields after the existing "Resources" row:

```typescript
// After Row 8 (Resources) in initiative-form.tsx
{/* Row 9: KPI Configuration (v1.5) */}
<div className="space-y-4">
  <div className="flex items-center gap-2">
    <label className="text-sm font-medium text-gray-700">KPI Tracking</label>
    <Switch
      checked={formData.kpiManualOverride}
      onCheckedChange={(checked) =>
        setFormData({ ...formData, kpiManualOverride: checked })
      }
    />
    <span className="text-xs text-gray-500">
      {formData.kpiManualOverride ? 'Manual' : 'Auto (from projects)'}
    </span>
  </div>

  {formData.kpiManualOverride && (
    <div className="grid grid-cols-1 gap-4 md:grid-cols-2">
      <Input label="KPI Label" value={formData.kpiLabel} ... />
      <Input label="KPI Unit" value={formData.kpiUnit} ... />
      <Input label="Target" type="number" value={formData.kpiTarget} ... />
      <Input label="Actual" type="number" value={formData.kpiActual} ... />
    </div>
  )}
</div>
```

### 7.4 Export Button Placement

The ExportButton should be in the page header area of the Objectives view (and optionally in the flat list view). It is a simple download trigger:

```typescript
// ExportButton component
export function ExportButton() {
  const [isExporting, setIsExporting] = useState(false)

  const handleExport = async () => {
    setIsExporting(true)
    try {
      const response = await fetch('/api/initiatives/export')
      const blob = await response.blob()
      const url = window.URL.createObjectURL(blob)
      const a = document.createElement('a')
      a.href = url
      a.download = `initiatives-${new Date().toISOString().slice(0, 10)}.xlsx`
      a.click()
      window.URL.revokeObjectURL(url)
    } finally {
      setIsExporting(false)
    }
  }

  return (
    <Button variant="outline" onClick={handleExport} disabled={isExporting}>
      {isExporting ? <Loader2 className="h-4 w-4 mr-2 animate-spin" /> : <Download className="h-4 w-4 mr-2" />}
      Export
    </Button>
  )
}
```

**Why fetch+blob instead of window.open:**
- Shows loading state on the button
- Handles errors gracefully (window.open would show error in new tab)
- Can show toast notification on success/failure
- Follows the pattern used elsewhere in the app for file operations

---

## 8. Utility Module Design

### 8.1 initiative-group-utils.ts

Pure functions for data grouping. No side effects, easily testable.

```typescript
// src/lib/initiative-group-utils.ts

export interface GroupedObjective {
  objective: string
  label: string
  keyResults: GroupedKeyResult[]
  totalInitiatives: number
  completedCount: number
  inProgressCount: number
  atRiskCount: number
}

export interface GroupedKeyResult {
  keyResult: string
  initiatives: Initiative[]
  totalInitiatives: number
  completedCount: number
}

export function groupInitiativesByObjective(initiatives: Initiative[]): GroupedObjective[] {
  // Group by objective enum -> then by keyResult string
  // Sort KRs naturally: "KR1.1" < "KR1.2" < "KR2.1"
}

export function getObjectiveSummary(initiatives: Initiative[]): {
  total: number
  completed: number
  inProgress: number
  atRisk: number
  overdue: number
} {
  // Aggregate counts across all initiatives
}
```

### 8.2 initiative-kpi-utils.ts

```typescript
// src/lib/initiative-kpi-utils.ts

export interface KpiData {
  label: string
  target: number | null
  actual: number
  unit: string
  percentage: number | null  // actual/target * 100
  source: 'auto' | 'manual'
}

export function calculateKpi(initiative: InitiativeWithProjects): KpiData {
  if (initiative.kpiManualOverride && initiative.kpiLabel) {
    return {
      label: initiative.kpiLabel,
      target: initiative.kpiTarget ? Number(initiative.kpiTarget) : null,
      actual: initiative.kpiActual ? Number(initiative.kpiActual) : 0,
      unit: initiative.kpiUnit || '',
      percentage: initiative.kpiTarget
        ? (Number(initiative.kpiActual || 0) / Number(initiative.kpiTarget)) * 100
        : null,
      source: 'manual',
    }
  }

  // Auto-calculate from linked projects
  const projects = initiative.projects || []
  const totalRevenue = projects.reduce((sum, p) => sum + (p.revenue || 0), 0)
  const completedProjects = projects.filter(p => p.status === 'COMPLETED').length

  return {
    label: projects.length > 0 ? 'Projects' : 'No KPI',
    target: projects.length || null,
    actual: completedProjects,
    unit: 'completed',
    percentage: projects.length > 0 ? (completedProjects / projects.length) * 100 : null,
    source: 'auto',
  }
}
```

### 8.3 initiative-date-utils.ts

```typescript
// src/lib/initiative-date-utils.ts
import {
  differenceInDays,
  areIntervalsOverlapping,
  isPast,
  isFuture,
  intervalToDuration,
  formatDuration,
} from 'date-fns'

export type DateFlag = 'overdue' | 'ending-soon' | 'long-duration' | 'invalid-dates' | 'not-started-yet'

export interface DateIntelligence {
  durationDays: number
  durationLabel: string       // "3 months, 15 days"
  flags: DateFlag[]
  isOverdue: boolean
  daysUntilEnd: number | null // null if already past
}

export function analyzeDates(
  startDate: string,
  endDate: string,
  status: string
): DateIntelligence { ... }

export interface OverlapResult {
  initiative1Id: string
  initiative2Id: string
  overlapDays: number
}

export function detectOverlaps(
  initiatives: { id: string; startDate: string; endDate: string }[]
): OverlapResult[] { ... }

export function getDateValidationErrors(
  startDate: string,
  endDate: string
): string[] { ... }
```

---

## 9. Anti-Patterns to Avoid

### 9.1 Do NOT Refactor Existing Views Into Tabs

**Anti-pattern:** Merging all 5 views (List, Kanban, Timeline, Calendar, Objectives) into tabs on a single page.

**Why bad:**
- Each view has different data requirements (Kanban needs `position`, Timeline needs `department` ordering, Objectives need `projects`)
- A single page would need to fetch ALL data (projects, positions, department ordering) even if only one view is shown
- The Kanban board uses DnD-kit with complex sensor setup that should not be loaded for other views
- Breaks the existing sidebar navigation pattern that users are accustomed to
- Would require massive refactoring of all existing view components

**Instead:** Keep each view as a separate route. Add `/objectives` as a new route.

### 9.2 Do NOT Create a KeyResult Model

**Anti-pattern:** Normalizing the `keyResult` VarChar field into a separate `KeyResult` model with its own ID, description, target, etc.

**Why bad:**
- With only ~6-8 KRs, a separate table adds join complexity for zero practical benefit
- The `keyResult` field is already effectively a grouping key (e.g., "KR1.1", "KR1.2")
- A new model would require migration of existing data, new CRUD UI, new API endpoints
- KR-level metrics can be computed by aggregating initiatives in the same group

**Instead:** Group by the existing `keyResult` string field client-side. Use natural string sorting ("KR1.1" < "KR1.2").

### 9.3 Do NOT Use Client-Side Data Fetching for Initial Load

**Anti-pattern:** Having the Objectives page render empty, then fetch data via `useEffect` + `fetch('/api/initiatives')`.

**Why bad:**
- Causes visible loading spinner on every page navigation
- Doubles the request (Server Component could have fetched directly)
- Loses the benefit of Server Component data fetching (no client bundle for fetch logic)
- Inconsistent with every other page in the app (all use Server Component fetch)

**Instead:** Follow the established pattern: Server Component fetches, serializes, passes as prop to client component.

### 9.4 Do NOT Put Date Logic in Components

**Anti-pattern:** Calculating durations, detecting overlaps, and determining flags directly inside React components.

**Why bad:**
- Not testable without rendering components
- Duplicated logic if the same flags are needed in different views
- Mixes presentation logic with business logic

**Instead:** All date intelligence lives in `lib/initiative-date-utils.ts` as pure functions. Components call these functions with data and render the results.

### 9.5 Do NOT Build Client-Side Export

**Anti-pattern:** Importing xlsx in the client bundle and generating the spreadsheet in the browser.

**Why bad:**
- xlsx adds ~200KB to the client JavaScript bundle
- Client has serialized data (Strings, Numbers) while server has raw Prisma types with proper formatting
- Error handling is harder in the browser (if generation fails, user sees nothing)
- Cannot leverage server-side caching or streaming

**Instead:** Server-side API route (`/api/initiatives/export`) generates the file. Client fetches and triggers download.

### 9.6 Do NOT Store Computed KPI Values in Database

**Anti-pattern:** Running a cron job or trigger to calculate KPI values from projects and store them on the Initiative row.

**Why bad:**
- Creates stale data problem (computed values lag behind source data)
- Requires sync mechanism (when a project revenue changes, which initiatives need recalculation?)
- With ~28 initiatives and ~50 projects, computing on-the-fly is instant
- The `kpiActual` field is ONLY for manual override, not cached computation

**Instead:** Auto-calculated KPIs are always computed at query time from the `projects` relation. Only manual overrides are stored in `kpiActual`.

---

## 10. File Inventory

### New Files to Create

| File | Type | Purpose |
|------|------|---------|
| `src/app/(dashboard)/objectives/page.tsx` | Server Component | Objectives page route |
| `src/app/api/initiatives/export/route.ts` | API Route | Excel/CSV export |
| `src/components/objectives/objective-hierarchy.tsx` | Client Component | Main hierarchy orchestrator |
| `src/components/objectives/objective-group.tsx` | Client Component | Objective-level collapsible |
| `src/components/objectives/key-result-group.tsx` | Client Component | KR-level collapsible |
| `src/components/objectives/initiative-row.tsx` | Client Component | Initiative row with inline data |
| `src/components/objectives/kpi-inline.tsx` | Client Component | Inline KPI progress |
| `src/components/objectives/linked-projects-inline.tsx` | Client Component | Inline project chips |
| `src/components/objectives/date-intelligence-badge.tsx` | Client Component | Date warning badges |
| `src/components/objectives/hierarchy-summary-bar.tsx` | Client Component | Top summary stats |
| `src/components/objectives/export-button.tsx` | Client Component | Export download trigger |
| `src/lib/initiative-date-utils.ts` | Utility | Date intelligence functions |
| `src/lib/initiative-kpi-utils.ts` | Utility | KPI calculation functions |
| `src/lib/initiative-group-utils.ts` | Utility | Grouping/hierarchy functions |

### Existing Files to Modify

| File | Change | Scope |
|------|--------|-------|
| `prisma/schema.prisma` | Add 5 KPI fields to Initiative | Small (5 lines) |
| `src/app/api/initiatives/[id]/route.ts` | Add KPI fields to PATCH and PUT handlers | Small (15 lines) |
| `src/components/layout/sidebar.tsx` | Add `/objectives` nav item | 1 line |
| `src/components/layout/mobile-sidebar.tsx` | Add `/objectives` nav item | 1 line |
| `src/components/initiatives/initiative-form.tsx` | Add KPI section | Medium (30 lines) |
| `src/components/initiatives/initiative-detail.tsx` | Add KPI display + linked projects | Medium (40 lines) |
| `src/components/kanban/initiative-detail-sheet.tsx` | Add KPI display (or move to shared/) | Small (20 lines) |

---

## 11. TypeScript Interface Design

### Shared Initiative Type (Enhanced)

```typescript
// Can be placed in a shared types file or co-located with components

interface InitiativeBase {
  id: string
  sequenceNumber: number
  title: string
  objective: string
  keyResult: string
  department: string
  status: string
  personInCharge: string | null
  startDate: string
  endDate: string
}

// For objectives view (includes projects + KPI)
interface InitiativeWithProjects extends InitiativeBase {
  kpiLabel: string | null
  kpiTarget: number | null
  kpiActual: number | null
  kpiUnit: string | null
  kpiManualOverride: boolean
  projects: LinkedProject[]
}

interface LinkedProject {
  id: string
  title: string
  status: string
  revenue: number | null
  potentialRevenue: number | null
  totalCost: number
}

// For kanban (existing, unchanged)
interface InitiativeKanban extends InitiativeBase {
  position: number
}
```

This typed approach ensures each view only receives the data it needs, keeping props lean and preventing accidental coupling.

---

## 12. Performance Considerations

### Data Volume Reality Check

| Entity | Count | Impact |
|--------|-------|--------|
| Objectives | 2 | Trivial |
| Key Results | ~6-8 | Trivial |
| Initiatives | ~28 | Trivial |
| Projects per Initiative | ~0-5 | ~50 total projects |
| Costs per Project | ~5-20 | ~500 total (only aggregated) |

**Verdict:** No performance optimization needed. All grouping, KPI calculation, date analysis, and overlap detection can happen synchronously in a single render cycle. Memoization via `useMemo` is sufficient.

### Query Optimization

The server component query includes projects with their costs:

```prisma
initiative.findMany({
  include: {
    projects: {
      select: { id, title, status, revenue, costs: { select: { amount } } }
    }
  }
})
```

This generates 1 query for initiatives + N+1 for projects and costs. With ~28 initiatives and ~50 projects, this completes in <100ms. If performance becomes an issue later (unlikely), a raw SQL aggregation query could replace it. But premature optimization is not warranted at this scale.

---

*Architecture research for: v1.5 Initiative Intelligence & Export*
*Researched: 2026-01-26*
*Verdict: Additive architecture -- new route, new components, schema additions. Zero breaking changes to existing system.*
