# Stack Research: v1.5 OKR/Initiative Management with KPI Tracking & Export

**Domain:** OKR/Initiative Management with KPI Tracking, Date Intelligence, Excel Export
**Researched:** 2026-01-26
**Confidence:** HIGH

## Executive Summary

The existing SAAP stack already contains most of what v1.5 needs. The project has `date-fns` v4, `recharts` v3, `xlsx` (SheetJS) v0.18.5, shadcn/ui `Table`, `Collapsible`, and `Progress` components. The key decision is whether to add `@tanstack/react-table` for hierarchical grouped views or build a custom solution with existing shadcn/ui components. Given the specific 3-level hierarchy (Objective > KR > Initiative) with a small dataset (~30-50 initiatives), TanStack Table is overkill. A custom collapsible table using existing shadcn/ui components is the right choice.

**Bottom line: Zero new npm dependencies required.** Everything needed is already installed.

---

## Current Stack Inventory (Already Installed)

| Technology | Version | Purpose in v1.5 |
|------------|---------|-----------------|
| Next.js | ^14.2.28 | App framework, API routes for export |
| Prisma | ^6.19.2 | DB queries for hierarchy, KPI aggregation |
| MariaDB (mysql) | - | Data storage |
| Tailwind CSS | ^3.4.1 | Styling hierarchy rows, KPI indicators |
| shadcn/ui | latest | Table, Collapsible, Progress, Badge, Tabs |
| Recharts | ^3.6.0 | KPI visualization (RadialBarChart, BarChart) |
| date-fns | ^4.1.0 | Duration calc, overlap detection, date analysis |
| xlsx (SheetJS) | ^0.18.5 | Excel export (write-only, safe for export use) |
| Lucide React | ^0.562.0 | Icons (ChevronRight, Target, AlertTriangle, etc.) |
| @radix-ui/react-collapsible | ^1.1.12 | Expand/collapse for hierarchy rows |
| @radix-ui/react-progress | ^1.1.8 | KPI progress bars |

---

## Recommended Stack by Feature Area

### 1. Hierarchical Grouped Table (Objective > KR > Initiative)

**Recommendation: Custom collapsible table with existing shadcn/ui components**

| Component | Source | Role |
|-----------|--------|------|
| `<Table>` | shadcn/ui (installed) | Table structure |
| `<Collapsible>` | shadcn/ui (installed) | Expand/collapse Objective and KR groups |
| `<Badge>` | shadcn/ui (installed) | Status badges, KR labels |
| `<ChevronRight>` | Lucide (installed) | Expand/collapse indicator (rotates on open) |

**Why NOT @tanstack/react-table:**
- The dataset is small (2 objectives, ~6-8 KRs, ~30-50 initiatives)
- The hierarchy is fixed at exactly 3 levels, not dynamic
- TanStack Table's grouping feature requires `getGroupedRowModel` + `getExpandedRowModel` + column definitions -- significant API surface for a simple use case
- The existing manual table pattern (see `initiatives-list.tsx`, `supplier-items-table.tsx`) works well and is consistent with the codebase
- TanStack Table adds ~53KB (minified) to the bundle for features we don't need (sorting, pagination, column resizing, pinning)

**Implementation pattern:**
```typescript
// Group initiatives by Objective, then by KR -- pure data transformation
const grouped = useMemo(() => {
  const byObjective = groupBy(initiatives, 'objective')
  return Object.entries(byObjective).map(([obj, items]) => ({
    objective: obj,
    keyResults: groupBy(items, 'keyResult'),
    // Aggregated metrics
    totalInitiatives: items.length,
    completedCount: items.filter(i => i.status === 'COMPLETED').length,
  }))
}, [initiatives])

// Render with Collapsible + Table
<Collapsible open={expanded[obj]} onOpenChange={...}>
  <CollapsibleTrigger asChild>
    <TableRow className="bg-muted/50 cursor-pointer">
      <TableCell>
        <ChevronRight className={cn("transition-transform", expanded && "rotate-90")} />
      </TableCell>
      <TableCell colSpan={5}>{formatObjective(obj)}</TableCell>
    </TableRow>
  </CollapsibleTrigger>
  <CollapsibleContent>
    {/* KR sub-groups, each also collapsible */}
  </CollapsibleContent>
</Collapsible>
```

**Confidence: HIGH** -- This pattern is well-documented in shadcn/ui community (GitHub issue #4736, DEV Community article) and matches the existing codebase conventions.

---

### 2. KPI Metrics with Progress Visualization

**Recommendation: Existing Recharts v3 + shadcn/ui Progress component**

| Component | Source | Role |
|-----------|--------|------|
| `<Progress>` | shadcn/ui (installed) | Inline progress bars for target/actual |
| `RadialBarChart` | Recharts (installed) | Radial KPI gauges on summary cards |
| `BarChart` | Recharts (installed) | Target vs actual comparison bars |
| `PieChart` | Recharts (installed) | Status distribution (already in dashboard) |

**KPI data model approach:**
KPI target/actual values are derived from linked projects, not stored separately. The initiative already has a `projects Project[]` relation. Aggregation happens at query time via Prisma:

```typescript
// In API route / server component
const initiative = await prisma.initiative.findUnique({
  where: { id },
  include: {
    projects: {
      select: {
        revenue: true,
        totalCost: true,
        status: true,
      }
    }
  }
})

// KPI calculation is pure TypeScript
const kpiMetrics = {
  projectCount: initiative.projects.length,
  completedProjects: initiative.projects.filter(p => p.status === 'COMPLETED').length,
  totalRevenue: initiative.projects.reduce((sum, p) => sum + Number(p.revenue || 0), 0),
  targetRevenue: Number(initiative.resourcesFinancial || 0),
}
```

**Why NOT a dedicated KPI/metrics library:**
- The metrics are simple ratios (actual/target as percentage)
- shadcn/ui `<Progress>` handles the visual (already has styled indicator with animation)
- Recharts already supports RadialBarChart for gauge-style displays
- No need for sparklines, mini-charts, or complex metric widgets at this scale

**Confidence: HIGH** -- Recharts is already used in the project (3 chart components). The Progress component is installed and styled.

---

### 3. Date Intelligence (Duration, Overlap, Flags)

**Recommendation: date-fns v4 (already installed) -- zero new dependencies**

| Function | From | Purpose |
|----------|------|---------|
| `differenceInDays` | date-fns | Calculate initiative duration |
| `differenceInBusinessDays` | date-fns | Business day duration |
| `areIntervalsOverlapping` | date-fns | Detect timeline overlaps between initiatives |
| `isWithinInterval` | date-fns | Check if date falls within range |
| `isBefore` / `isAfter` | date-fns | Date validation (end > start) |
| `isPast` | date-fns | Overdue detection |
| `formatDistanceToNow` | date-fns | "3 days ago" / "in 2 weeks" for deadlines |
| `eachMonthOfInterval` | date-fns | Monthly timeline breakdown |
| `intervalToDuration` | date-fns | Human-readable duration (X months, Y days) |

**Key date-fns v4 features relevant to this milestone:**
- `areIntervalsOverlapping` now normalizes intervals (handles reversed start/end gracefully)
- `areIntervalsOverlapping({ inclusive: true })` option catches adjacent intervals sharing endpoints
- Invalid dates return `false` instead of throwing errors (safer for nullable DB fields)
- Full ESM + CommonJS dual-package support (compatible with Next.js 14)

**Date intelligence utility module pattern:**
```typescript
// src/lib/initiative-date-utils.ts
import {
  differenceInDays,
  areIntervalsOverlapping,
  isPast,
  isFuture,
  isWithinInterval,
  intervalToDuration,
} from 'date-fns'

export function getDurationFlag(startDate: Date, endDate: Date): 'short' | 'medium' | 'long' {
  const days = differenceInDays(endDate, startDate)
  if (days <= 30) return 'short'
  if (days <= 90) return 'medium'
  return 'long'
}

export function getOverlappingInitiatives(initiatives: Initiative[]): OverlapPair[] {
  const overlaps: OverlapPair[] = []
  for (let i = 0; i < initiatives.length; i++) {
    for (let j = i + 1; j < initiatives.length; j++) {
      if (areIntervalsOverlapping(
        { start: initiatives[i].startDate, end: initiatives[i].endDate },
        { start: initiatives[j].startDate, end: initiatives[j].endDate }
      )) {
        overlaps.push([initiatives[i], initiatives[j]])
      }
    }
  }
  return overlaps
}

export function getDateValidationErrors(start: Date, end: Date): string[] {
  const errors: string[] = []
  if (end <= start) errors.push('End date must be after start date')
  if (isPast(end)) errors.push('End date is in the past')
  return errors
}
```

**Confidence: HIGH** -- date-fns v4 is already installed and used across the codebase (12+ files). All needed functions are part of the core package.

---

### 4. Excel/CSV Export

**Recommendation: SheetJS xlsx v0.18.5 (already installed) for export-only use**

| Capability | Library | Notes |
|------------|---------|-------|
| XLSX write | xlsx (installed) | `XLSX.utils.json_to_sheet` + `XLSX.write` |
| CSV write | xlsx (installed) | `XLSX.utils.sheet_to_csv` |
| Styled export | N/A | Not needed for v1.5 (data export only) |

**Security note on xlsx v0.18.5:**
- CVE-2023-30533 (Prototype Pollution, CVSS 7.8) affects read/parse operations only
- The SheetJS advisory explicitly states: "Workflows that do not read arbitrary files (for example, exporting data to spreadsheet files) are unaffected"
- v1.5 uses xlsx strictly for **write/export** operations (generating XLSX from DB data)
- The vulnerability does NOT apply to our export-only use case
- The project already uses xlsx for seed data import (`prisma/seed.ts`), but that reads trusted local files only

**Why NOT ExcelJS:**
- xlsx is already installed and working in the project
- ExcelJS would add ~500KB to node_modules for features we don't need (styling, images, conditional formatting)
- For data-only export (initiatives list with objectives, KRs, status, metrics, dates), SheetJS is sufficient
- ExcelJS is slower than SheetJS and can crash on large files (not our concern at ~50 rows, but no reason to switch)

**Why NOT client-side export:**
- Server-side API route is more reliable for data aggregation
- Can include computed KPI metrics in the export
- No bundle size impact on the client

**Export API route pattern:**
```typescript
// src/app/api/initiatives/export/route.ts
import * as XLSX from 'xlsx'

export async function GET(request: NextRequest) {
  const initiatives = await prisma.initiative.findMany({
    include: { projects: true },
    orderBy: [{ objective: 'asc' }, { keyResult: 'asc' }, { sequenceNumber: 'asc' }],
  })

  const rows = initiatives.map(i => ({
    '#': i.sequenceNumber,
    'Objective': formatObjective(i.objective),
    'Key Result': i.keyResult,
    'Initiative': i.title,
    'Department': formatDepartment(i.department),
    'Status': formatStatus(i.status),
    'Owner': formatTeamMember(i.personInCharge),
    'Start Date': format(i.startDate, 'yyyy-MM-dd'),
    'End Date': format(i.endDate, 'yyyy-MM-dd'),
    'Duration (Days)': differenceInDays(i.endDate, i.startDate),
    'Linked Projects': i.projects.length,
  }))

  const ws = XLSX.utils.json_to_sheet(rows)
  const wb = XLSX.utils.book_new()
  XLSX.utils.book_append_sheet(wb, ws, 'Initiatives')

  const buf = XLSX.write(wb, { type: 'buffer', bookType: 'xlsx' })

  return new Response(buf, {
    headers: {
      'Content-Type': 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
      'Content-Disposition': `attachment; filename="initiatives-${format(new Date(), 'yyyy-MM-dd')}.xlsx"`,
    },
  })
}
```

**Confidence: HIGH** -- xlsx is already installed and used in the project. Export-only usage is explicitly safe per SheetJS advisory.

---

## Full Recommended Stack Summary

### New Dependencies Required

**None.** Zero new npm packages needed.

### Existing Dependencies Leveraged

| Library | Version | v1.5 Feature Area | New Usage |
|---------|---------|-------------------|-----------|
| shadcn/ui Table + Collapsible | installed | Hierarchy view | Collapsible table rows for Objective/KR groups |
| shadcn/ui Progress | installed | KPI visualization | Target/actual progress bars inline |
| Recharts | ^3.6.0 | KPI visualization | RadialBarChart for summary gauges |
| date-fns | ^4.1.0 | Date intelligence | `areIntervalsOverlapping`, `differenceInDays`, `intervalToDuration` |
| xlsx (SheetJS) | ^0.18.5 | Excel export | Server-side XLSX generation via API route |
| Lucide React | ^0.562.0 | UI icons | ChevronRight, Target, AlertTriangle, Download |

### What We Build Custom

| Component | Purpose | Based On |
|-----------|---------|----------|
| `ObjectiveGroupTable` | 3-level collapsible hierarchy view | shadcn Table + Collapsible |
| `KpiProgressBar` | Colored progress with target/actual labels | shadcn Progress |
| `KpiSummaryCard` | Radial gauge for objective-level KPIs | Recharts RadialBarChart |
| `initiative-date-utils.ts` | Duration, overlap, flag utilities | date-fns functions |
| `GET /api/initiatives/export` | Server-side XLSX generation | xlsx write API |
| `DateIntelligenceBadge` | Visual flags for date warnings | shadcn Badge + date-fns |

---

## Alternatives Considered

| Category | Recommended | Alternative | Why Not Alternative |
|----------|-------------|-------------|---------------------|
| Hierarchy table | Custom Collapsible + Table | @tanstack/react-table v8.21.3 | Overkill for 3-level fixed hierarchy with ~50 rows. Adds 53KB+ for features not needed (pagination, column resize, virtual scrolling). Inconsistent with existing manual table pattern in codebase. |
| Hierarchy table | Custom Collapsible + Table | AG Grid | Enterprise-grade, massive bundle (~1MB+), paid license for grouping. Absurd for a 3-person team tool. |
| KPI charts | Recharts (installed) | Chart.js / react-chartjs-2 | Would add a second charting library. Recharts is already used in 3 dashboard components. |
| KPI visualization | shadcn Progress + Recharts | Nivo | Beautiful but heavy (~300KB). Unnecessary when Recharts is already installed. |
| Date utilities | date-fns v4 (installed) | Day.js | Would add a second date library. date-fns is already used in 12+ files. Day.js has smaller API for intervals/overlap detection. |
| Date utilities | date-fns v4 (installed) | Luxon | Heavier than date-fns, OOP style inconsistent with codebase's functional approach. |
| Excel export | xlsx (installed) | ExcelJS v4.4.0 | Would add ~500KB dep when xlsx is already working. ExcelJS advantages (styling, images) not needed for data export. |
| Excel export | xlsx (installed) | Papa Parse (CSV only) | CSV is less useful than XLSX for this use case (multi-sheet potential, column widths). xlsx can do CSV too via `sheet_to_csv`. |
| Excel export | xlsx (installed) | Upgrade to xlsx v0.20.3 via CDN | Only needed if parsing untrusted files. Export-only use is safe on v0.18.5. Upgrade would require CDN tarball install, adds complexity. |

---

## What NOT to Use

| Avoid | Why | Use Instead |
|-------|-----|-------------|
| @tanstack/react-table | Overkill for fixed 3-level hierarchy with small dataset. Adds complexity and bundle size for unused features. | Custom Collapsible + Table (existing shadcn/ui) |
| AG Grid / Handsontable | Enterprise-grade, massive bundles, paid licenses for grouping features. | Custom Collapsible + Table |
| D3.js directly | Too low-level for the chart types needed. Recharts already wraps D3. | Recharts (already installed) |
| Moment.js | Deprecated, mutable, large bundle (300KB+). | date-fns v4 (already installed) |
| ExcelJS | Unnecessary new dependency when xlsx is installed and working for export-only. | xlsx v0.18.5 (already installed) |
| Client-side export libraries (file-saver, etc.) | Server-side API route is cleaner, more reliable, and doesn't bloat client bundle. | Server-side API route with xlsx |
| Tree view component (shadcn-tree-view) | Designed for file-explorer/menu patterns, not tabular data with columns. | Collapsible Table pattern |

---

## Installation

```bash
# No new packages to install!
# Everything needed is already in package.json.

# If you want to verify current versions:
npm ls recharts date-fns xlsx @radix-ui/react-collapsible @radix-ui/react-progress
```

---

## Risks and Mitigations

| Risk | Severity | Mitigation |
|------|----------|------------|
| xlsx v0.18.5 CVE-2023-30533 | LOW (export-only safe) | Only use xlsx.write/utils.json_to_sheet. Never parse untrusted files. Document this constraint. |
| Collapsible inside Table breaks HTML semantics | MEDIUM | Use `asChild` pattern on TableRow. Test across browsers. Alternatively, use CSS-based show/hide instead of Radix Collapsible if DOM nesting causes issues. |
| Recharts RadialBarChart responsiveness | LOW | Use `<ResponsiveContainer>` wrapper (already established pattern in project). |
| date-fns v4 ESM imports in Next.js 14 | LOW | Already working in 12+ files. No known issues. |
| KPI aggregation performance with many projects | LOW | ~50 initiatives x ~5 projects each = ~250 rows. Well within Prisma's capability. Add DB index on `initiative_id` in projects table (already exists per schema). |

---

## Sources

- [TanStack Table Grouping Guide](https://tanstack.com/table/v8/docs/guide/grouping) -- Official docs on row grouping
- [@tanstack/react-table on npm](https://www.npmjs.com/package/@tanstack/react-table) -- v8.21.3 (latest, April 2025)
- [Build Expandable Data Table with shadcn/ui](https://dev.to/mfts/build-an-expandable-data-table-with-2-shadcnui-components-4nge) -- Collapsible + Table pattern without TanStack
- [shadcn/ui Nested Data Table Issue #4736](https://github.com/shadcn-ui/ui/issues/4736) -- Community implementation
- [shadcn/ui Charts - Radial](https://ui.shadcn.com/charts/radial) -- Official radial chart components
- [shadcn/ui Chart component docs](https://ui.shadcn.com/docs/components/chart) -- Chart wrapper for Recharts
- [date-fns Intervals and Durations](https://deepwiki.com/date-fns/date-fns/2.5-intervals-and-durations) -- DeepWiki reference for interval functions
- [date-fns areIntervalsOverlapping](https://docs.w3cub.com/date_fns/areIntervalsOverlapping) -- API reference
- [SheetJS CVE-2023-30533](https://git.sheetjs.com/sheetjs/sheetjs/issues/2934) -- Security advisory (export-only workflows unaffected)
- [Snyk xlsx 0.18.5 vulnerabilities](https://security.snyk.io/package/npm/xlsx/0.18.5) -- Vulnerability tracker
- [ExcelJS vs SheetJS npm trends](https://npmtrends.com/exceljs-vs-sheetjs-vs-xlsx) -- Download comparison
- [SheetJS Data Export docs](https://docs.sheetjs.com/docs/solutions/output/) -- Official export documentation

---

*Stack research for: v1.5 OKR/Initiative Management with KPI Tracking & Export*
*Researched: 2026-01-26*
*Verdict: Zero new dependencies. Leverage existing stack fully.*
