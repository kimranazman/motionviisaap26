# Technology Stack: v2.0 OKR Restructure

**Project:** SAAP 2026 v2.0
**Researched:** 2026-01-27
**Scope:** What is NEW for v2.0 -- packages, tools, and patterns needed beyond the existing stack

## Executive Summary

v2.0 requires **zero new npm packages**. The existing stack already contains everything needed:

| Capability | Already Installed | Version |
|---|---|---|
| Excel parsing for seed | `xlsx` (SheetJS) | 0.18.5 |
| Database ORM + migrations | `prisma` / `@prisma/client` | 6.19.2 |
| Dashboard charts (revenue widget) | `recharts` | 3.6.0 |
| Dashboard grid layout | `react-grid-layout` | 2.2.2 |
| Widget registry pattern | Custom (`src/lib/widgets/registry.ts`) | N/A |
| Date handling | `date-fns` | 4.1.0 |
| UI components | `shadcn/ui` + Radix primitives | Latest |
| TypeScript seed runner | `tsx` (available globally) / `ts-node` | 4.21.0 / 10.9.2 |

The work is **schema design + migration + seed rewrite + UI**, not library acquisition.

---

## Existing Stack (No Changes Needed)

### Core Runtime
| Technology | Version | Status |
|---|---|---|
| Next.js 14 (App Router) | 14.2.28 | Keep as-is |
| React 18 | 18.x | Keep as-is |
| TypeScript | 5.x | Keep as-is |
| Node.js | 23.7.0 | Keep as-is |

### Database Layer
| Technology | Version | Status |
|---|---|---|
| Prisma ORM | 6.19.2 | Keep -- use `prisma migrate dev` for schema changes |
| @prisma/client | 6.19.2 | Keep -- auto-generated from schema |
| MariaDB (MySQL provider) | Via `datasource db { provider = "mysql" }` | Keep as-is |

### UI Layer
| Technology | Version | Status |
|---|---|---|
| Tailwind CSS | 3.4.1 | Keep as-is |
| shadcn/ui (Radix primitives) | Latest | Keep as-is |
| Recharts | 3.6.0 | Keep -- revenue target widget uses BarChart/RadialBarChart |
| react-grid-layout | 2.2.2 | Keep -- dashboard widget grid |
| lucide-react | 0.562.0 | Keep -- icons |

### Data Processing
| Technology | Version | Status |
|---|---|---|
| xlsx (SheetJS) | 0.18.5 | Keep -- seed script already uses this for Excel parsing |
| date-fns | 4.1.0 | Keep -- date parsing in seed and UI |

---

## What v2.0 USES From Existing Stack

### 1. Prisma Migrate (for schema changes)

**What:** Promote `keyResult` from a `String @db.VarChar(20)` field on `Initiative` to a first-class `KeyResult` model. Add `SupportTask` model with join table.

**How:** `npx prisma migrate dev --name "add-key-result-model"` creates a migration SQL file, applies it, and regenerates the client. This is the standard Prisma workflow already in use.

**Confidence:** HIGH -- Prisma 6.19.2 fully supports this. The project already uses `prisma db push` and has migration infrastructure.

**Key decisions:**

| Decision | Recommendation | Rationale |
|---|---|---|
| Migration strategy | `prisma migrate dev` (not `db push`) | Creates versioned SQL migrations for reproducibility. The project currently uses `db push` for development, but v2.0 is a structural change that benefits from migration history. |
| Wipe vs. migrate existing data | **Wipe and reseed** | The project context explicitly says "wipe and reseed from Excel." Use `prisma migrate reset` which drops DB, re-applies all migrations, and runs seed automatically. |
| Join table for SupportTask-to-KR | **Explicit join table** (not implicit) | The many-to-many between SupportTask and KeyResult does NOT need extra fields on the relation itself -- but MariaDB/MySQL with Prisma implicit m:n can be finicky, and explicit gives full control over the join table naming and future extensibility. Also matches the existing `TaskTag` explicit join pattern in the codebase. |

**Source:** [Prisma Migrate docs](https://www.prisma.io/docs/orm/prisma-migrate), [Many-to-many relations](https://www.prisma.io/docs/orm/prisma-schema/data-model/relations/many-to-many-relations)

### 2. xlsx (SheetJS) for Seed Script

**What:** Parse `MotionVii_SAAP_2026_v2.xlsx` with 5 sheets (OKR Summary, Key Results, Initiatives, Structure Guide, Support Tasks).

**How:** The existing `prisma/seed.ts` already does exactly this pattern -- reads Excel with `XLSX.readFile()`, parses with `sheet_to_json()`, maps to Prisma models. The v2.0 seed extends this to parse 3 additional sheets (Key Results, Initiatives with new structure, Support Tasks).

**Confidence:** HIGH -- `xlsx` 0.18.5 handles multi-sheet workbooks. The existing seed script already demonstrates this with the "Events to Attend" sheet.

**Key decisions:**

| Decision | Recommendation | Rationale |
|---|---|---|
| Seed runner | Switch to `tsx` (already available at v4.21.0) | The `seed-admin.ts` and `seed-cost-categories.ts` already use `npx tsx`. Faster than `ts-node` with `--compiler-options`. Update `package.json` prisma.seed to use `tsx`. |
| Seed script structure | Single `prisma/seed-v2.ts` file | Keep separate from v1 seed. The v2 seed handles the new OKR structure (KeyResult model, updated Initiative, SupportTask). Can coexist until v1 seed is removed. |
| Delete order for wipe | `SupportTaskKeyResult` -> `SupportTask` -> `Initiative` -> `KeyResult` -> (other tables) | Foreign key constraints require child-first deletion. MariaDB enforces this strictly. |

### 3. Recharts for Revenue Target Widget

**What:** Dashboard widget showing revenue target vs. actual, with progress visualization.

**How:** The codebase already uses `BarChart` from Recharts for pipeline-stage-chart and department-chart. Revenue target widget should use either:
- `BarChart` with target line overlay (simple, consistent with existing patterns)
- `RadialBarChart` for a gauge-style progress indicator (more visually distinct for a single KPI)

**Confidence:** HIGH -- Recharts 3.6.0 includes both chart types. No new packages needed.

**Key decisions:**

| Decision | Recommendation | Rationale |
|---|---|---|
| Chart type | **BarChart with ReferenceLine** for target | Consistent with existing dashboard chart patterns. Shows actual vs target as horizontal bars with a reference line at target. Simple, readable. |
| Data source | Aggregate from `KeyResult` model where `metricType = 'Revenue'` | KR1.1 and KR1.3 are revenue-typed KRs. Sum their `actual` fields and compare to `target`. |
| Widget registration | Add to `src/lib/widgets/registry.ts` | Follow existing pattern: define in registry, create component, add to dashboard data fetcher. |

### 4. Widget Registry Pattern (for revenue widget)

**What:** Register a new `revenue-target` widget in the existing registry.

**How:** Add entry to `WIDGET_REGISTRY` in `src/lib/widgets/registry.ts` following the exact pattern of existing widgets (id, title, description, defaultSize, minRole, category, dataKey).

**Confidence:** HIGH -- Well-established pattern with 8 existing widgets. Zero new libraries.

---

## New Prisma Schema Models (Design Recommendations)

These are not "stack" per se, but they drive the migration:

### KeyResult Model

```prisma
enum MetricType {
  REVENUE
  COUNT
  PERCENTAGE
  BINARY
}

enum KeyResultStatus {
  NOT_STARTED
  ON_TRACK
  AT_RISK
  BEHIND
  ACHIEVED
}

model KeyResult {
  id          String          @id @default(cuid())
  krId        String          @unique @db.VarChar(20)  // e.g., "KR1.1"
  objective   Objective
  description String          @db.VarChar(500)

  // Measurement
  metricType  MetricType
  target      Decimal         @db.Decimal(12, 2)
  actual      Decimal         @default(0) @db.Decimal(12, 2)
  unit        String          @db.VarChar(50)          // "RM", "events", "%"
  progress    Decimal         @default(0) @db.Decimal(5, 2) // 0.00 - 100.00

  // Ownership & timeline
  owner       TeamMember?
  deadline    DateTime?
  status      KeyResultStatus @default(NOT_STARTED)

  // Context
  howWeMeasure String?        @map("how_we_measure") @db.Text
  weight       Decimal        @default(1) @db.Decimal(3, 2) // 0.00 - 1.00 for weighted scoring
  notes        String?        @db.Text

  // Relations
  initiatives  Initiative[]
  supportTasks SupportTaskKeyResult[]

  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt

  @@index([objective])
  @@index([status])
  @@index([metricType])
  @@map("key_results")
}
```

### Updated Initiative Model (remove KPI fields, add KR relation)

```prisma
model Initiative {
  // ... existing fields ...

  // REMOVE these fields:
  // kpiLabel, kpiTarget, kpiActual, kpiUnit, kpiManualOverride

  // CHANGE keyResult from String to relation:
  keyResultId   String       @map("key_result_id")
  keyResult     KeyResult    @relation(fields: [keyResultId], references: [id])

  // ... rest unchanged ...
  @@index([keyResultId])
}
```

### SupportTask Model

```prisma
enum SupportTaskCategory {
  DESIGN_CREATIVE
  BUSINESS_ADMIN
  TALENTA_IDEAS
  OPERATIONS
}

enum SupportTaskFrequency {
  ONE_TIME
  DAILY
  WEEKLY
  MONTHLY
  QUARTERLY
  AS_NEEDED
}

enum SupportTaskPriority {
  LOW
  MEDIUM
  HIGH
}

model SupportTask {
  id          String                @id @default(cuid())
  task        String                @db.VarChar(500)
  category    SupportTaskCategory
  owner       TeamMember?
  frequency   SupportTaskFrequency  @default(AS_NEEDED)
  priority    SupportTaskPriority   @default(MEDIUM)
  notes       String?               @db.Text

  // Many-to-many with KeyResult (explicit join)
  keyResults  SupportTaskKeyResult[]

  createdAt   DateTime              @default(now())
  updatedAt   DateTime              @updatedAt

  @@index([category])
  @@index([priority])
  @@map("support_tasks")
}

model SupportTaskKeyResult {
  id            String      @id @default(cuid())

  supportTaskId String      @map("support_task_id")
  supportTask   SupportTask @relation(fields: [supportTaskId], references: [id], onDelete: Cascade)

  keyResultId   String      @map("key_result_id")
  keyResult     KeyResult   @relation(fields: [keyResultId], references: [id], onDelete: Cascade)

  createdAt     DateTime    @default(now())

  @@unique([supportTaskId, keyResultId])
  @@index([supportTaskId])
  @@index([keyResultId])
  @@map("support_task_key_results")
}
```

---

## What NOT to Install

| Package | Why You Might Think You Need It | Why You Don't |
|---|---|---|
| `exceljs` | Alternative Excel parser | `xlsx` (SheetJS) 0.18.5 already installed and used in seed. Switching adds risk for zero benefit. |
| `openpyxl` (Python) | Python Excel parsing mentioned in context | The seed script is TypeScript, runs with `tsx`/`ts-node`, uses `xlsx`. Python is unnecessary complexity. |
| `@tanstack/react-table` | For OKR data tables | The existing objectives view uses custom components (`ObjectiveHierarchy`, `KeyResultGroup`). Adding a table library for 6 KRs and 30 support tasks is overkill. |
| `zod` | Schema validation for seed data | The seed script validates via Prisma's type system and enum mapping functions. Adding Zod for a one-time seed operation is overengineering. |
| `d3` or `victory` | Charts for revenue widget | Recharts 3.6.0 already handles all charting needs. Three chart components already exist using it. |
| `@radix-ui/react-checkbox` | For SupportTask multi-select UI | Not currently installed, but the existing multi-select pattern in the codebase uses `cmdk` (command palette) for selection. If checkboxes are needed, add the shadcn checkbox component (`npx shadcn-ui@latest add checkbox`), not a raw Radix package. |

---

## Potential shadcn/ui Component Additions

These are **optional** shadcn/ui components that might be useful for v2.0 UI but require no npm install (shadcn copies component files locally):

| Component | Use Case | Command |
|---|---|---|
| `checkbox` | SupportTask multi-KR selection | `npx shadcn-ui@latest add checkbox` |
| `data-table` | SupportTask list view (if needed) | Uses `@tanstack/react-table` -- avoid unless table is complex |

**Recommendation:** Only add `checkbox` if the SupportTask editing UI needs multi-select checkboxes for KR linkage. The `cmdk` command palette already installed may handle this better.

---

## Seed Script Execution Strategy

**Current state:**
- `prisma/seed.ts` -- Uses `ts-node` with CommonJS compiler option, reads v1 Excel
- `prisma/seed-admin.ts` -- Uses `tsx`, seeds admin user
- `prisma/seed-cost-categories.ts` -- Uses `tsx`, seeds cost categories

**v2.0 approach:**

```bash
# 1. Update package.json to use tsx (faster, already available)
"prisma": {
  "seed": "npx tsx prisma/seed.ts"
}

# 2. Rewrite seed.ts to handle v2 Excel structure
# Parse sheets: "Key Results", "Initiatives", "Support Tasks"
# Seed order: KeyResult -> Initiative (with keyResultId) -> SupportTask -> SupportTaskKeyResult

# 3. Wipe and reseed
npx prisma migrate reset
# This drops DB, re-applies migrations, runs seed automatically
```

**Confidence:** HIGH -- This is the documented Prisma workflow. The seed auto-runs on `migrate reset`.

---

## Progress Calculation Strategy (No Library Needed)

The KR progress field can be computed in two ways:

| Approach | How | When |
|---|---|---|
| **Seed-time calculation** | `progress = (actual / target) * 100` computed during Excel import | For initial data load |
| **Runtime calculation** | Computed in API route or server component | For live dashboard updates |
| **Status auto-calculation** | Based on progress vs. timeline: if `expectedProgress - actualProgress > 25` then `AT_RISK` | Following Microsoft Viva Goals pattern |

**Weighted objective scoring:** Each KR has a `weight` field (0.00 - 1.00). Objective progress = sum of (KR progress * KR weight). This is standard OKR scoring per [IBM's OKR methodology](https://www.ibm.com/think/insights/okr-measurement-scoring).

No library needed -- this is arithmetic in TypeScript.

---

## Migration Execution Order

For the v2.0 schema changes, execute in this order:

```
1. prisma migrate dev --name "add-key-result-model"
   - Creates KeyResult table
   - Creates SupportTask table
   - Creates SupportTaskKeyResult join table
   - Adds keyResultId to Initiative
   - Drops kpiLabel, kpiTarget, kpiActual, kpiUnit, kpiManualOverride from Initiative
   - Removes keyResult String field from Initiative

2. prisma migrate reset
   - Drops and recreates entire DB (acceptable since we're reseeding)
   - Runs seed script automatically

3. npx tsx prisma/seed.ts
   - Parses v2 Excel file
   - Seeds KeyResult, Initiative, SupportTask, SupportTaskKeyResult
```

**Note:** Since we're wiping and reseeding, the migration can be a single big migration rather than incremental steps. Data preservation is not a concern.

---

## Confidence Assessment

| Area | Confidence | Reason |
|---|---|---|
| No new npm packages needed | HIGH | Verified all existing packages cover requirements |
| Prisma migration approach | HIGH | Standard documented workflow, verified with Prisma 6.19.2 |
| xlsx seed parsing | HIGH | Existing seed.ts already demonstrates multi-sheet parsing |
| Recharts for revenue widget | HIGH | 3 existing chart components prove the pattern |
| Widget registry extension | HIGH | 8 existing widgets in registry.ts prove the pattern |
| Explicit join table for SupportTask-KR | HIGH | Matches existing TaskTag pattern in codebase |
| Schema design for KeyResult | MEDIUM | Design is sound but specific field types/sizes should be validated against actual Excel data during implementation |
| Progress calculation | MEDIUM | Arithmetic is trivial but auto-status thresholds need product validation |

---

## Sources

- [Prisma Migrate Documentation](https://www.prisma.io/docs/orm/prisma-migrate)
- [Prisma Many-to-Many Relations](https://www.prisma.io/docs/orm/prisma-schema/data-model/relations/many-to-many-relations)
- [Prisma Seeding Documentation](https://www.prisma.io/docs/orm/prisma-migrate/workflows/seeding)
- [IBM OKR Measurement and Scoring](https://www.ibm.com/think/insights/okr-measurement-scoring)
- [Microsoft Viva Goals - Track OKR Progress](https://learn.microsoft.com/en-us/viva/goals/track-okr-progress-status)
- [Quantive OKR Tracking Best Practices](https://quantive.com/resources/articles/okr-tracking)
- Codebase analysis: `package.json`, `prisma/schema.prisma`, `prisma/seed.ts`, `src/lib/widgets/registry.ts`, `src/components/objectives/`
