# Domain Pitfalls: SAAP v2.3 CRM & UX Improvements

**Domain:** CRM platform with modal-heavy UI, sidebar navigation, internal projects, line item pricing
**Researched:** 2026-01-28
**Overall confidence:** HIGH (verified against codebase + official Radix/shadcn docs + community issue trackers)

---

## Critical Pitfalls

Mistakes that cause rewrites, recurring bugs, or data corruption.

---

### Pitfall 1: Radix Dialog/Sheet ScrollArea Height Collapse

**What goes wrong:** Content inside `DetailView` (used by all detail sheets: deals, projects, potentials, suppliers, companies, initiatives, tasks) cannot scroll when content exceeds viewport. The `ScrollArea` component silently fails to scroll because it has no bounded height.

**Why it happens:** The codebase uses Radix `ScrollArea` inside `DialogContent`. The current `detail-view.tsx` (line 120) applies `className="flex-1 min-h-0"` to the `ScrollArea`, which is correct for flex containers. However, the `DialogContent` (line 111) uses `p-0 flex flex-col` but the Radix `DialogContent` is positioned with `fixed` + `max-h-[85vh]`. The issue chain is:

1. `DialogContent` has `max-h-[85vh]` and `overflow-y-auto` (from `dialog.tsx` line 42-49)
2. The `overflow-y-auto` on `DialogContent` competes with the `ScrollArea` inside it
3. Radix `ScrollArea`'s internal viewport uses `display: table` (known Radix bug, [Issue #2307](https://github.com/radix-ui/primitives/issues/2307)), which prevents flex-based height calculation
4. When `ScrollArea` cannot compute a bounded height, it renders at full content height, pushing content beyond the `DialogContent` boundary
5. The `overflow-y-auto` on `DialogContent` then handles scrolling, but this bypasses the custom `ScrollBar` styling of `ScrollArea`

**Specific codebase evidence:** In `dialog.tsx` line 42, `DialogContent` has `overflow-y-auto` as a fallback. This masks the `ScrollArea` bug because native scrolling takes over, but it means the custom scrollbar from `ScrollArea` never appears. On mobile (line 44), the dialog is `h-[calc(100vh-2rem)]` which further constrains the container and can cause double-scroll when the native overflow and `ScrollArea` both try to scroll.

**Consequences:**
- Users cannot reach content below the fold in long forms (project detail sheet with costs, documents, tasks is very long)
- On mobile, double-scroll bars appear (native + Radix ScrollArea)
- Close button may be unreachable if header scrolls away
- AlertDialog confirmations inside detail sheets may render off-screen

**Prevention:**
1. Remove `overflow-y-auto` from `DialogContent` base styles and let `ScrollArea` handle all scrolling
2. Give `ScrollArea` an explicit bounded height: `h-[calc(85vh-header-footer)]` instead of relying on `flex-1`
3. For `ScrollArea` inside flex containers, apply the height to the `ScrollAreaPrimitive.Viewport` directly via `[&>[data-radix-scroll-area-viewport]]:max-h-[calc(85vh-120px)]` to work around the `display: table` bug
4. Test every detail sheet type after changes: deal, project, potential, supplier, company, initiative, task
5. Test both `dialog` and `drawer` modes (controlled by `useDetailViewMode`)

**Detection:**
- Open project detail sheet for a project with 10+ costs, several documents, and tasks
- Attempt to scroll to bottom in dialog mode
- Check if ScrollArea thumb/track appears or if browser native scrollbar appears instead
- Test on both desktop and mobile viewports

**Confidence:** HIGH -- verified against actual codebase source code and known Radix issues

**Phase relevance:** Must be addressed first, before any other modal content changes. Every new feature (line items, CRM pages) adds content to modals, making this worse.

---

### Pitfall 2: Expand-to-Page Button Opens Modal-on-Page Instead of Standalone View

**What goes wrong:** The expand button (`expandHref`) navigates to `/projects/[id]`, but that page (`project-detail-page-client.tsx`) renders `ProjectDetailSheet` with `open={true}` -- meaning the user sees a modal overlaying an empty page, not a proper full-page view.

**Why it happens:** The standalone page at `src/app/(dashboard)/projects/[id]/page.tsx` was implemented as a quick wrapper that re-uses the existing `ProjectDetailSheet` component. This was a reasonable shortcut, but it means:

1. User clicks expand button in modal -> navigates to `/projects/[id]`
2. Page renders an empty container with `Header` and a `main` element
3. `ProjectDetailSheet` opens as a modal/drawer on top of this empty page
4. When user closes the modal, `handleOpenChange` navigates back to `/projects`
5. The "full page" experience is actually "modal on empty page"

**Consequences:**
- No true full-page layout exists -- users expecting a real page get another modal
- Closing the modal unexpectedly navigates away (to `/projects` list)
- Browser back button from the expand page goes back to the list page with the original modal gone
- URL-based sharing works (`/projects/[id]`) but the experience is disorienting

**Prevention:**
1. Create a true standalone `ProjectDetailPage` component that renders content inline (not in a modal)
2. Reuse the same data-fetching and form logic, but render it in a page layout instead of `DetailView`
3. Extract shared content (form fields, cost list, documents section) into composable sections that work in both modal and page contexts
4. Pattern: `DetailContent` (shared) used by both `DetailSheet` (modal) and `DetailPage` (full page)

**Detection:**
- Click expand button on any project detail modal
- Observe if you get a proper page layout or another modal on empty background
- Press browser back button and observe navigation behavior

**Confidence:** HIGH -- directly verified in codebase (`project-detail-page-client.tsx` line 54-58 opens `ProjectDetailSheet` with `open={true}`)

**Phase relevance:** Must be designed before adding standalone entity pages for CRM. The pattern established here will be replicated for companies, suppliers, contacts, deals.

---

### Pitfall 3: Making companyId Optional Cascades Through 26+ Files

**What goes wrong:** Changing `companyId` from required to optional in the Prisma schema (`companyId String @map("company_id")` to `companyId String? @map("company_id")`) triggers cascading failures across the entire application.

**Why it happens:** The current schema enforces `companyId` as non-nullable on `Project`. This assumption is baked into:

**API routes (validation):**
- `src/app/api/projects/route.ts` line 72: `if (!body.companyId)` returns 400 error
- `src/app/api/projects/[id]/route.ts`: PATCH handler may assume companyId exists
- `src/app/api/deals/route.ts`: requires companyId
- `src/app/api/potential-projects/route.ts`: requires companyId

**Components (form validation):**
- `src/components/projects/project-form-modal.tsx` line 79, 113: validates companyId required
- `src/components/pipeline/deal-form-modal.tsx` line 83, 140: validates companyId required
- `src/components/potential-projects/potential-form-modal.tsx` line 83, 140: validates companyId required
- `src/components/projects/project-detail-sheet.tsx` line 577: validates companyId required

**Components (display, assumes non-null):**
- `src/components/projects/project-card.tsx` line 74: `project.company.name` (will crash if null)
- `src/components/pipeline/pipeline-card.tsx` line 258: `deal.company.name` (will crash if null)
- `src/components/potential-projects/potential-card.tsx` line 258: `project.company.name` (will crash if null)
- `src/components/suppliers/supplier-detail-modal.tsx` line 444: `project.company.name`
- `src/lib/manifest-utils.ts` line 88: `project.company.name`
- `src/app/api/ai/pending/route.ts` line 75: `doc.project.company.name` (will crash in API)

**Prisma schema:**
- `@@index([companyId])` -- index remains valid for nullable column
- `company Company @relation(...)` needs to become `company Company? @relation(...)`
- Referential action changes: default switches from `Restrict` to `SetNull` on delete

**Consequences:**
- Runtime crashes (`Cannot read property 'name' of null`) on project cards, pipeline cards, potential cards
- API 500 errors when AI pending endpoint encounters internal projects
- Form validation blocks saving internal projects if validation is not updated
- Prisma migration may require manual SQL if existing data has issues

**Prevention:**
1. **Audit first:** Search for all `company.name`, `company?.name`, `companyId` references (26+ files identified above)
2. **Type-driven refactoring:** Change `company: { id: string; name: string }` to `company: { id: string; name: string } | null` in all interfaces first, then fix TypeScript errors
3. **Conditional rendering:** Every `company.name` display must become `company?.name ?? 'Internal'` or similar
4. **Form logic:** Add "Internal Project" toggle/checkbox that:
   - Hides company selector when checked
   - Skips companyId validation when checked
   - Sets a visual indicator (badge, icon) on project cards
5. **Migration strategy:**
   - Generate migration with `prisma migrate dev --create-only`
   - Review generated SQL before applying
   - Do NOT drop and re-create the column (data loss risk)
   - Simply `ALTER TABLE projects ALTER COLUMN company_id DROP NOT NULL`
6. **Test the full pipeline:** Create internal project -> view in list -> view in detail -> view in AI pending -> view in supplier detail

**Detection:**
- Run `tsc --noEmit` after schema change to find all type errors
- Search for `.company.name` (without optional chaining) to find crash points
- Test AI `/api/ai/pending` endpoint with an internal project

**Confidence:** HIGH -- file-by-file audit completed against actual codebase

**Phase relevance:** This is the single most impactful schema change in v2.3. Must be done carefully with a full file audit checklist. Recommend a dedicated phase or sub-task.

---

### Pitfall 4: Line Item Pricing Data Model Breaks Existing Cost Aggregation

**What goes wrong:** Adding `quantity` and `unitPrice` fields to the `Cost` model introduces ambiguity in how `amount` is calculated and breaks existing aggregation logic.

**Why it happens:** The current `Cost` model stores a single `amount Decimal @db.Decimal(12, 2)`. All existing aggregation code (dashboard, project detail, supplier comparison) uses `cost.amount` directly. If you add `quantity` and `unitPrice`:

```prisma
model Cost {
  // existing
  amount      Decimal  @db.Decimal(12, 2)    // total line amount
  // new
  quantity    Int?                             // number of units
  unitPrice   Decimal? @db.Decimal(12, 2)     // price per unit
}
```

**The ambiguity:**
- Is `amount` always `quantity * unitPrice`? What about existing records without quantity?
- What if `amount` is edited manually but `quantity * unitPrice` disagrees?
- What about tax, discount on line items?
- The AI extraction already outputs `quantity`, `unitPrice`, and `total` per line item -- but the import route (`/api/ai/import/invoice/route.ts`) currently only stores `amount`

**Consequences:**
- Existing costs (hundreds of records) have `amount` but null `quantity`/`unitPrice`
- `calculateTotalCosts()` in `src/lib/cost-utils.ts` sums `amount` -- this still works but ignores the new fields
- Price comparison page (`/supplier-items`) uses `normalizedItem` and `amount` -- adding `unitPrice` changes what "price" means for comparison
- Dashboard charts and profit calculations could show wrong numbers if `amount` and `quantity * unitPrice` diverge

**Prevention:**
1. **Keep `amount` as the canonical total.** Always store the line total in `amount`. `quantity` and `unitPrice` are informational/audit fields.
2. **Computed validation, not computed storage:** When creating/editing costs with quantity and unitPrice, validate that `amount == quantity * unitPrice` (within rounding tolerance) but store all three independently. This handles:
   - Legacy records: `amount` exists, `quantity`/`unitPrice` are null -- aggregation unchanged
   - New records: all three populated -- aggregation uses `amount` as before
   - Manual edits: user changes `amount` directly -- system warns if it diverges from `quantity * unitPrice`
3. **Migration is additive:** Add nullable columns, no data migration needed for existing records
4. **Update AI import:** Modify invoice import to store `quantity` and `unitPrice` alongside `amount`
5. **Price comparison:** Use `unitPrice` for per-unit comparison, `amount` for total comparison. Make the view toggleable.

**Detection:**
- After adding fields, run existing cost aggregation and compare before/after totals
- Create cost with quantity=2, unitPrice=100, amount=200 -- verify aggregation shows 200
- Create cost with quantity=2, unitPrice=100, amount=250 (manual override) -- verify system warns

**Confidence:** HIGH -- analyzed actual Cost model, cost-utils.ts, and import route

**Phase relevance:** Should be implemented alongside AI extraction improvements since both touch the Cost model.

---

## Moderate Pitfalls

Mistakes that cause delays, confusing UX, or technical debt.

---

### Pitfall 5: AlertDialog Inside Dialog/Sheet Creates Focus Trap Conflicts

**What goes wrong:** When an `AlertDialog` (delete confirmation) is triggered from inside a `Dialog` or `Sheet` (detail view), Radix's focus trap management conflicts between the two portals.

**Why it happens:** Both `Dialog` and `AlertDialog` are Radix Dialog primitives. Each creates its own portal with focus trapping. When `AlertDialog` opens inside an already-open `Dialog`:
1. The `Dialog`'s focus trap is active
2. `AlertDialog` creates a second focus trap on top
3. When `AlertDialog` closes, focus trap may not correctly return to the `Dialog`
4. On some browsers/screen readers, the `Dialog` may close too

**Codebase evidence:** This pattern exists in 10+ components:
- `deal-detail-sheet.tsx` (delete deal AlertDialog inside DetailView)
- `project-detail-sheet.tsx` (delete project, plus cost/deliverable/task deletions)
- `potential-detail-sheet.tsx` (delete potential)
- `supplier-detail-modal.tsx` (delete supplier)
- `company-detail-modal.tsx` (delete company)
- `cost-card.tsx`, `deliverable-card.tsx`, `task-tree-node.tsx`, `document-card.tsx`, `contact-card.tsx`, `department-card.tsx` (nested inside detail views)

**Consequences:**
- After confirming delete in AlertDialog, the parent Dialog/Sheet may close unexpectedly
- Focus may jump to an unexpected element after AlertDialog closes
- Screen readers may announce incorrect dialog state
- On mobile, dismissing AlertDialog by tapping outside may also dismiss the parent

**Prevention:**
1. Use `event.stopPropagation()` on AlertDialog's `onOpenChange` to prevent bubbling to parent Dialog
2. Set `modal={true}` explicitly on AlertDialog (default, but worth confirming)
3. Test the full flow: open detail sheet -> click delete -> click cancel in AlertDialog -> verify detail sheet is still open and focused
4. Consider using a custom confirmation pattern (inline confirmation with undo) instead of nested dialogs for less critical actions

**Detection:**
- Open any detail sheet -> click Delete -> click Cancel -> check if detail sheet is still open
- Test with keyboard navigation (Tab, Enter, Escape)
- Test with screen reader

**Confidence:** MEDIUM -- known Radix issue pattern, but current code may already handle it (shadcn AlertDialog renders in a separate portal). Needs runtime testing.

**Phase relevance:** Should be tested when fixing the scroll issues, since both involve Dialog internals.

---

### Pitfall 6: Sidebar Customization State Corruption and Lock-Out

**What goes wrong:** If sidebar customization allows users to hide navigation groups or items, users can hide the page they are currently on, creating a disorienting experience. Worse, corrupted localStorage state can hide all navigation items.

**Why it happens:** The current sidebar uses `useNavCollapseState` which stores group expand/collapse in localStorage under `sidebar-collapse-state`. If customization extends to hiding items entirely:

1. User hides the "CRM" group
2. User navigates to `/projects` via bookmark or URL
3. Sidebar shows no active item -- user cannot tell where they are
4. User cannot navigate back to other CRM pages without unhiding the group
5. If localStorage is corrupted (JSON parse failure), fallback may hide everything

**Current safeguard:** The existing code (line 32-34 in `use-nav-collapse-state.ts`) catches JSON parse errors and falls back to `DEFAULT_STATE` where all groups are expanded. But this only handles collapse state, not item visibility.

**Consequences:**
- Users lose navigation context ("Where am I?")
- Users cannot access hidden pages without knowing URLs
- Admin-only groups (`requireRole: 'ADMIN'`) hidden for non-admins is already correct -- but user-hidden items are a new risk
- Multiple browsers/devices may have different sidebar states, confusing users
- If settings are stored only in localStorage (not API-backed like `detailViewMode`), they cannot sync across devices

**Prevention:**
1. **Minimum visible set:** Always show at least "Dashboard" and "Settings" regardless of customization. These are escape hatches.
2. **Auto-reveal active page:** If user navigates to a page whose nav item is hidden, temporarily show it (similar to existing `findGroupForPath` auto-expand logic)
3. **"Reset to defaults" button:** Always accessible in Settings, not behind customizable navigation
4. **Server-side persistence:** Store sidebar preferences in `UserPreferences` (already has `dashboardLayout Json?`), not just localStorage
5. **Schema validation:** Define allowed values; reject unknown group keys; always include core items
6. **Progressive disclosure:** Instead of full hiding, allow "pin/unpin" with unpinned items still accessible via "More" overflow

**Detection:**
- Hide all groups -> refresh page -> verify at least core navigation appears
- Navigate to hidden page via URL -> verify sidebar shows correct active state
- Clear localStorage -> verify fallback renders all items
- Corrupt localStorage with invalid JSON -> verify graceful fallback

**Confidence:** HIGH for the risk assessment (based on UX research and codebase analysis), MEDIUM for specific implementation since sidebar customization is not yet built.

**Phase relevance:** This is a design-phase concern. Establish the rules before building the feature.

---

### Pitfall 7: Standalone Entity Pages Duplicate Data Fetching Logic

**What goes wrong:** Creating standalone pages (e.g., `/companies/[id]`, `/suppliers/[id]`, `/contacts/[id]`) that duplicate the data fetching already done in modal components leads to data consistency issues and maintenance burden.

**Why it happens:** The current pattern has detail sheets (e.g., `deal-detail-sheet.tsx`) that receive pre-fetched data as props AND also fetch additional data inside the component (e.g., contacts, activity logs). A standalone page would need to:

1. Fetch the entity data server-side (like `projects/[id]/page.tsx` does)
2. Pass it to a client component
3. The client component re-fetches related data (contacts, logs)

This creates two separate data-fetching paths for the same entity, and any schema/API change must be updated in both places.

**Current codebase evidence:**
- `projects/[id]/page.tsx` fetches project with `include: { company, contact, sourceDeal, sourcePotential, initiative, costs }`
- `ProjectDetailSheet` receives project as prop but also fetches costs, documents, deliverables, tasks independently
- Both paths serialize Decimal/Date values differently

**Consequences:**
- Bug fixes in one path are missed in the other
- Data shape mismatches between server and client fetching
- Increased API calls (page fetches data, then component re-fetches it)
- Serialization divergence (server component serializes `Decimal -> Number`, client component may not)

**Prevention:**
1. **Extract a shared data layer:** Create `getProjectById(id)` utility that both page.tsx and the detail sheet use
2. **Extract shared content components:** `ProjectInfoSection`, `ProjectCostsSection`, `ProjectDocumentsSection` that work in both modal and page contexts
3. **Prefer server-side data fetching:** Page components fetch all data; detail sheets receive it as props; avoid re-fetching in client components
4. **Type sharing:** Define shared TypeScript interfaces in a central location (e.g., `types/entities.ts`) used by both paths

**Detection:**
- Compare the `include` object in page.tsx vs the fetch calls in the detail sheet
- Check for data shape mismatches in TypeScript types
- Verify that editing data in modal updates the standalone page (and vice versa)

**Confidence:** HIGH -- directly observed in project detail page vs project detail sheet

**Phase relevance:** Must be designed before creating any new standalone entity pages. Establish the shared pattern first.

---

### Pitfall 8: AI Quantity Extraction Accuracy for Malaysian Invoices

**What goes wrong:** AI extraction of quantity and unit price from invoices produces incorrect values, leading to wrong cost data that is trusted because it came from "AI."

**Why it happens:** The current AI invoice extraction instruction file (`.claude/skills/ai-analyze/instructions/document-invoice.md`) already defines line item extraction including quantity, unitPrice, and lineTotal. However, real-world Malaysian invoices (the primary use case for Motionvii) present specific challenges:

1. **Lump sum invoices:** Many Malaysian service invoices (video production, design work) have a single line item with quantity=1 and the total amount. There is no meaningful quantity to extract.
2. **Mixed format invoices:** Some invoices mix line items with subtotals, making it hard to distinguish "2 x Video Production" from "Video Production Phase 1 / Phase 2"
3. **Malay language invoices:** Field labels may be in Malay ("Kuantiti", "Harga Seunit", "Jumlah") which AI models may handle with lower confidence
4. **Handwritten receipts:** Common for small Malaysian suppliers. OCR accuracy drops significantly.
5. **Tax complexity:** Malaysian SST (6%) may be applied per-item or as a final total. The AI may misattribute tax to the wrong level.

**Consequences:**
- Incorrect quantity (e.g., extracting "2" from "Phase 2" in description)
- Unit price that doesn't match total / quantity due to rounding
- Duplicate costs if AI creates separate entries for subtotal lines
- User trust erosion when imported data is visibly wrong
- Price comparison (`/supplier-items`) corrupted by bad unit prices

**Prevention:**
1. **Cross-validation rule:** Always verify `quantity * unitPrice == lineTotal` (within 1% tolerance for rounding). Flag mismatches for manual review.
2. **Default to lump sum:** When quantity is ambiguous, default to quantity=1, unitPrice=total. This is safe for aggregation.
3. **Confidence-gated import:** The instruction file already mentions confidence scoring. Enforce it: only auto-import HIGH confidence quantities. Present MEDIUM/LOW for manual review.
4. **Human-in-the-loop for quantity:** Show extracted quantity alongside the invoice image in the review UI. Let users correct before import.
5. **Audit trail:** Store both AI-extracted values and any user corrections. This helps improve extraction over time.
6. **Separate extraction from import:** The current flow already has PENDING -> ANALYZED -> IMPORTED states. Add a review step specifically for quantity/unitPrice before importing to Cost.

**Detection:**
- Run extraction on 10 diverse Malaysian invoices. Compare AI-extracted quantities against manual count.
- Check for invoices where quantity * unitPrice != lineTotal
- Check for invoices where sum of line totals != invoice total

**Confidence:** MEDIUM -- based on industry research on invoice OCR accuracy. Specific accuracy for this codebase's AI model depends on runtime testing.

**Phase relevance:** Should be implemented in the same phase as Cost model changes (quantity/unitPrice fields), but the validation rules should be designed before the import logic.

---

## Minor Pitfalls

Mistakes that cause annoyance but are fixable without major rework.

---

### Pitfall 9: Mobile Dialog Scroll Conflict with iOS Safari Bounce

**What goes wrong:** On iOS Safari, the dialog's `overflow-y-auto` interacts with Safari's elastic bounce scrolling, causing the dialog to dismiss when the user reaches the top or bottom of scrollable content and continues scrolling.

**Why it happens:** The current `DialogContent` on mobile (line 44 in dialog.tsx) uses `h-[calc(100vh-2rem)]` with bottom-anchored positioning. iOS Safari's rubber-banding scroll behavior can trigger the "pull to dismiss" gesture when the user over-scrolls at boundaries.

**Prevention:**
1. Add `overscroll-behavior: contain` CSS to the dialog content on mobile
2. Test on actual iOS devices (simulators may not reproduce)
3. For Sheet/drawer mode, use Vaul drawer which handles this natively (but note the Sheet component currently uses Radix Dialog, not Vaul)

**Confidence:** MEDIUM -- common iOS Safari issue, but not confirmed in this specific codebase

**Phase relevance:** Can be addressed alongside the main scroll fix.

---

### Pitfall 10: localStorage Quota Exceeded for Sidebar State

**What goes wrong:** If sidebar customization stores extensive preferences in localStorage, it may silently fail on devices with limited storage.

**Why it happens:** The current code wraps localStorage operations in try/catch (e.g., `use-nav-collapse-state.ts` lines 24-35, 46-49). However, if the app stores many preferences (collapse state, sheet width, sidebar customization, dashboard layout), cumulative storage may approach the ~5MB localStorage limit.

**Prevention:**
1. Keep localStorage data minimal (group keys + booleans only)
2. Use server-side storage (UserPreferences) for complex preferences
3. Always handle localStorage errors gracefully (the existing code already does this)
4. Consider using `sessionStorage` for non-persistent state

**Confidence:** LOW -- unlikely to be a real issue given the small data size, but worth noting for defensive coding

**Phase relevance:** Minor consideration during sidebar customization implementation.

---

### Pitfall 11: Radix Select/Popover Inside Dialog Portal Layering

**What goes wrong:** Select dropdowns and Popover components rendered inside Dialogs may appear behind the Dialog overlay due to z-index stacking context issues.

**Why it happens:** Radix renders portals at document root. When a Select inside a Dialog opens its dropdown, the dropdown portal may render behind the Dialog's overlay. The current codebase uses Select components inside detail sheets (e.g., company select, contact select, status select in project-detail-sheet.tsx).

**Prevention:**
1. Ensure Select/Popover components use `portal` containers that are z-indexed above the Dialog
2. In shadcn, `SelectContent` already portals to the document body -- but verify z-index is above Dialog's `z-50`
3. Test dropdowns opening inside both Dialog and Sheet modes
4. For Combobox patterns (CompanySelect uses a custom dropdown), ensure the dropdown renders in a portal

**Detection:**
- Open project detail sheet in dialog mode
- Click company selector dropdown
- Verify dropdown appears above the dialog, not behind it

**Confidence:** MEDIUM -- common Radix portal issue, but shadcn defaults may already handle it. Needs runtime verification.

**Phase relevance:** Test when fixing scroll issues, since both involve Dialog internal rendering.

---

### Pitfall 12: Stale Data After Modal Save When Standalone Page Exists

**What goes wrong:** After editing an entity in a modal and saving, navigating to the standalone page shows stale server-rendered data because Next.js cached the server component.

**Why it happens:** Next.js App Router caches server components by default. The standalone page (`projects/[id]/page.tsx`) has `export const dynamic = 'force-dynamic'` which prevents caching, but if the user navigates via client-side `router.push()`, the Next.js client-side cache may serve stale data.

**Prevention:**
1. Call `router.refresh()` after saving data in modals (already done in `project-detail-page-client.tsx` line 39)
2. For new standalone pages, always include `export const dynamic = 'force-dynamic'`
3. Consider using `revalidatePath()` in API routes to invalidate caches
4. Use SWR or React Query for client-side data if real-time freshness is required

**Confidence:** MEDIUM -- `force-dynamic` is already used, but client-side navigation caching is subtle

**Phase relevance:** Consider when implementing new standalone entity pages.

---

## Phase-Specific Warnings

| Phase Topic | Likely Pitfall | Mitigation | Severity |
|---|---|---|---|
| Modal scroll fix | Pitfall 1 (ScrollArea height collapse) + Pitfall 9 (iOS bounce) | Remove `overflow-y-auto` from DialogContent, give ScrollArea explicit height, add `overscroll-behavior: contain` for mobile | Critical |
| Modal scroll fix | Pitfall 5 (AlertDialog focus trap) | Test nested AlertDialog flows after scroll changes | Moderate |
| Expand-to-page | Pitfall 2 (modal-on-page) + Pitfall 7 (data duplication) | Design shared content components before building standalone pages | Critical |
| Standalone entity pages | Pitfall 7 (duplicate data fetching) + Pitfall 12 (stale data) | Extract shared data layer and content components first | Moderate |
| Internal projects (companyId optional) | Pitfall 3 (26+ file cascade) | Full audit of companyId references, type-driven refactoring, phased testing | Critical |
| Sidebar customization | Pitfall 6 (lock-out) + Pitfall 10 (localStorage) | Enforce minimum visible items, provide reset option, use server-side storage | Moderate |
| Line item pricing | Pitfall 4 (amount ambiguity) | Keep `amount` as canonical total, add quantity/unitPrice as informational | Moderate |
| AI quantity extraction | Pitfall 8 (accuracy issues) | Cross-validation rules, default to lump sum, confidence-gated import | Moderate |
| Select/Popover in Dialog | Pitfall 11 (z-index layering) | Test dropdown rendering in both dialog and drawer modes | Minor |

---

## Recommended Phase Ordering Based on Pitfalls

1. **Phase A: Fix modal scrolling** (Pitfalls 1, 5, 9, 11) -- This is a blocking issue. Every subsequent feature adds content to modals. Fix the foundation first.

2. **Phase B: Establish standalone page pattern** (Pitfalls 2, 7) -- Design the shared content component pattern. Refactor project detail page as the template. This pattern is needed before creating any new CRM standalone pages.

3. **Phase C: Internal projects (companyId optional)** (Pitfall 3) -- High-impact schema change that touches 26+ files. Do this in isolation so regressions can be caught cleanly.

4. **Phase D: Line item pricing + AI extraction** (Pitfalls 4, 8) -- Schema change is additive (nullable fields), lower risk. AI extraction improvements can be validated independently.

5. **Phase E: Sidebar customization** (Pitfalls 6, 10) -- Lowest risk, self-contained feature. Benefits from all prior fixes being stable.

---

## Sources

### Radix Dialog/ScrollArea Issues
- [Radix ScrollArea max-height bug (Issue #2307)](https://github.com/radix-ui/primitives/issues/2307)
- [shadcn Dialog overflow (Issue #16)](https://github.com/shadcn-ui/ui/issues/16)
- [Radix Dialog/Popover scroll blocking (Issue #6988)](https://github.com/shadcn-ui/ui/issues/6988)
- [Radix Popover inside Dialog scroll issue (Issue #1159)](https://github.com/radix-ui/primitives/issues/1159)
- [shadcn ScrollArea with max-height (Issue #296)](https://github.com/shadcn-ui/ui/issues/296)
- [shadcn Dialog vertical scroll fix (PR #8103)](https://github.com/shadcn-ui/ui/pull/8103)
- [Radix ScrollArea viewport fixes (PR #2945)](https://github.com/radix-ui/primitives/pull/2945)

### Prisma Migration
- [Prisma referential actions documentation](https://www.prisma.io/docs/orm/prisma-schema/data-model/relations/referential-actions)
- [Prisma foreign key nullability drift (Discussion #19546)](https://github.com/prisma/prisma/discussions/19546)
- [Prisma customizing migrations](https://www.prisma.io/docs/orm/prisma-migrate/workflows/customizing-migrations)

### Invoice AI Extraction
- [Invoice OCR line items extraction - Mindee](https://www.mindee.com/blog/invoice-ocr-line-items-extraction)
- [Invoice OCR accuracy benchmark](https://research.aimultiple.com/invoice-ocr/)
- [Invoice extraction AI pipeline challenges](https://medium.com/@xaheer3scc/invoice-extraction-is-not-just-ocr-and-why-its-messy-and-needs-a-robust-ai-pipeline-eb9785d7796b)

### Sidebar UX
- [Best UX practices for sidebar design - UX Planet](https://uxplanet.org/best-ux-practices-for-designing-a-sidebar-9174ee0ecaa2)
- [Menu design checklist - Nielsen Norman Group](https://www.nngroup.com/articles/menu-design/)
- [Navigation UX patterns](https://userpilot.com/blog/navigation-ux/)
