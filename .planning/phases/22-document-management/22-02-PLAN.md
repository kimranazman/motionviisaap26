---
phase: 22-document-management
plan: 02
type: execute
wave: 2
depends_on: ["22-01"]
files_modified:
  - package.json
  - src/components/projects/document-upload-zone.tsx
  - src/components/projects/document-card.tsx
  - src/components/projects/document-list.tsx
  - src/components/projects/image-preview-dialog.tsx
autonomous: true

must_haves:
  truths:
    - "User can drag and drop files onto upload zone"
    - "User can click upload zone to open file picker"
    - "Upload zone shows progress bar for each file during upload"
    - "Upload zone shows error message for rejected files (wrong type or too large)"
    - "Document card shows filename, category badge, size, and date"
    - "Document card has preview, download, and delete action buttons"
    - "Image preview opens in modal dialog"
  artifacts:
    - path: "src/components/projects/document-upload-zone.tsx"
      provides: "Drag-drop upload component with progress tracking"
      min_lines: 100
    - path: "src/components/projects/document-card.tsx"
      provides: "Document list item with actions"
      min_lines: 80
    - path: "src/components/projects/document-list.tsx"
      provides: "Document list with category filter tabs"
      min_lines: 60
    - path: "src/components/projects/image-preview-dialog.tsx"
      provides: "Full-screen image preview modal"
      min_lines: 30
  key_links:
    - from: "src/components/projects/document-upload-zone.tsx"
      to: "/api/projects/{id}/documents"
      via: "XMLHttpRequest POST"
      pattern: "xhr\\.open.*POST"
    - from: "src/components/projects/document-card.tsx"
      to: "/api/files/{projectId}/{filename}"
      via: "window.open for preview/download"
      pattern: "window\\.open.*api/files"
    - from: "src/components/projects/document-card.tsx"
      to: "/api/projects/{id}/documents/{documentId}"
      via: "fetch DELETE"
      pattern: "fetch.*DELETE"
---

<objective>
Create document upload and display components with drag-drop, progress tracking, and image preview

Purpose: Build the frontend components for uploading documents and displaying them in a list with filtering
Output: Reusable document upload zone, document card, document list with filters, and image preview dialog
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/22-document-management/22-RESEARCH.md

# Phase 22 Plan 01 (API routes, utils)
@.planning/phases/22-document-management/22-01-PLAN.md

# Existing patterns
@src/components/projects/cost-card.tsx
@src/components/projects/project-detail-sheet.tsx
@src/lib/document-utils.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install react-dropzone</name>
  <files>package.json</files>
  <action>
Install react-dropzone for drag-and-drop file uploads:

```bash
npm install react-dropzone
```

This provides:
- Drag-and-drop zone with visual feedback
- Click-to-select fallback
- File type and size validation
- Keyboard accessibility
- Cross-browser support
  </action>
  <verify>
Run `npm ls react-dropzone` - should show installed version (^14.x)
  </verify>
  <done>react-dropzone installed and available for import</done>
</task>

<task type="auto">
  <name>Task 2: Create document upload zone component</name>
  <files>src/components/projects/document-upload-zone.tsx</files>
  <action>
Create the upload zone component using react-dropzone with XMLHttpRequest for progress tracking:

```typescript
'use client'

import { useCallback, useState } from 'react'
import { useDropzone, FileRejection } from 'react-dropzone'
import { Upload, AlertCircle, CheckCircle, X } from 'lucide-react'
import { Progress } from '@/components/ui/progress'
import { Button } from '@/components/ui/button'
import { cn } from '@/lib/utils'
import { MAX_FILE_SIZE, ALLOWED_MIME_TYPES, DOCUMENT_CATEGORIES, type DocumentCategory } from '@/lib/document-utils'
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from '@/components/ui/select'

interface FileWithProgress {
  file: File
  progress: number
  status: 'pending' | 'uploading' | 'complete' | 'error'
  error?: string
}

interface DocumentUploadZoneProps {
  projectId: string
  onUploadComplete: () => void
}

export function DocumentUploadZone({ projectId, onUploadComplete }: DocumentUploadZoneProps) {
  const [files, setFiles] = useState<FileWithProgress[]>([])
  const [defaultCategory, setDefaultCategory] = useState<DocumentCategory>('OTHER')

  const uploadFile = async (file: File, index: number) => {
    const formData = new FormData()
    formData.append('file', file)
    formData.append('category', defaultCategory)

    return new Promise<void>((resolve, reject) => {
      const xhr = new XMLHttpRequest()

      xhr.upload.onprogress = (event) => {
        if (event.lengthComputable) {
          const progress = Math.round((event.loaded / event.total) * 100)
          setFiles(prev => prev.map((f, i) =>
            i === index ? { ...f, progress, status: 'uploading' } : f
          ))
        }
      }

      xhr.onload = () => {
        if (xhr.status >= 200 && xhr.status < 300) {
          setFiles(prev => prev.map((f, i) =>
            i === index ? { ...f, progress: 100, status: 'complete' } : f
          ))
          resolve()
        } else {
          let errorMsg = 'Upload failed'
          try {
            const response = JSON.parse(xhr.responseText)
            errorMsg = response.error || errorMsg
          } catch {}
          setFiles(prev => prev.map((f, i) =>
            i === index ? { ...f, status: 'error', error: errorMsg } : f
          ))
          reject(new Error(errorMsg))
        }
      }

      xhr.onerror = () => {
        setFiles(prev => prev.map((f, i) =>
          i === index ? { ...f, status: 'error', error: 'Network error' } : f
        ))
        reject(new Error('Network error'))
      }

      xhr.open('POST', `/api/projects/${projectId}/documents`)
      xhr.send(formData)
    })
  }

  const onDrop = useCallback(async (acceptedFiles: File[]) => {
    if (acceptedFiles.length === 0) return

    // Add files to state with pending status
    const newFiles = acceptedFiles.map(file => ({
      file,
      progress: 0,
      status: 'pending' as const,
    }))

    const startIndex = files.length
    setFiles(prev => [...prev, ...newFiles])

    // Upload files sequentially (to avoid memory issues with large files)
    for (let i = 0; i < acceptedFiles.length; i++) {
      try {
        await uploadFile(acceptedFiles[i], startIndex + i)
      } catch (err) {
        console.error('Upload error:', err)
      }
    }

    onUploadComplete()
  }, [files.length, projectId, defaultCategory, onUploadComplete])

  const { getRootProps, getInputProps, isDragActive, fileRejections } = useDropzone({
    onDrop,
    accept: {
      'application/pdf': ['.pdf'],
      'image/png': ['.png'],
      'image/jpeg': ['.jpg', '.jpeg'],
    },
    maxSize: MAX_FILE_SIZE,
    multiple: true,
  })

  const clearCompleted = () => {
    setFiles(prev => prev.filter(f => f.status !== 'complete'))
  }

  const hasCompleted = files.some(f => f.status === 'complete')

  return (
    <div className="space-y-4">
      {/* Category selector */}
      <div className="flex items-center gap-2">
        <span className="text-sm text-muted-foreground">Upload as:</span>
        <Select value={defaultCategory} onValueChange={(v) => setDefaultCategory(v as DocumentCategory)}>
          <SelectTrigger className="w-[120px] h-9">
            <SelectValue />
          </SelectTrigger>
          <SelectContent>
            {DOCUMENT_CATEGORIES.map((cat) => (
              <SelectItem key={cat.value} value={cat.value}>
                {cat.label}
              </SelectItem>
            ))}
          </SelectContent>
        </Select>
      </div>

      {/* Drop zone */}
      <div
        {...getRootProps()}
        className={cn(
          'border-2 border-dashed rounded-lg p-6 text-center cursor-pointer transition-colors',
          'min-h-[120px] flex flex-col items-center justify-center',
          isDragActive ? 'border-blue-500 bg-blue-50' : 'border-gray-300 hover:border-gray-400'
        )}
      >
        <input {...getInputProps()} />
        <Upload className="h-8 w-8 text-gray-400 mb-2" />
        {isDragActive ? (
          <p className="text-blue-600 font-medium">Drop files here...</p>
        ) : (
          <>
            <p className="text-gray-600 font-medium">Drag & drop files here</p>
            <p className="text-sm text-gray-400 mt-1">or click to select files</p>
            <p className="text-xs text-gray-400 mt-2">PDF, PNG, JPG up to 10MB</p>
          </>
        )}
      </div>

      {/* File rejections (validation errors) */}
      {fileRejections.length > 0 && (
        <div className="text-sm text-red-500 space-y-1">
          {fileRejections.map(({ file, errors }: FileRejection) => (
            <div key={file.name} className="flex items-center gap-2">
              <AlertCircle className="h-4 w-4 shrink-0" />
              <span className="truncate">{file.name}: {errors.map(e => e.message).join(', ')}</span>
            </div>
          ))}
        </div>
      )}

      {/* Upload progress list */}
      {files.length > 0 && (
        <div className="space-y-2">
          <div className="flex items-center justify-between">
            <span className="text-sm text-muted-foreground">Uploads</span>
            {hasCompleted && (
              <Button variant="ghost" size="sm" onClick={clearCompleted}>
                Clear completed
              </Button>
            )}
          </div>
          {files.map((f, i) => (
            <div key={i} className="flex items-center gap-3 p-2 bg-gray-50 rounded">
              <div className="flex-1 min-w-0">
                <p className="text-sm font-medium truncate">{f.file.name}</p>
                {f.status === 'uploading' && (
                  <Progress value={f.progress} className="h-1 mt-1" />
                )}
                {f.status === 'error' && (
                  <p className="text-xs text-red-500 truncate">{f.error}</p>
                )}
              </div>
              {f.status === 'pending' && (
                <div className="h-5 w-5 border-2 border-gray-300 border-t-transparent rounded-full animate-spin shrink-0" />
              )}
              {f.status === 'uploading' && (
                <span className="text-xs text-muted-foreground shrink-0">{f.progress}%</span>
              )}
              {f.status === 'complete' && (
                <CheckCircle className="h-5 w-5 text-green-500 shrink-0" />
              )}
              {f.status === 'error' && (
                <X className="h-5 w-5 text-red-500 shrink-0" />
              )}
            </div>
          ))}
        </div>
      )}
    </div>
  )
}
```

Key features:
- Uses react-dropzone for drag-and-drop with validation
- XMLHttpRequest for upload progress tracking (fetch doesn't support this)
- Sequential uploads to avoid memory issues
- Category selection before upload (defaults to OTHER)
- Progress bar for each file
- Error display for rejected files
- Clear completed button
  </action>
  <verify>
Run `npx tsc --noEmit` - should pass without type errors
  </verify>
  <done>Document upload zone component created with drag-drop, progress tracking, and validation</done>
</task>

<task type="auto">
  <name>Task 3: Create document display components</name>
  <files>
src/components/projects/document-card.tsx
src/components/projects/document-list.tsx
src/components/projects/image-preview-dialog.tsx
  </files>
  <action>
Create the document card, list, and preview components.

**1. Create `src/components/projects/document-card.tsx`:**

```typescript
'use client'

import { useState } from 'react'
import { Button } from '@/components/ui/button'
import { Badge } from '@/components/ui/badge'
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from '@/components/ui/select'
import {
  AlertDialog,
  AlertDialogAction,
  AlertDialogCancel,
  AlertDialogContent,
  AlertDialogDescription,
  AlertDialogFooter,
  AlertDialogHeader,
  AlertDialogTitle,
  AlertDialogTrigger,
} from '@/components/ui/alert-dialog'
import { FileText, ImageIcon, Download, Trash2, Eye } from 'lucide-react'
import { formatDate } from '@/lib/utils'
import { formatFileSize, getCategoryColor, isPreviewable, DOCUMENT_CATEGORIES, type DocumentCategory } from '@/lib/document-utils'

interface Document {
  id: string
  filename: string
  storagePath: string
  mimeType: string
  size: number
  category: DocumentCategory
  createdAt: string
}

interface DocumentCardProps {
  document: Document
  projectId: string
  onPreview: (document: Document) => void
  onCategoryChange: (id: string, category: DocumentCategory) => void
  onDelete: () => void
}

export function DocumentCard({
  document,
  projectId,
  onPreview,
  onCategoryChange,
  onDelete,
}: DocumentCardProps) {
  const [isDeleting, setIsDeleting] = useState(false)
  const [isUpdating, setIsUpdating] = useState(false)
  const isImage = isPreviewable(document.mimeType)
  const Icon = isImage ? ImageIcon : FileText

  // Extract UUID filename from storagePath for file serving
  const storageFilename = document.storagePath.split('/').pop() || ''

  const handleDelete = async () => {
    setIsDeleting(true)
    try {
      const response = await fetch(
        `/api/projects/${projectId}/documents/${document.id}`,
        { method: 'DELETE' }
      )
      if (response.ok) {
        onDelete()
      }
    } catch (error) {
      console.error('Failed to delete document:', error)
    } finally {
      setIsDeleting(false)
    }
  }

  const handleCategoryChange = async (category: DocumentCategory) => {
    setIsUpdating(true)
    try {
      const response = await fetch(
        `/api/projects/${projectId}/documents/${document.id}`,
        {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ category }),
        }
      )
      if (response.ok) {
        onCategoryChange(document.id, category)
      }
    } catch (error) {
      console.error('Failed to update category:', error)
    } finally {
      setIsUpdating(false)
    }
  }

  const handleDownload = () => {
    // Use the file serving API route with storage filename
    window.open(`/api/files/${projectId}/${storageFilename}`, '_blank')
  }

  const handlePreview = () => {
    if (isImage) {
      onPreview(document)
    } else {
      // PDF opens in new tab
      window.open(`/api/files/${projectId}/${storageFilename}`, '_blank')
    }
  }

  return (
    <div className="flex items-center justify-between p-3 border rounded-lg bg-white hover:bg-gray-50">
      <div className="flex items-center gap-3 flex-1 min-w-0">
        <Icon className="h-8 w-8 text-gray-400 shrink-0" />
        <div className="min-w-0">
          <div className="flex items-center gap-2 flex-wrap">
            <span className="font-medium truncate">{document.filename}</span>
            <Badge variant="outline" className={getCategoryColor(document.category)}>
              {document.category}
            </Badge>
          </div>
          <div className="text-sm text-gray-500 mt-0.5">
            {formatFileSize(document.size)} - {formatDate(document.createdAt)}
          </div>
        </div>
      </div>

      <div className="flex items-center gap-1 ml-2 shrink-0">
        {/* Category select */}
        <Select
          value={document.category}
          onValueChange={handleCategoryChange}
          disabled={isUpdating}
        >
          <SelectTrigger className="w-[100px] h-10">
            <SelectValue />
          </SelectTrigger>
          <SelectContent>
            {DOCUMENT_CATEGORIES.map((cat) => (
              <SelectItem key={cat.value} value={cat.value}>
                {cat.label}
              </SelectItem>
            ))}
          </SelectContent>
        </Select>

        {/* Preview */}
        <Button
          variant="ghost"
          size="icon"
          className="h-10 w-10"
          onClick={handlePreview}
          title={isImage ? 'Preview' : 'Open PDF'}
        >
          <Eye className="h-4 w-4" />
        </Button>

        {/* Download */}
        <Button
          variant="ghost"
          size="icon"
          className="h-10 w-10"
          onClick={handleDownload}
          title="Download"
        >
          <Download className="h-4 w-4" />
        </Button>

        {/* Delete with confirmation */}
        <AlertDialog>
          <AlertDialogTrigger asChild>
            <Button
              variant="ghost"
              size="icon"
              className="h-10 w-10 text-red-600 hover:text-red-700 hover:bg-red-50"
              title="Delete"
            >
              <Trash2 className="h-4 w-4" />
            </Button>
          </AlertDialogTrigger>
          <AlertDialogContent>
            <AlertDialogHeader>
              <AlertDialogTitle>Delete Document</AlertDialogTitle>
              <AlertDialogDescription>
                Are you sure you want to delete &quot;{document.filename}&quot;? This action
                cannot be undone.
              </AlertDialogDescription>
            </AlertDialogHeader>
            <AlertDialogFooter>
              <AlertDialogCancel>Cancel</AlertDialogCancel>
              <AlertDialogAction
                onClick={handleDelete}
                disabled={isDeleting}
                className="bg-red-600 hover:bg-red-700"
              >
                {isDeleting ? 'Deleting...' : 'Delete'}
              </AlertDialogAction>
            </AlertDialogFooter>
          </AlertDialogContent>
        </AlertDialog>
      </div>
    </div>
  )
}
```

**2. Create `src/components/projects/document-list.tsx`:**

```typescript
'use client'

import { useState } from 'react'
import { DocumentCard } from './document-card'
import { cn } from '@/lib/utils'
import { type DocumentCategory } from '@/lib/document-utils'

interface Document {
  id: string
  filename: string
  storagePath: string
  mimeType: string
  size: number
  category: DocumentCategory
  createdAt: string
}

interface DocumentListProps {
  documents: Document[]
  projectId: string
  onPreview: (document: Document) => void
  onDocumentChange: () => void
}

const CATEGORY_TABS = [
  { id: 'ALL', label: 'All' },
  { id: 'RECEIPT', label: 'Receipt' },
  { id: 'INVOICE', label: 'Invoice' },
  { id: 'OTHER', label: 'Other' },
] as const

type FilterCategory = 'ALL' | DocumentCategory

export function DocumentList({
  documents,
  projectId,
  onPreview,
  onDocumentChange,
}: DocumentListProps) {
  const [selectedCategory, setSelectedCategory] = useState<FilterCategory>('ALL')

  const filteredDocuments = selectedCategory === 'ALL'
    ? documents
    : documents.filter(d => d.category === selectedCategory)

  const handleCategoryChange = (id: string, category: DocumentCategory) => {
    // Update will be reflected after onDocumentChange triggers refresh
    onDocumentChange()
  }

  return (
    <div className="space-y-3">
      {/* Filter tabs */}
      {documents.length > 0 && (
        <div className="flex items-center gap-1 p-1 bg-gray-100 rounded-lg overflow-x-auto">
          {CATEGORY_TABS.map((tab) => {
            const count = tab.id === 'ALL'
              ? documents.length
              : documents.filter(d => d.category === tab.id).length
            return (
              <button
                key={tab.id}
                onClick={() => setSelectedCategory(tab.id as FilterCategory)}
                className={cn(
                  'px-3 py-1.5 text-sm font-medium rounded-md transition-colors whitespace-nowrap',
                  selectedCategory === tab.id
                    ? 'bg-white text-gray-900 shadow-sm'
                    : 'text-gray-600 hover:text-gray-900'
                )}
              >
                {tab.label} ({count})
              </button>
            )
          })}
        </div>
      )}

      {/* Document list */}
      {filteredDocuments.length === 0 ? (
        <p className="text-sm text-muted-foreground text-center py-4">
          {documents.length === 0
            ? 'No documents yet'
            : 'No documents in this category'}
        </p>
      ) : (
        <div className="space-y-2">
          {filteredDocuments.map((doc) => (
            <DocumentCard
              key={doc.id}
              document={doc}
              projectId={projectId}
              onPreview={onPreview}
              onCategoryChange={handleCategoryChange}
              onDelete={onDocumentChange}
            />
          ))}
        </div>
      )}
    </div>
  )
}
```

**3. Create `src/components/projects/image-preview-dialog.tsx`:**

```typescript
'use client'

import {
  Dialog,
  DialogContent,
  DialogHeader,
  DialogTitle,
} from '@/components/ui/dialog'

interface Document {
  id: string
  filename: string
  storagePath: string
  mimeType: string
}

interface ImagePreviewDialogProps {
  document: Document | null
  projectId: string
  open: boolean
  onOpenChange: (open: boolean) => void
}

export function ImagePreviewDialog({
  document,
  projectId,
  open,
  onOpenChange,
}: ImagePreviewDialogProps) {
  if (!document) return null

  // Extract UUID filename from storagePath for file serving
  const storageFilename = document.storagePath.split('/').pop() || ''

  return (
    <Dialog open={open} onOpenChange={onOpenChange}>
      <DialogContent className="max-w-4xl p-0">
        <DialogHeader className="p-4 pb-0">
          <DialogTitle className="truncate pr-8">{document.filename}</DialogTitle>
        </DialogHeader>
        <div className="p-4 flex items-center justify-center bg-gray-100 min-h-[300px] max-h-[70vh] overflow-auto">
          {/* eslint-disable-next-line @next/next/no-img-element */}
          <img
            src={`/api/files/${projectId}/${storageFilename}`}
            alt={document.filename}
            className="max-w-full max-h-full object-contain"
          />
        </div>
      </DialogContent>
    </Dialog>
  )
}
```

Key patterns followed:
- DocumentCard follows CostCard pattern (same button sizes, delete confirmation)
- DocumentList follows ProjectList filter tab pattern
- All components use existing shadcn/ui components
- Mobile-friendly with 44px touch targets
  </action>
  <verify>
Run `npx tsc --noEmit` - should pass without type errors
Run `npm run build` - should pass without errors
  </verify>
  <done>
Document components created:
- DocumentCard with category select, preview, download, delete actions
- DocumentList with category filter tabs
- ImagePreviewDialog for full-screen image viewing
  </done>
</task>

</tasks>

<verification>
After all tasks complete:
1. `npm run build` passes
2. react-dropzone is installed
3. All components export correctly
4. TypeScript types are correct
</verification>

<success_criteria>
- react-dropzone installed in package.json
- DocumentUploadZone supports drag-drop and click-to-select
- DocumentUploadZone shows progress bar during upload via XMLHttpRequest
- DocumentUploadZone validates file type and size before upload
- DocumentCard displays document info with category badge
- DocumentCard has working preview (modal for images), download, and delete buttons
- DocumentList filters documents by category
- ImagePreviewDialog opens image in modal
</success_criteria>

<output>
After completion, create `.planning/phases/22-document-management/22-02-SUMMARY.md`
</output>
