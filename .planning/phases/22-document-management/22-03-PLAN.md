---
phase: 22-document-management
plan: 03
type: execute
wave: 3
depends_on: ["22-02"]
files_modified:
  - src/components/projects/project-detail-sheet.tsx
autonomous: false

must_haves:
  truths:
    - "ProjectDetailSheet has Documents section below Costs section"
    - "User can upload documents via drag-drop or file picker in Documents section"
    - "User can see list of documents with category filter"
    - "User can preview images in modal and PDFs in new tab"
    - "User can download and delete documents"
    - "User can set project start date and end date"
    - "Project start date auto-fills from source deal's stageChangedAt when deal was WON"
  artifacts:
    - path: "src/components/projects/project-detail-sheet.tsx"
      provides: "Updated sheet with Documents section and project date fields"
      contains: "DocumentUploadZone"
  key_links:
    - from: "src/components/projects/project-detail-sheet.tsx"
      to: "DocumentUploadZone"
      via: "import and render"
      pattern: "import.*DocumentUploadZone"
    - from: "src/components/projects/project-detail-sheet.tsx"
      to: "DocumentList"
      via: "import and render"
      pattern: "import.*DocumentList"
    - from: "src/components/projects/project-detail-sheet.tsx"
      to: "/api/projects/{id}/documents"
      via: "fetch for document list"
      pattern: "fetch.*documents"
---

<objective>
Integrate document management into ProjectDetailSheet and add project date fields

Purpose: Complete the document management feature by integrating upload and display components into the project detail view
Output: ProjectDetailSheet with working Documents section and project start/end date fields
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/22-document-management/22-RESEARCH.md

# Prior plans in this phase
@.planning/phases/22-document-management/22-01-PLAN.md
@.planning/phases/22-document-management/22-02-PLAN.md

# Main file to modify
@src/components/projects/project-detail-sheet.tsx

# Components to integrate
@src/components/projects/document-upload-zone.tsx
@src/components/projects/document-list.tsx
@src/components/projects/image-preview-dialog.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add project date fields to ProjectDetailSheet</name>
  <files>src/components/projects/project-detail-sheet.tsx</files>
  <action>
Add start date and end date picker fields to ProjectDetailSheet:

1. Add imports at top:
```typescript
import { Calendar } from '@/components/ui/calendar'
import { Popover, PopoverContent, PopoverTrigger } from '@/components/ui/popover'
import { CalendarIcon } from 'lucide-react'
import { format } from 'date-fns'
```

2. Add to Project interface:
```typescript
interface Project {
  // ... existing fields ...
  startDate: string | null
  endDate: string | null
  sourceDeal: { id: string; title: string; stageChangedAt?: string } | null
  // ... rest of interface ...
}
```

3. Add state variables after existing state:
```typescript
const [startDate, setStartDate] = useState<Date | null>(null)
const [endDate, setEndDate] = useState<Date | null>(null)
```

4. Update useEffect that initializes form (after setDescription):
```typescript
// Initialize dates
if (project.startDate) {
  setStartDate(new Date(project.startDate))
} else if (project.sourceDeal?.stageChangedAt) {
  // Auto-fill from deal won date if available
  setStartDate(new Date(project.sourceDeal.stageChangedAt))
} else {
  setStartDate(null)
}
setEndDate(project.endDate ? new Date(project.endDate) : null)
```

5. Update hasChanges to include dates:
```typescript
const hasChanges =
  // ... existing checks ...
  startDate?.toISOString().split('T')[0] !== (project.startDate ? new Date(project.startDate).toISOString().split('T')[0] : null) ||
  endDate?.toISOString().split('T')[0] !== (project.endDate ? new Date(project.endDate).toISOString().split('T')[0] : null)
```

6. Update handleSave to include dates in the body:
```typescript
body: JSON.stringify({
  // ... existing fields ...
  startDate: startDate ? startDate.toISOString() : null,
  endDate: endDate ? endDate.toISOString() : null,
}),
```

7. Add date pickers after the Description field (before the Source Info Separator):
```tsx
{/* Project Dates */}
<div className="grid grid-cols-2 gap-4">
  <div className="space-y-2">
    <Label>Start Date</Label>
    <Popover>
      <PopoverTrigger asChild>
        <Button
          type="button"
          variant="outline"
          className={cn(
            'w-full justify-start text-left font-normal h-11',
            !startDate && 'text-muted-foreground'
          )}
        >
          <CalendarIcon className="mr-2 h-4 w-4" />
          {startDate ? format(startDate, 'PP') : 'Pick date'}
        </Button>
      </PopoverTrigger>
      <PopoverContent className="w-auto p-0" align="start">
        <Calendar
          mode="single"
          selected={startDate || undefined}
          onSelect={(d) => setStartDate(d || null)}
          initialFocus
        />
      </PopoverContent>
    </Popover>
    {project.sourceDeal?.stageChangedAt && !project.startDate && (
      <p className="text-xs text-muted-foreground">
        Auto-filled from deal won date
      </p>
    )}
  </div>

  <div className="space-y-2">
    <Label>End Date</Label>
    <Popover>
      <PopoverTrigger asChild>
        <Button
          type="button"
          variant="outline"
          className={cn(
            'w-full justify-start text-left font-normal h-11',
            !endDate && 'text-muted-foreground'
          )}
        >
          <CalendarIcon className="mr-2 h-4 w-4" />
          {endDate ? format(endDate, 'PP') : 'Pick date'}
        </Button>
      </PopoverTrigger>
      <PopoverContent className="w-auto p-0" align="start">
        <Calendar
          mode="single"
          selected={endDate || undefined}
          onSelect={(d) => setEndDate(d || null)}
          initialFocus
        />
      </PopoverContent>
    </Popover>
  </div>
</div>
```
  </action>
  <verify>
Run `npx tsc --noEmit` - should pass without type errors
  </verify>
  <done>ProjectDetailSheet has start date and end date pickers, with auto-fill from deal won date</done>
</task>

<task type="auto">
  <name>Task 2: Add Documents section to ProjectDetailSheet</name>
  <files>src/components/projects/project-detail-sheet.tsx</files>
  <action>
Add the Documents section below the Costs section:

1. Add imports at top:
```typescript
import { DocumentUploadZone } from './document-upload-zone'
import { DocumentList } from './document-list'
import { ImagePreviewDialog } from './image-preview-dialog'
import { FileText } from 'lucide-react'
import { type DocumentCategory } from '@/lib/document-utils'
```

2. Add Document interface after Cost interface:
```typescript
interface Document {
  id: string
  filename: string
  storagePath: string
  mimeType: string
  size: number
  category: DocumentCategory
  createdAt: string
}
```

3. Add state variables for documents (after cost-related state):
```typescript
const [documents, setDocuments] = useState<Document[]>([])
const [showUploadZone, setShowUploadZone] = useState(false)
const [previewDocument, setPreviewDocument] = useState<Document | null>(null)
const [isPreviewOpen, setIsPreviewOpen] = useState(false)
```

4. Add useEffect to fetch documents when project changes (after the existing useEffect for project):
```typescript
// Fetch documents when project changes
useEffect(() => {
  const fetchDocuments = async () => {
    if (!project || !open) return
    try {
      const response = await fetch(`/api/projects/${project.id}/documents`)
      if (response.ok) {
        const data = await response.json()
        setDocuments(data)
      }
    } catch (error) {
      console.error('Failed to fetch documents:', error)
    }
  }
  fetchDocuments()
}, [project?.id, open])
```

5. Add document handlers (after cost handlers):
```typescript
// Document management handlers
const handleDocumentsRefresh = async () => {
  if (!project) return
  try {
    const response = await fetch(`/api/projects/${project.id}/documents`)
    if (response.ok) {
      const data = await response.json()
      setDocuments(data)
    }
  } catch (error) {
    console.error('Failed to refresh documents:', error)
  }
}

const handlePreviewDocument = (doc: Document) => {
  setPreviewDocument(doc)
  setIsPreviewOpen(true)
}
```

6. Reset document state in the main useEffect (after setCosts):
```typescript
setDocuments([])
setShowUploadZone(false)
setPreviewDocument(null)
setIsPreviewOpen(false)
```

7. Add Documents section after the Costs section (before the error message):
```tsx
<Separator />

{/* Documents Section */}
<div className="space-y-3">
  <div className="flex items-center justify-between">
    <div className="flex items-center gap-2">
      <Label className="text-muted-foreground">Documents</Label>
      {documents.length > 0 && (
        <Badge variant="secondary" className="text-xs">
          {documents.length}
        </Badge>
      )}
    </div>
    {documents.length > 0 && !showUploadZone && (
      <Button
        variant="ghost"
        size="sm"
        onClick={() => setShowUploadZone(true)}
      >
        <Plus className="mr-1 h-4 w-4" />
        Upload
      </Button>
    )}
  </div>

  {/* Upload Zone */}
  {showUploadZone && (
    <div className="space-y-2">
      <DocumentUploadZone
        projectId={project.id}
        onUploadComplete={handleDocumentsRefresh}
      />
      <Button
        variant="ghost"
        size="sm"
        onClick={() => setShowUploadZone(false)}
        className="w-full"
      >
        Hide upload zone
      </Button>
    </div>
  )}

  {/* Document List or Empty State */}
  {documents.length === 0 && !showUploadZone ? (
    <Card className="p-6 text-center">
      <FileText className="mx-auto h-8 w-8 text-gray-400 mb-2" />
      <p className="text-sm text-gray-500 mb-3">No documents attached yet</p>
      <Button
        variant="outline"
        size="sm"
        onClick={() => setShowUploadZone(true)}
      >
        <Plus className="mr-1 h-4 w-4" />
        Upload your first document
      </Button>
    </Card>
  ) : documents.length > 0 && (
    <DocumentList
      documents={documents}
      projectId={project.id}
      onPreview={handlePreviewDocument}
      onDocumentChange={handleDocumentsRefresh}
    />
  )}
</div>

{/* Image Preview Dialog */}
<ImagePreviewDialog
  document={previewDocument}
  projectId={project.id}
  open={isPreviewOpen}
  onOpenChange={setIsPreviewOpen}
/>
```

Important: Make sure the ImagePreviewDialog is placed inside the SheetContent but outside the ScrollArea, so it can render as a proper modal overlay.
  </action>
  <verify>
Run `npm run build` - should pass without errors
  </verify>
  <done>ProjectDetailSheet has working Documents section with upload zone, document list, and image preview</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete document management feature in ProjectDetailSheet</what-built>
  <how-to-verify>
1. Start dev server: `npm run dev`
2. Open http://localhost:3000 and sign in
3. Navigate to Projects page and open a project detail sheet
4. Verify Project Dates:
   - Start Date and End Date pickers appear below Description
   - If project was converted from a won deal, start date should auto-fill
   - Both dates can be changed and saved
5. Verify Documents section:
   - Documents section appears below Costs section
   - Empty state shows "Upload your first document" button
   - Click upload button to show drag-drop zone
   - Drag a file (PDF/PNG/JPG) onto zone - should show progress
   - Try uploading a file over 10MB or wrong type - should show error
   - Upload multiple files at once
   - Verify category can be selected before upload
6. Verify Document List:
   - Documents appear in list with filename, category badge, size, date
   - Category filter tabs work (All, Receipt, Invoice, Other)
   - Can change document category via dropdown
7. Verify Document Actions:
   - Preview button opens images in modal dialog
   - Preview button opens PDFs in new tab
   - Download button downloads the file
   - Delete button shows confirmation, then removes document
8. Mobile verification:
   - Open on mobile or narrow viewport
   - All buttons are at least 44px tall for touch
   - Upload zone works with file picker on mobile
  </how-to-verify>
  <resume-signal>Type "approved" or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
After all tasks complete:
1. `npm run build` passes
2. ProjectDetailSheet includes Documents section
3. Project date pickers work
4. File upload works with progress
5. Document list shows with category filter
6. Preview, download, delete actions work
7. Human verification confirms full feature works
</verification>

<success_criteria>
- Project start/end dates can be viewed and edited
- Start date auto-fills from deal won date when applicable
- Documents section visible in project detail sheet
- Can upload single and multiple files via drag-drop or picker
- Upload shows progress indicator
- Invalid files (wrong type/too large) show error
- Document list displays with category badges
- Category filter tabs filter the list
- Can change document category
- Images preview in modal
- PDFs open in new tab
- Download works
- Delete with confirmation works
- Mobile-friendly touch targets
</success_criteria>

<output>
After completion, create `.planning/phases/22-document-management/22-03-SUMMARY.md`
</output>
