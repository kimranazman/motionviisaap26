---
plan: 04-02
title: Auth Configuration and Route Handler
wave: 2
depends_on: ["04-01"]
files_modified:
  - src/auth.ts
  - src/auth.config.ts
  - src/types/next-auth.d.ts
  - src/app/api/auth/[...nextauth]/route.ts
autonomous: true
must_haves:
  truths:
    - "auth() function is exported from src/auth.ts"
    - "signIn callback validates @talenta.com.my domain"
    - "JWT includes user role"
    - "Session includes user role and id"
    - "TypeScript knows about session.user.role"
  artifacts:
    - path: "src/auth.ts"
      provides: "Main auth configuration with Prisma adapter"
      exports: ["auth", "signIn", "signOut", "handlers"]
    - path: "src/auth.config.ts"
      provides: "Edge-compatible auth config"
      exports: ["authConfig"]
    - path: "src/types/next-auth.d.ts"
      provides: "TypeScript augmentation for role in session"
      contains: "role: UserRole"
    - path: "src/app/api/auth/[...nextauth]/route.ts"
      provides: "Auth API route handler"
      exports: ["GET", "POST"]
  key_links:
    - from: "src/auth.ts"
      to: "src/lib/prisma.ts"
      via: "PrismaAdapter import"
      pattern: "PrismaAdapter\\(prisma\\)"
    - from: "src/app/api/auth/[...nextauth]/route.ts"
      to: "src/auth.ts"
      via: "handlers import"
      pattern: "from.*@/auth"
---

# Plan 04-02: Auth Configuration and Route Handler

## Objective
Create the core Auth.js v5 configuration with Google provider, domain restriction, role in session, and TypeScript types.

## Context
Auth.js v5 uses a root-level auth.ts that exports auth(), signIn(), signOut(), and handlers. The configuration must:
1. Use PrismaAdapter for database persistence
2. Use JWT session strategy (Edge middleware compatible)
3. Validate @talenta.com.my domain server-side in signIn callback (CRITICAL - hd parameter alone is not secure)
4. Include user role in JWT and session via callbacks
5. TypeScript declarations must be extended for role

From research (Pitfall #2): Domain restriction via hd parameter only is INSUFFICIENT. Must validate in signIn callback.
From research (Pitfall #4): Role won't be in session unless explicitly added via jwt/session callbacks.

## Tasks

<task id="1">
Create TypeScript declarations at `src/types/next-auth.d.ts`:

```typescript
import { UserRole } from "@prisma/client"
import "next-auth"
import "next-auth/jwt"

declare module "next-auth" {
  interface User {
    role: UserRole
  }

  interface Session {
    user: {
      id: string
      role: UserRole
      name?: string | null
      email?: string | null
      image?: string | null
    }
  }
}

declare module "next-auth/jwt" {
  interface JWT {
    id: string
    role: UserRole
  }
}
```

This enables `session.user.role` to be typed correctly throughout the app.
</task>

<task id="2">
Create edge-compatible config at `src/auth.config.ts`:

```typescript
import type { NextAuthConfig } from "next-auth"

export const authConfig = {
  pages: {
    signIn: "/login",
    error: "/login",
  },
  callbacks: {
    authorized({ auth, request: { nextUrl } }) {
      // This runs on Edge - used by middleware
      // For now, just check if user exists
      // More granular checks happen in auth.ts
      return true // Let middleware.ts handle redirection
    },
  },
  providers: [], // Providers configured in main auth.ts
} satisfies NextAuthConfig
```

This config is Edge-safe (no Prisma import) and will be used by middleware later (Phase 6).
</task>

<task id="3">
Create main auth configuration at `src/auth.ts`:

```typescript
import NextAuth from "next-auth"
import Google from "next-auth/providers/google"
import { PrismaAdapter } from "@auth/prisma-adapter"
import { prisma } from "@/lib/prisma"
import { authConfig } from "./auth.config"

export const { handlers, auth, signIn, signOut } = NextAuth({
  ...authConfig,
  adapter: PrismaAdapter(prisma),
  session: {
    strategy: "jwt", // Edge middleware compatible
    maxAge: 30 * 24 * 60 * 60, // 30 days
  },
  providers: [
    Google({
      clientId: process.env.AUTH_GOOGLE_ID!,
      clientSecret: process.env.AUTH_GOOGLE_SECRET!,
      authorization: {
        params: {
          hd: "talenta.com.my", // UI hint only - NOT security control
        },
      },
    }),
  ],
  callbacks: {
    async signIn({ account, profile }) {
      // CRITICAL: Server-side domain validation
      // hd parameter alone is NOT sufficient (Pitfall #2)
      if (account?.provider === "google") {
        return (
          profile?.email_verified === true &&
          (profile?.email?.endsWith("@talenta.com.my") ?? false)
        )
      }
      return false // Reject non-Google providers
    },
    async jwt({ token, user }) {
      // Add role and id to JWT when user signs in
      if (user) {
        token.id = user.id
        token.role = user.role
      }
      return token
    },
    async session({ session, token }) {
      // Add role and id to session from JWT
      if (session.user) {
        session.user.id = token.id
        session.user.role = token.role
      }
      return session
    },
  },
})
```

Key security points:
- signIn callback validates domain server-side (not just hd parameter)
- Checks email_verified is true
- JWT strategy for Edge compatibility
- Role flows from User -> JWT -> Session
</task>

<task id="4">
Create route handler at `src/app/api/auth/[...nextauth]/route.ts`:

```typescript
import { handlers } from "@/auth"

export const { GET, POST } = handlers
```

This exposes the Auth.js API routes at /api/auth/*.
</task>

## Verification

<verification>
<check>File exists: src/auth.ts with NextAuth export</check>
<check>File exists: src/auth.config.ts with authConfig export</check>
<check>File exists: src/types/next-auth.d.ts with UserRole declaration</check>
<check>File exists: src/app/api/auth/[...nextauth]/route.ts</check>
<check>Run `npx tsc --noEmit` - no TypeScript errors related to auth types</check>
</verification>

## must_haves
- auth() function exported from src/auth.ts
- signIn callback validates @talenta.com.my domain AND email_verified
- JWT callback adds role and id
- Session callback exposes role and id
- TypeScript augmentation allows session.user.role
- Route handler exposes GET and POST at /api/auth/*
