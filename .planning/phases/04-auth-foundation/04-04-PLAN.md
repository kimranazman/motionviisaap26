---
plan: 04-04
title: Environment Setup and End-to-End Verification
wave: 4
depends_on: ["04-03"]
files_modified:
  - .env.local
  - .env.example
autonomous: false
must_haves:
  truths:
    - "User can click Google sign-in and complete OAuth flow"
    - "User with @talenta.com.my email sees dashboard after sign-in"
    - "User without @talenta.com.my email sees Access Denied page"
    - "User session persists after browser refresh"
    - "User can sign out and return to login page"
  artifacts:
    - path: ".env.example"
      provides: "Environment variable documentation"
      contains: "AUTH_SECRET"
  key_links:
    - from: "src/auth.ts"
      to: ".env.local"
      via: "process.env.AUTH_GOOGLE_ID"
      pattern: "AUTH_GOOGLE"
---

# Plan 04-04: Environment Setup and End-to-End Verification

## Objective
Set up environment variables and verify the complete authentication flow works end-to-end.

## Context
This plan ensures all the pieces from previous plans work together. The user must have completed Google Cloud Console setup (OAuth credentials, consent screen) before this plan can be executed successfully.

Environment variables required:
- AUTH_SECRET - Encrypts JWT tokens
- AUTH_URL - Public URL for OAuth callbacks
- AUTH_GOOGLE_ID - Google OAuth client ID
- AUTH_GOOGLE_SECRET - Google OAuth client secret

## Tasks

<task id="1">
Create environment variable example file at `.env.example`:

```bash
# Auth.js Configuration
AUTH_SECRET="generate-with-npx-auth-secret"
AUTH_URL="http://localhost:3000"

# Google OAuth - Get from Google Cloud Console
AUTH_GOOGLE_ID="your-client-id.apps.googleusercontent.com"
AUTH_GOOGLE_SECRET="your-client-secret"

# Database (existing)
DATABASE_URL="mysql://user:password@localhost:3306/saap2026"
```

This documents required environment variables for other developers and deployment.
</task>

<task id="2">
Generate AUTH_SECRET and update .env.local:

```bash
npx auth secret
```

Copy the generated secret to .env.local. Also ensure AUTH_URL is set correctly:
- Development: `AUTH_URL=http://localhost:3000`
- Production: `AUTH_URL=https://saap.motionvii.com`

The user must provide AUTH_GOOGLE_ID and AUTH_GOOGLE_SECRET from Google Cloud Console.
</task>

<task id="3" type="checkpoint:human-verify" gate="blocking">
<what-built>Complete authentication flow with Google OAuth</what-built>
<how-to-verify>
Before testing, ensure you have:
1. Created OAuth 2.0 credentials in Google Cloud Console
2. Set OAuth consent screen to "Internal" (for @talenta.com.my only)
3. Added redirect URI: http://localhost:3000/api/auth/callback/google
4. Copied credentials to .env.local

Testing steps:
1. Start dev server: `npm run dev`
2. Visit http://localhost:3000/login
3. Verify: Branded login page with Google button
4. Click "Sign in with Google"
5. Sign in with @talenta.com.my account
6. Verify: Redirected to dashboard (/)
7. Refresh the page
8. Verify: Still logged in (session persists)
9. Sign out (if sign-out button exists, otherwise skip)
10. Test with non-@talenta.com.my account (use personal Gmail)
11. Verify: Redirected to /access-denied page

Expected results:
- [x] Login page shows with Talenta branding
- [x] Google OAuth flow completes successfully
- [x] @talenta.com.my user reaches dashboard
- [x] Session persists after refresh
- [x] Non-domain user sees Access Denied
</how-to-verify>
<resume-signal>Type "verified" if all checks pass, or describe any issues found</resume-signal>
</task>

## Verification

<verification>
<check>AUTH_SECRET is set and at least 32 characters</check>
<check>AUTH_GOOGLE_ID and AUTH_GOOGLE_SECRET are set</check>
<check>AUTH_URL matches development/production environment</check>
<check>OAuth flow completes without errors</check>
<check>Domain restriction works (non-talenta.com.my rejected)</check>
<check>Session persists across browser refresh</check>
</verification>

## must_haves
- Environment variables documented in .env.example
- Complete OAuth flow works for @talenta.com.my users
- Access denied for non-domain users
- Session persistence verified
- Phase 4 success criteria 1-5 all passing
