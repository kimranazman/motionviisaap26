---
plan: 04-01
title: Dependencies and Database Schema
wave: 1
depends_on: []
files_modified:
  - package.json
  - prisma/schema.prisma
autonomous: true
must_haves:
  truths:
    - "next-auth@5.0.0-beta.30 is installed"
    - "@auth/prisma-adapter@2.11.1 is installed"
    - "User, Account, Session, VerificationToken tables exist in database"
    - "UserRole enum exists with ADMIN, EDITOR, VIEWER values"
  artifacts:
    - path: "package.json"
      provides: "Auth packages"
      contains: "next-auth"
    - path: "prisma/schema.prisma"
      provides: "Auth models"
      contains: "model User"
  key_links:
    - from: "prisma/schema.prisma"
      to: "database"
      via: "prisma db push"
      pattern: "model User"
---

# Plan 04-01: Dependencies and Database Schema

## Objective
Install authentication packages and add Auth.js-required models to the Prisma schema.

## Context
This plan establishes the foundation for authentication. Auth.js v5 requires specific database tables (User, Account, Session, VerificationToken) to function with the Prisma adapter. We're using:
- `next-auth@5.0.0-beta.30` - Native App Router support, universal auth() function
- `@auth/prisma-adapter@2.11.1` - Compatible with Prisma 6.x
- JWT session strategy - Edge middleware compatible

The existing schema already uses `mysql` provider (which is correct for MariaDB) and has the singleton prisma.ts pattern (no changes needed there).

## Tasks

<task id="1">
Install authentication packages:

```bash
npm install next-auth@5.0.0-beta.30 @auth/prisma-adapter@2.11.1
```

Verify installation by checking package.json contains both packages with correct versions.
</task>

<task id="2">
Add Auth.js models to prisma/schema.prisma. Add these models AFTER the existing models (Initiative, Comment, Event, EventToAttend):

```prisma
// ============================================================
// Auth.js Models
// ============================================================

enum UserRole {
  ADMIN
  EDITOR
  VIEWER
}

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String?   @unique
  emailVerified DateTime? @map("email_verified")
  image         String?
  role          UserRole  @default(VIEWER)

  accounts      Account[]
  sessions      Session[]

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@map("users")
}

model Account {
  id                String  @id @default(cuid())
  userId            String  @map("user_id")
  type              String
  provider          String
  providerAccountId String  @map("provider_account_id")
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique @map("session_token")
  userId       String   @map("user_id")
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}
```

Key points:
- Use `@db.Text` for token fields (can exceed VARCHAR limit)
- Use `@map()` for snake_case column names (Auth.js convention)
- Use `@@map()` for table names
- User.role defaults to VIEWER
</task>

<task id="3">
Push schema changes to the database:

```bash
npx prisma db push
```

Then regenerate the Prisma client:

```bash
npx prisma generate
```

Verify tables were created by running:

```bash
npx prisma db pull --print | grep -E "(users|accounts|sessions|verification_tokens)"
```
</task>

## Verification

<verification>
<check>Run `npm list next-auth` - should show 5.0.0-beta.30</check>
<check>Run `npm list @auth/prisma-adapter` - should show 2.11.1</check>
<check>Run `npx prisma db pull --print` - should show User, Account, Session, VerificationToken models</check>
<check>Run `npx prisma generate` - should complete without errors</check>
</verification>

## must_haves
- next-auth@5.0.0-beta.30 installed
- @auth/prisma-adapter@2.11.1 installed
- UserRole enum exists (ADMIN, EDITOR, VIEWER)
- User model exists with role field
- Account, Session, VerificationToken models exist
- Database tables created via prisma db push
