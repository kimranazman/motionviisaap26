---
phase: 48-api-layer-utilities
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/app/api/key-results/route.ts
  - src/app/api/key-results/[id]/route.ts
  - src/app/api/support-tasks/route.ts
autonomous: true

must_haves:
  truths:
    - "GET /api/key-results returns all 6 KRs with initiative counts, Decimal fields serialized to Number"
    - "GET /api/key-results/[id] returns a single KR with its initiatives and linked support tasks"
    - "PATCH /api/key-results/[id] can update actual, progress, and status fields"
    - "GET /api/support-tasks returns all 30 tasks with KR relations"
    - "GET /api/support-tasks?category=DESIGN_CREATIVE filters to only that category"
  artifacts:
    - path: "src/app/api/key-results/route.ts"
      provides: "KeyResult list endpoint with initiative counts"
      exports: ["GET"]
    - path: "src/app/api/key-results/[id]/route.ts"
      provides: "KeyResult detail and update endpoint"
      exports: ["GET", "PATCH"]
    - path: "src/app/api/support-tasks/route.ts"
      provides: "SupportTask list endpoint with category filter"
      exports: ["GET"]
  key_links:
    - from: "src/app/api/key-results/route.ts"
      to: "prisma.keyResult"
      via: "findMany with _count include"
      pattern: "prisma\\.keyResult\\.findMany"
    - from: "src/app/api/key-results/[id]/route.ts"
      to: "prisma.keyResult"
      via: "findUnique with initiatives + supportTaskLinks includes"
      pattern: "prisma\\.keyResult\\.(findUnique|update)"
    - from: "src/app/api/support-tasks/route.ts"
      to: "prisma.supportTask"
      via: "findMany with keyResultLinks include and category filter"
      pattern: "prisma\\.supportTask\\.findMany"
---

<objective>
Create new CRUD API routes for KeyResult and SupportTask models.

Purpose: Phases 49-51 (OKR UI, Support Tasks UI, Revenue Widget) all depend on these endpoints to fetch and update data. This plan creates the net-new API routes.
Output: 3 new route files following established codebase patterns (auth guards, Prisma includes, Decimal serialization).
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/48-api-layer-utilities/48-RESEARCH.md

Reference patterns:
@src/app/api/suppliers/route.ts (list endpoint pattern with _count)
@src/app/api/suppliers/[id]/route.ts (detail endpoint pattern with params)
@src/lib/auth-utils.ts (requireAuth, requireEditor helpers)
@prisma/schema.prisma (KeyResult, SupportTask, SupportTaskKeyResult models)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create KeyResult API routes</name>
  <files>
    src/app/api/key-results/route.ts
    src/app/api/key-results/[id]/route.ts
  </files>
  <action>
Create two new route files following the exact patterns from src/app/api/suppliers/.

**GET /api/key-results (route.ts):**
- Import NextRequest, NextResponse, prisma, requireAuth
- Auth guard with requireAuth()
- Query: `prisma.keyResult.findMany({ include: { _count: { select: { initiatives: true } } }, orderBy: [{ objective: 'asc' }, { krId: 'asc' }] })`
- Serialize ALL Decimal fields: target, actual, progress, weight (use `Number()` on each)
- Return serialized array
- Wrap in try/catch with console.error + 500 response

**GET /api/key-results/[id] (route.ts):**
- Params: `{ params }: { params: Promise<{ id: string }> }` (Next.js 15 pattern -- params is a Promise, must await)
- Auth guard with requireAuth()
- Query: `prisma.keyResult.findUnique({ where: { id: parseInt(id) } })` -- KeyResult.id is Int autoincrement, parse the string param to int
- Include: `initiatives` (select: id, sequenceNumber, title, status, department, personInCharge, startDate, endDate, budget, resources; orderBy: sequenceNumber asc)
- Include: `supportTaskLinks` with nested include `supportTask` (select: id, taskId, task, category, owner)
- If not found, return 404 `{ error: 'Key result not found' }`
- Serialize Decimal fields on the KR (target, actual, progress, weight)
- Serialize initiative dates with `.toISOString()`
- Flatten supportTaskLinks to return `supportTasks` array (map each link to `link.supportTask`)

**PATCH /api/key-results/[id] (route.ts):**
- Same file as GET [id]
- Auth guard with requireEditor() (write operation)
- Parse body with `request.json()`
- Build updateData object: only include fields that are present in body (actual, progress, status)
- For actual/progress: `parseFloat(String(body.actual))` for Decimal conversion
- Update: `prisma.keyResult.update({ where: { id: parseInt(id) }, data: updateData })`
- Serialize Decimal fields in response
- Wrap in try/catch
  </action>
  <verify>
Run `npx tsc --noEmit` to confirm no TypeScript errors. Then verify with curl:
- `curl http://localhost:3000/api/key-results` returns 6 KRs with numeric target/actual/progress/weight and _count.initiatives
- `curl http://localhost:3000/api/key-results/1` returns single KR with initiatives array and supportTasks array
  </verify>
  <done>
GET /api/key-results returns 6 serialized KeyResult objects with initiative counts. GET /api/key-results/[id] returns a single KR with initiatives and support tasks. PATCH /api/key-results/[id] updates actual/progress/status.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create SupportTask API route</name>
  <files>
    src/app/api/support-tasks/route.ts
  </files>
  <action>
Create a new route file for listing support tasks.

**GET /api/support-tasks (route.ts):**
- Import NextRequest, NextResponse, prisma, requireAuth, Prisma, SupportTaskCategory from @prisma/client
- Auth guard with requireAuth()
- Parse optional `category` query param from `request.nextUrl.searchParams.get('category')`
- Build where clause: if category is provided, filter `{ category: category as SupportTaskCategory }`
- Query: `prisma.supportTask.findMany({ where, include: { keyResultLinks: { include: { keyResult: { select: { id: true, krId: true, description: true } } } } }, orderBy: [{ category: 'asc' }, { taskId: 'asc' }] })`
- Return the tasks array as JSON (SupportTask has no Decimal fields, so no serialization needed)
- Wrap in try/catch with console.error + 500 response

Note: The relation field in the schema is called `keyResultLinks` (not `keyResultLinks` vs `supportTaskLinks` -- check schema.prisma for the exact field name on SupportTask model). The SupportTaskKeyResult model has `supportTask` and `keyResult` relation fields. On SupportTask, the back-relation to SupportTaskKeyResult should be named based on what's in the schema. Verify by reading the SupportTask model in schema.prisma.
  </action>
  <verify>
Run `npx tsc --noEmit` to confirm no TypeScript errors. Then verify with curl:
- `curl http://localhost:3000/api/support-tasks` returns 30 tasks with keyResultLinks
- `curl http://localhost:3000/api/support-tasks?category=DESIGN_CREATIVE` returns only tasks in that category
  </verify>
  <done>
GET /api/support-tasks returns all 30 support tasks with KR relations. Filtering by category query param returns only tasks in that category.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with no errors in the new files
2. All 3 new route files exist and export the correct HTTP methods
3. KeyResult list returns 6 records with numeric Decimal fields and initiative counts
4. KeyResult detail includes initiatives and support tasks
5. SupportTask list returns 30 records; category filter works
</verification>

<success_criteria>
- GET /api/key-results returns 6 KRs with initiative counts
- GET /api/key-results/[id] returns single KR with initiatives and support tasks
- PATCH /api/key-results/[id] updates actual, progress, status
- GET /api/support-tasks returns 30 tasks with KR links
- GET /api/support-tasks?category=X filters correctly
</success_criteria>

<output>
After completion, create `.planning/phases/48-api-layer-utilities/48-01-SUMMARY.md`
</output>
