---
phase: 48-api-layer-utilities
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/app/api/initiatives/route.ts
  - src/app/api/initiatives/[id]/route.ts
  - src/app/api/initiatives/search/route.ts
  - src/app/api/initiatives/export/route.ts
  - src/lib/initiative-export-utils.ts
autonomous: true

must_haves:
  truths:
    - "Initiative POST/PUT uses keyResultId FK instead of keyResult string"
    - "Initiative PATCH no longer handles KPI fields (kpiLabel, kpiTarget, kpiActual, kpiUnit, kpiManualOverride)"
    - "Initiative GET detail no longer serializes removed kpiTarget/kpiActual fields"
    - "Initiative search no longer references monthlyObjective or weeklyTasks"
    - "Initiative export no longer selects removed fields and does not crash"
  artifacts:
    - path: "src/app/api/initiatives/route.ts"
      provides: "Updated initiative list/create with keyResultId FK"
    - path: "src/app/api/initiatives/[id]/route.ts"
      provides: "Updated initiative detail/update/patch without KPI fields"
    - path: "src/app/api/initiatives/search/route.ts"
      provides: "Updated search without monthlyObjective/weeklyTasks"
    - path: "src/app/api/initiatives/export/route.ts"
      provides: "Updated export without removed field selects"
    - path: "src/lib/initiative-export-utils.ts"
      provides: "Updated export utils without KPI imports/fields"
  key_links:
    - from: "src/app/api/initiatives/route.ts"
      to: "prisma.initiative.create"
      via: "keyResultId field in create data"
      pattern: "keyResultId.*body\\.keyResultId"
    - from: "src/app/api/initiatives/[id]/route.ts"
      to: "prisma.initiative.update"
      via: "keyResultId in update data, no KPI fields"
      pattern: "keyResultId"
    - from: "src/app/api/initiatives/export/route.ts"
      to: "initiative-export-utils.ts"
      via: "mapInitiativeToExportRow import"
      pattern: "mapInitiativeToExportRow"
---

<objective>
Update all existing initiative API routes to remove references to deleted schema fields (kpiLabel, kpiTarget, kpiActual, kpiUnit, kpiManualOverride, monthlyObjective, weeklyTasks, keyResult-as-string) and use the new keyResultId FK.

Purpose: Phase 46 removed KPI fields and the keyResult string from the Initiative model. The existing API routes still reference these removed fields, which causes Prisma runtime errors. This plan makes the initiative endpoints functional again with the v2.0 schema.
Output: 5 updated files (4 route files + 1 export utility) that compile and work with the current schema.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/48-api-layer-utilities/48-RESEARCH.md

Files to modify:
@src/app/api/initiatives/route.ts
@src/app/api/initiatives/[id]/route.ts
@src/app/api/initiatives/search/route.ts
@src/app/api/initiatives/export/route.ts
@src/lib/initiative-export-utils.ts
@prisma/schema.prisma (reference for current Initiative fields)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix initiative list, create, detail, update, and search routes</name>
  <files>
    src/app/api/initiatives/route.ts
    src/app/api/initiatives/[id]/route.ts
    src/app/api/initiatives/search/route.ts
  </files>
  <action>
**src/app/api/initiatives/route.ts:**

GET handler changes:
- Lines 37-43 (search OR conditions): Remove `{ monthlyObjective: { contains: search } }` and `{ weeklyTasks: { contains: search } }`. Keep only `title` and `remarks` search.
- Add `include: { keyResult: { select: { id: true, krId: true, description: true } } }` to the findMany query so the response includes the linked KeyResult info.

POST handler changes:
- Line 79: Replace `keyResult: body.keyResult` with `keyResultId: body.keyResultId ? parseInt(body.keyResultId) : null` (FK is Int, parse from body)
- Lines 82-83: Remove `monthlyObjective: body.monthlyObjective || null` and `weeklyTasks: body.weeklyTasks || null` -- these fields no longer exist on Initiative
- Add `budget: body.budget || null` and `resources: body.resources || null` to the create data (new v2.0 fields)

**src/app/api/initiatives/[id]/route.ts:**

GET handler changes:
- Lines 69-70: Remove `kpiTarget: initiative.kpiTarget ? Number(initiative.kpiTarget) : null` and `kpiActual: initiative.kpiActual ? Number(initiative.kpiActual) : null` -- these fields no longer exist
- Add `keyResult: true` to the include (alongside comments and projects) so the response includes the linked KeyResult

PUT handler changes:
- Line 98: Replace `keyResult: body.keyResult` with `keyResultId: body.keyResultId ? parseInt(body.keyResultId) : undefined` (FK, only update if provided)
- Lines 101-102: Remove `monthlyObjective: body.monthlyObjective || null` and `weeklyTasks: body.weeklyTasks || null`
- Add `budget: body.budget !== undefined ? body.budget : undefined` and `resources: body.resources !== undefined ? body.resources : undefined`

PATCH handler changes:
- Lines 154-173: Remove the ENTIRE KPI fields block (kpiLabel, kpiTarget, kpiActual, kpiUnit, kpiManualOverride handling). These fields no longer exist on Initiative.

DELETE handler: No changes needed.

**src/app/api/initiatives/search/route.ts:**

- Lines 26-27: Remove `{ monthlyObjective: { contains: searchTerm } }` and `{ weeklyTasks: { contains: searchTerm } }` from the OR conditions. Keep `title` and `remarks` search conditions.
  </action>
  <verify>
Run `npx tsc --noEmit` -- zero errors related to these files. Verify:
- `curl http://localhost:3000/api/initiatives` returns initiatives without kpi/monthlyObjective/weeklyTasks fields, with keyResult relation included
- `curl http://localhost:3000/api/initiatives/search?q=test` does not crash
  </verify>
  <done>
Initiative list/create uses keyResultId FK. Initiative detail no longer serializes KPI Decimals. Initiative update uses keyResultId FK with budget/resources. Initiative PATCH has no KPI field handling. Initiative search only searches title and remarks.
  </done>
</task>

<task type="auto">
  <name>Task 2: Fix initiative export route and export utilities</name>
  <files>
    src/app/api/initiatives/export/route.ts
    src/lib/initiative-export-utils.ts
  </files>
  <action>
**src/app/api/initiatives/export/route.ts:**

- Line 19 orderBy: Replace `{ keyResult: 'asc' }` with `{ keyResultId: 'asc' }` (keyResult is now a relation, not a sortable string field)
- Lines 27-41 select: Remove ALL of these fields from select: `keyResult` (string, no longer exists), `kpiLabel`, `kpiTarget`, `kpiActual`, `kpiUnit`, `kpiManualOverride`, `monthlyObjective`, `weeklyTasks`
- Add to select: `keyResult: { select: { krId: true, description: true } }` (include the relation for display), `budget: true`, `resources: true`, `accountable: true`
- Keep: sequenceNumber, title, objective, department, status, personInCharge, startDate, endDate, remarks, projects

**src/lib/initiative-export-utils.ts:**

- Remove the import of `calculateKpi` from `@/lib/initiative-kpi-utils` (line 11)
- Update `InitiativeForExport` interface:
  - Remove: `keyResult: string`, `kpiLabel`, `kpiTarget`, `kpiActual`, `kpiUnit`, `kpiManualOverride`, `monthlyObjective`, `weeklyTasks`
  - Add: `keyResult: { krId: string; description: string } | null`, `budget: string | null`, `resources: string | null`, `accountable: string | null`
- Update `EXPORT_COLUMNS` array:
  - Change 'Key Result' column: keep it (will now show krId from the relation)
  - Remove columns: `kpiLabel`, `kpiTarget`, `kpiActual`, `achievement` (% Achievement), `monthlyObjective`, `weeklyTasks`
  - Add columns: `{ key: 'budget', header: 'Budget', wch: 16 }`, `{ key: 'resources', header: 'Resources', wch: 20 }`, `{ key: 'accountable', header: 'Accountable', wch: 14 }`
- Update `mapInitiativeToExportRow`:
  - Remove: KPI calculation block (calculateKpi call + kpi result usage), 'KPI Label', 'KPI Target', 'KPI Actual', '% Achievement' row values, 'Monthly Objective', 'Weekly Tasks' row values
  - Change 'Key Result' value: `initiative.keyResult?.krId || '-'` (from the included relation)
  - Add: `'Budget': initiative.budget || '-'`, `'Resources': initiative.resources || '-'`, `'Accountable': initiative.accountable || '-'`
  </action>
  <verify>
Run `npx tsc --noEmit` -- zero errors in export files. The export route should no longer reference any removed fields. Verify the import of calculateKpi is gone from initiative-export-utils.ts.
  </verify>
  <done>
Export route selects only existing fields plus the keyResult relation. Export utility no longer imports from initiative-kpi-utils.ts. Export columns updated: KPI and monthly/weekly columns removed, budget/resources/accountable added.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with no errors in any of the 5 modified files
2. Initiative list/create/update/search routes do not reference monthlyObjective, weeklyTasks, kpiLabel, kpiTarget, kpiActual, kpiUnit, kpiManualOverride, or keyResult-as-string
3. Initiative POST/PUT use keyResultId (Int FK) instead of keyResult (string)
4. Initiative export does not crash and produces an XLSX with updated columns
</verification>

<success_criteria>
- All 4 initiative route files compile and run without Prisma errors from removed fields
- POST/PUT send keyResultId FK instead of keyResult string
- PATCH handler simplified (no KPI fields)
- Export produces valid XLSX with budget/resources/accountable columns, no KPI columns
- Search only searches title and remarks
</success_criteria>

<output>
After completion, create `.planning/phases/48-api-layer-utilities/48-02-SUMMARY.md`
</output>
