# Plan 58-01: Dashboard Breakpoint Layout Persistence

## Frontmatter
- **Phase**: 58
- **Plan**: 58-01
- **Wave**: 1
- **Depends on**: None
- **Files modified**:
  - `src/types/dashboard.ts`
  - `src/components/dashboard/dashboard-grid.tsx`
  - `src/components/dashboard/dashboard-client.tsx`
  - `src/lib/hooks/use-dashboard-layout.ts`
  - `src/app/api/user/preferences/route.ts`
- **Autonomous**: true
- **Requirement**: BUG-04

## Goal
Saving dashboard layout on mobile does not overwrite the desktop layout. Each breakpoint persists independently.

## Context
Currently the dashboard stores a single layout array and passes it to all breakpoints. When react-grid-layout adjusts widget positions for a smaller screen, the `onLayoutChange` callback fires with the mobile-adjusted layout, which overwrites the desktop layout in the database. The fix requires storing layouts per breakpoint.

## Tasks

<task id="1">
Update `src/types/dashboard.ts` to add a `ResponsiveLayouts` type:

```typescript
export interface ResponsiveLayouts {
  lg?: WidgetConfig[];
  md?: WidgetConfig[];
  sm?: WidgetConfig[];
  xs?: WidgetConfig[];
  xxs?: WidgetConfig[];
}

export interface DashboardLayout {
  widgets: WidgetConfig[];
  breakpoints?: ResponsiveLayouts;
}
```

Keep `widgets` for backward compatibility. The new `breakpoints` field stores per-breakpoint layouts. When `breakpoints` is present, it takes priority over `widgets`.
</task>

<task id="2">
Update `src/components/dashboard/dashboard-grid.tsx`:

1. Change the `onLayoutChange` callback type to accept responsive layouts:
   ```typescript
   onLayoutChange: (layout: LayoutWidgetConfig[], allLayouts: Record<string, LayoutWidgetConfig[]>) => void;
   ```

2. Use the **two-argument** form of `onLayoutChange` from `ResponsiveGridLayout`:
   ```typescript
   import type { Layout, Layouts } from 'react-grid-layout/legacy';
   ```

3. Change `handleLayoutChange` to accept `(currentLayout: Layout, allLayouts: Layouts)`:
   - Convert each breakpoint's layout from grid format to our format using `convertFromGridLayout`
   - Call `onLayoutChange(updatedCurrentLayout, convertedAllLayouts)`

4. For the `layouts` prop, accept an optional `responsiveLayouts` prop:
   ```typescript
   interface DashboardGridProps {
     layout: LayoutWidgetConfig[];
     responsiveLayouts?: Record<string, LayoutWidgetConfig[]>;
     onLayoutChange: (layout: LayoutWidgetConfig[], allLayouts: Record<string, LayoutWidgetConfig[]>) => void;
     ...
   }
   ```
   When `responsiveLayouts` is provided, convert each breakpoint to grid format and pass to `layouts`. Otherwise fall back to passing `gridLayout` to all breakpoints (current behavior).
</task>

<task id="3">
Update `src/lib/hooks/use-dashboard-layout.ts`:

1. Add `responsiveLayouts` to state:
   ```typescript
   interface LayoutState {
     current: LayoutWidgetConfig[];
     responsiveLayouts: Record<string, LayoutWidgetConfig[]>;
     history: LayoutWidgetConfig[][];
     historyIndex: number;
   }
   ```

2. Accept `initialResponsiveLayouts` parameter:
   ```typescript
   export function useDashboardLayout(
     initialLayout: LayoutWidgetConfig[],
     initialResponsiveLayouts?: Record<string, LayoutWidgetConfig[]>
   )
   ```

3. Add `updateResponsiveLayouts` callback that stores all breakpoint layouts:
   ```typescript
   const updateResponsiveLayouts = useCallback((
     currentLayout: LayoutWidgetConfig[],
     allLayouts: Record<string, LayoutWidgetConfig[]>
   ) => { ... })
   ```

4. Return `responsiveLayouts` and `updateResponsiveLayouts` from the hook.

5. When `addWidget` or `removeWidget` is called, also update the responsive layouts by adding/removing the widget from each breakpoint.
</task>

<task id="4">
Update `src/components/dashboard/dashboard-client.tsx`:

1. Accept `initialResponsiveLayouts` prop (optional):
   ```typescript
   interface DashboardClientProps {
     initialLayout: LayoutWidgetConfig[];
     initialResponsiveLayouts?: Record<string, LayoutWidgetConfig[]>;
     ...
   }
   ```

2. Pass `initialResponsiveLayouts` to `useDashboardLayout`.

3. In the auto-save effect, save both `widgets` (current layout for backward compat) and `breakpoints` (responsive layouts):
   ```typescript
   body: JSON.stringify({
     dashboardLayout: {
       widgets: debouncedLayout,
       breakpoints: responsiveLayouts,
     },
   })
   ```

4. Pass `responsiveLayouts` to `DashboardGrid` as `responsiveLayouts` prop.

5. Wire up `updateResponsiveLayouts` to `DashboardGrid`'s `onLayoutChange`.
</task>

<task id="5">
Update the dashboard page server component to pass `initialResponsiveLayouts` when loading saved preferences. Read from `src/app/(dashboard)/page.tsx` (or wherever the dashboard page is) and check if the saved `dashboardLayout` has a `breakpoints` field. If so, pass it to `DashboardClient`. Add `LayoutWidgetConfig`'s `i` field (instance ID) to each breakpoint layout item if missing.

Find the dashboard page:
```bash
grep -r "DashboardClient" src/app/ --include="*.tsx" -l
```
</task>

## Verification
1. Open dashboard on desktop (lg breakpoint), rearrange widgets, verify layout saves
2. Open dashboard on mobile (xs breakpoint), rearrange widgets, verify layout saves
3. Return to desktop — desktop layout should be preserved (not overwritten by mobile)
4. Fresh load on desktop — desktop layout loads correctly
5. Fresh load on mobile — mobile layout loads correctly

## must_haves
- [ ] Dashboard stores layouts per breakpoint (lg, md, sm, xs, xxs)
- [ ] Saving layout on mobile does not overwrite desktop layout
- [ ] Existing single-array layouts still work (backward compatibility)
- [ ] Dashboard renders correctly on all breakpoints after changes
