---
phase: 05-role-infrastructure
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/auth.ts
  - prisma/seed-admin.ts
  - package.json
autonomous: true

must_haves:
  truths:
    - "New @talenta.com.my user is automatically created with VIEWER role"
    - "User role is stored in database"
    - "khairul@talenta.com.my is seeded as ADMIN on first run"
  artifacts:
    - path: "src/auth.ts"
      provides: "Profile callback returning role explicitly"
      contains: "role:"
    - path: "prisma/seed-admin.ts"
      provides: "Idempotent admin user seeding"
      exports: ["main"]
    - path: "package.json"
      provides: "db:seed:admin script"
      contains: "seed-admin"
  key_links:
    - from: "Google OAuth provider"
      to: "User.role field"
      via: "profile callback returns role"
      pattern: "profile.*role"
    - from: "prisma/seed-admin.ts"
      to: "prisma.user.upsert"
      via: "Prisma upsert for idempotent seeding"
      pattern: "user\\.upsert"
---

<objective>
Establish role infrastructure by explicitly assigning VIEWER role to new users via OAuth profile callback and creating an idempotent admin seeding mechanism.

Purpose: Ensure all new @talenta.com.my users are created with VIEWER role and khairul@talenta.com.my is seeded as ADMIN for managing the system.

Output: Modified auth.ts with profile callback, seed-admin.ts script, npm script for admin seeding
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-role-infrastructure/05-RESEARCH.md

# Existing auth implementation (Phase 4)
@src/auth.ts
@src/types/next-auth.d.ts
@prisma/schema.prisma
@prisma/seed.ts
@package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add profile callback to Google provider</name>
  <files>src/auth.ts</files>
  <action>
Add a `profile` callback to the Google provider in src/auth.ts that explicitly returns the role field.

The profile callback should return:
```typescript
profile(profile) {
  return {
    id: profile.sub,
    name: profile.name,
    email: profile.email,
    image: profile.picture,
    role: "VIEWER", // Default role for all new users
  }
},
```

This callback should be added inside the Google() provider configuration, after the `authorization` config.

Why this matters: While the Prisma schema has `@default(VIEWER)`, explicitly returning role from the profile callback ensures clarity and allows for future conditional logic (e.g., assigning different roles based on email patterns).

IMPORTANT: Keep all existing configuration (authorization.params.hd, clientId, clientSecret). Only ADD the profile callback.
  </action>
  <verify>
1. Run `npx tsc --noEmit` - no TypeScript errors
2. Grep src/auth.ts for "profile" and "role:" to confirm callback exists
  </verify>
  <done>
Google provider has profile callback that returns user object with role: "VIEWER"
  </done>
</task>

<task type="auto">
  <name>Task 2: Create idempotent admin seed script</name>
  <files>prisma/seed-admin.ts</files>
  <action>
Create prisma/seed-admin.ts as an idempotent admin user seeding script.

Requirements:
1. Use Prisma's `upsert` to ensure idempotency (can run multiple times safely)
2. Admin email: 'khairul@talenta.com.my'
3. Admin name: 'Khairul'
4. Role: UserRole.ADMIN
5. On upsert update: Always ensure role is ADMIN (in case manually demoted)
6. Proper error handling and disconnect

Pattern from research:
```typescript
import { PrismaClient, UserRole } from '@prisma/client'

const prisma = new PrismaClient()

const ADMIN_EMAIL = 'khairul@talenta.com.my'

async function main() {
  console.log('Seeding admin user...')

  const admin = await prisma.user.upsert({
    where: { email: ADMIN_EMAIL },
    update: {
      role: UserRole.ADMIN, // Ensure admin role even if exists
    },
    create: {
      email: ADMIN_EMAIL,
      name: 'Khairul',
      role: UserRole.ADMIN,
    },
  })

  console.log(`Admin user ready: ${admin.email} (role: ${admin.role})`)
}

main()
  .catch((e) => {
    console.error('Admin seed failed:', e)
    process.exit(1)
  })
  .finally(async () => {
    await prisma.$disconnect()
  })
```

Note: Do NOT include Account record. The Account will be created automatically when the admin logs in via Google OAuth for the first time. The PrismaAdapter matches by email and links the OAuth Account to the existing User.
  </action>
  <verify>
1. File exists at prisma/seed-admin.ts
2. Run `npx tsc --noEmit` - no TypeScript errors in the script
  </verify>
  <done>
prisma/seed-admin.ts exists and contains idempotent upsert logic for khairul@talenta.com.my as ADMIN
  </done>
</task>

<task type="auto">
  <name>Task 3: Add npm script and run admin seed</name>
  <files>package.json</files>
  <action>
1. Add npm script to package.json:
```json
"db:seed:admin": "npx ts-node --compiler-options {\"module\":\"CommonJS\"} prisma/seed-admin.ts"
```

Add this in the "scripts" section alongside the existing "db:seed" script.

2. Run the admin seed:
```bash
npm run db:seed:admin
```

Expected output: "Admin user ready: khairul@talenta.com.my (role: ADMIN)"

3. Verify the user exists in database:
```bash
npx prisma studio
```
Or use: `echo "SELECT email, role FROM users WHERE email = 'khairul@talenta.com.my';" | docker exec -i saap2026v2-mysql-1 mysql -u saap2026 -psalem12345 saap2026` (if using docker MySQL)
  </action>
  <verify>
1. `npm run db:seed:admin` executes without error
2. Output shows admin user created/updated with ADMIN role
3. Re-running `npm run db:seed:admin` succeeds (idempotent - no duplicate error)
  </verify>
  <done>
- package.json has db:seed:admin script
- Admin user khairul@talenta.com.my exists in database with ADMIN role
- Seed script is idempotent (can run multiple times)
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. **Profile callback verification:**
   - `grep -A5 "profile(" src/auth.ts` shows role: "VIEWER"

2. **Admin seed verification:**
   - `npm run db:seed:admin` outputs success message
   - Database contains khairul@talenta.com.my with role ADMIN

3. **Idempotency verification:**
   - Run `npm run db:seed:admin` twice - second run succeeds without error

4. **TypeScript verification:**
   - `npx tsc --noEmit` passes with no errors

5. **Integration verification (optional):**
   - Clear existing session (delete cookies)
   - Log in as khairul@talenta.com.my
   - Session should show role: ADMIN (verify in auth logs or browser devtools)
</verification>

<success_criteria>
- [ ] src/auth.ts has profile callback returning role: "VIEWER"
- [ ] prisma/seed-admin.ts exists with upsert logic
- [ ] package.json has db:seed:admin script
- [ ] `npm run db:seed:admin` succeeds
- [ ] khairul@talenta.com.my exists in database with ADMIN role
- [ ] Running seed twice doesn't cause errors (idempotent)
- [ ] `npx tsc --noEmit` passes
</success_criteria>

<output>
After completion, create `.planning/phases/05-role-infrastructure/05-01-SUMMARY.md`
</output>
