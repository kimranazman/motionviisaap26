---
phase: 44-ux-polish
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/ui/currency-input.tsx
  - src/components/pipeline/deal-form-modal.tsx
  - src/components/pipeline/deal-detail-sheet.tsx
  - src/components/potential-projects/potential-form-modal.tsx
  - src/components/potential-projects/potential-detail-sheet.tsx
autonomous: true

must_haves:
  truths:
    - "Deal value inputs display formatted as 'RM 200,000' when not focused"
    - "Potential project estimated value inputs display formatted as 'RM 200,000' when not focused"
    - "Focusing a currency input shows the raw number for easy editing"
    - "Submitting a form stores the raw numeric value (not the formatted string)"
    - "Currency inputs show the RM prefix label when displaying formatted values"
  artifacts:
    - path: "src/components/ui/currency-input.tsx"
      provides: "Reusable CurrencyInput component with format-on-blur pattern"
      exports: ["CurrencyInput"]
    - path: "src/components/pipeline/deal-form-modal.tsx"
      provides: "Deal creation form using CurrencyInput for value field"
      contains: "CurrencyInput"
    - path: "src/components/pipeline/deal-detail-sheet.tsx"
      provides: "Deal detail/edit using CurrencyInput for value field"
      contains: "CurrencyInput"
    - path: "src/components/potential-projects/potential-form-modal.tsx"
      provides: "Potential project creation form using CurrencyInput for estimated value"
      contains: "CurrencyInput"
    - path: "src/components/potential-projects/potential-detail-sheet.tsx"
      provides: "Potential project detail/edit using CurrencyInput for estimated value"
      contains: "CurrencyInput"
  key_links:
    - from: "CurrencyInput"
      to: "Intl.NumberFormat('en-MY')"
      via: "formatDisplay function"
      pattern: "Intl\\.NumberFormat"
    - from: "deal-form-modal.tsx"
      to: "CurrencyInput"
      via: "import and render for value field"
      pattern: "CurrencyInput"
    - from: "potential-form-modal.tsx"
      to: "CurrencyInput"
      via: "import and render for estimatedValue field"
      pattern: "CurrencyInput"
---

<objective>
Create a reusable CurrencyInput component that displays "RM 200,000" formatting and replace all deal/potential value inputs with it.

Purpose: Users see properly formatted Malaysian Ringgit values in all value input fields (FMT-01), while the system continues to store raw numbers (FMT-02). This eliminates the current pattern of showing raw numbers like "200000" in input fields.
Output: New CurrencyInput component and updated form files.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/44-ux-polish/44-RESEARCH.md

@src/components/ui/input.tsx
@src/lib/utils.ts (formatCurrency function reference)
@src/components/pipeline/deal-form-modal.tsx
@src/components/pipeline/deal-detail-sheet.tsx
@src/components/potential-projects/potential-form-modal.tsx
@src/components/potential-projects/potential-detail-sheet.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create CurrencyInput component</name>
  <files>src/components/ui/currency-input.tsx</files>
  <action>
Create a new reusable `CurrencyInput` component at `src/components/ui/currency-input.tsx`.

The component implements the "format on blur" pattern:
- When **focused**: shows the raw number (e.g., "200000") for easy editing
- When **blurred**: shows formatted display (e.g., "200,000") with an "RM" prefix label
- On **change**: strips non-numeric characters (except decimal point), prevents multiple decimal points
- The component accepts `value` (string) and `onChange` (value: string) => void -- matching the existing pattern where form state stores string values

Implementation details:
```typescript
'use client'

import { useState } from 'react'
import { Input } from '@/components/ui/input'
import { cn } from '@/lib/utils'

interface CurrencyInputProps {
  value: string
  onChange: (value: string) => void
  placeholder?: string
  disabled?: boolean
  className?: string
  id?: string
}

export function CurrencyInput({
  value,
  onChange,
  placeholder = '0',
  disabled = false,
  className,
  id,
}: CurrencyInputProps) {
  const [isFocused, setIsFocused] = useState(false)

  const formatDisplay = (raw: string): string => {
    if (!raw) return ''
    const num = parseFloat(raw)
    if (isNaN(num)) return ''
    return new Intl.NumberFormat('en-MY', {
      minimumFractionDigits: 0,
      maximumFractionDigits: 2,
    }).format(num)
  }

  const handleChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    const cleaned = e.target.value.replace(/[^0-9.]/g, '')
    // Prevent multiple decimal points
    const parts = cleaned.split('.')
    const sanitized = parts.length > 2
      ? parts[0] + '.' + parts.slice(1).join('')
      : cleaned
    onChange(sanitized)
  }

  const displayValue = isFocused ? value : formatDisplay(value)

  return (
    <div className="relative">
      {!isFocused && value && (
        <span className="absolute left-3 top-1/2 -translate-y-1/2 text-sm text-muted-foreground pointer-events-none">
          RM
        </span>
      )}
      <Input
        id={id}
        type="text"
        inputMode="decimal"
        value={displayValue}
        onChange={handleChange}
        onFocus={() => setIsFocused(true)}
        onBlur={() => setIsFocused(false)}
        placeholder={placeholder}
        disabled={disabled}
        className={cn(
          !isFocused && value ? 'pl-10' : '',
          disabled && 'bg-gray-50 cursor-not-allowed',
          className
        )}
      />
    </div>
  )
}
```

Do NOT use `type="number"` -- must be `type="text"` with `inputMode="decimal"` to allow formatting.
Do NOT format on every keystroke -- only format on blur to avoid cursor jumping issues.
  </action>
  <verify>
Run `npx tsc --noEmit` to confirm no type errors in the new component.
  </verify>
  <done>CurrencyInput component exists at src/components/ui/currency-input.tsx, exports CurrencyInput, compiles without errors.</done>
</task>

<task type="auto">
  <name>Task 2: Replace value inputs in deal and potential project forms</name>
  <files>
    src/components/pipeline/deal-form-modal.tsx
    src/components/pipeline/deal-detail-sheet.tsx
    src/components/potential-projects/potential-form-modal.tsx
    src/components/potential-projects/potential-detail-sheet.tsx
  </files>
  <action>
Replace the `<Input type="number">` elements for value/estimatedValue fields with `<CurrencyInput>` in all four files.

**For each file:**

1. Add import at top: `import { CurrencyInput } from '@/components/ui/currency-input'`
2. Find the value/estimatedValue `<Input type="number">` and replace it with `<CurrencyInput>`

**deal-form-modal.tsx** (around line 246-254):
- BEFORE:
  ```
  <Input
    id="value"
    type="number"
    step="0.01"
    min="0"
    value={value}
    onChange={(e) => setValue(e.target.value)}
    placeholder="0.00"
  />
  ```
- AFTER:
  ```
  <CurrencyInput
    id="value"
    value={value}
    onChange={setValue}
    placeholder="0"
  />
  ```
Note: `onChange={setValue}` works directly because CurrencyInput's onChange passes the string value, matching useState setter signature.

**deal-detail-sheet.tsx** (around line 338-347):
- BEFORE:
  ```
  <Input
    id="edit-value"
    type="number"
    step="0.01"
    min="0"
    value={value}
    onChange={(e) => setValue(e.target.value)}
    placeholder="0.00"
    disabled={isReadOnly}
    className={cn(isReadOnly && "bg-gray-50 cursor-not-allowed")}
  />
  ```
- AFTER:
  ```
  <CurrencyInput
    id="edit-value"
    value={value}
    onChange={setValue}
    placeholder="0"
    disabled={isReadOnly}
    className={cn(isReadOnly && "bg-gray-50 cursor-not-allowed")}
  />
  ```

**potential-form-modal.tsx** (around line 246-254):
- BEFORE:
  ```
  <Input
    id="estimatedValue"
    type="number"
    step="0.01"
    min="0"
    value={estimatedValue}
    onChange={(e) => setEstimatedValue(e.target.value)}
    placeholder="0.00"
  />
  ```
- AFTER:
  ```
  <CurrencyInput
    id="estimatedValue"
    value={estimatedValue}
    onChange={setEstimatedValue}
    placeholder="0"
  />
  ```

**potential-detail-sheet.tsx** (around line 334-342):
- BEFORE:
  ```
  <Input
    id="edit-estimatedValue"
    type="number"
    step="0.01"
    min="0"
    value={estimatedValue}
    onChange={(e) => setEstimatedValue(e.target.value)}
    placeholder="0.00"
    disabled={isReadOnly}
  />
  ```
- AFTER:
  ```
  <CurrencyInput
    id="edit-estimatedValue"
    value={estimatedValue}
    onChange={setEstimatedValue}
    placeholder="0"
    disabled={isReadOnly}
  />
  ```

IMPORTANT: The `parseFloat(value)` calls in form submission handlers (e.g., `parseFloat(estimatedValue)`) should remain unchanged -- they already convert the raw string to number for the API. The CurrencyInput stores raw numeric strings, so parseFloat will work correctly.

You may also remove the now-unused `Input` import from each file IF no other Input elements remain. Check before removing.
  </action>
  <verify>
1. Run `npx tsc --noEmit` to confirm no type errors
2. Open http://localhost:3000/pipeline in the browser:
   - Click "Add Deal" and check the Value field shows "RM" prefix with formatting when blurred
   - Click on a deal card and check the Value field in the detail sheet shows "RM" formatting
3. Open http://localhost:3000/potential-projects:
   - Click "Add Potential" and check the Estimated Value field shows "RM" prefix with formatting
   - Click on a card and check the Estimated Value field in the detail sheet shows "RM" formatting
4. Create a test deal with value 200000, save, reopen -- should show "RM 200,000"
  </verify>
  <done>All four value input fields display "RM 200,000" format when blurred. Focusing shows raw number for editing. Form submission stores raw numeric values. No type errors.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with no errors
2. Deal form modal: value field shows "RM" formatted display
3. Deal detail sheet: value field shows "RM" formatted display
4. Potential form modal: estimated value field shows "RM" formatted display
5. Potential detail sheet: estimated value field shows "RM" formatted display
6. All formatted values show thousand separators (e.g., "200,000" not "200000")
7. Focusing any currency input shows the raw number for editing
8. Saving a form with a value preserves the correct number in the database
9. Disabled state (read-only mode) displays formatted value correctly
</verification>

<success_criteria>
- FMT-01 satisfied: Pipeline/Deal value inputs display with "RM" prefix and thousand separators
- FMT-02 satisfied: Values stored as raw numbers, formatting is display-only
- CurrencyInput component is reusable for future value fields
- No regressions: Forms still submit correctly, values still parse to numbers
</success_criteria>

<output>
After completion, create `.planning/phases/44-ux-polish/44-02-SUMMARY.md`
</output>
