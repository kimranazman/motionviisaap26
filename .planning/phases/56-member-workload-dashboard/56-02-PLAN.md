---
phase: 56-member-workload-dashboard
plan: 02
type: execute
wave: 2
depends_on: ["56-01"]
files_modified:
  - src/app/(dashboard)/members/[name]/page.tsx
  - src/components/members/member-detail.tsx
  - src/components/members/member-stats-header.tsx
  - src/components/members/member-kr-section.tsx
  - src/components/members/member-initiatives-section.tsx
  - src/components/members/member-accountable-section.tsx
  - src/components/members/member-tasks-section.tsx
  - src/components/members/member-support-tasks-section.tsx
autonomous: true

must_haves:
  truths:
    - "User sees KRs section with progress bars, target/actual, status badge, and deadline for each KR"
    - "User sees Initiatives section with status badge, department, date range, and linked KR badge"
    - "User sees Tasks section with project context, status, priority, and due date"
    - "User sees Support Tasks section with category, description, frequency, priority, and linked KRs"
    - "User sees summary statistics header with total counts and status breakdowns per entity type"
    - "User sees a separate Accountable For section for initiatives where member is accountable but not personInCharge"
    - "Items past due date or in AT_RISK/BEHIND status are highlighted with red accent"
  artifacts:
    - path: "src/app/(dashboard)/members/[name]/page.tsx"
      provides: "Server component detail page with parallel Prisma queries for all 5 data sets"
      contains: "force-dynamic"
    - path: "src/components/members/member-detail.tsx"
      provides: "Layout component orchestrating stats header and 5 sections"
      min_lines: 30
    - path: "src/components/members/member-stats-header.tsx"
      provides: "4-column stat cards with total counts and status breakdown badges"
      min_lines: 30
    - path: "src/components/members/member-kr-section.tsx"
      provides: "KR list with progress bars and status badges"
      min_lines: 40
    - path: "src/components/members/member-initiatives-section.tsx"
      provides: "Initiatives list with status, department, dates, KR badge"
      min_lines: 40
    - path: "src/components/members/member-accountable-section.tsx"
      provides: "Accountable initiatives section (distinct from personInCharge)"
      min_lines: 30
    - path: "src/components/members/member-tasks-section.tsx"
      provides: "Cross-project tasks list with project badge, status, priority, due date"
      min_lines: 40
    - path: "src/components/members/member-support-tasks-section.tsx"
      provides: "Support tasks list with category, frequency, priority, linked KRs"
      min_lines: 40
  key_links:
    - from: "src/app/(dashboard)/members/[name]/page.tsx"
      to: "prisma"
      via: "Promise.all with 5 parallel queries"
      pattern: "Promise\\.all"
    - from: "src/app/(dashboard)/members/[name]/page.tsx"
      to: "src/lib/member-utils.ts"
      via: "getMemberBySlug import"
      pattern: "getMemberBySlug"
    - from: "member-kr-section.tsx"
      to: "shouldHighlightRed"
      via: "Red border/bg on AT_RISK/BEHIND KRs"
      pattern: "shouldHighlightRed|isItemAtRisk"
    - from: "member-tasks-section.tsx"
      to: "shouldHighlightRed"
      via: "Red border/bg on overdue or AT_RISK tasks"
      pattern: "shouldHighlightRed|isItemOverdue"
    - from: "member-accountable-section.tsx"
      to: "prisma initiative query"
      via: "accountable = member AND NOT personInCharge = member"
      pattern: "NOT.*personInCharge"
---

<objective>
Create the /members/[name] detail page showing all work items for a specific team member across 5 sections (KRs, Initiatives, Accountable For, Tasks, Support Tasks) with summary statistics and overdue/at-risk highlighting.

Purpose: Delivers the full member workload detail view (MBR-04 through MBR-11), providing deep visibility into each member's responsibilities.
Output: Working /members/[name] page with stats header, 5 data sections, red highlighting for overdue/at-risk items.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/56-member-workload-dashboard/56-RESEARCH.md
@.planning/phases/56-member-workload-dashboard/56-01-SUMMARY.md

Key existing files to reference:
@src/lib/member-utils.ts (MEMBER_PROFILES, getMemberBySlug, helpers -- created in Plan 01)
@src/lib/utils.ts (formatStatus, getStatusColor, formatDate, formatDateRange, formatDepartment, cn)
@src/lib/task-utils.ts (formatTaskStatus, getTaskStatusColor, formatTaskPriority, getTaskPriorityColor)
@src/components/objectives/key-result-group.tsx (KR display pattern with progress bars)
@src/components/objectives/initiative-row.tsx (Initiative display pattern)
@src/components/support-tasks/support-tasks-view.tsx (CATEGORY_LABELS, CATEGORY_COLORS, support task card pattern)
@src/components/tasks/task-table-view.tsx (Task table display pattern from Phase 55)
@src/app/(dashboard)/tasks/page.tsx (Server component pattern)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create member detail server page with parallel Prisma queries</name>
  <files>src/app/(dashboard)/members/[name]/page.tsx</files>
  <action>
Create `src/app/(dashboard)/members/[name]/page.tsx` following the server component pattern from tasks/page.tsx:

- `export const dynamic = 'force-dynamic'`
- Import: notFound from next/navigation, prisma from @/lib/prisma, Header from @/components/layout/header, MemberDetail from @/components/members/member-detail, getMemberBySlug from @/lib/member-utils

- Page function receives `params: Promise<{ name: string }>` (Next.js 15 async params pattern)
- Await params, call `getMemberBySlug(name)`, return `notFound()` if undefined

- Create `getMemberDetailData(member: MemberProfile)` function with `Promise.all` for 5 parallel queries:

  1. **Key Results:**
     ```typescript
     prisma.keyResult.findMany({
       where: { owner: member.name },
       orderBy: { krId: 'asc' },
     })
     ```
     Use exact match with title-case name (not case-insensitive mode).

  2. **Initiatives (personInCharge):**
     ```typescript
     prisma.initiative.findMany({
       where: { personInCharge: member.enumValue as any },
       include: { keyResult: { select: { id: true, krId: true } } },
       orderBy: { sequenceNumber: 'asc' },
     })
     ```

  3. **Accountable Initiatives (accountable but NOT personInCharge):**
     ```typescript
     prisma.initiative.findMany({
       where: {
         accountable: member.enumValue as any,
         NOT: { personInCharge: member.enumValue as any },
       },
       include: { keyResult: { select: { id: true, krId: true } } },
       orderBy: { sequenceNumber: 'asc' },
     })
     ```
     The `NOT` clause prevents double-counting (Pitfall 3 from research).

  4. **Tasks:**
     ```typescript
     prisma.task.findMany({
       where: { assignee: member.enumValue as any, parentId: null },
       include: { project: { select: { id: true, title: true } } },
       orderBy: { createdAt: 'desc' },
     })
     ```

  5. **Support Tasks:**
     ```typescript
     prisma.supportTask.findMany({
       where: { owner: member.name },
       include: {
         keyResultLinks: {
           include: { keyResult: { select: { id: true, krId: true, description: true } } },
         },
       },
       orderBy: [{ category: 'asc' }, { taskId: 'asc' }],
     })
     ```

- **Serialize all Prisma data before passing to client component** (Pitfall 4):
  - KRs: Convert Decimal fields (target, actual, progress, weight) with `Number()`. Keep all other fields as-is (status, owner, deadline are strings).
  - Initiatives: Convert startDate/endDate with `.toISOString()`. Convert createdAt/updatedAt with `.toISOString()`.
  - Tasks: Convert dueDate with `?.toISOString() || null`, createdAt/updatedAt with `.toISOString()`.
  - Support Tasks: No date serialization needed (no date fields on SupportTask).

- Pass serialized data to `<MemberDetail>` as a `data` prop containing: `{ member, keyResults, initiatives, accountableInitiatives, tasks, supportTasks }`

- Render:
  ```tsx
  <div className="min-h-screen bg-gray-50">
    <Header title={member.name} description={`Workload overview for ${member.name}`} />
    <div className="p-3 md:p-6">
      <MemberDetail data={serializedData} />
    </div>
  </div>
  ```
  </action>
  <verify>
Run `npx tsc --noEmit` after creating the server page (MemberDetail component will be created in Task 2). If MemberDetail doesn't exist yet, you may see an import error -- that is expected and will resolve when Task 2 completes.
  </verify>
  <done>
Server page at /members/[name] resolves slug to member profile, queries 5 data sets in parallel, serializes Decimal/Date fields, and passes to MemberDetail client component. Returns 404 for invalid slugs.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create member detail layout, stats header, and all 5 section components</name>
  <files>
    src/components/members/member-detail.tsx
    src/components/members/member-stats-header.tsx
    src/components/members/member-kr-section.tsx
    src/components/members/member-initiatives-section.tsx
    src/components/members/member-accountable-section.tsx
    src/components/members/member-tasks-section.tsx
    src/components/members/member-support-tasks-section.tsx
  </files>
  <action>
Create all 7 component files. All are 'use client' components.

**1. MemberDetail (`member-detail.tsx`):**
- Orchestrator component receiving `data` prop with member, keyResults, initiatives, accountableInitiatives, tasks, supportTasks
- Define TypeScript interfaces for each serialized data type matching what the server page passes
- Import and render: MemberStatsHeader, MemberKrSection, MemberInitiativesSection, MemberAccountableSection, MemberTasksSection, MemberSupportTasksSection
- Layout: `<div className="space-y-6">` wrapping stats header + 5 sections
- Also render a back link at the top: `<Link href="/members">` with ArrowLeft icon and "Back to Members" text

**2. MemberStatsHeader (`member-stats-header.tsx`):**
- Props: stats array with label, count, icon, breakdown entries
- Compute stats in MemberDetail and pass down:
  - "Key Results" (Target icon): count = keyResults.length, breakdown from getStatusBreakdown using KR statuses
  - "Initiatives" (Briefcase icon): count = initiatives.length, breakdown using initiative statuses
  - "Tasks" (ListChecks icon): count = tasks.length, breakdown using task statuses
  - "Support Tasks" (ClipboardList icon): count = supportTasks.length, breakdown using priority (since STs don't have status)
- Render: `grid grid-cols-2 md:grid-cols-4 gap-4` with shadcn Card for each stat
- Each card: icon (h-5 w-5 text-gray-400), count (text-2xl font-bold), label (text-sm text-gray-500)
- Below the count: flex-wrap gap-1 of breakdown badges using `<Badge variant="secondary" className="text-xs">` with format "{count} {label}"
- Import getStatusBreakdown from @/lib/member-utils for breakdown computation
- Use formatStatus from @/lib/utils for initiative status labels, formatTaskStatus from @/lib/task-utils for task labels, formatKrStatus from @/lib/member-utils for KR labels

**3. MemberKrSection (`member-kr-section.tsx`):**
- Props: keyResults array (serialized KR objects with number fields for target/actual/progress/weight)
- Section title: "Key Results" with count badge
- For each KR, render a card-like row inside a Card:
  - KR ID badge (font-mono text-xs)
  - Description text
  - Progress bar using shadcn Progress component, colored via getProgressBarColor
  - Target/Actual display: "{actual}/{target} {unit}" text
  - Progress percentage text (colored: green >= 80%, yellow >= 50%, red < 50%)
  - Status badge using getKrStatusColor from member-utils
  - Owner name and deadline text
- **Red highlighting (MBR-10):** For KRs, do NOT use date-based overdue (deadline is free text). Only highlight if `isItemAtRisk(kr.status)` returns true. Apply: `border-red-200 bg-red-50/50` on the row container when at risk.
- Empty state: "No key results assigned to {member.name}" centered text

**4. MemberInitiativesSection (`member-initiatives-section.tsx`):**
- Props: initiatives array (serialized with ISO date strings), memberName for empty state
- Section title: "Initiatives (Person In Charge)" with count badge
- For each initiative, render a row with:
  - Sequence number badge (text-xs font-mono)
  - Title (font-medium, truncated)
  - Status badge using getStatusColor and formatStatus from @/lib/utils
  - Department badge using formatDepartment from @/lib/utils
  - Date range using formatDateRange from @/lib/utils
  - KR badge if keyResult exists: `<Badge variant="outline" className="text-blue-700 border-blue-200">{initiative.keyResult.krId}</Badge>`
- **Red highlighting (MBR-10):** Apply `border-red-200 bg-red-50/50` if `shouldHighlightRed(initiative.status, initiative.endDate)` -- initiatives have proper DateTime endDate, so overdue detection works.
- Empty state: "No initiatives assigned to {memberName}"

**5. MemberAccountableSection (`member-accountable-section.tsx`):**
- Props: same shape as initiatives, memberName
- Section title: "Accountable For" with count badge
- Identical rendering to MemberInitiativesSection (same columns, same highlighting logic)
- Empty state: "No accountability assignments for {memberName}"
- This is a SEPARATE section from initiatives (MBR-11). It only shows initiatives where accountable = member AND personInCharge != member (the server query handles this deduplication).

**6. MemberTasksSection (`member-tasks-section.tsx`):**
- Props: tasks array (serialized with ISO date strings and project relation)
- Section title: "Tasks" with count badge
- Render as a table-like list. For each task:
  - Title (font-medium)
  - Project badge: `<Badge variant="secondary" className="bg-blue-50 text-blue-700">{task.project.title}</Badge>`
  - Status badge using getTaskStatusColor and formatTaskStatus from @/lib/task-utils
  - Priority badge using getTaskPriorityColor and formatTaskPriority from @/lib/task-utils
  - Due date using formatDate from @/lib/utils
- **Red highlighting (MBR-10):** Apply `border-red-200 bg-red-50/50` if `shouldHighlightRed(task.status, task.dueDate)`. Tasks have proper dueDate (nullable).
- Empty state: "No tasks assigned to {memberName}"

**7. MemberSupportTasksSection (`member-support-tasks-section.tsx`):**
- Props: supportTasks array with keyResultLinks relation
- Section title: "Support Tasks" with count badge
- For each support task, render a card with border-left color by category:
  - Define CATEGORY_LABELS and CATEGORY_COLORS locally (same values as support-tasks-view.tsx): DESIGN_CREATIVE, BUSINESS_ADMIN, TALENTA_IDEAS, OPERATIONS
  - Also define CATEGORY_BORDER_COLORS for left border
  - Task ID badge (font-mono text-xs)
  - Task description (font-medium)
  - Category badge with category-specific color
  - Priority badge (LOW/MEDIUM/HIGH with colors)
  - Frequency text if present (with Clock icon)
  - KR links section: flex-wrap badges linking to /objectives, each showing krId
- **Red highlighting (MBR-10):** Support tasks have a priority field but no status or due date. Apply `border-red-200 bg-red-50/50` only if priority is HIGH (since there is no status or date to check).
- Empty state: "No support tasks assigned to {memberName}"

**General component patterns:**
- All sections use shadcn Card as the outer wrapper with CardHeader (section title + count) and CardContent (list of items)
- Items within sections use `div` with `p-3 rounded-lg border` styling, stacked with `space-y-2`
- Badge imports from @/components/ui/badge
- Use `cn()` from @/lib/utils for conditional classes
- Mobile responsive: items stack vertically, badges wrap
  </action>
  <verify>
Run `npx tsc --noEmit` and confirm no type errors across all 7 new files plus the server page from Task 1. Visit /members/khairul in the browser and verify: stats header shows 4 stat cards with breakdowns, KR section shows KRs with progress bars, Initiatives section shows initiatives with status badges, Accountable section is distinct, Tasks section shows cross-project tasks, Support Tasks section shows categorized tasks with KR links.
  </verify>
  <done>
/members/[name] page shows full member workload with: summary stats header (4 cards with counts and status breakdowns), KR section (progress bars, status, at-risk highlighting), Initiatives section (status, department, dates, KR badge), Accountable For section (separate from initiatives), Tasks section (project badge, status, priority, due date, overdue highlighting), Support Tasks section (category, priority, frequency, KR links). All sections have empty states and red highlighting for overdue/at-risk items.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with no errors
2. /members/khairul shows stats header with 4 count cards and status breakdowns
3. KR section shows key results with progress bars and AT_RISK/BEHIND items highlighted red
4. Initiatives section shows initiatives where member is personInCharge with status badges and KR badges
5. Accountable For section shows initiatives where member is accountable but NOT personInCharge (no duplicates)
6. Tasks section shows cross-project tasks with project badges and overdue items highlighted red
7. Support Tasks section shows categorized tasks with KR link badges
8. Empty sections show appropriate "No {entity} assigned to {name}" message
9. /members/azlan and /members/izyani also render correctly (with potentially empty sections)
10. /members/invalid returns 404
</verification>

<success_criteria>
- All 5 sections render correct data for each of the 3 members
- Stats header shows accurate counts and status breakdowns
- Red highlighting appears on AT_RISK/BEHIND KRs, overdue initiatives, and overdue tasks
- Accountable For section is distinct from personInCharge section with no double-counting
- No type errors, no serialization errors (Decimal/Date properly handled)
- All 11 MBR requirements (MBR-01 through MBR-11) are satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/56-member-workload-dashboard/56-02-SUMMARY.md`
</output>
