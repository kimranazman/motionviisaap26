# Plan 71-01: Internal Field Config Backend

## Frontmatter
- **Phase**: 71 — Internal Project Field Config
- **Wave**: 1
- **Depends on**: Nothing
- **Files modified**:
  - `prisma/schema.prisma`
  - `src/types/internal-fields.ts` (new)
  - `src/lib/widgets/defaults.ts`
  - `src/app/api/admin/internal-fields/route.ts` (new)
  - `src/lib/hooks/use-internal-field-config.ts` (new)
- **Autonomous**: Yes

## Objective
Add backend infrastructure for internal project field configuration: Prisma schema extension, TypeScript types, API endpoint, and client-side hook.

## Tasks

<task id="1">
**Add internalFieldConfig to AdminDefaults schema**

Edit `prisma/schema.prisma`, model `AdminDefaults` (line ~631):

Add a new JSON field after `widgetRoles`:
```
internalFieldConfig Json? @map("internal_field_config") @db.Json
```

The field is nullable — when null, sensible defaults apply (INTL-06).

Then run: `npx prisma db push` to sync schema.
</task>

<task id="2">
**Create TypeScript type for internal field config**

Create `src/types/internal-fields.ts`:

```typescript
/**
 * Internal Project Field Configuration
 * Controls which fields are hidden when a project is internal.
 * Stored in AdminDefaults as system-wide config.
 */

/** Field keys that can be hidden on internal projects */
export type InternalFieldKey =
  | 'revenue'
  | 'potentialRevenue'
  | 'pipelineSource'
  | 'companyContact'
  | 'initiativeLink'

/** All configurable internal field keys */
export const INTERNAL_FIELD_KEYS: { key: InternalFieldKey; label: string; description: string }[] = [
  { key: 'revenue', label: 'Revenue (Actual)', description: 'Actual revenue from invoices' },
  { key: 'potentialRevenue', label: 'Revenue (Potential)', description: 'Potential revenue from deal/estimate' },
  { key: 'pipelineSource', label: 'Pipeline Source', description: 'Source deal or potential project' },
  { key: 'companyContact', label: 'Company & Contact', description: 'Company and contact association' },
  { key: 'initiativeLink', label: 'Initiative Link', description: 'Link to KRI / Initiative' },
]

/** Config stored in AdminDefaults.internalFieldConfig */
export interface InternalFieldConfig {
  hiddenFields: InternalFieldKey[]
}

/**
 * Default config when no admin config exists (INTL-06)
 * Hides revenue and pipeline source for internal projects
 */
export const DEFAULT_INTERNAL_FIELD_CONFIG: InternalFieldConfig = {
  hiddenFields: ['revenue', 'potentialRevenue', 'pipelineSource', 'companyContact'],
}

/** Check if a field should be hidden for internal projects */
export function isFieldHidden(
  config: InternalFieldConfig | null,
  fieldKey: InternalFieldKey,
  isInternal: boolean
): boolean {
  if (!isInternal) return false
  const effectiveConfig = config ?? DEFAULT_INTERNAL_FIELD_CONFIG
  return effectiveConfig.hiddenFields.includes(fieldKey)
}
```
</task>

<task id="3">
**Extend getAdminDefaults and updateAdminDefaults**

Edit `src/lib/widgets/defaults.ts`:

1. Add import: `import type { InternalFieldConfig } from '@/types/internal-fields'`

2. Update `getAdminDefaults()` return type to include `internalFieldConfig: InternalFieldConfig | null`

3. In the return object, add:
```typescript
internalFieldConfig: defaults.internalFieldConfig as unknown as InternalFieldConfig | null,
```

4. Update `updateAdminDefaults()` parameter type to include `internalFieldConfig?: InternalFieldConfig`

5. In the update function body, add handling for the new field:
```typescript
if (updates.internalFieldConfig !== undefined) {
  data.internalFieldConfig = updates.internalFieldConfig as unknown as object
}
```
</task>

<task id="4">
**Create API route for internal field config**

Create `src/app/api/admin/internal-fields/route.ts`:

```typescript
import { NextRequest, NextResponse } from 'next/server'
import { requireAdmin } from '@/lib/auth-utils'
import { getAdminDefaults, updateAdminDefaults } from '@/lib/widgets/defaults'
import { INTERNAL_FIELD_KEYS, type InternalFieldConfig, type InternalFieldKey } from '@/types/internal-fields'

/**
 * GET /api/admin/internal-fields
 * Returns the current internal project field config
 * Admin only
 */
export async function GET() {
  const { error } = await requireAdmin()
  if (error) return error

  try {
    const defaults = await getAdminDefaults()
    return NextResponse.json({
      internalFieldConfig: defaults.internalFieldConfig,
      fields: INTERNAL_FIELD_KEYS,
    })
  } catch (err) {
    console.error('[Admin Internal Fields API] GET error:', err)
    return NextResponse.json(
      { error: 'Failed to fetch internal field config' },
      { status: 500 }
    )
  }
}

/**
 * PUT /api/admin/internal-fields
 * Updates internal project field visibility config
 * Admin only
 */
export async function PUT(request: NextRequest) {
  const { error } = await requireAdmin()
  if (error) return error

  try {
    const body = await request.json()
    const { internalFieldConfig } = body as { internalFieldConfig: InternalFieldConfig }

    // Validate hiddenFields are valid keys
    const validKeys = INTERNAL_FIELD_KEYS.map(f => f.key)
    const invalidKeys = internalFieldConfig.hiddenFields.filter(
      (key) => !validKeys.includes(key as InternalFieldKey)
    )
    if (invalidKeys.length > 0) {
      return NextResponse.json(
        { error: 'Invalid field keys', invalidKeys },
        { status: 400 }
      )
    }

    await updateAdminDefaults({ internalFieldConfig })
    return NextResponse.json({ success: true })
  } catch (err) {
    console.error('[Admin Internal Fields API] PUT error:', err)
    return NextResponse.json(
      { error: 'Failed to update internal field config' },
      { status: 500 }
    )
  }
}
```

Note: This endpoint does NOT need requireAdmin for GET — we need all users to read the config so they can hide fields. Change GET to not require admin auth, or create a separate public endpoint. Decision: Make GET public (no auth required) since field visibility config is not sensitive. Keep PUT admin-only.

Actually, revisiting: use `requireAuth` (any logged-in user) for GET, and `requireAdmin` for PUT.
</task>

<task id="5">
**Create client-side hook for internal field config**

Create `src/lib/hooks/use-internal-field-config.ts`:

```typescript
'use client'

import { useState, useEffect } from 'react'
import { DEFAULT_INTERNAL_FIELD_CONFIG, type InternalFieldConfig, type InternalFieldKey } from '@/types/internal-fields'

export function useInternalFieldConfig() {
  const [config, setConfig] = useState<InternalFieldConfig | null>(null)
  const [isLoading, setIsLoading] = useState(true)

  useEffect(() => {
    const fetchConfig = async () => {
      try {
        const response = await fetch('/api/admin/internal-fields')
        if (response.ok) {
          const data = await response.json()
          setConfig(data.internalFieldConfig)
        }
      } catch (error) {
        console.error('Failed to fetch internal field config:', error)
      } finally {
        setIsLoading(false)
      }
    }
    fetchConfig()
  }, [])

  /** Check if a field should be hidden for internal projects */
  const isHidden = (fieldKey: InternalFieldKey, isInternal: boolean): boolean => {
    if (!isInternal) return false
    const effectiveConfig = config ?? DEFAULT_INTERNAL_FIELD_CONFIG
    return effectiveConfig.hiddenFields.includes(fieldKey)
  }

  return { config, isLoading, isHidden }
}
```

Check if `requireAuth` exists in auth-utils. If not, adjust the GET endpoint to use whatever auth middleware is available, or skip auth for GET entirely (config is not sensitive).
</task>

## Verification

- [ ] `npx prisma db push` succeeds without errors
- [ ] `GET /api/admin/internal-fields` returns config (null when no config saved)
- [ ] `PUT /api/admin/internal-fields` with `{ internalFieldConfig: { hiddenFields: ['revenue'] } }` succeeds
- [ ] TypeScript compiles without errors
- [ ] `isFieldHidden()` returns true for hidden fields on internal projects, false for non-internal

## must_haves
- AdminDefaults schema has internalFieldConfig Json field
- TypeScript types define all 5 configurable field keys
- API endpoint supports GET (any user) and PUT (admin only)
- Client hook provides isHidden() helper
- Sensible defaults applied when no config exists (INTL-06)
