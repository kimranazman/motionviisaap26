# Plan 71-02: Internal Field Config UI & Integration

## Frontmatter
- **Phase**: 71 — Internal Project Field Config
- **Wave**: 2
- **Depends on**: 71-01
- **Files modified**:
  - `src/app/(dashboard)/settings/page.tsx`
  - `src/components/projects/project-form-modal.tsx`
  - `src/components/projects/project-detail-sheet.tsx`
  - `src/app/(dashboard)/projects/[id]/project-detail-page-client.tsx`
- **Autonomous**: Yes

## Objective
Add admin settings UI for field toggles and integrate field visibility into all project forms and detail views.

## Tasks

<task id="1">
**Add Internal Project Fields section to Settings page**

Edit `src/app/(dashboard)/settings/page.tsx`:

Add a new Card section below "Sidebar Navigation" card for admin-only Internal Project Fields config.

1. Import the hook: `import { useInternalFieldConfig } from '@/lib/hooks/use-internal-field-config'`
2. Import types: `import { INTERNAL_FIELD_KEYS, DEFAULT_INTERNAL_FIELD_CONFIG, type InternalFieldConfig, type InternalFieldKey } from '@/types/internal-fields'`
3. Import `{ EyeOff }` from lucide-react

4. Add state in SettingsPage component:
```typescript
const { config: internalFieldConfig, isLoading: fieldConfigLoading } = useInternalFieldConfig()
const [localHiddenFields, setLocalHiddenFields] = useState<InternalFieldKey[]>([])
const [isFieldConfigSaving, setIsFieldConfigSaving] = useState(false)
```

5. Add useEffect to sync local state:
```typescript
useEffect(() => {
  if (!fieldConfigLoading) {
    setLocalHiddenFields(
      internalFieldConfig?.hiddenFields ?? DEFAULT_INTERNAL_FIELD_CONFIG.hiddenFields
    )
  }
}, [fieldConfigLoading, internalFieldConfig])
```

6. Add dirty detection:
```typescript
const currentHiddenFields = internalFieldConfig?.hiddenFields ?? DEFAULT_INTERNAL_FIELD_CONFIG.hiddenFields
const isFieldConfigDirty = JSON.stringify([...localHiddenFields].sort()) !==
                           JSON.stringify([...currentHiddenFields].sort())
```

7. Add toggle handler:
```typescript
const handleFieldToggle = (key: InternalFieldKey) => {
  setLocalHiddenFields(prev =>
    prev.includes(key)
      ? prev.filter(k => k !== key)
      : [...prev, key]
  )
}
```

8. Add save handler:
```typescript
const handleFieldConfigSave = async () => {
  setIsFieldConfigSaving(true)
  try {
    const response = await fetch('/api/admin/internal-fields', {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        internalFieldConfig: { hiddenFields: localHiddenFields }
      }),
    })
    if (response.ok) {
      toast.success('Internal field settings saved')
    } else {
      toast.error('Failed to save settings')
    }
  } catch {
    toast.error('Failed to save settings')
  } finally {
    setIsFieldConfigSaving(false)
  }
}
```

9. Add the UI card after the Sidebar Navigation card:
```tsx
{/* Internal Project Fields (Admin only) */}
<Card className="p-6">
  <div className="space-y-4">
    <div>
      <h3 className="text-base font-semibold text-gray-900 flex items-center gap-2">
        <EyeOff className="h-4 w-4" />
        Internal Project Fields
      </h3>
      <p className="text-sm text-gray-500 mt-1">
        Choose which fields to hide when a project is marked as internal.
        This applies system-wide for all users.
      </p>
    </div>

    {fieldConfigLoading ? (
      <div className="space-y-3">
        {[...Array(5)].map((_, i) => (
          <div key={i} className="h-8 rounded bg-gray-100 animate-pulse" />
        ))}
      </div>
    ) : (
      <div className="space-y-1">
        {INTERNAL_FIELD_KEYS.map(({ key, label, description }) => {
          const isHidden = localHiddenFields.includes(key)
          return (
            <div
              key={key}
              className="flex items-center justify-between py-2 px-1"
            >
              <div>
                <span className="text-sm text-gray-700">{label}</span>
                <p className="text-xs text-gray-400">{description}</p>
              </div>
              <Switch
                checked={isHidden}
                onCheckedChange={() => handleFieldToggle(key)}
              />
            </div>
          )
        })}
      </div>
    )}

    {isFieldConfigDirty && (
      <div className="pt-4 border-t border-gray-200">
        <Button
          onClick={handleFieldConfigSave}
          disabled={isFieldConfigSaving}
          className="w-full"
        >
          {isFieldConfigSaving ? 'Saving...' : 'Save Field Settings'}
        </Button>
      </div>
    )}
  </div>
</Card>
```

The Switch "checked" state represents "is this field hidden?" — checked = hidden.
</task>

<task id="2">
**Integrate field config into ProjectFormModal (create form)**

Edit `src/components/projects/project-form-modal.tsx`:

1. Import the hook: `import { useInternalFieldConfig } from '@/lib/hooks/use-internal-field-config'`

2. In the component, add:
```typescript
const { isHidden } = useInternalFieldConfig()
```

3. Wrap the Revenue field with conditional rendering:
```tsx
{/* Revenue - hidden for internal projects if configured */}
{!isHidden('revenue', isInternal) && (
  <div className="space-y-2">
    <Label htmlFor="revenue">Revenue</Label>
    <Input ... />
  </div>
)}
```

Note: The revenue input in the create form maps to actual revenue. potentialRevenue is set via pipeline conversion, not the create form. So we only need to check 'revenue' here.

4. Wrap the KRI Link field with conditional rendering:
```tsx
{/* KRI Link - hidden for internal projects if configured */}
{!isHidden('initiativeLink', isInternal) && (
  <div className="space-y-2">
    <Label>Link to KRI</Label>
    <InitiativeSelect ... />
  </div>
)}
```

5. Company and Contact are already hidden when `isInternal === true`. The admin config for 'companyContact' reinforces this but the current behavior is already correct (internal projects show entity selector instead). No change needed for company/contact in the create form since isInternal toggle already handles it.

6. When fields are hidden due to config, clear their values in the submit handler to avoid sending stale data:
```typescript
// In handleSubmit, before building the request body:
const shouldHideRevenue = isHidden('revenue', isInternal)
const shouldHideInitiative = isHidden('initiativeLink', isInternal)

body: JSON.stringify({
  ...
  revenue: shouldHideRevenue ? null : (revenue ? parseFloat(revenue) : null),
  initiativeId: shouldHideInitiative ? null : (initiativeId || null),
})
```
</task>

<task id="3">
**Integrate field config into ProjectDetailSheet (edit form)**

Edit `src/components/projects/project-detail-sheet.tsx`:

1. Import the hook: `import { useInternalFieldConfig } from '@/lib/hooks/use-internal-field-config'`

2. In the ProjectDetailSheet component, add:
```typescript
const { isHidden } = useInternalFieldConfig()
```

3. Conditionally render the KRI Link edit field:
```tsx
{/* KRI Link - hidden for internal if configured */}
{!isHidden('initiativeLink', isInternal) && (
  <div className="space-y-2">
    <Label>Link to KRI</Label>
    <InitiativeSelect ... />
  </div>
)}
```

4. Conditionally render the FinancialsSummary section. If both revenue and potentialRevenue are hidden, hide the entire Financials Summary:
```tsx
{/* Financials Summary - hidden if revenue fields are both hidden for internal */}
{!(isHidden('revenue', isInternal) && isHidden('potentialRevenue', isInternal)) && (
  <>
    <FinancialsSummary ... />
    <Separator />
  </>
)}
```

5. Conditionally render the Source Info section:
```tsx
{/* Source Info - hidden for internal if pipeline source is hidden */}
{!isHidden('pipelineSource', isInternal) && (
  <div className="space-y-2">
    <Label className="text-muted-foreground">Source</Label>
    ...
  </div>
)}
```

6. Conditionally render the KRI Display section (read-only):
```tsx
{/* KRI Display - hidden for internal if initiative link is hidden */}
{!isHidden('initiativeLink', isInternal) && project.initiative && (
  <div className="space-y-2">
    <Label className="text-muted-foreground">Linked KRI</Label>
    ...
  </div>
)}
```

7. In the `handleSave` function, nullify hidden fields:
```typescript
initiativeId: isHidden('initiativeLink', isInternal) ? null : (initiativeId || null),
```
</task>

<task id="4">
**Integrate field config into ProjectDetailPageClient (read-only view)**

Edit `src/app/(dashboard)/projects/[id]/project-detail-page-client.tsx`:

1. Import the hook: `import { useInternalFieldConfig } from '@/lib/hooks/use-internal-field-config'`

2. In the component, add:
```typescript
const { isHidden } = useInternalFieldConfig()
const isInternal = project.isInternal ?? false
```

3. In the Details Card, conditionally render Company/Entity:
```tsx
{/* Company / Entity - hidden for internal if configured */}
{!isHidden('companyContact', isInternal) && (
  <div className="space-y-1.5">
    <label>...Company/Entity...</label>
    ...
  </div>
)}
```

4. Conditionally render Contact:
```tsx
{!isHidden('companyContact', isInternal) && (
  <div className="space-y-1.5">
    <label>...Contact...</label>
    ...
  </div>
)}
```

5. Conditionally render Initiative:
```tsx
{!isHidden('initiativeLink', isInternal) && project.initiative && (
  <div className="space-y-1.5">
    <label>...Initiative...</label>
    ...
  </div>
)}
```

6. Conditionally render Source:
```tsx
{!isHidden('pipelineSource', isInternal) && (project.sourceDeal || project.sourcePotential) && (
  <div className="space-y-1.5">
    <label>...Source...</label>
    ...
  </div>
)}
```

7. Conditionally render the Financials Card:
```tsx
{/* Financials Card - hidden if both revenue fields are hidden for internal */}
{!(isHidden('revenue', isInternal) && isHidden('potentialRevenue', isInternal)) && (
  <Card>
    <CardHeader>
      <CardTitle>...Financials...</CardTitle>
    </CardHeader>
    ...
  </Card>
)}
```

Note: For the header section, always show the project title, status badge, and "Internal" badge — these are always visible regardless of config.

For Company name in the header subtitle: conditionally render based on companyContact config:
```tsx
{!isHidden('companyContact', isInternal) && (
  project.company ? (
    <p className="text-sm text-gray-500 mt-0.5">{project.company.name}</p>
  ) : project.isInternal && project.internalEntity ? (
    <p className="text-sm text-gray-500 mt-0.5">
      {project.internalEntity === 'MOTIONVII' ? 'Motionvii' : 'Talenta'}
    </p>
  ) : null
)}
```

Wait — for internal projects, the header shows the entity name (Motionvii/Talenta), not the company. The `companyContact` config should hide the company/contact but not the entity name. The entity is always shown for internal projects since it's their identifying attribute.

Revised: Only hide the company name subtitle for non-internal projects (when companyContact is somehow hidden). For internal projects, always show entity name in header. The `companyContact` config hides the Company/Contact fields in the Details card form only.
</task>

## Verification

- [ ] Settings page shows "Internal Project Fields" card with 5 toggle switches
- [ ] Toggle switches represent "hidden when internal" state (checked = hidden)
- [ ] Save button appears only when local state differs from persisted state
- [ ] Toast confirms "Internal field settings saved" on successful save
- [ ] ProjectFormModal hides Revenue field when creating internal project (if revenue is in hiddenFields)
- [ ] ProjectFormModal hides KRI Link when creating internal project (if initiativeLink is in hiddenFields)
- [ ] ProjectDetailSheet hides Financials Summary, Source Info, KRI sections based on config
- [ ] ProjectDetailPageClient hides Details fields and Financials card based on config
- [ ] Non-internal projects show all fields regardless of config
- [ ] TypeScript compiles without errors
- [ ] App renders without console errors

## must_haves
- Settings page has admin toggle section for internal project fields (INTL-01)
- All 5 field types are configurable (INTL-02)
- Project form hides configured fields when project is internal (INTL-04)
- Project detail views follow same visibility rules (INTL-05)
- Sensible defaults applied (revenue and pipeline hidden by default) (INTL-06)
