---
phase: 40-kpi-tracking-linked-projects
plan: 02
type: execute
wave: 2
depends_on: ["40-01"]
files_modified:
  - src/components/objectives/linked-projects-section.tsx
  - src/components/objectives/initiative-row.tsx
  - src/components/kanban/initiative-detail-sheet.tsx
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Each initiative row shows a linked project count badge (e.g., folder icon with '3')"
    - "Clicking the badge opens the initiative detail sheet scrolled to the linked projects section"
    - "Linked projects section shows each project with title, status badge, revenue, costs, client name, and dates"
    - "Clicking a linked project navigates to /projects/[id]"
    - "Initiatives with no linked projects show appropriate empty state in the detail sheet"
    - "Initiatives with no linked projects do not show a badge on the row (or show subtle '0' at Claude's discretion)"
  artifacts:
    - path: "src/components/objectives/linked-projects-section.tsx"
      provides: "Linked projects list with click-through navigation"
      min_lines: 40
    - path: "src/components/objectives/initiative-row.tsx"
      provides: "Project count badge on initiative row"
      contains: "FolderOpen"
    - path: "src/components/kanban/initiative-detail-sheet.tsx"
      provides: "Linked projects section in detail sheet"
      contains: "LinkedProjectsSection"
  key_links:
    - from: "src/components/objectives/initiative-row.tsx"
      to: "initiative.projects"
      via: "Project count badge showing projects.length"
      pattern: "projects.*length"
    - from: "src/components/objectives/linked-projects-section.tsx"
      to: "/projects/[id]"
      via: "Next.js Link component for click-through navigation"
      pattern: "href.*projects/"
    - from: "src/components/kanban/initiative-detail-sheet.tsx"
      to: "src/components/objectives/linked-projects-section.tsx"
      via: "LinkedProjectsSection rendered inside detail sheet ScrollArea"
      pattern: "LinkedProjectsSection"
---

<objective>
Add linked project inline display to initiative rows and the detail sheet: a project count badge on each initiative row and an expandable linked projects section in the detail sheet showing project title, status, revenue, costs, client name, and dates with click-through navigation.

Purpose: Users can see at a glance how many projects are linked to each initiative and drill into project details without leaving the initiatives view.

Output: LinkedProjectsSection component, project count badge on initiative rows, linked projects section in detail sheet with navigation to /projects/[id].
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/40-kpi-tracking-linked-projects/40-CONTEXT.md
@.planning/phases/40-kpi-tracking-linked-projects/40-RESEARCH.md
@.planning/phases/40-kpi-tracking-linked-projects/40-01-SUMMARY.md

@src/components/objectives/initiative-row.tsx
@src/components/objectives/objective-hierarchy.tsx
@src/components/kanban/initiative-detail-sheet.tsx
@src/lib/project-utils.ts
@src/lib/utils.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: LinkedProjectsSection component and project count badge on initiative row</name>
  <files>
    src/components/objectives/linked-projects-section.tsx
    src/components/objectives/initiative-row.tsx
  </files>
  <action>
    **1. Create `linked-projects-section.tsx`** -- new file in `src/components/objectives/`:

    A component that renders a list of linked projects for an initiative. Used inside the detail sheet.

    Props:
    ```typescript
    interface LinkedProject {
      id: string
      title: string
      status: string
      revenue: number | null
      totalCosts: number
      companyName: string | null
      startDate: string | null
      endDate: string | null
    }

    interface LinkedProjectsSectionProps {
      projects: LinkedProject[]
    }
    ```

    Layout for each project item:
    - Wrapped in a Next.js `<Link href={`/projects/${project.id}`}>` for click-through navigation
    - Row layout: left side has project title (font-medium, sm) with an `ExternalLink` icon that appears on hover (opacity-0 group-hover:opacity-100), and client name below (text-xs text-gray-500)
    - Right side: status badge using `getProjectStatusColor` and `formatProjectStatus` from `project-utils.ts`, revenue using `formatCurrency`, and "Cost: {formatCurrency(totalCosts)}" below
    - Date range shown below in small text using `formatDateRange` or simple date formatting if both dates exist
    - Hover state: `hover:bg-gray-50` transition on the entire row
    - Each item separated by a subtle divider or spacing

    Empty state: When `projects.length === 0`, show a centered muted message: "No linked projects" with a `FolderOpen` icon.

    Section wrapper: Include a section header with `FolderOpen` icon and "Linked Projects" title with count badge (similar to Comments section pattern in the detail sheet).

    **2. Add project count badge to `initiative-row.tsx`:**

    The initiative row already has: sequence number badge | center content (title + metadata) | status badge.

    Add a project count badge in the metadata row (the `flex flex-wrap items-center gap-2 mt-1 text-xs text-gray-500` div):
    - Import `FolderOpen` from lucide-react
    - After the existing metadata items (department, person, date range), add:
      ```
      {initiative.projects && initiative.projects.length > 0 && (
        <span className="inline-flex items-center gap-1 text-blue-600">
          <FolderOpen className="h-3 w-3" />
          {initiative.projects.length} project{initiative.projects.length !== 1 ? 's' : ''}
        </span>
      )}
      ```
    - If no projects or empty array: do NOT show a badge (hide entirely for clean row density)
    - The badge is purely informational on the row -- clicking the initiative row opens the detail sheet as before (no special badge click handler needed since the whole row is clickable)
  </action>
  <verify>
    - `npx tsc --noEmit` passes with no type errors
    - Visit `/objectives` page: initiatives with linked projects show a blue "N projects" badge in the metadata row
    - Initiatives without projects show no badge (clean row)
    - The project count matches actual linked projects in the database
  </verify>
  <done>
    - LinkedProjectsSection component created with project list, click-through links, status badges, revenue/cost display
    - Initiative rows show project count badge for initiatives with linked projects
    - Empty state handled (no badge on row, "No linked projects" in section component)
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate LinkedProjectsSection into initiative detail sheet</name>
  <files>
    src/components/kanban/initiative-detail-sheet.tsx
  </files>
  <action>
    **1. Add Linked Projects section to the detail sheet:**

    In `initiative-detail-sheet.tsx`, add a "Linked Projects" section between the Separator (after Save Button) and the Comments section:

    - Import `LinkedProjectsSection` from `@/components/objectives/linked-projects-section`
    - The initiative data from the hierarchy view already includes `projects` array (added in Plan 01)
    - However, the detail sheet fetches full initiative data via GET `/api/initiatives/[id]` on open. The GET endpoint currently uses `include: { comments: ... }`. It needs to ALSO include projects with cost data.

    **2. Extend GET endpoint in `api/initiatives/[id]/route.ts`:**

    Update the `include` to also fetch linked projects:
    ```typescript
    include: {
      comments: {
        orderBy: { createdAt: 'desc' },
        include: {
          user: { select: { id: true, name: true, email: true, image: true } },
        },
      },
      projects: {
        select: {
          id: true,
          title: true,
          status: true,
          revenue: true,
          startDate: true,
          endDate: true,
          company: { select: { id: true, name: true } },
          costs: { select: { amount: true } },
        },
      },
    },
    ```

    Serialize the projects in the response before returning. The GET handler currently returns `NextResponse.json(initiative)` directly -- Prisma Decimal fields (revenue, cost amounts) need Number() conversion. Add a serialization step:
    ```typescript
    const serializedProjects = (initiative.projects || []).map(p => ({
      id: p.id,
      title: p.title,
      status: p.status,
      revenue: p.revenue ? Number(p.revenue) : null,
      totalCosts: p.costs.reduce((sum, c) => sum + Number(c.amount), 0),
      companyName: p.company?.name || null,
      startDate: p.startDate ? p.startDate.toISOString() : null,
      endDate: p.endDate ? p.endDate.toISOString() : null,
    }))
    ```
    Return `{ ...initiative, projects: serializedProjects }` (ensure the rest of the initiative fields are also properly serialized -- Decimal fields like kpiTarget, kpiActual need Number() conversion too).

    **3. Wire LinkedProjectsSection in the detail sheet:**

    - Add `projects` state: `const [projects, setProjects] = useState<LinkedProject[]>([])`
    - Define `LinkedProject` type matching the component's expected shape (or import from linked-projects-section.tsx if exported)
    - In the `useEffect` that fetches initiative data, also `setProjects(data.projects || [])`
    - Add a `<Separator />` before the linked projects section
    - Render `<LinkedProjectsSection projects={projects} />` between the KPI section and the Comments section
    - The section should be visible even when loading (show the LinkedProjectsSection with its internal empty state or loading handling)

    **4. Ensure dialog close on project navigation:**
    When user clicks a linked project (which uses a Next.js `<Link>`), the dialog should close. The `<Link>` component triggers client-side navigation. The dialog's `onOpenChange` should handle this. However, since the Link navigates away, the dialog will unmount naturally. No special handling needed -- the navigation will leave the `/objectives` page.

    IMPORTANT: The GET API response needs careful serialization. Currently it returns `NextResponse.json(initiative)` which auto-serializes. With Prisma Decimal fields (kpiTarget, kpiActual, revenue, cost amounts), these become `{type: "Decimal", value: "..."}` objects in JSON. Convert ALL Decimal fields to Number before returning.
  </action>
  <verify>
    - `npx tsc --noEmit` passes with no type errors
    - `npm run build` succeeds
    - Open an initiative detail sheet: "Linked Projects" section appears with project list
    - Each linked project shows title, status badge, revenue, costs, client name
    - Click a linked project: navigates to `/projects/{id}`
    - Initiative with no projects: shows "No linked projects" empty state in the section
    - Decimal fields (revenue, costs, KPI values) display as numbers (not `[object Object]`)
  </verify>
  <done>
    - LinkedProjectsSection integrated into initiative detail sheet
    - GET API returns serialized project data with Decimal-to-Number conversion
    - Each linked project has title, status, revenue, costs, client, dates, and click-through to /projects/[id]
    - Empty state handled for initiatives with no linked projects
    - All Decimal fields properly serialized in GET response
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` -- no TypeScript errors
2. `npm run build` -- production build succeeds
3. Visit `/objectives` page:
   - Initiatives with linked projects show blue project count badge in metadata row
   - Initiatives without projects show no badge
4. Click an initiative with linked projects:
   - Detail sheet opens with "Linked Projects" section showing project list
   - Each project shows: title, status badge, revenue, costs, client name, dates
   - ExternalLink icon appears on hover
5. Click a linked project title: navigates to `/projects/{id}`
6. Click an initiative without linked projects:
   - Detail sheet shows "No linked projects" empty state in the section
</verification>

<success_criteria>
- PROJ-01: Each initiative detail sheet shows linked projects with title, status badge, revenue, costs
- PROJ-02: Clicking a linked project navigates to /projects/[id]
- PROJ-03: Initiative row shows project count badge (e.g., "3 projects")
- PROJ-04: Initiatives with no linked projects show appropriate empty state (no badge on row, "No linked projects" in sheet)
</success_criteria>

<output>
After completion, create `.planning/phases/40-kpi-tracking-linked-projects/40-02-SUMMARY.md`
</output>
