---
phase: 40-kpi-tracking-linked-projects
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/app/(dashboard)/objectives/page.tsx
  - src/app/api/initiatives/[id]/route.ts
  - src/components/objectives/objective-hierarchy.tsx
  - src/components/objectives/initiative-row.tsx
  - src/components/objectives/kpi-progress-bar.tsx
  - src/components/objectives/key-result-group.tsx
  - src/components/objectives/objective-group.tsx
  - src/components/kanban/initiative-detail-sheet.tsx
  - src/lib/initiative-kpi-utils.ts
autonomous: true
user_setup: []

must_haves:
  truths:
    - "User can set KPI label, target, actual, and unit on any initiative via the edit form"
    - "KPI actual auto-calculates from linked project revenue when manual override is not set"
    - "Manual override stops auto-calculation; user sees confirmation dialog before overriding"
    - "User can revert to auto-calculation, which clears manual actual and resumes revenue-based calculation"
    - "KPI progress bar displays below initiative title with green >80%, yellow 50-80%, red <50% color coding"
    - "Manual vs auto values visually distinguished with pencil (manual) vs calculator (auto) icon"
    - "KR-level and Objective-level headers show aggregated KPI totals from child initiatives"
    - "No KPI set shows grayed-out placeholder; zero target avoids division; null revenue treated as 0"
  artifacts:
    - path: "src/components/objectives/kpi-progress-bar.tsx"
      provides: "Reusable KPI progress bar with color coding and source icon"
      min_lines: 30
    - path: "src/app/(dashboard)/objectives/page.tsx"
      provides: "Expanded Prisma query with KPI fields and linked projects"
      contains: "kpiLabel"
    - path: "src/app/api/initiatives/[id]/route.ts"
      provides: "PATCH handler extended for KPI fields"
      contains: "kpiManualOverride"
    - path: "src/components/kanban/initiative-detail-sheet.tsx"
      provides: "KPI edit fields with AlertDialog confirmation and revert button"
      contains: "AlertDialog"
  key_links:
    - from: "src/app/(dashboard)/objectives/page.tsx"
      to: "prisma.initiative"
      via: "Prisma select with KPI fields + nested projects.costs"
      pattern: "kpiLabel.*kpiTarget.*kpiActual"
    - from: "src/components/objectives/initiative-row.tsx"
      to: "src/components/objectives/kpi-progress-bar.tsx"
      via: "KpiProgressBar component rendered below title"
      pattern: "KpiProgressBar"
    - from: "src/components/kanban/initiative-detail-sheet.tsx"
      to: "/api/initiatives/[id]"
      via: "PATCH with KPI fields including kpiManualOverride"
      pattern: "kpiManualOverride"
    - from: "src/components/objectives/objective-group.tsx"
      to: "src/lib/initiative-kpi-utils.ts"
      via: "aggregateKpiTotals or inline aggregation for header display"
      pattern: "kpiTarget|totalTarget"
---

<objective>
Add KPI tracking to the initiative hierarchy view: progress bar display on each initiative row, KPI edit fields in the detail sheet with manual override confirmation, aggregated KPI totals in KR/Objective headers, and auto-calculation from linked project revenue.

Purpose: Users can assess initiative health at a glance via color-coded KPI progress bars, edit KPI values with manual override protection, and see aggregated progress at KR and Objective levels.

Output: KpiProgressBar component, expanded data queries with KPI + project data, KPI edit form in detail sheet with AlertDialog confirmation and revert-to-auto, aggregated KPI in group headers.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/40-kpi-tracking-linked-projects/40-CONTEXT.md
@.planning/phases/40-kpi-tracking-linked-projects/40-RESEARCH.md
@src/app/(dashboard)/objectives/page.tsx
@src/components/objectives/objective-hierarchy.tsx
@src/components/objectives/initiative-row.tsx
@src/components/objectives/key-result-group.tsx
@src/components/objectives/objective-group.tsx
@src/components/kanban/initiative-detail-sheet.tsx
@src/app/api/initiatives/[id]/route.ts
@src/lib/initiative-kpi-utils.ts
@src/lib/initiative-group-utils.ts
@src/components/ui/progress.tsx
@src/lib/utils.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Expand data layer -- Prisma query, serialization, Initiative type, and PATCH API</name>
  <files>
    src/app/(dashboard)/objectives/page.tsx
    src/components/objectives/objective-hierarchy.tsx
    src/app/api/initiatives/[id]/route.ts
    src/lib/initiative-kpi-utils.ts
  </files>
  <action>
    **1. Expand Prisma query in `objectives/page.tsx`:**
    Add KPI fields and linked projects to the existing `select` query:
    ```
    kpiLabel: true,
    kpiTarget: true,
    kpiActual: true,
    kpiUnit: true,
    kpiManualOverride: true,
    projects: {
      select: {
        id: true,
        title: true,
        status: true,
        revenue: true,
        startDate: true,
        endDate: true,
        company: { select: { id: true, name: true } },
        costs: { select: { amount: true } },
      },
    },
    ```

    **2. Serialize Decimal fields** in the `return initiatives.map(...)` block:
    - Convert `kpiTarget` and `kpiActual` with `i.kpiTarget ? Number(i.kpiTarget) : null` pattern
    - Convert `revenue` on each project with `Number(p.revenue)` (or null)
    - Sum costs per project server-side: `p.costs.reduce((sum, c) => sum + Number(c.amount), 0)` -- send `totalCosts: number` instead of the raw costs array
    - Convert project `startDate`/`endDate` to ISO strings
    - Include `companyName: p.company?.name || null` as a flat field

    The serialized project shape should be:
    ```typescript
    { id: string, title: string, status: string, revenue: number | null, totalCosts: number, companyName: string | null, startDate: string | null, endDate: string | null }
    ```

    **3. Expand the `Initiative` interface in `objective-hierarchy.tsx`:**
    Add optional KPI fields and projects array:
    ```typescript
    kpiLabel?: string | null
    kpiTarget?: number | null
    kpiActual?: number | null
    kpiUnit?: string | null
    kpiManualOverride?: boolean
    projects?: Array<{
      id: string
      title: string
      status: string
      revenue: number | null
      totalCosts: number
      companyName: string | null
      startDate: string | null
      endDate: string | null
    }>
    ```
    Make these optional (?) so existing usage from other views (List, Kanban) that don't include these fields still compiles.

    **4. Extend the `InitiativeForGrouping` interface in `initiative-group-utils.ts`:**
    The grouping utility's `InitiativeForGrouping` interface is used in components. It needs additional optional fields so the grouped data can pass through KPI + project data. However, since the grouping function only needs id/objective/keyResult/status/title, the cleanest approach is to NOT modify `InitiativeForGrouping`. Instead, the components already cast `initiative as Initiative` when passing to InitiativeRow (see key-result-group.tsx line 76). This cast will work as long as the data flowing in from the page has the KPI fields. No changes needed to `initiative-group-utils.ts`.

    **5. Extend PATCH API in `api/initiatives/[id]/route.ts`:**
    Add KPI field handling after the existing `personInCharge` block:
    ```typescript
    if (body.kpiLabel !== undefined) {
      updateData.kpiLabel = body.kpiLabel || null
    }
    if (body.kpiTarget !== undefined) {
      updateData.kpiTarget = body.kpiTarget !== null && body.kpiTarget !== ''
        ? parseFloat(String(body.kpiTarget))
        : null
    }
    if (body.kpiActual !== undefined) {
      updateData.kpiActual = body.kpiActual !== null && body.kpiActual !== ''
        ? parseFloat(String(body.kpiActual))
        : null
    }
    if (body.kpiUnit !== undefined) {
      updateData.kpiUnit = body.kpiUnit || null
    }
    if (body.kpiManualOverride !== undefined) {
      updateData.kpiManualOverride = body.kpiManualOverride
    }
    ```

    **6. Add `aggregateKpiTotals` function to `initiative-kpi-utils.ts`:**
    Add a new exported function that takes an array of initiatives and returns `{ totalTarget: number, totalActual: number, percentage: number | null, hasData: boolean, mixedUnits: boolean }`. Sum kpiTarget and kpiActual across initiatives. If all initiatives sharing a KPI have the same unit, report that unit; if units differ, set `mixedUnits: true`. Only count initiatives that have a kpiLabel set. Use the existing `calculateKpi` function for each initiative's actual value (so auto-calc from projects is included).
  </action>
  <verify>
    - `npx tsc --noEmit` passes with no type errors
    - Visit `/objectives` page and confirm it loads without errors (check browser console)
    - `curl -X PATCH /api/initiatives/{id} -H 'Content-Type: application/json' -d '{"kpiLabel":"Revenue","kpiTarget":100,"kpiUnit":"RM"}' ` returns 200
  </verify>
  <done>
    - Objectives page fetches KPI fields + linked project data with costs aggregated server-side
    - Decimal fields properly serialized to numbers
    - Initiative interface expanded with optional KPI + project fields
    - PATCH API accepts and persists all 5 KPI fields
    - aggregateKpiTotals utility function available for header components
  </done>
</task>

<task type="auto">
  <name>Task 2: KPI progress bar, initiative row display, header aggregation, and detail sheet KPI editing</name>
  <files>
    src/components/objectives/kpi-progress-bar.tsx
    src/components/objectives/initiative-row.tsx
    src/components/objectives/key-result-group.tsx
    src/components/objectives/objective-group.tsx
    src/components/kanban/initiative-detail-sheet.tsx
  </files>
  <action>
    **1. Create `kpi-progress-bar.tsx`** -- new file in `src/components/objectives/`:
    A compact, reusable component that shows:
    - A thin progress bar (h-1.5) using shadcn/ui `<Progress>` component
    - Color-coded indicator: green (`[&>div]:bg-green-500`) for >=80%, yellow (`[&>div]:bg-yellow-500`) for >=50%, red (`[&>div]:bg-red-500`) for <50%, gray for no data
    - A small text line above the bar showing: source icon (Pencil for manual, Calculator for auto) + display text (e.g., "Revenue: 75 / 100 RM")
    - When percentage is null (no data / no KPI set): show a grayed-out bar with "No KPI set" text in muted gray
    - Cap visual bar at 100% but show actual percentage text if >100%

    Props: `{ label: string, percentage: number | null, displayText: string, source: 'auto' | 'manual', className?: string }`

    Import `calculateKpi` from `initiative-kpi-utils.ts` is NOT done in this component -- the parent passes pre-computed values.

    **2. Update `initiative-row.tsx`:**
    - Import `KpiProgressBar` and `calculateKpi` from their respective modules
    - Import `InitiativeWithKpiAndProjects` type from `initiative-kpi-utils.ts`
    - After the title paragraph, add the KpiProgressBar component
    - Compute KPI result using `calculateKpi()` by constructing the required shape from the Initiative props (the Initiative interface has optional KPI + projects fields)
    - If the initiative has no kpiLabel AND no projects (or empty projects array), the calculateKpi will return "No data" -- render a subtle gray placeholder bar
    - Keep the existing layout structure intact -- the progress bar sits below the title, above the metadata row

    **3. Add aggregated KPI display to `key-result-group.tsx` header:**
    - Import `calculateKpi` and `aggregateKpiTotals` from `initiative-kpi-utils.ts`
    - In the header (CollapsibleTrigger area), after the initiative count text, add a compact KPI summary
    - Compute aggregated totals from `keyResult.initiatives` using `aggregateKpiTotals`
    - Display format: if `hasData` is true and not mixedUnits, show "KPI: {totalActual}/{totalTarget} {unit} ({percentage}%)" in small text; if mixedUnits, show "Mixed KPIs"; if no data, show nothing extra
    - Use the same color coding (green/yellow/red) for the percentage text color
    - Cast initiatives through the type system -- `keyResult.initiatives` are `InitiativeForGrouping[]` but the actual data has KPI fields. Use type assertion or widen the input type for aggregateKpiTotals to accept minimal KPI fields.

    **4. Add aggregated KPI display to `objective-group.tsx` header:**
    - Same pattern as key-result-group but aggregating all initiatives in the objective group
    - Flatten `group.keyResults.flatMap(kr => kr.initiatives)` to get all initiatives under this objective
    - Display aggregated KPI totals in the ObjectiveGroup header after the status badges
    - Use same compact format and color coding

    **5. Add KPI edit fields to `initiative-detail-sheet.tsx`:**
    This is the most complex change. Add a "KPI Settings" section between the Quick Info Grid and the Save Button:

    a. **New state variables:**
    - `kpiLabel`, `kpiTarget`, `kpiActual`, `kpiUnit` (string states, initialized from loaded data)
    - `kpiManualOverride` (boolean state)
    - `showOverrideConfirm` (boolean for AlertDialog)
    - `pendingActual` (string to hold value before confirmation)

    b. **Load KPI data on open:**
    In the existing `useEffect` that fetches initiative data, also set the KPI states from the API response.

    c. **KPI form section (below the Quick Info Grid, above Save Button):**
    - Section header with `BarChart3` icon: "KPI Tracking"
    - If `kpiManualOverride` is true, show a small info banner: "Manual override active" with a "Revert to Auto" button
    - KPI Label: text Input (placeholder "e.g., Revenue, Completion")
    - KPI Unit: text Input (placeholder "e.g., RM, %, units")
    - KPI Target: number Input (placeholder "Target value")
    - KPI Actual: number Input (placeholder "Actual value") -- this triggers the override flow:
      - When user changes the actual value (and kpiManualOverride is currently false), set `pendingActual` and open `showOverrideConfirm` AlertDialog
      - AlertDialog title: "Override auto-calculated value?"
      - AlertDialog description: "This will set the KPI actual value manually and stop auto-calculation from linked project revenue. You can revert to auto-calculation later."
      - On confirm: set `kpiActual` to pendingActual, set `kpiManualOverride` to true, close dialog
      - On cancel: revert input to previous value, close dialog
    - If kpiManualOverride is already true, editing actual does NOT re-show the dialog (user already confirmed)

    d. **"Revert to Auto" button logic:**
    When clicked, PATCH with `kpiManualOverride: false, kpiActual: null`. Update local state accordingly. Show a brief confirmation or just update the UI immediately.

    e. **Extend `handleSave`:**
    Include KPI fields in the PATCH body alongside status and personInCharge. Send `kpiLabel`, `kpiTarget`, `kpiActual`, `kpiUnit`, and `kpiManualOverride`.

    f. **Extend `hasChanges` logic:**
    Also detect changes to KPI fields to enable the Save button.

    g. **Import AlertDialog components** from `@/components/ui/alert-dialog`. Import `BarChart3` icon from lucide-react. Import `Input` from `@/components/ui/input`.

    h. **Update the internal `Initiative` interface** in this file to include optional KPI fields: `kpiLabel?: string | null`, `kpiTarget?: number | null`, `kpiActual?: number | null`, `kpiUnit?: string | null`, `kpiManualOverride?: boolean`.

    IMPORTANT: The `initiative` prop passed to the detail sheet comes from the hierarchy view's Initiative type (which now has optional KPI fields). The detail sheet also fetches full data via GET API on open. The KPI fields will be present in the GET response because the Initiative model includes them. Initialize KPI state from the fetched data (not from the prop, since the prop may have partial data).
  </action>
  <verify>
    - `npx tsc --noEmit` passes with no type errors
    - Visit `/objectives` page: each initiative row shows a thin KPI progress bar below the title
    - Initiatives with no KPI or projects show a grayed-out "No KPI set" bar
    - KR headers and Objective headers show aggregated KPI totals
    - Click an initiative to open the detail sheet: KPI Settings section visible with label, target, actual, unit fields
    - Type a value in KPI Actual when override is off: AlertDialog appears asking for confirmation
    - Confirm override: value is saved, pencil icon appears on the progress bar in the row
    - Click "Revert to Auto": override clears, calculator icon appears, auto-calculated value from projects shown
    - Color coding: set target=100, actual=90 -> green bar; actual=60 -> yellow bar; actual=30 -> red bar
  </verify>
  <done>
    - KpiProgressBar component renders with color-coded progress and manual/auto icon
    - Every initiative row displays KPI progress bar below the title
    - KR-level and Objective-level headers show aggregated KPI totals
    - Detail sheet has KPI edit fields with AlertDialog manual override confirmation
    - "Revert to Auto" button clears override and resumes auto-calculation
    - All edge cases handled: no KPI, no projects, zero target, null revenue, >100% progress
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` -- no TypeScript errors
2. `npm run build` -- production build succeeds
3. Visit `/objectives` page:
   - Initiative rows show KPI progress bars with correct color coding
   - KR and Objective headers show aggregated KPI totals
   - Click initiative -> detail sheet shows KPI Settings section
   - Edit KPI actual when override is off -> AlertDialog confirmation appears
   - Save KPI values -> refresh page -> values persist
   - "Revert to Auto" button works
4. Edge cases:
   - Initiative with no KPI set: grayed-out placeholder bar
   - Initiative with projects but no manual KPI: auto-calculated revenue shown with calculator icon
   - Zero target: no division error, shows absolute value
   - KPI actual > target: bar capped at 100%, text shows actual percentage
</verification>

<success_criteria>
- KPI-01: Initiative has editable KPI fields (label, target, actual, unit) in the detail sheet
- KPI-02: Auto-calculation from linked project revenue when manual override is not set
- KPI-03: Manual override sets flag, prevents auto-calculation overwrite, confirmed via AlertDialog
- KPI-04: Progress bar with green/yellow/red color coding displays on every initiative row
- KPI-05: KR-level and Objective-level headers show aggregated KPI totals
- KPI-06: Null/zero edge cases handled gracefully (no data, zero target, null revenue)
- KPI-07: Manual (pencil icon) vs auto (calculator icon) values visually distinguished
</success_criteria>

<output>
After completion, create `.planning/phases/40-kpi-tracking-linked-projects/40-01-SUMMARY.md`
</output>
