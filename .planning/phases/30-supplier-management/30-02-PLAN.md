---
phase: 30-supplier-management
plan: 02
type: execute
wave: 2
depends_on: ["30-01"]
files_modified:
  - src/app/api/suppliers/[id]/route.ts
  - src/components/suppliers/supplier-detail-modal.tsx
  - src/components/suppliers/supplier-select.tsx
  - src/components/projects/cost-form.tsx
  - src/components/projects/cost-card.tsx
  - src/app/api/projects/[id]/costs/route.ts
  - src/app/api/projects/[id]/costs/[costId]/route.ts
autonomous: true

must_haves:
  truths:
    - "User can link supplier when creating/editing project cost"
    - "Cost card shows supplier name when linked"
    - "Supplier detail page shows total spend (sum of linked costs)"
    - "Supplier detail page shows price list (all linked cost items)"
    - "Supplier detail page shows projects worked on (unique from costs)"
  artifacts:
    - path: "src/components/suppliers/supplier-select.tsx"
      provides: "Searchable combobox for selecting supplier in cost form"
      min_lines: 80
    - path: "src/components/projects/cost-form.tsx"
      provides: "Extended cost form with optional supplier field"
      contains: "SupplierSelect"
    - path: "src/components/projects/cost-card.tsx"
      provides: "Cost card showing supplier name badge"
      contains: "supplier"
    - path: "src/app/api/suppliers/[id]/route.ts"
      provides: "Extended GET with costs, totalSpend, projects"
      contains: "totalSpend"
  key_links:
    - from: "src/components/projects/cost-form.tsx"
      to: "src/components/suppliers/supplier-select.tsx"
      via: "import and render"
      pattern: "SupplierSelect"
    - from: "src/components/projects/cost-form.tsx"
      to: "/api/projects/[id]/costs"
      via: "POST/PATCH with supplierId"
      pattern: "supplierId"
    - from: "src/components/suppliers/supplier-detail-modal.tsx"
      to: "/api/suppliers/[id]"
      via: "fetch with costs and projects data"
      pattern: "totalSpend|projects"
---

<objective>
Link suppliers to project costs and display spend analytics on supplier detail page

Purpose: Enable tracking of purchases per supplier and aggregate spend visibility (SUPP-06 to SUPP-09)
Output: Cost form includes supplier selection, supplier detail shows total spend and price list
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/30-supplier-management/30-RESEARCH.md
@.planning/phases/30-supplier-management/30-01-SUMMARY.md

# Files to extend
@src/components/projects/cost-form.tsx
@src/components/projects/cost-card.tsx
@src/app/api/projects/[id]/costs/route.ts
@src/app/api/projects/[id]/costs/[costId]/route.ts
@src/components/suppliers/supplier-detail-modal.tsx
@src/app/api/suppliers/[id]/route.ts

# Patterns to follow
@src/components/pipeline/company-select.tsx
@prisma/schema.prisma
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create supplier select and extend cost form</name>
  <files>
    src/components/suppliers/supplier-select.tsx
    src/components/projects/cost-form.tsx
    src/app/api/projects/[id]/costs/route.ts
    src/app/api/projects/[id]/costs/[costId]/route.ts
  </files>
  <action>
Create supplier select component and extend cost form to include supplier:

1. Create `src/components/suppliers/supplier-select.tsx`:
   - Client component following `pipeline/company-select.tsx` combobox pattern
   - Props: `value: string | null`, `onValueChange: (value: string | null) => void`, `disabled?: boolean`
   - State: open (popover), suppliers[], isLoading
   - Fetch suppliers from `/api/suppliers` when popover opens (lazy load)
   - Use Command component (cmdk) with CommandInput for search
   - Show Truck icon next to supplier names
   - Include clear button (X) when value is selected
   - Placeholder: "Select supplier (optional)"

2. Extend `src/components/projects/cost-form.tsx`:
   - Add import for SupplierSelect
   - Update Cost interface to include `supplierId?: string | null`
   - Add state: `const [supplierId, setSupplierId] = useState<string | null>(cost?.supplierId || null)`
   - Add to form body after Category select:
     ```tsx
     <div className="space-y-2">
       <Label>Supplier</Label>
       <SupplierSelect
         value={supplierId}
         onValueChange={setSupplierId}
       />
       <p className="text-xs text-muted-foreground">
         Optional: Link this cost to a supplier for spend tracking
       </p>
     </div>
     ```
   - Update JSON.stringify in handleSubmit to include: `supplierId: supplierId || null`

3. Update `src/app/api/projects/[id]/costs/route.ts`:
   - In POST handler, add `supplierId: body.supplierId || null` to prisma.cost.create data
   - Update include to add: `supplier: { select: { id: true, name: true } }`
   - In GET handler, add supplier to include as well

4. Update `src/app/api/projects/[id]/costs/[costId]/route.ts`:
   - In PATCH handler, add supplierId to data (if provided in body)
   - Update include to add: `supplier: { select: { id: true, name: true } }`
   - In GET handler (if exists), add supplier to include
  </action>
  <verify>
Run `npm run build` - should complete without errors.
Navigate to a project detail page and add a new cost - supplier select should appear.
  </verify>
  <done>
Cost form shows optional supplier selection. Cost API accepts and returns supplierId with supplier object.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update cost card to show supplier and extend supplier detail API</name>
  <files>
    src/components/projects/cost-card.tsx
    src/app/api/suppliers/[id]/route.ts
  </files>
  <action>
Show supplier on cost cards and extend supplier detail API with spend data:

1. Update `src/components/projects/cost-card.tsx`:
   - Update Cost interface to include: `supplier?: { id: string; name: string } | null`
   - Add Truck import from lucide-react
   - After the category badge and AI badge, add supplier display:
     ```tsx
     {cost.supplier && (
       <div className="flex items-center gap-1 text-xs text-gray-500">
         <Truck className="h-3 w-3" />
         {cost.supplier.name}
       </div>
     )}
     ```
   - Consider showing it in a separate line below description if there's not enough space

2. Extend `src/app/api/suppliers/[id]/route.ts` GET handler:
   - Include costs with full details:
     ```typescript
     costs: {
       select: {
         id: true,
         description: true,
         amount: true,
         date: true,
         category: { select: { id: true, name: true } },
         project: {
           select: {
             id: true,
             title: true,
             company: { select: { id: true, name: true } },
           }
         },
       },
       orderBy: { date: 'desc' },
     }
     ```
   - After fetching, calculate totalSpend:
     ```typescript
     const totalSpend = supplier.costs.reduce(
       (sum, cost) => sum + Number(cost.amount),
       0
     )
     ```
   - Extract unique projects from costs:
     ```typescript
     const projectMap = new Map()
     supplier.costs.forEach((cost) => {
       if (cost.project && !projectMap.has(cost.project.id)) {
         projectMap.set(cost.project.id, {
           id: cost.project.id,
           title: cost.project.title,
           company: cost.project.company,
         })
       }
     })
     const projects = Array.from(projectMap.values())
     ```
   - Serialize costs (convert Decimal to Number):
     ```typescript
     const serializedCosts = supplier.costs.map((cost) => ({
       ...cost,
       amount: Number(cost.amount),
     }))
     ```
   - Return extended response:
     ```typescript
     return NextResponse.json({
       ...supplier,
       costs: serializedCosts,
       totalSpend,
       projects,
     })
     ```
  </action>
  <verify>
Run `npm run build` - should complete without errors.
Create a cost with supplier linked - cost card shows supplier name.
Call GET /api/suppliers/[id] - response includes costs array, totalSpend number, and projects array.
  </verify>
  <done>
Cost cards display supplier name. Supplier detail API returns costs, totalSpend, and projects.
  </done>
</task>

<task type="auto">
  <name>Task 3: Extend supplier detail modal with spend analytics</name>
  <files>
    src/components/suppliers/supplier-detail-modal.tsx
  </files>
  <action>
Update supplier detail modal to show total spend, price list, and projects:

1. Update the Supplier interface in the component to include:
   ```typescript
   interface SupplierCost {
     id: string
     description: string
     amount: number
     date: string
     category: { id: string; name: string }
     project: {
       id: string
       title: string
       company: { id: string; name: string } | null
     } | null
   }

   interface SupplierProject {
     id: string
     title: string
     company: { id: string; name: string } | null
   }

   interface Supplier {
     // ... existing fields
     costs: SupplierCost[]
     totalSpend: number
     projects: SupplierProject[]
   }
   ```

2. Add imports:
   - DollarSign from lucide-react
   - formatCurrency, formatDate from @/lib/utils
   - Card from @/components/ui/card
   - Badge from @/components/ui/badge
   - getCategoryColor from @/lib/cost-utils

3. After Notes section and Separator, add Financial Summary section:
   ```tsx
   {/* Financial Summary */}
   <div className="space-y-4">
     <h3 className="font-medium text-gray-900">Financial Summary</h3>

     {/* Total Spend Card */}
     <Card className="p-4 bg-blue-50 border-blue-200">
       <div className="flex items-center gap-2">
         <DollarSign className="h-5 w-5 text-blue-600" />
         <div className="text-sm text-blue-600 font-medium">Total Spend</div>
       </div>
       <div className="text-2xl font-bold text-blue-700 mt-1">
         {formatCurrency(supplier.totalSpend)}
       </div>
       <div className="text-xs text-blue-600/70 mt-0.5">
         From {supplier.costs.length} purchase{supplier.costs.length !== 1 ? 's' : ''}
       </div>
     </Card>
   </div>
   ```

4. Add Price List section (after Financial Summary):
   ```tsx
   {/* Price List */}
   {supplier.costs.length > 0 && (
     <div className="space-y-3">
       <h3 className="font-medium text-gray-900">
         Price List
         <span className="ml-2 text-sm font-normal text-gray-500">
           ({supplier.costs.length} items)
         </span>
       </h3>
       <div className="space-y-2 max-h-48 overflow-y-auto">
         {supplier.costs.map((cost) => (
           <div
             key={cost.id}
             className="flex items-center justify-between p-2 border rounded-lg bg-white text-sm"
           >
             <div className="flex-1 min-w-0">
               <div className="flex items-center gap-2">
                 <span className="truncate font-medium">{cost.description}</span>
                 <Badge variant="outline" className={getCategoryColor(cost.category.name)}>
                   {cost.category.name}
                 </Badge>
               </div>
               <div className="text-xs text-gray-500 mt-0.5">
                 {formatDate(cost.date)}
                 {cost.project && ` - ${cost.project.title}`}
               </div>
             </div>
             <div className="font-medium text-gray-900 ml-2">
               {formatCurrency(cost.amount)}
             </div>
           </div>
         ))}
       </div>
     </div>
   )}
   ```

5. Add Projects Worked On section (after Price List):
   ```tsx
   {/* Projects Worked On */}
   {supplier.projects.length > 0 && (
     <div className="space-y-3">
       <h3 className="font-medium text-gray-900">
         Projects Worked On
         <span className="ml-2 text-sm font-normal text-gray-500">
           ({supplier.projects.length})
         </span>
       </h3>
       <div className="space-y-1">
         {supplier.projects.map((project) => (
           <div
             key={project.id}
             className="flex items-center justify-between text-sm py-1"
           >
             <span className="truncate">{project.title}</span>
             {project.company && (
               <span className="text-xs text-gray-500 ml-2">
                 {project.company.name}
               </span>
             )}
           </div>
         ))}
       </div>
     </div>
   )}
   ```

6. Handle empty state:
   - If no costs linked, show a subtle message in Financial Summary: "No purchases recorded yet"
  </action>
  <verify>
Run `npm run build` - should complete without errors.
Run `npm run dev` and test:
1. Go to a project and add a cost with supplier linked
2. Navigate to /suppliers and click on that supplier
3. Detail modal shows:
   - Total Spend card with correct sum
   - Price List with cost items
   - Projects Worked On with project name
4. Add more costs to same supplier - totals update correctly
  </verify>
  <done>
Supplier detail modal shows total spend, price list of all purchases, and projects worked on.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. Build verification:
   - `npm run build` completes without errors

2. Cost-Supplier linking flow:
   - Navigate to any project
   - Add cost with supplier selected
   - Cost card shows supplier name with Truck icon
   - Edit cost - supplier can be changed
   - Add cost without supplier - works normally

3. Supplier detail analytics:
   - Navigate to /suppliers
   - Click on supplier with linked costs
   - Total Spend shows correct sum of all linked costs
   - Price List shows each cost item with description, amount, date, category, project
   - Projects Worked On shows unique projects (no duplicates even if multiple costs per project)
   - All amounts formatted as currency (RM)

4. Edge cases:
   - Supplier with no costs: Total Spend shows RM 0.00, "No purchases recorded yet" or empty sections
   - Cost linked to deleted supplier: Cost should still work (supplierId becomes null, or supplier field is null)
</verification>

<success_criteria>
- Cost form has optional Supplier select field (SUPP-06)
- Cost card displays linked supplier name
- Supplier detail shows total spend sum (SUPP-07)
- Supplier detail shows price list of all cost items (SUPP-08)
- Supplier detail shows projects worked on (SUPP-09)
- All Decimal amounts converted to Number for display
- TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/30-supplier-management/30-02-SUMMARY.md`
</output>
