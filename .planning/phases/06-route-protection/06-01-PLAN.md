---
phase: 06-route-protection
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/auth-utils.ts
  - src/app/(auth)/forbidden/page.tsx
  - src/auth.config.ts
  - src/middleware.ts
autonomous: true

must_haves:
  truths:
    - "Non-admin user visiting /admin/* sees forbidden page"
    - "Forbidden page displays explicit permission denied message"
    - "API routes can use requireAuth() to get session or 401 error"
    - "API routes can use requireRole() to check permissions or get 403 error"
  artifacts:
    - path: "src/lib/auth-utils.ts"
      provides: "Auth utility functions for API protection"
      exports: ["requireAuth", "requireRole", "requireAdmin", "requireEditor", "unauthorizedResponse", "forbiddenResponse"]
    - path: "src/app/(auth)/forbidden/page.tsx"
      provides: "403 Forbidden page for role-based access denial"
      min_lines: 20
    - path: "src/auth.config.ts"
      provides: "Enhanced middleware config with admin route blocking"
      contains: "pathname.startsWith(\"/admin\")"
  key_links:
    - from: "src/auth.config.ts"
      to: "/forbidden"
      via: "Response.redirect for non-admin /admin/* access"
      pattern: "redirect.*forbidden"
    - from: "src/lib/auth-utils.ts"
      to: "src/auth.ts"
      via: "auth() import for session"
      pattern: "import.*auth.*from.*@/auth"
---

<objective>
Create auth utility functions and forbidden page to enable API route protection and admin route blocking.

Purpose: Foundation for all route protection - reusable utilities for consistent 401/403 responses, forbidden page for role-based denial, and middleware enhancement for /admin/* blocking.

Output: `src/lib/auth-utils.ts`, `src/app/(auth)/forbidden/page.tsx`, updated `src/auth.config.ts` and `src/middleware.ts`
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-route-protection/06-RESEARCH.md
@.planning/phases/06-route-protection/06-CONTEXT.md

# Existing auth files to reference
@src/auth.ts
@src/auth.config.ts
@src/middleware.ts
@src/app/(auth)/access-denied/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create auth utilities module</name>
  <files>src/lib/auth-utils.ts</files>
  <action>
Create `src/lib/auth-utils.ts` with the following exports:

1. `unauthorizedResponse(message?)` - Returns NextResponse.json with 401 status
   - Default message: "Authentication required"
   - Body format: `{ error: "Unauthorized", message }`

2. `forbiddenResponse(message?)` - Returns NextResponse.json with 403 status
   - Default message: "You don't have permission to access this resource"
   - Body format: `{ error: "Forbidden", message }`

3. `requireAuth()` - Async function that:
   - Calls `auth()` from `@/auth`
   - If no session, logs "[AUTH] Unauthorized API access attempt" and returns `{ session: null, error: unauthorizedResponse() }`
   - If session exists, returns `{ session, error: null }`
   - Return type should be discriminated union for type safety

4. `requireRole(...allowedRoles: UserRole[])` - Async function that:
   - Calls `auth()` from `@/auth`
   - If no session, logs and returns 401
   - If session.user.role not in allowedRoles, logs "[AUTH] Forbidden: {email} ({role}) requires {allowedRoles}" and returns 403
   - If authorized, returns `{ session, error: null }`

5. `requireAdmin()` - Convenience wrapper for `requireRole(UserRole.ADMIN)`

6. `requireEditor()` - Convenience wrapper for `requireRole(UserRole.ADMIN, UserRole.EDITOR)`

Import `UserRole` from `@prisma/client`. Import `Session` from `next-auth` for typing.
  </action>
  <verify>`npx tsc --noEmit` passes with no errors in auth-utils.ts</verify>
  <done>Auth utilities module exists with all 6 exports, TypeScript compiles cleanly</done>
</task>

<task type="auto">
  <name>Task 2: Create forbidden page</name>
  <files>src/app/(auth)/forbidden/page.tsx</files>
  <action>
Create `src/app/(auth)/forbidden/page.tsx` modeled after the existing access-denied page.

Use the same Card-based layout with:
- ShieldAlert icon from lucide-react (orange color scheme to differentiate from red access-denied)
- Title: "Access Forbidden"
- Description: "You don't have permission to access this page."
- Body text: "This area is restricted to administrators only. Contact your admin if you believe this is an error."
- Button: "Return to Dashboard" linking to "/"

Per CONTEXT.md decision: Explicit permission denied message, not silent redirect.
  </action>
  <verify>File exists at `src/app/(auth)/forbidden/page.tsx` and exports default function</verify>
  <done>Forbidden page renders with explicit 403 messaging, consistent with app styling</done>
</task>

<task type="auto">
  <name>Task 3: Enhance middleware for admin route blocking</name>
  <files>src/auth.config.ts, src/middleware.ts</files>
  <action>
Update `src/auth.config.ts` authorized callback:

1. Add `/forbidden` to public paths (alongside /login, /access-denied)
2. Add admin route blocking logic:
   - If `pathname.startsWith("/admin")` AND user role is NOT "ADMIN":
   - Log: `[AUTH] Admin access denied: {email} ({role}) -> {pathname}`
   - Return `Response.redirect(new URL("/forbidden", nextUrl))`

Important: Check for admin route AFTER confirming user is logged in (auth check first, then role check).

Update `src/middleware.ts` matcher:
- Add `forbidden` to the exclusion pattern alongside `login|access-denied`
- Pattern should become: `"/((?!login|access-denied|forbidden|api/auth|_next/static|_next/image|favicon.ico|images).*)"`
  </action>
  <verify>
1. `npx tsc --noEmit` passes
2. Middleware matcher includes forbidden in exclusion pattern
3. auth.config.ts has admin route check with redirect to /forbidden
  </verify>
  <done>Middleware blocks non-admin /admin/* access with redirect to /forbidden page</done>
</task>

</tasks>

<verification>
After all tasks complete:
1. `npm run build` succeeds (full build verification)
2. Auth utilities can be imported: `import { requireAuth, requireRole } from '@/lib/auth-utils'`
3. Forbidden page accessible at /forbidden (no redirect loop)
4. Manual test: Admin route protection ready (will be fully testable after Phase 7 creates /admin/* routes)
</verification>

<success_criteria>
- `src/lib/auth-utils.ts` exports requireAuth, requireRole, requireAdmin, requireEditor, unauthorizedResponse, forbiddenResponse
- `src/app/(auth)/forbidden/page.tsx` renders 403 page with explicit message
- `src/auth.config.ts` redirects non-admin /admin/* to /forbidden
- `src/middleware.ts` excludes /forbidden from auth requirement
- TypeScript compiles with no errors
</success_criteria>

<output>
After completion, create `.planning/phases/06-route-protection/06-01-SUMMARY.md`
</output>
