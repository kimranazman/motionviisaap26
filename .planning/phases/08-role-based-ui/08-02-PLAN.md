---
phase: 08-role-based-ui
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/initiatives/initiative-detail.tsx
  - src/components/kanban/initiative-detail-sheet.tsx
  - src/components/permission-denied-dialog.tsx
autonomous: true

must_haves:
  truths:
    - "VIEWER cannot see status dropdown (shows read-only badge instead)"
    - "VIEWER cannot see Person In Charge dropdown (shows read-only text)"
    - "VIEWER cannot see remarks textarea (shows read-only text or hidden)"
    - "VIEWER CAN see and use comment form (add comments)"
    - "VIEWER cannot see comment delete button"
    - "EDITOR and ADMIN see all edit controls and delete buttons"
    - "403 API error shows permission denied dialog"
  artifacts:
    - path: "src/components/initiatives/initiative-detail.tsx"
      provides: "Role-aware initiative detail page"
      contains: "useSession"
    - path: "src/components/kanban/initiative-detail-sheet.tsx"
      provides: "Role-aware initiative detail sheet"
      contains: "useSession"
    - path: "src/components/permission-denied-dialog.tsx"
      provides: "Permission denied modal"
      exports: ["PermissionDeniedDialog"]
  key_links:
    - from: "src/components/initiatives/initiative-detail.tsx"
      to: "src/lib/permissions.ts"
      via: "import { canEdit }"
      pattern: "canEdit.*session"
    - from: "initiative-detail.tsx"
      to: "permission-denied-dialog.tsx"
      via: "import PermissionDeniedDialog"
      pattern: "setShowPermissionDenied.*true"
---

<objective>
Add role-based controls to initiative detail views and create permission denied dialog.

Purpose: VIEWERs see read-only views of initiative details. Edit controls hidden except comment form (VIEWERs can add comments per CONTEXT.md). 403 errors show dialog.
Output: Role-aware detail components and permission denied dialog
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-role-based-ui/08-RESEARCH.md
@.planning/phases/08-role-based-ui/08-CONTEXT.md
@src/components/initiatives/initiative-detail.tsx
@src/components/kanban/initiative-detail-sheet.tsx
@src/components/ui/dialog.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create PermissionDeniedDialog component</name>
  <files>src/components/permission-denied-dialog.tsx</files>
  <action>
Create a reusable permission denied dialog component:

```typescript
'use client'

import { useRouter } from 'next/navigation'
import {
  Dialog,
  DialogContent,
  DialogDescription,
  DialogFooter,
  DialogHeader,
  DialogTitle,
} from '@/components/ui/dialog'
import { Button } from '@/components/ui/button'
import { ShieldAlert } from 'lucide-react'

interface PermissionDeniedDialogProps {
  open: boolean
  onOpenChange: (open: boolean) => void
  requiredRole?: 'editor' | 'admin'
  redirectTo?: string
}

export function PermissionDeniedDialog({
  open,
  onOpenChange,
  requiredRole = 'editor',
  redirectTo,
}: PermissionDeniedDialogProps) {
  const router = useRouter()

  const handleDismiss = () => {
    onOpenChange(false)
    if (redirectTo) {
      router.push(redirectTo)
    }
  }

  const roleText = requiredRole === 'admin' ? 'Admin' : 'Editor or Admin'

  return (
    <Dialog open={open} onOpenChange={onOpenChange}>
      <DialogContent className="sm:max-w-md">
        <DialogHeader>
          <div className="flex items-center gap-3">
            <div className="flex h-10 w-10 items-center justify-center rounded-full bg-red-100">
              <ShieldAlert className="h-5 w-5 text-red-600" />
            </div>
            <DialogTitle>Permission Denied</DialogTitle>
          </div>
          <DialogDescription className="pt-2">
            You don&apos;t have permission to perform this action.
            This requires {roleText} role.
          </DialogDescription>
        </DialogHeader>
        <DialogFooter>
          <Button onClick={handleDismiss} className="w-full sm:w-auto">
            OK
          </Button>
        </DialogFooter>
      </DialogContent>
    </Dialog>
  )
}
```

Per CONTEXT.md: Dialog must require user to dismiss (click OK) before optionally redirecting.
  </action>
  <verify>File exists at src/components/permission-denied-dialog.tsx and exports PermissionDeniedDialog</verify>
  <done>PermissionDeniedDialog component available for import</done>
</task>

<task type="auto">
  <name>Task 2: Add role-based controls to initiative detail components</name>
  <files>src/components/initiatives/initiative-detail.tsx, src/components/kanban/initiative-detail-sheet.tsx</files>
  <action>
**IMPORTANT CONTEXT RULE:** Per CONTEXT.md:
- VIEWERs CAN add comments (participation allowed)
- VIEWERs CANNOT edit fields or delete comments
- VIEWERs CANNOT see edit controls (status, PIC, remarks)

**In initiative-detail.tsx:**

1. Add imports:
   ```typescript
   import { useSession } from 'next-auth/react'
   import { canEdit } from '@/lib/permissions'
   import { PermissionDeniedDialog } from '@/components/permission-denied-dialog'
   ```

2. At top of InitiativeDetail component:
   ```typescript
   const { data: session, status: sessionStatus } = useSession()
   const userCanEdit = canEdit(session?.user?.role)
   const [showPermissionDenied, setShowPermissionDenied] = useState(false)
   ```

3. For Status field (around line 254-279), replace Select with conditional:
   ```typescript
   {/* Status - Editable only for Editor/Admin */}
   <div className="space-y-1.5">
     <label className="text-xs font-medium text-gray-500 flex items-center gap-1.5">
       <Target className="h-3.5 w-3.5" />
       Status
     </label>
     {userCanEdit ? (
       <Select value={status} onValueChange={setStatus}>
         {/* existing Select content */}
       </Select>
     ) : (
       <div className="h-9 px-3 flex items-center text-sm bg-gray-50 rounded-md border">
         <span className={cn('px-2 py-0.5 rounded text-xs', getStatusColor(initiative.status))}>
           {STATUS_OPTIONS.find(o => o.value === initiative.status)?.label}
         </span>
       </div>
     )}
   </div>
   ```

4. For Person In Charge field (around line 281-305), same pattern:
   ```typescript
   {userCanEdit ? (
     <Select ...>...</Select>
   ) : (
     <div className="h-9 px-3 flex items-center text-sm bg-gray-50 rounded-md border">
       {initiative.personInCharge ? formatTeamMember(initiative.personInCharge) : 'Unassigned'}
     </div>
   )}
   ```

5. For Remarks Card (around line 354-370):
   - If userCanEdit: show Textarea
   - If !userCanEdit: show read-only div with remarks text (or "No remarks" if empty)
   ```typescript
   {userCanEdit ? (
     <Textarea ... />
   ) : (
     <div className="text-sm text-gray-700 min-h-[100px] p-3 bg-gray-50 rounded-md border">
       {remarks || <span className="text-gray-400">No remarks</span>}
     </div>
   )}
   ```

6. Comment section modifications:
   - Keep comment input form visible for ALL users (VIEWERs CAN add comments)
   - Only hide the delete button for VIEWERs (around line 475-481):
   ```typescript
   {userCanEdit && (
     <Button
       variant="ghost"
       size="icon"
       className="h-6 w-6 opacity-0 group-hover:opacity-100 transition-opacity"
       onClick={() => handleDeleteComment(comment.id)}
     >
       <Trash2 className="h-3.5 w-3.5 text-gray-400 hover:text-red-500" />
     </Button>
   )}
   ```

7. Save button already only shows when hasChanges - no change needed, but note:
   - Since VIEWERs can't change status/PIC/remarks, hasChanges will always be false for them
   - Save button naturally won't appear

8. Add 403 handling to save functions (handleSave, handleSubmitComment, handleDeleteComment):
   ```typescript
   if (response.status === 403) {
     setShowPermissionDenied(true)
     return
   }
   ```

9. Add PermissionDeniedDialog at end of component JSX (before closing div):
   ```typescript
   <PermissionDeniedDialog
     open={showPermissionDenied}
     onOpenChange={setShowPermissionDenied}
   />
   ```

**In initiative-detail-sheet.tsx:**

Apply same pattern:
1. Add useSession and canEdit imports
2. Derive userCanEdit from session
3. Status Select -> conditional (Select or read-only div)
4. Person In Charge Select -> conditional
5. Comment delete button -> wrap in {userCanEdit && ...}
6. Keep comment form visible for all (VIEWERs can add comments)
7. Add 403 handling to handleSave, handleSubmitComment, handleDeleteComment
8. Add PermissionDeniedDialog
  </action>
  <verify>
1. Log in as VIEWER, visit initiative detail page:
   - Status shows as badge (not dropdown)
   - PIC shows as text (not dropdown)
   - Remarks shows as read-only text
   - Comment form IS visible and works
   - Comment delete buttons NOT visible
2. Log in as EDITOR, same page:
   - All dropdowns/textareas editable
   - Delete buttons visible
3. npm run build passes
  </verify>
  <done>
- VIEWER sees read-only status, PIC, remarks
- VIEWER can add comments but cannot delete
- EDITOR/ADMIN has full edit access
- 403 errors show dialog
  </done>
</task>

</tasks>

<verification>
1. Build passes: `npm run build`
2. Manual test as VIEWER on /initiatives/[id]:
   - Status: read-only badge
   - Person In Charge: read-only text
   - Remarks: read-only text
   - Comment form: visible and functional
   - Comment delete: NOT visible
3. Manual test as EDITOR: full edit controls
4. Test 403 handling: API returns 403 -> dialog appears
</verification>

<success_criteria>
- [ ] PermissionDeniedDialog component exists
- [ ] initiative-detail.tsx has conditional edit controls
- [ ] initiative-detail-sheet.tsx has conditional edit controls
- [ ] Comment form visible for ALL roles (VIEWERs can add comments)
- [ ] Comment delete button only visible for EDITOR/ADMIN
- [ ] 403 API responses trigger permission dialog
- [ ] Build passes without errors
</success_criteria>

<output>
After completion, create `.planning/phases/08-role-based-ui/08-02-SUMMARY.md`
</output>
