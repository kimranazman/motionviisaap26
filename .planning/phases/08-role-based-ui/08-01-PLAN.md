---
phase: 08-role-based-ui
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/permissions.ts
  - src/components/kanban/kanban-card.tsx
  - src/components/kanban/kanban-board.tsx
autonomous: true

must_haves:
  truths:
    - "VIEWER cannot drag Kanban cards"
    - "VIEWER does not see quick action menu on Kanban cards"
    - "EDITOR and ADMIN can drag cards and see quick action menu"
  artifacts:
    - path: "src/lib/permissions.ts"
      provides: "Permission check utilities"
      exports: ["canEdit", "isAdmin"]
    - path: "src/components/kanban/kanban-card.tsx"
      provides: "Role-aware Kanban card"
      contains: "canEdit"
    - path: "src/components/kanban/kanban-board.tsx"
      provides: "Passes canEdit to cards"
      contains: "useSession"
  key_links:
    - from: "src/components/kanban/kanban-board.tsx"
      to: "src/lib/permissions.ts"
      via: "import { canEdit }"
      pattern: "canEdit.*session"
    - from: "src/components/kanban/kanban-card.tsx"
      to: "useSortable"
      via: "disabled prop"
      pattern: "disabled.*!canEdit"
---

<objective>
Create permission utilities and add role-based controls to Kanban board.

Purpose: VIEWERs should see Kanban cards but cannot drag them or use quick actions. EDITOR/ADMIN can drag and use all controls.
Output: Permission utils and role-aware Kanban components
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-role-based-ui/08-RESEARCH.md
@.planning/phases/08-role-based-ui/08-CONTEXT.md
@src/components/kanban/kanban-card.tsx
@src/components/kanban/kanban-board.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create permission utilities</name>
  <files>src/lib/permissions.ts</files>
  <action>
Create permission utility functions for client-side role checks:

```typescript
import { UserRole } from "@prisma/client"

/**
 * Check if user role can edit content (ADMIN or EDITOR)
 */
export function canEdit(role: UserRole | undefined): boolean {
  if (!role) return false
  return role === UserRole.ADMIN || role === UserRole.EDITOR
}

/**
 * Check if user role is admin
 */
export function isAdmin(role: UserRole | undefined): boolean {
  return role === UserRole.ADMIN
}
```

Keep it simple - just pure functions that check roles. No hooks here.
  </action>
  <verify>File exists at src/lib/permissions.ts with both functions exported</verify>
  <done>canEdit() and isAdmin() functions available for import</done>
</task>

<task type="auto">
  <name>Task 2: Add role-based controls to Kanban components</name>
  <files>src/components/kanban/kanban-card.tsx, src/components/kanban/kanban-board.tsx</files>
  <action>
**In kanban-board.tsx:**

1. Add imports:
   ```typescript
   import { useSession } from 'next-auth/react'
   import { canEdit } from '@/lib/permissions'
   ```

2. At top of KanbanBoard component, get session and derive canEdit:
   ```typescript
   const { data: session } = useSession()
   const userCanEdit = canEdit(session?.user?.role)
   ```

3. Pass canEdit prop to all KanbanCard instances (there are multiple render sites):
   - In the SortableContext map (~line 500): `<KanbanCard ... canEdit={userCanEdit} />`
   - In the DragOverlay (~line 516): `<KanbanCard ... canEdit={userCanEdit} />`
   - In KanbanSwimlaneView if it renders cards (check if needed)

**In kanban-card.tsx:**

1. Add canEdit to KanbanCardProps interface:
   ```typescript
   interface KanbanCardProps {
     // ... existing props
     canEdit?: boolean  // Optional for backward compatibility
   }
   ```

2. Destructure in function signature:
   ```typescript
   export function KanbanCard({ item, isDragging, onClick, onStatusChange, onReassign, canEdit = true }: KanbanCardProps)
   ```

3. Add disabled to useSortable:
   ```typescript
   const { ... } = useSortable({
     id: item.id,
     disabled: !canEdit  // Disable drag when user cannot edit
   })
   ```

4. Only attach drag listeners when canEdit:
   ```typescript
   const dragListeners = canEdit ? listeners : {}
   ```
   And spread dragListeners instead of listeners: `{...dragListeners}`

5. Update cursor class conditionally:
   ```typescript
   className={cn(
     'group relative bg-white rounded-2xl ...',
     canEdit && 'cursor-grab active:cursor-grabbing touch-none',
     !canEdit && 'cursor-default',
     // ... rest of classes
   )}
   ```
   Remove `touch-none` from the base classes since it's now conditional.

6. Wrap quick action menu in canEdit check (around line 107-182):
   ```typescript
   {/* Quick Actions Menu - only for Editor/Admin */}
   {canEdit && (
     <div className="absolute -top-2 -right-2 opacity-0 group-hover:opacity-100 ...">
       <DropdownMenu>
         {/* existing menu content */}
       </DropdownMenu>
     </div>
   )}
   ```

7. Keep the "View Details" click on card title working for everyone (VIEWERs can still click to view).
  </action>
  <verify>
1. Log in as VIEWER, visit /kanban - cards should NOT show quick action menu on hover, cannot drag
2. Log in as EDITOR/ADMIN, visit /kanban - cards show quick action menu, can drag
3. npm run build passes (no TypeScript errors)
  </verify>
  <done>
- VIEWER sees Kanban cards but cannot drag or see quick action menu
- EDITOR/ADMIN can drag cards and use quick action menu
- Card click (view details) works for all roles
  </done>
</task>

</tasks>

<verification>
1. Build passes: `npm run build`
2. Manual test as VIEWER: Kanban cards visible, no drag cursor, no quick action menu
3. Manual test as EDITOR: Full Kanban functionality
</verification>

<success_criteria>
- [ ] src/lib/permissions.ts exists with canEdit() and isAdmin()
- [ ] KanbanCard accepts canEdit prop and disables drag when false
- [ ] Quick action menu only renders when canEdit is true
- [ ] Cursor shows default (not grab) for VIEWERs
- [ ] Build passes without errors
</success_criteria>

<output>
After completion, create `.planning/phases/08-role-based-ui/08-01-SUMMARY.md`
</output>
