---
phase: 24-dashboard-customization-ui
plan: 05
type: execute
wave: 3
depends_on: ["24-02", "24-03", "24-04"]
files_modified:
  - src/components/dashboard/dashboard-header.tsx
  - src/app/(dashboard)/page.tsx
autonomous: true

must_haves:
  truths:
    - "Dashboard header shows Customize, date filter, undo, and reset buttons"
    - "Clicking Customize opens widget bank and enables edit mode"
    - "Layout changes auto-save with debounce and show undo toast"
    - "Reset to default shows confirmation and replaces layout"
    - "Date filter selection persists in user preferences"
  artifacts:
    - path: "src/components/dashboard/dashboard-header.tsx"
      provides: "Dashboard header with customization controls"
      exports: ["DashboardHeader"]
    - path: "src/app/(dashboard)/page.tsx"
      provides: "Updated dashboard page with customization UI"
      contains: "DashboardGrid"
  key_links:
    - from: "src/app/(dashboard)/page.tsx"
      to: "src/components/dashboard/dashboard-grid.tsx"
      via: "DashboardGrid for layout rendering"
      pattern: "DashboardGrid"
    - from: "src/app/(dashboard)/page.tsx"
      to: "src/app/api/user/preferences/route.ts"
      via: "fetch for save/load preferences"
      pattern: "api/user/preferences"
    - from: "src/components/dashboard/dashboard-header.tsx"
      to: "sonner"
      via: "toast for undo notifications"
      pattern: "toast"
---

<objective>
Integrate all dashboard customization components and complete the user experience.

Purpose: Connect dashboard grid, widget bank, date filter, and persistence into a cohesive customizable dashboard experience.
Output: Fully functional customizable dashboard with auto-save, undo, and reset capabilities.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/24-dashboard-customization-ui/24-CONTEXT.md
@.planning/phases/24-dashboard-customization-ui/24-RESEARCH.md
@.planning/phases/24-dashboard-customization-ui/24-01-SUMMARY.md
@.planning/phases/24-dashboard-customization-ui/24-02-SUMMARY.md
@.planning/phases/24-dashboard-customization-ui/24-03-SUMMARY.md
@.planning/phases/24-dashboard-customization-ui/24-04-SUMMARY.md
@src/app/(dashboard)/page.tsx
@src/lib/widgets/defaults.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create dashboard header component</name>
  <files>
    - src/components/dashboard/dashboard-header.tsx
  </files>
  <action>
Create src/components/dashboard/dashboard-header.tsx:

```typescript
'use client';

import { Settings2, Undo2, RotateCcw, Check } from 'lucide-react';
import { Button } from '@/components/ui/button';
import {
  AlertDialog,
  AlertDialogAction,
  AlertDialogCancel,
  AlertDialogContent,
  AlertDialogDescription,
  AlertDialogFooter,
  AlertDialogHeader,
  AlertDialogTitle,
  AlertDialogTrigger,
} from '@/components/ui/alert-dialog';
import { DateRangeFilter } from './date-range-filter';
import type { DateFilter } from '@/types/dashboard';
```

Props interface:
```typescript
interface DashboardHeaderProps {
  isEditMode: boolean;
  onToggleEditMode: () => void;
  canUndo: boolean;
  onUndo: () => void;
  onReset: () => void;
  dateFilter: DateFilter;
  onDateFilterChange: (filter: DateFilter) => void;
  isSaving?: boolean;
}
```

Component structure:
```tsx
<div className="flex items-center justify-between mb-6">
  <div>
    <h1 className="text-2xl font-bold text-gray-900">Dashboard</h1>
    <p className="text-sm text-gray-500">Strategic Annual Action Plan 2026</p>
  </div>

  <div className="flex items-center gap-2">
    {/* Date Filter */}
    <DateRangeFilter
      value={dateFilter}
      onChange={onDateFilterChange}
    />

    {/* Edit Mode Controls - only show when in edit mode */}
    {isEditMode && (
      <>
        <Button
          variant="outline"
          size="sm"
          onClick={onUndo}
          disabled={!canUndo}
        >
          <Undo2 className="h-4 w-4 mr-1" />
          Undo
        </Button>

        {/* Reset with confirmation */}
        <AlertDialog>
          <AlertDialogTrigger asChild>
            <Button variant="outline" size="sm">
              <RotateCcw className="h-4 w-4 mr-1" />
              Reset
            </Button>
          </AlertDialogTrigger>
          <AlertDialogContent>
            <AlertDialogHeader>
              <AlertDialogTitle>Reset to Default Layout?</AlertDialogTitle>
              <AlertDialogDescription>
                This will replace your current dashboard with the default layout.
                Your customizations will be lost.
              </AlertDialogDescription>
            </AlertDialogHeader>
            <AlertDialogFooter>
              <AlertDialogCancel>Cancel</AlertDialogCancel>
              <AlertDialogAction onClick={onReset}>
                Reset Layout
              </AlertDialogAction>
            </AlertDialogFooter>
          </AlertDialogContent>
        </AlertDialog>
      </>
    )}

    {/* Customize Button */}
    <Button
      variant={isEditMode ? 'default' : 'outline'}
      size="sm"
      onClick={onToggleEditMode}
    >
      {isEditMode ? (
        <>
          <Check className="h-4 w-4 mr-1" />
          Done
        </>
      ) : (
        <>
          <Settings2 className="h-4 w-4 mr-1" />
          Customize
        </>
      )}
    </Button>
  </div>
</div>
```

Export DashboardHeader component.
  </action>
  <verify>
    - File exists at src/components/dashboard/dashboard-header.tsx
    - Exports DashboardHeader
    - TypeScript compiles: `npx tsc --noEmit`
  </verify>
  <done>Dashboard header with customization controls created</done>
</task>

<task type="auto">
  <name>Task 2: Create dashboard client component</name>
  <files>
    - src/components/dashboard/dashboard-client.tsx
  </files>
  <action>
Create src/components/dashboard/dashboard-client.tsx - the client-side wrapper for the dashboard:

```typescript
'use client';

import { useState, useEffect, useCallback, useMemo } from 'react';
import { toast } from 'sonner';
import { DashboardHeader } from './dashboard-header';
import { DashboardGrid } from './dashboard-grid';
import { WidgetBank } from './widget-bank';
import { useDashboardLayout } from '@/lib/hooks/use-dashboard-layout';
import { useDebounce } from '@/lib/hooks/use-debounce';
import { KPICards } from './kpi-cards';
import { StatusChart } from './status-chart';
import { DepartmentChart } from './department-chart';
import { TeamWorkload } from './team-workload';
import { RecentInitiatives } from './recent-initiatives';
import { CRMKPICards } from './crm-kpi-cards';
import { PipelineStageChart } from './pipeline-stage-chart';
import type { LayoutWidgetConfig, DateFilter, DashboardLayout } from '@/types/dashboard';
import { createDateFilter } from '@/lib/date-utils';
```

Props interface (receives server-fetched data):
```typescript
interface DashboardClientProps {
  initialLayout: LayoutWidgetConfig[];
  initialDateFilter: DateFilter | null;
  defaultLayout: LayoutWidgetConfig[];
  visibleWidgetIds: string[];
  dashboardData: {
    stats: any;
    byStatus: any[];
    byDepartment: any[];
    byPerson: any[];
    recentInitiatives: any[];
  };
  crmData: {
    stageData: any[];
    openPipeline: number;
    weightedForecast: number;
    winRate: number;
    dealCount: number;
    totalRevenue: number;
    profit: number;
  } | null;
}
```

State management:
```typescript
const [isEditMode, setIsEditMode] = useState(false);
const [widgetBankOpen, setWidgetBankOpen] = useState(false);
const [dateFilter, setDateFilter] = useState<DateFilter>(
  initialDateFilter || createDateFilter('last30days')
);

// Layout management with undo
const {
  layout,
  updateLayout,
  addWidget,
  removeWidget,
  undo,
  canUndo,
  isDirty
} = useDashboardLayout(initialLayout);

// Debounced layout for auto-save
const debouncedLayout = useDebounce(layout, 1000);
```

Auto-save effect:
```typescript
useEffect(() => {
  if (!isDirty) return;

  // Save layout
  fetch('/api/user/preferences', {
    method: 'PATCH',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ dashboardLayout: { widgets: debouncedLayout } }),
  }).then(() => {
    toast('Layout saved', {
      action: {
        label: 'Undo',
        onClick: undo,
      },
      duration: 5000,
    });
  });
}, [debouncedLayout, isDirty, undo]);
```

Date filter save effect:
```typescript
const debouncedDateFilter = useDebounce(dateFilter, 500);

useEffect(() => {
  fetch('/api/user/preferences', {
    method: 'PATCH',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ dateFilter: debouncedDateFilter }),
  });
}, [debouncedDateFilter]);
```

Reset handler:
```typescript
const handleReset = useCallback(() => {
  updateLayout(defaultLayout);
  toast('Layout reset to default');
}, [defaultLayout, updateLayout]);
```

Toggle edit mode:
```typescript
const handleToggleEditMode = useCallback(() => {
  setIsEditMode(prev => {
    if (!prev) {
      // Opening edit mode - also open widget bank
      setWidgetBankOpen(true);
    }
    return !prev;
  });
}, []);
```

Widget renderer:
```typescript
const renderWidget = useCallback((widgetId: string, instanceId: string) => {
  switch (widgetId) {
    case 'kpi-cards':
      return <KPICards stats={dashboardData.stats} />;
    case 'status-chart':
      return <StatusChart data={dashboardData.byStatus} />;
    case 'department-chart':
      return <DepartmentChart data={dashboardData.byDepartment} />;
    case 'team-workload':
      return <TeamWorkload data={dashboardData.byPerson} total={dashboardData.stats.totalInitiatives} />;
    case 'recent-initiatives':
      return <RecentInitiatives initiatives={dashboardData.recentInitiatives} />;
    case 'crm-kpi-cards':
      return crmData ? (
        <CRMKPICards
          openPipeline={crmData.openPipeline}
          weightedForecast={crmData.weightedForecast}
          winRate={crmData.winRate}
          dealCount={crmData.dealCount}
          totalRevenue={crmData.totalRevenue}
          profit={crmData.profit}
        />
      ) : null;
    case 'pipeline-stage-chart':
      return crmData ? <PipelineStageChart data={crmData.stageData} /> : null;
    default:
      return <div>Unknown widget: {widgetId}</div>;
  }
}, [dashboardData, crmData]);
```

Get current widget IDs for widget bank:
```typescript
const currentWidgetIds = useMemo(
  () => layout.map(w => w.id),
  [layout]
);
```

Render:
```tsx
return (
  <div className="min-h-screen bg-gray-50">
    <div className="p-4 md:p-6">
      <DashboardHeader
        isEditMode={isEditMode}
        onToggleEditMode={handleToggleEditMode}
        canUndo={canUndo}
        onUndo={undo}
        onReset={handleReset}
        dateFilter={dateFilter}
        onDateFilterChange={setDateFilter}
      />

      <DashboardGrid
        layout={layout}
        onLayoutChange={updateLayout}
        onRemoveWidget={removeWidget}
        isEditMode={isEditMode}
        renderWidget={renderWidget}
      />

      <WidgetBank
        open={widgetBankOpen}
        onOpenChange={setWidgetBankOpen}
        currentWidgetIds={currentWidgetIds}
        visibleWidgetIds={visibleWidgetIds}
        onAddWidget={addWidget}
      />
    </div>
  </div>
);
```

Export DashboardClient component.
  </action>
  <verify>
    - File exists at src/components/dashboard/dashboard-client.tsx
    - Exports DashboardClient
    - TypeScript compiles: `npx tsc --noEmit`
  </verify>
  <done>Dashboard client component with full state management</done>
</task>

<task type="auto">
  <name>Task 3: Update dashboard page to use new components</name>
  <files>
    - src/app/(dashboard)/page.tsx
  </files>
  <action>
Update src/app/(dashboard)/page.tsx to use the new dashboard customization:

1. Keep existing data fetching functions (getDashboardData, getCRMDashboardData)

2. Add imports:
```typescript
import { DashboardClient } from '@/components/dashboard/dashboard-client';
import { getAdminDefaults, DEFAULT_DASHBOARD_LAYOUT } from '@/lib/widgets/defaults';
import prisma from '@/lib/prisma';
import type { DashboardLayout, LayoutWidgetConfig } from '@/types/dashboard';
```

3. Add function to get user preferences:
```typescript
async function getUserPreferences(userId: string) {
  const prefs = await prisma.userPreferences.findUnique({
    where: { userId },
  });

  return {
    dashboardLayout: prefs?.dashboardLayout as DashboardLayout | null,
    dateFilter: prefs?.dateFilter as DateFilter | null,
  };
}
```

4. Update the page component:
```typescript
export default async function DashboardPage() {
  const session = await auth();
  if (!session) {
    redirect('/login');
  }

  const userRole = session.user.role;

  // Get admin defaults for widget role restrictions
  const adminDefaults = await getAdminDefaults();

  // Filter visible widgets based on user role
  const visibleWidgetIds = filterWidgetsByRole(WIDGET_IDS, userRole, adminDefaults.widgetRoles);

  // Get user preferences
  const userPrefs = await getUserPreferences(session.user.id);

  // Use user layout or default, filtering by role
  let userLayout = userPrefs.dashboardLayout?.widgets || DEFAULT_DASHBOARD_LAYOUT.widgets;

  // Filter user's layout to only include widgets they can see
  userLayout = userLayout.filter(w => visibleWidgetIds.includes(w.id));

  // Convert to LayoutWidgetConfig (add instance IDs if missing)
  const initialLayout: LayoutWidgetConfig[] = userLayout.map((w, index) => ({
    ...w,
    i: (w as any).i || `widget-${index}-${w.id}`,
  }));

  // Get default layout for reset
  const defaultLayout: LayoutWidgetConfig[] = DEFAULT_DASHBOARD_LAYOUT.widgets
    .filter(w => visibleWidgetIds.includes(w.id))
    .map((w, index) => ({
      ...w,
      i: `default-${index}-${w.id}`,
    }));

  // Always fetch KRI data
  const data = await getDashboardData();

  // Only fetch CRM data if at least one CRM widget is visible
  const shouldFetchCrmData = visibleWidgetIds.includes('crm-kpi-cards') ||
    visibleWidgetIds.includes('pipeline-stage-chart');
  const crmData = shouldFetchCrmData ? await getCRMDashboardData() : null;

  return (
    <DashboardClient
      initialLayout={initialLayout}
      initialDateFilter={userPrefs.dateFilter}
      defaultLayout={defaultLayout}
      visibleWidgetIds={visibleWidgetIds}
      dashboardData={data}
      crmData={crmData}
    />
  );
}
```

Note: Remove the old hardcoded widget grid and Header component usage.
  </action>
  <verify>
    - Dashboard page uses DashboardClient
    - User preferences loaded server-side
    - Role-based filtering applied
    - TypeScript compiles: `npx tsc --noEmit`
    - Dashboard loads in browser
  </verify>
  <done>Dashboard page updated to use customization components</done>
</task>

</tasks>

<verification>
- Dashboard loads with user's saved layout or default
- Clicking "Customize" opens widget bank and enables edit mode
- Drag and resize work in edit mode
- Adding widget from bank adds to dashboard
- Removing widget removes from dashboard
- Layout auto-saves with undo toast
- Undo reverts last change
- Reset shows confirmation and replaces layout with default
- Date filter selection works and persists
- Mobile view has fixed layout (no drag)
</verification>

<success_criteria>
- DashboardHeader shows all customization controls
- DashboardClient manages all client-side state
- Dashboard page passes server data to client component
- Auto-save with debounce works (1 second delay)
- Undo toast appears after save with working undo button
- Reset confirmation dialog prevents accidental resets
- Date filter persists in user preferences
- All requirements covered: DASH-01 through DASH-08, DASH-12 through DASH-15
</success_criteria>

<output>
After completion, create `.planning/phases/24-dashboard-customization-ui/24-05-SUMMARY.md`
</output>
