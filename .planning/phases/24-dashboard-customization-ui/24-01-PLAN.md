---
phase: 24-dashboard-customization-ui
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - src/app/api/user/preferences/route.ts
  - src/lib/widgets/layout-utils.ts
  - src/types/dashboard.ts
  - src/app/layout.tsx
autonomous: true

must_haves:
  truths:
    - "User preferences API returns saved layout or null for new users"
    - "User preferences API accepts PATCH to save layout and date filter"
    - "Sonner toaster renders globally for undo notifications"
  artifacts:
    - path: "src/app/api/user/preferences/route.ts"
      provides: "GET and PATCH endpoints for user dashboard preferences"
      exports: ["GET", "PATCH"]
    - path: "src/lib/widgets/layout-utils.ts"
      provides: "Layout manipulation helpers for grid operations"
      exports: ["addWidgetToLayout", "removeWidgetFromLayout", "generateLayoutId"]
    - path: "src/app/layout.tsx"
      provides: "Sonner Toaster provider"
      contains: "Toaster"
  key_links:
    - from: "src/app/api/user/preferences/route.ts"
      to: "prisma.userPreferences"
      via: "upsert for save, findUnique for load"
      pattern: "prisma\\.userPreferences\\.(upsert|findUnique)"
---

<objective>
Install dependencies and create user preferences infrastructure for dashboard customization.

Purpose: Foundation for dashboard persistence - install react-grid-layout and sonner, create user preferences API, and layout utility functions.
Output: Working user preferences API, sonner toast setup, and layout manipulation utilities.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/24-dashboard-customization-ui/24-CONTEXT.md
@.planning/phases/24-dashboard-customization-ui/24-RESEARCH.md
@src/types/dashboard.ts
@src/lib/widgets/defaults.ts
@prisma/schema.prisma (UserPreferences model)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install dependencies and setup Sonner</name>
  <files>
    - package.json
    - src/app/layout.tsx
  </files>
  <action>
1. Install dependencies:
   ```bash
   npm install react-grid-layout sonner
   ```

2. Update src/app/layout.tsx to add Sonner Toaster:
   - Import: `import { Toaster } from 'sonner'`
   - Add `<Toaster position="bottom-right" richColors />` inside the body, after {children}

Note: react-grid-layout includes its own TypeScript types in v2, no @types package needed.
  </action>
  <verify>
    - `npm list react-grid-layout sonner` shows both installed
    - Toaster component in layout.tsx
  </verify>
  <done>react-grid-layout and sonner installed, Toaster provider in root layout</done>
</task>

<task type="auto">
  <name>Task 2: Create user preferences API</name>
  <files>
    - src/app/api/user/preferences/route.ts
  </files>
  <action>
Create API route for user dashboard preferences at src/app/api/user/preferences/route.ts:

GET endpoint:
- Get session via auth()
- Return 401 if no session
- Query prisma.userPreferences.findUnique where userId = session.user.id
- Return { dashboardLayout: prefs?.dashboardLayout ?? null, dateFilter: prefs?.dateFilter ?? null }

PATCH endpoint:
- Get session via auth()
- Return 401 if no session
- Parse body: { dashboardLayout?: DashboardLayout, dateFilter?: DateFilter }
- Build update data object with only provided fields
- Use prisma.userPreferences.upsert:
  - where: { userId: session.user.id }
  - update: data
  - create: { userId: session.user.id, ...data }
- Return { success: true }

Import types from @/types/dashboard.
  </action>
  <verify>
    - File exists at src/app/api/user/preferences/route.ts
    - Exports GET and PATCH
  </verify>
  <done>User preferences API with GET and PATCH working</done>
</task>

<task type="auto">
  <name>Task 3: Create layout utility functions</name>
  <files>
    - src/lib/widgets/layout-utils.ts
    - src/types/dashboard.ts
  </files>
  <action>
1. Update src/types/dashboard.ts to add LayoutWidgetConfig interface:
   ```typescript
   export interface LayoutWidgetConfig extends WidgetConfig {
     i: string;  // Instance ID (uuid) for react-grid-layout
   }
   ```

2. Create src/lib/widgets/layout-utils.ts with:

   ```typescript
   import { v4 as uuidv4 } from 'crypto';
   // Actually use crypto.randomUUID() which is built-in, no import needed
   ```

   Functions to create:

   a) generateLayoutId(): string
      - Return crypto.randomUUID()
      - Used for unique widget instance IDs

   b) addWidgetToLayout(layout: LayoutWidgetConfig[], widgetId: string, defaultSize: {w: number, h: number}): LayoutWidgetConfig[]
      - Generate new instance ID with generateLayoutId()
      - Calculate y position: max y of existing widgets + their height, or 0 if empty
      - Add new widget at x=0, y=calculated, w=defaultSize.w, h=defaultSize.h
      - Return new array with added widget

   c) removeWidgetFromLayout(layout: LayoutWidgetConfig[], instanceId: string): LayoutWidgetConfig[]
      - Filter out widget with matching instance ID (i field)
      - Return filtered array

   d) convertToGridLayout(layout: LayoutWidgetConfig[]): Layout[]
      - Convert LayoutWidgetConfig[] to react-grid-layout Layout[] format
      - Each item: { i: widget.i, x: widget.x, y: widget.y, w: widget.w, h: widget.h }

   e) convertFromGridLayout(gridLayout: Layout[], originalLayout: LayoutWidgetConfig[]): LayoutWidgetConfig[]
      - Merge position updates from react-grid-layout back to our format
      - Preserve widget id (type) from originalLayout, update x,y,w,h from gridLayout

Export all functions.
  </action>
  <verify>
    - File exists at src/lib/widgets/layout-utils.ts
    - All 5 functions exported
    - Types compile without errors: `npx tsc --noEmit`
  </verify>
  <done>Layout utilities created with add, remove, and conversion functions</done>
</task>

</tasks>

<verification>
- `npm list react-grid-layout sonner` shows versions
- `curl -X GET http://localhost:3000/api/user/preferences` (with valid session) returns JSON
- TypeScript compiles: `npx tsc --noEmit`
</verification>

<success_criteria>
- react-grid-layout ^2.0.0 and sonner ^1.7.0 installed
- Sonner Toaster in root layout
- User preferences API at /api/user/preferences with GET and PATCH
- Layout utilities with add/remove/convert functions
- All TypeScript types compile
</success_criteria>

<output>
After completion, create `.planning/phases/24-dashboard-customization-ui/24-01-SUMMARY.md`
</output>
