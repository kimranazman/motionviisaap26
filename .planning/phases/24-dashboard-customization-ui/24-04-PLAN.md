---
phase: 24-dashboard-customization-ui
plan: 04
type: execute
wave: 2
depends_on: ["24-01"]
files_modified:
  - src/components/dashboard/widget-bank.tsx
autonomous: true

must_haves:
  truths:
    - "Widget bank sidebar opens from the right side"
    - "Widgets are grouped by category (KRI, CRM, Financials)"
    - "User can click a widget to add it to dashboard"
    - "Widgets already on dashboard show count indicator"
  artifacts:
    - path: "src/components/dashboard/widget-bank.tsx"
      provides: "Sidebar panel for selecting widgets to add"
      exports: ["WidgetBank"]
  key_links:
    - from: "src/components/dashboard/widget-bank.tsx"
      to: "src/lib/widgets/registry.ts"
      via: "WIDGET_REGISTRY for widget definitions"
      pattern: "WIDGET_REGISTRY"
    - from: "src/components/dashboard/widget-bank.tsx"
      to: "src/components/ui/sheet.tsx"
      via: "Sheet component for sidebar"
      pattern: "Sheet"
---

<objective>
Create widget bank sidebar for adding widgets to dashboard.

Purpose: Users can browse available widgets by category and add them to their dashboard with a click.
Output: Widget bank Sheet component with categorized widget list.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/24-dashboard-customization-ui/24-CONTEXT.md
@.planning/phases/24-dashboard-customization-ui/24-RESEARCH.md
@src/lib/widgets/registry.ts
@src/lib/widgets/permissions.ts
@src/components/ui/sheet.tsx
@src/components/ui/scroll-area.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create widget bank component</name>
  <files>
    - src/components/dashboard/widget-bank.tsx
  </files>
  <action>
Create src/components/dashboard/widget-bank.tsx:

```typescript
'use client';

import { useMemo } from 'react';
import { Plus, Check } from 'lucide-react';
import {
  Sheet,
  SheetContent,
  SheetHeader,
  SheetTitle,
  SheetDescription
} from '@/components/ui/sheet';
import { ScrollArea } from '@/components/ui/scroll-area';
import { Button } from '@/components/ui/button';
import { Badge } from '@/components/ui/badge';
import { Card, CardContent } from '@/components/ui/card';
import { WIDGET_REGISTRY, WidgetDefinition } from '@/lib/widgets/registry';
import { cn } from '@/lib/utils';
```

Props interface:
```typescript
interface WidgetBankProps {
  open: boolean;
  onOpenChange: (open: boolean) => void;
  currentWidgetIds: string[];  // Widget type IDs currently on dashboard
  visibleWidgetIds: string[];  // Widget IDs user is allowed to see (role-filtered)
  onAddWidget: (widgetId: string) => void;
}
```

Category labels:
```typescript
const CATEGORY_LABELS: Record<string, string> = {
  kri: 'Key Result Initiatives',
  crm: 'Sales & CRM',
  financials: 'Financials'
};
```

Group widgets by category:
```typescript
const widgetsByCategory = useMemo(() => {
  const grouped: Record<string, WidgetDefinition[]> = {};

  // Only include widgets the user can see
  Object.values(WIDGET_REGISTRY)
    .filter(widget => visibleWidgetIds.includes(widget.id))
    .forEach(widget => {
      if (!grouped[widget.category]) {
        grouped[widget.category] = [];
      }
      grouped[widget.category].push(widget);
    });

  return grouped;
}, [visibleWidgetIds]);
```

Count instances per widget type:
```typescript
const getWidgetCount = (widgetId: string) => {
  return currentWidgetIds.filter(id => id === widgetId).length;
};
```

Component structure:
1. Sheet with side="right"
2. SheetHeader with title "Add Widgets" and description "Click to add widgets to your dashboard"
3. ScrollArea containing categories

For each category:
```tsx
<div className="mb-6">
  <h3 className="text-sm font-medium text-muted-foreground uppercase tracking-wide mb-3">
    {CATEGORY_LABELS[category] || category}
  </h3>
  <div className="space-y-2">
    {widgets.map(widget => (
      <WidgetBankItem
        key={widget.id}
        widget={widget}
        count={getWidgetCount(widget.id)}
        onAdd={() => onAddWidget(widget.id)}
      />
    ))}
  </div>
</div>
```

WidgetBankItem sub-component (inline or separate):
```tsx
function WidgetBankItem({
  widget,
  count,
  onAdd
}: {
  widget: WidgetDefinition;
  count: number;
  onAdd: () => void;
}) {
  return (
    <Card
      className="cursor-pointer hover:bg-accent transition-colors"
      onClick={onAdd}
    >
      <CardContent className="p-3 flex items-center justify-between">
        <div>
          <div className="font-medium text-sm">{widget.title}</div>
          <div className="text-xs text-muted-foreground">
            {widget.description}
          </div>
        </div>
        <div className="flex items-center gap-2">
          {count > 0 && (
            <Badge variant="secondary" className="text-xs">
              {count} added
            </Badge>
          )}
          <Button size="icon" variant="ghost" className="h-8 w-8">
            <Plus className="h-4 w-4" />
          </Button>
        </div>
      </CardContent>
    </Card>
  );
}
```

Note: Per CONTEXT.md, duplicate widgets are allowed (same widget multiple times with different date ranges). So we show count and always allow adding more.

Export WidgetBank component.
  </action>
  <verify>
    - File exists at src/components/dashboard/widget-bank.tsx
    - Exports WidgetBank
    - Groups widgets by category
    - TypeScript compiles: `npx tsc --noEmit`
  </verify>
  <done>Widget bank sidebar with categorized widgets and add functionality</done>
</task>

<task type="auto">
  <name>Task 2: Add size preview to widget bank items</name>
  <files>
    - src/components/dashboard/widget-bank.tsx
  </files>
  <action>
Enhance WidgetBankItem to show widget size preview:

Add visual size indicator below description:
```tsx
<div className="flex items-center gap-1 mt-1">
  <span className="text-xs text-muted-foreground">Size:</span>
  <span className="text-xs font-mono bg-muted px-1 rounded">
    {widget.defaultSize.w} x {widget.defaultSize.h}
  </span>
</div>
```

This shows the grid units (e.g., "12 x 2" for full-width KPI cards, "6 x 3" for half-width charts).

Alternative: Visual grid preview (small dots representing the grid):
```tsx
<div className="flex gap-0.5 mt-1">
  {Array.from({ length: Math.min(widget.defaultSize.w, 6) }).map((_, i) => (
    <div
      key={i}
      className="w-1.5 h-1.5 rounded-full bg-primary/40"
    />
  ))}
  {widget.defaultSize.w > 6 && (
    <span className="text-xs text-muted-foreground ml-1">...</span>
  )}
</div>
```

Choose the simpler text-based approach for clarity.
  </action>
  <verify>
    - Size indicator visible in widget bank items
    - TypeScript compiles: `npx tsc --noEmit`
  </verify>
  <done>Widget bank items show size preview</done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes
- Widget bank opens as Sheet from right side
- Widgets grouped by category with proper labels
- Add button works (triggers onAddWidget callback)
- Count badge shows for widgets already on dashboard
</verification>

<success_criteria>
- Widget bank renders as right-side Sheet
- Three categories: KRI, CRM, Financials
- Only role-visible widgets shown (visibleWidgetIds filtering)
- Click anywhere on widget card adds it to dashboard
- Count badge shows how many instances of each widget type
- Size preview helps user understand widget dimensions
</success_criteria>

<output>
After completion, create `.planning/phases/24-dashboard-customization-ui/24-04-SUMMARY.md`
</output>
