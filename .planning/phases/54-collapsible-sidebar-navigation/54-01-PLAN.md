---
phase: 54-collapsible-sidebar-navigation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/nav-config.ts
  - src/lib/hooks/use-nav-collapse-state.ts
  - src/components/layout/nav-group.tsx
  - src/components/layout/sidebar.tsx
  - src/components/layout/mobile-sidebar.tsx
autonomous: true

must_haves:
  truths:
    - "User can click SAAP, CRM, and Admin group headers to collapse/expand each section"
    - "Chevron icon rotates smoothly (CSS transition) when toggling collapse state"
    - "Sidebar collapse state persists in localStorage across page navigations and browser sessions"
    - "All sidebar groups default to expanded on first visit"
    - "When user navigates to a route inside a collapsed group, that group auto-expands"
    - "Mobile sidebar uses the same collapsible groups as desktop sidebar"
    - "Price Comparison appears in mobile sidebar (fixing current mobile drift)"
    - "Collapsed group headers show item count badge"
    - "Top-level Tasks and Members links appear in sidebar, not nested in any group"
    - "Desktop and mobile sidebars share a single navigation config"
  artifacts:
    - path: "src/lib/nav-config.ts"
      provides: "Unified navigation config with typed NavItem, NavGroup, TopLevelNavItem, findGroupForPath helper"
      exports: ["navGroups", "topLevelItems", "findGroupForPath", "NavItem", "NavGroup", "TopLevelNavItem"]
    - path: "src/lib/hooks/use-nav-collapse-state.ts"
      provides: "SSR-safe localStorage-backed collapse state hook"
      exports: ["useNavCollapseState"]
    - path: "src/components/layout/nav-group.tsx"
      provides: "Reusable collapsible nav group component with chevron animation and count badge"
      exports: ["NavGroupComponent"]
    - path: "src/components/layout/sidebar.tsx"
      provides: "Refactored desktop sidebar consuming shared config with collapsible groups"
      exports: ["Sidebar"]
    - path: "src/components/layout/mobile-sidebar.tsx"
      provides: "Refactored mobile sidebar consuming shared config with collapsible groups and Price Comparison"
      exports: ["MobileSidebar"]
  key_links:
    - from: "src/components/layout/sidebar.tsx"
      to: "src/lib/nav-config.ts"
      via: "import { navGroups, topLevelItems }"
      pattern: "import.*navGroups.*from.*nav-config"
    - from: "src/components/layout/mobile-sidebar.tsx"
      to: "src/lib/nav-config.ts"
      via: "import { navGroups, topLevelItems }"
      pattern: "import.*navGroups.*from.*nav-config"
    - from: "src/components/layout/sidebar.tsx"
      to: "src/lib/hooks/use-nav-collapse-state.ts"
      via: "useNavCollapseState(pathname)"
      pattern: "useNavCollapseState"
    - from: "src/components/layout/mobile-sidebar.tsx"
      to: "src/lib/hooks/use-nav-collapse-state.ts"
      via: "useNavCollapseState(pathname)"
      pattern: "useNavCollapseState"
    - from: "src/components/layout/sidebar.tsx"
      to: "src/components/layout/nav-group.tsx"
      via: "NavGroupComponent rendered per group"
      pattern: "NavGroupComponent"
    - from: "src/components/layout/mobile-sidebar.tsx"
      to: "src/components/layout/nav-group.tsx"
      via: "NavGroupComponent rendered per group with onLinkClick"
      pattern: "NavGroupComponent.*onLinkClick"
    - from: "src/lib/hooks/use-nav-collapse-state.ts"
      to: "src/lib/nav-config.ts"
      via: "findGroupForPath for auto-expand"
      pattern: "findGroupForPath"
---

<objective>
Unify the desktop and mobile sidebar navigation into a single typed config, add collapsible groups with localStorage persistence, and include top-level Tasks/Members links.

Purpose: Eliminates duplicated navigation arrays (which caused mobile to miss Price Comparison), gives users control over sidebar density via collapsible groups, and prepares nav links for Phase 55 (/tasks) and Phase 56 (/members).

Output: 3 new files (nav-config.ts, use-nav-collapse-state.ts, nav-group.tsx) and 2 refactored files (sidebar.tsx, mobile-sidebar.tsx) that together satisfy NAV-01 through NAV-11.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/54-collapsible-sidebar-navigation/54-RESEARCH.md

@src/components/layout/sidebar.tsx
@src/components/layout/mobile-sidebar.tsx
@src/components/ui/collapsible.tsx
@src/components/objectives/objective-group.tsx
@src/lib/hooks/use-detail-view-mode.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create unified nav config and collapse state hook</name>
  <files>
    src/lib/nav-config.ts
    src/lib/hooks/use-nav-collapse-state.ts
  </files>
  <action>
Create `src/lib/nav-config.ts` with:
- Export `NavItem` interface: `{ name: string; href: string; icon: LucideIcon }` (import `LucideIcon` type from `lucide-react`)
- Export `NavGroup` interface: `{ key: string; label: string; items: NavItem[]; requireRole?: string }`
- Export `TopLevelNavItem` interface extending `NavItem` (alias, for semantic clarity)
- Export `navGroups: NavGroup[]` array with 3 groups:
  - SAAP group (key: `'saap'`, label: `'SAAP'`): Dashboard (/), By Objective (/objectives), Timeline (/timeline), Kanban (/kanban), Calendar (/calendar), Initiatives (/initiatives), Support Tasks (/support-tasks), Events to Attend (/events) -- icons: LayoutDashboard, Target, GanttChart, KanbanSquare, Calendar, ListTodo, ClipboardList, Ticket
  - CRM group (key: `'crm'`, label: `'CRM'`): Companies (/companies), Pipeline (/pipeline), Potential Projects (/potential-projects), Projects (/projects), Suppliers (/suppliers), Price Comparison (/supplier-items) -- icons: Building2, Funnel, FolderKanban, Briefcase, Truck, Scale
  - Admin group (key: `'admin'`, label: `'Admin'`, requireRole: `'ADMIN'`): Users (/admin/users) -- icon: Users
- Export `topLevelItems: TopLevelNavItem[]` array: Tasks (/tasks, ListChecks icon), Members (/members, Users2 icon)
- Export `settingsItem: NavItem` for Settings (/settings, Settings icon) -- kept separate so both sidebars render it in its own border-top section
- Export `findGroupForPath(pathname: string): string | null` helper that iterates `navGroups` and returns the `key` of the group containing a matching route (exact match for '/', startsWith for others), or `null` if no match

Create `src/lib/hooks/use-nav-collapse-state.ts` with:
- `'use client'` directive at top
- Import `useState`, `useEffect`, `useCallback` from `'react'`
- Import `findGroupForPath` from `'@/lib/nav-config'`
- Constant `STORAGE_KEY = 'sidebar-collapse-state'`
- Constant `DEFAULT_STATE: Record<string, boolean> = { saap: true, crm: true, admin: true }` (all expanded by default per NAV-06)
- Export `useNavCollapseState(pathname: string)` hook that:
  1. Initializes `expandedGroups` state with `DEFAULT_STATE` (matches server render, avoids hydration mismatch)
  2. Tracks `hydrated` boolean state (starts `false`)
  3. First `useEffect` (runs once on mount, `[]` deps): reads `localStorage.getItem(STORAGE_KEY)`, parses JSON, calls `setExpandedGroups` if valid, then `setHydrated(true)`. Wraps in try/catch to ignore parse errors.
  4. Second `useEffect` (deps: `[pathname, hydrated]`): if `hydrated` is false, return early. Calls `findGroupForPath(pathname)`. If result is non-null AND `expandedGroups[result]` is falsy, updates state to expand that group AND writes to localStorage. This implements NAV-07 (auto-expand for active route).
  5. `toggleGroup` callback (wrapped in `useCallback`): flips `expandedGroups[key]`, writes updated state to localStorage.
  6. Returns `{ expandedGroups, toggleGroup }`

Follow the established hook pattern from `src/lib/hooks/use-detail-view-mode.ts` for localStorage read/write style.
  </action>
  <verify>
Run `npx tsc --noEmit` to confirm both files compile with no type errors. Verify that `nav-config.ts` exports all 6 named exports and `use-nav-collapse-state.ts` exports `useNavCollapseState`.
  </verify>
  <done>
`nav-config.ts` defines 3 nav groups (SAAP with 8 items, CRM with 6 items including Price Comparison, Admin with 1 item), 2 top-level items (Tasks, Members), 1 settings item, and `findGroupForPath` helper. `use-nav-collapse-state.ts` provides SSR-safe collapse state hook with localStorage persistence, default-expanded, and auto-expand for active route.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create reusable NavGroup component</name>
  <files>
    src/components/layout/nav-group.tsx
  </files>
  <action>
Create `src/components/layout/nav-group.tsx` with:
- `'use client'` directive
- Import `Collapsible`, `CollapsibleTrigger`, `CollapsibleContent` from `'@/components/ui/collapsible'`
- Import `ChevronRight` from `'lucide-react'`
- Import `Link` from `'next/link'`
- Import `cn` from `'@/lib/utils'`
- Import `NavGroup` type from `'@/lib/nav-config'`

Define and export `NavGroupComponent` with props:
```typescript
interface NavGroupProps {
  group: NavGroup
  isExpanded: boolean
  onToggle: () => void
  pathname: string
  onLinkClick?: () => void  // For mobile: close sheet on navigation
}
```

Component structure:
- Wraps in `<Collapsible open={isExpanded} onOpenChange={onToggle}>`
- `CollapsibleTrigger` renders as a `button` with flex layout:
  - Left side: group label text (`group.label`) in uppercase, xs font, semibold, gray-400, tracking-wider
  - Item count badge in parentheses after the label text, e.g., "SAAP (8)" -- this satisfies NAV-09
  - Right side: `ChevronRight` icon (h-3.5 w-3.5, shrink-0) with `transition-transform duration-200` and conditional `rotate-90` when `isExpanded` (same pattern as `objective-group.tsx` lines 74-79)
  - Full width, flex items-center justify-between, px-3 py-2, mt-4, hover:text-gray-600 transition-colors
- `CollapsibleContent` contains a `div` with `flex flex-col gap-1`:
  - Maps over `group.items` rendering a `<Link>` for each:
    - `href={item.href}`, `onClick={onLinkClick}` (for mobile sheet close; no-op if undefined)
    - Active detection: `pathname === item.href || (item.href !== '/' && pathname.startsWith(item.href))`
    - Active class: `bg-gray-100 text-gray-900`; Inactive class: `text-gray-600 hover:bg-gray-50 hover:text-gray-900`
    - Layout: `flex items-center gap-3 rounded-lg px-3 py-2 text-sm font-medium transition-colors`
    - Renders `<item.icon className="h-5 w-5" />` and `{item.name}`

IMPORTANT: The `onLinkClick` callback goes ONLY on `<Link>` elements, NOT on `CollapsibleTrigger`. This prevents mobile sheet from closing when user toggles a group (Pitfall 3 from RESEARCH.md).
  </action>
  <verify>
Run `npx tsc --noEmit` to confirm the component compiles. Verify the file exports `NavGroupComponent` and imports from the correct paths (`@/components/ui/collapsible`, `@/lib/nav-config`).
  </verify>
  <done>
`NavGroupComponent` renders a collapsible nav section with chevron rotation animation (NAV-04), item count badge (NAV-09), active route highlighting, and optional `onLinkClick` for mobile sheet close behavior. Reusable by both desktop and mobile sidebars (NAV-08, NAV-11).
  </done>
</task>

<task type="auto">
  <name>Task 3: Refactor desktop and mobile sidebars to use shared config</name>
  <files>
    src/components/layout/sidebar.tsx
    src/components/layout/mobile-sidebar.tsx
  </files>
  <action>
**Refactor `src/components/layout/sidebar.tsx`:**

Remove ALL inline navigation arrays and individual CRM `<Link>` elements. Replace with shared config imports.

1. Remove the `navigation` array (lines 26-35) and all individual CRM `<Link>` elements (lines 80-151).
2. Remove icon imports that are now in `nav-config.ts`. Keep only icons still directly used: `Target` (logo), `Settings` (settings link -- or import `settingsItem` instead). Actually, since `settingsItem` provides the icon, you can remove the `Settings` import too and use `settingsItem.icon`.
3. Add imports:
   - `{ navGroups, topLevelItems, settingsItem }` from `'@/lib/nav-config'`
   - `{ useNavCollapseState }` from `'@/lib/hooks/use-nav-collapse-state'`
   - `{ NavGroupComponent }` from `'@/components/layout/nav-group'`
   - Keep `Target` import from lucide-react for the logo icon
4. Inside the component, call `const { expandedGroups, toggleGroup } = useNavCollapseState(pathname)`
5. Replace the nav content with:
   - Map over `navGroups`, filter by `requireRole` (skip if `group.requireRole` is set and `session?.user?.role !== group.requireRole`), render `<NavGroupComponent>` for each with `isExpanded={expandedGroups[group.key] ?? true}` and `onToggle={() => toggleGroup(group.key)}`
   - After groups, render top-level items section: a `div` with `mt-4 flex flex-col gap-1`, map `topLevelItems` with the same Link styling pattern (flex items-center gap-3 rounded-lg px-3 py-2, active/inactive classes). Each is a simple `<Link>` with icon and name, active detection same as before.
   - Settings section: keep the `mt-6 pt-4 border-t border-gray-200` wrapper div, render a single `<Link>` using `settingsItem.href`, `settingsItem.icon`, `settingsItem.name` with same active styling.

**Refactor `src/components/layout/mobile-sidebar.tsx`:**

Remove ALL inline navigation arrays. Replace with shared config imports.

1. Remove the `navigation` array (lines 28-37) and `crmNavigation` array (lines 39-45).
2. Remove icon imports that are now in `nav-config.ts`. Keep only: `Menu` (hamburger button), `Target` (logo).
3. Add imports:
   - `{ navGroups, topLevelItems, settingsItem }` from `'@/lib/nav-config'`
   - `{ useNavCollapseState }` from `'@/lib/hooks/use-nav-collapse-state'`
   - `{ NavGroupComponent }` from `'@/components/layout/nav-group'`
4. Inside the component, call `const { expandedGroups, toggleGroup } = useNavCollapseState(pathname)` ALONGSIDE the existing `useState` for sheet open state.
5. Keep the `NavLink` inner component (or convert to inline) for top-level items and settings -- it already handles `onClick={() => setOpen(false)}` for sheet close.
6. Replace nav content with:
   - Map over `navGroups`, filter by `requireRole`, render `<NavGroupComponent>` for each with `onLinkClick={() => setOpen(false)}` (closes mobile sheet when a link is clicked). Pass `isExpanded={expandedGroups[group.key] ?? true}`, `onToggle={() => toggleGroup(group.key)}`, `pathname`.
   - After groups, render top-level items: map `topLevelItems` using the NavLink pattern with `onClick={() => setOpen(false)}`.
   - Settings section: same border-top wrapper, render using `settingsItem` with `onClick={() => setOpen(false)}`.

**Ordering in both sidebars (top to bottom):**
1. Logo header
2. Collapsible groups (SAAP, CRM, Admin if ADMIN role)
3. Top-level items (Tasks, Members) -- with a `mt-4` separator
4. Settings link -- with `mt-6 pt-4 border-t`

This satisfies the Research recommendation to place Tasks/Members between the collapsible groups and the Settings link.
  </action>
  <verify>
1. Run `npx tsc --noEmit` -- no type errors.
2. Run `npm run build` -- successful build with no warnings about missing imports or unused variables.
3. Run `npm run dev`, navigate to any page:
   - Desktop sidebar shows 3 collapsible groups (SAAP, CRM, Admin for ADMIN users) with chevron icons
   - Click a group header -- it collapses/expands with chevron rotation animation
   - Refresh page -- collapse state is preserved
   - Navigate to a page inside a collapsed group -- that group auto-expands
   - Tasks and Members links appear below the groups, above Settings
   - Settings link is at the bottom with a top border
4. Open mobile view (resize or DevTools):
   - Hamburger menu opens sheet with same collapsible groups
   - Price Comparison appears in CRM group (fixing the drift)
   - Clicking a nav link closes the sheet
   - Toggling a group does NOT close the sheet
  </verify>
  <done>
Both sidebars consume `navGroups` from `nav-config.ts` (NAV-11), eliminating duplication. Desktop sidebar has collapsible groups (NAV-01, NAV-02, NAV-03) with chevron animation (NAV-04), localStorage persistence (NAV-05), default expanded (NAV-06), auto-expand on active route (NAV-07). Mobile sidebar has identical collapsible groups (NAV-08) including Price Comparison. Count badges show on collapsed headers (NAV-09). Tasks and Members top-level links present (NAV-10).
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. **NAV-01/02/03**: Click SAAP, CRM, Admin headers -- each collapses and expands independently
2. **NAV-04**: Chevron rotates smoothly on toggle (CSS `transition-transform duration-200` + `rotate-90`)
3. **NAV-05**: Close browser, reopen -- sidebar groups retain their collapsed/expanded state
4. **NAV-06**: Clear localStorage, refresh -- all groups default to expanded
5. **NAV-07**: Collapse CRM group, navigate directly to /companies via URL bar -- CRM group auto-expands
6. **NAV-08**: Open mobile sidebar (Sheet) -- same collapsible groups as desktop
7. **NAV-09**: Collapsed group headers show item count (e.g., "SAAP (8)", "CRM (6)")
8. **NAV-10**: Tasks link (/tasks) and Members link (/members) visible as top-level items, not in any group
9. **NAV-11**: No duplicate navigation arrays exist -- both sidebars import from `nav-config.ts`
10. **Build check**: `npm run build` succeeds with no errors or warnings
</verification>

<success_criteria>
- All 11 NAV requirements (NAV-01 through NAV-11) satisfied
- Zero duplicate navigation arrays in codebase (single source of truth in nav-config.ts)
- Mobile sidebar includes Price Comparison (CRM drift fixed)
- No hydration mismatch errors in browser console
- `npm run build` passes
</success_criteria>

<output>
After completion, create `.planning/phases/54-collapsible-sidebar-navigation/54-01-SUMMARY.md`
</output>
