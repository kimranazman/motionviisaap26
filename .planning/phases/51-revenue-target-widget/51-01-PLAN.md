---
phase: 51-revenue-target-widget
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/widgets/registry.ts
  - src/lib/widgets/defaults.ts
  - src/components/dashboard/revenue-target.tsx
  - src/app/(dashboard)/page.tsx
  - src/components/dashboard/dashboard-client.tsx
autonomous: true

must_haves:
  truths:
    - "Dashboard displays a revenue-target widget with RM1,000,000 total target and current actual total"
    - "Revenue-target widget shows Events (KR1.1, RM800K target) and AI Training (KR2.2, RM200K target) breakdown rows with per-row progress bars"
    - "Revenue-target widget appears in the widget registry and is selectable in the widget bank under the KRI category"
    - "New users see the revenue-target widget in their default dashboard layout"
  artifacts:
    - path: "src/components/dashboard/revenue-target.tsx"
      provides: "Revenue target widget presentation component"
      min_lines: 40
    - path: "src/lib/widgets/registry.ts"
      provides: "Widget registry entry for revenue-target"
      contains: "revenue-target"
    - path: "src/lib/widgets/defaults.ts"
      provides: "Default layout position for revenue-target"
      contains: "revenue-target"
    - path: "src/app/(dashboard)/page.tsx"
      provides: "Per-KR revenue breakdown data fetch"
      contains: "revenueBreakdown"
    - path: "src/components/dashboard/dashboard-client.tsx"
      provides: "Render switch case and props for revenue-target"
      contains: "RevenueTarget"
  key_links:
    - from: "src/app/(dashboard)/page.tsx"
      to: "prisma.keyResult"
      via: "findMany with krId + description select"
      pattern: "krId.*description.*target.*actual"
    - from: "src/app/(dashboard)/page.tsx"
      to: "src/components/dashboard/dashboard-client.tsx"
      via: "revenueBreakdown prop in dashboardData"
      pattern: "revenueBreakdown"
    - from: "src/components/dashboard/dashboard-client.tsx"
      to: "src/components/dashboard/revenue-target.tsx"
      via: "import and render switch case"
      pattern: "case 'revenue-target'"
    - from: "src/lib/widgets/registry.ts"
      to: "src/lib/widgets/defaults.ts"
      via: "widget id must match between registry and layout"
      pattern: "revenue-target"
---

<objective>
Create the revenue-target dashboard widget that shows RM1,000,000 total revenue target with Events (KR1.1, RM800K) and AI Training (KR2.2, RM200K) breakdown, using real KeyResult actual values from the database.

Purpose: Users need visibility into revenue progress against the annual target, broken down by revenue stream (Events vs AI Training), directly on the dashboard.
Output: A fully registered, wired, and renderable revenue-target widget appearing on the dashboard.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/51-revenue-target-widget/51-RESEARCH.md

Key source files to reference:
@src/lib/widgets/registry.ts
@src/lib/widgets/defaults.ts
@src/components/dashboard/kpi-cards.tsx (pattern reference for widget component)
@src/components/dashboard/dashboard-client.tsx
@src/app/(dashboard)/page.tsx
@src/types/dashboard.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create revenue-target widget component and register it</name>
  <files>
    src/components/dashboard/revenue-target.tsx
    src/lib/widgets/registry.ts
    src/lib/widgets/defaults.ts
  </files>
  <action>
    **1. Create `src/components/dashboard/revenue-target.tsx`:**

    Create a new 'use client' component following the same patterns as `kpi-cards.tsx` and `crm-kpi-cards.tsx`. The component:

    - Accepts props: `breakdown` (array of `{ krId: string, description: string, target: number, actual: number }`), `totalTarget` (number), `totalActual` (number)
    - Define a `RevenueBreakdownItem` interface for the breakdown array items
    - Define a `RevenueTargetProps` interface with: `breakdown: RevenueBreakdownItem[]`, `totalTarget: number`, `totalActual: number`
    - Export a named function `RevenueTarget`
    - The component renders:
      - Overall summary section: icon (TrendingUp from lucide-react in emerald-50/emerald-600 colors), "Total Revenue" label, `formatCurrency(totalActual)` as large text, target on the right with `formatCurrency(totalTarget)`
      - Overall progress bar using `<Progress>` component with percentage = `Math.round((totalActual / totalTarget) * 100)`, handle totalTarget=0 (show 0%)
      - Percentage text below the progress bar (e.g., "X% of target")
      - Per-KR breakdown rows: for each item in `breakdown`, show `description` on left, `formatCurrency(actual) / formatCurrency(target)` on right, and a smaller `<Progress>` bar below
    - Root div has `className="h-full flex flex-col"` to fill the WidgetWrapper
    - Use `formatCurrency` from `@/lib/utils` (already handles RM formatting)
    - Use `Progress` from `@/components/ui/progress`
    - Handle edge cases: totalTarget=0 (show 0%), empty breakdown array (show "No revenue targets configured")

    **2. Add registry entry in `src/lib/widgets/registry.ts`:**

    Add a new entry to `WIDGET_REGISTRY` after the `'pending-analysis'` entry:

    ```typescript
    'revenue-target': {
      id: 'revenue-target',
      title: 'Revenue Target',
      description: 'RM1M revenue target with Events and AI Training breakdown',
      defaultSize: { w: 6, h: 3 },
      minRole: UserRole.EDITOR,
      category: 'kri',
      dataKey: 'revenueBreakdown',
    },
    ```

    Use `minRole: UserRole.EDITOR` because revenue data is sensitive (same as crm-kpi-cards). Use category `'kri'` since revenue targets are Key Result metrics -- this avoids needing to update the WidgetDefinition category type union.

    **3. Add default layout entry in `src/lib/widgets/defaults.ts`:**

    Add to the `DEFAULT_DASHBOARD_LAYOUT.widgets` array after the last entry (`pipeline-stage-chart` at y=10, h=3):

    ```typescript
    { id: 'revenue-target', x: 0, y: 13, w: 6, h: 3 },
    ```

    Also update the file comment from "7 widgets" to "8 widgets" if such a comment exists.
  </action>
  <verify>
    Run `npx tsc --noEmit` from the project root. The registry and defaults files should compile without errors. The revenue-target.tsx component should compile (it won't be imported anywhere yet, but its own types should be valid).
  </verify>
  <done>
    - `revenue-target.tsx` exists as a presentation component with typed props
    - Registry has 9 entries (8 existing + revenue-target)
    - Default layout has 8 widgets (7 existing + revenue-target at y=13)
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire data flow and render switch for revenue-target widget</name>
  <files>
    src/app/(dashboard)/page.tsx
    src/components/dashboard/dashboard-client.tsx
  </files>
  <action>
    **1. Expand revenue data fetch in `src/app/(dashboard)/page.tsx`:**

    In the `getDashboardData()` function, modify the existing `revenueKRs` query (currently at lines 39-42) to also select `krId` and `description`:

    ```typescript
    const revenueKRs = await prisma.keyResult.findMany({
      where: { metricType: 'REVENUE' },
      select: { krId: true, description: true, target: true, actual: true },
      orderBy: { krId: 'asc' },
    })
    ```

    Keep the existing `revenueTarget` and `revenueProgress` sum computations (they are used by `kpi-cards` widget).

    Add a new `revenueBreakdown` computation after those sums:

    ```typescript
    const revenueBreakdown = revenueKRs.map(kr => ({
      krId: kr.krId,
      description: kr.description,
      target: Number(kr.target),
      actual: Number(kr.actual),
    }))
    ```

    Add `revenueBreakdown` to the return object of `getDashboardData()`, alongside the existing `stats`, `byStatus`, etc.:

    ```typescript
    return {
      stats: { ... },  // unchanged
      byStatus: ...,
      byDepartment: ...,
      byPerson: ...,
      recentInitiatives: ...,
      revenueBreakdown,  // NEW
    }
    ```

    **2. Update `DashboardClientProps` in `src/components/dashboard/dashboard-client.tsx`:**

    Add `revenueBreakdown` to the `dashboardData` object type in the `DashboardClientProps` interface (after `recentInitiatives`):

    ```typescript
    dashboardData: {
      stats: { ... };  // unchanged
      byStatus: ...;
      byDepartment: ...;
      byPerson: ...;
      recentInitiatives: ...;
      revenueBreakdown: Array<{
        krId: string;
        description: string;
        target: number;
        actual: number;
      }>;
    };
    ```

    **3. Add import and render switch case in `dashboard-client.tsx`:**

    Add import at the top with the other widget imports:

    ```typescript
    import { RevenueTarget } from './revenue-target';
    ```

    Add a new case in the `renderWidget` switch, before the `default` case:

    ```typescript
    case 'revenue-target':
      return (
        <RevenueTarget
          breakdown={dashboardData.revenueBreakdown}
          totalTarget={dashboardData.stats.revenueTarget}
          totalActual={dashboardData.stats.revenueProgress}
        />
      );
    ```

    Note: `totalTarget` and `totalActual` are passed from the existing `stats.revenueTarget` and `stats.revenueProgress` values (already computed by page.tsx). The `breakdown` is the new per-KR array.
  </action>
  <verify>
    Run `npx tsc --noEmit` from the project root -- zero TypeScript errors. Then run `npm run build` to confirm the full Next.js build passes. The data flow is: page.tsx fetches per-KR breakdown -> passes to DashboardClient -> DashboardClient renders RevenueTarget component.
  </verify>
  <done>
    - page.tsx queries krId + description in the revenue KR fetch and passes `revenueBreakdown` in the return
    - DashboardClientProps interface includes `revenueBreakdown` in dashboardData
    - Render switch has a `case 'revenue-target'` that renders the RevenueTarget component with correct props
    - Full build passes with no TypeScript errors
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with zero errors
2. `npm run build` completes successfully
3. Widget registry has exactly 9 entries (verify: count entries in registry.ts)
4. Default layout has exactly 8 widgets (verify: count entries in defaults.ts)
5. The render switch in dashboard-client.tsx handles all 9 widget IDs
6. Revenue data flows from page.tsx server component through to the RevenueTarget component (no client-side fetch)
</verification>

<success_criteria>
1. Dashboard displays a revenue-target widget showing RM1,000,000 total target, current actual total, and overall progress -- with breakdown rows for Events (KR1.1, RM800K target) and AI Training (KR2.2, RM200K target)
2. Revenue-target widget is registered in the widget registry following the existing pattern (category: 'kri', minRole: EDITOR), with default layout position at y=13
3. No hardcoded revenue values in the component -- all values come from KeyResult database records
4. Full build passes with zero TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/51-revenue-target-widget/51-01-SUMMARY.md`
</output>
