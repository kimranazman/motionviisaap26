---
phase: 14-project-costs
plan: 02
type: execute
wave: 2
depends_on: ["14-01"]
files_modified:
  - src/app/api/projects/[id]/route.ts
  - src/components/projects/project-detail-sheet.tsx
autonomous: true

must_haves:
  truths:
    - "Project detail shows total costs (sum of all cost items)"
    - "Project detail shows profit (revenue minus total costs)"
    - "User can add cost items from within project detail"
    - "Costs list updates immediately after add/edit/delete"
  artifacts:
    - path: "src/app/api/projects/[id]/route.ts"
      provides: "Project detail with costs included"
      contains: "costs:"
    - path: "src/components/projects/project-detail-sheet.tsx"
      provides: "Project detail with costs section and financial summary"
      min_lines: 200
  key_links:
    - from: "src/components/projects/project-detail-sheet.tsx"
      to: "/api/cost-categories"
      via: "fetch categories for cost form"
      pattern: "fetch.*api/cost-categories"
    - from: "src/components/projects/project-detail-sheet.tsx"
      to: "CostForm"
      via: "import and render cost form"
      pattern: "import.*CostForm"
    - from: "src/components/projects/project-detail-sheet.tsx"
      to: "CostCard"
      via: "import and render cost cards"
      pattern: "import.*CostCard"
---

<objective>
Integrate costs into project detail with profit calculation

Purpose: Complete the cost tracking feature by showing costs within project context and calculating profit
Output: Enhanced ProjectDetailSheet with costs management and financial summary
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14-project-costs/14-RESEARCH.md

# Prior plan created these
@.planning/phases/14-project-costs/14-01-SUMMARY.md

# Files to modify
@src/app/api/projects/[id]/route.ts
@src/components/projects/project-detail-sheet.tsx

# Pattern reference
@src/components/companies/company-detail-modal.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend Project API to Include Costs</name>
  <files>
    src/app/api/projects/[id]/route.ts
  </files>
  <action>
Update the GET handler in `src/app/api/projects/[id]/route.ts` to include costs with category:

**Changes to GET handler:**

1. Add costs to the include block:
```typescript
costs: {
  include: {
    category: { select: { id: true, name: true } },
  },
  orderBy: [
    { date: 'desc' },
    { createdAt: 'desc' },
  ],
},
```

2. Before returning, serialize the response to convert Decimals to Numbers:
```typescript
const serialized = {
  ...project,
  revenue: project.revenue ? Number(project.revenue) : null,
  costs: project.costs.map(cost => ({
    ...cost,
    amount: Number(cost.amount),
  })),
}
return NextResponse.json(serialized)
```

Keep existing PATCH and DELETE handlers unchanged - they already work correctly.
  </action>
  <verify>
```bash
# Test project detail includes costs (replace with valid project ID)
curl -s http://localhost:3000/api/projects/[id] | jq 'keys'
# Should include "costs" key

curl -s http://localhost:3000/api/projects/[id] | jq '.costs | type'
# Should return "array"
```
  </verify>
  <done>
- GET /api/projects/[id] returns project with costs array
- Each cost has amount as Number (not string)
- Each cost includes category { id, name }
- Costs ordered by date descending
  </done>
</task>

<task type="auto">
  <name>Task 2: Add Costs Section to Project Detail Sheet</name>
  <files>
    src/components/projects/project-detail-sheet.tsx
  </files>
  <action>
Extend `ProjectDetailSheet` to include costs management and financial summary:

**1. Update Project interface:**
Add to the interface:
```typescript
costs?: {
  id: string
  description: string
  amount: number
  date: string
  category: { id: string; name: string }
}[]
```

**2. Add state variables:**
```typescript
const [costs, setCosts] = useState<Cost[]>([])
const [categories, setCategories] = useState<CostCategory[]>([])
const [showAddCostForm, setShowAddCostForm] = useState(false)
const [editingCost, setEditingCost] = useState<Cost | null>(null)
```

**3. Fetch categories on mount:**
```typescript
useEffect(() => {
  const fetchCategories = async () => {
    try {
      const response = await fetch('/api/cost-categories')
      if (response.ok) {
        const data = await response.json()
        setCategories(data)
      }
    } catch (error) {
      console.error('Failed to fetch categories:', error)
    }
  }
  fetchCategories()
}, [])
```

**4. Sync costs from project prop:**
```typescript
// In the existing useEffect that handles project changes
if (project?.costs) {
  setCosts(project.costs)
}
```

**5. Add Financial Summary section (after KRI Display, before error message):**
Using Separator, create a grid with 3 cards:
- Revenue card (green): Shows formatCurrency(project.revenue)
- Total Costs card (red): Shows formatCurrency(totalCosts) using calculateTotalCosts
- Profit card (blue if positive, orange if negative): Shows formatCurrency(profit) using calculateProfit

**6. Add Costs Section (after Financial Summary):**
Using Separator, create costs management area:
- Header: "Costs" with count badge, "Add Cost" button (if userCanEdit)
- If showAddCostForm or editingCost: Render CostForm
- If costs empty and no form: Show empty state with DollarSign icon and "Add your first cost" button
- If costs exist: Map over costs and render CostCard for each

**7. Add handler functions:**
```typescript
const handleCostAdded = async () => {
  // Refresh costs from API
  const response = await fetch(`/api/projects/${project.id}/costs`)
  if (response.ok) {
    const data = await response.json()
    setCosts(data)
  }
  setShowAddCostForm(false)
  setEditingCost(null)
}

const handleCostDeleted = async () => {
  // Refresh costs from API
  const response = await fetch(`/api/projects/${project.id}/costs`)
  if (response.ok) {
    const data = await response.json()
    setCosts(data)
  }
}

const handleEditCost = (cost: Cost) => {
  setEditingCost(cost)
  setShowAddCostForm(true)
}

const handleCancelCostForm = () => {
  setShowAddCostForm(false)
  setEditingCost(null)
}
```

**8. Reset cost form state when sheet closes:**
In the useEffect for project/open changes, also reset:
```typescript
setShowAddCostForm(false)
setEditingCost(null)
```

**Imports to add:**
```typescript
import { CostForm } from './cost-form'
import { CostCard } from './cost-card'
import { getCategoryColor, calculateTotalCosts, calculateProfit } from '@/lib/cost-utils'
import { DollarSign } from 'lucide-react'
import { Card } from '@/components/ui/card'
```

**Important:**
- Use formatCurrency from lib/utils for all money displays
- Financial summary should be visible even without costs (shows 0 for costs, revenue as profit)
- Keep all existing functionality intact (editing project fields, source display, etc.)
  </action>
  <verify>
```bash
# TypeScript compilation
npx tsc --noEmit

# Check imports
grep -l "CostForm" src/components/projects/project-detail-sheet.tsx
grep -l "CostCard" src/components/projects/project-detail-sheet.tsx
grep -l "calculateProfit" src/components/projects/project-detail-sheet.tsx

# Manual verification:
# 1. Open project detail sheet
# 2. See Financial Summary section (Revenue, Costs, Profit)
# 3. Add a cost item via form
# 4. See cost appear in list
# 5. Edit the cost
# 6. Delete the cost with confirmation
# 7. Verify totals update correctly
```
  </verify>
  <done>
- Financial Summary shows revenue, total costs, and profit
- Costs section shows list of cost items
- "Add Cost" button opens CostForm
- Cost items display with category badge and edit/delete actions
- Adding/editing/deleting costs updates totals immediately
- Form state resets when sheet closes
- All existing project editing functionality still works
  </done>
</task>

</tasks>

<verification>
Full feature verification:

1. **Cost Categories:** Visit /api/cost-categories, see 6 categories
2. **Project Detail:** Open any project detail sheet
3. **Financial Summary:** See Revenue, Total Costs, Profit cards
4. **Add Cost:** Click "Add Cost", fill form, submit - cost appears in list
5. **Edit Cost:** Click edit on cost, modify, save - changes appear
6. **Delete Cost:** Click delete, confirm - cost removed
7. **Totals Update:** After each operation, totals recalculate
8. **Profit Calculation:** Profit = Revenue - Total Costs (can be negative)
</verification>

<success_criteria>
- Project detail shows financial summary (revenue, costs, profit)
- User can add costs with description, amount, category, date
- User can edit and delete costs
- Totals and profit calculate correctly
- Reqs covered: COST-05, COST-06, PROJ-09
</success_criteria>

<output>
After completion, create `.planning/phases/14-project-costs/14-02-SUMMARY.md`
</output>
