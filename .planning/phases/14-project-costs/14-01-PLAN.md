---
phase: 14-project-costs
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/app/api/cost-categories/route.ts
  - src/app/api/projects/[id]/costs/route.ts
  - src/app/api/projects/[id]/costs/[costId]/route.ts
  - src/lib/cost-utils.ts
  - src/components/projects/cost-form.tsx
  - src/components/projects/cost-card.tsx
autonomous: true

must_haves:
  truths:
    - "User can add cost item to project with description, amount, category, date"
    - "User can select from 6 cost categories (Labor, Materials, Vendors, Travel, Software, Other)"
    - "User can edit existing cost items"
    - "User can delete cost items with confirmation"
  artifacts:
    - path: "src/app/api/cost-categories/route.ts"
      provides: "GET cost categories lookup endpoint"
      exports: ["GET"]
    - path: "src/app/api/projects/[id]/costs/route.ts"
      provides: "List and create costs for a project"
      exports: ["GET", "POST"]
    - path: "src/app/api/projects/[id]/costs/[costId]/route.ts"
      provides: "Update and delete individual costs"
      exports: ["PATCH", "DELETE"]
    - path: "src/lib/cost-utils.ts"
      provides: "Category colors, total/profit calculations"
      exports: ["getCategoryColor", "calculateTotalCosts", "calculateProfit"]
    - path: "src/components/projects/cost-form.tsx"
      provides: "Add/edit cost form with date picker"
      exports: ["CostForm"]
    - path: "src/components/projects/cost-card.tsx"
      provides: "Cost item display with edit/delete actions"
      exports: ["CostCard"]
  key_links:
    - from: "src/components/projects/cost-form.tsx"
      to: "/api/projects/[id]/costs"
      via: "fetch POST/PATCH for cost mutations"
      pattern: "fetch.*api/projects.*costs"
    - from: "src/components/projects/cost-card.tsx"
      to: "/api/projects/[id]/costs/[costId]"
      via: "fetch DELETE for cost removal"
      pattern: "fetch.*DELETE"
    - from: "src/app/api/projects/[id]/costs/route.ts"
      to: "prisma.cost"
      via: "database queries"
      pattern: "prisma\\.cost\\.(findMany|create)"
---

<objective>
Create Cost CRUD infrastructure and reusable components

Purpose: Enable tracking of project costs with categories, preparing foundation for profit calculation
Output: API routes for cost management, reusable CostForm and CostCard components
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14-project-costs/14-RESEARCH.md

# Existing patterns to follow
@src/app/api/companies/[id]/contacts/route.ts
@src/app/api/companies/[id]/contacts/[contactId]/route.ts
@src/components/companies/contact-form.tsx
@src/components/companies/contact-card.tsx
</context>

<prerequisite>
Before starting tasks, run the cost categories seed to ensure categories exist in database:

```bash
npx ts-node prisma/seed-cost-categories.ts
```

Verify output shows 6 categories created/updated.
</prerequisite>

<tasks>

<task type="auto">
  <name>Task 1: Cost API Routes</name>
  <files>
    src/app/api/cost-categories/route.ts
    src/app/api/projects/[id]/costs/route.ts
    src/app/api/projects/[id]/costs/[costId]/route.ts
  </files>
  <action>
Create three API route files following the existing contacts pattern:

**1. cost-categories/route.ts** (GET only - read-only lookup):
- GET: Return active cost categories ordered by sortOrder
- Use `requireAuth()` for read access
- Select: id, name, description
- Filter: `where: { isActive: true }`

**2. projects/[id]/costs/route.ts** (GET list, POST create):
- GET: List all costs for project with category included
- POST: Create cost with validation
- Use `requireAuth()` for GET, `requireEditor()` for POST
- Verify project exists before operations
- For POST: validate description (required, trim), amount (required, valid number), categoryId (required, must be active category)
- Include category relation: `{ select: { id: true, name: true } }`
- Order by: date desc, then createdAt desc
- IMPORTANT: Convert Decimal amount to Number before returning: `amount: Number(cost.amount)`

**3. projects/[id]/costs/[costId]/route.ts** (PATCH update, DELETE):
- PATCH: Update cost fields (description, amount, categoryId, date)
- DELETE: Remove cost item
- Use `requireEditor()` for both
- Verify cost exists AND belongs to project before operations
- If changing categoryId, verify new category is active
- Convert Decimal to Number in response

Pattern reference: Follow exact structure of `src/app/api/companies/[id]/contacts/route.ts` and `[contactId]/route.ts`
  </action>
  <verify>
```bash
# Run seed first
npx ts-node prisma/seed-cost-categories.ts

# Verify categories API
curl -s http://localhost:3000/api/cost-categories | jq 'length'
# Should return 6

# Test costs API (replace with valid project ID)
# GET should return empty array for project with no costs
# POST should create cost and return with category included
```
  </verify>
  <done>
- GET /api/cost-categories returns 6 active categories
- GET /api/projects/[id]/costs returns costs array with category
- POST /api/projects/[id]/costs creates cost with validation
- PATCH /api/projects/[id]/costs/[costId] updates cost
- DELETE /api/projects/[id]/costs/[costId] removes cost
- All Decimal amounts converted to Number in responses
  </done>
</task>

<task type="auto">
  <name>Task 2: Cost Components</name>
  <files>
    src/lib/cost-utils.ts
    src/components/projects/cost-form.tsx
    src/components/projects/cost-card.tsx
  </files>
  <action>
Create utility functions and reusable components:

**1. src/lib/cost-utils.ts**:
```typescript
// Category color mapping for badges (Tailwind classes)
export function getCategoryColor(category: string): string {
  const colors: Record<string, string> = {
    Labor: 'bg-purple-100 text-purple-700 border-purple-200',
    Materials: 'bg-amber-100 text-amber-700 border-amber-200',
    Vendors: 'bg-blue-100 text-blue-700 border-blue-200',
    Travel: 'bg-green-100 text-green-700 border-green-200',
    Software: 'bg-cyan-100 text-cyan-700 border-cyan-200',
    Other: 'bg-gray-100 text-gray-700 border-gray-200',
  }
  return colors[category] || colors.Other
}

export function calculateTotalCosts(costs: { amount: number }[]): number {
  return costs.reduce((sum, cost) => sum + Number(cost.amount), 0)
}

export function calculateProfit(revenue: number | null, totalCosts: number): number {
  return (revenue || 0) - totalCosts
}
```

**2. src/components/projects/cost-form.tsx**:
- Props: projectId, cost? (for edit), categories array, onSuccess callback, onCancel callback
- Form fields: description (Input), amount (Input type=number step=0.01), categoryId (Select), date (Calendar in Popover)
- Use date-fns format for date display
- Client-side validation: description required, amount required and valid number, categoryId required
- On submit: POST to create or PATCH to update
- Show loading state and error messages
- Follow pattern from: `src/components/initiatives/initiative-form.tsx` for date picker

**3. src/components/projects/cost-card.tsx**:
- Props: cost object, projectId, onEdit callback, onDelete callback
- Display: description, category badge with color, date formatted, amount formatted
- Actions: Edit button (calls onEdit), Delete button with AlertDialog confirmation
- Use formatCurrency from lib/utils for amount display
- Use getCategoryColor for category badge styling
- Follow pattern from: Contact card inline actions

UI components to use (all already installed):
- Input, Label, Button, Select, Calendar, Popover, AlertDialog, Badge from shadcn/ui
- Icons: Edit2, Trash2, CalendarIcon, Loader2 from lucide-react
  </action>
  <verify>
```bash
# TypeScript compilation check
npx tsc --noEmit

# Check components export correctly
grep -l "export function CostForm" src/components/projects/cost-form.tsx
grep -l "export function CostCard" src/components/projects/cost-card.tsx
grep -l "getCategoryColor" src/lib/cost-utils.ts
```
  </verify>
  <done>
- cost-utils.ts exports getCategoryColor, calculateTotalCosts, calculateProfit
- CostForm renders with all fields, submits to API, shows loading/error states
- CostCard displays cost with category badge, edit and delete actions work
- Components follow existing codebase patterns (date picker, AlertDialog)
- TypeScript compiles without errors
  </done>
</task>

</tasks>

<verification>
After both tasks complete:
1. Cost categories seed has run successfully
2. All API routes respond correctly with proper auth
3. Components render and TypeScript compiles
4. No console errors in browser
</verification>

<success_criteria>
- 6 cost categories available via API
- Cost CRUD operations work via nested API routes
- CostForm and CostCard components ready for integration
- All amounts properly converted from Decimal to Number
- Reqs covered: COST-01, COST-02, COST-03, COST-04
</success_criteria>

<output>
After completion, create `.planning/phases/14-project-costs/14-01-SUMMARY.md`
</output>
