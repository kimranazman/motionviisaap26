---
phase: 26-revenue-model-refinement
plan: 02
type: execute
wave: 2
depends_on: ["26-01"]
files_modified:
  - src/app/api/deals/reorder/route.ts
  - src/app/api/potential-projects/reorder/route.ts
  - src/lib/ai-auto-import.ts
  - src/app/api/ai/import/invoice/route.ts
  - src/app/api/projects/[id]/route.ts
autonomous: true

must_haves:
  truths:
    - "Deal WON conversion sets potentialRevenue, not revenue"
    - "Potential CONFIRMED conversion sets potentialRevenue, not revenue"
    - "AI invoice import sets revenue only (no aiImportedRevenue tracking)"
    - "Project GET API includes potentialRevenue in response"
    - "Project PATCH API ignores manual revenue input"
  artifacts:
    - path: "src/app/api/deals/reorder/route.ts"
      provides: "Deal to Project conversion with potentialRevenue"
      contains: "potentialRevenue"
    - path: "src/app/api/potential-projects/reorder/route.ts"
      provides: "Potential to Project conversion with potentialRevenue"
      contains: "potentialRevenue"
    - path: "src/lib/ai-auto-import.ts"
      provides: "Simplified AI import without aiImportedRevenue"
      contains: "revenue: results.total"
    - path: "src/app/api/ai/import/invoice/route.ts"
      provides: "Simplified invoice import without aiImportedRevenue"
      contains: "revenue: extraction.total"
  key_links:
    - from: "deals/reorder/route.ts"
      to: "prisma.project.create"
      via: "potentialRevenue field"
      pattern: "potentialRevenue.*currentDeal\\.value"
    - from: "potential-projects/reorder/route.ts"
      to: "prisma.project.create"
      via: "potentialRevenue field"
      pattern: "potentialRevenue.*currentPotential\\.estimatedValue"
---

<objective>
Update all API routes to use the new revenue model - conversions set potentialRevenue, AI imports set revenue

Purpose: Implement the data flow where estimates and actuals are tracked separately
Output: Updated API routes with correct revenue field assignments
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/26-revenue-model-refinement/26-CONTEXT.md
@.planning/phases/26-revenue-model-refinement/26-RESEARCH.md
@.planning/phases/26-revenue-model-refinement/26-01-SUMMARY.md
@src/app/api/deals/reorder/route.ts
@src/app/api/potential-projects/reorder/route.ts
@src/lib/ai-auto-import.ts
@src/app/api/ai/import/invoice/route.ts
@src/app/api/projects/[id]/route.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update conversion routes to set potentialRevenue</name>
  <files>
    src/app/api/deals/reorder/route.ts
    src/app/api/potential-projects/reorder/route.ts
  </files>
  <action>
**In src/app/api/deals/reorder/route.ts (line 54-62):**

Change the project creation data from:
```typescript
const project = await tx.project.create({
  data: {
    title: currentDeal.title,
    description: null,
    revenue: currentDeal.value,  // CHANGE THIS
    ...
  },
})
```

To:
```typescript
const project = await tx.project.create({
  data: {
    title: currentDeal.title,
    description: null,
    potentialRevenue: currentDeal.value,  // Set potential, not actual
    // revenue is null - will be set by AI invoice import
    ...
  },
})
```

**In src/app/api/potential-projects/reorder/route.ts (line 55-63):**

Change the project creation data from:
```typescript
const project = await tx.project.create({
  data: {
    title: currentPotential.title,
    description: currentPotential.description,
    revenue: currentPotential.estimatedValue,  // CHANGE THIS
    ...
  },
})
```

To:
```typescript
const project = await tx.project.create({
  data: {
    title: currentPotential.title,
    description: currentPotential.description,
    potentialRevenue: currentPotential.estimatedValue,  // Set potential, not actual
    // revenue is null - will be set by AI invoice import
    ...
  },
})
```
  </action>
  <verify>
grep -n "potentialRevenue" src/app/api/deals/reorder/route.ts src/app/api/potential-projects/reorder/route.ts
# Should show potentialRevenue in both files
  </verify>
  <done>Deal WON and Potential CONFIRMED conversions set potentialRevenue, not revenue</done>
</task>

<task type="auto">
  <name>Task 2: Simplify AI import routes - remove aiImportedRevenue</name>
  <files>
    src/lib/ai-auto-import.ts
    src/app/api/ai/import/invoice/route.ts
  </files>
  <action>
**In src/lib/ai-auto-import.ts (around line 156-162):**

Change from:
```typescript
await prisma.project.update({
  where: { id: projectId },
  data: {
    revenue: results.total,
    aiImportedRevenue: results.total,  // REMOVE THIS LINE
  },
})
```

To:
```typescript
await prisma.project.update({
  where: { id: projectId },
  data: {
    revenue: results.total,  // Only set actual revenue
  },
})
```

**In src/app/api/ai/import/invoice/route.ts (around line 38-39, 80-87, 100-106):**

1. Remove aiImportedRevenue from project select (line 38):
```typescript
// BEFORE:
select: { id: true, revenue: true, aiImportedRevenue: true },
// AFTER:
select: { id: true, revenue: true, potentialRevenue: true },
```

2. Update project update data (line 80-87):
```typescript
// BEFORE:
updatedProject = await prisma.project.update({
  where: { id: projectId },
  data: {
    revenue: extraction.total,
    aiImportedRevenue: extraction.total,  // REMOVE
  },
  select: { id: true, revenue: true, aiImportedRevenue: true },  // UPDATE
})

// AFTER:
updatedProject = await prisma.project.update({
  where: { id: projectId },
  data: {
    revenue: extraction.total,  // Only set actual revenue
  },
  select: { id: true, revenue: true, potentialRevenue: true },
})
```

3. Update response (line 100-106):
```typescript
// BEFORE:
project: {
  id: updatedProject.id,
  revenue: updatedProject.revenue ? Number(updatedProject.revenue) : null,
  aiImportedRevenue: updatedProject.aiImportedRevenue ? Number(updatedProject.aiImportedRevenue) : null,
},

// AFTER:
project: {
  id: updatedProject.id,
  revenue: updatedProject.revenue ? Number(updatedProject.revenue) : null,
  potentialRevenue: updatedProject.potentialRevenue ? Number(updatedProject.potentialRevenue) : null,
},
```
  </action>
  <verify>
grep -n "aiImportedRevenue" src/lib/ai-auto-import.ts src/app/api/ai/import/invoice/route.ts
# Should return nothing - aiImportedRevenue is removed from both files
  </verify>
  <done>AI import routes only set revenue field, aiImportedRevenue references removed</done>
</task>

<task type="auto">
  <name>Task 3: Update projects API route</name>
  <files>src/app/api/projects/[id]/route.ts</files>
  <action>
**In src/app/api/projects/[id]/route.ts:**

1. Update GET response serialization (around line 54-61) to include potentialRevenue:
```typescript
// BEFORE:
const serialized = {
  ...project,
  revenue: project.revenue ? Number(project.revenue) : null,
  costs: project.costs.map(cost => ({
    ...cost,
    amount: Number(cost.amount),
  })),
}

// AFTER:
const serialized = {
  ...project,
  revenue: project.revenue ? Number(project.revenue) : null,
  potentialRevenue: project.potentialRevenue ? Number(project.potentialRevenue) : null,
  costs: project.costs.map(cost => ({
    ...cost,
    amount: Number(cost.amount),
  })),
}
```

2. REMOVE revenue from PATCH allowed fields (around line 90):
```typescript
// BEFORE:
...(body.revenue !== undefined && { revenue: body.revenue ? parseFloat(body.revenue) : null }),

// AFTER:
// REMOVE THIS LINE ENTIRELY - revenue should only be set by AI invoice import
```

This prevents manual revenue overrides via the API.
  </action>
  <verify>
# Verify potentialRevenue added and revenue removed from PATCH
grep -n "potentialRevenue\|body.revenue" src/app/api/projects/[id]/route.ts
# Should show potentialRevenue in serialization, but NOT body.revenue in PATCH
  </verify>
  <done>GET returns potentialRevenue, PATCH no longer accepts revenue updates</done>
</task>

</tasks>

<verification>
1. grep "potentialRevenue" on all modified files - should be present
2. grep "aiImportedRevenue" on all modified files - should return nothing
3. grep "body.revenue" on projects/[id]/route.ts - should return nothing
4. TypeScript compiles: `npx tsc --noEmit`
</verification>

<success_criteria>
- Deal WON conversion: sets potentialRevenue, not revenue
- Potential CONFIRMED conversion: sets potentialRevenue, not revenue
- AI invoice import: sets revenue only (no aiImportedRevenue)
- Project GET: includes potentialRevenue in response
- Project PATCH: revenue field is NOT updateable via API
- No TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/26-revenue-model-refinement/26-02-SUMMARY.md`
</output>
