---
phase: 26-revenue-model-refinement
plan: 03
type: execute
wave: 2
depends_on: ["26-01"]
files_modified:
  - src/components/projects/project-detail-sheet.tsx
autonomous: true

must_haves:
  truths:
    - "Manual revenue input field is removed from project edit form"
    - "FinancialsSummary shows potential revenue card"
    - "FinancialsSummary shows actual revenue card"
    - "Variance row shows difference between potential and actual"
    - "Profit card margin text is not cut off on narrow screens"
  artifacts:
    - path: "src/components/projects/project-detail-sheet.tsx"
      provides: "Updated FinancialsSummary with dual revenue display"
      contains: "potentialRevenue"
  key_links:
    - from: "src/components/projects/project-detail-sheet.tsx"
      to: "FinancialsSummary"
      via: "props"
      pattern: "potentialRevenue.*revenue.*totalCosts"
---

<objective>
Update the project detail UI to show separate potential and actual revenue with variance calculation, remove manual revenue input

Purpose: Provide clear visual distinction between estimated and confirmed revenue
Output: Updated FinancialsSummary component with dual revenue display and variance row
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/26-revenue-model-refinement/26-CONTEXT.md
@.planning/phases/26-revenue-model-refinement/26-RESEARCH.md
@.planning/phases/26-revenue-model-refinement/26-01-SUMMARY.md
@src/components/projects/project-detail-sheet.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update Project interface and remove manual revenue input</name>
  <files>src/components/projects/project-detail-sheet.tsx</files>
  <action>
**1. Update Project interface (around line 93-108):**

Add potentialRevenue, remove aiImportedRevenue:
```typescript
interface Project {
  id: string
  title: string
  description: string | null
  revenue: number | null              // Actual revenue from AI invoices
  potentialRevenue: number | null     // ADD: From deal/potential conversion
  // REMOVE: aiImportedRevenue?: number | null
  status: string
  startDate: string | null
  endDate: string | null
  company: { id: string; name: string } | null
  contact: { id: string; name: string } | null
  initiative: { id: string; title: string } | null
  sourceDeal: { id: string; title: string; stageChangedAt?: string } | null
  sourcePotential: { id: string; title: string } | null
  costs?: Cost[]
}
```

**2. Remove revenue state and related code:**

Remove these lines (around line 278, 323, 428):
```typescript
// REMOVE line ~278:
const [revenue, setRevenue] = useState('')

// REMOVE from useEffect line ~323:
setRevenue(project.revenue?.toString() || '')

// REMOVE from handleSave body line ~428:
revenue: revenue ? parseFloat(revenue) : null,
```

**3. Remove revenue input field from JSX (around lines 703-715):**

Remove the entire revenue input section:
```typescript
// REMOVE THIS ENTIRE BLOCK:
{/* Revenue */}
<div className="space-y-2">
  <Label htmlFor="edit-revenue">Revenue</Label>
  <Input
    id="edit-revenue"
    type="number"
    step="0.01"
    min="0"
    value={revenue}
    onChange={(e) => setRevenue(e.target.value)}
    placeholder="0.00"
  />
</div>
```
  </action>
  <verify>
grep -n "setRevenue\|edit-revenue" src/components/projects/project-detail-sheet.tsx
# Should return nothing - all manual revenue input code removed
  </verify>
  <done>Manual revenue input is removed from project edit form</done>
</task>

<task type="auto">
  <name>Task 2: Redesign FinancialsSummary for dual revenue with variance</name>
  <files>src/components/projects/project-detail-sheet.tsx</files>
  <action>
**Update FinancialsSummary props interface and component (lines 118-263):**

Replace the entire FinancialsSummary component with this new version:

```typescript
// Updated Financials Summary sub-component
interface FinancialsSummaryProps {
  potentialRevenue: number | null   // From deal/potential conversion
  revenue: number | null            // Actual revenue from AI invoices
  totalCosts: number
  profit: number
  costsCount: number
  aiImportedCostsCount?: number
}

function FinancialsSummary({ potentialRevenue, revenue, totalCosts, profit, costsCount, aiImportedCostsCount }: FinancialsSummaryProps) {
  const potentialValue = potentialRevenue ?? 0
  const actualValue = revenue ?? 0
  const hasAiCosts = (aiImportedCostsCount ?? 0) > 0
  const hasNoData = potentialValue === 0 && actualValue === 0 && totalCosts === 0

  // Check what data we have
  const hasPotential = potentialValue > 0
  const hasActual = actualValue > 0
  const hasBothRevenues = hasPotential && hasActual

  // Calculate variance (actual - potential)
  const variance = actualValue - potentialValue
  const variancePercent = potentialValue > 0
    ? Math.round((variance / potentialValue) * 100)
    : 0
  const isAboveEstimate = variance > 0
  const isBelowEstimate = variance < 0

  // Use actual revenue for profit calculation if available, otherwise use potential
  const revenueForProfit = hasActual ? actualValue : potentialValue

  // Calculate margin percentage
  const margin = revenueForProfit > 0
    ? Math.round(((revenueForProfit - totalCosts) / revenueForProfit) * 100)
    : 0

  // Determine profit/loss status
  const isProfitable = profit > 0
  const isBreakEven = profit === 0
  const isLoss = profit < 0

  // Get icon based on profit status
  const ProfitIcon = isProfitable ? TrendingUp : isLoss ? TrendingDown : Minus

  if (hasNoData) {
    return (
      <div className="space-y-3">
        <Label className="text-muted-foreground">Financials Summary</Label>
        <Card className="p-6 text-center border-dashed">
          <DollarSign className="mx-auto h-8 w-8 text-gray-400 mb-2" />
          <p className="text-sm text-gray-500">No financial data yet</p>
          <p className="text-xs text-gray-400 mt-1">
            Revenue will appear after deal conversion or invoice import
          </p>
        </Card>
      </div>
    )
  }

  return (
    <div className="space-y-3">
      <Label className="text-muted-foreground">Financials Summary</Label>

      {/* Revenue cards - Potential and Actual side by side */}
      <div className="grid grid-cols-2 gap-3">
        {/* Potential Revenue Card */}
        <Card className={cn(
          'p-3',
          hasPotential ? 'bg-blue-50 border-blue-200' : 'bg-gray-50 border-gray-200'
        )}>
          <div className="flex items-center gap-2">
            <Target className={cn(
              'h-4 w-4',
              hasPotential ? 'text-blue-600' : 'text-gray-400'
            )} />
            <div className={cn(
              'text-xs font-medium',
              hasPotential ? 'text-blue-600' : 'text-gray-500'
            )}>Potential</div>
          </div>
          <div className={cn(
            'text-lg font-semibold mt-1',
            hasPotential ? 'text-blue-700' : 'text-gray-500'
          )}>
            {formatCurrency(potentialValue)}
          </div>
          <div className={cn(
            'text-xs mt-0.5',
            hasPotential ? 'text-blue-600/70' : 'text-gray-400'
          )}>
            {hasPotential ? 'From deal/estimate' : 'No estimate'}
          </div>
        </Card>

        {/* Actual Revenue Card */}
        <Card className={cn(
          'p-3',
          hasActual ? 'bg-green-50 border-green-200' : 'bg-gray-50 border-gray-200'
        )}>
          <div className="flex items-center gap-2">
            <TrendingUp className={cn(
              'h-4 w-4',
              hasActual ? 'text-green-600' : 'text-gray-400'
            )} />
            <div className={cn(
              'text-xs font-medium',
              hasActual ? 'text-green-600' : 'text-gray-500'
            )}>Actual</div>
            {hasActual && (
              <div className="flex items-center gap-0.5 bg-purple-100 text-purple-700 text-[10px] px-1.5 py-0.5 rounded-full font-medium">
                <Sparkles className="h-2.5 w-2.5" />
                AI
              </div>
            )}
          </div>
          <div className={cn(
            'text-lg font-semibold mt-1',
            hasActual ? 'text-green-700' : 'text-gray-500'
          )}>
            {formatCurrency(actualValue)}
          </div>
          <div className={cn(
            'text-xs mt-0.5',
            hasActual ? 'text-green-600/70' : 'text-gray-400'
          )}>
            {hasActual ? 'From invoice' : 'No invoices yet'}
          </div>
        </Card>
      </div>

      {/* Variance row - only show if both potential and actual exist */}
      {hasBothRevenues && (
        <Card className={cn(
          'p-2 px-3',
          isAboveEstimate && 'bg-green-50 border-green-200',
          isBelowEstimate && 'bg-amber-50 border-amber-200',
          variance === 0 && 'bg-gray-50 border-gray-200'
        )}>
          <div className="flex items-center justify-between text-sm">
            <span className={cn(
              'font-medium',
              isAboveEstimate && 'text-green-700',
              isBelowEstimate && 'text-amber-700',
              variance === 0 && 'text-gray-600'
            )}>
              Variance
            </span>
            <span className={cn(
              'font-semibold',
              isAboveEstimate && 'text-green-700',
              isBelowEstimate && 'text-amber-700',
              variance === 0 && 'text-gray-600'
            )}>
              {isAboveEstimate ? '+' : ''}{formatCurrency(variance)} ({isAboveEstimate ? '+' : ''}{variancePercent}%)
            </span>
          </div>
        </Card>
      )}

      {/* Total Costs Card */}
      <Card className="p-3 bg-red-50 border-red-200">
        <div className="flex items-center gap-2">
          <TrendingDown className="h-4 w-4 text-red-600" />
          <div className="text-xs text-red-600 font-medium">Total Costs</div>
          {hasAiCosts && (
            <div className="flex items-center gap-0.5 bg-purple-100 text-purple-700 text-[10px] px-1.5 py-0.5 rounded-full font-medium">
              <Sparkles className="h-2.5 w-2.5" />
              AI
            </div>
          )}
        </div>
        <div className="text-lg font-semibold text-red-700 mt-1">
          {formatCurrency(totalCosts)}
        </div>
        <div className="text-xs text-red-600/70 mt-0.5">
          {hasAiCosts
            ? `${aiImportedCostsCount} of ${costsCount} from AI`
            : `From ${costsCount} expense${costsCount !== 1 ? 's' : ''}`}
        </div>
      </Card>

      {/* Profit/Loss card - full width */}
      <Card className={cn(
        'p-3 overflow-hidden',
        isProfitable && 'bg-green-100 border-green-200',
        isLoss && 'bg-red-100 border-red-200',
        isBreakEven && 'bg-gray-100 border-gray-200'
      )}>
        <div className="flex items-center justify-between gap-2">
          <div className="min-w-0 flex-1">
            <div className="flex items-center gap-2">
              <ProfitIcon className={cn(
                'h-4 w-4 flex-shrink-0',
                isProfitable && 'text-green-700',
                isLoss && 'text-red-700',
                isBreakEven && 'text-gray-600'
              )} />
              <div className={cn(
                'text-xs font-medium',
                isProfitable && 'text-green-700',
                isLoss && 'text-red-700',
                isBreakEven && 'text-gray-600'
              )}>
                {isProfitable ? 'Profit' : isLoss ? 'Loss' : 'Break-even'}
              </div>
            </div>
            <div className={cn(
              'text-xl font-bold mt-1 truncate',
              isProfitable && 'text-green-800',
              isLoss && 'text-red-800',
              isBreakEven && 'text-gray-700'
            )}>
              {formatCurrency(Math.abs(profit))}
            </div>
          </div>
          {revenueForProfit > 0 && (
            <div className={cn(
              'text-right flex-shrink-0 whitespace-nowrap',
              isProfitable && 'text-green-700',
              isLoss && 'text-red-700',
              isBreakEven && 'text-gray-600'
            )}>
              <div className="text-xs font-medium">Margin</div>
              <div className="text-lg font-semibold">{margin}%</div>
            </div>
          )}
        </div>
      </Card>
    </div>
  )
}
```

**Also update the FinancialsSummary usage (around line 600-605):**

Update where FinancialsSummary is called to pass potentialRevenue:

```typescript
// Find the current usage and update it:
<FinancialsSummary
  potentialRevenue={project.potentialRevenue}  // ADD THIS
  revenue={project.revenue}
  totalCosts={totalCosts}
  profit={profit}
  costsCount={costs.length}
  aiImportedCostsCount={costs.filter(c => c.aiImported).length}
/>
```

**Update profit calculation (around line 599):**

Change from using project.revenue to preferring actual revenue:
```typescript
// Update the profit calculation to use actual revenue if available, else potential
const revenueForProfit = project.revenue ?? project.potentialRevenue ?? 0
const profit = calculateProfit(revenueForProfit, totalCosts)
```
  </action>
  <verify>
# Check component has potentialRevenue support
grep -c "potentialRevenue" src/components/projects/project-detail-sheet.tsx
# Should return at least 5 occurrences (interface, props, card, variance calc, usage)

# Check margin div has flex-shrink-0 and whitespace-nowrap
grep "flex-shrink-0.*whitespace-nowrap\|whitespace-nowrap.*flex-shrink-0" src/components/projects/project-detail-sheet.tsx
# Should return 1 match
  </verify>
  <done>FinancialsSummary shows potential and actual revenue with variance, profit card margin fixed</done>
</task>

</tasks>

<verification>
1. No TypeScript errors: `npx tsc --noEmit`
2. grep "setRevenue" returns nothing (manual input removed)
3. grep "potentialRevenue" returns multiple matches (new feature added)
4. Component renders correctly with mock data
</verification>

<success_criteria>
- Manual revenue input field is completely removed
- Project interface includes potentialRevenue, not aiImportedRevenue
- FinancialsSummary shows two revenue cards (Potential in blue, Actual in green)
- Variance row appears only when both values exist
- Variance shows +/- with percentage
- Profit card margin text has flex-shrink-0 and whitespace-nowrap to prevent cutoff
- Profit calculation uses actual revenue if available, else potential
</success_criteria>

<output>
After completion, create `.planning/phases/26-revenue-model-refinement/26-03-SUMMARY.md`
</output>
