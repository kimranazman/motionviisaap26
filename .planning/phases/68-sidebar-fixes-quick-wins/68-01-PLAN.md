---
phase: 68-sidebar-fixes-quick-wins
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/hooks/use-nav-visibility.ts
  - src/components/layout/sidebar.tsx
  - src/app/(dashboard)/settings/page.tsx
autonomous: true

must_haves:
  truths:
    - "User hides a nav item in Settings, clicks Save, and the item stays hidden across all page navigations and browser refreshes"
    - "Save button appears only when sidebar visibility state has unsaved changes"
    - "Toast notification confirms successful save"
    - "Sidebar visually updates immediately after saving without page reload"
  artifacts:
    - path: "src/lib/hooks/use-nav-visibility.ts"
      provides: "Nav visibility hook without autoReveal, with saveHiddenItems batch persist"
      contains: "saveHiddenItems"
    - path: "src/components/layout/sidebar.tsx"
      provides: "Sidebar without autoReveal useEffect"
    - path: "src/app/(dashboard)/settings/page.tsx"
      provides: "Settings page with local state, dirty detection, Save button, toast"
      contains: "isDirty"
  key_links:
    - from: "src/app/(dashboard)/settings/page.tsx"
      to: "src/lib/hooks/use-nav-visibility.ts"
      via: "saveHiddenItems function call on Save click"
      pattern: "saveHiddenItems"
    - from: "src/app/(dashboard)/settings/page.tsx"
      to: "sonner"
      via: "toast.success on save"
      pattern: "toast\\.success"
    - from: "src/components/layout/sidebar.tsx"
      to: "src/lib/hooks/use-nav-visibility.ts"
      via: "isVisible filtering (no autoReveal)"
      pattern: "isVisible"
---

<objective>
Fix sidebar nav visibility bugs and add a Save button with dirty detection to the Settings page.

Purpose: Users currently lose their hidden nav item settings because the autoReveal function re-shows hidden items on pathname changes. The fire-and-forget per-toggle PATCH causes race conditions. This plan removes autoReveal entirely, replaces fire-and-forget with batch save, adds dirty detection and a Save button, and shows a toast on successful save.

Output: Refactored `use-nav-visibility.ts` hook, cleaned `sidebar.tsx`, and reworked `settings/page.tsx` with Save button + dirty detection + toast.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/68-sidebar-fixes-quick-wins/68-RESEARCH.md

@src/lib/hooks/use-nav-visibility.ts
@src/components/layout/sidebar.tsx
@src/app/(dashboard)/settings/page.tsx
@src/lib/nav-config.ts
@src/components/layout/mobile-sidebar.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Refactor use-nav-visibility hook -- remove autoReveal, add saveHiddenItems</name>
  <files>src/lib/hooks/use-nav-visibility.ts</files>
  <action>
Refactor the `useNavVisibility` hook with these changes:

1. **Remove autoReveal entirely:**
   - Delete the `autoReveal` callback function (lines 73-100)
   - Delete the `lastRevealedRef` ref (line 14)
   - Remove `autoReveal` from the return object (line 102)

2. **Remove fire-and-forget PATCH from toggleItem:**
   - Keep `toggleItem` for local state changes only (just the `setHiddenItems` call)
   - Remove the `fetch('/api/user/preferences', ...)` call inside `toggleItem`
   - This makes toggleItem a pure local state toggle

3. **Add `saveHiddenItems` function:**
   ```typescript
   const saveHiddenItems = useCallback(
     async (items: string[]) => {
       const response = await fetch('/api/user/preferences', {
         method: 'PATCH',
         headers: { 'Content-Type': 'application/json' },
         body: JSON.stringify({ hiddenNavItems: items }),
       })
       if (!response.ok) throw new Error('Failed to save')
       setHiddenItems(items)
     },
     []
   )
   ```

4. **Update return object:**
   - Return `{ hiddenItems, isLoading, isVisible, toggleItem, saveHiddenItems }`
   - No longer returns `autoReveal`

The hook signature changes from:
`{ hiddenItems, isLoading, isVisible, toggleItem, autoReveal }`
to:
`{ hiddenItems, isLoading, isVisible, toggleItem, saveHiddenItems }`

Note: `toggleItem` is still returned for backward compatibility (local state toggle without persist). The settings page will use its own local state + `saveHiddenItems` for batch persist.
  </action>
  <verify>
Run `npx tsc --noEmit` to ensure no TypeScript errors. Verify `autoReveal` is no longer exported. Verify `saveHiddenItems` is exported.
  </verify>
  <done>
Hook no longer has autoReveal function. toggleItem no longer fires PATCH. saveHiddenItems function persists hidden items in a single batch call and updates local state atomically.
  </done>
</task>

<task type="auto">
  <name>Task 2: Remove autoReveal usage from sidebar component</name>
  <files>src/components/layout/sidebar.tsx</files>
  <action>
Update `sidebar.tsx` to stop using autoReveal:

1. **Update hook destructure (line 18):**
   Change from:
   `const { isVisible, autoReveal } = useNavVisibility()`
   to:
   `const { isVisible } = useNavVisibility()`

2. **Remove the autoReveal useEffect (lines 21-23):**
   Delete entirely:
   ```typescript
   useEffect(() => {
     autoReveal(pathname)
   }, [pathname, autoReveal])
   ```

3. **Clean up imports (line 1):**
   Remove `useEffect` from the React import since it is no longer used in this component. Keep `useMemo`.
   Change: `import { useEffect, useMemo } from 'react'`
   To: `import { useMemo } from 'react'`

No other changes needed. The sidebar already uses `isVisible` for filtering, which continues to work. Mobile sidebar (`mobile-sidebar.tsx`) does NOT call autoReveal and needs NO changes.
  </action>
  <verify>
Run `npx tsc --noEmit` to ensure no TypeScript errors. Grep for `autoReveal` in the entire `src/components/layout/` directory -- should return zero matches.
  </verify>
  <done>
Sidebar no longer calls autoReveal on pathname changes. Hidden nav items stay hidden regardless of navigation. Mobile sidebar unchanged (already correct).
  </done>
</task>

<task type="auto">
  <name>Task 3: Add Save button with dirty detection and toast to Settings page</name>
  <files>src/app/(dashboard)/settings/page.tsx</files>
  <action>
Rework the Sidebar Navigation section of the Settings page to use local editing state with a Save button:

1. **Add imports:**
   - Add `import { useState, useEffect } from 'react'` (useState for local state, useEffect to sync initial state)
   - Add `import { toast } from 'sonner'`
   - Add `import { Button } from '@/components/ui/button'`

2. **Replace direct hook toggle with local state:**
   Instead of using `toggleItem` from the hook directly, maintain local editing state:

   ```typescript
   const { hiddenItems, isLoading: navLoading, saveHiddenItems } = useNavVisibility()
   const [localHidden, setLocalHidden] = useState<string[]>([])
   const [isSaving, setIsSaving] = useState(false)

   // Sync local state when hook loads persisted state
   useEffect(() => {
     if (!navLoading) {
       setLocalHidden(hiddenItems)
     }
   }, [navLoading, hiddenItems])

   // Dirty detection: compare sorted arrays
   const isDirty = JSON.stringify([...localHidden].sort()) !==
                   JSON.stringify([...hiddenItems].sort())

   // Local toggle (no persist)
   const handleToggle = (href: string) => {
     if (isAlwaysVisible(href)) return
     setLocalHidden((prev) =>
       prev.includes(href)
         ? prev.filter((h) => h !== href)
         : [...prev, href]
     )
   }

   // Save handler
   const handleSave = async () => {
     setIsSaving(true)
     try {
       await saveHiddenItems(localHidden)
       toast.success('Settings saved')
     } catch {
       toast.error('Failed to save settings')
     } finally {
       setIsSaving(false)
     }
   }
   ```

3. **Update Switch components:**
   Replace `onCheckedChange={() => toggleItem(item.href)}` with `onCheckedChange={() => handleToggle(item.href)}` for ALL nav items (both group items and top-level items).

   Update visibility check to use local state:
   Replace `const visible = alwaysOn || isVisible(item.href)` with `const visible = alwaysOn || !localHidden.includes(item.href)`

4. **Add Save button:**
   Place the Save button inside the Sidebar Navigation Card, after the nav items list but before the closing `</div>` of the card. It should only appear when `isDirty` is true:

   ```tsx
   {isDirty && (
     <div className="pt-4 border-t border-gray-200">
       <Button
         onClick={handleSave}
         disabled={isSaving}
         className="w-full"
       >
         {isSaving ? 'Saving...' : 'Save Changes'}
       </Button>
     </div>
   )}
   ```

5. **Ensure the Card structure is correct:**
   The Save button goes inside the Sidebar Navigation `<Card>`, as the last child of the `space-y-4` div, after the loading skeleton / nav items section.

Do NOT change the Detail View Mode card -- it remains unchanged.
Do NOT change the always-visible items display or settings item display logic.
  </action>
  <verify>
Run `npx tsc --noEmit` to ensure no TypeScript errors. Run `npm run build` to verify the page builds without errors. Manually verify: open Settings page, toggle a nav item, confirm Save button appears. Click Save, confirm toast appears. Navigate away and back -- confirm the change persisted.
  </verify>
  <done>
Settings page uses local state for toggle edits. Save button appears only when there are unsaved changes (dirty detection). Clicking Save persists all changes in a single batch PATCH, shows "Settings saved" toast on success or "Failed to save settings" toast on error. Sidebar updates immediately after save because `saveHiddenItems` updates the hook's internal state.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with zero errors
2. `npm run build` succeeds
3. No references to `autoReveal` anywhere in `src/components/layout/`
4. `saveHiddenItems` is exported from `use-nav-visibility.ts`
5. Settings page shows Save button only when toggles have been changed
6. After saving, sidebar reflects changes without page reload
7. Hidden items persist across browser refresh
</verification>

<success_criteria>
- SIDE-01: Hidden nav items stay hidden regardless of URL navigation (autoReveal removed)
- SIDE-02: Settings page has a Save button that batch-persists all visibility changes
- SIDE-03: Save button only visible when local state differs from persisted state
- SIDE-04: Sidebar updates immediately after save (hook state updated atomically)
- SIDE-05: Toast notification "Settings saved" appears on successful save
</success_criteria>

<output>
After completion, create `.planning/phases/68-sidebar-fixes-quick-wins/68-01-SUMMARY.md`
</output>
