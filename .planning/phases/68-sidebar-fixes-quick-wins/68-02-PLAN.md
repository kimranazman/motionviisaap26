---
phase: 68-sidebar-fixes-quick-wins
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/app/(dashboard)/page.tsx
autonomous: true

must_haves:
  truths:
    - "Dashboard CRM Revenue KPI shows the sum of per-project revenue-or-potentialRevenue for ACTIVE and COMPLETED projects"
    - "Projects with both revenue and potentialRevenue count actual revenue only (no double-counting)"
    - "Profit calculation uses the corrected revenue total"
    - "User can create tasks on projects with COMPLETED status"
    - "User can create subtasks on tasks belonging to completed projects"
    - "User can edit existing tasks on completed projects"
  artifacts:
    - path: "src/app/(dashboard)/page.tsx"
      provides: "Fixed getCRMDashboardData revenue query using findMany + JS coalesce"
      contains: "revenue ?? potentialRevenue"
  key_links:
    - from: "src/app/(dashboard)/page.tsx"
      to: "prisma.project.findMany"
      via: "Query for ACTIVE + COMPLETED projects with revenue and potentialRevenue fields"
      pattern: "status.*in.*ACTIVE.*COMPLETED"
---

<objective>
Fix dashboard CRM Revenue KPI accuracy and verify task CRUD on completed projects.

Purpose: The dashboard currently aggregates only the `revenue` field for COMPLETED projects, ignoring `potentialRevenue` and ACTIVE projects entirely. This understates actual revenue. Additionally, the requirements state task CRUD should work on completed projects -- research found no blocking code, so this needs verification.

Output: Fixed revenue query in `page.tsx` using `findMany` with JS-level coalesce. Task CRUD verified working on completed projects (no code changes expected).
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/68-sidebar-fixes-quick-wins/68-RESEARCH.md

@src/app/(dashboard)/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix dashboard revenue query to use per-project coalesce for ACTIVE + COMPLETED</name>
  <files>src/app/(dashboard)/page.tsx</files>
  <action>
In the `getCRMDashboardData()` function, replace the revenue aggregation query (approximately lines 182-194) with a per-project coalesce approach:

**Current code to replace:**
```typescript
// Revenue from completed projects
const revenueResult = await prisma.project.aggregate({
  where: { status: 'COMPLETED' },
  _sum: { revenue: true }
})

// Total costs from all projects
const costsResult = await prisma.cost.aggregate({
  _sum: { amount: true }
})

const totalRevenue = Number(revenueResult._sum.revenue) || 0
const totalCosts = Number(costsResult._sum.amount) || 0
const profit = totalRevenue - totalCosts
```

**Replace with:**
```typescript
// Revenue: per-project coalesce (prefer actual revenue, fall back to potentialRevenue)
// Include both ACTIVE and COMPLETED projects
const revenueProjects = await prisma.project.findMany({
  where: { status: { in: ['ACTIVE', 'COMPLETED'] } },
  select: { revenue: true, potentialRevenue: true },
})

const totalRevenue = revenueProjects.reduce((sum, p) => {
  const projectRevenue = Number(p.revenue) || Number(p.potentialRevenue) || 0
  return sum + projectRevenue
}, 0)

// Total costs from all projects
const costsResult = await prisma.cost.aggregate({
  _sum: { amount: true }
})

const totalCosts = Number(costsResult._sum.amount) || 0
const profit = totalRevenue - totalCosts
```

**Why this approach:**
- Prisma `aggregate` does not support SQL COALESCE, so we cannot do `_sum` on an expression
- `findMany` with `select` fetches only the two needed fields (lightweight)
- JS-level `Number(p.revenue) || Number(p.potentialRevenue) || 0` implements the coalesce:
  - If `revenue` is non-null and non-zero, use it
  - Else if `potentialRevenue` is non-null and non-zero, use it
  - Else 0
- This prevents double-counting: each project contributes exactly one value
- ACTIVE + COMPLETED matches the requirements (REV-02)

**Important:** Keep the costs query unchanged (`prisma.cost.aggregate`). The requirements only specify fixing revenue. The `profit` calculation already uses `totalRevenue - totalCosts` which will automatically update.

Do NOT change any other queries in `getCRMDashboardData()`. Do NOT change `CRMKPICards` component or any other downstream consumer.
  </action>
  <verify>
Run `npx tsc --noEmit` to ensure no TypeScript errors. Run `npm run build` to verify the page builds. Verify the dashboard loads without errors by checking the dev server.
  </verify>
  <done>
Dashboard CRM Revenue KPI uses per-project `revenue ?? potentialRevenue` for ACTIVE and COMPLETED projects. No double-counting. Profit calculation updated consistently.
  </done>
</task>

<task type="auto">
  <name>Task 2: Verify task CRUD works on completed projects</name>
  <files></files>
  <action>
Research found NO code blocking task CRUD on completed projects. This task verifies that claim by checking the actual runtime behavior:

1. **Check the task API routes for status guards:**
   - Read `src/app/api/projects/[id]/tasks/route.ts` -- confirm POST handler does not check project status
   - Read `src/app/api/projects/[id]/tasks/[taskId]/route.ts` -- confirm PATCH/DELETE handlers do not check project status

2. **Check the task UI components for disabled states:**
   - Read `src/components/projects/task-tree.tsx` -- confirm no `status` prop or read-only guard
   - Read `src/components/projects/task-form.tsx` -- confirm no status-based disabling
   - Read `src/components/projects/task-detail-sheet.tsx` -- confirm subtask creation and editing not blocked by status
   - Read `src/components/projects/project-detail-sheet.tsx` -- confirm TaskTree is rendered without status-based read-only flag

3. **Check the Tasks page for project filtering:**
   - Read `src/components/tasks/tasks-page-client.tsx` -- confirm completed projects are available in the project selector for new task creation

4. **Document findings:**
   - If all checks pass (no status guards found), document: "Task CRUD on completed projects verified -- no blocking code exists. TASK-01, TASK-02, TASK-03 confirmed working."
   - If any blocking code IS found, fix it by removing the status guard (since the requirement explicitly says tasks should work on completed projects).

**Expected outcome:** No code changes needed. This is a verification task that confirms the research finding.
  </action>
  <verify>
Grep for `status.*COMPLETED` or `COMPLETED.*status` in all task-related files to confirm no guards exist. Run `npx tsc --noEmit` to ensure no TypeScript errors (in case any fix was applied).
  </verify>
  <done>
Task CRUD on completed projects confirmed working: no status-based guards in API routes, no disabled states in UI components, completed projects available in task creation project selector. Requirements TASK-01, TASK-02, TASK-03 verified.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with zero errors
2. `npm run build` succeeds
3. Dashboard page loads without runtime errors
4. Revenue query uses `findMany` with `{ status: { in: ['ACTIVE', 'COMPLETED'] } }`
5. Per-project coalesce: `Number(p.revenue) || Number(p.potentialRevenue) || 0`
6. No status-based task guards found in API routes or UI components
</verification>

<success_criteria>
- REV-01: Dashboard CRM Revenue KPI uses per-project `revenue ?? potentialRevenue` fallback
- REV-02: Revenue calculation includes ACTIVE and COMPLETED projects
- REV-03: Projects with both revenue and potentialRevenue count actual revenue only
- REV-04: Profit calculation updates consistently with new revenue logic
- TASK-01: User can create tasks on COMPLETED projects (verified, no code blocking)
- TASK-02: User can create subtasks on tasks belonging to completed projects (verified)
- TASK-03: User can edit existing tasks on completed projects (verified)
</success_criteria>

<output>
After completion, create `.planning/phases/68-sidebar-fixes-quick-wins/68-02-SUMMARY.md`
</output>
