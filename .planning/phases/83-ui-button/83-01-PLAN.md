# Plan 83-01: Create AiAnalyzeButton Component

## Frontmatter

```yaml
phase: 83
plan: 01
title: Create AiAnalyzeButton Component
wave: 1
depends_on: []
files_modified:
  - src/components/layout/ai-analyze-button.tsx (create)
autonomous: true
```

## Objective

Create the AiAnalyzeButton component with dropdown menu, pending counts badge, trigger functionality, and hybrid polling.

## Context

- Phase 81 completed: `/api/ai/pending` returns `{ costs, invoices, receipts, deliverables, total }`
- Phase 82 (in progress): `/api/ai/trigger` accepts POST with type parameter
- Component pattern reference: `src/components/layout/notification-bell.tsx`
- Toast pattern: `import { toast } from 'sonner'`
- Role check: `session?.user?.role === 'ADMIN'`

## Tasks

<task id="1">
Create the AiAnalyzeButton component file with all functionality:

**File:** `src/components/layout/ai-analyze-button.tsx`

**Component requirements:**
1. State management:
   - `pendingCounts`: object with costs, invoices, receipts, deliverables, total
   - `isLoading`: boolean for initial fetch
   - `isPolling`: boolean for active polling
   - `isTriggering`: boolean for trigger in progress
   - `initialCount`: number to track pre-trigger count
   - `pollCount`: number to track polling iterations

2. Data fetching:
   - Fetch `/api/ai/pending` on mount
   - Re-fetch during polling every 15 seconds
   - Handle errors gracefully

3. UI structure:
   - DropdownMenu as root
   - DropdownMenuTrigger with Button containing Sparkles icon
   - Badge overlay showing total count (hidden when 0)
   - DropdownMenuContent with:
     - Label: "AI Analysis"
     - MenuItem: "Analyze All (N)" - triggers with type "all"
     - Separator
     - MenuItem: "Costs (N)" - triggers with type "costs"
     - MenuItem: "Invoices (N)" - triggers with type "invoice"
     - MenuItem: "Receipts (N)" - triggers with type "receipt"
     - MenuItem: "Deliverables (N)" - triggers with type "deliverables"
   - Disable items when count is 0

4. Trigger logic:
   - POST to `/api/ai/trigger` with `{ type }`
   - Show toast.info("Analyzing...") on trigger
   - On 202: start polling
   - On 500: toast.error(error message from response)
   - On 403: toast.error("Admin access required")

5. Polling logic:
   - Start after successful trigger
   - Poll every 15 seconds
   - Store initialCount before starting
   - On each poll:
     - Fetch pending counts
     - If total < initialCount: calculate diff, show success toast, stop
     - If pollCount >= 6 (90 seconds): show info toast, stop
   - Clean up interval on unmount

**Code structure:**
```typescript
'use client'

import { useState, useEffect, useCallback, useRef } from 'react'
import { useSession } from 'next-auth/react'
import { Sparkles, Loader2 } from 'lucide-react'
import { Button } from '@/components/ui/button'
import {
  DropdownMenu,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuLabel,
  DropdownMenuSeparator,
  DropdownMenuTrigger,
} from '@/components/ui/dropdown-menu'
import { toast } from 'sonner'

interface PendingCounts {
  costs: number
  invoices: number
  receipts: number
  deliverables: number
  total: number
}

export function AiAnalyzeButton() {
  // State
  const [counts, setCounts] = useState<PendingCounts | null>(null)
  const [isLoading, setIsLoading] = useState(true)
  const [isTriggering, setIsTriggering] = useState(false)
  const [isPolling, setIsPolling] = useState(false)
  const initialCountRef = useRef<number>(0)
  const pollCountRef = useRef<number>(0)
  const pollIntervalRef = useRef<NodeJS.Timeout | null>(null)

  // Fetch pending counts
  const fetchCounts = useCallback(async () => {
    try {
      const res = await fetch('/api/ai/pending')
      if (res.ok) {
        const data = await res.json()
        setCounts({
          costs: data.costs,
          invoices: data.invoices,
          receipts: data.receipts,
          deliverables: data.deliverables,
          total: data.total,
        })
        return data.total
      }
    } catch (error) {
      console.error('Error fetching pending counts:', error)
    }
    return null
  }, [])

  // Initial fetch
  useEffect(() => {
    fetchCounts().finally(() => setIsLoading(false))
  }, [fetchCounts])

  // Stop polling
  const stopPolling = useCallback(() => {
    if (pollIntervalRef.current) {
      clearInterval(pollIntervalRef.current)
      pollIntervalRef.current = null
    }
    setIsPolling(false)
    pollCountRef.current = 0
  }, [])

  // Cleanup on unmount
  useEffect(() => {
    return () => {
      if (pollIntervalRef.current) {
        clearInterval(pollIntervalRef.current)
      }
    }
  }, [])

  // Start polling
  const startPolling = useCallback(() => {
    initialCountRef.current = counts?.total ?? 0
    pollCountRef.current = 0
    setIsPolling(true)

    pollIntervalRef.current = setInterval(async () => {
      pollCountRef.current += 1
      const newTotal = await fetchCounts()

      if (newTotal !== null) {
        const diff = initialCountRef.current - newTotal
        if (diff > 0) {
          toast.success(`${diff} item${diff > 1 ? 's' : ''} analyzed`)
          stopPolling()
          return
        }
      }

      // Max 6 polls (90 seconds)
      if (pollCountRef.current >= 6) {
        toast.info('Still running on Mac', {
          description: 'Analysis may take longer than expected',
        })
        stopPolling()
      }
    }, 15000)
  }, [counts?.total, fetchCounts, stopPolling])

  // Trigger analysis
  const handleTrigger = async (type: string) => {
    if (isTriggering || isPolling) return

    setIsTriggering(true)
    toast.info('Analyzing...', { description: `Running ${type} analysis` })

    try {
      const res = await fetch('/api/ai/trigger', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ type }),
      })

      if (res.status === 202) {
        startPolling()
      } else if (res.status === 403) {
        toast.error('Admin access required')
      } else {
        const data = await res.json().catch(() => ({}))
        toast.error('Analysis failed', {
          description: data.error || 'SSH connection failed',
        })
      }
    } catch (error) {
      toast.error('Failed to start analysis', {
        description: 'Network error',
      })
    } finally {
      setIsTriggering(false)
    }
  }

  const total = counts?.total ?? 0
  const showBadge = !isLoading && total > 0

  return (
    <DropdownMenu>
      <DropdownMenuTrigger asChild>
        <Button
          variant="ghost"
          size="icon"
          className="relative"
          disabled={isTriggering}
        >
          {isTriggering || isPolling ? (
            <Loader2 className="h-5 w-5 text-purple-600 animate-spin" />
          ) : (
            <Sparkles className="h-5 w-5 text-purple-600" />
          )}
          {showBadge && (
            <span className="absolute -right-1 -top-1 flex h-4 w-4 items-center justify-center rounded-full bg-purple-500 text-[10px] font-medium text-white">
              {total > 99 ? '99+' : total}
            </span>
          )}
        </Button>
      </DropdownMenuTrigger>
      <DropdownMenuContent align="end" className="w-48">
        <DropdownMenuLabel>AI Analysis</DropdownMenuLabel>
        <DropdownMenuSeparator />
        <DropdownMenuItem
          onClick={() => handleTrigger('all')}
          disabled={total === 0 || isTriggering || isPolling}
        >
          Analyze All ({total})
        </DropdownMenuItem>
        <DropdownMenuSeparator />
        <DropdownMenuItem
          onClick={() => handleTrigger('costs')}
          disabled={(counts?.costs ?? 0) === 0 || isTriggering || isPolling}
        >
          Costs ({counts?.costs ?? 0})
        </DropdownMenuItem>
        <DropdownMenuItem
          onClick={() => handleTrigger('invoice')}
          disabled={(counts?.invoices ?? 0) === 0 || isTriggering || isPolling}
        >
          Invoices ({counts?.invoices ?? 0})
        </DropdownMenuItem>
        <DropdownMenuItem
          onClick={() => handleTrigger('receipt')}
          disabled={(counts?.receipts ?? 0) === 0 || isTriggering || isPolling}
        >
          Receipts ({counts?.receipts ?? 0})
        </DropdownMenuItem>
        <DropdownMenuItem
          onClick={() => handleTrigger('deliverables')}
          disabled={(counts?.deliverables ?? 0) === 0 || isTriggering || isPolling}
        >
          Deliverables ({counts?.deliverables ?? 0})
        </DropdownMenuItem>
      </DropdownMenuContent>
    </DropdownMenu>
  )
}
```
</task>

## Verification

```yaml
checks:
  - description: Component file created
    command: ls src/components/layout/ai-analyze-button.tsx
    expected: File exists

  - description: No TypeScript errors
    command: npx tsc --noEmit src/components/layout/ai-analyze-button.tsx 2>&1 | grep -c error || echo 0
    expected: "0"
```

## must_haves

- [ ] AiAnalyzeButton component created with Sparkles icon
- [ ] Badge shows total pending count (hidden when 0)
- [ ] Dropdown menu with All, Costs, Invoices, Receipts, Deliverables options
- [ ] Each menu item shows count and triggers POST to /api/ai/trigger
- [ ] Toast shows "Analyzing..." on trigger
- [ ] Error toast shows on API error
- [ ] Polling starts after successful trigger (every 15s)
- [ ] Polling stops at 90s max with info toast
- [ ] Success toast shows when count decreases
