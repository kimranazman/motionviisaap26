---
phase: 28-server-query-project-include
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/app/(dashboard)/pipeline/page.tsx
  - src/app/(dashboard)/potential-projects/page.tsx
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Conversion badges visible on pipeline page initial load (no archive toggle needed)"
    - "Conversion badges visible on potential-projects page initial load (no archive toggle needed)"
    - "Project revenue and potentialRevenue correctly serialized as numbers (not Decimal objects)"
  artifacts:
    - path: "src/app/(dashboard)/pipeline/page.tsx"
      provides: "Deal query with project relation"
      contains: "project:"
    - path: "src/app/(dashboard)/potential-projects/page.tsx"
      provides: "Potential query with project relation"
      contains: "project:"
  key_links:
    - from: "src/app/(dashboard)/pipeline/page.tsx"
      to: "prisma.deal.findMany"
      via: "include.project with Decimal serialization"
      pattern: "project.*revenue.*potentialRevenue"
    - from: "src/app/(dashboard)/potential-projects/page.tsx"
      to: "prisma.potentialProject.findMany"
      via: "include.project with Decimal serialization"
      pattern: "project.*revenue.*potentialRevenue"
---

<objective>
Fix server-side page queries to include project relation, enabling conversion badges to display on initial page load.

Purpose: Close the gap identified in v1.3.2 audit where conversion badges only appear after toggling "Show Archived" (which triggers API fetch) because server-side page queries lack the project relation.

Output: Both pipeline and potential-projects pages include project data in their initial server-side queries with proper Decimal serialization.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/v1.3.2-MILESTONE-AUDIT.md

Reference implementation (correct pattern from API routes):
@src/app/api/deals/route.ts (lines 26-50 show correct project include + serialization)
@src/app/api/potential-projects/route.ts (lines 26-50 show correct project include + serialization)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add project include to pipeline/page.tsx</name>
  <files>src/app/(dashboard)/pipeline/page.tsx</files>
  <action>
Add project relation to the Prisma query include clause (after contact):

```typescript
project: {
  select: {
    id: true,
    title: true,
    revenue: true,
    potentialRevenue: true,
  },
},
```

Update the serialization logic to handle project Decimal values:

```typescript
const serializedDeals = deals.map(deal => ({
  ...deal,
  value: deal.value ? Number(deal.value) : null,
  project: deal.project ? {
    ...deal.project,
    revenue: deal.project.revenue ? Number(deal.project.revenue) : null,
    potentialRevenue: deal.project.potentialRevenue ? Number(deal.project.potentialRevenue) : null,
  } : null,
}))
```

Reference the API route at `src/app/api/deals/route.ts` lines 26-50 for the exact pattern.
  </action>
  <verify>
TypeScript compiles without errors: `npx tsc --noEmit`
  </verify>
  <done>pipeline/page.tsx includes project relation with Decimal serialization matching API route pattern</done>
</task>

<task type="auto">
  <name>Task 2: Add project include to potential-projects/page.tsx</name>
  <files>src/app/(dashboard)/potential-projects/page.tsx</files>
  <action>
Add project relation to the Prisma query include clause (after contact):

```typescript
project: {
  select: {
    id: true,
    title: true,
    revenue: true,
    potentialRevenue: true,
  },
},
```

Update the serialization logic to handle project Decimal values:

```typescript
const serializedProjects = potentialProjects.map(project => ({
  ...project,
  estimatedValue: project.estimatedValue ? Number(project.estimatedValue) : null,
  project: project.project ? {
    ...project.project,
    revenue: project.project.revenue ? Number(project.project.revenue) : null,
    potentialRevenue: project.project.potentialRevenue ? Number(project.project.potentialRevenue) : null,
  } : null,
}))
```

Reference the API route at `src/app/api/potential-projects/route.ts` lines 26-50 for the exact pattern.
  </action>
  <verify>
TypeScript compiles without errors: `npx tsc --noEmit`
  </verify>
  <done>potential-projects/page.tsx includes project relation with Decimal serialization matching API route pattern</done>
</task>

</tasks>

<verification>
1. TypeScript compilation: `npx tsc --noEmit` passes without errors
2. Code inspection: Both page files contain `project:` in their include clauses
3. Code inspection: Both serialization blocks handle `deal.project.revenue` and `deal.project.potentialRevenue`
4. Manual verification: Navigate to /pipeline and /potential-projects - conversion badges should appear on WON deals and CONFIRMED potentials on initial page load (no archive toggle needed)
</verification>

<success_criteria>
- pipeline/page.tsx Prisma query includes project relation
- potential-projects/page.tsx Prisma query includes project relation
- Both files serialize project.revenue and project.potentialRevenue as numbers
- TypeScript compiles successfully
- Conversion badges visible on initial page load (CONV-01 gap closed)
</success_criteria>

<output>
After completion, create `.planning/phases/28-server-query-project-include/28-01-SUMMARY.md`
</output>
