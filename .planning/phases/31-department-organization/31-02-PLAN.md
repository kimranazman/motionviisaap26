---
phase: 31-department-organization
plan: 02
type: execute
wave: 2
depends_on: ["31-01"]
files_modified:
  - src/components/pipeline/deal-form-modal.tsx
  - src/components/potential-projects/potential-form-modal.tsx
  - src/app/api/deals/route.ts
  - src/app/api/deals/[id]/route.ts
  - src/app/api/potential-projects/route.ts
  - src/app/api/potential-projects/[id]/route.ts
autonomous: true

must_haves:
  truths:
    - "User can assign a deal to a department when creating a deal"
    - "User can assign a potential project to a department when creating a potential"
    - "When user selects company in deal form, departments load and become selectable"
    - "When user selects department, contacts are filtered to show department contacts plus company-wide contacts"
    - "Company -> Department -> Contact cascading selection works smoothly in forms"
  artifacts:
    - path: "src/components/pipeline/deal-form-modal.tsx"
      provides: "Deal form with department selection and cascading contact filter"
      contains: "DepartmentSelect"
    - path: "src/components/potential-projects/potential-form-modal.tsx"
      provides: "Potential form with department selection and cascading contact filter"
      contains: "DepartmentSelect"
    - path: "src/app/api/deals/route.ts"
      provides: "Deal create with departmentId support"
      contains: "departmentId"
    - path: "src/app/api/potential-projects/route.ts"
      provides: "Potential create with departmentId support"
      contains: "departmentId"
  key_links:
    - from: "src/components/pipeline/deal-form-modal.tsx"
      to: "department-select.tsx"
      via: "import DepartmentSelect"
      pattern: "import.*DepartmentSelect"
    - from: "src/components/pipeline/deal-form-modal.tsx"
      to: "/api/companies/[id]"
      via: "fetch company data including departments"
      pattern: "data\\.departments"
    - from: "src/app/api/deals/route.ts"
      to: "prisma.deal.create"
      via: "departmentId in data object"
      pattern: "departmentId.*body\\.departmentId"
---

<objective>
Implement deal and potential project department assignment with cascading Company -> Department -> Contact selection flow.

Purpose: Allow users to scope deals and potential projects to specific departments (DEPT-06, DEPT-07, DEPT-08). The selection flow cascades: selecting a company loads its departments, selecting a department filters contacts to show only those in that department (plus company-wide contacts with no department).

Output: Extended deal and potential forms with department selection, updated APIs to store departmentId, proper cascading selection UX.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/31-department-organization/31-RESEARCH.md

# From Plan 01 - DepartmentSelect component
@src/components/pipeline/department-select.tsx

# Forms to extend
@src/components/pipeline/deal-form-modal.tsx
@src/components/potential-projects/potential-form-modal.tsx

# APIs to extend
@src/app/api/deals/route.ts
@src/app/api/potential-projects/route.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend deal form with department selection and cascading contacts</name>
  <files>
    src/components/pipeline/deal-form-modal.tsx
    src/app/api/deals/route.ts
    src/app/api/deals/[id]/route.ts
  </files>
  <action>
Add department selection to deal form with cascading contact filter:

1. **Update `src/components/pipeline/deal-form-modal.tsx`**:
   - Import DepartmentSelect from './department-select'
   - Add interface: Department { id: string; name: string }
   - Add state: departmentId (string | null), departments (Department[])
   - Update fetchContacts effect to also extract departments from company response:
     ```typescript
     setDepartments(data.departments || [])
     ```
   - Add effect: When companyId changes, reset departmentId to null and clear departments
   - Add useMemo for filteredContacts:
     ```typescript
     const filteredContacts = useMemo(() => {
       if (!departmentId) return contacts // No filter when no department selected
       return contacts.filter(
         (c) => c.departmentId === departmentId || c.departmentId === null
       )
     }, [contacts, departmentId])
     ```
   - Update Contact interface to include departmentId: string | null
   - Add effect: When departmentId changes, check if current contactId is still valid in filteredContacts. If not, reset contactId to null.
   - Render DepartmentSelect AFTER Company, BEFORE Contact:
     ```tsx
     <div className="space-y-2">
       <Label>Department</Label>
       <DepartmentSelect
         value={departmentId}
         onValueChange={setDepartmentId}
         departments={departments}
         disabled={!companyId || isLoadingContacts}
       />
       {!companyId && (
         <p className="text-xs text-muted-foreground">Select a company first</p>
       )}
     </div>
     ```
   - Update ContactSelect to use filteredContacts instead of contacts
   - Update submit body to include: `departmentId: departmentId || null`
   - Reset departmentId and departments in form reset (when modal closes)

2. **Update `src/app/api/deals/route.ts` POST**:
   - Accept optional departmentId in body
   - Add to create data: `departmentId: body.departmentId || null`
   - Add to include: `department: { select: { id: true, name: true } }`

3. **Update `src/app/api/deals/[id]/route.ts` PATCH** (if exists):
   - Accept optional departmentId in body
   - Add to update data conditionally:
     ```typescript
     ...(body.departmentId !== undefined && { departmentId: body.departmentId || null }),
     ```
  </action>
  <verify>
    - Open new deal modal, select company - department dropdown becomes enabled with company's departments
    - Select department - contact dropdown filters to show only department contacts + unassigned contacts
    - Select contact from filtered list, submit - deal created with departmentId
    - Change department after selecting contact - contact clears if not in new department
    - Create deal without department selected - works (department optional)
  </verify>
  <done>
    Deal form has Company -> Department -> Contact cascading selection. Deals can be scoped to departments.
  </done>
</task>

<task type="auto">
  <name>Task 2: Extend potential form with department selection and cascading contacts</name>
  <files>
    src/components/potential-projects/potential-form-modal.tsx
    src/app/api/potential-projects/route.ts
    src/app/api/potential-projects/[id]/route.ts
  </files>
  <action>
Add department selection to potential form (mirror deal form changes exactly):

1. **Update `src/components/potential-projects/potential-form-modal.tsx`**:
   - Import DepartmentSelect from '@/components/pipeline/department-select'
   - Add interface: Department { id: string; name: string }
   - Add state: departmentId (string | null), departments (Department[])
   - Update fetchContacts effect to also set departments from company response
   - Add useMemo for filteredContacts (same logic as deal form)
   - Update Contact interface to include departmentId: string | null
   - Add effect to clear contactId when departmentId changes and contact not in filtered list
   - Render DepartmentSelect after Company, before Contact (same layout as deal form)
   - Update ContactSelect to use filteredContacts
   - Update submit body to include: `departmentId: departmentId || null`
   - Reset departmentId and departments when modal closes

2. **Update `src/app/api/potential-projects/route.ts` POST**:
   - Accept optional departmentId in body
   - Add to create data: `departmentId: body.departmentId || null`
   - Add to include: `department: { select: { id: true, name: true } }`

3. **Update `src/app/api/potential-projects/[id]/route.ts` PATCH** (if exists):
   - Accept optional departmentId in body
   - Add to update data conditionally
  </action>
  <verify>
    - Open new potential modal, select company - department dropdown enabled
    - Select department - contacts filter correctly
    - Create potential with department - departmentId saved
    - Create potential without department - works (optional)
  </verify>
  <done>
    Potential form has Company -> Department -> Contact cascading selection. Potentials can be scoped to departments.
  </done>
</task>

<task type="auto">
  <name>Task 3: Verify full cascading flow and edge cases</name>
  <files>
    src/components/pipeline/deal-form-modal.tsx
    src/components/potential-projects/potential-form-modal.tsx
  </files>
  <action>
Verify and polish cascading selection behavior:

1. **Edge case handling in both forms**:
   - When company has NO departments: DepartmentSelect shows "(No departments)" and is disabled - verify this works
   - When switching companies: departments, departmentId, and contactId all reset - verify clean state
   - When department is selected then company is changed: all cascade correctly - verify no stale data

2. **Contact filtering logic verification**:
   - Contacts with departmentId matching selected department: SHOWN
   - Contacts with departmentId = null (company-wide): SHOWN
   - Contacts with different departmentId: HIDDEN
   - When no department selected: ALL contacts shown (no filtering)

3. **Loading states**:
   - While fetching company data: both DepartmentSelect and ContactSelect disabled
   - Show "Loading contacts..." or similar when isLoadingContacts true
   - After load completes: only ContactSelect shows "(No contacts)" if company has no contacts

4. **Form reset verification**:
   - When modal closes: title, companyId, departmentId, contactId, departments, contacts, value, description all reset
   - When modal opens fresh: all fields empty, selects show placeholders
  </action>
  <verify>
    - Create deal for company with departments: full cascade works
    - Create deal for company without departments: department select disabled, contacts work normally
    - Switch company mid-form: previous department/contact cleared, new data loads
    - Close and reopen modal: completely fresh state
    - Run `npm run build` - no TypeScript errors
  </verify>
  <done>
    Cascading Company -> Department -> Contact selection works reliably in both deal and potential forms.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. **DEPT-06 (Deal assignment):** Create deal with department selected - departmentId saved
2. **DEPT-07 (Potential assignment):** Create potential with department selected - departmentId saved
3. **DEPT-08 (Cascading selection):**
   - Select company -> departments load
   - Select department -> contacts filter
   - Change company -> department/contact reset
   - Full flow feels natural and responsive

Run `npm run build` - no TypeScript errors.

Manual test flow:
1. Create company "Acme Corp"
2. Add departments: "Engineering", "Sales"
3. Add contacts: "Alice" (Engineering), "Bob" (Sales), "Carol" (no department)
4. Create new deal, select Acme Corp
5. Select "Engineering" department -> Only Alice and Carol shown in contacts
6. Select "Sales" department -> Only Bob and Carol shown in contacts
7. Select no department -> Alice, Bob, and Carol all shown
</verification>

<success_criteria>
- Deal form has department selection between company and contact
- Potential form has department selection between company and contact
- Contacts filter by department when department selected
- Company-wide contacts (no department) always shown
- departmentId saved to deals and potentials
- Switching company resets department and contact
- No TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/31-department-organization/31-02-SUMMARY.md`
</output>
