---
phase: 31-department-organization
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/app/api/companies/[id]/departments/route.ts
  - src/app/api/companies/[id]/departments/[deptId]/route.ts
  - src/app/api/companies/[id]/route.ts
  - src/app/api/companies/[id]/contacts/route.ts
  - src/components/companies/department-section.tsx
  - src/components/companies/department-card.tsx
  - src/components/companies/department-form.tsx
  - src/components/companies/company-detail-modal.tsx
  - src/components/companies/contact-form.tsx
  - src/components/pipeline/department-select.tsx
autonomous: true

must_haves:
  truths:
    - "User can create a department under a company with name and optional description"
    - "User can view list of all departments for a company in the company detail modal"
    - "User can edit department name and description inline"
    - "User can delete department (linked contacts/deals/potentials become unassigned)"
    - "User can assign a contact to a department when creating or editing contact"
  artifacts:
    - path: "src/app/api/companies/[id]/departments/route.ts"
      provides: "GET list, POST create department"
      exports: ["GET", "POST"]
    - path: "src/app/api/companies/[id]/departments/[deptId]/route.ts"
      provides: "GET, PATCH, DELETE single department"
      exports: ["GET", "PATCH", "DELETE"]
    - path: "src/components/companies/department-section.tsx"
      provides: "Departments section in company modal"
      min_lines: 50
    - path: "src/components/companies/department-card.tsx"
      provides: "Single department display with edit/delete"
      min_lines: 60
    - path: "src/components/companies/department-form.tsx"
      provides: "Form to add new department"
      min_lines: 50
    - path: "src/components/pipeline/department-select.tsx"
      provides: "Reusable department combobox for forms"
      min_lines: 60
  key_links:
    - from: "src/components/companies/department-section.tsx"
      to: "/api/companies/[id]/departments"
      via: "fetch for CRUD operations"
      pattern: "fetch.*departments"
    - from: "src/components/companies/company-detail-modal.tsx"
      to: "department-section.tsx"
      via: "import and render DepartmentSection"
      pattern: "DepartmentSection"
    - from: "src/components/companies/contact-form.tsx"
      to: "department-select.tsx"
      via: "import and use DepartmentSelect"
      pattern: "DepartmentSelect"
---

<objective>
Implement Department CRUD within companies and contact-department assignment.

Purpose: Allow users to organize company contacts by department (DEPT-01 through DEPT-05). Departments appear inline in the company detail modal, following the existing contacts section pattern.

Output: Department API routes, department UI components in company modal, DepartmentSelect component for forms, contact form with department selection.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/31-department-organization/31-RESEARCH.md

# Existing patterns to follow
@src/components/companies/company-detail-modal.tsx
@src/components/companies/contact-form.tsx
@src/components/companies/contact-card.tsx
@src/components/pipeline/contact-select.tsx
@src/app/api/companies/[id]/route.ts
@src/app/api/companies/[id]/contacts/route.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Department API routes and company API extension</name>
  <files>
    src/app/api/companies/[id]/departments/route.ts
    src/app/api/companies/[id]/departments/[deptId]/route.ts
    src/app/api/companies/[id]/route.ts
    src/app/api/companies/[id]/contacts/route.ts
  </files>
  <action>
Create department API routes following contacts pattern:

1. **`src/app/api/companies/[id]/departments/route.ts`**:
   - GET: List departments for company with `_count` for contacts, deals, potentials. Order by name asc.
   - POST: Create department with name (required), description (optional). Check unique constraint (companyId + name). Handle Prisma P2002 error with "Department with this name already exists" message.
   - Both require auth (GET: requireAuth, POST: requireEditor).

2. **`src/app/api/companies/[id]/departments/[deptId]/route.ts`**:
   - GET: Fetch single department with counts.
   - PATCH: Update name and/or description. Validate department belongs to company.
   - DELETE: Use transaction to set departmentId to null on all linked contacts, deals, potentials BEFORE deleting department (avoid orphaned references).
   - All require requireEditor for mutations.

3. **Extend `src/app/api/companies/[id]/route.ts` GET**:
   - Add `departments` to include with `_count { contacts, deals, potentials }`, ordered by name asc.
   - Add `department: { select: { id: true, name: true } }` to contacts include.

4. **Extend `src/app/api/companies/[id]/contacts/route.ts` POST**:
   - Accept optional `departmentId` in body.
   - Validate if provided that department exists and belongs to same company.
   - Include `departmentId` in contact create data.
  </action>
  <verify>
    - `curl -X POST /api/companies/{id}/departments -d '{"name":"Engineering"}' -H "Content-Type: application/json"` returns 201
    - `curl /api/companies/{id}` includes departments array with _count
    - `curl /api/companies/{id}` contacts include department field
    - Duplicate department name returns 400 with specific error message
    - Delete department sets linked records' departmentId to null
  </verify>
  <done>
    Department CRUD API complete. Company GET returns departments. Contacts can have departmentId.
  </done>
</task>

<task type="auto">
  <name>Task 2: Department UI components in company modal</name>
  <files>
    src/components/companies/department-section.tsx
    src/components/companies/department-card.tsx
    src/components/companies/department-form.tsx
    src/components/companies/company-detail-modal.tsx
  </files>
  <action>
Create department UI following contacts pattern exactly:

1. **`src/components/companies/department-form.tsx`**:
   - Props: companyId, onSuccess, onCancel
   - State: name, description, isSubmitting, error
   - Submit to POST /api/companies/{companyId}/departments
   - Follow ContactForm layout: Card wrapper, form with labels, responsive button row
   - Name required, description optional (Textarea)

2. **`src/components/companies/department-card.tsx`**:
   - Props: department (with _count), companyId, onUpdate, onDelete
   - Display: Building icon (purple), inline-editable name (use CompanyInlineField), description
   - Stats row: X contacts, Y deals, Z potentials (use Users, Briefcase, FileStack icons)
   - Delete button with AlertDialog confirmation. Show warning if linked items exist ("X linked items will be unassigned").
   - PATCH to /api/companies/{companyId}/departments/{deptId}
   - DELETE to /api/companies/{companyId}/departments/{deptId}

3. **`src/components/companies/department-section.tsx`**:
   - Props: companyId, departments (array with _count), onDepartmentChange
   - State: showAddForm
   - Layout matches contacts section: header with count and Add button, form toggle, cards or empty state
   - Empty state: Building icon, "No departments yet", "Add your first department" button
   - Map departments to DepartmentCard components

4. **Update `src/components/companies/company-detail-modal.tsx`**:
   - Add Department interface with id, name, description, _count
   - Extend Company interface to include departments: Department[]
   - Import DepartmentSection
   - Add state: showAddDeptForm (or let DepartmentSection manage internally)
   - Add handlers: handleDepartmentAdded, handleDepartmentUpdated, handleDepartmentDeleted (all call fetchCompany + onUpdated)
   - Render DepartmentSection between Contacts section and Separator (before Related Items)
   - Add Separator after departments section
  </action>
  <verify>
    - Open company detail modal - departments section appears after contacts
    - Click "Add your first department" - form appears
    - Submit department - appears in list with stats
    - Edit department name inline - saves correctly
    - Delete department - confirmation shows linked count, deletion works
  </verify>
  <done>
    Department CRUD UI complete in company detail modal.
  </done>
</task>

<task type="auto">
  <name>Task 3: DepartmentSelect and contact form integration</name>
  <files>
    src/components/pipeline/department-select.tsx
    src/components/companies/contact-form.tsx
  </files>
  <action>
Create reusable DepartmentSelect and integrate into contact form:

1. **`src/components/pipeline/department-select.tsx`**:
   - Follow ContactSelect pattern exactly (see contact-select.tsx)
   - Props: value (string | null), onValueChange, departments (array of {id, name}), disabled
   - Use Popover with Command (cmdk) for searchable dropdown
   - Filter departments by input value (client-side)
   - Show "(No departments)" when empty and disabled
   - Show "Select department..." placeholder when not selected
   - Use Building icon before department name in list items
   - Toggle selection on click (select again to deselect)

2. **Update `src/components/companies/contact-form.tsx`**:
   - Add props: departments (optional array, default [])
   - Add state: departmentId (string | null, default null)
   - Import and render DepartmentSelect after role field
   - Label: "Department" (no asterisk - optional)
   - Pass departmentId in POST body
   - Clear departmentId on form reset after success
   - Only show DepartmentSelect if departments.length > 0 (hide entirely if no departments exist)

3. **Update `src/components/companies/company-detail-modal.tsx`**:
   - Pass company.departments to ContactForm as departments prop
   - ContactForm now shows department selection when company has departments
  </action>
  <verify>
    - Open company with departments, add new contact - department select appears
    - Open company without departments, add contact - no department select shown
    - Select department in contact form, submit - contact created with departmentId
    - Contact cards in modal could show department badge (optional enhancement)
  </verify>
  <done>
    DepartmentSelect component created. Contacts can be assigned to departments via ContactForm.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. **DEPT-01 (Create):** Create department via company modal form
2. **DEPT-02 (View):** See department list with stats in company modal
3. **DEPT-03 (Edit):** Click department name, edit inline, saves
4. **DEPT-04 (Delete):** Delete department with confirmation, linked items unassigned
5. **DEPT-05 (Contact assignment):** Create contact with department selected

Run `npm run build` - no TypeScript errors.
</verification>

<success_criteria>
- Department CRUD API routes functional
- Company GET includes departments with counts
- Department section appears in company detail modal
- Departments can be created, edited, deleted with proper UX
- DepartmentSelect component exists and works in contact form
- Contacts can be assigned to departments
- No TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/31-department-organization/31-01-SUMMARY.md`
</output>
