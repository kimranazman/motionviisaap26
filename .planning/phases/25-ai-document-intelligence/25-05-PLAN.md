---
phase: 25-ai-document-intelligence
plan: 05
type: execute
wave: 4
depends_on: ["25-04"]
files_modified:
  - src/components/projects/documents-section.tsx
  - src/components/projects/project-detail-sheet.tsx
  - src/components/dashboard/pending-analysis-widget.tsx
  - src/lib/widget-registry.ts
  - src/app/api/projects/[id]/documents/route.ts
autonomous: true

must_haves:
  truths:
    - "Documents show AI status badge (Pending/Analyzed/Imported)"
    - "Dashboard shows pending analysis summary with Claude command"
    - "Auto-generate manifest on document upload"
    - "Project detail sheet integrates AI review workflow"
  artifacts:
    - path: "src/components/projects/documents-section.tsx"
      provides: "Updated documents section with AI status badges"
      contains: "aiStatus"
    - path: "src/components/dashboard/pending-analysis-widget.tsx"
      provides: "Dashboard widget for pending AI analysis"
      min_lines: 50
    - path: "src/lib/widget-registry.ts"
      provides: "Widget registry with new AI pending widget"
      contains: "pending-analysis"
  key_links:
    - from: "src/components/projects/documents-section.tsx"
      to: "src/components/ai/ai-review-sheet.tsx"
      via: "opens review sheet on click"
      pattern: "AIReviewSheet"
    - from: "src/components/dashboard/pending-analysis-widget.tsx"
      to: "/api/ai/pending"
      via: "fetch pending count"
      pattern: "api/ai/pending"
    - from: "src/app/api/projects/[id]/documents/route.ts"
      to: "src/lib/manifest-utils.ts"
      via: "generate manifest after upload"
      pattern: "generateProjectManifest"
---

<objective>
Integrate AI document intelligence into existing UI and add dashboard visibility.

Purpose: Connect all AI components into the existing workflow so users can see pending analysis, trigger reviews, and monitor AI-processed documents.
Output: AI status badges on documents, pending analysis dashboard widget, and manifest auto-generation on upload.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/25-ai-document-intelligence/25-CONTEXT.md
@.planning/phases/25-ai-document-intelligence/25-RESEARCH.md
@.planning/phases/25-ai-document-intelligence/25-04-SUMMARY.md
@src/components/projects/documents-section.tsx
@src/components/projects/project-detail-sheet.tsx
@src/lib/widget-registry.ts
@src/app/api/projects/[id]/documents/route.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add AI status badges to documents and integrate review</name>
  <files>src/components/projects/documents-section.tsx, src/components/projects/project-detail-sheet.tsx</files>
  <action>
Update documents-section.tsx:

1. Add AI status badge to document cards:
   - Import Badge from ui/badge
   - Create getAIStatusColor function:
     - PENDING: bg-yellow-100 text-yellow-700 border-yellow-200
     - ANALYZED: bg-blue-100 text-blue-700 border-blue-200
     - IMPORTED: bg-green-100 text-green-700 border-green-200
     - FAILED: bg-red-100 text-red-700 border-red-200
   - Show badge next to category badge

2. Add "Review" button for ANALYZED documents:
   - Only show for INVOICE and RECEIPT categories
   - Only show when aiStatus is ANALYZED
   - Button opens AIReviewSheet

3. Add state for review sheet:
   - selectedDocumentForReview: Document | null
   - reviewExtraction: InvoiceExtraction | ReceiptExtraction | null
   - isReviewSheetOpen: boolean

4. Load AI results when opening review:
   - Read from /api/projects/{id}/ai-results (new endpoint, or read from file)
   - Find extraction matching document ID
   - Open AIReviewSheet with extraction data

5. Update Document type to include aiStatus and aiAnalyzedAt fields

Update project-detail-sheet.tsx:
- Import AIReviewSheet component
- Pass down review props to DocumentsSection
- Handle review sheet state at project detail level for proper refresh after import
  </action>
  <verify>
Documents show AI status badges.
ANALYZED documents show "Review" button.
Clicking Review opens AIReviewSheet with extraction data.
After import, document status updates to IMPORTED.
  </verify>
  <done>Documents display AI status and users can open review sheet for analyzed documents.</done>
</task>

<task type="auto">
  <name>Task 2: Create pending analysis dashboard widget</name>
  <files>src/components/dashboard/pending-analysis-widget.tsx, src/lib/widget-registry.ts</files>
  <action>
Create pending-analysis-widget.tsx:

A dashboard widget showing summary of documents pending AI analysis.

Features:
1. Fetch data from /api/ai/pending on mount
2. Display:
   - Total pending count (large number)
   - Breakdown: X invoices, Y receipts
   - List of projects with pending docs (max 5)
   - "View all" link if more than 5

3. Ready-to-run command section:
   - Show the Claude command in a code block
   - Copy button to copy command to clipboard
   - "No pending documents" message if count is 0

4. Refresh button to reload data

Use Card layout matching other dashboard widgets.

Update widget-registry.ts:
1. Add new widget definition:
```typescript
{
  id: 'pending-analysis',
  type: 'pending-analysis',
  title: 'AI Document Analysis',
  description: 'Documents pending AI analysis',
  icon: 'sparkles',  // or 'brain' - use lucide icon
  defaultSize: { w: 2, h: 2 },
  minSize: { w: 2, h: 2 },
  allowedRoles: ['ADMIN', 'EDITOR'],  // Viewers can't trigger analysis
  category: 'operations',
}
```

2. Update WIDGET_COMPONENTS mapping to include PendingAnalysisWidget
  </action>
  <verify>
Widget appears in widget bank for ADMIN and EDITOR roles.
Widget displays pending document count.
Claude command is copyable.
  </verify>
  <done>Dashboard widget shows pending AI analysis summary with ready-to-run Claude command.</done>
</task>

<task type="auto">
  <name>Task 3: Auto-generate manifest on document upload</name>
  <files>src/app/api/projects/[id]/documents/route.ts</files>
  <action>
Update documents route to auto-generate manifest after document operations.

In POST handler (after successful document creation):
1. Import generateProjectManifest from '@/lib/manifest-utils'
2. After document is created in DB, call generateProjectManifest(projectId)
3. Run async (don't await) to not block upload response
4. Log any errors but don't fail the upload

```typescript
// After document creation success
generateProjectManifest(projectId).catch(err => {
  console.error('Failed to generate manifest:', err)
})
```

Also trigger manifest regeneration on:
- DELETE document (in [documentId]/route.ts)
- PATCH document category change (in [documentId]/route.ts)

This ensures manifest is always up-to-date with latest document state.

Note: The generateProjectManifest function writes to file system, so it needs to handle concurrent writes gracefully (the function should be idempotent - regenerates full manifest each time).
  </action>
  <verify>
Upload a document, check that manifest.json is created/updated in project folder.
Delete a document, check that manifest.json is updated.
Change document category, check that manifest.json is updated.
  </verify>
  <done>Manifest auto-generates on document upload, delete, and category change, keeping AI context always current.</done>
</task>

</tasks>

<verification>
1. Document cards show AI status badges (Pending/Analyzed/Imported/Failed)
2. ANALYZED invoices/receipts have "Review" button that opens AIReviewSheet
3. Pending analysis widget shows in widget bank for ADMIN/EDITOR
4. Widget displays pending counts and copyable Claude command
5. Manifest auto-generates on document upload
6. Manifest updates on document delete and category change
</verification>

<success_criteria>
- AI status badges visible on all documents
- Review workflow accessible from document list
- Dashboard widget available to editors and admins
- Claude command copy-paste ready for bulk analysis
- Manifest always reflects current document state
</success_criteria>

<output>
After completion, create `.planning/phases/25-ai-document-intelligence/25-05-SUMMARY.md`
</output>
