---
phase: 25-ai-document-intelligence
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - prisma/schema.prisma
  - src/types/ai-extraction.ts
  - src/lib/manifest-utils.ts
  - src/app/api/projects/[id]/manifest/route.ts
autonomous: true

must_haves:
  truths:
    - "Document model has aiStatus field tracking analysis state"
    - "Manifest JSON file can be generated for any project"
    - "Manifest contains project context, categories, and document list"
  artifacts:
    - path: "prisma/schema.prisma"
      provides: "DocumentAIStatus enum and aiStatus field on Document"
      contains: "enum DocumentAIStatus"
    - path: "src/types/ai-extraction.ts"
      provides: "TypeScript types for AI extraction workflow"
      exports: ["InvoiceExtraction", "ReceiptExtraction", "ProjectManifest"]
    - path: "src/lib/manifest-utils.ts"
      provides: "Manifest generation utility functions"
      exports: ["generateProjectManifest"]
    - path: "src/app/api/projects/[id]/manifest/route.ts"
      provides: "API endpoint to generate/get manifest"
      exports: ["GET", "POST"]
  key_links:
    - from: "src/lib/manifest-utils.ts"
      to: "prisma.document"
      via: "database query for pending documents"
      pattern: "prisma\\.document"
    - from: "src/app/api/projects/[id]/manifest/route.ts"
      to: "src/lib/manifest-utils.ts"
      via: "import and call generateProjectManifest"
      pattern: "generateProjectManifest"
---

<objective>
Add schema support for AI document status tracking and create manifest generation infrastructure.

Purpose: Enable documents to track their AI analysis state and generate context files that Claude Code can read for document analysis.
Output: Schema with aiStatus field, TypeScript types, manifest generation utility, and manifest API route.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/25-ai-document-intelligence/25-CONTEXT.md
@.planning/phases/25-ai-document-intelligence/25-RESEARCH.md
@prisma/schema.prisma
@src/lib/document-utils.ts
@src/app/api/projects/[id]/documents/route.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add DocumentAIStatus enum and field to schema</name>
  <files>prisma/schema.prisma</files>
  <action>
Add DocumentAIStatus enum with values: PENDING, ANALYZED, IMPORTED, FAILED

Add to Document model:
- aiStatus field (DocumentAIStatus @default(PENDING))
- aiAnalyzedAt field (DateTime? optional)

Run `npx prisma db push` to apply changes.

The enum values mean:
- PENDING: Document uploaded but not yet analyzed by AI
- ANALYZED: AI has extracted data, awaiting user review
- IMPORTED: User confirmed and data imported to costs/revenue
- FAILED: AI analysis failed (unparseable document)
  </action>
  <verify>Run `npx prisma db push` succeeds without errors. Check schema.prisma has the new enum and fields.</verify>
  <done>Document model has aiStatus (default PENDING) and aiAnalyzedAt fields with DocumentAIStatus enum defined.</done>
</task>

<task type="auto">
  <name>Task 2: Create AI extraction types</name>
  <files>src/types/ai-extraction.ts</files>
  <action>
Create TypeScript types file with:

1. ConfidenceLevel type: 'HIGH' | 'MEDIUM' | 'LOW'

2. InvoiceLineItem interface:
   - description: string
   - quantity?: number
   - unitPrice?: number
   - amount: number
   - confidence: ConfidenceLevel

3. InvoiceExtraction interface:
   - documentId: string
   - confidence: ConfidenceLevel
   - invoiceNumber?: string
   - invoiceDate?: string
   - vendor?: string
   - lineItems: InvoiceLineItem[]
   - subtotal?: number
   - tax?: number
   - total: number
   - notes?: string
   - warnings?: string[]

4. ReceiptItem interface:
   - description: string
   - amount: number
   - suggestedCategory?: string
   - suggestedCategoryId?: string
   - confidence: ConfidenceLevel

5. ReceiptExtraction interface:
   - documentId: string
   - confidence: ConfidenceLevel
   - merchant?: string
   - receiptDate?: string
   - items: ReceiptItem[]
   - total: number
   - paymentMethod?: string
   - notes?: string
   - warnings?: string[]

6. AIAnalysisResult interface:
   - version: '1.0'
   - analyzedAt: string
   - projectId: string
   - invoices: InvoiceExtraction[]
   - receipts: ReceiptExtraction[]
   - errors?: { documentId: string; error: string }[]

7. ManifestDocument interface:
   - id: string
   - filename: string
   - category: 'RECEIPT' | 'INVOICE' | 'OTHER'
   - path: string
   - mimeType: string
   - size: number
   - uploadedAt: string
   - aiStatus: 'PENDING' | 'ANALYZED' | 'IMPORTED' | 'FAILED'

8. ProjectManifest interface:
   - version: '1.0'
   - generatedAt: string
   - project: { id, title, company, startDate?, endDate?, status }
   - existingCategories: { id: string; name: string }[]
   - documents: { pendingAnalysis: ManifestDocument[]; alreadyAnalyzed: ManifestDocument[] }
   - existingCosts: { description: string; amount: number; category: string; date: string }[]

Export all types.
  </action>
  <verify>TypeScript compiles without errors: `npx tsc --noEmit src/types/ai-extraction.ts`</verify>
  <done>All AI extraction types are defined and exported from src/types/ai-extraction.ts</done>
</task>

<task type="auto">
  <name>Task 3: Create manifest generation utility and API route</name>
  <files>src/lib/manifest-utils.ts, src/app/api/projects/[id]/manifest/route.ts</files>
  <action>
Create src/lib/manifest-utils.ts:

1. Import prisma, types, fs/promises, path
2. Define UPLOADS_DIR constant (same as documents route: process.env.UPLOADS_DIR || '/app/uploads')

3. Create generateProjectManifest(projectId: string) async function:
   - Fetch project with company, costs (include category), documents
   - Fetch all cost categories
   - Build manifest object matching ProjectManifest type
   - Split documents into pendingAnalysis (aiStatus PENDING) and alreadyAnalyzed (others)
   - Include existing costs for context (last 20 costs)
   - Write manifest to UPLOADS_DIR/projects/{projectId}/manifest.json
   - Return the manifest object

4. Create getProjectManifest(projectId: string) async function:
   - Read manifest.json from project folder
   - Return parsed JSON or null if not exists

Create src/app/api/projects/[id]/manifest/route.ts:

GET handler:
- Require auth (viewer can read)
- Call getProjectManifest(projectId)
- Return manifest or 404 if not exists

POST handler:
- Require editor role
- Call generateProjectManifest(projectId)
- Return generated manifest with 201 status

Follow existing API patterns from documents/route.ts for auth and error handling.
  </action>
  <verify>
Test API endpoints:
- `curl -X POST /api/projects/{id}/manifest` generates manifest file
- `curl /api/projects/{id}/manifest` returns manifest JSON
- Check manifest.json created in uploads/projects/{id}/ folder
  </verify>
  <done>Manifest generation utility works and API routes are functional. Manifest includes project context, categories, and document list.</done>
</task>

</tasks>

<verification>
1. Schema has DocumentAIStatus enum with PENDING, ANALYZED, IMPORTED, FAILED
2. Document model has aiStatus and aiAnalyzedAt fields
3. AI extraction types compile and export correctly
4. Manifest API generates proper manifest.json file
5. Manifest contains: project info, categories, documents (split by status), existing costs
</verification>

<success_criteria>
- `npx prisma db push` applies schema changes without errors
- TypeScript types compile without errors
- POST /api/projects/{id}/manifest creates manifest.json file
- GET /api/projects/{id}/manifest returns complete manifest structure
- Manifest JSON matches ProjectManifest type structure
</success_criteria>

<output>
After completion, create `.planning/phases/25-ai-document-intelligence/25-01-SUMMARY.md`
</output>
