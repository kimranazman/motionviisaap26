---
phase: 25-ai-document-intelligence
plan: 03
type: execute
wave: 2
depends_on: ["25-01"]
files_modified:
  - src/app/api/ai/import/invoice/route.ts
  - src/app/api/ai/import/receipt/route.ts
  - src/app/api/ai/pending/route.ts
autonomous: true

must_haves:
  truths:
    - "Invoice extraction data can be imported to update project revenue"
    - "Receipt extraction data can be imported to create cost entries"
    - "Document aiStatus is updated after successful import"
    - "Pending documents can be queried across all projects"
  artifacts:
    - path: "src/app/api/ai/import/invoice/route.ts"
      provides: "Invoice import endpoint"
      exports: ["POST"]
    - path: "src/app/api/ai/import/receipt/route.ts"
      provides: "Receipt import endpoint"
      exports: ["POST"]
    - path: "src/app/api/ai/pending/route.ts"
      provides: "Pending documents query endpoint"
      exports: ["GET"]
  key_links:
    - from: "src/app/api/ai/import/invoice/route.ts"
      to: "prisma.project"
      via: "update project revenue"
      pattern: "prisma\\.project\\.update"
    - from: "src/app/api/ai/import/receipt/route.ts"
      to: "prisma.cost"
      via: "create cost entries"
      pattern: "prisma\\.cost\\.create"
    - from: "src/app/api/ai/import/receipt/route.ts"
      to: "prisma.document"
      via: "update aiStatus to IMPORTED"
      pattern: "aiStatus.*IMPORTED"
---

<objective>
Create API routes for importing AI-extracted data into the system.

Purpose: Enable the app to receive AI extraction results and create corresponding cost entries and revenue updates with proper audit trail.
Output: API routes for invoice import, receipt import, and pending documents query.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/25-ai-document-intelligence/25-CONTEXT.md
@.planning/phases/25-ai-document-intelligence/25-RESEARCH.md
@.planning/phases/25-ai-document-intelligence/25-01-SUMMARY.md
@src/app/api/projects/[id]/costs/route.ts
@src/app/api/projects/[id]/route.ts
@src/types/ai-extraction.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create invoice import API route</name>
  <files>src/app/api/ai/import/invoice/route.ts</files>
  <action>
Create src/app/api/ai/import/invoice/route.ts:

POST handler that accepts InvoiceExtraction data and updates project revenue.

Request body:
```typescript
{
  projectId: string
  extraction: InvoiceExtraction
  addToRevenue: boolean  // Whether to add total to project revenue
}
```

Implementation:
1. Require editor role
2. Validate projectId exists
3. Validate documentId exists and belongs to project
4. If addToRevenue is true:
   - Fetch current project revenue
   - Add extraction.total to revenue (or set if null)
   - Update project with new revenue
5. Update document:
   - Set aiStatus to 'IMPORTED'
   - Set aiAnalyzedAt to now()
6. Return success with updated project and document

Response:
```typescript
{
  success: true
  project: { id, revenue }
  document: { id, aiStatus, aiAnalyzedAt }
}
```

Error handling:
- 404 if project or document not found
- 400 if document doesn't belong to project
- 400 if document category is not INVOICE
  </action>
  <verify>
Test: POST /api/ai/import/invoice with valid extraction data
- Returns 200 with updated project revenue
- Document aiStatus changed to IMPORTED
  </verify>
  <done>Invoice import API creates/updates project revenue from AI extraction and marks document as imported.</done>
</task>

<task type="auto">
  <name>Task 2: Create receipt import API route</name>
  <files>src/app/api/ai/import/receipt/route.ts</files>
  <action>
Create src/app/api/ai/import/receipt/route.ts:

POST handler that accepts ReceiptExtraction data and creates cost entries.

Request body:
```typescript
{
  projectId: string
  extraction: ReceiptExtraction
  items: {
    description: string
    amount: number
    categoryId: string  // User-confirmed category
    include: boolean    // Whether to import this item
  }[]
}
```

Implementation:
1. Require editor role
2. Validate projectId exists
3. Validate documentId exists and belongs to project
4. Filter items where include is true
5. For each included item:
   - Create Cost entry with:
     - projectId
     - description
     - amount
     - categoryId
     - date: extraction.receiptDate or now()
     - (Optional: link to document via notes or future field)
6. Update document:
   - Set aiStatus to 'IMPORTED'
   - Set aiAnalyzedAt to now()
7. Return success with created costs

Response:
```typescript
{
  success: true
  costsCreated: number
  costs: Cost[]
  document: { id, aiStatus, aiAnalyzedAt }
}
```

Error handling:
- 404 if project or document not found
- 400 if document doesn't belong to project
- 400 if document category is not RECEIPT
- 400 if any categoryId is invalid
  </action>
  <verify>
Test: POST /api/ai/import/receipt with valid extraction data
- Returns 200 with created cost entries
- Document aiStatus changed to IMPORTED
- Cost entries visible in project costs list
  </verify>
  <done>Receipt import API creates cost entries from AI extraction with user-confirmed categories and marks document as imported.</done>
</task>

<task type="auto">
  <name>Task 3: Create pending documents query API</name>
  <files>src/app/api/ai/pending/route.ts</files>
  <action>
Create src/app/api/ai/pending/route.ts:

GET handler that returns summary of documents pending AI analysis across all projects.

Implementation:
1. Require auth (viewer can read)
2. Query documents where:
   - aiStatus = 'PENDING'
   - category IN ('INVOICE', 'RECEIPT')  // Skip OTHER
3. Group by project
4. Return summary

Response:
```typescript
{
  totalPending: number
  projects: {
    id: string
    title: string
    company: string
    pendingInvoices: number
    pendingReceipts: number
    hasManifest: boolean  // Check if manifest.json exists
  }[]
  claudeCommand: string  // Ready-to-run command
}
```

The claudeCommand should be:
`claude "Read .claude/prompts/bulk-analysis.md and process uploads/projects/"`

Also check if manifest.json exists for each project (read file system).

Error handling:
- 500 if database query fails
  </action>
  <verify>
Test: GET /api/ai/pending
- Returns list of projects with pending document counts
- Includes ready-to-run Claude command
  </verify>
  <done>Pending documents API returns summary of all projects needing AI analysis with ready-to-run Claude command.</done>
</task>

</tasks>

<verification>
1. POST /api/ai/import/invoice updates project revenue and marks document imported
2. POST /api/ai/import/receipt creates cost entries and marks document imported
3. GET /api/ai/pending returns pending document summary across projects
4. All routes require proper auth (editor for imports, viewer for query)
5. Document aiStatus transitions correctly: PENDING -> IMPORTED
</verification>

<success_criteria>
- Invoice import adds extraction total to project revenue
- Receipt import creates individual cost entries with confirmed categories
- Document aiStatus updated to IMPORTED after successful import
- Pending API shows projects with unanalyzed invoices/receipts
- Claude command in pending response is ready to copy-paste
</success_criteria>

<output>
After completion, create `.planning/phases/25-ai-document-intelligence/25-03-SUMMARY.md`
</output>
