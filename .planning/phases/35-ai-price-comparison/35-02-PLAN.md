---
phase: 35-ai-price-comparison
plan: 02
type: execute
wave: 2
depends_on: [35-01]
files_modified:
  - src/app/api/projects/[id]/costs/route.ts
  - src/app/api/suppliers/compare/route.ts
  - src/components/suppliers/price-comparison-sheet.tsx
  - src/components/projects/cost-card.tsx
autonomous: true

must_haves:
  truths:
    - "Costs with suppliers automatically get embeddings generated"
    - "User can click Compare Prices on any cost with a supplier"
    - "Price comparison shows similar items from other suppliers with confidence"
    - "Similar items are sorted by similarity score"
  artifacts:
    - path: "src/app/api/suppliers/compare/route.ts"
      provides: "POST endpoint for finding similar costs"
      exports: ["POST"]
    - path: "src/components/suppliers/price-comparison-sheet.tsx"
      provides: "Sheet component displaying comparison results"
      exports: ["PriceComparisonSheet"]
    - path: "src/components/projects/cost-card.tsx"
      provides: "Cost card with Compare Prices button"
      contains: "Compare Prices"
  key_links:
    - from: "src/app/api/projects/[id]/costs/route.ts"
      to: "src/lib/embeddings.ts"
      via: "fire-and-forget embedding generation"
      pattern: "getEmbedding"
    - from: "src/app/api/suppliers/compare/route.ts"
      to: "src/lib/embeddings.ts"
      via: "similarity calculation"
      pattern: "cosineSimilarity"
    - from: "src/components/suppliers/price-comparison-sheet.tsx"
      to: "/api/suppliers/compare"
      via: "fetch in useEffect"
      pattern: "fetch.*api/suppliers/compare"
    - from: "src/components/projects/cost-card.tsx"
      to: "src/components/suppliers/price-comparison-sheet.tsx"
      via: "sheet trigger"
      pattern: "PriceComparisonSheet"
---

<objective>
Wire up embedding generation and price comparison UI for semantic matching across suppliers.

Purpose: Enable users to find and compare prices for similar items from different suppliers, helping identify cost savings opportunities.

Output: Automatic embedding generation on cost save, comparison API endpoint, and interactive price comparison sheet accessible from cost cards.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/35-ai-price-comparison/35-RESEARCH.md
@.planning/phases/35-ai-price-comparison/35-01-SUMMARY.md

@src/app/api/projects/[id]/costs/route.ts
@src/components/projects/cost-card.tsx
@src/components/ai/ai-review-sheet.tsx
@src/lib/embeddings.ts
@src/types/price-comparison.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add fire-and-forget embedding generation to costs API</name>
  <files>src/app/api/projects/[id]/costs/route.ts</files>
  <action>
Modify the POST handler in `/api/projects/[id]/costs/route.ts` to generate embeddings asynchronously:

1. Import `getEmbedding` from '@/lib/embeddings'

2. After `prisma.cost.create()` succeeds, check if `cost.supplierId` is set

3. If supplier is linked, fire-and-forget embedding generation:
   ```typescript
   if (cost.supplierId) {
     generateCostEmbedding(cost.id, cost.description).catch(console.error)
   }
   ```

4. Add helper function at bottom of file:
   ```typescript
   async function generateCostEmbedding(costId: string, description: string) {
     try {
       const embedding = await getEmbedding(description)
       await prisma.cost.update({
         where: { id: costId },
         data: { embedding },
       })
     } catch (error) {
       console.error(`Failed to generate embedding for cost ${costId}:`, error)
     }
   }
   ```

5. Also add embedding generation to the PUT handler in the [costId]/route.ts file if it exists, following same pattern.

Key insight: Do NOT await the embedding call - let it run in background so UI responds immediately.

Reference 35-RESEARCH.md lines 266-286 for the pattern.
  </action>
  <verify>
- File compiles without TypeScript errors
- POST handler returns immediately after cost creation
- Embedding generation happens asynchronously
  </verify>
  <done>Costs with suppliers automatically get embeddings generated in background</done>
</task>

<task type="auto">
  <name>Task 2: Create price comparison API endpoint</name>
  <files>src/app/api/suppliers/compare/route.ts</files>
  <action>
Create `src/app/api/suppliers/compare/route.ts` with POST handler:

1. Import `requireAuth` from '@/lib/auth-utils'
2. Import `getEmbedding`, `cosineSimilarity`, `getConfidenceLevel` from '@/lib/embeddings'
3. Import `PriceComparisonResult`, `SimilarCostItem` from '@/types/price-comparison'

4. POST handler accepts JSON body:
   - `description`: string (item to compare)
   - `excludeCostId`: string (optional, exclude the source cost)
   - `limit`: number (optional, default 10)

5. Implementation:
   a. Get embedding for query description
   b. Fetch all costs with embeddings and suppliers:
      ```typescript
      const costs = await prisma.cost.findMany({
        where: {
          embedding: { not: null },
          supplierId: { not: null },
          ...(excludeCostId ? { id: { not: excludeCostId } } : {}),
        },
        include: {
          supplier: { select: { id: true, name: true } },
          project: { select: { id: true, title: true } },
          category: { select: { id: true, name: true } },
        },
      })
      ```
   c. Calculate similarity for each cost (in-memory)
   d. Filter by threshold 0.7
   e. Sort by similarity descending
   f. Take top `limit` results
   g. Map to `SimilarCostItem[]` with confidence levels

6. Return `PriceComparisonResult`:
   ```typescript
   return Response.json({
     query: description,
     queryCostId: excludeCostId || null,
     results,
     searchedCount: costs.length,
     matchedCount: results.length,
   })
   ```

Handle errors gracefully - return 500 with error message if embedding generation or DB query fails.

Reference 35-RESEARCH.md lines 101-135 for the pattern.
  </action>
  <verify>
- File exists at src/app/api/suppliers/compare/route.ts
- TypeScript compiles without errors
- POST handler exported
  </verify>
  <done>Comparison API endpoint finds similar costs across suppliers</done>
</task>

<task type="auto">
  <name>Task 3: Create PriceComparisonSheet component and integrate with CostCard</name>
  <files>src/components/suppliers/price-comparison-sheet.tsx, src/components/projects/cost-card.tsx</files>
  <action>
**Part A: Create PriceComparisonSheet**

Create `src/components/suppliers/price-comparison-sheet.tsx` following AIReviewSheet pattern:

1. Props interface:
   ```typescript
   interface PriceComparisonSheetProps {
     open: boolean
     onOpenChange: (open: boolean) => void
     costDescription: string
     costId: string
     costAmount: number
     currentSupplier: string
   }
   ```

2. State:
   - `isLoading: boolean`
   - `results: SimilarCostItem[]`
   - `searchedCount: number`
   - `error: string | null`

3. useEffect to fetch comparison on open:
   ```typescript
   useEffect(() => {
     if (!open) return
     setIsLoading(true)
     fetch('/api/suppliers/compare', {
       method: 'POST',
       headers: { 'Content-Type': 'application/json' },
       body: JSON.stringify({
         description: costDescription,
         excludeCostId: costId,
         limit: 10,
       }),
     })
     // handle response...
   }, [open, costDescription, costId])
   ```

4. UI structure (using Sheet, SheetContent, SheetHeader, SheetTitle from ui/sheet):
   - Header: "Compare Prices" title with current item description
   - Show current cost amount prominently
   - Loading state with Loader2 spinner
   - Empty state: "No similar items found from other suppliers"
   - Results table with columns:
     - Description (truncated)
     - Supplier name
     - Amount (with formatCurrency)
     - Similarity badge (use ConfidenceBadge pattern or custom badge showing "92% match")
     - Price difference indicator (cheaper/more expensive with color)
   - Footer: "Searched X items, found Y matches"

5. Use ConfidenceLevel colors:
   - HIGH (>=0.85): green badge
   - MEDIUM (>=0.7): yellow badge

6. Price difference display:
   - If result.amount < costAmount: show green "X% cheaper" or "Save RM X"
   - If result.amount > costAmount: show red "X% more" or "RM X more"
   - If equal: show "Same price"

**Part B: Integrate with CostCard**

Modify `src/components/projects/cost-card.tsx`:

1. Import `PriceComparisonSheet` and `Scale` icon from lucide-react
2. Add state: `const [showComparison, setShowComparison] = useState(false)`
3. Add "Compare Prices" button after the Edit button (only show if cost.supplier exists):
   ```tsx
   {cost.supplier && (
     <Button
       variant="ghost"
       size="icon"
       className="h-8 w-8"
       onClick={() => setShowComparison(true)}
       title="Compare Prices"
     >
       <Scale className="h-4 w-4" />
     </Button>
   )}
   ```
4. Add PriceComparisonSheet at end of component:
   ```tsx
   {cost.supplier && (
     <PriceComparisonSheet
       open={showComparison}
       onOpenChange={setShowComparison}
       costDescription={cost.description}
       costId={cost.id}
       costAmount={cost.amount}
       currentSupplier={cost.supplier.name}
     />
   )}
   ```
  </action>
  <verify>
- Both files compile without TypeScript errors
- PriceComparisonSheet exports correctly
- CostCard shows Compare button only for costs with suppliers
- `npm run build` succeeds
  </verify>
  <done>Users can click Compare Prices to see similar items from other suppliers</done>
</task>

</tasks>

<verification>
After all tasks complete:
1. `npm run build` succeeds
2. Create a test cost with a supplier -> embedding is generated (check DB)
3. Click "Compare Prices" on a cost with supplier -> sheet opens
4. Sheet shows similar items with:
   - Similarity percentage
   - Price comparison (cheaper/more expensive)
   - Supplier names
5. Items are sorted by similarity score
</verification>

<success_criteria>
- Costs with suppliers get embeddings automatically (fire-and-forget)
- Compare Prices button appears on cost cards with suppliers
- PriceComparisonSheet displays similar items with confidence levels
- Price differences are clearly indicated (savings opportunities)
- UI is responsive and handles loading/empty/error states
</success_criteria>

<output>
After completion, create `.planning/phases/35-ai-price-comparison/35-02-SUMMARY.md`
</output>
