---
phase: 35-ai-price-comparison
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - prisma/schema.prisma
  - src/lib/embeddings.ts
  - src/types/price-comparison.ts
  - package.json
autonomous: true
user_setup:
  - service: openai
    why: "Embedding generation via OpenAI API"
    env_vars:
      - name: OPENAI_API_KEY
        source: "OpenAI Platform -> API keys (https://platform.openai.com/api-keys)"

must_haves:
  truths:
    - "Cost model has embedding column for storing vector data"
    - "OpenAI SDK is installed and configured"
    - "Embedding generation function returns 1536-dimensional vector"
    - "Cosine similarity function computes match score between vectors"
  artifacts:
    - path: "prisma/schema.prisma"
      provides: "Cost.embedding JSON column"
      contains: "embedding Json?"
    - path: "src/lib/embeddings.ts"
      provides: "OpenAI embedding generation and similarity functions"
      exports: ["getEmbedding", "cosineSimilarity", "getConfidenceLevel"]
    - path: "src/types/price-comparison.ts"
      provides: "TypeScript types for price comparison"
      exports: ["SimilarCostItem", "PriceComparisonResult"]
  key_links:
    - from: "src/lib/embeddings.ts"
      to: "openai"
      via: "import OpenAI from 'openai'"
      pattern: "new OpenAI"
---

<objective>
Add embedding infrastructure for AI-powered semantic matching of cost line items.

Purpose: Enable semantic similarity search to find similar items across suppliers, regardless of how they're described (e.g., "A4 Paper 80gsm" matches "Paper A4 80g").

Output: Schema with embedding column, OpenAI SDK integration, embedding utility functions, and price comparison types.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/35-ai-price-comparison/35-RESEARCH.md

@prisma/schema.prisma
@src/types/ai-extraction.ts
@package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add embedding column to Cost model and install OpenAI SDK</name>
  <files>prisma/schema.prisma, package.json</files>
  <action>
1. Add `embedding` field to the Cost model in prisma/schema.prisma:
   ```prisma
   // AI embedding for semantic matching (1536 floats for text-embedding-3-small)
   embedding Json? @db.Json
   ```
   Place this field after `aiImported` and before `supplierId`.

2. Install OpenAI SDK:
   ```bash
   npm install openai
   ```

3. Run prisma db push to apply schema changes:
   ```bash
   npx prisma db push
   ```

4. Regenerate Prisma client:
   ```bash
   npx prisma generate
   ```
  </action>
  <verify>
- `npx prisma validate` shows no errors
- `npm ls openai` shows openai installed
- Cost model in generated client includes `embedding` field
  </verify>
  <done>Cost model has embedding column, OpenAI SDK installed, database migrated</done>
</task>

<task type="auto">
  <name>Task 2: Create embedding utility library</name>
  <files>src/lib/embeddings.ts</files>
  <action>
Create `src/lib/embeddings.ts` with the following:

1. Import OpenAI SDK and initialize client with `process.env.OPENAI_API_KEY`

2. `getEmbedding(text: string): Promise<number[]>` function:
   - Uses model `text-embedding-3-small`
   - Truncates input to 8000 chars (max 8191 tokens)
   - Uses `encoding_format: 'float'`
   - Returns `response.data[0].embedding` (1536-dimensional float array)

3. `cosineSimilarity(a: number[], b: number[]): number` function:
   - OpenAI embeddings are pre-normalized, so dot product = cosine similarity
   - Simple reduce: `a.reduce((sum, val, i) => sum + val * b[i], 0)`

4. `getConfidenceLevel(similarity: number): ConfidenceLevel` function:
   - Import ConfidenceLevel from '@/types/ai-extraction'
   - Returns 'HIGH' if similarity >= 0.85
   - Returns 'MEDIUM' if similarity >= 0.7
   - Returns 'LOW' otherwise

5. Export all three functions.

Reference the code pattern from 35-RESEARCH.md lines 75-95 and 225-259.
  </action>
  <verify>
- File exists at src/lib/embeddings.ts
- TypeScript compiles without errors: `npx tsc --noEmit src/lib/embeddings.ts`
- All three functions are exported
  </verify>
  <done>Embedding library created with getEmbedding, cosineSimilarity, getConfidenceLevel functions</done>
</task>

<task type="auto">
  <name>Task 3: Create price comparison types</name>
  <files>src/types/price-comparison.ts</files>
  <action>
Create `src/types/price-comparison.ts` with the following types:

1. Import `ConfidenceLevel` from '@/types/ai-extraction'

2. `SimilarCostItem` interface:
   - id: string
   - description: string
   - amount: number
   - date: Date
   - similarity: number (0-1 score)
   - confidence: ConfidenceLevel
   - supplier: { id: string; name: string }
   - project: { id: string; title: string } | null
   - category: { id: string; name: string }

3. `PriceComparisonResult` interface:
   - query: string (the description being compared)
   - queryCostId: string (the cost being compared)
   - results: SimilarCostItem[]
   - searchedCount: number (total costs searched)
   - matchedCount: number (results above threshold)

Reference 35-RESEARCH.md lines 289-319 for the pattern.
  </action>
  <verify>
- File exists at src/types/price-comparison.ts
- TypeScript compiles without errors: `npx tsc --noEmit src/types/price-comparison.ts`
- Both interfaces are exported
  </verify>
  <done>Price comparison types created for use in API and UI</done>
</task>

</tasks>

<verification>
After all tasks complete:
1. `npx prisma validate` passes
2. `npm run build` completes without type errors
3. Database has `embedding` column on `costs` table
4. `src/lib/embeddings.ts` exports three functions
5. `src/types/price-comparison.ts` exports two interfaces
</verification>

<success_criteria>
- Cost model has nullable embedding JSON column
- OpenAI SDK installed in dependencies
- Embedding utility functions ready for use
- Price comparison types defined
- All TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/35-ai-price-comparison/35-01-SUMMARY.md`
</output>
