---
phase: 52-cleanup-polish
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/initiative-kpi-utils.ts          # DELETE
  - src/components/objectives/kpi-progress-bar.tsx  # DELETE
  - src/lib/initiative-export-utils.ts       # UPDATE line 108 + column width
  - prisma/schema.prisma                     # REMOVE resourcesFinancial, resourcesNonFinancial
  - src/app/(dashboard)/initiatives/page.tsx
  - src/app/(dashboard)/initiatives/[id]/page.tsx
  - src/app/api/initiatives/route.ts
  - src/app/api/initiatives/[id]/route.ts
  - src/components/initiatives/initiative-detail.tsx
  - src/components/initiatives/initiative-form.tsx
autonomous: true

must_haves:
  truths:
    - "No dead code from v1.5 KPI system remains in codebase"
    - "Export Key Result column shows 'KR1.1 - description' format instead of just 'KR1.1'"
    - "No resourcesFinancial or resourcesNonFinancial references remain in source code or schema"
    - "TypeScript compiles cleanly after all deletions and removals"
  artifacts:
    - path: "src/lib/initiative-kpi-utils.ts"
      provides: "DELETED -- must not exist"
    - path: "src/components/objectives/kpi-progress-bar.tsx"
      provides: "DELETED -- must not exist"
    - path: "src/lib/initiative-export-utils.ts"
      provides: "Updated export mapping with KR description"
      contains: "initiative.keyResult.description"
    - path: "prisma/schema.prisma"
      provides: "Schema without resourcesFinancial/resourcesNonFinancial"
  key_links:
    - from: "src/lib/initiative-export-utils.ts"
      to: "initiative.keyResult relation"
      via: "template literal combining krId and description"
      pattern: "keyResult\\.krId.*keyResult\\.description"
---

<objective>
Remove all dead code from the v1.5 KPI/string-keyResult system, update the Excel export Key Result column to show descriptions, and remove deprecated resourcesFinancial/resourcesNonFinancial fields from schema and code.

Purpose: Complete CLEAN-01 and CLEAN-02 requirements -- the codebase should have zero remnants of the old KPI system and deprecated field patterns.
Output: Deleted 2 orphan files, updated export mapping, removed deprecated schema fields from 7 files, Prisma schema pushed to database.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/52-cleanup-polish/52-RESEARCH.md
@src/lib/initiative-export-utils.ts
@prisma/schema.prisma
</context>

<tasks>

<task type="auto">
  <name>Task 1: Delete orphan files and remove deprecated schema fields</name>
  <files>
    src/lib/initiative-kpi-utils.ts (DELETE)
    src/components/objectives/kpi-progress-bar.tsx (DELETE)
    prisma/schema.prisma
    src/app/(dashboard)/initiatives/page.tsx
    src/app/(dashboard)/initiatives/[id]/page.tsx
    src/app/api/initiatives/route.ts
    src/app/api/initiatives/[id]/route.ts
    src/components/initiatives/initiative-detail.tsx
    src/components/initiatives/initiative-form.tsx
  </files>
  <action>
    Follow the delete-verify-commit cycle for each step. Run `npx tsc --noEmit` after EACH deletion/edit to catch breakage immediately.

    **Step A: Delete initiative-kpi-utils.ts**
    1. Verify zero imports: `grep -r "initiative-kpi-utils" src/` should return nothing
    2. Delete `src/lib/initiative-kpi-utils.ts`
    3. Run `npx tsc --noEmit` -- must pass clean

    **Step B: Delete kpi-progress-bar.tsx**
    1. Verify zero imports: `grep -r "KpiProgressBar\|kpi-progress-bar" src/` should return only the file itself
    2. Delete `src/components/objectives/kpi-progress-bar.tsx`
    3. Run `npx tsc --noEmit` -- must pass clean

    **Step C: Remove resourcesFinancial and resourcesNonFinancial**

    These old fields were deferred to Phase 52 for removal. They are replaced by the `budget` (String) and `resources` (String) fields already in use. The seed script does not populate them and no UI displays them.

    Edit these files to remove all `resourcesFinancial` and `resourcesNonFinancial` references:

    1. `prisma/schema.prisma` -- Remove these two lines from the Initiative model:
       ```
       resourcesFinancial    Decimal?             @db.Decimal(12, 2)
       resourcesNonFinancial String?              @db.Text
       ```

    2. `src/app/(dashboard)/initiatives/page.tsx` -- Remove the serialization line:
       ```
       resourcesFinancial: i.resourcesFinancial ? Number(i.resourcesFinancial) : null,
       ```

    3. `src/app/(dashboard)/initiatives/[id]/page.tsx` -- Remove the serialization lines:
       ```
       resourcesFinancial: initiative.resourcesFinancial
         ? Number(initiative.resourcesFinancial)
       ```
       (This is around lines 41-42)

    4. `src/app/api/initiatives/route.ts` -- Remove from POST data:
       ```
       resourcesFinancial: body.resourcesFinancial || null,
       resourcesNonFinancial: body.resourcesNonFinancial || null,
       ```
       (Around lines 87-88)

    5. `src/app/api/initiatives/[id]/route.ts` -- Remove from PUT data:
       ```
       resourcesFinancial: body.resourcesFinancial,
       resourcesNonFinancial: body.resourcesNonFinancial || null,
       ```
       (Around lines 101-102)

    6. `src/components/initiatives/initiative-detail.tsx` -- Remove from interface:
       ```
       resourcesFinancial: number | null
       resourcesNonFinancial: string | null
       ```
       (Around lines 73-74)

    7. `src/components/initiatives/initiative-form.tsx` -- Remove from interface:
       ```
       resourcesFinancial?: number | null
       resourcesNonFinancial?: string | null
       ```
       (Around lines 40-41)

    8. Run `npx prisma generate` to regenerate client without old fields
    9. Run `npx tsc --noEmit` -- must pass clean
    10. Run `npx prisma db push` to drop the columns from the database

    IMPORTANT: After removing the fields from TypeScript files, if `tsc` reveals any other references to `resourcesFinancial` or `resourcesNonFinancial` that were missed, fix them before proceeding.
  </action>
  <verify>
    1. `ls src/lib/initiative-kpi-utils.ts` returns "No such file"
    2. `ls src/components/objectives/kpi-progress-bar.tsx` returns "No such file"
    3. `grep -r "resourcesFinancial\|resourcesNonFinancial" src/ prisma/schema.prisma` returns no results
    4. `grep -r "initiative-kpi-utils\|KpiProgressBar\|kpi-progress-bar" src/` returns no results
    5. `npx tsc --noEmit` passes clean
    6. `npx prisma db push` applies without errors
  </verify>
  <done>
    initiative-kpi-utils.ts and kpi-progress-bar.tsx are deleted. resourcesFinancial and resourcesNonFinancial are removed from schema and all 6 code files. TypeScript compiles cleanly. Database schema is updated.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update Excel export Key Result column to show description</name>
  <files>
    src/lib/initiative-export-utils.ts
  </files>
  <action>
    Update the export utility to show "KR1.1 - description" instead of just "KR1.1" in the Key Result column. Two changes needed:

    1. **Line 108** -- Change the Key Result mapping from:
       ```typescript
       'Key Result': initiative.keyResult?.krId || '-',
       ```
       To:
       ```typescript
       'Key Result': initiative.keyResult
         ? `${initiative.keyResult.krId} - ${initiative.keyResult.description}`
         : '-',
       ```
       The `InitiativeForExport` type (line ~38) already includes `description` in the keyResult type, and the export API route already selects `description`. No type changes needed.

    2. **Line 59** -- Widen the Key Result column from `wch: 10` to `wch: 40` to accommodate the longer "KR1.1 - description" text:
       ```typescript
       { key: 'keyResult', header: 'Key Result', wch: 40 },
       ```

    No other changes needed. The column count stays at 17, column order unchanged. Budget/resources/accountable columns are already present from Phase 48.

    Run `npx tsc --noEmit` after changes to verify compilation.
  </action>
  <verify>
    1. `grep "keyResult.description" src/lib/initiative-export-utils.ts` returns the new mapping line
    2. `grep "wch: 40" src/lib/initiative-export-utils.ts` returns the updated column width
    3. `npx tsc --noEmit` passes clean
  </verify>
  <done>
    Excel export Key Result column shows "KR1.1 - Drive revenue through events" format instead of just "KR1.1". Column width increased to 40 characters to accommodate description text.
  </done>
</task>

</tasks>

<verification>
After both tasks complete:
1. `npx tsc --noEmit` passes with zero errors
2. `grep -r "initiative-kpi-utils\|KpiProgressBar\|kpi-progress-bar" src/` returns nothing
3. `grep -r "resourcesFinancial\|resourcesNonFinancial" src/ prisma/` returns nothing
4. `grep "keyResult.description" src/lib/initiative-export-utils.ts` confirms description in export
5. Both dead files no longer exist on disk
</verification>

<success_criteria>
- initiative-kpi-utils.ts deleted (was 91 lines, zero imports)
- kpi-progress-bar.tsx deleted (was 63 lines, zero imports)
- resourcesFinancial and resourcesNonFinancial removed from schema and 6 code files
- Export Key Result column shows "KR1.1 - description" format with wch: 40
- TypeScript compiles cleanly
- Database schema pushed (old columns dropped)
</success_criteria>

<output>
After completion, create `.planning/phases/52-cleanup-polish/52-01-SUMMARY.md`
</output>
