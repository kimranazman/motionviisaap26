---
phase: 52-cleanup-polish
plan: 02
type: execute
wave: 2
depends_on: ["52-01"]
files_modified: []
autonomous: true

must_haves:
  truths:
    - "No remaining references to initiative-level KPI fields in source code"
    - "No remaining references to keyResult-as-string pattern in source code"
    - "All 24 files from Appendix A verified migrated to FK relation"
    - "All 8 files from Appendix B verified with no KPI remnants"
    - "Full Next.js build succeeds (catches dynamic imports too)"
  artifacts: []
  key_links: []
---

<objective>
Verify all 32 files from the Pitfalls Appendix A (24 keyResult string files) and Appendix B (8 KPI files) are fully migrated with no remnants. Run comprehensive grep-based audit and full Next.js build to confirm zero dead code remains.

Purpose: Complete CLEAN-03 requirement -- provide verifiable proof that the v1.5 to v2.0 migration is 100% complete across the entire codebase.
Output: Full build passes, grep audit confirms zero remnants, verification complete.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/52-cleanup-polish/52-RESEARCH.md
@.planning/phases/52-cleanup-polish/52-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Comprehensive migration audit and build verification</name>
  <files>No files modified -- this is a verification-only task</files>
  <action>
    Run a comprehensive audit to verify CLEAN-03. This task modifies NO files -- it only verifies. If any check fails, fix the issue before proceeding.

    **Part A: Dead Code Grep Audit**

    Run these grep searches across the entire `src/` directory. Each MUST return zero results:

    1. KPI utility imports: `grep -r "initiative-kpi-utils" src/`
    2. KPI progress bar imports: `grep -r "KpiProgressBar\|kpi-progress-bar" src/`
    3. KPI field names (initiative-level): `grep -r "kpiTarget\|kpiActual\|kpiUnit\|kpiLabel\|kpiManualOverride\|kpiAutoCalculated" src/`
    4. Old monthly/weekly fields: `grep -r "monthlyObjective\|weeklyTasks" src/`
    5. Old KPI aggregation functions: `grep -r "calculateKpi\|aggregateKpiTotals\|KpiResult\|AggregatedKpi" src/`
    6. Deprecated resource fields: `grep -r "resourcesFinancial\|resourcesNonFinancial" src/ prisma/`

    If any grep returns results, investigate -- it could be a comment, a string literal in a different context, or a genuine remnant that needs fixing.

    **Part B: Appendix A Verification (24 keyResult string files)**

    Verify each of these files uses the FK relation pattern (keyResultId or keyResult relation), NOT the old string pattern. For each file, confirm ONE of these patterns:
    - Schema/API files: Use `keyResultId` FK and `keyResult` include/select
    - Server page files: Flatten `i.keyResult?.krId` to string at server layer
    - UI components: Receive either full object or flattened string

    Files to verify (all 24 from Appendix A):
    1. prisma/schema.prisma
    2. prisma/seed.ts
    3. src/app/api/initiatives/route.ts
    4. src/app/api/initiatives/[id]/route.ts
    5. src/app/api/initiatives/export/route.ts
    6. src/lib/initiative-group-utils.ts
    7. src/lib/initiative-export-utils.ts
    8. src/app/(dashboard)/objectives/page.tsx
    9. src/app/(dashboard)/kanban/page.tsx
    10. src/app/(dashboard)/calendar/page.tsx
    11. src/app/(dashboard)/timeline/page.tsx
    12. src/components/objectives/objective-hierarchy.tsx
    13. src/components/objectives/key-result-group.tsx
    14. src/components/objectives/objective-group.tsx
    15. src/components/initiatives/initiative-form.tsx
    16. src/components/initiatives/initiatives-list.tsx
    17. src/components/initiatives/initiative-detail.tsx
    18. src/components/kanban/initiative-detail-sheet.tsx
    19. src/components/kanban/kanban-board.tsx
    20. src/components/kanban/kanban-filter-bar.tsx
    21. src/components/kanban/kanban-card.tsx
    22. src/components/kanban/kanban-swimlane-view.tsx
    23. src/components/timeline/gantt-chart.tsx
    24. src/components/calendar/calendar-view.tsx

    Plus 3 additional files identified during research:
    25. src/app/(dashboard)/initiatives/page.tsx
    26. src/app/(dashboard)/initiatives/[id]/page.tsx
    27. src/components/initiatives/initiative-detail.tsx

    For each file, a quick grep for `keyResult` should show FK-based usage (keyResultId, keyResult?.krId, keyResult relation), NOT a bare `keyResult: String` or `keyResult: string` as a model field.

    **Part C: Appendix B Verification (8 KPI files)**

    Verify these 8 files have no remaining KPI references:
    1. src/lib/initiative-kpi-utils.ts -- MUST NOT EXIST (deleted in Plan 01)
    2. src/lib/initiative-export-utils.ts -- No KPI columns
    3. src/components/objectives/key-result-group.tsx -- No aggregateKpiTotals
    4. src/components/objectives/initiative-row.tsx -- No calculateKpi, no KpiProgressBar
    5. src/components/objectives/objective-hierarchy.tsx -- No KPI fields in interfaces
    6. src/components/kanban/initiative-detail-sheet.tsx -- No KPI state, no KPI section
    7. src/app/(dashboard)/objectives/page.tsx -- No KPI fields in Prisma select
    8. src/app/api/initiatives/[id]/route.ts -- No KPI fields in include/select

    **Part D: Full Build**

    Run `npm run build` to verify the entire Next.js application builds successfully. This catches dynamic imports that `tsc --noEmit` might miss.

    The build MUST succeed with zero errors.

    **If any check fails:** Fix the issue (this may require editing files), then re-run the failing verification step. Document what was fixed.
  </action>
  <verify>
    1. All 6 grep searches from Part A return zero results
    2. All 24+3 files from Part B confirmed using FK-based pattern
    3. All 8 files from Part C confirmed KPI-free
    4. `npm run build` succeeds with zero errors
  </verify>
  <done>
    Full codebase audit confirms: zero KPI remnants, zero keyResult-as-string remnants, zero deprecated field references. All 32 files from Pitfalls Appendix A+B verified migrated. Next.js build succeeds. Phase 52 CLEAN-03 requirement is satisfied.
  </done>
</task>

</tasks>

<verification>
Final phase-level verification:
1. CLEAN-01: `ls src/lib/initiative-kpi-utils.ts src/components/objectives/kpi-progress-bar.tsx` both return "No such file"
2. CLEAN-01: `grep -r "resourcesFinancial\|resourcesNonFinancial" src/ prisma/` returns nothing
3. CLEAN-02: `grep "keyResult.description" src/lib/initiative-export-utils.ts` returns the export mapping
4. CLEAN-03: `npm run build` succeeds
5. CLEAN-03: All dead-code grep searches return zero results
</verification>

<success_criteria>
- All 6 dead-code grep searches return zero results
- All 32 Pitfalls Appendix files verified migrated
- `npm run build` succeeds with zero errors
- Phase 52 is complete -- v2.0 OKR Restructure codebase is clean
</success_criteria>

<output>
After completion, create `.planning/phases/52-cleanup-polish/52-02-SUMMARY.md`
</output>
