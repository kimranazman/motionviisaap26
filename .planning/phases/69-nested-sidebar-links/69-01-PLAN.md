# Plan 69-01: Nav Config & Sidebar Nested Rendering

## Frontmatter

```yaml
phase: 69
plan: 69-01
title: "Nav Config & Sidebar Nested Rendering"
wave: 1
depends_on: []
files_modified:
  - src/lib/nav-config.ts
  - src/components/layout/nav-group.tsx
  - src/components/layout/sidebar.tsx
  - src/components/layout/mobile-sidebar.tsx
autonomous: true
```

## Goal

Add children support to NavItem, restructure Companies with Departments/Contacts as nested sub-items, and update NavGroupComponent to render expandable nested items with separate chevron toggle and label navigation. Both desktop and mobile sidebars render the nested hierarchy identically.

## Requirements Addressed

- NEST-01: Companies nav item has expand/collapse chevron showing Departments and Contacts as indented sub-items
- NEST-02: Clicking "Companies" label navigates to /companies; clicking chevron toggles sub-items
- NEST-03: Companies parent is highlighted when on /companies, /departments, or /contacts
- NEST-06: Mobile sidebar renders nested items with same hierarchy and behavior

## Tasks

<task id="1">
<title>Extend NavItem type with optional children</title>
<file>src/lib/nav-config.ts</file>
<action>
1. Add `children?: NavItem[]` to the `NavItem` interface
2. Restructure the CRM group: remove standalone Departments and Contacts items
3. Add them as `children` of the Companies item:
   ```typescript
   { name: 'Companies', href: '/companies', icon: Building2, children: [
     { name: 'Departments', href: '/departments', icon: Building },
     { name: 'Contacts', href: '/contacts', icon: Contact },
   ]},
   ```
4. Update `getAllNavHrefs()` to iterate children:
   ```typescript
   for (const item of group.items) {
     hrefs.push(item.href)
     if (item.children) {
       for (const child of item.children) {
         hrefs.push(child.href)
       }
     }
   }
   ```
5. Update `findGroupForPath()` to check children:
   ```typescript
   for (const item of group.items) {
     if (item.href === '/') {
       if (pathname === '/') return group.key
     } else {
       if (pathname === item.href || pathname.startsWith(item.href)) return group.key
     }
     if (item.children) {
       for (const child of item.children) {
         if (pathname === child.href || pathname.startsWith(child.href)) return group.key
       }
     }
   }
   ```
</action>
</task>

<task id="2">
<title>Update NavGroupComponent to render nested items</title>
<file>src/components/layout/nav-group.tsx</file>
<action>
1. Import `ChevronDown` icon (or reuse `ChevronRight` with rotation) and `useState` for nested expand state
2. For items WITH `children`:
   - Render a container div with two click zones:
     a. The label area (icon + name) wrapped in a `Link` to `item.href`
     b. A chevron button that toggles children visibility
   - Determine `isActive` for parent: true when pathname matches item.href OR any child.href (exact or startsWith)
   - Maintain local state `expandedItems: Record<string, boolean>` for nested expand/collapse
   - Default: expanded if parent or any child is active route
   - When expanded, render children as indented links (add `pl-9` to indent under parent icon)
   - Each child has its own `isActive` check
   - Children items also call `onLinkClick` when clicked (mobile close)
3. For items WITHOUT `children`:
   - Render exactly as before (no behavior change)
4. The `filterVisible` function must be applied to children too:
   - Filter parent's children through visibility
   - If all children are filtered out, parent still shows but without chevron
   - If parent is filtered out, children are not rendered (handled by parent-level filter)
5. Update the `NavGroupProps` filterVisible to also handle children:
   - Apply filterVisible to item.children before rendering
   - Chevron only shows if item has visible children after filtering

Here is the approximate JSX for a parent item with children:
```tsx
<div key={item.href}>
  <div className={cn(
    'flex items-center rounded-lg px-3 py-2 text-sm font-medium transition-colors',
    parentIsActive ? 'bg-gray-100 text-gray-900' : 'text-gray-600 hover:bg-gray-50 hover:text-gray-900'
  )}>
    <Link
      href={item.href}
      onClick={onLinkClick}
      className="flex items-center gap-3 flex-1 min-w-0"
    >
      <item.icon className="h-5 w-5" />
      {item.name}
    </Link>
    {visibleChildren.length > 0 && (
      <button
        onClick={(e) => { e.stopPropagation(); toggleNested(item.href) }}
        className="p-1 rounded hover:bg-gray-200 transition-colors"
      >
        <ChevronRight className={cn(
          'h-3.5 w-3.5 text-gray-400 transition-transform duration-200',
          isNestedExpanded && 'rotate-90'
        )} />
      </button>
    )}
  </div>
  {isNestedExpanded && visibleChildren.length > 0 && (
    <div className="flex flex-col gap-0.5 mt-0.5">
      {visibleChildren.map((child) => {
        const childActive = pathname === child.href || pathname.startsWith(child.href)
        return (
          <Link key={child.href} href={child.href} onClick={onLinkClick}
            className={cn(
              'flex items-center gap-3 rounded-lg pl-9 pr-3 py-1.5 text-sm transition-colors',
              childActive ? 'bg-gray-100 text-gray-900 font-medium' : 'text-gray-500 hover:bg-gray-50 hover:text-gray-900'
            )}>
            <child.icon className="h-4 w-4" />
            {child.name}
          </Link>
        )
      })}
    </div>
  )}
</div>
```
</action>
</task>

<task id="3">
<title>Update sidebar visibility filtering for children</title>
<file>src/components/layout/sidebar.tsx</file>
<action>
1. The `visibleGroups` memo currently filters `group.items` via `isVisible(item.href)`.
2. Update: still filter parent items via isVisible, but for items with children, also check if hiding the parent should hide children (this is handled at render time by nav-group via filterVisible).
3. The filterVisible function passed to NavGroupComponent already works at the item level. Children filtering is handled inside NavGroupComponent (task 2).
4. No structural changes needed — the existing filterVisible prop handles it since NavGroupComponent now applies it to children too.
5. Verify the visibleCount calculation: it should count parent items that are visible. Children are secondary (they don't affect group header count). Keep count as `visibleItems.length` (number of visible top-level items in group).
</action>
</task>

<task id="4">
<title>Update mobile sidebar visibility filtering</title>
<file>src/components/layout/mobile-sidebar.tsx</file>
<action>
1. Same approach as sidebar.tsx — the mobile sidebar uses the same NavGroupComponent.
2. The `filterVisible` prop and `onLinkClick` are already passed.
3. Verify that onLinkClick closes the sheet when a child item is clicked.
4. No structural changes needed — NavGroupComponent changes from task 2 propagate automatically.
5. Test: verify that clicking a nested child item (Departments, Contacts) closes the mobile sheet.
</action>
</task>

## Verification

```yaml
checks:
  - description: "NavItem interface has optional children field"
    command: "grep -n 'children' src/lib/nav-config.ts"
    expect: "children?: NavItem[]"

  - description: "Companies has Departments and Contacts as children"
    command: "grep -A5 'Companies' src/lib/nav-config.ts"
    expect: "children:"

  - description: "Departments and Contacts are NOT standalone CRM items"
    command: "grep -c \"name: 'Departments'\" src/lib/nav-config.ts"
    expect: "1"

  - description: "NavGroupComponent handles children rendering"
    command: "grep -n 'children' src/components/layout/nav-group.tsx"
    expect: "multiple matches for children handling"

  - description: "Chevron toggle exists for parent items"
    command: "grep 'toggleNested\\|expandedItems\\|nestedExpanded' src/components/layout/nav-group.tsx"
    expect: "state management for nested expand"

  - description: "Child items are indented"
    command: "grep 'pl-9\\|pl-8' src/components/layout/nav-group.tsx"
    expect: "indentation class"

  - description: "Parent active when child route active"
    command: "grep -A3 'parentIsActive\\|parentActive' src/components/layout/nav-group.tsx"
    expect: "child href check in parent active logic"

  - description: "getAllNavHrefs includes children"
    command: "grep -A5 'item.children' src/lib/nav-config.ts | grep 'child.href'"
    expect: "hrefs.push(child.href)"

  - description: "App compiles without errors"
    command: "cd /Users/khairul/Documents/MyDev/Work/Motionvii/saap2026v2 && npx tsc --noEmit 2>&1 | head -20"
    expect: "no errors"
```

## must_haves

- Companies nav item has a chevron that toggles Departments and Contacts sub-items
- Clicking Companies label navigates to /companies (not just toggles)
- Companies parent is highlighted when on /companies, /departments, or /contacts
- Sub-items render indented under parent
- Mobile sidebar renders identical nested hierarchy
- Existing non-nested items (Pipeline, Projects, etc.) render unchanged
- App compiles without TypeScript errors
