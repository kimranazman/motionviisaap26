---
phase: 15-dashboard-widgets
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/pipeline-utils.ts
  - src/app/(dashboard)/page.tsx
  - src/components/dashboard/crm-kpi-cards.tsx
  - src/components/dashboard/pipeline-stage-chart.tsx
autonomous: true

must_haves:
  truths:
    - "Dashboard shows pipeline breakdown by stage with deal counts and values"
    - "Dashboard shows open pipeline total (sum of non-Won/Lost deals)"
    - "Dashboard shows weighted forecast (probability-adjusted values)"
    - "Dashboard shows win rate percentage"
  artifacts:
    - path: "src/lib/pipeline-utils.ts"
      provides: "STAGE_PROBABILITY constant"
      contains: "STAGE_PROBABILITY"
    - path: "src/components/dashboard/crm-kpi-cards.tsx"
      provides: "CRM KPI cards component"
      exports: ["CRMKPICards"]
    - path: "src/components/dashboard/pipeline-stage-chart.tsx"
      provides: "Pipeline stage horizontal bar chart"
      exports: ["PipelineStageChart"]
    - path: "src/app/(dashboard)/page.tsx"
      provides: "Dashboard with CRM section"
      contains: "getCRMDashboardData"
  key_links:
    - from: "src/app/(dashboard)/page.tsx"
      to: "prisma.deal"
      via: "groupBy aggregation"
      pattern: "prisma\\.deal\\.groupBy"
    - from: "src/components/dashboard/crm-kpi-cards.tsx"
      to: "src/lib/utils.ts"
      via: "formatCurrency import"
      pattern: "import.*formatCurrency.*from"
    - from: "src/components/dashboard/pipeline-stage-chart.tsx"
      to: "recharts"
      via: "BarChart component"
      pattern: "import.*BarChart.*from.*recharts"
---

<objective>
Add pipeline widgets to dashboard showing deal breakdown by stage, open pipeline value, weighted forecast, and win rate.

Purpose: Enable users to see sales pipeline health at a glance - total open deals, probability-weighted forecast, and conversion metrics.

Output: New CRM section on dashboard with 4 KPI cards (Open Pipeline, Weighted Forecast, Win Rate, Deal Count) and a horizontal bar chart showing pipeline by stage.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/15-dashboard-widgets/15-RESEARCH.md

# Existing patterns
@src/app/(dashboard)/page.tsx
@src/components/dashboard/kpi-cards.tsx
@src/components/dashboard/department-chart.tsx
@src/lib/pipeline-utils.ts
@src/lib/utils.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add STAGE_PROBABILITY constant and create CRM data fetching</name>
  <files>src/lib/pipeline-utils.ts, src/app/(dashboard)/page.tsx</files>
  <action>
1. Add STAGE_PROBABILITY constant to src/lib/pipeline-utils.ts:
```typescript
export const STAGE_PROBABILITY: Record<string, number> = {
  LEAD: 0.10,
  QUALIFIED: 0.25,
  PROPOSAL: 0.50,
  NEGOTIATION: 0.75,
  WON: 1.00,
  LOST: 0.00,
}

export const STAGE_CHART_COLORS: Record<string, string> = {
  LEAD: '#9CA3AF',
  QUALIFIED: '#60A5FA',
  PROPOSAL: '#A78BFA',
  NEGOTIATION: '#FBBF24',
}
```

2. Add getCRMDashboardData function to src/app/(dashboard)/page.tsx (after existing getDashboardData):
```typescript
async function getCRMDashboardData() {
  // Pipeline by stage (open deals only)
  const pipelineByStage = await prisma.deal.groupBy({
    by: ['stage'],
    _count: { _all: true },
    _sum: { value: true },
    where: { stage: { notIn: ['WON', 'LOST'] } }
  })

  // Total open pipeline
  const openPipelineResult = await prisma.deal.aggregate({
    where: { stage: { notIn: ['WON', 'LOST'] } },
    _sum: { value: true },
    _count: { _all: true }
  })

  // Win rate calculation
  const closedDeals = await prisma.deal.count({
    where: { stage: { in: ['WON', 'LOST'] } }
  })
  const wonDeals = await prisma.deal.count({
    where: { stage: 'WON' }
  })

  // Calculate weighted forecast
  const weightedValue = pipelineByStage.reduce((sum, item) => {
    const value = Number(item._sum.value) || 0
    const probability = STAGE_PROBABILITY[item.stage] || 0
    return sum + (value * probability)
  }, 0)

  // Transform to ordered array
  const stageData = STAGES.filter(s => !['WON', 'LOST'].includes(s.id)).map(stage => {
    const found = pipelineByStage.find(m => m.stage === stage.id)
    return {
      id: stage.id,
      name: stage.title,
      count: found?._count._all ?? 0,
      value: Number(found?._sum.value) || 0,
      color: STAGE_CHART_COLORS[stage.id] || '#9CA3AF',
    }
  })

  return {
    stageData,
    openPipeline: Number(openPipelineResult._sum.value) || 0,
    dealCount: openPipelineResult._count._all,
    weightedForecast: Math.round(weightedValue),
    winRate: closedDeals > 0 ? Math.round((wonDeals / closedDeals) * 100) : 0,
    closedDealsCount: closedDeals,
  }
}
```

3. Add import for STAGES, STAGE_PROBABILITY, STAGE_CHART_COLORS at top of page.tsx.

4. Call getCRMDashboardData in DashboardPage and pass to new components (placeholder for now - Task 2 will add components).
  </action>
  <verify>
- TypeScript compiles without errors: `npx tsc --noEmit`
- No runtime errors when loading dashboard
  </verify>
  <done>
- STAGE_PROBABILITY and STAGE_CHART_COLORS constants exist in pipeline-utils.ts
- getCRMDashboardData function exists and returns structured data
- Dashboard page calls getCRMDashboardData
  </done>
</task>

<task type="auto">
  <name>Task 2: Create CRM KPI cards and pipeline stage chart components</name>
  <files>src/components/dashboard/crm-kpi-cards.tsx, src/components/dashboard/pipeline-stage-chart.tsx, src/app/(dashboard)/page.tsx</files>
  <action>
1. Create src/components/dashboard/crm-kpi-cards.tsx:
- 'use client' directive
- Accept props: openPipeline, weightedForecast, winRate, dealCount
- Display 4 KPI cards in a row (same pattern as existing kpi-cards.tsx):
  - Open Pipeline: formatCurrency(openPipeline), subtitle "{dealCount} deals", blue color, Target icon
  - Weighted Forecast: formatCurrency(weightedForecast), subtitle "Probability-adjusted", purple color, TrendingUp icon
  - Win Rate: "{winRate}%", subtitle "Won vs closed", green color, CheckCircle2 icon
  - Total Deals: dealCount, subtitle "In pipeline", gray color, Briefcase icon
- Use existing Card, CardContent from @/components/ui/card
- Follow exact styling pattern from kpi-cards.tsx

2. Create src/components/dashboard/pipeline-stage-chart.tsx:
- 'use client' directive
- Accept props: data array with { id, name, count, value, color }
- Use horizontal BarChart from recharts (same pattern as department-chart.tsx)
- Show stage name on Y-axis, value on X-axis
- Add custom Tooltip showing: stage name, count deals, formatCurrency(value)
- Card wrapper with title "Pipeline by Stage"

3. Update src/app/(dashboard)/page.tsx to render new components:
- Import CRMKPICards and PipelineStageChart
- Add CRM section after existing initiative dashboard (before closing div)
- Add section divider with title "Sales & Revenue"
- Render CRMKPICards with crmData props
- Render PipelineStageChart with crmData.stageData
  </action>
  <verify>
- Dashboard loads without errors
- CRM KPI cards show 4 metrics in a row
- Pipeline stage chart shows horizontal bars for Lead, Qualified, Proposal, Negotiation
- Hover shows tooltip with deal count and value
  </verify>
  <done>
- CRMKPICards component renders Open Pipeline, Weighted Forecast, Win Rate, Total Deals
- PipelineStageChart component renders horizontal bar chart
- Dashboard page displays new CRM section below initiative section
  </done>
</task>

</tasks>

<verification>
1. Dashboard page loads: `curl http://localhost:3000` returns 200
2. CRM section visible below initiative section
3. Pipeline KPI cards show values (or 0 if no deals)
4. Pipeline stage chart renders (empty state OK if no deals)
5. TypeScript compiles: `npx tsc --noEmit`
</verification>

<success_criteria>
- DASH-01: Pipeline stage chart shows breakdown by stage with values
- DASH-02: Open Pipeline card shows sum of non-Won/Lost deals
- DASH-05: Weighted Forecast card shows probability-adjusted total
- DASH-06: Win Rate card shows won/closed percentage
</success_criteria>

<output>
After completion, create `.planning/phases/15-dashboard-widgets/15-01-SUMMARY.md`
</output>
