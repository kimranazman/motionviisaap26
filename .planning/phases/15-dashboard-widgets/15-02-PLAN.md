---
phase: 15-dashboard-widgets
plan: 02
type: execute
wave: 2
depends_on: ["15-01"]
files_modified:
  - src/app/(dashboard)/page.tsx
  - src/components/dashboard/crm-kpi-cards.tsx
autonomous: true

must_haves:
  truths:
    - "Dashboard shows total revenue from completed projects"
    - "Dashboard shows total profit (revenue minus costs)"
    - "Profit card shows blue for positive, orange for negative"
  artifacts:
    - path: "src/app/(dashboard)/page.tsx"
      provides: "Revenue and profit aggregations"
      contains: "totalRevenue"
    - path: "src/components/dashboard/crm-kpi-cards.tsx"
      provides: "Revenue and Profit KPI cards"
      contains: "Revenue"
  key_links:
    - from: "src/app/(dashboard)/page.tsx"
      to: "prisma.project"
      via: "aggregate for completed projects"
      pattern: "prisma\\.project\\.aggregate"
    - from: "src/app/(dashboard)/page.tsx"
      to: "prisma.cost"
      via: "aggregate for total costs"
      pattern: "prisma\\.cost\\.aggregate"
    - from: "src/components/dashboard/crm-kpi-cards.tsx"
      to: "src/lib/utils.ts"
      via: "cn for conditional styling"
      pattern: "import.*cn.*from"
---

<objective>
Add revenue and profit widgets to dashboard showing completed project revenue and overall profit.

Purpose: Enable users to see financial health - total revenue generated from completed projects and net profit after all costs.

Output: Two additional KPI cards in CRM section: Revenue (sum of completed project revenues) and Profit (revenue minus costs, with color-coded positive/negative).
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/15-dashboard-widgets/15-RESEARCH.md
@.planning/phases/15-dashboard-widgets/15-01-SUMMARY.md

# Existing patterns
@src/components/project/project-detail-sheet.tsx (profit card styling)
@src/lib/cost-utils.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add revenue and profit aggregations to CRM data</name>
  <files>src/app/(dashboard)/page.tsx</files>
  <action>
1. Extend getCRMDashboardData function to add revenue and profit queries:

```typescript
// Add after existing queries in getCRMDashboardData

// Revenue from completed projects
const revenueResult = await prisma.project.aggregate({
  where: { status: 'COMPLETED' },
  _sum: { revenue: true }
})

// Total costs from all projects
const costsResult = await prisma.cost.aggregate({
  _sum: { amount: true }
})

const totalRevenue = Number(revenueResult._sum.revenue) || 0
const totalCosts = Number(costsResult._sum.amount) || 0
const profit = totalRevenue - totalCosts
```

2. Add to return object:
```typescript
return {
  // ...existing fields
  totalRevenue,
  totalCosts,
  profit,
}
```

3. Update CRMKPICards props in JSX to include totalRevenue and profit.
  </action>
  <verify>
- TypeScript compiles without errors: `npx tsc --noEmit`
- Console log in getCRMDashboardData shows correct values
  </verify>
  <done>
- getCRMDashboardData returns totalRevenue, totalCosts, profit
- Values passed to CRMKPICards component
  </done>
</task>

<task type="auto">
  <name>Task 2: Add Revenue and Profit cards to CRM KPI component</name>
  <files>src/components/dashboard/crm-kpi-cards.tsx</files>
  <action>
1. Extend CRMKPICardsProps interface to include:
- totalRevenue: number
- profit: number

2. Update component to render 6 cards total (2 rows of 3, or responsive grid):
- Row 1: Open Pipeline, Weighted Forecast, Win Rate
- Row 2: Total Deals, Revenue, Profit

3. Add Revenue card:
- Title: "Revenue"
- Value: formatCurrency(totalRevenue)
- Subtitle: "Completed projects"
- Icon: DollarSign (import from lucide-react)
- Color: green-600, bg-green-50

4. Add Profit card with conditional styling (following project-detail-sheet pattern):
- Title: "Profit"
- Value: formatCurrency(profit)
- Subtitle: "Revenue minus costs"
- Icon: TrendingUp
- Conditional color: profit >= 0 ? blue-600/bg-blue-50 : orange-600/bg-orange-50
- Use cn() for conditional class merging

5. Update grid layout:
- Use `grid-cols-2 lg:grid-cols-3` for responsive 2x3 layout
- Or keep `grid-cols-2 lg:grid-cols-4` and show 6 cards (wrapping to 2nd row)
  </action>
  <verify>
- Dashboard shows Revenue card with green styling
- Dashboard shows Profit card with blue (positive) or orange (negative) styling
- Cards are responsive and wrap correctly on mobile
  </verify>
  <done>
- Revenue card shows sum of completed project revenues
- Profit card shows revenue minus costs with color-coded styling
- All 6 CRM KPI cards render correctly in grid layout
  </done>
</task>

</tasks>

<verification>
1. Dashboard page loads without errors
2. Revenue card shows "Revenue" with green styling and currency value
3. Profit card shows "Profit" with conditional blue/orange styling
4. If no completed projects: Revenue shows RM 0, Profit shows RM 0 (or negative if costs exist)
5. TypeScript compiles: `npx tsc --noEmit`
</verification>

<success_criteria>
- DASH-03: Revenue card shows sum of completed project revenues
- DASH-04: Profit card shows total revenue minus total costs, color-coded for positive/negative
</success_criteria>

<output>
After completion, create `.planning/phases/15-dashboard-widgets/15-02-SUMMARY.md`
</output>
