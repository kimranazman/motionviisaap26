# Plan 77-03: Add Grouping Toggle to Tasks Page

## Frontmatter

```yaml
phase: 77
plan: 03
wave: 2
depends_on:
  - 77-01
  - 77-02
files_modified:
  - src/components/tasks/tasks-page-client.tsx
autonomous: true
```

## Objective

Add a grouping mode toggle to the tasks page that allows users to switch between "group by status" (default, current behavior) and "group by project" (new feature) when in kanban view.

## Context

From 77-RESEARCH.md:
- Toggle only visible when Kanban view is selected
- Options: "By Status" (default) | "By Project"
- Persists preference to localStorage (consistent with view mode pattern)
- Uses same Tabs/TabsList pattern as existing view toggle

## Tasks

<task id="1">
Update `src/components/tasks/tasks-page-client.tsx` to add grouping mode state and toggle:

1. Add import for the new TaskKanbanProjectView component
2. Add groupMode state with localStorage persistence
3. Add grouping toggle UI (visible only in kanban mode)
4. Conditionally render TaskKanbanView or TaskKanbanProjectView based on groupMode

**Changes to make:**

After the existing imports, add:
```typescript
import { TaskKanbanProjectView } from './task-kanban-project-view'
```

Add new storage key constant:
```typescript
const GROUPING_STORAGE_KEY = 'tasks-grouping-preference'
```

Add groupMode state (after viewMode state):
```typescript
// Grouping mode state (only applies to kanban view)
const [groupMode, setGroupMode] = useState<'status' | 'project'>('status')
```

Add useEffect to load grouping preference (after the viewMode useEffect):
```typescript
// Load grouping preference from localStorage (SSR-safe)
useEffect(() => {
  try {
    const stored = localStorage.getItem(GROUPING_STORAGE_KEY)
    if (stored === 'status' || stored === 'project') {
      setGroupMode(stored)
    }
  } catch {
    /* ignore */
  }
}, [])
```

Add handler for grouping change (after handleViewChange):
```typescript
// Persist grouping preference
const handleGroupingChange = (mode: string) => {
  const validMode = mode as 'status' | 'project'
  setGroupMode(validMode)
  try {
    localStorage.setItem(GROUPING_STORAGE_KEY, validMode)
  } catch {
    /* ignore */
  }
}
```

Update the view toggle section to add the grouping toggle. Find this section in the JSX:
```jsx
{/* View Toggle */}
<Tabs
  value={viewMode}
  ...
```

Replace that entire Tabs block with:
```jsx
{/* View Toggle + Grouping Toggle */}
<div className="flex items-center gap-2">
  {/* Grouping Toggle (only in kanban mode) */}
  {viewMode === 'kanban' && (
    <Tabs
      value={groupMode}
      onValueChange={handleGroupingChange}
      className="shrink-0"
    >
      <TabsList className="bg-white/70 backdrop-blur-xl border border-gray-200/50 h-9">
        <TabsTrigger value="status" className="text-xs px-2 data-[state=active]:bg-white">
          By Status
        </TabsTrigger>
        <TabsTrigger value="project" className="text-xs px-2 data-[state=active]:bg-white">
          By Project
        </TabsTrigger>
      </TabsList>
    </Tabs>
  )}

  {/* View Toggle */}
  <Tabs
    value={viewMode}
    onValueChange={handleViewChange}
    className="shrink-0 w-full md:w-auto"
  >
    <TabsList className="bg-white/70 backdrop-blur-xl border border-gray-200/50">
      <TabsTrigger value="table" className="gap-1.5 data-[state=active]:bg-white">
        <TableIcon className="h-4 w-4" />
        Table
      </TabsTrigger>
      <TabsTrigger value="kanban" className="gap-1.5 data-[state=active]:bg-white">
        <KanbanSquare className="h-4 w-4" />
        Kanban
      </TabsTrigger>
    </TabsList>
  </Tabs>
</div>
```

Update the Kanban View rendering section. Find:
```jsx
{/* Kanban View */}
{viewMode === 'kanban' && (
  <TaskKanbanView
    ...
```

Replace with:
```jsx
{/* Kanban View */}
{viewMode === 'kanban' && groupMode === 'status' && (
  <TaskKanbanView
    tasks={filteredTasks}
    onTaskClick={handleTaskClick}
    onTasksChange={(updatedTasks) => {
      setTasks(prev => prev.map(t => {
        const updated = updatedTasks.find(u => u.id === t.id)
        return updated || t
      }))
    }}
  />
)}

{/* Kanban Project Grouped View */}
{viewMode === 'kanban' && groupMode === 'project' && (
  <TaskKanbanProjectView
    tasks={filteredTasks}
    onTaskClick={handleTaskClick}
    onTasksChange={(updatedTasks) => {
      setTasks(prev => prev.map(t => {
        const updated = updatedTasks.find(u => u.id === t.id)
        return updated || t
      }))
    }}
  />
)}
```
</task>

## Verification

```yaml
check:
  - no_typescript_errors: src/components/tasks/tasks-page-client.tsx
  - imports_valid:
      - './task-kanban-project-view'
  - component_renders: TaskKanbanProjectView when groupMode is 'project'
  - component_renders: TaskKanbanView when groupMode is 'status'
  - toggle_visible: only when viewMode is 'kanban'
```

## Must-Haves

- [ ] Import TaskKanbanProjectView component
- [ ] groupMode state initialized to 'status' (default)
- [ ] localStorage persistence for groupMode (key: 'tasks-grouping-preference')
- [ ] Grouping toggle visible only when viewMode === 'kanban'
- [ ] Toggle shows "By Status" and "By Project" options
- [ ] TaskKanbanView renders when groupMode === 'status'
- [ ] TaskKanbanProjectView renders when groupMode === 'project'
- [ ] Both views receive same props (tasks, onTaskClick, onTasksChange)
