---
phase: 41-date-intelligence
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/initiative-date-utils.ts
  - src/components/objectives/date-badges.tsx
  - src/components/objectives/objective-hierarchy.tsx
  - src/components/objectives/objective-group.tsx
  - src/components/objectives/key-result-group.tsx
  - src/components/objectives/initiative-row.tsx
autonomous: true

must_haves:
  truths:
    - "Overdue initiatives show red badge with 'Xd overdue' text"
    - "Ending-soon initiatives show orange badge with 'Ends in Xd' text (within 14 days)"
    - "Late-start initiatives show yellow 'Late start' badge"
    - "Invalid date combinations show red 'Invalid dates' badge"
    - "Long-duration initiatives (>180 days) show gray info badge with duration"
    - "Owner with >3 concurrent active initiatives shows orange 'Workload: X concurrent' badge"
    - "Badges display inline in By Objective hierarchy per initiative row"
    - "Completed/cancelled initiatives do NOT show overdue or ending-soon badges"
  artifacts:
    - path: "src/lib/initiative-date-utils.ts"
      provides: "detectOwnerOverlap() and extended DateIntelligence with daysOverdue"
      exports: ["detectOwnerOverlap", "generateTimelineSuggestions", "DateIntelligence", "DateFlag"]
    - path: "src/components/objectives/date-badges.tsx"
      provides: "DateBadges component rendering color-coded inline badges"
      exports: ["DateBadges"]
    - path: "src/components/objectives/initiative-row.tsx"
      provides: "InitiativeRow with DateBadges integrated between title and KPI bar"
    - path: "src/components/objectives/objective-hierarchy.tsx"
      provides: "ObjectiveHierarchy computing overlapMap from initialData"
  key_links:
    - from: "src/components/objectives/date-badges.tsx"
      to: "src/lib/initiative-date-utils.ts"
      via: "import analyzeDates and DateFlag type"
      pattern: "analyzeDates.*initiative-date-utils"
    - from: "src/components/objectives/objective-hierarchy.tsx"
      to: "src/lib/initiative-date-utils.ts"
      via: "import detectOwnerOverlap, compute overlapMap"
      pattern: "detectOwnerOverlap.*initiative-date-utils"
    - from: "src/components/objectives/initiative-row.tsx"
      to: "src/components/objectives/date-badges.tsx"
      via: "renders DateBadges component"
      pattern: "<DateBadges"
---

<objective>
Add date intelligence badges to initiative rows in the By Objective hierarchy view. Extend the existing date utility with owner overlap detection and daysOverdue field, create a DateBadges component, and integrate it through the component tree so every initiative row shows contextual date flags.

Purpose: Users can instantly see which initiatives are overdue, ending soon, late to start, have invalid dates, are unusually long, or have overloaded owners -- enabling proactive timeline management.
Output: Color-coded date badges visible on every initiative row in the objectives view, with overlap detection computed once at hierarchy level.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/41-date-intelligence/41-RESEARCH.md

Key source files:
@src/lib/initiative-date-utils.ts
@src/components/objectives/objective-hierarchy.tsx
@src/components/objectives/objective-group.tsx
@src/components/objectives/key-result-group.tsx
@src/components/objectives/initiative-row.tsx
@src/components/ai/confidence-badge.tsx (pattern reference for color-coded badges)
@src/components/ui/badge.tsx
@src/components/ui/tooltip.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend date utility with overlap detection, timeline suggestions, and daysOverdue</name>
  <files>src/lib/initiative-date-utils.ts</files>
  <action>
Extend `src/lib/initiative-date-utils.ts` with three additions:

1. **Extend `DateIntelligence` interface** -- add `daysOverdue: number | null` field. When the `overdue` flag is present, `daysOverdue` should equal `differenceInDays(new Date(), end)` (a positive number). Otherwise null.

2. **Update `analyzeDates()` function** -- compute and return `daysOverdue` in the return object. When `isOverdue` is true, set `daysOverdue = differenceInDays(today, end)`. Otherwise `daysOverdue: null`. This avoids the pitfall where badge components would need to re-compute the overdue days.

3. **Add `detectOwnerOverlap()` function** -- accepts an array of initiatives with `{ id, personInCharge, startDate, endDate, status }`. Returns `Map<string, number>` where key is initiative ID and value is the count of concurrent active initiatives for that owner (including self). Implementation:
   - Filter to active initiatives (status not COMPLETED/CANCELLED) that have a personInCharge
   - Group by personInCharge for efficiency
   - For each initiative in each group, count how many others in the same group have overlapping date ranges (using `start1 <= end2 && start2 <= end1` after converting to Date objects)
   - Return count + 1 (include self) for each initiative

4. **Add `generateTimelineSuggestions()` function** -- accepts `flags: DateFlag[]`, `durationDays: number`, `overlapCount: number`. Returns `string[]` of human-readable suggestions:
   - overdue: "Consider extending the end date or marking as completed/cancelled"
   - late-start: "Initiative has not started despite start date passing. Update status or adjust start date"
   - long-duration: "Duration is {durationDays} days. Consider breaking into smaller initiatives"
   - invalid-dates: "End date is before start date. Correct the date range"
   - overlapCount > 3: "Owner has {overlapCount} concurrent initiatives. Consider redistributing workload"
   - Return empty array if no suggestions

Add a helper `datesOverlap(start1, end1, start2, end2)` as a private function (not exported). Use `new Date().getTime()` for comparisons.

Add `InitiativeForOverlap` interface (exported) for the input type:
```typescript
export interface InitiativeForOverlap {
  id: string
  personInCharge: string | null
  startDate: string | Date
  endDate: string | Date
  status: string
}
```

Do NOT add any new npm dependencies. Use existing date-fns imports already in the file.
  </action>
  <verify>
Run `npx tsc --noEmit` to verify no type errors. Confirm the file exports: `analyzeDates`, `detectOwnerOverlap`, `generateTimelineSuggestions`, `DateIntelligence`, `DateFlag`, `InitiativeForOverlap`.
  </verify>
  <done>
`analyzeDates()` returns `daysOverdue` field, `detectOwnerOverlap()` returns Map of initiative IDs to concurrent counts, `generateTimelineSuggestions()` returns array of suggestion strings. All type-check cleanly.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create DateBadges component and integrate into hierarchy</name>
  <files>
    src/components/objectives/date-badges.tsx
    src/components/objectives/initiative-row.tsx
    src/components/objectives/objective-hierarchy.tsx
    src/components/objectives/objective-group.tsx
    src/components/objectives/key-result-group.tsx
  </files>
  <action>
**Create `src/components/objectives/date-badges.tsx`:**

A 'use client' component that renders color-coded inline badges for date intelligence flags plus an optional owner overlap badge. Follow the ConfidenceBadge pattern from `src/components/ai/confidence-badge.tsx`.

Props interface:
```typescript
interface DateBadgesProps {
  startDate: string
  endDate: string
  status: string
  overlapCount: number
}
```

Implementation:
1. Call `analyzeDates(startDate, endDate, status)` to get flags and intelligence data
2. Define `FLAG_CONFIG` mapping each `DateFlag` to:
   - `'overdue'`: red (`bg-red-100 text-red-700 border-red-200`), AlertTriangle icon, label: `${daysOverdue}d overdue`
   - `'ending-soon'`: orange (`bg-orange-100 text-orange-700 border-orange-200`), Clock icon, label: `Ends in ${daysUntilEnd}d`
   - `'late-start'`: yellow (`bg-yellow-100 text-yellow-700 border-yellow-200`), Clock icon, label: `Late start`
   - `'invalid-dates'`: red (`bg-red-100 text-red-700 border-red-200`), AlertCircle icon, label: `Invalid dates`
   - `'long-duration'`: gray (`bg-gray-100 text-gray-600 border-gray-200`), Info icon, label: `${durationDays}d span`
3. If `overlapCount > 3`, add an orange badge (`bg-orange-100 text-orange-700 border-orange-200`) with Users icon, label: `Workload: ${overlapCount} concurrent`
4. If no flags and no overlap warning, render nothing (return null)
5. Render as a flex-wrap container: `<div className="flex flex-wrap gap-1 mt-1">`
6. Each badge: `<Badge variant="outline" className={cn(flagColor, 'text-[11px] py-0 px-1.5 gap-1')}><Icon className="h-3 w-3" />{label}</Badge>`

Import icons from lucide-react: AlertTriangle, Clock, AlertCircle, Info, Users.
Import Badge from @/components/ui/badge, cn from @/lib/utils, analyzeDates + DateFlag from @/lib/initiative-date-utils.

**Modify `src/components/objectives/objective-hierarchy.tsx`:**

1. Add import: `import { useMemo } from 'react'` (add to existing useState import), `import { detectOwnerOverlap } from '@/lib/initiative-date-utils'`
2. Inside the component, compute overlap map once:
   ```typescript
   const overlapMap = useMemo(() => detectOwnerOverlap(initialData), [initialData])
   ```
3. Pass `overlapMap` to each `ObjectiveGroup`: `overlapMap={overlapMap}`
4. Also pass `overlapMap` to `InitiativeDetailSheet` is NOT needed (timeline suggestions will compute their own in Plan 02)

**Modify `src/components/objectives/objective-group.tsx`:**

1. Add `overlapMap: Map<string, number>` to `ObjectiveGroupProps` interface
2. Pass `overlapMap` through to each `KeyResultGroup`: `overlapMap={overlapMap}`

**Modify `src/components/objectives/key-result-group.tsx`:**

1. Add `overlapMap: Map<string, number>` to `KeyResultGroupProps` interface
2. Pass `overlapCount` to each `InitiativeRow`: `overlapCount={overlapMap.get(initiative.id) ?? 0}`

**Modify `src/components/objectives/initiative-row.tsx`:**

1. Add import: `import { DateBadges } from '@/components/objectives/date-badges'`
2. Add `overlapCount: number` to `InitiativeRowProps` interface
3. Insert `<DateBadges>` between the title `<p>` and the `<KpiProgressBar>`:
   ```tsx
   <DateBadges
     startDate={initiative.startDate}
     endDate={initiative.endDate}
     status={initiative.status}
     overlapCount={overlapCount}
   />
   ```

Do NOT use Tooltip components -- keep badges simple with just the text label. Tooltips add complexity (need TooltipProvider in tree) and the badge text is already descriptive enough.
  </action>
  <verify>
Run `npx tsc --noEmit` to verify no type errors. Run `npm run build` to verify the build succeeds. Visually confirm at `http://localhost:3000/objectives` that initiative rows show colored badges where applicable (overdue items have red badges, long-duration items have gray badges, etc.).
  </verify>
  <done>
DateBadges component renders inline color-coded badges per initiative row. Overdue shows red "Xd overdue", ending-soon shows orange "Ends in Xd", late-start shows yellow, invalid-dates shows red, long-duration shows gray, and owner overlap >3 shows orange workload badge. Badges wrap cleanly on mobile with flex-wrap. Completed/cancelled initiatives correctly skip overdue/ending-soon badges (handled by analyzeDates).
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` -- zero type errors
2. `npm run build` -- build succeeds
3. Navigate to `/objectives` -- initiative rows display date badges between title and KPI bar
4. Overdue initiatives have red "Xd overdue" badge
5. Initiatives ending within 14 days have orange "Ends in Xd" badge
6. NOT_STARTED initiatives past start date have yellow "Late start" badge
7. Initiatives with end < start show red "Invalid dates" badge
8. Initiatives spanning >180 days show gray "{X}d span" badge
9. Owners with >3 concurrent active initiatives show orange "Workload: X concurrent" badge
10. Completed/cancelled initiatives do NOT show overdue or ending-soon badges
11. Badges wrap cleanly on narrow screens (no horizontal overflow)
</verification>

<success_criteria>
- All 7 requirements DATE-01 through DATE-07 are satisfied
- Date badges render inline per initiative row in the By Objective view
- Owner overlap detection works client-side with no new API calls
- No new npm dependencies added
- Build passes, no type errors
</success_criteria>

<output>
After completion, create `.planning/phases/41-date-intelligence/41-01-SUMMARY.md`
</output>
