---
phase: 42-excel-export
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/initiative-export-utils.ts
  - src/app/api/initiatives/export/route.ts
  - src/components/initiatives/initiatives-list.tsx
autonomous: true

must_haves:
  truths:
    - "User clicks export button on initiatives list page and an .xlsx file downloads to their device"
    - "Downloaded file contains all 20 required columns with readable formatting (dates as '15 Jan 2026', status as 'In Progress', currency with 2 decimals)"
    - "File is named SAAP_Initiatives_YYYY-MM-DD.xlsx with today's date"
    - "Export includes all initiatives with correct linked project counts, revenue totals, cost totals, and KPI achievement percentages"
  artifacts:
    - path: "src/lib/initiative-export-utils.ts"
      provides: "Column definitions, row mapping function, workbook builder"
      exports: ["EXPORT_COLUMNS", "mapInitiativeToExportRow", "buildInitiativesWorkbook"]
    - path: "src/app/api/initiatives/export/route.ts"
      provides: "GET endpoint returning XLSX buffer as downloadable file"
      exports: ["GET"]
    - path: "src/components/initiatives/initiatives-list.tsx"
      provides: "Export button in toolbar with loading state"
      contains: "handleExport"
  key_links:
    - from: "src/components/initiatives/initiatives-list.tsx"
      to: "/api/initiatives/export"
      via: "fetch in handleExport"
      pattern: "fetch.*api/initiatives/export"
    - from: "src/app/api/initiatives/export/route.ts"
      to: "src/lib/initiative-export-utils.ts"
      via: "import mapInitiativeToExportRow, buildInitiativesWorkbook"
      pattern: "import.*initiative-export-utils"
    - from: "src/app/api/initiatives/export/route.ts"
      to: "prisma.initiative.findMany"
      via: "database query with projects relation"
      pattern: "prisma\\.initiative\\.findMany"
    - from: "src/lib/initiative-export-utils.ts"
      to: "src/lib/initiative-kpi-utils.ts"
      via: "import calculateKpi for achievement"
      pattern: "import.*calculateKpi.*initiative-kpi-utils"
---

<objective>
Create a single-click Excel export for all initiative data, generating a server-side XLSX file with all 20 required columns and proper formatting.

Purpose: Enables users to export initiative data for offline analysis, reporting, and sharing with stakeholders who don't have platform access.
Output: A new API route (`GET /api/initiatives/export`) and an export button on the initiatives list page.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/42-excel-export/42-RESEARCH.md
@src/lib/initiative-kpi-utils.ts
@src/lib/utils.ts
@src/app/(dashboard)/objectives/page.tsx
@src/components/initiatives/initiatives-list.tsx
@src/app/api/initiatives/route.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create export utility and API route</name>
  <files>
    src/lib/initiative-export-utils.ts
    src/app/api/initiatives/export/route.ts
  </files>
  <action>
Create `src/lib/initiative-export-utils.ts` with:

1. **EXPORT_COLUMNS** array defining all 20 columns with `key`, `header`, and `wch` (character width) values. Use exact column order from EXPORT-02: #, Objective, Key Result, Title, Department, Status, Owner, Start Date, End Date, Duration, KPI Label, KPI Target, KPI Actual, % Achievement, Linked Projects, Total Revenue, Total Costs, Monthly Objective, Weekly Tasks, Remarks.

2. **mapInitiativeToExportRow(initiative)** function that transforms a Prisma initiative record (with projects relation) into a flat object keyed by column headers. Must:
   - Convert Decimal fields with `Number()` (kpiTarget, kpiActual, revenue, cost amounts)
   - Format dates using `formatDate()` from `@/lib/utils` (produces "15 Jan 2026" format)
   - Format status/department/objective/owner using existing formatters from `@/lib/utils`
   - Compute duration in days using `differenceInDays` from `date-fns`
   - Compute KPI achievement using `calculateKpi` from `@/lib/initiative-kpi-utils` -- use `kpi.percentage` rounded to 1 decimal, null if no data
   - Compute linked projects count from `initiative.projects.length`
   - Compute totalRevenue as sum of `project.revenue` (Number, null as 0)
   - Compute totalCosts as sum of all `project.costs[].amount` (Number)
   - Use `null` for empty numeric fields (not 0) so Excel shows blank cells
   - Use `'-'` for empty string fields
   - Revenue/costs should be plain numbers with 2 decimal precision (use `Number(value.toFixed(2))`) -- NOT formatted with currency symbols, so Excel can do arithmetic

3. **buildInitiativesWorkbook(rows)** function that:
   - Creates a worksheet from rows using `XLSX.utils.json_to_sheet(rows, { header })` where header is the array of column header strings from EXPORT_COLUMNS
   - Sets `ws['!cols']` from EXPORT_COLUMNS wch values
   - Creates workbook, appends sheet named 'Initiatives'
   - Returns buffer via `XLSX.write(wb, { type: 'buffer', bookType: 'xlsx' })`
   - Import xlsx as `import * as XLSX from 'xlsx'`

Create `src/app/api/initiatives/export/route.ts` with:

1. **GET handler** that:
   - Calls `requireAuth()` from `@/lib/auth-utils` (same pattern as existing API routes)
   - Queries all initiatives using the EXACT Prisma select pattern from `src/app/(dashboard)/objectives/page.tsx` (lines 8-46), adding `monthlyObjective`, `weeklyTasks`, `remarks` to the select. Order by `objective asc, keyResult asc, sequenceNumber asc`.
   - Maps each initiative through `mapInitiativeToExportRow()`
   - Builds workbook via `buildInitiativesWorkbook(rows)`
   - Generates filename as `SAAP_Initiatives_${format(new Date(), 'yyyy-MM-dd')}.xlsx` using date-fns `format`
   - Returns `new Response(buf, { status: 200, headers: { 'Content-Disposition': attachment with filename, 'Content-Type': 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet', 'Content-Length': buf.length.toString() } })`
   - Wraps in try/catch, returns 500 JSON error on failure

IMPORTANT: Do NOT use the existing `GET /api/initiatives` endpoint -- it does NOT include the projects relation. The export route must have its own Prisma query with projects+costs included.
  </action>
  <verify>
Run `npx tsc --noEmit` to confirm no TypeScript errors. Then test the API route manually:
```bash
curl -s -o /tmp/test-export.xlsx -w "%{http_code}" http://localhost:3000/api/initiatives/export
```
Verify it returns 200 (or 401 if auth required -- both confirm the route exists and compiles).
  </verify>
  <done>
Export utility module exists with EXPORT_COLUMNS, mapInitiativeToExportRow, and buildInitiativesWorkbook exports. API route at GET /api/initiatives/export compiles and returns XLSX buffer with correct Content-Type and Content-Disposition headers.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add export button to initiatives list toolbar</name>
  <files>
    src/components/initiatives/initiatives-list.tsx
  </files>
  <action>
Modify `src/components/initiatives/initiatives-list.tsx` to add an export button:

1. Add `Download` and `Loader2` to the lucide-react imports (alongside existing `Plus, Search, Filter, Eye, MoreHorizontal`)

2. Add `isExporting` state: `const [isExporting, setIsExporting] = useState(false)`

3. Add `handleExport` async function:
   - Sets `isExporting` to true
   - Fetches `/api/initiatives/export` with no special headers
   - If response is not ok, logs error and returns (with finally setting isExporting false)
   - Gets blob from response
   - Creates object URL, creates an anchor element, sets href to object URL
   - Extracts filename from Content-Disposition header: `response.headers.get('content-disposition')?.match(/filename="(.+)"/)?.[1] || 'export.xlsx'`
   - Sets `a.download` to filename, calls `a.click()`, revokes object URL
   - Wraps in try/catch/finally (finally sets isExporting false)

4. Add export button in the toolbar, placed BEFORE the "Add Initiative" dialog (between the filter selects and the create dialog). Use this structure:
   ```tsx
   <Button
     variant="outline"
     onClick={handleExport}
     disabled={isExporting}
     className="w-full sm:w-auto"
   >
     {isExporting ? (
       <Loader2 className="mr-2 h-4 w-4 animate-spin" />
     ) : (
       <Download className="mr-2 h-4 w-4" />
     )}
     Export
   </Button>
   ```

5. Wrap the export button and the existing Add Initiative dialog in a flex container so they sit side by side on desktop and stack on mobile:
   ```tsx
   <div className="flex flex-col sm:flex-row gap-2 sm:gap-2 w-full sm:w-auto">
     {/* Export button */}
     {/* Existing Dialog for Add Initiative */}
   </div>
   ```

This keeps the toolbar layout consistent with the existing responsive design.
  </action>
  <verify>
Run `npx tsc --noEmit` to confirm no TypeScript errors. Open http://localhost:3000/initiatives in browser -- verify the Export button appears in the toolbar next to "Add Initiative", shows a download icon, and clicking it triggers a file download of an .xlsx file named with today's date.
  </verify>
  <done>
Export button visible in initiatives list toolbar. Clicking it downloads SAAP_Initiatives_YYYY-MM-DD.xlsx. Button shows loading spinner during export. File opens in Excel/Numbers with all 20 columns, readable dates, formatted status values, and numeric currency fields.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with no errors
2. Navigate to /initiatives page -- Export button visible alongside Add Initiative
3. Click Export -- spinner shows briefly, then .xlsx file downloads
4. Open downloaded file -- verify:
   - Filename is SAAP_Initiatives_YYYY-MM-DD.xlsx with today's date
   - 20 columns present in correct order (#, Objective, Key Result, Title, Department, Status, Owner, Start Date, End Date, Duration, KPI Label, KPI Target, KPI Actual, % Achievement, Linked Projects, Total Revenue, Total Costs, Monthly Objective, Weekly Tasks, Remarks)
   - Dates show as "15 Jan 2026" format (not ISO strings)
   - Status shows "In Progress" (not IN_PROGRESS)
   - Department shows "Biz Dev" (not BIZ_DEV)
   - Revenue/costs are plain numbers suitable for Excel arithmetic
   - Column widths are reasonable (not all narrow)
   - All initiatives present (not just filtered subset)
</verification>

<success_criteria>
- EXPORT-01: Single-click export from initiatives page produces .xlsx download
- EXPORT-02: All 20 columns present with correct data
- EXPORT-03: File named SAAP_Initiatives_YYYY-MM-DD.xlsx
- EXPORT-04: Generated server-side via API route
- EXPORT-05: Dates, status, currency all formatted for readability
</success_criteria>

<output>
After completion, create `.planning/phases/42-excel-export/42-01-SUMMARY.md`
</output>
