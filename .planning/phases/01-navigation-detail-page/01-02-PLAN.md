---
phase: 01-navigation-detail-page
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/app/(dashboard)/initiatives/[id]/page.tsx
  - src/components/initiatives/initiative-detail.tsx
autonomous: true

must_haves:
  truths:
    - "User can access /initiatives/[id] and see full initiative details"
    - "User can change status and person in charge inline"
    - "User can view existing comments on the detail page"
    - "User can add new comments with author selection"
  artifacts:
    - path: "src/app/(dashboard)/initiatives/[id]/page.tsx"
      provides: "Server Component page for initiative detail"
      exports: ["default"]
      contains: "notFound"
    - path: "src/components/initiatives/initiative-detail.tsx"
      provides: "Client Component with inline editing and comments"
      contains: "'use client'"
      min_lines: 150
  key_links:
    - from: "src/app/(dashboard)/initiatives/[id]/page.tsx"
      to: "prisma.initiative.findUnique"
      via: "direct Prisma query"
      pattern: "prisma\\.initiative\\.findUnique"
    - from: "src/components/initiatives/initiative-detail.tsx"
      to: "/api/initiatives/[id]"
      via: "fetch for PATCH updates"
      pattern: "fetch.*api/initiatives"
    - from: "src/components/initiatives/initiative-detail.tsx"
      to: "/api/initiatives/[id]/comments"
      via: "fetch for comment operations"
      pattern: "api/initiatives.*comments"
---

<objective>
Create the initiative detail page with inline editing and comments.

Purpose: Users clicking initiative links currently get 404. This plan builds the destination page where users view full details, edit fields inline, and manage comments.

Output: Working `/initiatives/[id]` route with full initiative details, inline status/owner editing, and comments section.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-navigation-detail-page/01-RESEARCH.md

@src/components/kanban/initiative-detail-sheet.tsx
@src/app/(dashboard)/initiatives/page.tsx
@src/app/api/initiatives/[id]/route.ts
@src/app/api/initiatives/[id]/comments/route.ts
@src/lib/utils.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create initiative detail page (Server Component)</name>
  <files>src/app/(dashboard)/initiatives/[id]/page.tsx</files>
  <action>
    Create `src/app/(dashboard)/initiatives/[id]/page.tsx` as Server Component:

    1. Add `export const dynamic = 'force-dynamic'` to disable caching
    2. Create `getInitiative(id: string)` async function that:
       - Queries `prisma.initiative.findUnique({ where: { id }, include: { comments: { orderBy: { createdAt: 'desc' } } } })`
       - Returns null if not found
       - Serializes Date fields to ISO strings (startDate, endDate, createdAt, updatedAt)
       - Serializes Decimal fields to numbers (resourcesFinancial)
       - Serializes comment dates

    3. Create default async page component:
       - Extract `id` from `params` (params is Promise in Next.js 15: `const { id } = await params`)
       - Call getInitiative(id)
       - If null, call `notFound()` from 'next/navigation'
       - Otherwise render `<InitiativeDetail initiative={initiative} />`

    Follow exact pattern from `src/app/(dashboard)/kanban/page.tsx` for data fetching.
    Follow exact pattern from `src/app/(dashboard)/initiatives/page.tsx` for serialization.
  </action>
  <verify>
    File exists at src/app/(dashboard)/initiatives/[id]/page.tsx
    Contains 'force-dynamic'
    Contains 'notFound'
    Contains 'prisma.initiative.findUnique'
    `npm run build` passes
  </verify>
  <done>Server Component page fetches initiative by ID, handles not-found, passes to client component.</done>
</task>

<task type="auto">
  <name>Task 2: Create initiative detail component (Client Component)</name>
  <files>src/components/initiatives/initiative-detail.tsx</files>
  <action>
    Create `src/components/initiatives/initiative-detail.tsx` as Client Component.

    **Adapt patterns from `initiative-detail-sheet.tsx` but for a full page:**

    1. **Props interface:** Accept `initiative` with all fields including comments array

    2. **State management:**
       - `status` - current status value (initialized from prop)
       - `personInCharge` - current owner (initialized from prop)
       - `remarks` - current remarks text (initialized from prop, editable)
       - `comments` - array of comments (initialized from prop)
       - `newComment` - text for new comment input
       - `commentAuthor` - selected author for new comment (default 'KHAIRUL')
       - `isSaving` - loading state for save
       - `isSubmittingComment` - loading state for comment submission
       - `hasChanges` - derived from comparing state to initial props

    3. **Layout structure (use Card for sections):**
       - **Header:** Back button (router.back() with fallback to /initiatives), title, sequence number badge
       - **Details Card:** 2-column grid showing:
         - Status (Select, editable)
         - Person In Charge (Select, editable)
         - Department (read-only badge)
         - Start Date (read-only)
         - End Date (read-only)
         - Key Result (read-only badge)
       - **Remarks Card:** Textarea for remarks (editable)
       - **Save Button:** Only visible when hasChanges is true
       - **Comments Card:** Full comments section (list + add new)

    4. **Save handler:** PATCH to `/api/initiatives/${initiative.id}` with { status, personInCharge, remarks }. Update local state on success.

    5. **Comment handlers:** Copy from initiative-detail-sheet.tsx:
       - `handleSubmitComment` - POST to /api/initiatives/[id]/comments
       - `handleDeleteComment` - DELETE to /api/initiatives/[id]/comments
       - `formatCommentTime` - relative time display

    6. **Imports needed:**
       - 'use client' directive
       - useState from 'react'
       - useRouter from 'next/navigation'
       - Card, CardContent, CardHeader, CardTitle from @/components/ui/card
       - Button, Badge, Select, Textarea, Avatar, Separator, ScrollArea from ui
       - Utilities: cn, formatDate, formatDepartment, formatTeamMember, getStatusColor, STATUS_OPTIONS, TEAM_MEMBER_OPTIONS from @/lib/utils
       - Icons: ArrowLeft, Calendar, User, Building2, Target, Send, Loader2, MessageSquare, Clock, Trash2, FileText from lucide-react

    **DO NOT:**
    - Create a separate edit route
    - Use modals for editing
    - Refresh the page after save (use local state updates)
  </action>
  <verify>
    File exists at src/components/initiatives/initiative-detail.tsx
    Contains 'use client'
    Contains Select components for status and personInCharge
    Contains comments section with add/delete
    Contains PATCH fetch to /api/initiatives
    `npm run build` passes
  </verify>
  <done>Client Component renders full initiative detail with inline editing for status, person in charge, and remarks; plus full comments functionality.</done>
</task>

<task type="auto">
  <name>Task 3: Verify end-to-end flow</name>
  <files></files>
  <action>
    Start dev server and verify the complete flow:

    1. Run `npm run dev`
    2. Navigate to /initiatives
    3. Click View (Eye) button on any initiative
    4. Confirm page loads at /initiatives/[id] without errors
    5. Verify all fields display correctly
    6. Change status dropdown - Save button should appear
    7. Click Save - should succeed (check Network tab)
    8. Add a comment - should appear in list
    9. Click Back - should return to /initiatives

    Also test edge case:
    - Navigate to /initiatives/nonexistent-id - should show 404 page
  </action>
  <verify>
    Dev server runs without errors
    /initiatives/[id] loads with correct data
    Status change + save works (API returns 200)
    Comment add works (new comment appears)
    Invalid ID shows 404 not found page
  </verify>
  <done>Full initiative detail flow working: view, edit, save, comments, navigation.</done>
</task>

</tasks>

<verification>
1. `npm run build` passes without errors
2. `npm run lint` passes without warnings
3. Navigate to /initiatives/[valid-id] - page renders with all details
4. Change status, save - API call succeeds
5. Add comment - comment appears in list
6. Navigate to /initiatives/invalid-id - 404 page shown
7. Back button navigates correctly
</verification>

<success_criteria>
- Build and lint pass
- /initiatives/[id] route resolves to detail page
- Initiative details display correctly (title, status, dates, department, etc.)
- Status and Person In Charge are editable via dropdowns
- Remarks are editable via textarea
- Save button only appears when changes exist
- Comments list shows existing comments
- New comments can be added with author selection
- Comments can be deleted
- Invalid IDs show 404 page
- Back navigation works
</success_criteria>

<output>
After completion, create `.planning/phases/01-navigation-detail-page/01-02-SUMMARY.md`
</output>
