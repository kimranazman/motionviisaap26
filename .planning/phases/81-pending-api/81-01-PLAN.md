# Plan 81-01: Enhance Pending API with Granular Counts

## Metadata
- **Wave:** 1
- **Depends on:** None
- **Files modified:** `src/app/api/ai/pending/route.ts`
- **Autonomous:** Yes

## Context

The `/api/ai/pending` endpoint currently returns total pending document count and project-level summaries. Phase 81 requires extending this to return granular counts by type (costs, invoices, receipts, deliverables) for the UI badge dropdown.

## Tasks

<task id="1">
**Add interface for granular counts response**

Add a new interface above the existing interfaces:

```typescript
interface PendingCounts {
  costs: number
  invoices: number
  receipts: number
  deliverables: number
  total: number
}
```

Update the PendingDocumentsResponse interface to include the new counts:

```typescript
interface PendingDocumentsResponse {
  // New granular counts
  costs: number
  invoices: number
  receipts: number
  deliverables: number
  total: number
  // Existing fields (backward compatibility)
  totalPending: number
  projects: ProjectPendingSummary[]
  claudeCommand: string
}
```
</task>

<task id="2">
**Add parallel count queries**

Inside the GET handler, before the existing pendingDocuments query, add parallel count queries using Promise.all:

```typescript
// Query all counts in parallel
const [costsCount, invoicesCount, receiptsCount, deliverablesCount] = await Promise.all([
  // Costs with supplier but no normalizedItem
  prisma.cost.count({
    where: {
      supplierId: { not: null },
      normalizedItem: null
    }
  }),
  // Pending invoices
  prisma.document.count({
    where: {
      category: 'INVOICE',
      aiStatus: 'PENDING'
    }
  }),
  // Pending receipts
  prisma.document.count({
    where: {
      category: 'RECEIPT',
      aiStatus: 'PENDING'
    }
  }),
  // Projects with invoices but no aiExtracted deliverables
  prisma.project.count({
    where: {
      documents: {
        some: {
          category: 'INVOICE'
        }
      },
      deliverables: {
        none: {
          aiExtracted: true
        }
      }
    }
  })
])

const total = costsCount + invoicesCount + receiptsCount + deliverablesCount
```
</task>

<task id="3">
**Update response object**

Modify the response object to include the new counts at the top level:

```typescript
const response: PendingDocumentsResponse = {
  // New granular counts
  costs: costsCount,
  invoices: invoicesCount,
  receipts: receiptsCount,
  deliverables: deliverablesCount,
  total,
  // Existing fields
  totalPending,
  projects,
  claudeCommand,
}
```
</task>

## Verification

- [ ] TypeScript compiles without errors
- [ ] API returns costs count (costs with supplierId but no normalizedItem)
- [ ] API returns invoices count (documents with category=INVOICE, aiStatus=PENDING)
- [ ] API returns receipts count (documents with category=RECEIPT, aiStatus=PENDING)
- [ ] API returns deliverables count (projects with invoices but no aiExtracted deliverables)
- [ ] API returns total as sum of all counts
- [ ] Existing fields (totalPending, projects, claudeCommand) still present

## Must Haves

- [ ] Response includes `{ costs, invoices, receipts, deliverables, total }` structure
- [ ] Costs count: costs with supplierId but no normalizedItem
- [ ] Invoices count: documents with category INVOICE and aiStatus PENDING
- [ ] Receipts count: documents with category RECEIPT and aiStatus PENDING
- [ ] Deliverables count: projects with invoices but no aiExtracted deliverables
- [ ] Total is sum of all counts
