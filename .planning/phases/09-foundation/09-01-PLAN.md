---
phase: 09-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - prisma/schema.prisma
  - prisma/seed-cost-categories.ts
  - package.json
autonomous: true

must_haves:
  truths:
    - "Prisma schema includes Company, Contact, Deal, PotentialProject, Project, Cost, CostCategory models"
    - "DealStage, PotentialStage, ProjectStatus enums exist with correct values"
    - "All currency fields use Decimal(12,2)"
    - "Database migration runs without errors"
    - "CostCategory table seeded with 6 categories"
  artifacts:
    - path: "prisma/schema.prisma"
      provides: "CRM and project financials data models"
      contains: "model Company"
    - path: "prisma/seed-cost-categories.ts"
      provides: "Idempotent seed script for cost categories"
      exports: "main function"
  key_links:
    - from: "prisma/schema.prisma"
      to: "database"
      via: "prisma db push"
      pattern: "model (Company|Contact|Deal|PotentialProject|Project|Cost|CostCategory)"
    - from: "prisma/schema.prisma"
      to: "Initiative model"
      via: "projects relation"
      pattern: "projects.*Project\\[\\]"
---

<objective>
Add CRM and project financials schema to database

Purpose: Establish data foundation for v1.2 milestone - all subsequent phases depend on these models
Output: Database with Company, Contact, Deal, PotentialProject, Project, Cost, CostCategory tables and seeded categories
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-foundation/09-RESEARCH.md

@prisma/schema.prisma
@prisma/seed.ts
@package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update Prisma schema with CRM models</name>
  <files>prisma/schema.prisma</files>
  <action>
Add the following to prisma/schema.prisma after the existing models:

1. Add enums (after existing enums, before models):
   - DealStage: LEAD, QUALIFIED, PROPOSAL, NEGOTIATION, WON, LOST
   - PotentialStage: POTENTIAL, CONFIRMED, CANCELLED
   - ProjectStatus: DRAFT, ACTIVE, COMPLETED, CANCELLED

2. Add models (add a comment section header "CRM & Project Financials Models (v1.2)"):
   - Company: id (cuid), name (VarChar 255), industry (VarChar 100, optional), notes (Text, optional), relations to contacts/deals/potentials/projects, timestamps, @@index([name]), @@map("companies")
   - Contact: id (cuid), companyId (required, cascade delete), name (VarChar 255), email (VarChar 255, optional), phone (VarChar 50, optional), role (VarChar 100, optional), relations to deals/potentials/projects, timestamps, @@index([companyId]), @@map("contacts")
   - Deal: id (cuid), title (VarChar 255), description (Text, optional), value (Decimal 12,2, optional), stage (DealStage default LEAD), stageChangedAt (DateTime default now), lostReason (Text, optional), companyId (required), contactId (optional), projectId (unique, optional for "DealToProject" relation), position (Int default 0), timestamps, @@index([companyId, contactId, stage]), @@map("deals")
   - PotentialProject: id (cuid), title (VarChar 255), description (Text, optional), estimatedValue (Decimal 12,2, optional), stage (PotentialStage default POTENTIAL), stageChangedAt, companyId (required), contactId (optional), projectId (unique, optional for "PotentialToProject" relation), position (Int default 0), timestamps, @@index([companyId, contactId, stage]), @@map("potential_projects")
   - Project: id (cuid), title (VarChar 255), description (Text, optional), revenue (Decimal 12,2, optional), status (ProjectStatus default DRAFT), companyId (required), contactId (optional), sourceDeal (inverse of Deal.project), sourcePotential (inverse of PotentialProject.project), initiativeId (optional, relation to Initiative), costs relation, timestamps, @@index([companyId, contactId, initiativeId, status]), @@map("projects")
   - CostCategory: id (cuid), name (VarChar 50, unique), description (VarChar 255, optional), sortOrder (Int default 0), isActive (Boolean default true), costs relation, timestamps, @@map("cost_categories")
   - Cost: id (cuid), description (VarChar 500), amount (Decimal 12,2, required), date (DateTime default now), projectId (required, cascade delete), categoryId (required), receiptPath (VarChar 500, optional), timestamps, @@index([projectId, categoryId, date]), @@map("costs")

3. Update existing Initiative model: Add `projects Project[]` relation field

Use relation names "DealToProject" and "PotentialToProject" to disambiguate bidirectional relations.
Use @map for snake_case column names on multi-word fields (e.g., company_id, stage_changed_at).
Follow existing schema conventions (cuid IDs, timestamps, explicit indexes).
  </action>
  <verify>Run `npx prisma validate` - should show "The schema at prisma/schema.prisma is valid"</verify>
  <done>Schema file contains all 7 new models with correct field types, relations, and indexes</done>
</task>

<task type="auto">
  <name>Task 2: Run database migration</name>
  <files>None (database operation)</files>
  <action>
Run Prisma migration to sync schema with database:

1. Run `npx prisma db push` to push schema changes to MariaDB
2. Run `npx prisma generate` to regenerate Prisma client with new types

This uses db push (not migrate) because this is a development environment and db push is already established as the workflow in this project (see package.json scripts).

Expected: Creates tables companies, contacts, deals, potential_projects, projects, cost_categories, costs with all columns and indexes. Adds projects column to initiatives table.
  </action>
  <verify>
Run `npx prisma db push` - should complete without errors.
Run `npx prisma studio` briefly to confirm tables exist (or just check output shows table creation).
  </verify>
  <done>Database contains all new tables: companies, contacts, deals, potential_projects, projects, cost_categories, costs</done>
</task>

<task type="auto">
  <name>Task 3: Create and run CostCategory seed</name>
  <files>prisma/seed-cost-categories.ts, package.json</files>
  <action>
1. Create prisma/seed-cost-categories.ts with idempotent seeding:
   - Import PrismaClient
   - Define categories array: Labor (sort 1), Materials (sort 2), Vendors (sort 3), Travel (sort 4), Software (sort 5), Other (sort 6)
   - Each category has: name, description, sortOrder
   - Use upsert with where: { name } to make idempotent (can run multiple times safely)
   - Log each upsert and final count
   - Include proper error handling and disconnect

2. Add npm script to package.json:
   ```
   "db:seed:categories": "npx tsx prisma/seed-cost-categories.ts"
   ```
   (Use tsx like db:seed:admin script for consistency)

3. Run the seed: `npm run db:seed:categories`

Categories to seed:
| Name | Description | Sort Order |
|------|-------------|------------|
| Labor | Internal staff costs | 1 |
| Materials | Physical materials and supplies | 2 |
| Vendors | Third-party contractor/vendor costs | 3 |
| Travel | Transportation and accommodation | 4 |
| Software | Software licenses and subscriptions | 5 |
| Other | Miscellaneous costs | 6 |
  </action>
  <verify>
Run `npm run db:seed:categories` - should output "Total cost categories: 6"
Run seed again - should complete without errors (idempotent)
  </verify>
  <done>CostCategory table contains 6 seeded categories with correct names, descriptions, and sort order</done>
</task>

</tasks>

<verification>
After all tasks complete:

1. Schema validation: `npx prisma validate` passes
2. Database state: `npx prisma db push` reports no changes needed (already applied)
3. Seed idempotency: `npm run db:seed:categories` can run twice without errors
4. Type generation: Import statements in existing code still work (no breaking changes)

Quick verification query (run via Prisma Studio or direct DB):
- Check cost_categories table has 6 rows
- Check all new tables exist with expected columns
</verification>

<success_criteria>
- Prisma schema includes Company, Contact, Deal, PotentialProject, Project, Cost, CostCategory models
- DealStage enum has: LEAD, QUALIFIED, PROPOSAL, NEGOTIATION, WON, LOST
- PotentialStage enum has: POTENTIAL, CONFIRMED, CANCELLED
- ProjectStatus enum has: DRAFT, ACTIVE, COMPLETED, CANCELLED
- All Decimal fields use @db.Decimal(12, 2)
- Initiative model has projects relation
- Database migration runs without errors
- CostCategory seeded with 6 categories (Labor, Materials, Vendors, Travel, Software, Other)
- Seed script is idempotent (can run multiple times)
</success_criteria>

<output>
After completion, create `.planning/phases/09-foundation/09-01-SUMMARY.md`
</output>
