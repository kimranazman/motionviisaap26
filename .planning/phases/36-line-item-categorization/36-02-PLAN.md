---
phase: 36-line-item-categorization
plan: 02
type: execute
wave: 2
depends_on: ["36-01"]
files_modified:
  - src/app/api/supplier-items/route.ts
  - src/app/(dashboard)/supplier-items/page.tsx
  - src/components/supplier-items/supplier-items-table.tsx
  - src/components/supplier-items/normalized-item-edit.tsx
  - src/components/layout/sidebar.tsx
autonomous: true

must_haves:
  truths:
    - "User can view table of all line items across all suppliers"
    - "Table shows: item description, normalizedItem, supplier, unit price, project"
    - "User can filter table by normalizedItem (category)"
    - "User can filter table by supplier"
    - "User can sort table by price to compare"
    - "User can inline edit normalizedItem in the table"
  artifacts:
    - path: "src/app/api/supplier-items/route.ts"
      provides: "GET endpoint returning costs with suppliers and filter options"
      exports: ["GET"]
    - path: "src/app/(dashboard)/supplier-items/page.tsx"
      provides: "Server component page for supplier items table"
      min_lines: 20
    - path: "src/components/supplier-items/supplier-items-table.tsx"
      provides: "Client component with filters, sorting, and inline edit"
      min_lines: 100
    - path: "src/components/supplier-items/normalized-item-edit.tsx"
      provides: "Inline edit component for normalizedItem cell"
      min_lines: 40
  key_links:
    - from: "src/app/(dashboard)/supplier-items/page.tsx"
      to: "/api/supplier-items"
      via: "server-side fetch"
      pattern: "fetch.*api/supplier-items"
    - from: "src/components/supplier-items/supplier-items-table.tsx"
      to: "src/components/supplier-items/normalized-item-edit.tsx"
      via: "inline edit in table cell"
      pattern: "NormalizedItemEdit"
    - from: "src/components/supplier-items/normalized-item-edit.tsx"
      to: "/api/costs/[id]/normalize"
      via: "PATCH on save"
      pattern: "api/costs.*normalize"
    - from: "src/components/layout/sidebar.tsx"
      to: "/supplier-items"
      via: "navigation link"
      pattern: "href=\"/supplier-items\""
---

<objective>
Create supplier items table page with filtering by category and supplier, and price sorting.

Purpose: Allow users to compare prices across suppliers by filtering all costs with suppliers in a single table. Users filter by normalizedItem to see all suppliers offering the same item.

Output: /supplier-items page with filterable table, inline edit for normalizedItem, sidebar navigation link.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/36-line-item-categorization/36-RESEARCH.md
@.planning/phases/36-line-item-categorization/36-01-SUMMARY.md

# Pattern references
@src/components/suppliers/supplier-list.tsx
@src/components/layout/sidebar.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create supplier-items API endpoint</name>
  <files>
    - src/app/api/supplier-items/route.ts
  </files>
  <action>
1. Create directory: src/app/api/supplier-items/

2. Create src/app/api/supplier-items/route.ts:
   - Import NextRequest, NextResponse from 'next/server'
   - Import prisma from '@/lib/prisma'
   - Import requireAuth from '@/lib/auth-utils'

3. Export GET handler:
   ```typescript
   export async function GET(request: NextRequest) {
     const { error } = await requireAuth()
     if (error) return error

     try {
       const searchParams = request.nextUrl.searchParams
       const categoryFilter = searchParams.get('category')
       const supplierFilter = searchParams.get('supplier')

       // Build where clause - only costs with suppliers
       const where: Record<string, unknown> = {
         supplierId: { not: null },
       }

       if (categoryFilter) {
         where.normalizedItem = categoryFilter
       }

       if (supplierFilter) {
         where.supplierId = supplierFilter
       }

       // Fetch costs with suppliers
       const costs = await prisma.cost.findMany({
         where,
         select: {
           id: true,
           description: true,
           normalizedItem: true,
           amount: true,
           date: true,
           supplier: { select: { id: true, name: true } },
           project: { select: { id: true, title: true } },
         },
         orderBy: { date: 'desc' },
       })

       // Get unique categories and suppliers for filter dropdowns
       const [categories, suppliers] = await Promise.all([
         prisma.cost.groupBy({
           by: ['normalizedItem'],
           where: {
             supplierId: { not: null },
             normalizedItem: { not: null },
           },
         }),
         prisma.supplier.findMany({
           select: { id: true, name: true },
           orderBy: { name: 'asc' },
         }),
       ])

       // Serialize costs (convert Decimal to Number)
       const serializedCosts = costs.map(cost => ({
         ...cost,
         amount: Number(cost.amount),
       }))

       return NextResponse.json({
         items: serializedCosts,
         categories: categories
           .map(c => c.normalizedItem)
           .filter((c): c is string => c !== null)
           .sort(),
         suppliers,
       })
     } catch (error) {
       console.error('Error fetching supplier items:', error)
       return NextResponse.json(
         { error: 'Failed to fetch supplier items' },
         { status: 500 }
       )
     }
   }
   ```
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - GET /api/supplier-items returns { items, categories, suppliers }
    - Query params ?category= and ?supplier= filter correctly
  </verify>
  <done>
    - GET /api/supplier-items endpoint exists
    - Returns items (costs with suppliers), categories (unique normalizedItem values), suppliers list
    - Supports category and supplier query param filters
  </done>
</task>

<task type="auto">
  <name>Task 2: Create supplier items table component with inline edit</name>
  <files>
    - src/components/supplier-items/supplier-items-table.tsx
    - src/components/supplier-items/normalized-item-edit.tsx
  </files>
  <action>
1. Create directory: src/components/supplier-items/

2. Create src/components/supplier-items/normalized-item-edit.tsx:
   - 'use client' directive
   - Import useState from 'react'
   - Import Input, Button from shadcn/ui
   - Import Check, X, Pencil from lucide-react
   - Props: costId: string, value: string | null, onUpdate: (newValue: string) => void
   - State: isEditing, editValue, isSaving
   - On edit click: show input with current value
   - On save: PATCH /api/costs/{costId}/normalize with { normalizedItem: editValue.trim() }
   - On success: call onUpdate(editValue.trim()), setIsEditing(false)
   - Display: show value with hover pencil icon, or input with check/x buttons when editing

3. Create src/components/supplier-items/supplier-items-table.tsx:
   - 'use client' directive
   - Import useState, useMemo from 'react'
   - Import Table components from shadcn/ui
   - Import Select components from shadcn/ui
   - Import Input, Button from shadcn/ui
   - Import ArrowUpDown, Search from lucide-react
   - Import formatCurrency from '@/lib/utils' (if exists, or format inline)
   - Import NormalizedItemEdit from './normalized-item-edit'

4. Define interfaces:
   ```typescript
   interface SupplierItem {
     id: string
     description: string
     normalizedItem: string | null
     amount: number
     date: string
     supplier: { id: string; name: string } | null
     project: { id: string; title: string } | null
   }

   interface SupplierItemsTableProps {
     initialItems: SupplierItem[]
     categories: string[]
     suppliers: { id: string; name: string }[]
   }
   ```

5. Component state:
   - items: SupplierItem[] (local copy for optimistic updates)
   - categoryFilter: string | null
   - supplierFilter: string | null
   - sortDirection: 'asc' | 'desc'
   - search: string

6. Filtered items with useMemo:
   - Filter by categoryFilter (exact match on normalizedItem)
   - Filter by supplierFilter (exact match on supplier.id)
   - Filter by search (description or normalizedItem includes search)
   - Sort by amount based on sortDirection

7. Render:
   - Toolbar with: Search input, Category select, Supplier select
   - Table with columns: Description, Category (with inline edit), Supplier, Price (with sort button), Project
   - Show count: "Showing X of Y items"
   - Empty state if no items

8. Handle normalizedItem update:
   ```typescript
   const handleNormalizedItemUpdate = (costId: string, newValue: string) => {
     setItems(prev => prev.map(item =>
       item.id === costId ? { ...item, normalizedItem: newValue } : item
     ))
   }
   ```
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - Components render without errors
    - Filtering works for category and supplier
    - Price sorting toggles asc/desc
    - Inline edit calls API and updates UI
  </verify>
  <done>
    - NormalizedItemEdit component handles inline editing with API call
    - SupplierItemsTable shows all items with filters and sorting
    - Category filter shows unique normalizedItem values
    - Supplier filter shows all suppliers
    - Price column has sort toggle
    - Search filters by description and normalizedItem
  </done>
</task>

<task type="auto">
  <name>Task 3: Create supplier items page and add sidebar navigation</name>
  <files>
    - src/app/(dashboard)/supplier-items/page.tsx
    - src/components/layout/sidebar.tsx
  </files>
  <action>
1. Create directory: src/app/(dashboard)/supplier-items/

2. Create src/app/(dashboard)/supplier-items/page.tsx:
   ```typescript
   import { Metadata } from 'next'
   import { SupplierItemsTable } from '@/components/supplier-items/supplier-items-table'
   import { requireAuth } from '@/lib/auth-utils'
   import { redirect } from 'next/navigation'

   export const metadata: Metadata = {
     title: 'Supplier Items | SAAP 2026',
     description: 'Compare prices across suppliers',
   }

   async function getSupplierItems() {
     const baseUrl = process.env.NEXTAUTH_URL || 'http://localhost:3000'
     const response = await fetch(`${baseUrl}/api/supplier-items`, {
       cache: 'no-store',
       headers: {
         // Server-side fetch needs cookies forwarded for auth
         // Use internal prisma call instead
       },
     })
     // Actually, for server components, call prisma directly
   }

   export default async function SupplierItemsPage() {
     const session = await requireAuth()
     if (!session) {
       redirect('/login')
     }

     // Fetch data directly with prisma for server component
     const prisma = (await import('@/lib/prisma')).default

     const [costs, categories, suppliers] = await Promise.all([
       prisma.cost.findMany({
         where: { supplierId: { not: null } },
         select: {
           id: true,
           description: true,
           normalizedItem: true,
           amount: true,
           date: true,
           supplier: { select: { id: true, name: true } },
           project: { select: { id: true, title: true } },
         },
         orderBy: { date: 'desc' },
       }),
       prisma.cost.groupBy({
         by: ['normalizedItem'],
         where: {
           supplierId: { not: null },
           normalizedItem: { not: null },
         },
       }),
       prisma.supplier.findMany({
         select: { id: true, name: true },
         orderBy: { name: 'asc' },
       }),
     ])

     const serializedCosts = costs.map(cost => ({
       ...cost,
       amount: Number(cost.amount),
       date: cost.date.toISOString(),
     }))

     const categoryList = categories
       .map(c => c.normalizedItem)
       .filter((c): c is string => c !== null)
       .sort()

     return (
       <div className="space-y-6">
         <div>
           <h1 className="text-2xl font-semibold text-gray-900">
             Supplier Items
           </h1>
           <p className="text-gray-500 mt-1">
             Compare prices across suppliers by filtering items
           </p>
         </div>

         <SupplierItemsTable
           initialItems={serializedCosts}
           categories={categoryList}
           suppliers={suppliers}
         />
       </div>
     )
   }
   ```

3. Update src/components/layout/sidebar.tsx:
   - Import ShoppingBasket from lucide-react (or use existing Truck icon with different label)
   - Add link after Suppliers in CRM section:
   ```tsx
   <Link
     href="/supplier-items"
     className={cn(
       'flex items-center gap-3 rounded-lg px-3 py-2 text-sm font-medium transition-colors',
       pathname.startsWith('/supplier-items')
         ? 'bg-gray-100 text-gray-900'
         : 'text-gray-600 hover:bg-gray-50 hover:text-gray-900'
     )}
   >
     <ShoppingBasket className="h-5 w-5" />
     Price Comparison
   </Link>
   ```
   - Import ShoppingBasket at top with other icons

Note: Use getServerSession pattern if requireAuth doesn't work for server component. Check existing page patterns in codebase for correct auth approach.
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - Navigate to /supplier-items shows the table
    - Sidebar shows "Price Comparison" link under CRM section
    - Page requires authentication
    - Table shows costs with suppliers
  </verify>
  <done>
    - /supplier-items page exists and displays table
    - Sidebar has "Price Comparison" link
    - Page is server-rendered with initial data
    - Auth is enforced
  </done>
</task>

</tasks>

<verification>
After all tasks complete:
1. Navigate to /supplier-items - page loads with table
2. Table shows: Description, Category, Supplier, Price, Project columns
3. Category filter dropdown shows unique normalizedItem values
4. Supplier filter dropdown shows all suppliers
5. Price column sort toggles between asc/desc
6. Inline edit on Category column updates via API
7. Sidebar has "Price Comparison" link under CRM
8. TypeScript: `npx tsc --noEmit` passes
</verification>

<success_criteria>
- ITEM-05: User can view table of all line items across all suppliers - COMPLETE
- ITEM-06: Table shows: item description, normalizedItem, supplier, unit price, project - COMPLETE
- ITEM-07: User can filter table by normalizedItem (category) - COMPLETE
- ITEM-08: User can filter table by supplier - COMPLETE
- ITEM-09: User can sort table by price to compare - COMPLETE
</success_criteria>

<output>
After completion, create `.planning/phases/36-line-item-categorization/36-02-SUMMARY.md`
</output>
