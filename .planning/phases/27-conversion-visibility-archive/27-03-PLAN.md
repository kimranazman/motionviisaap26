---
phase: 27-conversion-visibility-archive
plan: 03
type: execute
wave: 2
depends_on: ["27-01"]
files_modified:
  - src/components/pipeline/pipeline-board.tsx
  - src/components/pipeline/deal-detail-sheet.tsx
  - src/components/potential-projects/potential-board.tsx
  - src/components/potential-projects/potential-detail-sheet.tsx
  - src/components/projects/project-list.tsx
  - src/components/projects/project-detail-sheet.tsx
  - src/app/(dashboard)/pipeline/page.tsx
  - src/app/(dashboard)/potential-projects/page.tsx
  - src/app/(dashboard)/projects/page.tsx
autonomous: true
must_haves:
  truths:
    - "User can archive deals, potentials, and projects"
    - "Archived items hidden from default views"
    - "User can toggle Show Archived to see archived items"
    - "User can unarchive items to restore them"
  artifacts:
    - path: "src/components/pipeline/pipeline-board.tsx"
      provides: "Show Archived toggle"
      contains: "showArchived"
    - path: "src/components/pipeline/deal-detail-sheet.tsx"
      provides: "Archive/Unarchive button"
      contains: "handleArchive"
    - path: "src/components/projects/project-list.tsx"
      provides: "Show Archived toggle"
      contains: "showArchived"
  key_links:
    - from: "src/components/pipeline/pipeline-board.tsx"
      to: "/api/deals?showArchived=true"
      via: "fetch with query param"
      pattern: "showArchived"
---

<objective>
Add archive system: toggle in list/board views, archive/unarchive buttons in detail sheets, proper filtering.

Purpose: Users can archive completed items and toggle visibility to reduce clutter (ARCH-01, ARCH-02, ARCH-03, ARCH-04).
Output: Archive toggle in headers, archive buttons in sheets, archived items filtered by default.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/27-conversion-visibility-archive/27-RESEARCH.md
@.planning/phases/27-conversion-visibility-archive/27-01-SUMMARY.md
@src/components/pipeline/pipeline-board.tsx
@src/components/pipeline/deal-detail-sheet.tsx
@src/components/potential-projects/potential-board.tsx
@src/components/potential-projects/potential-detail-sheet.tsx
@src/components/projects/project-list.tsx
@src/components/projects/project-detail-sheet.tsx
@src/app/(dashboard)/pipeline/page.tsx
@src/app/(dashboard)/potential-projects/page.tsx
@src/app/(dashboard)/projects/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add archive toggle and button to pipeline (deals)</name>
  <files>src/components/pipeline/pipeline-board.tsx, src/components/pipeline/deal-detail-sheet.tsx, src/app/(dashboard)/pipeline/page.tsx</files>
  <action>
Update Pipeline page (src/app/(dashboard)/pipeline/page.tsx) to accept showArchived query param and pass to PipelineBoard:
```typescript
export default async function PipelinePage({
  searchParams,
}: {
  searchParams: Promise<{ showArchived?: string }>
}) {
  const { showArchived } = await searchParams
  // ... existing code

  // Pass showArchived to API call or board component
  return (
    <PipelineBoard
      initialData={serializedDeals}
      initialShowArchived={showArchived === 'true'}
    />
  )
}
```

Update PipelineBoard to:
1. Accept initialShowArchived prop
2. Add showArchived state
3. Add toggle button in header
4. Filter deals client-side (initially) then refetch when toggled
5. Disable drag for archived items

```typescript
interface PipelineBoardProps {
  initialData: Deal[]
  initialShowArchived?: boolean
}

export function PipelineBoard({ initialData, initialShowArchived = false }: PipelineBoardProps) {
  const [showArchived, setShowArchived] = useState(initialShowArchived)
  // ... existing state

  // Toggle handler updates URL and refetches
  const handleToggleArchived = async () => {
    const newValue = !showArchived
    setShowArchived(newValue)

    // Update URL
    const url = new URL(window.location.href)
    if (newValue) {
      url.searchParams.set('showArchived', 'true')
    } else {
      url.searchParams.delete('showArchived')
    }
    window.history.replaceState({}, '', url)

    // Refetch data
    const response = await fetch(`/api/deals?showArchived=${newValue}`)
    if (response.ok) {
      const data = await response.json()
      setDeals(data)
    }
  }

  // In header (after Add Deal button):
  <Button
    variant={showArchived ? "secondary" : "ghost"}
    size="sm"
    onClick={handleToggleArchived}
  >
    <Archive className="h-4 w-4 mr-1" />
    {showArchived ? 'Showing Archived' : 'Show Archived'}
  </Button>
}
```

Update PipelineCard to show archived badge and disable drag:
```tsx
// In PipelineCard
{deal.isArchived && (
  <Badge variant="outline" className="bg-gray-100 text-gray-500 text-xs">
    Archived
  </Badge>
)}

// Disable drag for archived
<SortableItem disabled={!canEdit || deal.isArchived}>
```

Update DealDetailSheet to add Archive/Unarchive button in footer:
```tsx
import { Archive, ArchiveRestore } from 'lucide-react'

// Add state
const [isArchiving, setIsArchiving] = useState(false)

// Add handler
const handleArchive = async () => {
  if (!deal) return
  setIsArchiving(true)
  try {
    const response = await fetch(`/api/deals/${deal.id}`, {
      method: 'PATCH',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ isArchived: !deal.isArchived }),
    })
    if (response.ok) {
      const updated = await response.json()
      onUpdate(updated)
      toast.success(updated.isArchived ? 'Deal archived' : 'Deal unarchived')
    }
  } catch (err) {
    toast.error('Failed to update')
  } finally {
    setIsArchiving(false)
  }
}

// In footer, before Delete button:
<Button
  variant="outline"
  size="sm"
  onClick={handleArchive}
  disabled={isArchiving}
  className={deal.isArchived ? "text-blue-600" : "text-gray-600"}
>
  {deal.isArchived ? (
    <>
      <ArchiveRestore className="mr-2 h-4 w-4" />
      Unarchive
    </>
  ) : (
    <>
      <Archive className="mr-2 h-4 w-4" />
      Archive
    </>
  )}
</Button>
```

Import toast from sonner for feedback.
  </action>
  <verify>
Visit /pipeline - toggle should appear in header.
Click Show Archived - URL updates, archived deals appear.
Open deal detail - Archive button visible.
Click Archive - deal gets archived badge, toast shows success.
Click Unarchive - deal restored.
Archived deals cannot be dragged.
  </verify>
  <done>Pipeline has archive toggle and archive/unarchive functionality.</done>
</task>

<task type="auto">
  <name>Task 2: Add archive toggle and button to potential projects</name>
  <files>src/components/potential-projects/potential-board.tsx, src/components/potential-projects/potential-detail-sheet.tsx, src/app/(dashboard)/potential-projects/page.tsx</files>
  <action>
Apply same pattern as deals:

1. Update page.tsx to accept showArchived query param
2. Update PotentialBoard with showArchived state and toggle button
3. Update PotentialCard to show archived badge and disable drag
4. Update PotentialDetailSheet with Archive/Unarchive button

Use same patterns from Task 1, adapting for potential-projects API endpoint.
  </action>
  <verify>
Visit /potential-projects - toggle should appear in header.
Click Show Archived - URL updates, archived items appear.
Open potential detail - Archive button visible.
Archive/Unarchive works correctly.
  </verify>
  <done>Potential Projects has archive toggle and archive/unarchive functionality.</done>
</task>

<task type="auto">
  <name>Task 3: Add archive toggle and button to projects</name>
  <files>src/components/projects/project-list.tsx, src/components/projects/project-detail-sheet.tsx, src/app/(dashboard)/projects/page.tsx</files>
  <action>
Projects uses a list view, not kanban. Apply archive pattern:

1. Update page.tsx:
   - Accept showArchived and open query params
   - Filter projects by isArchived in the server query
   - Pass showArchived and openProjectId to ProjectList

```typescript
export default async function ProjectsPage({
  searchParams,
}: {
  searchParams: Promise<{ showArchived?: string; open?: string }>
}) {
  const { showArchived, open } = await searchParams

  const projects = await prisma.project.findMany({
    where: {
      ...(showArchived !== 'true' ? { isArchived: false } : {}),
    },
    // ... existing includes
  })

  return (
    <ProjectList
      initialData={serializedProjects}
      initialShowArchived={showArchived === 'true'}
      openProjectId={open}
    />
  )
}
```

2. Update ProjectList:
   - Accept initialShowArchived and openProjectId props
   - Add showArchived state and toggle button in header (next to status tabs)
   - Filter projects client-side when toggled
   - Auto-open project sheet if openProjectId provided

```typescript
interface ProjectListProps {
  initialData: Project[]
  initialShowArchived?: boolean
  openProjectId?: string
}

// In header, add toggle button after status tabs:
<Button
  variant={showArchived ? "secondary" : "ghost"}
  size="sm"
  onClick={handleToggleArchived}
>
  <Archive className="h-4 w-4 mr-1" />
  {showArchived ? 'Showing Archived' : 'Show Archived'}
</Button>
```

3. Update ProjectCard to show archived badge
4. Update ProjectDetailSheet with Archive/Unarchive button (same pattern as deals)

Also handle auto-opening project from URL:
```typescript
useEffect(() => {
  if (openProjectId) {
    const project = projects.find(p => p.id === openProjectId)
    if (project) {
      setSelectedProject(project)
      setIsDetailOpen(true)
    }
  }
}, [openProjectId])
```
  </action>
  <verify>
Visit /projects - toggle should appear in header.
Click Show Archived - archived projects appear.
Open project detail - Archive button visible.
Archive/Unarchive works correctly.
Visit /projects?open={id} - project detail opens automatically.
  </verify>
  <done>Projects has archive toggle, archive/unarchive functionality, and deep linking.</done>
</task>

</tasks>

<verification>
1. Pipeline: Archive toggle works, archived deals hidden by default, can archive/unarchive
2. Potential Projects: Archive toggle works, archived items hidden by default, can archive/unarchive
3. Projects: Archive toggle works, archived projects hidden by default, can archive/unarchive
4. Deep linking: /projects?open={id} opens project detail sheet
5. Toast notifications shown on archive/unarchive
6. Archived items show badge and cannot be dragged (kanban views)
</verification>

<success_criteria>
- [ ] ARCH-01: User can archive deals, potentials, and projects
- [ ] ARCH-02: Archived items hidden from default views
- [ ] ARCH-03: User can toggle "Show Archived" to see archived items
- [ ] ARCH-04: User can unarchive items
- [ ] Deep link to projects works (/projects?open={id})
- [ ] No TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/27-conversion-visibility-archive/27-03-SUMMARY.md`
</output>
