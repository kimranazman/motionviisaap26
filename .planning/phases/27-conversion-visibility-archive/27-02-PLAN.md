---
phase: 27-conversion-visibility-archive
plan: 02
type: execute
wave: 2
depends_on: ["27-01"]
files_modified:
  - src/components/pipeline/pipeline-card.tsx
  - src/components/pipeline/deal-detail-sheet.tsx
  - src/components/potential-projects/potential-card.tsx
  - src/components/potential-projects/potential-detail-sheet.tsx
autonomous: true
must_haves:
  truths:
    - "WON deal shows Converted to Project badge with project title"
    - "CONFIRMED potential shows Converted to Project badge with project title"
    - "User can click View Project to navigate to linked project"
    - "Converted deal/potential shows variance between estimate and actual revenue"
    - "Converted deal/potential is read-only (edit disabled)"
  artifacts:
    - path: "src/components/pipeline/pipeline-card.tsx"
      provides: "Conversion badge on WON deals"
      contains: "project"
    - path: "src/components/pipeline/deal-detail-sheet.tsx"
      provides: "View Project button, variance display, read-only mode"
      contains: "isConverted"
    - path: "src/components/potential-projects/potential-card.tsx"
      provides: "Conversion badge on CONFIRMED potentials"
      contains: "project"
    - path: "src/components/potential-projects/potential-detail-sheet.tsx"
      provides: "View Project button, variance display, read-only mode"
      contains: "isConverted"
  key_links:
    - from: "src/components/pipeline/deal-detail-sheet.tsx"
      to: "/projects?open={id}"
      via: "Next.js Link"
      pattern: "Link.*projects.*open"
---

<objective>
Add conversion visibility UI to deals and potentials: badge on cards, View Project button, variance display, and read-only mode for converted items.

Purpose: Users can see which deals/potentials have been converted and navigate to linked projects (CONV-01, CONV-02, CONV-03, CONV-04, CONV-05).
Output: Cards show conversion badges, detail sheets show project link with variance, converted items are read-only.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/27-conversion-visibility-archive/27-RESEARCH.md
@.planning/phases/27-conversion-visibility-archive/27-01-SUMMARY.md
@src/components/pipeline/pipeline-card.tsx
@src/components/pipeline/deal-detail-sheet.tsx
@src/components/potential-projects/potential-card.tsx
@src/components/potential-projects/potential-detail-sheet.tsx
@src/lib/utils.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add conversion badge to deal and potential cards</name>
  <files>src/components/pipeline/pipeline-card.tsx, src/components/potential-projects/potential-card.tsx</files>
  <action>
Update Deal interface in pipeline-card.tsx to include project:
```typescript
interface Deal {
  id: string
  title: string
  description: string | null
  value: number | null
  stage: string
  lostReason?: string | null
  position: number
  isArchived: boolean  // NEW
  company: { id: string; name: string } | null
  contact: { id: string; name: string } | null
  project: {  // NEW
    id: string
    title: string
    revenue: number | null
    potentialRevenue: number | null
  } | null
}
```

Add conversion badge below the value display (if project exists and stage is WON):
```tsx
import { ArrowRight } from 'lucide-react'

// In card render, after value display:
{deal.project && deal.stage === 'WON' && (
  <Badge
    variant="outline"
    className="bg-green-50 text-green-700 border-green-200 text-xs"
  >
    <ArrowRight className="h-3 w-3 mr-1" />
    {deal.project.title}
  </Badge>
)}
```

Apply same pattern to potential-card.tsx:
- Update PotentialProject interface to include project
- Show badge when project exists and stage is 'CONFIRMED'
  </action>
  <verify>
View Pipeline page - WON deals with projects show green badge with project title.
View Potential Projects page - CONFIRMED items with projects show green badge.
  </verify>
  <done>Cards display conversion badge with linked project title.</done>
</task>

<task type="auto">
  <name>Task 2: Add View Project, variance, and read-only to deal detail sheet</name>
  <files>src/components/pipeline/deal-detail-sheet.tsx</files>
  <action>
Update Deal interface to include project and isArchived (same as card).

Add imports:
```typescript
import Link from 'next/link'
import { ExternalLink, Lock } from 'lucide-react'
import { formatCurrency } from '@/lib/utils'
```

Add computed flags after form state:
```typescript
const isConverted = deal?.stage === 'WON' && deal?.project !== null
const isLost = deal?.stage === 'LOST'
const isReadOnly = isConverted || isLost
```

Add conversion info section after description (before lost reason):
```tsx
{/* Converted Project Info */}
{isConverted && deal.project && (
  <>
    <Separator />
    <div className="space-y-3">
      <div className="flex items-center gap-2 text-muted-foreground">
        <Lock className="h-4 w-4" />
        <span className="text-sm">Converted to Project</span>
      </div>

      <div className="p-3 bg-green-50 rounded-lg border border-green-200">
        <div className="flex items-center justify-between">
          <div>
            <div className="font-medium text-green-800">{deal.project.title}</div>
          </div>
          <Button variant="outline" size="sm" asChild>
            <Link href={`/projects?open=${deal.project.id}`}>
              <ExternalLink className="h-4 w-4 mr-1" />
              View
            </Link>
          </Button>
        </div>

        {/* Variance display */}
        {deal.project.revenue !== null && (
          <div className="mt-3 pt-3 border-t border-green-200 text-sm">
            <div className="grid grid-cols-2 gap-2">
              <div>
                <span className="text-gray-500">Estimated: </span>
                <span className="font-medium">{formatCurrency(deal.value ?? 0)}</span>
              </div>
              <div>
                <span className="text-gray-500">Actual: </span>
                <span className="font-medium">{formatCurrency(deal.project.revenue)}</span>
              </div>
            </div>
            <div className={cn(
              "mt-1 font-medium",
              deal.project.revenue > (deal.value ?? 0) ? "text-green-600" : "text-amber-600"
            )}>
              Variance: {deal.project.revenue > (deal.value ?? 0) ? '+' : ''}
              {formatCurrency(deal.project.revenue - (deal.value ?? 0))}
            </div>
          </div>
        )}
      </div>
    </div>
  </>
)}
```

Make form inputs read-only when isReadOnly:
```tsx
<Input
  id="edit-title"
  value={title}
  onChange={(e) => setTitle(e.target.value)}
  placeholder="Enter deal title"
  disabled={isReadOnly}
  className={cn(isReadOnly && "bg-gray-50 cursor-not-allowed")}
/>
```

Apply disabled={isReadOnly} and styling to: Title, CompanySelect, ContactSelect, Value, Description inputs.

Replace Save button section in footer:
```tsx
{isReadOnly ? (
  <div className="text-sm text-muted-foreground text-center py-2 px-4">
    {isConverted ? 'Converted deals cannot be edited' : 'Lost deals cannot be edited'}
  </div>
) : (
  <Button onClick={handleSave} disabled={isSaving || !hasChanges} className="w-full sm:w-auto">
    {isSaving && <Loader2 className="mr-2 h-4 w-4 animate-spin" />}
    Save Changes
  </Button>
)}
```
  </action>
  <verify>
Open a WON deal with project - see conversion section with View button and variance.
Try to edit fields - should be disabled.
Click View - should navigate to /projects?open={id}.
Open a LOST deal - fields should be disabled.
  </verify>
  <done>Deal detail sheet shows conversion info, variance, and read-only mode.</done>
</task>

<task type="auto">
  <name>Task 3: Add View Project, variance, and read-only to potential detail sheet</name>
  <files>src/components/potential-projects/potential-detail-sheet.tsx</files>
  <action>
Apply same pattern as deal detail sheet:

Update PotentialProject interface to include project and isArchived.

Add imports (Link, ExternalLink, Lock, formatCurrency).

Add computed flags:
```typescript
const isConverted = project?.stage === 'CONFIRMED' && project?.project !== null
const isReadOnly = isConverted
```

Add conversion info section (similar to deal sheet but use estimatedValue instead of value).

Make form inputs disabled when isReadOnly.

Replace Save button with read-only message when isReadOnly.
  </action>
  <verify>
Open a CONFIRMED potential with project - see conversion section with View button and variance.
Try to edit fields - should be disabled.
Click View - should navigate to /projects?open={id}.
  </verify>
  <done>Potential detail sheet shows conversion info, variance, and read-only mode.</done>
</task>

</tasks>

<verification>
1. Pipeline cards show green badge on WON deals with project title
2. Potential cards show green badge on CONFIRMED items with project title
3. Deal detail sheet shows conversion info for WON deals with projects
4. Potential detail sheet shows conversion info for CONFIRMED items with projects
5. Variance displays correctly (estimate vs actual)
6. Form fields are disabled for converted/lost items
7. View Project button navigates to /projects?open={id}
</verification>

<success_criteria>
- [ ] CONV-01: CONFIRMED potential shows "Converted to Project" badge with project title
- [ ] CONV-02: User can click "View Project" to navigate to project detail
- [ ] CONV-03: Converted potential shows variance (Estimated vs Actual)
- [ ] CONV-04: Converted potential is read-only
- [ ] CONV-05: WON deal shows same conversion indicators
- [ ] No TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/27-conversion-visibility-archive/27-02-SUMMARY.md`
</output>
