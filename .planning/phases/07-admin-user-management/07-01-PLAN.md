---
phase: 07-admin-user-management
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/ui/alert-dialog.tsx
  - src/lib/actions/user-actions.ts
autonomous: true

must_haves:
  truths:
    - "Server Actions exist for updating user role"
    - "Server Actions exist for deleting user"
    - "Admin cannot demote/delete themselves (server-side check)"
    - "AlertDialog component available for delete confirmation"
  artifacts:
    - path: "src/components/ui/alert-dialog.tsx"
      provides: "Accessible confirmation dialog"
      min_lines: 50
    - path: "src/lib/actions/user-actions.ts"
      provides: "updateUserRole and deleteUser Server Actions"
      exports: ["updateUserRole", "deleteUser"]
  key_links:
    - from: "src/lib/actions/user-actions.ts"
      to: "@/auth"
      via: "auth() for session check"
      pattern: "auth\\(\\)"
    - from: "src/lib/actions/user-actions.ts"
      to: "@prisma/client"
      via: "prisma.user.update and prisma.user.delete"
      pattern: "prisma\\.user\\.(update|delete)"
---

<objective>
Create server-side infrastructure for admin user management: Server Actions for role changes and user deletion with self-protection, plus AlertDialog component for delete confirmation.

Purpose: Provide type-safe, secure backend operations before building the UI.
Output: User mutation Server Actions and AlertDialog component ready for Plan 02.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/07-admin-user-management/07-RESEARCH.md

@src/auth.ts
@src/lib/prisma.ts
@prisma/schema.prisma
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add AlertDialog component from shadcn/ui</name>
  <files>src/components/ui/alert-dialog.tsx</files>
  <action>
Run: `npx shadcn@latest add alert-dialog`

This installs the AlertDialog component which provides:
- AlertDialog, AlertDialogTrigger, AlertDialogContent
- AlertDialogHeader, AlertDialogTitle, AlertDialogDescription
- AlertDialogFooter, AlertDialogAction, AlertDialogCancel

Accept defaults when prompted. Component will be created at src/components/ui/alert-dialog.tsx.
  </action>
  <verify>File exists: `ls src/components/ui/alert-dialog.tsx`</verify>
  <done>AlertDialog component installed and available for import</done>
</task>

<task type="auto">
  <name>Task 2: Create Server Actions for user management</name>
  <files>src/lib/actions/user-actions.ts</files>
  <action>
Create `src/lib/actions/user-actions.ts` with two Server Actions:

**updateUserRole(userId: string, newRole: UserRole):**
1. Mark file with "use server" directive
2. Call `auth()` to get session
3. If no session or not ADMIN role, return `{ error: "Unauthorized" }`
4. If `session.user.id === userId`, return `{ error: "You cannot change your own role" }` (prevent self-demotion)
5. Call `prisma.user.update({ where: { id: userId }, data: { role: newRole } })`
6. Log action: `[ADMIN] ${session.user.email} changed ${user.email} role to ${newRole}`
7. Call `revalidatePath("/admin/users")`
8. Return `{ success: true }`
9. Wrap in try/catch, return `{ error: "Failed to update user role" }` on exception

**deleteUser(userId: string):**
1. Same auth checks as above
2. If `session.user.id === userId`, return `{ error: "You cannot delete your own account" }` (prevent self-deletion)
3. Call `prisma.user.delete({ where: { id: userId } })`
4. Log action: `[ADMIN] ${session.user.email} deleted user ${user.email}`
5. Call `revalidatePath("/admin/users")`
6. Return `{ success: true }`
7. Wrap in try/catch, return `{ error: "Failed to delete user" }` on exception

**Type definitions:**
- Import `UserRole` from `@prisma/client`
- Define `ActionResult = { success: true } | { error: string }`
- Both functions return `Promise<ActionResult>`

Reference 07-RESEARCH.md "Complete Server Actions" section for exact implementation.
  </action>
  <verify>
Run TypeScript check: `npx tsc --noEmit src/lib/actions/user-actions.ts`
Verify exports: `grep -E "export async function (updateUserRole|deleteUser)" src/lib/actions/user-actions.ts`
  </verify>
  <done>
Server Actions exist with:
- updateUserRole accepting userId and newRole, returning ActionResult
- deleteUser accepting userId, returning ActionResult
- Self-protection checks (cannot modify own user)
- Audit logging to console
- revalidatePath for UI refresh
  </done>
</task>

</tasks>

<verification>
1. AlertDialog component exists: `ls src/components/ui/alert-dialog.tsx`
2. Server Actions export correctly:
   ```bash
   grep "export async function updateUserRole" src/lib/actions/user-actions.ts
   grep "export async function deleteUser" src/lib/actions/user-actions.ts
   ```
3. Self-protection implemented:
   ```bash
   grep "session.user.id === userId" src/lib/actions/user-actions.ts
   ```
4. Revalidation implemented:
   ```bash
   grep "revalidatePath" src/lib/actions/user-actions.ts
   ```
5. TypeScript compiles: `npx tsc --noEmit`
</verification>

<success_criteria>
- AlertDialog component available at src/components/ui/alert-dialog.tsx
- Server Actions file exports updateUserRole and deleteUser
- Both actions check admin auth before proceeding
- Both actions prevent self-modification
- Both actions log admin activity
- Both actions revalidate /admin/users path
- No TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/07-admin-user-management/07-01-SUMMARY.md`
</output>
