---
phase: 07-admin-user-management
plan: 02
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - src/app/admin/users/page.tsx
  - src/components/admin/user-list.tsx
  - src/components/admin/user-role-select.tsx
  - src/components/admin/delete-user-button.tsx
  - src/components/layout/sidebar.tsx
autonomous: true

must_haves:
  truths:
    - "Admin can view list of all users with their email and role"
    - "Admin can change user role via dropdown (VIEWER/EDITOR/ADMIN)"
    - "Admin can remove user via delete button with confirmation dialog"
    - "Admin sees 'Users' link in sidebar navigation"
    - "Current user row shows 'You' badge and disabled controls"
  artifacts:
    - path: "src/app/admin/users/page.tsx"
      provides: "Admin users page with server-side data fetching"
      min_lines: 25
    - path: "src/components/admin/user-list.tsx"
      provides: "User table with avatar, email, role, joined date, actions"
      min_lines: 60
    - path: "src/components/admin/user-role-select.tsx"
      provides: "Role dropdown with optimistic updates"
      min_lines: 30
    - path: "src/components/admin/delete-user-button.tsx"
      provides: "Delete button with AlertDialog confirmation"
      min_lines: 40
  key_links:
    - from: "src/app/admin/users/page.tsx"
      to: "prisma.user.findMany"
      via: "Server Component data fetch"
      pattern: "prisma\\.user\\.findMany"
    - from: "src/components/admin/user-role-select.tsx"
      to: "src/lib/actions/user-actions.ts"
      via: "updateUserRole Server Action"
      pattern: "updateUserRole"
    - from: "src/components/admin/delete-user-button.tsx"
      to: "src/lib/actions/user-actions.ts"
      via: "deleteUser Server Action"
      pattern: "deleteUser"
    - from: "src/components/layout/sidebar.tsx"
      to: "/admin/users"
      via: "Admin-only nav link"
      pattern: "/admin/users"
---

<objective>
Build the admin user management UI: a page listing all users with inline role editing and delete functionality, plus sidebar navigation for admins.

Purpose: Enable admins to manage user access and roles through an intuitive interface.
Output: Fully functional admin user management accessible at /admin/users.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/07-admin-user-management/07-RESEARCH.md
@.planning/phases/07-admin-user-management/07-01-SUMMARY.md

@src/auth.ts
@src/lib/prisma.ts
@src/lib/actions/user-actions.ts
@src/components/layout/sidebar.tsx
@src/components/ui/select.tsx
@src/components/ui/alert-dialog.tsx
@src/components/ui/table.tsx
@src/components/ui/avatar.tsx
@src/components/ui/badge.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Admin Users Page</name>
  <files>src/app/admin/users/page.tsx</files>
  <action>
Create `src/app/admin/users/page.tsx` as a Server Component:

1. Export metadata: `{ title: "User Management - Admin" }`
2. Default export async function AdminUsersPage()
3. Get session via `auth()` from `@/auth`
4. Defense in depth: if no session or role !== "ADMIN", redirect to /forbidden
5. Fetch users with Prisma:
   ```typescript
   const users = await prisma.user.findMany({
     select: {
       id: true,
       name: true,
       email: true,
       image: true,
       role: true,
       createdAt: true,
     },
     orderBy: { createdAt: "desc" },
   })
   ```
6. Render page with:
   - h1: "User Management" (text-2xl font-bold tracking-tight)
   - p: "View and manage user access and roles" (text-muted-foreground)
   - UserList component with users and currentUserId props
7. Wrap in div with className="space-y-6"

Reference 07-RESEARCH.md "Complete Admin Users Page" section.
  </action>
  <verify>File exists and has correct structure: `grep -E "AdminUsersPage|findMany|UserList" src/app/admin/users/page.tsx`</verify>
  <done>Admin users page fetches all users and renders UserList component</done>
</task>

<task type="auto">
  <name>Task 2: Create User List and Action Components</name>
  <files>
    src/components/admin/user-list.tsx
    src/components/admin/user-role-select.tsx
    src/components/admin/delete-user-button.tsx
  </files>
  <action>
Create three client components in `src/components/admin/`:

**user-list.tsx:**
1. "use client" directive
2. Import: Avatar, Badge, Card, Table components, UserRoleSelect, DeleteUserButton, formatDistanceToNow from date-fns
3. Define User interface: { id, name, email, image, role, createdAt }
4. Define UserListProps: { users: User[], currentUserId: string }
5. Helper function getRoleBadgeVariant(role) returning Tailwind classes:
   - ADMIN: purple-100/purple-700
   - EDITOR: blue-100/blue-700
   - VIEWER: gray-100/gray-700
6. Helper function getInitials(name) returning first two initials
7. Render Card containing Table:
   - Columns: User (avatar + name + "You" badge if current), Email, Role, Joined, Actions
   - For each user row:
     - Avatar with image or initials fallback
     - Name with optional "You" Badge if isCurrentUser
     - Email in text-muted-foreground
     - UserRoleSelect (disabled if isCurrentUser)
     - formatDistanceToNow(createdAt, { addSuffix: true })
     - DeleteUserButton (disabled if isCurrentUser)
   - Empty state: "No users found" centered
   - Footer: "{N} user(s) total"

**user-role-select.tsx:**
1. "use client" directive
2. Import: useState, useTransition from React, UserRole from @prisma/client, Select components, updateUserRole action
3. Props: userId, currentRole, disabled
4. Define ROLE_OPTIONS: [{ value: "VIEWER", label: "Viewer" }, { value: "EDITOR", label: "Editor" }, { value: "ADMIN", label: "Admin" }]
5. State: optimisticRole (initialized to currentRole)
6. useTransition for isPending state
7. handleRoleChange(newRole):
   - setOptimisticRole(newRole) - optimistic update
   - startTransition -> call updateUserRole(userId, newRole)
   - if error, revert: setOptimisticRole(currentRole)
8. Render Select with value={optimisticRole}, disabled={disabled || isPending}
9. SelectTrigger className="w-[120px]"

**delete-user-button.tsx:**
1. "use client" directive
2. Import: useState, useTransition, AlertDialog components, Button, Trash2 icon, deleteUser action
3. Props: userId, userEmail, disabled
4. State: open for dialog
5. useTransition for isPending
6. handleDelete():
   - startTransition -> call deleteUser(userId)
   - setOpen(false) after (regardless of result)
7. Render AlertDialog with:
   - Trigger: ghost Button with Trash2 icon, red text/hover colors
   - Title: "Remove User"
   - Description: "Are you sure you want to remove {userEmail}? This action cannot be undone."
   - Cancel button
   - Action button: "Remove User" (red bg), shows "Removing..." when isPending

Reference 07-RESEARCH.md code examples for exact implementation patterns.
  </action>
  <verify>
Files exist:
- `ls src/components/admin/user-list.tsx`
- `ls src/components/admin/user-role-select.tsx`
- `ls src/components/admin/delete-user-button.tsx`
TypeScript check: `npx tsc --noEmit`
  </verify>
  <done>
All three components created:
- UserList renders table with user data
- UserRoleSelect provides inline role editing with optimistic updates
- DeleteUserButton shows confirmation dialog before deletion
  </done>
</task>

<task type="auto">
  <name>Task 3: Add Users link to Sidebar for Admins</name>
  <files>src/components/layout/sidebar.tsx</files>
  <action>
Update `src/components/layout/sidebar.tsx` to show "Users" link for ADMIN role:

1. Import `useSession` from `next-auth/react` (sidebar is already a client component)
2. Import `Users` icon from `lucide-react`
3. Inside Sidebar component, call `const { data: session } = useSession()`
4. After the main navigation map, conditionally render admin section:
   ```tsx
   {session?.user?.role === "ADMIN" && (
     <>
       <div className="mt-6 mb-2 px-3 text-xs font-semibold text-gray-400 uppercase tracking-wider">
         Admin
       </div>
       <Link
         href="/admin/users"
         className={cn(
           'flex items-center gap-3 rounded-lg px-3 py-2 text-sm font-medium transition-colors',
           pathname.startsWith('/admin/users')
             ? 'bg-gray-100 text-gray-900'
             : 'text-gray-600 hover:bg-gray-50 hover:text-gray-900'
         )}
       >
         <Users className="h-5 w-5" />
         Users
       </Link>
     </>
   )}
   ```
5. The admin section appears below the main navigation with a labeled divider.

Note: useSession requires SessionProvider which should already be configured from Phase 4. If not wrapped, the session will be null and the link won't appear (graceful degradation).
  </action>
  <verify>
Check for Users import and admin section:
- `grep "Users" src/components/layout/sidebar.tsx`
- `grep "/admin/users" src/components/layout/sidebar.tsx`
- `grep "useSession" src/components/layout/sidebar.tsx`
  </verify>
  <done>
Sidebar shows "Users" link under "Admin" section header for ADMIN role users.
Non-admin users see no change to navigation.
  </done>
</task>

</tasks>

<verification>
1. Page loads without errors:
   - Start dev server: `npm run dev`
   - Sign in as admin (khairul@talenta.com.my)
   - Navigate to /admin/users

2. User list displays:
   - All users shown with avatar, name, email, role, join date
   - Current user row shows "You" badge
   - Current user has disabled role select and delete button

3. Role change works:
   - Change a user's role via dropdown
   - Verify optimistic update (immediate UI change)
   - Refresh page to confirm persistence

4. User deletion works:
   - Click delete on a non-current user
   - Verify AlertDialog appears with user email
   - Click cancel, verify dialog closes without deletion
   - Click Remove User, verify user disappears from list

5. Sidebar navigation:
   - Admin user sees "Users" link under "Admin" section
   - Link navigates to /admin/users
   - Link shows active state when on /admin/users page

6. TypeScript: `npx tsc --noEmit`
</verification>

<success_criteria>
- Admin can access /admin/users and see all users in a table
- Admin can change any user's role (except their own) via inline dropdown
- Admin can delete any user (except themselves) with confirmation dialog
- Admin sees "Users" navigation link in sidebar
- Non-admin users do not see "Users" link
- Current user row clearly indicated and protected from self-modification
- All components type-safe with no TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/07-admin-user-management/07-02-SUMMARY.md`
</output>
