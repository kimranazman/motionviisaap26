---
phase: 02-header-features
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/app/api/initiatives/search/route.ts
  - src/components/layout/header-search.tsx
  - src/components/layout/header.tsx
  - src/lib/hooks/use-debounce.ts
autonomous: true

must_haves:
  truths:
    - "User types in header search and sees filtered initiative results"
    - "Results appear in dropdown without navigating away from current page"
    - "User can click a result to navigate to initiative detail page"
  artifacts:
    - path: "src/app/api/initiatives/search/route.ts"
      provides: "Search API endpoint with text matching"
      exports: ["GET"]
    - path: "src/components/layout/header-search.tsx"
      provides: "Search input with debounced popover results"
      min_lines: 80
    - path: "src/lib/hooks/use-debounce.ts"
      provides: "Debounce hook for search input"
      exports: ["useDebounce"]
  key_links:
    - from: "src/components/layout/header-search.tsx"
      to: "/api/initiatives/search"
      via: "fetch with debounced query"
      pattern: "fetch.*api/initiatives/search"
    - from: "src/components/layout/header-search.tsx"
      to: "/initiatives/[id]"
      via: "Link component on each result"
      pattern: "href=.*initiatives/"
---

<objective>
Implement global search functionality in the header that allows users to find initiatives by typing.

Purpose: Enable initiative discovery without navigating away from current page (SRCH-01)
Output: Working search input with instant results dropdown showing matching initiatives
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-header-features/02-CONTEXT.md
@.planning/phases/02-header-features/02-RESEARCH.md

Key files to reference:
@src/components/layout/header.tsx - Current header with placeholder search
@src/app/api/initiatives/route.ts - Existing search param pattern (lines 33-40)
@src/lib/utils.ts - formatStatus, getStatusColor utilities
@src/components/ui/popover.tsx - Popover component to use
@src/components/ui/scroll-area.tsx - ScrollArea for results list
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create search API and debounce hook</name>
  <files>
    src/app/api/initiatives/search/route.ts
    src/lib/hooks/use-debounce.ts
  </files>
  <action>
Create `/api/initiatives/search` API route:
- Accept query param `q` for search text
- Search across: title, monthlyObjective, weeklyTasks, remarks (existing pattern in /api/initiatives)
- Also search personInCharge (match formatted name like "Khairul")
- Return max 10 results ordered by relevance (title matches first)
- Return only fields needed for display: id, title, status, personInCharge
- Handle empty query (return empty array, not error)

Create useDebounce hook at `/src/lib/hooks/use-debounce.ts`:
- Generic hook: `useDebounce<T>(value: T, delay: number): T`
- Use setTimeout/clearTimeout pattern
- Default delay should be configurable (will use 300ms)

Pattern from existing API route (src/app/api/initiatives/route.ts lines 33-40):
```typescript
if (search) {
  where.OR = [
    { title: { contains: search } },
    { monthlyObjective: { contains: search } },
    // etc
  ]
}
```
  </action>
  <verify>
curl "http://localhost:3000/api/initiatives/search?q=test" returns JSON array
curl "http://localhost:3000/api/initiatives/search?q=" returns empty array []
  </verify>
  <done>
Search API returns filtered initiatives matching query text.
Hook file exists and exports useDebounce function.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create HeaderSearch component with popover results</name>
  <files>
    src/components/layout/header-search.tsx
    src/components/layout/header.tsx
  </files>
  <action>
Create HeaderSearch component at `/src/components/layout/header-search.tsx`:

1. State management:
   - `query` (string) - controlled input value
   - `results` (array) - search results from API
   - `isOpen` (boolean) - popover open state
   - `isLoading` (boolean) - show loading state during fetch

2. Debounced search:
   - Use useDebounce hook with 300ms delay
   - Fetch from /api/initiatives/search when debouncedQuery changes
   - Clear results when query is empty

3. Popover structure (use existing Popover component):
   - PopoverTrigger wraps the search input container
   - Input: controlled, with Search icon (lucide-react)
   - PopoverContent: opens when results exist AND query not empty
   - CRITICAL: Set `onOpenAutoFocus={(e) => e.preventDefault()}` to prevent focus steal
   - Set `align="start"` for left-aligned dropdown

4. Results display:
   - Use ScrollArea with max-h-80 for scrollable list
   - Each result as Link to /initiatives/[id]
   - Show: title (truncated), status badge (use getStatusColor + formatStatus from utils)
   - Show owner name (use formatTeamMember from utils)
   - Empty state: "No results for {query}" message
   - Loading state: "Searching..." message

5. Keyboard handling:
   - Escape closes popover
   - Click on result closes popover and navigates

6. Visual styling:
   - Match existing header search input style (bg-gray-50, border-gray-200, w-64)
   - Results hover state: bg-gray-100
   - Result items: flex with gap-2, items-center

Update header.tsx:
- Replace static search Input (lines 31-37) with HeaderSearch component
- Import HeaderSearch from './header-search'
- Remove unused Search import if no longer needed in header.tsx

Reference pitfalls from research:
- Pitfall 1: Focus issues - MUST use onOpenAutoFocus preventDefault
- Pitfall 4: Empty state - MUST render meaningful empty state message
  </action>
  <verify>
1. Open http://localhost:3000 (any page with header)
2. Type in search box - results should appear after ~300ms
3. Click a result - navigates to /initiatives/[id]
4. Type gibberish - shows "No results" message
5. Clear search - popover closes
6. Can continue typing without focus jumping
  </verify>
  <done>
User types in header search and sees filtered results in dropdown.
Clicking result navigates to initiative detail page.
Search works without leaving current page.
  </done>
</task>

</tasks>

<verification>
After both tasks complete:
1. Search API: `curl "http://localhost:3000/api/initiatives/search?q=scale"` returns matching initiatives
2. UI: Type "scale" in header search, see results appear
3. Navigation: Click any result, lands on /initiatives/[id] page
4. Empty state: Type "zzzzz", see "No results" message
5. No regressions: Verify header still shows correctly (title, bell, user dropdown)
</verification>

<success_criteria>
- User can type in header search and see matching initiatives
- Results show title, status badge, and owner
- Clicking result navigates to detail page
- Empty search returns no results (not error)
- Search is debounced (no flicker on fast typing)
- Requirement SRCH-01 satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/02-header-features/02-01-SUMMARY.md`
</output>
