---
phase: 02-header-features
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/app/api/notifications/route.ts
  - src/components/layout/notification-bell.tsx
  - src/components/layout/header.tsx
autonomous: true

must_haves:
  truths:
    - "User sees badge count on bell icon showing overdue/at-risk initiatives"
    - "User clicks bell and sees popover list with links to each at-risk initiative"
    - "Items are grouped by type: Overdue, At Risk, Due Soon"
  artifacts:
    - path: "src/app/api/notifications/route.ts"
      provides: "Notifications API with grouped items"
      exports: ["GET"]
    - path: "src/components/layout/notification-bell.tsx"
      provides: "Bell button with badge and popover"
      min_lines: 100
  key_links:
    - from: "src/components/layout/notification-bell.tsx"
      to: "/api/notifications"
      via: "fetch on mount + interval"
      pattern: "fetch.*api/notifications"
    - from: "src/components/layout/notification-bell.tsx"
      to: "/initiatives/[id]"
      via: "Link component on each notification item"
      pattern: "href=.*initiatives/"
---

<objective>
Implement notification bell in header showing overdue, at-risk, and due-soon initiatives.

Purpose: Alert users to items needing attention without them having to search (NOTF-01, NOTF-02)
Output: Bell icon with dynamic badge count and popover showing grouped notification items
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-header-features/02-CONTEXT.md
@.planning/phases/02-header-features/02-RESEARCH.md

Key files to reference:
@src/components/layout/header.tsx - Current header with hardcoded bell badge "3"
@src/app/api/dashboard/stats/route.ts - Date query patterns (lines 49-63)
@src/lib/utils.ts - formatDate, formatStatus, getStatusColor utilities
@src/components/ui/popover.tsx - Popover component to use
@src/components/ui/scroll-area.tsx - ScrollArea for notification list
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create notifications API endpoint</name>
  <files>src/app/api/notifications/route.ts</files>
  <action>
Create `/api/notifications` API route that returns grouped notification items:

1. Date calculations:
   - today: new Date() with hours set to 0,0,0,0
   - sevenDaysLater: today + 7 days

2. Three parallel queries (use Promise.all for efficiency):

   a) Overdue: endDate < today AND status NOT IN ['COMPLETED', 'CANCELLED']
   b) At Risk: status = 'AT_RISK'
   c) Due Soon: endDate >= today AND endDate <= sevenDaysLater
               AND status NOT IN ['COMPLETED', 'CANCELLED', 'AT_RISK']
               (exclude AT_RISK to avoid duplicates with category b)

3. Each query should:
   - Order by endDate ascending (most urgent first)
   - Select only needed fields: id, title, status, endDate, personInCharge
   - Limit to reasonable number (20 per category max)

4. Response structure:
```json
{
  "overdue": [...],
  "atRisk": [...],
  "dueSoon": [...],
  "totalCount": number
}
```

Reference pattern from dashboard/stats/route.ts (lines 49-63):
```typescript
const today = new Date()
const thirtyDaysLater = new Date(today)
thirtyDaysLater.setDate(thirtyDaysLater.getDate() + 30)

const upcomingDeadlines = await prisma.initiative.count({
  where: {
    endDate: { gte: today, lte: thirtyDaysLater },
    status: { notIn: ['COMPLETED', 'CANCELLED'] },
  },
})
```
  </action>
  <verify>
curl "http://localhost:3000/api/notifications" returns JSON with overdue, atRisk, dueSoon arrays and totalCount
  </verify>
  <done>
API returns grouped notification items with total count.
Each category contains initiatives matching its criteria.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create NotificationBell component with popover</name>
  <files>
    src/components/layout/notification-bell.tsx
    src/components/layout/header.tsx
  </files>
  <action>
Create NotificationBell component at `/src/components/layout/notification-bell.tsx`:

1. State management:
   - notifications: { overdue: [], atRisk: [], dueSoon: [], totalCount: 0 }
   - isLoading: boolean

2. Data fetching:
   - Fetch from /api/notifications on component mount
   - Refresh every 60 seconds (setInterval)
   - Also refresh on window focus (document.addEventListener('visibilitychange'))
   - Clean up intervals/listeners on unmount

3. Popover structure (use existing Popover component):
   - PopoverTrigger: Button with Bell icon
   - Badge: Only show if totalCount > 0
     - Position: absolute -right-1 -top-1
     - Style: bg-red-500 text-white text-[10px] rounded-full h-4 w-4
     - Display: totalCount > 99 ? '99+' : totalCount
   - PopoverContent: align="end", width w-80

4. Popover content layout:
   - Header: "Notifications" title with total count
   - ScrollArea with max-h-96
   - Group sections (only render if items exist):
     a) "Overdue" section (red accent)
     b) "At Risk" section (orange accent)
     c) "Due Soon" section (yellow accent)
   - Empty state: "No items need attention" centered message

5. Each notification item:
   - Link to /initiatives/[id]
   - Show: title (truncated), due date (use formatDate), status badge
   - Hover state: bg-gray-100
   - Section header with count: "Overdue (3)"

6. Section styling:
   - Each section has a header with left border color indicating severity
   - Overdue: border-l-red-500
   - At Risk: border-l-orange-500
   - Due Soon: border-l-yellow-500

Update header.tsx:
- Replace static bell button (lines 39-45) with NotificationBell component
- Import NotificationBell from './notification-bell'
- Remove hardcoded "3" badge

Handle Pitfall 3 from research (badge flicker):
- Initialize state with null/loading, show skeleton or nothing until first fetch completes
- Don't show badge as "0" during loading (just hide badge entirely)
  </action>
  <verify>
1. Open http://localhost:3000 (any page with header)
2. Bell icon shows badge with count (or no badge if 0 notifications)
3. Click bell - popover opens with grouped items
4. Overdue items show in red section, At Risk in orange, Due Soon in yellow
5. Click any item - navigates to /initiatives/[id]
6. Empty state shows if no items need attention
7. Navigate between pages - badge count persists (no flicker to 0)
  </verify>
  <done>
Bell icon shows dynamic count of items needing attention.
Popover shows grouped notifications with links to detail pages.
Items grouped by: Overdue, At Risk, Due Soon.
  </done>
</task>

</tasks>

<verification>
After both tasks complete:
1. API: `curl "http://localhost:3000/api/notifications"` returns grouped items with totalCount
2. Badge: Bell shows correct count based on actual data
3. Popover: Click bell, see sections for Overdue/At Risk/Due Soon
4. Navigation: Click any notification, lands on /initiatives/[id] page
5. Empty state: If no notifications, shows "No items need attention"
6. Refresh: After 60 seconds or tab focus, count updates if data changed
7. No regressions: Header still shows search, user dropdown correctly
</verification>

<success_criteria>
- Badge shows total count of overdue + at-risk + due-soon initiatives
- Clicking bell opens popover with grouped sections
- Each section shows items with title, due date, and status
- Clicking item navigates to initiative detail page
- Empty state handled gracefully
- Requirements NOTF-01 and NOTF-02 satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/02-header-features/02-02-SUMMARY.md`
</output>
