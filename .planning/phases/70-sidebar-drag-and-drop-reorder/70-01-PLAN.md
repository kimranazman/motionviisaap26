# Plan 70-01: Nav Order Backend & Hook

## Frontmatter
- **Phase:** 70
- **Plan:** 01
- **Wave:** 1
- **Depends on:** None
- **Files modified:** prisma/schema.prisma, src/app/api/user/preferences/route.ts, src/lib/hooks/use-nav-visibility.ts, src/lib/nav-config.ts
- **Autonomous:** yes

## Objective

Add `navItemOrder` field to UserPreferences, extend the preferences API to handle it, and extend the `useNavVisibility` hook to provide ordering functions. Also add a helper to `nav-config.ts` to get default order.

## Tasks

<task id="1">
**Add navItemOrder field to Prisma schema**

In `prisma/schema.prisma`, add `navItemOrder` field to the `UserPreferences` model:

```prisma
navItemOrder   Json?  @map("nav_item_order") @db.Json
```

Add it after the `hiddenNavItems` field.

Then run `npx prisma db push` to sync the schema (no migration needed for dev).
</task>

<task id="2">
**Add default order helper to nav-config.ts**

In `src/lib/nav-config.ts`, add a function that returns the default order for all groups:

```typescript
/** Returns the default item order (hrefs) for each nav group */
export function getDefaultNavOrder(): Record<string, string[]> {
  const order: Record<string, string[]> = {}
  for (const group of navGroups) {
    order[group.key] = group.items.map((item) => item.href)
  }
  return order
}
```

This is used by the Reset Order button and for merging new items.
</task>

<task id="3">
**Extend preferences API to handle navItemOrder**

In `src/app/api/user/preferences/route.ts`:

**GET handler:** Add `navItemOrder` to the response:
```typescript
navItemOrder: (prefs?.navItemOrder as Record<string, string[]>) ?? null,
```

**PATCH handler:** Add `navItemOrder` to the destructured body and the `data` object:
```typescript
const { dashboardLayout, dateFilter, detailViewMode, hiddenNavItems, navItemOrder } = body as {
  dashboardLayout?: DashboardLayout
  dateFilter?: DateFilter
  detailViewMode?: string
  hiddenNavItems?: string[]
  navItemOrder?: Record<string, string[]>
}

// ... in the data building section:
if (navItemOrder !== undefined) {
  data.navItemOrder = navItemOrder
}
```
</task>

<task id="4">
**Extend useNavVisibility hook with ordering support**

In `src/lib/hooks/use-nav-visibility.ts`:

1. Add state for `navItemOrder`:
```typescript
const [navItemOrder, setNavItemOrder] = useState<Record<string, string[]> | null>(null)
```

2. Update the fetch effect to also read `navItemOrder`:
```typescript
if (data.navItemOrder) {
  setNavItemOrder(data.navItemOrder)
}
```

3. Add a function `getOrderedItems` that takes a group key and items array, returns items sorted per saved order. Items not in saved order are appended at the end (handles future new items, REORD-07):
```typescript
const getOrderedItems = useCallback(
  (groupKey: string, items: NavItem[]): NavItem[] => {
    if (!navItemOrder || !navItemOrder[groupKey]) return items
    const order = navItemOrder[groupKey]
    const sorted = [...items].sort((a, b) => {
      const idxA = order.indexOf(a.href)
      const idxB = order.indexOf(b.href)
      // Items not in order go to end
      const posA = idxA === -1 ? order.length : idxA
      const posB = idxB === -1 ? order.length : idxB
      return posA - posB
    })
    return sorted
  },
  [navItemOrder]
)
```

4. Add `saveNavOrder` function:
```typescript
const saveNavOrder = useCallback(
  async (order: Record<string, string[]>) => {
    const response = await fetch('/api/user/preferences', {
      method: 'PATCH',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ navItemOrder: order }),
    })
    if (!response.ok) throw new Error('Failed to save')
    setNavItemOrder(order)
  },
  []
)
```

5. Import `NavItem` type from nav-config:
```typescript
import { isAlwaysVisible } from '@/lib/nav-config'
import type { NavItem } from '@/lib/nav-config'
```

6. Return the new values from the hook:
```typescript
return { hiddenItems, navItemOrder, isLoading, isVisible, toggleItem, saveHiddenItems, getOrderedItems, saveNavOrder }
```
</task>

## Verification

- [ ] `npx prisma db push` succeeds without errors
- [ ] `navItemOrder` field exists in UserPreferences model
- [ ] GET `/api/user/preferences` returns `navItemOrder: null` for users without custom order
- [ ] PATCH `/api/user/preferences` with `{ navItemOrder: { saap: ["/kanban", "/"] } }` persists successfully
- [ ] Subsequent GET returns the saved `navItemOrder`
- [ ] `getDefaultNavOrder()` returns correct hrefs for all 3 groups
- [ ] `getOrderedItems()` sorts items by saved order and appends unknown items at end
- [ ] TypeScript compiles without errors: `npx tsc --noEmit`

## must_haves
- navItemOrder field in Prisma schema (REORD-04)
- API GET/PATCH handles navItemOrder (REORD-04)
- getOrderedItems merges saved order with new items at end (REORD-07)
- getDefaultNavOrder helper for reset functionality (REORD-06)
