# Plan 78-06: Calendar Page Integration

## Frontmatter

```yaml
wave: 3
depends_on:
  - 78-05
files_modified:
  - src/app/(dashboard)/calendar/page.tsx
autonomous: true
```

## Objective

Update the calendar page to use the new MainCalendar component with all three entity types (tasks, projects, initiatives), replacing the old CalendarView that only showed initiatives and events.

## Tasks

<task id="1">
Update the calendar page at `src/app/(dashboard)/calendar/page.tsx`:

```typescript
export const dynamic = 'force-dynamic'

import { Header } from '@/components/layout/header'
import { MainCalendar } from '@/components/calendar/main-calendar'
import { ViewModeToggle } from '@/components/objectives/view-mode-toggle'
import prisma from '@/lib/prisma'

async function getTasks() {
  const tasks = await prisma.task.findMany({
    where: {
      dueDate: { not: null }
    },
    select: {
      id: true,
      title: true,
      dueDate: true,
      status: true,
      projectId: true,
    },
    orderBy: {
      dueDate: 'asc'
    }
  })

  return tasks.map(t => ({
    ...t,
    dueDate: t.dueDate ? t.dueDate.toISOString() : null,
  }))
}

async function getProjects() {
  const projects = await prisma.project.findMany({
    where: {
      isArchived: false,
      OR: [
        { startDate: { not: null } },
        { endDate: { not: null } }
      ]
    },
    select: {
      id: true,
      title: true,
      startDate: true,
      endDate: true,
      status: true,
    },
    orderBy: {
      startDate: 'asc'
    }
  })

  return projects.map(p => ({
    ...p,
    startDate: p.startDate ? p.startDate.toISOString() : null,
    endDate: p.endDate ? p.endDate.toISOString() : null,
  }))
}

async function getInitiatives() {
  const initiatives = await prisma.initiative.findMany({
    select: {
      id: true,
      title: true,
      keyResult: { select: { krId: true, description: true } },
      startDate: true,
      endDate: true,
      status: true,
    },
    orderBy: {
      startDate: 'asc'
    }
  })

  return initiatives.map(i => ({
    ...i,
    startDate: i.startDate.toISOString(),
    endDate: i.endDate.toISOString(),
    keyResult: i.keyResult
      ? `${i.keyResult.krId} - ${i.keyResult.description}`
      : 'Unlinked',
  }))
}

export default async function CalendarPage() {
  const [tasks, projects, initiatives] = await Promise.all([
    getTasks(),
    getProjects(),
    getInitiatives(),
  ])

  return (
    <div className="min-h-screen bg-gray-50">
      <Header
        title="Calendar"
        description="Unified view of tasks, projects, and initiatives"
      />

      <div className="p-6">
        <div className="mb-6">
          <ViewModeToggle />
        </div>
        <MainCalendar
          tasks={tasks}
          projects={projects}
          initiatives={initiatives}
        />
      </div>
    </div>
  )
}
```

This updates the page to:
- Fetch tasks with dueDate
- Fetch non-archived projects with startDate or endDate
- Fetch all initiatives (they always have dates)
- Pass all three entity types to MainCalendar
- Update description to reflect unified view
- Keep ViewModeToggle for SAAP view navigation
</task>

## Verification

- [ ] File updated at `src/app/(dashboard)/calendar/page.tsx`
- [ ] Tasks fetched with dueDate not null
- [ ] Projects fetched with startDate or endDate
- [ ] Initiatives fetched with all required fields
- [ ] Dates converted to ISO strings
- [ ] MainCalendar imported and used
- [ ] Header description updated
- [ ] No TypeScript errors
- [ ] Page loads without errors

## must_haves

- All three entity types loaded (CAL-02 through CAL-07)
- Tasks filtered to those with dueDate
- Projects filtered to non-archived with dates
- All initiatives included (dates are required)
- MainCalendar component used
- Page accessible at /calendar (CAL-01)
