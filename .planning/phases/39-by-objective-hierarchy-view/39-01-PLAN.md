---
phase: 39-by-objective-hierarchy-view
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/app/(dashboard)/objectives/page.tsx
  - src/components/objectives/objective-hierarchy.tsx
  - src/components/objectives/objective-group.tsx
  - src/components/objectives/key-result-group.tsx
  - src/components/objectives/initiative-row.tsx
  - src/components/layout/sidebar.tsx
  - src/components/layout/mobile-sidebar.tsx
autonomous: true

must_haves:
  truths:
    - "User navigates to /objectives and sees initiatives grouped in Objective > Key Result > Initiative hierarchy"
    - "Each Objective header shows initiative count and status summary (e.g. '6 In Progress, 2 At Risk')"
    - "Each Key Result header shows initiative count and status summary"
    - "User can expand/collapse any Objective or Key Result section independently"
    - "Collapse state persists across re-renders (not reset on data refresh)"
    - "Initiative titles display with full text wrapping -- no truncation"
    - "User can click an initiative row to open the detail sheet"
    - "Sidebar and mobile sidebar show 'By Objective' navigation item"
  artifacts:
    - path: "src/app/(dashboard)/objectives/page.tsx"
      provides: "Server Component route for objectives hierarchy"
      contains: "export const dynamic = 'force-dynamic'"
    - path: "src/components/objectives/objective-hierarchy.tsx"
      provides: "Main client component managing expand/collapse state"
      contains: "'use client'"
    - path: "src/components/objectives/objective-group.tsx"
      provides: "Objective-level collapsible section"
      contains: "Collapsible"
    - path: "src/components/objectives/key-result-group.tsx"
      provides: "Key Result-level collapsible section"
      contains: "Collapsible"
    - path: "src/components/objectives/initiative-row.tsx"
      provides: "Single initiative row with full text, status badge, and click handler"
    - path: "src/components/layout/sidebar.tsx"
      provides: "Updated navigation with /objectives entry"
      contains: "/objectives"
    - path: "src/components/layout/mobile-sidebar.tsx"
      provides: "Updated mobile navigation with /objectives entry"
      contains: "/objectives"
  key_links:
    - from: "src/app/(dashboard)/objectives/page.tsx"
      to: "src/components/objectives/objective-hierarchy.tsx"
      via: "import and render with initialData prop"
      pattern: "ObjectiveHierarchy.*initialData"
    - from: "src/components/objectives/objective-hierarchy.tsx"
      to: "src/lib/initiative-group-utils.ts"
      via: "import groupInitiativesByObjective"
      pattern: "groupInitiativesByObjective"
    - from: "src/components/objectives/initiative-row.tsx"
      to: "src/components/kanban/initiative-detail-sheet.tsx"
      via: "click handler opens detail sheet"
      pattern: "InitiativeDetailSheet"
---

<objective>
Create the /objectives route with a three-level expandable hierarchy (Objective > Key Result > Initiative) and update sidebar navigation to include it.

Purpose: This is the core hierarchy view for Phase 39, grouping all 28 initiatives by their strategic Objective and Key Result. It fulfills VIEW-01 through VIEW-05.
Output: A working /objectives page with expand/collapse, status summaries in headers, full text initiative titles, detail sheet on click, and sidebar navigation.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/39-by-objective-hierarchy-view/39-RESEARCH.md
@.planning/phases/38-schema-utilities-foundation/38-01-SUMMARY.md

Key existing files to reference:
@src/app/(dashboard)/kanban/page.tsx (Server Component pattern)
@src/components/kanban/kanban-board.tsx (InitiativeDetailSheet reuse pattern, lines 184-189, 577-583)
@src/lib/initiative-group-utils.ts (groupInitiativesByObjective, GroupedObjective, GroupedKeyResult interfaces)
@src/lib/utils.ts (formatObjective, formatStatus, getStatusColor, formatDepartment, formatTeamMember, OBJECTIVE_OPTIONS, cn)
@src/components/ui/collapsible.tsx (Collapsible, CollapsibleTrigger, CollapsibleContent)
@src/components/layout/sidebar.tsx (navigation array to update)
@src/components/layout/mobile-sidebar.tsx (navigation array to update)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create /objectives route and hierarchy components</name>
  <files>
    src/app/(dashboard)/objectives/page.tsx
    src/components/objectives/objective-hierarchy.tsx
    src/components/objectives/objective-group.tsx
    src/components/objectives/key-result-group.tsx
    src/components/objectives/initiative-row.tsx
  </files>
  <action>
Create 5 files following the established Server Component + Client Component pattern:

**1. `src/app/(dashboard)/objectives/page.tsx`** (Server Component)
- Export `dynamic = 'force-dynamic'`
- Import `prisma` from `@/lib/prisma`, `Header` from `@/components/layout/header`, `ObjectiveHierarchy` from `@/components/objectives/objective-hierarchy`
- `getInitiatives()` function: `prisma.initiative.findMany` with `orderBy: [{ objective: 'asc' }, { keyResult: 'asc' }, { sequenceNumber: 'asc' }]`
- Select fields: id, sequenceNumber, title, objective, keyResult, department, status, personInCharge, startDate, endDate
- Serialize: map to convert startDate/endDate to `.toISOString()`
- Render: `<Header title="By Objective" description="Initiatives grouped by Objective and Key Result" />` then `<ObjectiveHierarchy initialData={initiatives} />`
- Follow the exact same pattern as `kanban/page.tsx`

**2. `src/components/objectives/objective-hierarchy.tsx`** (Client Component - main orchestrator)
- `'use client'` directive
- Define local `Initiative` interface: `{ id: string; sequenceNumber: number; title: string; objective: string; keyResult: string; department: string; status: string; personInCharge: string | null; startDate: string; endDate: string }`
- Props: `{ initialData: Initiative[] }`
- Import `groupInitiativesByObjective` from `@/lib/initiative-group-utils`
- Import `OBJECTIVE_OPTIONS` from `@/lib/utils`
- Import `InitiativeDetailSheet` from `@/components/kanban/initiative-detail-sheet`
- State: `expandedObjectives` as `useState<Set<string>>` initialized with `new Set(OBJECTIVE_OPTIONS.map(o => o.value))` (all expanded by default)
- State: `expandedKRs` as `useState<Set<string>>` initialized from grouped data unique KR keys (all expanded by default). IMPORTANT: compute the initial KR keys from `groupInitiativesByObjective(initialData)` at initialization time, NOT in a useMemo that recomputes. Use a lazy initializer: `useState<Set<string>>(() => { const grouped = groupInitiativesByObjective(initialData); const krKeys = new Set<string>(); grouped.forEach(g => g.keyResults.forEach(kr => krKeys.add(g.objective + ':' + kr.keyResult))); return krKeys; })`
- State: `selectedInitiative` (Initiative | null), `isSheetOpen` (boolean) for detail sheet
- Toggle functions: `toggleObjective(objective: string)` and `toggleKR(key: string)` that add/remove from the respective Sets
- Handler: `handleInitiativeClick(initiative: Initiative)` sets selectedInitiative and opens sheet
- Handler: `handleInitiativeUpdate()` calls `router.refresh()` (import from `next/navigation`) to refresh server data
- Compute grouped data: `const grouped = groupInitiativesByObjective(initialData)` (call at render time since it's a pure function, NOT in useMemo -- the input only changes via server refresh which remounts anyway)
- Render: map over `grouped` array to render `<ObjectiveGroup>` for each objective, passing down expand state, toggle callbacks, initiative click handler
- Render `<InitiativeDetailSheet>` at the bottom (same pattern as kanban-board.tsx)
- If no initiatives, show empty state: "No initiatives found"

**3. `src/components/objectives/objective-group.tsx`** (Client Component - Objective level)
- Props: `{ group: GroupedObjective, isExpanded: boolean, expandedKRs: Set<string>, onToggleObjective: () => void, onToggleKR: (key: string) => void, onInitiativeClick: (initiative: Initiative) => void }`
- Import `Collapsible, CollapsibleTrigger, CollapsibleContent` from `@/components/ui/collapsible`
- Import `ChevronRight` from `lucide-react`
- Import `formatObjective` from `@/lib/utils`
- Import `cn` from `@/lib/utils`
- Render a `<Collapsible open={isExpanded} onOpenChange={onToggleObjective}>` wrapping:
  - `<CollapsibleTrigger>`: flex row with chevron icon (rotates 90deg when expanded via `cn("h-5 w-5 shrink-0 transition-transform duration-200", isExpanded && "rotate-90")`), objective name via `formatObjective(group.objective)` in bold text-lg, initiative count badge showing `{group.totalInitiatives} initiatives`, and status summary badges
  - Status summary: show colored badges for each non-zero status count. Use inline computation: show `{group.inProgressCount} In Progress` (blue badge), `{group.atRiskCount} At Risk` (orange badge), `{group.completedCount} Completed` (green badge), `{group.totalInitiatives - group.completedCount - group.inProgressCount - group.atRiskCount} other` only if > 0 (gray badge). Use small rounded pill badges matching existing `getStatusColor()` style
  - `<CollapsibleContent>`: map over `group.keyResults` rendering `<KeyResultGroup>` for each
- Styling: bg-white rounded-xl border border-gray-200 shadow-sm mb-4, trigger padding p-4, hover:bg-gray-50 transition

**4. `src/components/objectives/key-result-group.tsx`** (Client Component - KR level)
- Props: `{ keyResult: GroupedKeyResult, objectiveKey: string, isExpanded: boolean, onToggle: () => void, onInitiativeClick: (initiative: Initiative) => void }`
- Same Collapsible pattern as objective-group but nested (indented with ml-4 or pl-4)
- The KR key for expand state is `objectiveKey + ':' + keyResult.keyResult` (matching the initialization in hierarchy.tsx)
- Header: chevron + KR label (display `keyResult.keyResult` directly -- the normalized form "KR1.1" is already readable), initiative count, status summary
- Status summary for KR: compute inline from `keyResult.initiatives.filter(...)` since GroupedKeyResult only has totalInitiatives and completedCount. Compute inProgressCount and atRiskCount from the initiatives array directly. Show as colored inline text (not badges, to keep visual hierarchy -- Objective = badges, KR = inline text)
- CollapsibleContent: map over `keyResult.initiatives` rendering `<InitiativeRow>` for each
- Styling: bg-gray-50/50 rounded-lg border border-gray-100 mb-2, trigger padding p-3

**5. `src/components/objectives/initiative-row.tsx`** (Client Component - Initiative level)
- Props: `{ initiative: Initiative, onClick: () => void }`
- Import `formatStatus, getStatusColor, formatDepartment, formatTeamMember, cn` from `@/lib/utils`
- Render a clickable row (div with onClick and cursor-pointer hover:bg-blue-50/50 transition)
- Layout: flex items-start gap-3 p-3 rounded-lg
- Left: sequence number as small gray circle badge
- Center (flex-1): title in font-medium text-gray-900 with NO truncation (no `truncate`, no `line-clamp`, no `text-ellipsis`, no `overflow-hidden` on title). Title MUST wrap naturally.
- Below title: row of metadata -- department badge, owner name, date range
- Right: status badge using `formatStatus` + `getStatusColor`
- CRITICAL: Do NOT add `truncate` or any text overflow classes to the title. VIEW-05 requires full text wrapping.

**Styling guidance:**
- Match the glassmorphic style used in kanban-board.tsx: white backgrounds, subtle borders, rounded corners
- Use responsive padding: `p-3 md:p-4` on major sections
- Mobile indentation: Objective level `pl-0`, KR level `pl-2 md:pl-4`, Initiative `pl-2 md:pl-6`
  </action>
  <verify>
1. Run `npx next build` to verify no TypeScript or build errors
2. Run `curl http://localhost:3000/objectives` (after dev server start) to confirm page loads
3. Visually confirm: objectives/page.tsx has `export const dynamic = 'force-dynamic'`
4. Grep for `truncate` in initiative-row.tsx -- must NOT appear
5. Check that initiative-group-utils.ts `groupInitiativesByObjective` is imported in objective-hierarchy.tsx
  </verify>
  <done>
- /objectives route renders all initiatives in Objective > Key Result > Initiative hierarchy
- Each Objective header shows count + status summary (In Progress, At Risk, Completed counts)
- Each Key Result header shows count + status summary
- All sections expand/collapse independently via Collapsible
- Expand state uses useState<Set> (not derived from data), persists across re-renders
- Initiative titles display with full text wrapping, no truncation
- Clicking an initiative row opens InitiativeDetailSheet
  </done>
</task>

<task type="auto">
  <name>Task 2: Update sidebar and mobile sidebar navigation</name>
  <files>
    src/components/layout/sidebar.tsx
    src/components/layout/mobile-sidebar.tsx
  </files>
  <action>
**1. `src/components/layout/sidebar.tsx`**
- In the `navigation` array (line 24), add a new entry as the SECOND item (after Dashboard, before Timeline):
  `{ name: 'By Objective', href: '/objectives', icon: Target }`
- `Target` is already imported (line 13). No new import needed.
- The navigation array should become:
  ```
  { name: 'Dashboard', href: '/', icon: LayoutDashboard },
  { name: 'By Objective', href: '/objectives', icon: Target },
  { name: 'Timeline', href: '/timeline', icon: GanttChart },
  { name: 'Kanban', href: '/kanban', icon: KanbanSquare },
  { name: 'Calendar', href: '/calendar', icon: Calendar },
  { name: 'Initiatives', href: '/initiatives', icon: ListTodo },
  { name: 'Events to Attend', href: '/events', icon: Ticket },
  ```

**2. `src/components/layout/mobile-sidebar.tsx`**
- In the `navigation` array (line 26), add the same entry as the SECOND item:
  `{ name: 'By Objective', href: '/objectives', icon: Target }`
- `Target` is already imported (line 7). No new import needed.
- The navigation array should become:
  ```
  { name: 'Dashboard', href: '/', icon: LayoutDashboard },
  { name: 'By Objective', href: '/objectives', icon: Target },
  { name: 'Timeline', href: '/timeline', icon: GanttChart },
  { name: 'Kanban', href: '/kanban', icon: KanbanSquare },
  { name: 'Calendar', href: '/calendar', icon: Calendar },
  { name: 'Initiatives', href: '/initiatives', icon: ListTodo },
  { name: 'Events to Attend', href: '/events', icon: Ticket },
  ```

NOTE: Do NOT modify mobile-nav.tsx (bottom tab bar) -- it only has 4 items and adding more would overcrowd it.
  </action>
  <verify>
1. Grep for "By Objective" in sidebar.tsx -- must appear
2. Grep for "By Objective" in mobile-sidebar.tsx -- must appear
3. Grep for "/objectives" in sidebar.tsx -- must appear
4. Confirm Target icon is still imported (no duplicate imports)
  </verify>
  <done>
- Sidebar shows "By Objective" as second nav item with Target icon
- Mobile sidebar shows "By Objective" as second nav item with Target icon
- Clicking "By Objective" navigates to /objectives
- Active state correctly highlights when on /objectives route
  </done>
</task>

</tasks>

<verification>
1. `npx next build` completes without errors
2. Navigate to /objectives -- page loads with hierarchy view
3. Both Objectives (Obj 1 and Obj 2) visible with expand/collapse
4. Status summary visible in Objective and KR headers
5. Clicking chevron collapses/expands sections independently
6. Initiative titles wrap fully (no truncation)
7. Clicking an initiative opens the detail sheet
8. Sidebar shows "By Objective" nav item and highlights when active
9. Mobile sidebar shows "By Objective" nav item
</verification>

<success_criteria>
- VIEW-01: Initiatives grouped by Objective > Key Result > Initiative hierarchy
- VIEW-02: /objectives is a navigable route (default view integration in plan 39-02)
- VIEW-03: Headers show initiative count AND status summary
- VIEW-04: Expand/collapse works with state persistence
- VIEW-05: Full text wrapping on initiative titles
</success_criteria>

<output>
After completion, create `.planning/phases/39-by-objective-hierarchy-view/39-01-SUMMARY.md`
</output>
