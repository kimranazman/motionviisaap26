---
phase: 49-okr-hierarchy-ui
plan: 02
type: execute
wave: 2
depends_on: ["49-01"]
files_modified:
  - src/components/initiatives/initiative-form.tsx
  - src/components/initiatives/initiative-detail.tsx
  - src/components/initiatives/initiatives-list.tsx
  - src/components/kanban/initiative-detail-sheet.tsx
  - src/app/(dashboard)/initiatives/page.tsx
  - src/app/(dashboard)/initiatives/[id]/page.tsx
autonomous: true

must_haves:
  truths:
    - "Initiative create/edit form uses a KeyResult dropdown (select from existing KRs) instead of free-text input"
    - "Initiative form includes budget and resources fields and removes monthlyObjective/weeklyTasks"
    - "Initiative detail view shows linked KeyResult info, budget, resources -- no KPI section"
    - "Initiative detail sheet (side panel) removes KPI Tracking section, shows KR badge from relation"
  artifacts:
    - path: "src/components/initiatives/initiative-form.tsx"
      provides: "Form with KR select dropdown, budget, resources fields"
      contains: "keyResultId"
    - path: "src/components/kanban/initiative-detail-sheet.tsx"
      provides: "Detail sheet without KPI section"
    - path: "src/components/initiatives/initiative-detail.tsx"
      provides: "Detail page showing KR info and budget"
  key_links:
    - from: "src/components/initiatives/initiative-form.tsx"
      to: "/api/key-results"
      via: "fetch to populate KR dropdown"
      pattern: "api/key-results"
    - from: "src/components/initiatives/initiative-form.tsx"
      to: "/api/initiatives"
      via: "POST/PUT with keyResultId (not keyResult string)"
      pattern: "keyResultId"
    - from: "src/components/kanban/initiative-detail-sheet.tsx"
      to: "/api/initiatives/[id]"
      via: "fetch on open -- response now includes keyResult relation"
      pattern: "keyResult"
---

<objective>
Update initiative forms and detail views for v2.0: replace free-text keyResult input with KR select dropdown, add budget/resources fields, remove KPI sections, and update all initiative list/detail pages to use the FK relation.

Purpose: Completes UI-OKR-04 (forms), UI-OKR-05 (detail view), and partially UI-OKR-06/07 (form and detail sheet files from Appendix A/B).
Output: Working initiative create/edit forms with KR dropdown, updated detail views without KPI.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/48-api-layer-utilities/48-02-SUMMARY.md

Key prior decisions:
- API POST /api/initiatives accepts `keyResultId` (string cuid), not `keyResult` (string)
- API GET /api/initiatives/[id] includes `keyResult: { select: { id, krId, description } }` in response
- API PATCH /api/initiatives/[id] no longer handles KPI fields
- Budget is String (may contain non-numeric text), resources is String
- GET /api/key-results returns all 6 KRs with id, krId, description

Plan 01 updated the Initiative interface in objective-hierarchy.tsx. This plan must use a COMPATIBLE interface shape (keyResult as relation object, not string).
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update initiative form with KR dropdown, budget/resources, remove obsolete fields</name>
  <files>
    src/components/initiatives/initiative-form.tsx
  </files>
  <action>
1. Update the local Initiative interface:
   - Remove `keyResult: string` -- replace with `keyResultId: string | null`
   - Remove `monthlyObjective`, `weeklyTasks` (these fields no longer exist on the model)
   - Add `budget: string | null` and `resources: string | null`
   - Keep `resourcesFinancial` and `resourcesNonFinancial` for now (they still exist on schema)

2. Add state for KR options:
   ```tsx
   const [keyResults, setKeyResults] = useState<Array<{ id: string; krId: string; description: string }>>([])
   ```
   Add a useEffect to fetch KR options on mount:
   ```tsx
   useEffect(() => {
     fetch('/api/key-results')
       .then(res => res.json())
       .then(data => setKeyResults(data))
       .catch(console.error)
   }, [])
   ```

3. Update formData initial state:
   - Change `keyResult: initiative?.keyResult || ''` to `keyResultId: initiative?.keyResultId || ''`
   - Remove monthlyObjective, weeklyTasks
   - Add `budget: initiative?.budget || ''` and `resources: initiative?.resources || ''`

4. Replace the Key Result `<Input>` (line 127-136) with a `<Select>` dropdown:
   ```tsx
   <Select
     value={formData.keyResultId || ''}
     onValueChange={(value) => setFormData({ ...formData, keyResultId: value || null })}
   >
     <SelectTrigger>
       <SelectValue placeholder="Select Key Result" />
     </SelectTrigger>
     <SelectContent>
       {keyResults.map((kr) => (
         <SelectItem key={kr.id} value={kr.id}>
           {kr.krId} - {kr.description}
         </SelectItem>
       ))}
     </SelectContent>
   </Select>
   ```

5. Remove the Monthly Objective textarea (Row 6) and Weekly Tasks textarea (Row 7)

6. Replace Resources (Financial) and Resources (Non-Financial) with:
   - Budget: `<Input value={formData.budget || ''} onChange={...} placeholder="e.g., 1400" />`
   - Resources: `<Input value={formData.resources || ''} onChange={...} placeholder="e.g., Design team, Canva Pro" />`
   Keep the existing resourcesFinancial/resourcesNonFinancial fields in the submitted data for backward compat, OR map budget/resources to the JSON body. Since the API now expects `budget` and `resources` fields, use those.

7. In handleSubmit, the JSON body should include `keyResultId` (not `keyResult`), `budget`, `resources`. Do NOT include monthlyObjective, weeklyTasks, or KPI fields.
  </action>
  <verify>
Run `npx tsc --noEmit 2>&1 | grep "initiative-form" | head -10` -- should show 0 errors.
  </verify>
  <done>
Initiative form uses KR select dropdown populated from /api/key-results. Budget and resources fields present. monthlyObjective, weeklyTasks, and KPI fields removed from form.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update initiative detail, detail sheet, list, and page server components</name>
  <files>
    src/components/initiatives/initiative-detail.tsx
    src/components/initiatives/initiatives-list.tsx
    src/components/kanban/initiative-detail-sheet.tsx
    src/app/(dashboard)/initiatives/page.tsx
    src/app/(dashboard)/initiatives/[id]/page.tsx
  </files>
  <action>
**initiative-detail.tsx:**
1. Update the Initiative interface:
   - Change `keyResult: string` to `keyResultId?: string | null` and `keyResult?: { id: string; krId: string; description: string } | null`
   - Remove `monthlyObjective`, `weeklyTasks` (no longer on model)
   - Add `budget?: string | null` and `resources?: string | null`
2. Update the header Badge: change `{initiative.keyResult}` to `{initiative.keyResult?.krId || 'Unlinked'}`
3. Update the Key Result read-only display: show `{initiative.keyResult?.krId} - {initiative.keyResult?.description}` instead of just the Badge
4. Add Budget and Resources display fields in the Details card grid:
   - Budget: display `initiative.budget || '-'`
   - Resources: display `initiative.resources || '-'`

**initiatives-list.tsx:**
1. Update the Initiative interface:
   - Change `keyResult: string` to `keyResultId?: string | null` and `keyResult?: { id: string; krId: string; description: string } | null`
2. Fix the search filter: change `initiative.keyResult.toLowerCase()` to `(initiative.keyResult?.krId || '').toLowerCase()`
3. Fix the Badge display in the table: change `{initiative.keyResult}` to `{initiative.keyResult?.krId || '-'}`

**initiative-detail-sheet.tsx:**
1. Update the Initiative interface:
   - Change `keyResult: string` to `keyResultId?: string | null` and `keyResult?: { id: string; krId: string; description: string } | null`
   - Remove KPI fields: `kpiLabel`, `kpiTarget`, `kpiActual`, `kpiUnit`, `kpiManualOverride`
2. Remove ALL KPI state variables: `kpiLabel`, `kpiTarget`, `kpiActual`, `kpiUnit`, `kpiManualOverride`, `showOverrideConfirm`, `pendingActual`, `loadedKpi`
3. Remove KPI-related functions: `handleKpiActualChange`, `handleConfirmOverride`, `handleCancelOverride`, `handleRevertToAuto`
4. In the useEffect data fetch, remove KPI initialization lines
5. In handleSave, remove KPI fields from the PATCH body (kpiLabel, kpiTarget, kpiActual, kpiUnit, kpiManualOverride)
6. Remove the hasChanges KPI comparisons (kpiLabel !== loadedKpi.label, etc.)
7. Remove the entire "KPI Tracking Section" JSX block (from `{/* KPI Tracking Section */}` through the closing `</div>` of that section, approximately lines 457-541)
8. Remove the `AlertDialog` for override confirmation
9. Remove unused imports: `BarChart3`, `RotateCcw`, `AlertDialog*`, `Input` (if only used for KPI)
10. Update the title Badge: change `{initiative.keyResult}` to `{initiative.keyResult?.krId || 'Unlinked'}`

**initiatives/page.tsx (server component):**
1. Update the Prisma query to use `select` instead of bare `findMany`:
   Add select fields including `keyResultId: true` and `keyResult: { select: { id: true, krId: true, description: true } }`
   This ensures the relation is included in the response.

**initiatives/[id]/page.tsx (server component):**
1. Add `keyResult: { select: { id: true, krId: true, description: true } }` to the Prisma include
2. Add `budget: true, resources: true` to ensure these fields are passed through
  </action>
  <verify>
Run `npx tsc --noEmit 2>&1 | grep -E "initiative-detail|initiatives-list|initiative-detail-sheet|initiatives/page|initiatives/\\[id\\]" | head -20` -- should show 0 errors for these files.
  </verify>
  <done>
- Initiative detail view shows linked KR info (krId + description), budget, resources; no KPI section
- Initiative detail sheet (side panel) has no KPI Tracking section, shows KR badge from relation
- Initiatives list page includes keyResult relation for display and search
- All KPI state, handlers, and UI removed from detail sheet
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes for all 6 modified files
2. Initiative create form shows a KR dropdown (not free text input)
3. Initiative detail page shows linked KR, budget, resources
4. Initiative detail sheet (side panel) has NO KPI Tracking section
5. Initiatives list table shows KR code from relation
</verification>

<success_criteria>
- UI-OKR-04: Forms use KR dropdown with budget/resources fields, no KPI fields
- UI-OKR-05: Detail views show linked KR info, budget, resources, no KPI section
- UI-OKR-06 partial: initiative-form, initiative-detail, initiatives-list, initiative-detail-sheet updated
- UI-OKR-07 partial: initiative-detail-sheet KPI section removed
</success_criteria>

<output>
After completion, create `.planning/phases/49-okr-hierarchy-ui/49-02-SUMMARY.md`
</output>
