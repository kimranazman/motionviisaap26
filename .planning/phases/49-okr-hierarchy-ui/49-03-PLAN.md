---
phase: 49-okr-hierarchy-ui
plan: 03
type: execute
wave: 2
depends_on: ["49-01"]
files_modified:
  - src/app/(dashboard)/kanban/page.tsx
  - src/app/(dashboard)/calendar/page.tsx
  - src/app/(dashboard)/timeline/page.tsx
  - src/components/kanban/kanban-board.tsx
  - src/components/kanban/kanban-card.tsx
  - src/components/kanban/kanban-filter-bar.tsx
  - src/components/kanban/kanban-swimlane-view.tsx
  - src/components/timeline/gantt-chart.tsx
  - src/components/calendar/calendar-view.tsx
autonomous: true

must_haves:
  truths:
    - "Kanban board displays KR code from relation (not [object Object])"
    - "Kanban filter dropdown shows KR codes correctly"
    - "Calendar tooltip shows KR code from relation"
    - "Gantt chart shows KR code badge from relation"
    - "Swimlane view shows KR code from relation"
    - "All 3 page server components include keyResult relation in Prisma query"
  artifacts:
    - path: "src/app/(dashboard)/kanban/page.tsx"
      provides: "Server component with keyResult relation select"
      contains: "keyResult:"
    - path: "src/components/kanban/kanban-board.tsx"
      provides: "Board with KR string extracted from relation"
      contains: "krId"
    - path: "src/components/calendar/calendar-view.tsx"
      provides: "Calendar with KR string from relation"
      contains: "krId"
  key_links:
    - from: "src/app/(dashboard)/kanban/page.tsx"
      to: "src/components/kanban/kanban-board.tsx"
      via: "initialData with keyResult relation flattened to keyResultCode"
      pattern: "keyResultCode|keyResult.*krId"
    - from: "src/components/kanban/kanban-board.tsx"
      to: "src/components/kanban/kanban-filter-bar.tsx"
      via: "keyResults array of strings for filter dropdown"
      pattern: "keyResults"
---

<objective>
Update all remaining views (kanban, calendar, timeline) to use the keyResult FK relation instead of the old string field. This covers the remaining files from Pitfalls Appendix A (files 9-11, 19-24) and ensures no view shows [object Object] for keyResult.

Purpose: Completes UI-OKR-06 (remaining 9 files from Appendix A that reference keyResult as string).
Output: All views correctly display KR codes from the relation; no string keyResult references remain in source.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

Key context:
- The Prisma schema has `keyResult` as a RELATION (not string). `select: { keyResult: true }` returns the full KeyResult object or null.
- For display, components need the string code like "KR1.1" which is `keyResult.krId`.
- The cleanest approach: In page server components, flatten `keyResult?.krId` into the serialized output so client components receive a simple string.
- This avoids changing every client component's interface deeply -- just change the source of the string.

Strategy for this plan: Each page server component will select the keyResult relation and flatten `keyResult?.krId || 'Unlinked'` into a field called `keyResultCode: string`. Client components will use `keyResultCode` instead of the old `keyResult` string. This minimizes changes in client components to just renaming the field.

ALTERNATIVE simpler strategy: Keep the field name `keyResult` but populate it with the string from the relation. This way client components need ZERO interface changes -- only the server component mapping changes. Use this approach since it is lowest-risk.
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update kanban, calendar, timeline page server components</name>
  <files>
    src/app/(dashboard)/kanban/page.tsx
    src/app/(dashboard)/calendar/page.tsx
    src/app/(dashboard)/timeline/page.tsx
  </files>
  <action>
For ALL THREE page server components, apply the same pattern:

1. Change the Prisma select from `keyResult: true` to:
   ```typescript
   keyResult: { select: { krId: true } },
   ```
   This returns `keyResult: { krId: string } | null` instead of the old string field.

2. In the serialization `.map()`, flatten the relation back to a string:
   ```typescript
   keyResult: i.keyResult?.krId || 'Unlinked',
   ```
   This produces the SAME shape that client components expect (`keyResult: string`), so NO client component changes are needed for these views.

**kanban/page.tsx specifically:**
- Current select includes `keyResult: true` -- change to `keyResult: { select: { krId: true } }`
- In the map, add: `keyResult: i.keyResult?.krId || 'Unlinked'`
- Spread the rest as before but note the `keyResult` from Prisma is now an object, so put the string override AFTER the spread: `{ ...i, startDate: ..., endDate: ..., keyResult: i.keyResult?.krId || 'Unlinked' }`

**calendar/page.tsx specifically:**
- Same pattern. Current select includes `keyResult: true`
- In the map: `keyResult: i.keyResult?.krId || 'Unlinked'`

**timeline/page.tsx specifically:**
- Same pattern. Current select includes `keyResult: true`
- In the map: `keyResult: i.keyResult?.krId || 'Unlinked'`

This approach means kanban-board.tsx, kanban-card.tsx, kanban-filter-bar.tsx, kanban-swimlane-view.tsx, gantt-chart.tsx, and calendar-view.tsx need NO interface changes since they already expect `keyResult: string`.
  </action>
  <verify>
Run `npx tsc --noEmit 2>&1 | grep -E "kanban/page|calendar/page|timeline/page" | head -10` -- should show 0 errors.
  </verify>
  <done>
All 3 page server components select keyResult relation and flatten to string for client components. Client components receive the same `keyResult: string` shape they expect.
  </done>
</task>

<task type="auto">
  <name>Task 2: Verify client components compile and do full TypeScript check</name>
  <files>
    src/components/kanban/kanban-board.tsx
    src/components/kanban/kanban-card.tsx
    src/components/kanban/kanban-filter-bar.tsx
    src/components/kanban/kanban-swimlane-view.tsx
    src/components/timeline/gantt-chart.tsx
    src/components/calendar/calendar-view.tsx
  </files>
  <action>
1. Run `npx tsc --noEmit` to verify ALL files across the project compile cleanly. Since server components now pass `keyResult: string` (flattened from relation), client components should compile without changes.

2. If there are ANY remaining TypeScript errors related to `keyResult` being a relation object instead of string in ANY file, fix them by:
   - If the error is in a server component: ensure the relation is flattened in the serialization map
   - If the error is in a client component: ensure the interface matches what the server sends

3. Check for any remaining references to old KPI fields in the codebase that would cause build errors:
   ```bash
   grep -rn "kpiLabel\|kpiTarget\|kpiActual\|kpiUnit\|kpiManualOverride" src/ --include="*.tsx" --include="*.ts" | grep -v "kpi-utils\|kpi-progress-bar\|node_modules"
   ```
   Any hits outside of `initiative-kpi-utils.ts` and `kpi-progress-bar.tsx` (which are stubs/deprecated) need to be investigated. If they are in files modified by Plan 01 or Plan 02, they should already be fixed. If they are in OTHER files, fix them here.

4. Specifically verify that `kanban-board.tsx` line 199 (`initiatives.map(i => i.keyResult)`) still works -- it should since we're passing `keyResult: string` from the server component.

5. Run `npm run build` to verify the full Next.js build passes. This catches both TypeScript and runtime import issues.
  </action>
  <verify>
`npm run build` completes successfully with 0 errors. All pages compile.
  </verify>
  <done>
- Full TypeScript compilation passes
- Full Next.js build passes
- All kanban, calendar, timeline, and gantt views display KR codes correctly
- No [object Object] displayed anywhere
- UI-OKR-06 complete: all 22+ files referencing keyResult as string are updated
- UI-OKR-07 complete: all files referencing KPI fields are updated or cleaned (stubs remain for Phase 52)
  </done>
</task>

</tasks>

<verification>
1. `npm run build` passes with 0 errors
2. `npx tsc --noEmit` passes with 0 errors
3. grep for `keyResult: true` in page server components returns 0 results (all should use relation select)
4. grep for `.keyResult` in client components returns only valid usages (string display, not relation object access)
5. No remaining build-breaking KPI field references outside of the stub utility file
</verification>

<success_criteria>
- UI-OKR-06: All files that referenced keyResult as string are updated to use FK relation (flattened at server layer)
- UI-OKR-07: All files that referenced KPI fields are updated or using stubs
- Full project builds successfully (`npm run build` passes)
- No [object Object] displayed in any view
</success_criteria>

<output>
After completion, create `.planning/phases/49-okr-hierarchy-ui/49-03-SUMMARY.md`
</output>
