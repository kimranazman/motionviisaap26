---
phase: 49-okr-hierarchy-ui
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/app/(dashboard)/objectives/page.tsx
  - src/components/objectives/objective-hierarchy.tsx
  - src/components/objectives/objective-group.tsx
  - src/components/objectives/key-result-group.tsx
  - src/components/objectives/initiative-row.tsx
autonomous: true

must_haves:
  truths:
    - "KeyResult rows in By Objective view show description, target vs actual, progress bar, unit, status badge, owner, deadline"
    - "Objective headers show weighted rollup progress from child KR weights and progress"
    - "Initiative rows show title, department, person in charge, status, dates, budget -- no KPI progress bars"
  artifacts:
    - path: "src/app/(dashboard)/objectives/page.tsx"
      provides: "Server component fetching initiatives with keyResult relation + KR data"
      contains: "keyResult:"
    - path: "src/components/objectives/key-result-group.tsx"
      provides: "KR row with metrics display"
      contains: "progress"
    - path: "src/components/objectives/initiative-row.tsx"
      provides: "Simplified initiative row without KPI"
  key_links:
    - from: "src/app/(dashboard)/objectives/page.tsx"
      to: "src/components/objectives/objective-hierarchy.tsx"
      via: "initialData prop with keyResult relation included"
      pattern: "keyResult.*select"
    - from: "src/components/objectives/objective-group.tsx"
      to: "src/lib/kr-progress-utils.ts"
      via: "calculateObjectiveProgress import"
      pattern: "calculateObjectiveProgress"
    - from: "src/components/objectives/key-result-group.tsx"
      to: "GroupedKeyResult"
      via: "krId display + KR metrics from API data"
      pattern: "krId|target|actual|progress"
---

<objective>
Overhaul the By Objective view to display real KR-level metrics instead of aggregated initiative KPIs. KeyResult rows show target, actual, progress bar, status, owner, deadline. Objective headers show weighted rollup progress. Initiative rows are simplified (no KPI progress bars).

Purpose: This is the core UI change for Phase 49 -- the objectives page is the primary OKR view and currently broken (TS errors from Phase 48 grouping utility changes).
Output: Working objectives page with KR metrics, objective rollup progress, and simplified initiative rows.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/48-api-layer-utilities/48-03-SUMMARY.md

Key prior decisions:
- GroupedKeyResult interface now has `krId: string` and `keyResultId: string | null` (no longer `keyResult: string`)
- KPI utils are stubbed (return safe defaults) -- safe to remove imports now
- calculateObjectiveProgress exists in src/lib/kr-progress-utils.ts
- API GET /api/key-results returns KRs with initiative counts, target, actual, progress, weight, etc.
- keyResultId is String (cuid), not Int

Important: The Prisma schema has `keyResult` as a RELATION field (not string). When selecting `keyResult: true` in Prisma, it returns the related KeyResult object (or null), not a string. Server components must include the relation and flatten as needed.
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update objectives page server component and hierarchy component</name>
  <files>
    src/app/(dashboard)/objectives/page.tsx
    src/components/objectives/objective-hierarchy.tsx
  </files>
  <action>
**objectives/page.tsx:**
1. Rewrite the Prisma query to include the keyResult relation and remove KPI fields:
   - Change `keyResult: true` to `keyResult: { select: { id: true, krId: true, description: true, target: true, actual: true, unit: true, progress: true, deadline: true, status: true, owner: true, weight: true } }`
   - Add `keyResultId: true` to the select
   - Remove: `kpiLabel: true`, `kpiTarget: true`, `kpiActual: true`, `kpiUnit: true`, `kpiManualOverride: true`
   - Add `budget: true` to the select
   - Keep orderBy but change `keyResult: 'asc'` to `keyResultId: 'asc'` (since keyResult is now a relation, not orderable as string)
2. In the serialization map, remove the kpiTarget/kpiActual Number conversions
3. Serialize keyResult Decimal fields: target, actual, progress, weight to Number (if keyResult exists)

**objective-hierarchy.tsx:**
1. Update the Initiative interface to match the new data shape:
   - Remove `keyResult: string` -- replace with `keyResultId: string | null` and `keyResult: { id: string; krId: string; description: string; target: number; actual: number; unit: string; progress: number; deadline: string; status: string; owner: string; weight: number } | null`
   - Remove all KPI fields (kpiLabel, kpiTarget, kpiActual, kpiUnit, kpiManualOverride)
   - Add `budget: string | null`
2. Fix the expandedKRs initialization: change `kr.keyResult` to `kr.krId` in the Set key construction (`g.objective + ':' + kr.krId`)
3. The groupInitiativesByObjective call should work as-is since Phase 48 already updated the utility to accept the new shape
  </action>
  <verify>
Run `npx tsc --noEmit 2>&1 | grep -E "objectives/page|objective-hierarchy" | head -20` to check for TS errors in these files. Should show 0 errors for these files (may still show errors in files not yet updated -- that is expected).
  </verify>
  <done>
Objectives page server component fetches initiatives with full KeyResult relation data (no KPI fields). Hierarchy component has updated Initiative interface matching new data shape.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update objective-group, key-result-group, and initiative-row components</name>
  <files>
    src/components/objectives/objective-group.tsx
    src/components/objectives/key-result-group.tsx
    src/components/objectives/initiative-row.tsx
  </files>
  <action>
**objective-group.tsx:**
1. Remove `import { aggregateKpiTotals } from '@/lib/initiative-kpi-utils'`
2. Add `import { calculateObjectiveProgress } from '@/lib/kr-progress-utils'`
3. Remove all KPI aggregation logic (lines building kpiAgg, kpiColorClass, and the kpiAgg.hasData JSX)
4. Replace with objective rollup progress:
   - Extract KR progress data from the group: `const krProgressData = group.keyResults.filter(kr => kr.keyResultId).map(kr => ({ progress: /* need to access from initiatives */ }))` -- BUT the GroupedKeyResult does not carry KR metrics currently.
   - SOLUTION: Since the objectives page now passes initiatives with full keyResult relation data, access it through the initiatives. Collect unique KRs: iterate `group.keyResults`, for each get first initiative's `keyResult` relation object (which has progress + weight). Build array of `{ progress, weight }` and pass to `calculateObjectiveProgress()`.
   - Display as: `<span>Progress: {Math.round(objectiveProgress)}%</span>` with a small progress bar (using Progress component from ui)
5. Fix `key={kr.keyResult}` to `key={kr.krId}` on the KeyResultGroup mapping
6. Fix `expandedKRs.has(group.objective + ':' + kr.keyResult)` to `expandedKRs.has(group.objective + ':' + kr.krId)` (two references: isExpanded and onToggle)

**key-result-group.tsx:**
1. Remove `import { aggregateKpiTotals } from '@/lib/initiative-kpi-utils'`
2. Remove all KPI aggregation logic (kpiAgg, kpiColorClass, kpiAgg.hasData JSX)
3. Replace the `{keyResult.keyResult}` display text with `{keyResult.krId}` (the KR code like "KR1.1")
4. Add KR metrics display in the header: Get the KR data from the first initiative's keyResult relation object. Display:
   - Description (truncated if long)
   - Target vs Actual: `{actual}/{target} {unit}`
   - Progress bar (small, inline): use the Progress component
   - Status badge
   - Owner
   - Deadline
5. Access KR data: Since GroupedKeyResult contains `initiatives[]` and each initiative has a `keyResult` relation with full metrics, get it from: `const krData = keyResult.initiatives[0]?.keyResult` (cast through the Initiative type from objective-hierarchy). Check null safety.

**initiative-row.tsx:**
1. Remove `import { KpiProgressBar } from '@/components/objectives/kpi-progress-bar'`
2. Remove `import { calculateKpi, type InitiativeWithKpiAndProjects } from '@/lib/initiative-kpi-utils'`
3. Remove all KPI calculation logic (the kpiInput object and calculateKpi call)
4. Remove the `<KpiProgressBar>` JSX element
5. Add budget display: if `initiative.budget` exists, show it in the metadata row as a badge: `<span className="inline-flex items-center rounded bg-green-50 px-1.5 py-0.5 text-green-700">RM {initiative.budget}</span>`
6. The initiative row should now show: sequence number, title, date badges, metadata (department, person, date range, project count, budget)
  </action>
  <verify>
Run `npx tsc --noEmit 2>&1 | grep -E "objective-group|key-result-group|initiative-row" | head -20` to check for TS errors. Then verify the objectives page renders: `curl -s http://localhost:3000/objectives | head -50` (or just check build succeeds).
  </verify>
  <done>
- Objective headers show weighted rollup progress percentage (from calculateObjectiveProgress)
- KR rows show: krId label, description, target/actual/unit, progress bar, status badge, owner, deadline
- Initiative rows show: title, department, PIC, status, dates, budget -- NO KPI progress bars
- All KPI utility imports removed from these 3 components
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes for the 5 modified files (other files may still have errors -- those are Plan 02/03 scope)
2. The objectives page loads and shows the OKR hierarchy with KR-level metrics
3. No KPI progress bars visible on initiative rows
4. Objective headers show a progress percentage
5. KR headers show target, actual, progress, status, owner, deadline
</verification>

<success_criteria>
- UI-OKR-01: KR rows display description, target, actual, progress bar, unit, status badge, owner, deadline
- UI-OKR-02: Objective headers show weighted rollup progress
- UI-OKR-03: Initiative rows simplified (no KPI bars), show budget if present
- All aggregateKpiTotals and calculateKpi imports removed from objective view components
</success_criteria>

<output>
After completion, create `.planning/phases/49-okr-hierarchy-ui/49-01-SUMMARY.md`
</output>
