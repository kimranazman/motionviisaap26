# Plan 64-02: Subtask Creation from Task Detail View

## Frontmatter

- **Phase**: 64 - Task Creation on /tasks
- **Plan**: 02 of 02
- **Wave**: 2
- **Depends on**: 64-01
- **Files modified**:
  - `src/components/projects/task-detail-sheet.tsx` (modify)
- **Autonomous**: yes

## Objective

Add the ability to create subtasks directly from the task detail sheet. When viewing a task's details, users can click "Add Subtask" to inline-create a child task. The subtask is linked to the same project as the parent and has a bidirectional parent-child relationship.

## Requirements Covered

- **TASK-03**: User can create subtasks from task detail view with correct bidirectional parent-child link

## Tasks

<task id="1">
<title>Add subtask creation to task detail sheet</title>
<details>
Modify `src/components/projects/task-detail-sheet.tsx` to add subtask creation capability.

**Implementation:**

1. **Add state for subtask creation**:
```typescript
const [showSubtaskForm, setShowSubtaskForm] = useState(false)
const [subtaskTitle, setSubtaskTitle] = useState('')
const [isCreatingSubtask, setIsCreatingSubtask] = useState(false)
```

2. **Reset subtask form when task changes**:
In the existing `useEffect` that initializes form values, add:
```typescript
setShowSubtaskForm(false)
setSubtaskTitle('')
```

3. **Add subtask creation handler**:
```typescript
const handleCreateSubtask = async () => {
  if (!task || !subtaskTitle.trim()) return
  setIsCreatingSubtask(true)
  try {
    const response = await fetch(`/api/projects/${projectId}/tasks`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        title: subtaskTitle.trim(),
        parentId: task.id,
      }),
    })
    if (response.ok) {
      setSubtaskTitle('')
      setShowSubtaskForm(false)
      onTaskUpdate()
    }
  } catch (error) {
    console.error('Failed to create subtask:', error)
  } finally {
    setIsCreatingSubtask(false)
  }
}
```

4. **Import canAddSubtask** from `@/lib/task-utils`:
```typescript
import { canAddSubtask } from '@/lib/task-utils'
```

5. **Determine if subtask can be added**. The task detail sheet needs access to `depth`. Update the `Task` interface in the file to include optional `depth`:
```typescript
interface Task {
  id: string
  title: string
  description: string | null
  status: 'TODO' | 'IN_PROGRESS' | 'DONE'
  priority: 'LOW' | 'MEDIUM' | 'HIGH'
  dueDate: string | null
  assignee: string | null
  projectId: string
  parentId: string | null
  depth?: number
  tags?: TaskTag[]
}
```

Use `canAddSubtask(task.depth ?? 0)` to determine if the button should appear.

6. **Add UI between Tags and Separator sections** in the JSX. Place a "Subtasks" section:

```tsx
{/* Subtasks Section */}
{canAddSubtask(task.depth ?? 0) && (
  <div className="space-y-2">
    <div className="flex items-center justify-between">
      <Label>Subtasks</Label>
      {!showSubtaskForm && (
        <Button
          variant="ghost"
          size="sm"
          onClick={() => setShowSubtaskForm(true)}
        >
          <Plus className="mr-1 h-4 w-4" />
          Add Subtask
        </Button>
      )}
    </div>
    {showSubtaskForm && (
      <div className="flex gap-2">
        <Input
          value={subtaskTitle}
          onChange={(e) => setSubtaskTitle(e.target.value)}
          placeholder="Subtask title..."
          autoFocus
          onKeyDown={(e) => {
            if (e.key === 'Enter' && subtaskTitle.trim()) {
              handleCreateSubtask()
            }
            if (e.key === 'Escape') {
              setShowSubtaskForm(false)
              setSubtaskTitle('')
            }
          }}
        />
        <Button
          size="sm"
          onClick={handleCreateSubtask}
          disabled={!subtaskTitle.trim() || isCreatingSubtask}
        >
          {isCreatingSubtask ? 'Adding...' : 'Add'}
        </Button>
        <Button
          variant="ghost"
          size="sm"
          onClick={() => {
            setShowSubtaskForm(false)
            setSubtaskTitle('')
          }}
        >
          Cancel
        </Button>
      </div>
    )}
  </div>
)}
```

7. **Update callers** that pass task to TaskDetailSheet to include `depth`:

In `src/components/tasks/tasks-page-client.tsx`, the task already has `parentId: null` hardcoded. Since tasks from /tasks page are all root tasks (parentId=null in the query), they have depth=0. The spread already passes all props, but we need to ensure depth is present. The `CrossProjectTask` interface does not include depth. We have two options:
- Option A: Add `depth` to `CrossProjectTask` and fetch it from the DB
- Option B: Default to `depth: 0` since /tasks only shows root tasks

**Choose Option A** for correctness - update the tasks page query and interface to include depth.

In `src/app/(dashboard)/tasks/page.tsx`, add `depth: t.depth` to the return mapping in `getAllTasks()`.

In `src/components/tasks/tasks-page-client.tsx`:
- Add `depth: number` to `CrossProjectTask` interface
- Update the TaskDetailSheet usage to pass depth: `task={{ ...selectedTask, parentId: null }}` already spreads depth since it's on selectedTask

In `src/components/projects/task-tree.tsx`, TaskDetailSheet is already called with the full `selectedTask` which includes depth from the Task type.
</details>
</task>

## Verification

After implementation, verify:

1. [ ] Task detail sheet shows "Add Subtask" button for tasks at depth < 4
2. [ ] Clicking "Add Subtask" shows inline input field
3. [ ] Entering title and pressing Enter or clicking Add creates a subtask
4. [ ] Subtask is linked to the correct parent (parentId = current task ID)
5. [ ] Subtask is linked to the same project as the parent
6. [ ] After creating subtask, task detail closes or refreshes to show updated data
7. [ ] Pressing Escape cancels subtask creation
8. [ ] "Add Subtask" button does NOT appear for tasks at max depth (depth >= 4)
9. [ ] TypeScript compiles without errors

## Must Haves

- "Add Subtask" button visible in task detail sheet for eligible tasks
- Subtask created with correct parentId (bidirectional link via existing schema)
- Subtask belongs to same project as parent task
- Quick inline creation (title + Enter) for efficient workflow
- Depth validation prevents creating subtasks beyond level 5
