# Plan 64-01: Add Task Dialog with Project Selector

## Frontmatter

- **Phase**: 64 - Task Creation on /tasks
- **Plan**: 01 of 02
- **Wave**: 1
- **Depends on**: Nothing
- **Files modified**:
  - `src/components/tasks/project-select.tsx` (new)
  - `src/components/tasks/tasks-page-client.tsx` (modify)
  - `src/app/(dashboard)/tasks/page.tsx` (modify)
- **Autonomous**: yes

## Objective

Add an "Add Task" button to the /tasks page toolbar that opens a Dialog with a task creation form. The form includes a required project selector (searchable combobox) so users can create tasks for any project directly from the cross-project tasks view.

## Requirements Covered

- **TASK-01**: User can create a task from the /tasks page via Add Task button
- **TASK-02**: Add Task dialog includes project selector (required) for linking task to a project

## Tasks

<task id="1">
<title>Create ProjectSelect combobox component</title>
<details>
Create `src/components/tasks/project-select.tsx` following the CompanySelect pattern at `src/components/pipeline/company-select.tsx`.

**Implementation:**
- Build a Popover + Command combobox component
- Props: `value: string | null`, `onValueChange: (projectId: string | null) => void`, `disabled?: boolean`, optional `projects?: { id: string; title: string }[]` prop to avoid fetching
- If `projects` prop is provided, use those directly (avoids extra API call since the page already has the list)
- If not provided, fetch from `/api/projects` on mount
- Use `shouldFilter={false}` on Command and filter manually (matching CompanySelect pattern)
- Search by project title
- Display: "Select project..." placeholder, project title as display text
- Show check icon for selected item

**Key differences from CompanySelect:**
- Uses `title` instead of `name` (projects have `title`)
- Placeholder text: "Select project..." / "Search projects..."
</details>
</task>

<task id="2">
<title>Update tasks page to fetch all projects</title>
<details>
Modify `src/app/(dashboard)/tasks/page.tsx`:

1. Add a new `getAllProjects()` function that fetches ALL projects (not just those with tasks):
```typescript
async function getAllProjects() {
  const projects = await prisma.project.findMany({
    select: { id: true, title: true },
    orderBy: { title: 'asc' },
  })
  return projects
}
```

2. Update the `Promise.all` to also call `getAllProjects()`:
```typescript
const [tasks, projects, allProjects] = await Promise.all([
  getAllTasks(),
  getProjects(),
  getAllProjects(),
])
```

3. Pass `allProjects` as a new prop to `TasksPageClient`:
```tsx
<TasksPageClient initialTasks={tasks} projects={projects} allProjects={allProjects} />
```

The existing `projects` (only those with tasks) continues to be used for the filter dropdown.
The new `allProjects` is used for the Add Task dialog's project selector.
</details>
</task>

<task id="3">
<title>Add task creation dialog to tasks-page-client</title>
<details>
Modify `src/components/tasks/tasks-page-client.tsx`:

1. **Add `allProjects` prop** to `TasksPageClientProps`:
```typescript
interface TasksPageClientProps {
  initialTasks: CrossProjectTask[]
  projects: ProjectOption[]
  allProjects: ProjectOption[]
}
```

2. **Add state for create dialog**:
```typescript
const [isCreateOpen, setIsCreateOpen] = useState(false)
const [newProjectId, setNewProjectId] = useState<string | null>(null)
const [newTitle, setNewTitle] = useState('')
const [newDescription, setNewDescription] = useState('')
const [newStatus, setNewStatus] = useState('TODO')
const [newPriority, setNewPriority] = useState('MEDIUM')
const [newDueDate, setNewDueDate] = useState('')
const [newAssignee, setNewAssignee] = useState('')
const [isCreating, setIsCreating] = useState(false)
const [createError, setCreateError] = useState<string | null>(null)
```

3. **Add create handler**:
```typescript
const handleCreateTask = async () => {
  if (!newProjectId || !newTitle.trim()) return
  setIsCreating(true)
  setCreateError(null)
  try {
    const response = await fetch(`/api/projects/${newProjectId}/tasks`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        title: newTitle.trim(),
        description: newDescription.trim() || null,
        status: newStatus,
        priority: newPriority,
        dueDate: newDueDate || null,
        assignee: newAssignee || null,
      }),
    })
    if (!response.ok) {
      const data = await response.json()
      setCreateError(data.error || 'Failed to create task')
      return
    }
    // Reset form and close
    setIsCreateOpen(false)
    resetCreateForm()
    router.refresh()
  } catch {
    setCreateError('Failed to create task')
  } finally {
    setIsCreating(false)
  }
}
```

4. **Add reset helper**:
```typescript
const resetCreateForm = () => {
  setNewProjectId(null)
  setNewTitle('')
  setNewDescription('')
  setNewStatus('TODO')
  setNewPriority('MEDIUM')
  setNewDueDate('')
  setNewAssignee('')
  setCreateError(null)
}
```

5. **Add Dialog UI** - Place the "Add Task" button in the toolbar area (between the filter bar and view toggle). Follow the department-list.tsx dialog pattern:

```tsx
<Dialog open={isCreateOpen} onOpenChange={(open) => {
  setIsCreateOpen(open)
  if (!open) resetCreateForm()
}}>
  <DialogTrigger asChild>
    <Button className="w-full sm:w-auto shrink-0">
      <Plus className="mr-2 h-4 w-4" />
      Add Task
    </Button>
  </DialogTrigger>
  <DialogContent className="max-w-md">
    <DialogHeader>
      <DialogTitle>Add New Task</DialogTitle>
    </DialogHeader>
    <div className="space-y-4 py-4">
      {/* Project selector (required) */}
      <div className="space-y-2">
        <label className="text-sm font-medium text-gray-700">
          Project <span className="text-red-500">*</span>
        </label>
        <ProjectSelect
          value={newProjectId}
          onValueChange={setNewProjectId}
          projects={allProjects}
        />
      </div>
      {/* Title (required) */}
      {/* Description */}
      {/* Status + Priority (grid cols-2) */}
      {/* Due Date + Assignee (grid cols-2) */}
      {/* Error message */}
    </div>
    <DialogFooter>
      <DialogClose asChild>
        <Button variant="outline">Cancel</Button>
      </DialogClose>
      <Button
        onClick={handleCreateTask}
        disabled={!newProjectId || !newTitle.trim() || isCreating}
      >
        {isCreating ? 'Creating...' : 'Create Task'}
      </Button>
    </DialogFooter>
  </DialogContent>
</Dialog>
```

6. **Layout**: Reorganize the toolbar to accommodate the button:
- Filter bar on the left
- Add Task button + View toggle on the right

**Imports needed**: Dialog, DialogContent, DialogHeader, DialogTitle, DialogTrigger, DialogFooter, DialogClose, Plus, Input, Textarea, Select components, Label, ProjectSelect, TEAM_MEMBER_OPTIONS from utils
</details>
</task>

## Verification

After implementation, verify:

1. [ ] "Add Task" button visible on /tasks page toolbar
2. [ ] Clicking Add Task opens a dialog
3. [ ] Dialog contains: Project selector (required), Title (required), Description, Status, Priority, Due Date, Assignee
4. [ ] Project selector shows all projects (searchable)
5. [ ] Cannot create task without selecting a project
6. [ ] Cannot create task without a title
7. [ ] Task created successfully and appears in the list after page refresh
8. [ ] Create button shows loading state during creation
9. [ ] Dialog closes and form resets after successful creation
10. [ ] Error message shown on API failure
11. [ ] TypeScript compiles without errors

## Must Haves

- Add Task button on /tasks page toolbar
- Dialog form with required project selector and required title
- Project selector is a searchable combobox showing all projects
- Successful creation triggers page refresh to show new task
- Form validation prevents submission without project and title
