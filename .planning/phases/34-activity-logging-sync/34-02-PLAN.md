---
phase: 34-activity-logging-sync
plan: 02
type: execute
wave: 2
depends_on: ["34-01"]
files_modified:
  - src/app/api/deals/route.ts
  - src/app/api/potential-projects/route.ts
  - src/components/pipeline/pipeline-card.tsx
  - src/components/pipeline/pipeline-board.tsx
  - src/components/potential-projects/potential-card.tsx
  - src/components/potential-projects/potential-board.tsx
  - src/components/pipeline/deal-detail-sheet.tsx
  - src/components/potential-projects/potential-detail-sheet.tsx
autonomous: true

must_haves:
  truths:
    - "Converted deal card shows project status, revenue, and total costs"
    - "Converted potential card shows project status, revenue, and total costs"
    - "Pipeline board auto-refreshes every 60 seconds"
    - "Potential board auto-refreshes every 60 seconds"
    - "Deal detail sheet shows activity timeline"
    - "Potential detail sheet shows activity timeline"
  artifacts:
    - path: "src/app/api/deals/route.ts"
      provides: "Deal list with project status and costs"
      contains: "totalCosts"
    - path: "src/app/api/potential-projects/route.ts"
      provides: "Potential list with project status and costs"
      contains: "totalCosts"
    - path: "src/components/pipeline/pipeline-card.tsx"
      provides: "Deal card with project metrics"
      contains: "totalCosts"
    - path: "src/components/potential-projects/potential-card.tsx"
      provides: "Potential card with project metrics"
      contains: "totalCosts"
    - path: "src/components/pipeline/pipeline-board.tsx"
      provides: "Pipeline board with polling"
      contains: "setInterval"
    - path: "src/components/potential-projects/potential-board.tsx"
      provides: "Potential board with polling"
      contains: "setInterval"
  key_links:
    - from: "src/components/pipeline/pipeline-board.tsx"
      to: "/api/deals"
      via: "polling fetch"
      pattern: "setInterval.*fetchDeals"
    - from: "src/components/potential-projects/potential-board.tsx"
      to: "/api/potential-projects"
      via: "polling fetch"
      pattern: "setInterval.*fetchProjects"
    - from: "src/components/pipeline/deal-detail-sheet.tsx"
      to: "src/components/shared/activity-timeline.tsx"
      via: "import ActivityTimeline"
      pattern: "ActivityTimeline"
---

<objective>
Add live project metrics to converted cards and auto-refresh to pipeline boards.

Purpose: Users see real-time project data (status, revenue, costs) on converted deal/potential cards and boards automatically refresh to show latest data.

Output: Enhanced cards with metrics, polling refresh on boards, activity timeline in detail sheets.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/34-activity-logging-sync/34-RESEARCH.md
@.planning/phases/34-activity-logging-sync/34-01-SUMMARY.md

# Key existing files
@src/app/api/deals/route.ts (needs status + costs aggregate)
@src/app/api/potential-projects/route.ts (needs status + costs aggregate)
@src/components/pipeline/pipeline-card.tsx (needs metrics display)
@src/components/pipeline/pipeline-board.tsx (needs polling)
@src/components/potential-projects/potential-card.tsx (needs metrics display)
@src/components/potential-projects/potential-board.tsx (needs polling)
@src/components/pipeline/deal-detail-sheet.tsx (needs activity timeline)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Enhance APIs with project metrics</name>
  <files>src/app/api/deals/route.ts, src/app/api/potential-projects/route.ts</files>
  <action>
Enhance both GET endpoints to include project status and total costs.

**For /api/deals/route.ts GET:**

1. Expand project include to add status and costs:
   ```typescript
   project: {
     select: {
       id: true,
       title: true,
       revenue: true,
       potentialRevenue: true,
       status: true,  // ADD
       costs: {       // ADD - for aggregation
         select: { amount: true },
       },
     },
   },
   ```

2. Update serialization to compute totalCosts:
   ```typescript
   project: deal.project ? {
     id: deal.project.id,
     title: deal.project.title,
     revenue: deal.project.revenue ? Number(deal.project.revenue) : null,
     potentialRevenue: deal.project.potentialRevenue ? Number(deal.project.potentialRevenue) : null,
     status: deal.project.status,  // ADD
     totalCosts: deal.project.costs.reduce((sum, c) => sum + Number(c.amount), 0),  // ADD
   } : null,
   ```

**For /api/potential-projects/route.ts GET:**

Apply the exact same changes - add status and costs to project include, compute totalCosts in serialization.
  </action>
  <verify>
1. GET /api/deals - response should have project.status and project.totalCosts for converted deals
2. GET /api/potential-projects - response should have project.status and project.totalCosts for converted potentials
  </verify>
  <done>Both APIs return project status and totalCosts for converted items</done>
</task>

<task type="auto">
  <name>Task 2: Update cards with project metrics display</name>
  <files>src/components/pipeline/pipeline-card.tsx, src/components/potential-projects/potential-card.tsx</files>
  <action>
Add project metrics section to both card components.

**For pipeline-card.tsx:**

1. Update Deal interface to include new project fields:
   ```typescript
   project?: {
     id: string
     title: string
     revenue: number | null
     potentialRevenue: number | null
     status: string       // ADD
     totalCosts: number   // ADD
   } | null
   ```

2. After the conversion badge (line ~207), add metrics section for WON stage with project:
   ```tsx
   {/* Project Metrics - Only for WON deals with project */}
   {deal.project && deal.stage === 'WON' && (
     <div className="mt-2 p-2 bg-gray-50 rounded-lg text-xs space-y-1.5">
       {/* Status */}
       <div className="flex items-center justify-between">
         <span className="text-gray-500">Status:</span>
         <Badge variant="outline" className="text-xs px-1.5 py-0">
           {deal.project.status.replace('_', ' ')}
         </Badge>
       </div>
       {/* Revenue */}
       {deal.project.revenue !== null && (
         <div className="flex items-center justify-between">
           <span className="text-gray-500">Revenue:</span>
           <span className="font-medium text-green-600">
             {formatCurrency(deal.project.revenue)}
           </span>
         </div>
       )}
       {/* Costs */}
       {deal.project.totalCosts > 0 && (
         <div className="flex items-center justify-between">
           <span className="text-gray-500">Costs:</span>
           <span className="font-medium text-red-600">
             {formatCurrency(deal.project.totalCosts)}
           </span>
         </div>
       )}
     </div>
   )}
   ```

**For potential-card.tsx:**

Apply same changes:
1. Update PotentialProject interface with status and totalCosts
2. Add metrics section after conversion badge (for CONFIRMED stage with project)
   - Change condition to: `project.project && project.stage === 'CONFIRMED'`
  </action>
  <verify>View pipeline board - WON deals with projects should show status/revenue/costs. View potential board - CONFIRMED items with projects should show same metrics.</verify>
  <done>Converted cards display live project metrics (status, revenue, costs)</done>
</task>

<task type="auto">
  <name>Task 3: Add polling refresh to boards</name>
  <files>src/components/pipeline/pipeline-board.tsx, src/components/potential-projects/potential-board.tsx</files>
  <action>
Add 60-second polling and tab visibility refresh to both board components.

**For pipeline-board.tsx:**

1. Add useEffect for polling after existing state declarations (around line 77):
   ```typescript
   // Auto-refresh polling
   useEffect(() => {
     const fetchDeals = async () => {
       try {
         const response = await fetch(`/api/deals?showArchived=${showArchived}`)
         if (response.ok) {
           const newData = await response.json()
           // Only update if data actually changed to avoid flicker
           setDeals(prev => {
             if (JSON.stringify(prev) === JSON.stringify(newData)) return prev
             return newData
           })
         }
       } catch (error) {
         console.error('Failed to refresh deals:', error)
       }
     }

     // Poll every 60 seconds
     const pollInterval = setInterval(fetchDeals, 60000)

     // Refresh on tab focus
     const handleVisibilityChange = () => {
       if (document.visibilityState === 'visible') {
         fetchDeals()
       }
     }
     document.addEventListener('visibilitychange', handleVisibilityChange)

     return () => {
       clearInterval(pollInterval)
       document.removeEventListener('visibilitychange', handleVisibilityChange)
     }
   }, [showArchived])
   ```

**For potential-board.tsx:**

Apply same pattern:
1. Add identical useEffect for polling
2. Change fetch URL to `/api/potential-projects?showArchived=${showArchived}`
3. Change setDeals to setProjects
4. Change error message to "Failed to refresh potential projects"
  </action>
  <verify>
1. Open pipeline board in one tab
2. Make changes to a project in another tab (or via API)
3. Switch back to pipeline tab - data should refresh immediately
4. Wait 60 seconds - data should refresh automatically
  </verify>
  <done>Both boards auto-refresh every 60 seconds and on tab focus</done>
</task>

<task type="auto">
  <name>Task 4: Add activity timeline to detail sheets</name>
  <files>src/components/pipeline/deal-detail-sheet.tsx, src/components/potential-projects/potential-detail-sheet.tsx</files>
  <action>
Add ActivityTimeline section to show sync history in detail sheets.

**For deal-detail-sheet.tsx:**

1. Import ActivityTimeline:
   ```typescript
   import { ActivityTimeline } from '@/components/shared/activity-timeline'
   ```

2. Add state for activity logs and loading:
   ```typescript
   const [activityLogs, setActivityLogs] = useState<any[]>([])
   const [isLoadingActivity, setIsLoadingActivity] = useState(false)
   ```

3. Add fetch function and useEffect to load activities when sheet opens:
   ```typescript
   const fetchActivityLogs = async (dealId: string) => {
     setIsLoadingActivity(true)
     try {
       const response = await fetch(`/api/activity-logs?entityType=DEAL&entityId=${dealId}`)
       if (response.ok) {
         const data = await response.json()
         setActivityLogs(data)
       }
     } catch (error) {
       console.error('Failed to fetch activity logs:', error)
     } finally {
       setIsLoadingActivity(false)
     }
   }
   ```

4. In the existing useEffect that initializes form, add:
   ```typescript
   // Fetch activity logs for converted deals
   if (deal.project) {
     fetchActivityLogs(deal.id)
   }
   ```

5. After the "Converted Project Info" section (after line ~379), add Activity section:
   ```tsx
   {/* Activity History - Only for converted deals */}
   {isConverted && (
     <>
       <Separator />
       <div className="space-y-3">
         <Label className="text-muted-foreground">Activity History</Label>
         <ActivityTimeline
           logs={activityLogs}
           isLoading={isLoadingActivity}
         />
       </div>
     </>
   )}
   ```

**For potential-detail-sheet.tsx:**

Apply same pattern:
1. Import ActivityTimeline
2. Add state for activityLogs and isLoadingActivity
3. Add fetchActivityLogs function (change entityType to 'POTENTIAL')
4. Fetch logs in useEffect when sheet opens for converted projects
5. Add Activity History section after converted project info

Note: potential-detail-sheet.tsx structure may differ slightly - find the converted project section and add activity timeline after it.
  </action>
  <verify>
1. Open a converted deal's detail sheet - should show Activity History section
2. After making title sync, activity should show TITLE_SYNCED entry
3. Same verification for potential detail sheet
  </verify>
  <done>Detail sheets display activity timeline for converted deals/potentials</done>
</task>

</tasks>

<verification>
1. API returns metrics: GET /api/deals shows project.status and project.totalCosts
2. Cards show metrics: WON deals and CONFIRMED potentials display status/revenue/costs
3. Boards poll: Wait 60s on board page - data refreshes without manual action
4. Tab refresh: Switch away and back to board - data refreshes
5. Activity shown: Open converted deal sheet - Activity History section visible
6. Title sync logged: Change project title, check deal activity - shows TITLE_SYNCED
</verification>

<success_criteria>
- Converted deal cards show live project status, revenue, and total costs
- Converted potential cards show live project status, revenue, and total costs
- Pipeline board auto-refreshes every 60 seconds
- Potential board auto-refreshes every 60 seconds
- Pipeline board refreshes on tab visibility change
- Potential board refreshes on tab visibility change
- Deal detail sheet shows activity timeline for converted deals
- Potential detail sheet shows activity timeline for converted potentials
- All SYNC requirements (SYNC-01 to SYNC-06) satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/34-activity-logging-sync/34-02-SUMMARY.md`
</output>
