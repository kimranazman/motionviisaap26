# Plan 63-03: Contacts Page + Detail Modal

## Frontmatter
- **Phase**: 63 - Standalone CRM Pages
- **Wave**: 3
- **Depends_on**: 63-01, 63-02
- **Files_modified**:
  - `src/app/(dashboard)/contacts/page.tsx` (NEW)
  - `src/components/contacts/contact-list.tsx` (NEW)
  - `src/components/contacts/contact-detail-modal.tsx` (NEW)
  - `src/app/api/contacts/[id]/route.ts` (NEW)
- **Autonomous**: true
- **Requirements**: CRM-05, CRM-06, CRM-07, CRM-08, CRM-09, CRM-10

## Objective
Build the standalone /contacts page with cascading company and department filters, table view, create dialog, and contact detail modal showing company, department, deals, and projects.

## Tasks

<task id="1" name="Create single contact API route">
Create `src/app/api/contacts/[id]/route.ts` with:

**GET /api/contacts/[id]** - Fetch single contact with full details
- `requireAuth()` guard
- Include: `company { id, name }`, `department { id, name }`, `deals { id, title, stage, value }` (limit 10), `potentials { id, title, stage, estimatedValue }` (limit 10), `projects { id, title, status, revenue }` (limit 10)
- Return 404 if not found

**PATCH /api/contacts/[id]** - Update contact fields
- `requireEditor()` guard
- Updatable fields: name, email, phone, role, departmentId, isPrimary
- If isPrimary is set to true, unset isPrimary on all other contacts for the same company
- Return updated contact

**DELETE /api/contacts/[id]** - Delete contact
- `requireEditor()` guard
- Return 204 on success

Follow the pattern from `src/app/api/companies/[id]/contacts/[contactId]/route.ts` for the PATCH/DELETE logic.
</task>

<task id="2" name="Create contacts page (server component)">
Create `src/app/(dashboard)/contacts/page.tsx`:

```tsx
import prisma from '@/lib/prisma'
import { ContactList } from '@/components/contacts/contact-list'

export default async function ContactsPage() {
  const contacts = await prisma.contact.findMany({
    include: {
      company: { select: { id: true, name: true } },
      department: { select: { id: true, name: true } },
      _count: { select: { deals: true, potentials: true, projects: true } },
    },
    orderBy: [{ company: { name: 'asc' } }, { name: 'asc' }],
  })

  const companies = await prisma.company.findMany({
    select: { id: true, name: true },
    orderBy: { name: 'asc' },
  })

  return (
    <div className="space-y-6 p-6">
      <div>
        <h1 className="text-2xl font-bold text-gray-900">Contacts</h1>
        <p className="text-sm text-gray-500 mt-1">
          Browse and manage contacts across all companies
        </p>
      </div>
      <ContactList initialData={contacts} companies={companies} />
    </div>
  )
}
```
</task>

<task id="3" name="Create contact list component with cascading filters">
Create `src/components/contacts/contact-list.tsx` as a client component:

**Interface:**
```typescript
interface Contact {
  id: string
  name: string
  email: string | null
  phone: string | null
  role: string | null
  isPrimary: boolean
  company: { id: string; name: string }
  department: { id: string; name: string } | null
  _count: { deals: number; potentials: number; projects: number }
  createdAt: string | Date
}

interface ContactListProps {
  initialData: Contact[]
  companies: { id: string; name: string }[]
}
```

**State:**
- `contacts` (from initialData)
- `search` (string filter)
- `companyFilter` ('all' | companyId)
- `departmentFilter` ('all' | departmentId)
- `departments` (fetched when companyFilter changes)
- `isCreateOpen` (dialog)
- `selectedContactId` / `isDetailOpen` (detail modal)
- Create form state: `newCompanyId`, `newDepartmentId`, `newName`, `newEmail`, `newPhone`, `newRole`, `isCreating`

**Cascading Filter Logic:**
1. When `companyFilter` changes from 'all' to a companyId:
   - Reset `departmentFilter` to 'all'
   - Fetch departments for that company: `GET /api/companies/{companyId}/departments`
   - Store in `departments` state
2. When `companyFilter` changes to 'all':
   - Reset `departmentFilter` to 'all'
   - Clear `departments` to empty array
3. Department filter Select is disabled when companyFilter is 'all'

**Toolbar:**
- Search input (flex-1, max-w-sm on desktop)
- Company filter Select (w-44 on desktop)
- Department filter Select (w-44 on desktop, disabled when no company selected)
- "Add Contact" button (opens create dialog)

**Create Dialog:**
- CompanySelect for company (required) - use existing `CompanySelect` component
- DepartmentSelect (optional, only shows departments for selected company)
  - When company changes in dialog, fetch departments and reset department
- Name input (required)
- Email input (optional)
- Phone input (optional)
- Role input (optional)
- POST to `/api/contacts` with { companyId, departmentId, name, email, phone, role }
- On success: close dialog, refresh list

**Table columns:**
- Name (with User icon + role subtitle + company on mobile)
- Company (hidden mobile)
- Department (hidden mobile)
- Email (hidden mobile)
- Role (hidden mobile)
- Actions dropdown (View Details)

**Row click:** Opens contact detail modal

**Refresh function:** `fetch('/api/contacts')` then parse response

**Empty state:** Users icon + "No contacts yet" + Add Contact button

**Summary:** "Showing X of Y contacts"

**Bottom:** ContactDetailModal component

Follow the CompanyList pattern for structure. The cascading filter is the key new behavior.
</task>

<task id="4" name="Create contact detail modal">
Create `src/components/contacts/contact-detail-modal.tsx` as a client component:

**Interface:**
```typescript
interface ContactDetailModalProps {
  contactId: string | null
  open: boolean
  onOpenChange: (open: boolean) => void
  onDeleted: () => void
  onUpdated: () => void
}
```

**Fetches on open:** `GET /api/contacts/{contactId}`

**Modal Content (using DetailView):**
1. Title: Contact name (inline editable)
2. Primary badge (if isPrimary)
3. Fields grid (2 columns):
   - Company: show name as text (read-only, links to company)
   - Department: show name as text (or "None")
   - Role: inline editable
   - Email: inline editable
   - Phone: inline editable
4. Separator
5. Related Deals section (if any):
   - List deals: title, stage badge, value
6. Related Potential Projects section (if any):
   - List potentials: title, stage badge, estimated value
7. Related Projects section (if any):
   - List projects: title, status badge, revenue
8. Empty state if no related items
9. Footer: Delete button (left) + Close button (right)

**Inline editing:** Uses PATCH `/api/contacts/{contactId}` for field updates.

**Delete:** Uses DELETE `/api/contacts/{contactId}` with confirmation dialog.

Follow the CompanyDetailModal pattern for layout, skeleton loading, delete dialog, and related items display. Reuse `CompanyInlineField` for inline editing. Use `formatDealStage`, `getStageColor`, `formatPotentialStage`, `getPotentialStageColor`, `formatProjectStatus`, `getProjectStatusColor` for badge formatting.
</task>

## Verification

- [ ] /contacts page renders with list of all contacts
- [ ] Company filter dropdown filters contacts by company
- [ ] Department filter loads departments when company selected (cascading)
- [ ] Department filter disabled when no company selected
- [ ] Department filter resets when company changes
- [ ] Search filters contacts by name
- [ ] "Add Contact" opens dialog with company selector, department selector, and contact fields
- [ ] Department selector in create dialog loads departments for selected company
- [ ] Creating a contact refreshes the list
- [ ] Clicking a contact row opens detail modal
- [ ] Detail modal shows contact info, company, department, deals, potentials, projects
- [ ] Contact fields are inline editable in detail modal
- [ ] Delete contact works with confirmation dialog
- [ ] Company and department names visible in table
- [ ] Mobile responsive
- [ ] No TypeScript errors
- [ ] Primary badge shows on primary contacts

## must_haves
- User can browse all contacts on /contacts page
- User can filter contacts by company
- User can filter contacts by department (cascading from company selection)
- User can view contact detail modal with company, department, deals, and projects
- User can create a contact from standalone page (with company and optional department selection)
- Cross-entity navigation: contact shows company and department names
