# Plan 63-02: Departments Page + Detail Modal

## Frontmatter
- **Phase**: 63 - Standalone CRM Pages
- **Wave**: 2
- **Depends_on**: 63-01
- **Files_modified**:
  - `src/app/(dashboard)/departments/page.tsx` (NEW)
  - `src/components/departments/department-list.tsx` (NEW)
  - `src/components/departments/department-detail-modal.tsx` (NEW)
  - `src/app/api/departments/[id]/route.ts` (NEW)
- **Autonomous**: true
- **Requirements**: CRM-01, CRM-02, CRM-03, CRM-04, CRM-10

## Objective
Build the standalone /departments page with company filter, table view, create dialog, and department detail modal showing contacts, deals, and company link.

## Tasks

<task id="1" name="Create departments page (server component)">
Create `src/app/(dashboard)/departments/page.tsx`:

```tsx
import prisma from '@/lib/prisma'
import { DepartmentList } from '@/components/departments/department-list'

export default async function DepartmentsPage() {
  const departments = await prisma.department.findMany({
    include: {
      company: { select: { id: true, name: true } },
      _count: { select: { contacts: true, deals: true, potentials: true } },
    },
    orderBy: [{ company: { name: 'asc' } }, { name: 'asc' }],
  })

  // Get companies for filter dropdown
  const companies = await prisma.company.findMany({
    select: { id: true, name: true },
    orderBy: { name: 'asc' },
  })

  return (
    <div className="space-y-6 p-6">
      <div>
        <h1 className="text-2xl font-bold text-gray-900">Departments</h1>
        <p className="text-sm text-gray-500 mt-1">
          Browse and manage departments across all companies
        </p>
      </div>
      <DepartmentList initialData={departments} companies={companies} />
    </div>
  )
}
```

Follow the exact pattern from `src/app/(dashboard)/companies/page.tsx`.
</task>

<task id="2" name="Create department list component">
Create `src/components/departments/department-list.tsx` as a client component:

**Interface:**
```typescript
interface Department {
  id: string
  name: string
  description: string | null
  company: { id: string; name: string }
  _count: { contacts: number; deals: number; potentials: number }
  createdAt: string | Date
}

interface DepartmentListProps {
  initialData: Department[]
  companies: { id: string; name: string }[]
}
```

**State:**
- `departments` (from initialData)
- `search` (string filter)
- `companyFilter` ('all' | companyId)
- `isCreateOpen` (dialog)
- `selectedDeptId` / `isDetailOpen` (detail modal)
- Create form: `newName`, `newDescription`, `newCompanyId`, `isCreating`

**Toolbar:**
- Search input (left) with Search icon
- Company filter Select (all companies + each company)
- "Add Department" button (opens create dialog)

**Create Dialog:**
- CompanySelect component for company selection (required)
- Name input (required)
- Description textarea (optional)
- POST to `/api/departments` with { companyId, name, description }
- On success: close dialog, refresh list

**Table columns:**
- Name (with Building icon, company name subtitle on mobile)
- Company (hidden on mobile, clickable text that could open company detail later)
- Contacts count (center, hidden mobile)
- Deals count (center, hidden mobile)
- Actions dropdown (View Details)

**Row click:** Opens department detail modal

**Refresh function:** `fetch('/api/departments')` to get latest data

**Empty state:** Building icon + "No departments yet" + Add Department button

**Bottom:** DepartmentDetailModal component

Follow the CompanyList pattern exactly for structure, toolbar layout, and responsive design.
</task>

<task id="3" name="Create department detail modal">
Create `src/components/departments/department-detail-modal.tsx` as a client component:

**Interface:**
```typescript
interface DepartmentDetailModalProps {
  departmentId: string | null
  open: boolean
  onOpenChange: (open: boolean) => void
  onDeleted: () => void
  onUpdated: () => void
}
```

**Fetches full department on open:**
- `GET /api/companies/{companyId}/departments/{deptId}` - but we need the companyId.
- Alternative: Fetch department data through a new approach. Since we know the departmentId, we should add logic to the existing department PATCH/DELETE API or create a simple fetch.
- BEST APPROACH: Fetch from standalone `/api/departments?id={departmentId}` or extend the existing API.
- SIMPLEST: Fetch the department data directly. Create a helper: first fetch departments list and find by id, or add a GET `/api/departments/[id]` route.

**Actually, add a GET route for single department:**
Create `src/app/api/departments/[id]/route.ts` with:
- GET: Fetch single department with company (full details), contacts (in that dept), deals, potentials
- PATCH: Update department name/description
- DELETE: Delete department

This follows the pattern of `/api/companies/[id]/route.ts`.

**Modal Content (using DetailView):**
1. Title: Department name (inline editable via CompanyInlineField)
2. Company link: Show company name as a badge/link
3. Description: Inline editable text field
4. Separator
5. Contacts section: List contacts in this department (name, role, email)
6. Separator
7. Related Deals section: List deals linked to this department (title, stage, value)
8. Related Potentials section: List potentials (title, stage, value)
9. Footer: Delete button (left) + Close button (right)

Follow the CompanyDetailModal pattern for layout, loading skeleton, and delete confirmation.

**Files for this task:**
- `src/app/api/departments/[id]/route.ts` (NEW)
- `src/components/departments/department-detail-modal.tsx` (NEW)
</task>

## Verification

- [ ] /departments page renders with list of all departments
- [ ] Company filter dropdown filters departments by selected company
- [ ] Search filters departments by name
- [ ] "Add Department" opens dialog with company selector and name/description fields
- [ ] Creating a department refreshes the list
- [ ] Clicking a department row opens detail modal
- [ ] Detail modal shows department info, contacts, deals, company link
- [ ] Department name and description are inline editable
- [ ] Delete department works with confirmation dialog
- [ ] Company name in table row is visible
- [ ] Mobile responsive (company column hidden, info in name cell)
- [ ] No TypeScript errors

## must_haves
- User can browse all departments on /departments page
- User can filter departments by company
- User can view department detail modal with contacts, deals, and company link
- User can create a department from the standalone page (with company selection)
- Cross-entity navigation: department shows company name
