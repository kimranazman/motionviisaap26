# Plan 63-01: API Routes + Sidebar Navigation

## Frontmatter
- **Phase**: 63 - Standalone CRM Pages
- **Wave**: 1
- **Depends_on**: None
- **Files_modified**:
  - `src/app/api/departments/route.ts` (NEW)
  - `src/app/api/contacts/route.ts` (NEW)
  - `src/lib/nav-config.ts` (EDIT)
- **Autonomous**: true
- **Requirements**: CRM-11 (sidebar), CRM-01 partial (API), CRM-05 partial (API)

## Objective
Create standalone API routes for departments and contacts (cross-company queries) and add Departments and Contacts to the CRM sidebar group.

## Tasks

<task id="1" name="Create standalone departments API route">
Create `src/app/api/departments/route.ts` with:

**GET /api/departments** - List all departments across companies
- `requireAuth()` guard
- Query params: `?companyId=` (optional filter)
- Include: `company { id, name }`, `_count { contacts, deals, potentials }`
- OrderBy: `company.name asc`, then `name asc`
- Return JSON array

**POST /api/departments** - Create a department
- `requireEditor()` guard
- Required body fields: `companyId`, `name`
- Optional body fields: `description`
- Validate company exists
- Handle unique constraint violation (P2002) for [companyId, name]
- Return 201 with created department including `_count`

Follow the exact pattern from `src/app/api/companies/route.ts` for structure, error handling, and auth.
</task>

<task id="2" name="Create standalone contacts API route">
Create `src/app/api/contacts/route.ts` with:

**GET /api/contacts** - List all contacts across companies
- `requireAuth()` guard
- Query params: `?companyId=` (optional), `?departmentId=` (optional)
- Include: `company { id, name }`, `department { id, name }`, and `_count { deals, potentials, projects }`
- OrderBy: `company.name asc`, then `name asc`
- Return JSON array

**POST /api/contacts** - Create a contact
- `requireEditor()` guard
- Required body fields: `companyId`, `name`
- Optional body fields: `email`, `phone`, `role`, `departmentId`
- Validate company exists
- If departmentId provided, validate department exists AND belongs to same company
- Auto-set `isPrimary: true` if first contact for that company (count existing)
- Return 201 with created contact

Follow the exact pattern from `src/app/api/companies/[id]/contacts/route.ts` for validation logic.
</task>

<task id="3" name="Add Departments and Contacts to sidebar navigation">
Edit `src/lib/nav-config.ts`:

1. Add import for `Building` icon (for Departments) and `Users` icon (for Contacts) from `lucide-react`
   - Note: `Building2` is already imported (used for Companies). Use `Building` for Departments.
   - Note: `Users` is already imported (used for Admin Users). Use `Contact` from lucide-react for Contacts.

2. Add two items to the `crm` group in `navGroups`, right after the `Companies` entry:
   ```
   { name: 'Departments', href: '/departments', icon: Building },
   { name: 'Contacts', href: '/contacts', icon: Contact },
   ```

3. Verify the icon imports don't conflict with existing ones. The `Building` icon exists but check if it's already imported. Use `Contact` icon from lucide-react for contacts (not `Users` which is already used for Admin).
</task>

## Verification

- [ ] `GET /api/departments` returns departments with company info
- [ ] `GET /api/departments?companyId=xxx` filters by company
- [ ] `POST /api/departments` creates department with valid companyId
- [ ] `GET /api/contacts` returns contacts with company and department info
- [ ] `GET /api/contacts?companyId=xxx` filters by company
- [ ] `GET /api/contacts?companyId=xxx&departmentId=yyy` filters by both
- [ ] `POST /api/contacts` creates contact with valid companyId
- [ ] Departments appears in sidebar CRM group
- [ ] Contacts appears in sidebar CRM group
- [ ] No TypeScript errors

## must_haves
- Standalone department API supports listing all departments with optional companyId filter
- Standalone contact API supports listing all contacts with optional companyId and departmentId filters
- Both APIs include related entity data (company name, counts)
- Departments and Contacts nav items appear in CRM sidebar group
