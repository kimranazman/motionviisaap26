---
phase: 38-schema-utilities-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - prisma/schema.prisma
  - src/lib/initiative-group-utils.ts
  - src/lib/initiative-kpi-utils.ts
  - src/lib/initiative-date-utils.ts
autonomous: true

must_haves:
  truths:
    - "Initiative model has 5 new nullable KPI fields and existing data is unaffected"
    - "Group utility normalizes 'KR1.1', ' kr1.1 ', and 'KR 1.1' to the same value"
    - "KPI utility returns 'No data' for no projects, avoids division by zero, treats null revenue as 0"
    - "Date utility computes overdue, ending-soon, late-start, invalid-dates, and long-duration flags"
  artifacts:
    - path: "prisma/schema.prisma"
      provides: "Initiative model with 5 KPI fields"
      contains: "kpiLabel"
    - path: "src/lib/initiative-group-utils.ts"
      provides: "normalizeKeyResult and groupInitiativesByObjective functions"
      exports: ["normalizeKeyResult", "groupInitiativesByObjective"]
    - path: "src/lib/initiative-kpi-utils.ts"
      provides: "calculateKpi function with null/zero handling"
      exports: ["calculateKpi"]
    - path: "src/lib/initiative-date-utils.ts"
      provides: "analyzeDates function returning DateIntelligence with flags"
      exports: ["analyzeDates"]
  key_links:
    - from: "src/lib/initiative-group-utils.ts"
      to: "normalizeKeyResult"
      via: "trim().toUpperCase().replace(/\\s+/g, '')"
      pattern: "trim\\(\\)\\.toUpperCase\\(\\)\\.replace"
    - from: "src/lib/initiative-kpi-utils.ts"
      to: "calculateKpi"
      via: "null/zero guard before division"
      pattern: "target && target > 0"
    - from: "src/lib/initiative-date-utils.ts"
      to: "date-fns"
      via: "import { differenceInDays, isPast, isBefore, intervalToDuration }"
      pattern: "from 'date-fns'"
---

<objective>
Add 5 nullable KPI fields to the Initiative Prisma model and create 3 pure-function utility modules (grouping, KPI calculation, date intelligence) that phases 39-42 will consume.

Purpose: This is the foundation for v1.5 Initiative Intelligence & Export. All subsequent phases depend on these schema fields and utility functions existing.
Output: Updated schema.prisma with KPI fields pushed to DB, plus 3 new utility files in src/lib/.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/38-schema-utilities-foundation/38-RESEARCH.md
@prisma/schema.prisma
@src/lib/cost-utils.ts
@src/lib/date-utils.ts
@src/lib/utils.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add KPI fields to Initiative schema and push to database</name>
  <files>prisma/schema.prisma</files>
  <action>
Add 5 new KPI fields to the Initiative model in `prisma/schema.prisma`. Place them AFTER the `position` field (line 59) and BEFORE the `createdAt` field (line 61). Add a blank comment line before for readability.

Fields to add (exact Prisma syntax):
```prisma
  // KPI fields (v1.5 - Initiative Intelligence)
  kpiLabel          String?  @map("kpi_label") @db.VarChar(100)
  kpiTarget         Decimal? @map("kpi_target") @db.Decimal(12, 2)
  kpiActual         Decimal? @map("kpi_actual") @db.Decimal(12, 2)
  kpiUnit           String?  @map("kpi_unit") @db.VarChar(50)
  kpiManualOverride Boolean  @default(false) @map("kpi_manual_override")
```

IMPORTANT constraints:
- kpiUnit is VarChar(50) per REQUIREMENTS.md SCHEMA-01 (NOT VarChar(20) from architecture doc)
- kpiManualOverride is NOT nullable -- it has a default of false
- All other KPI fields ARE nullable (String?, Decimal?)
- Use @map("snake_case") for column names -- this matches how OTHER models (Project, Deal, Cost) handle multi-word columns. Note: the existing Initiative fields like keyResult, startDate do NOT use @map, but NEW fields should follow the @map convention per research decision.
- This is an additive-only migration -- no existing fields are changed or removed (SCHEMA-02)

After editing schema.prisma, run:
```bash
npx prisma db push
npx prisma generate
```

Then verify the build still compiles:
```bash
npx next build 2>&1 | tail -20
```
  </action>
  <verify>
1. `npx prisma db push` succeeds without errors
2. `npx prisma generate` succeeds
3. `npx next build` succeeds (no TypeScript errors)
4. Confirm existing data unaffected by running: `npx prisma db execute --stdin <<< "SELECT COUNT(*) as total, COUNT(kpi_label) as with_kpi FROM initiatives;"` -- total should be 28 (existing initiatives), with_kpi should be 0 (all null)
  </verify>
  <done>
Initiative model has 5 new KPI fields (kpiLabel, kpiTarget, kpiActual, kpiUnit, kpiManualOverride). Database schema updated. All 28 existing initiatives unaffected (new fields are null/default). Build passes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create initiative utility modules (group, KPI, date)</name>
  <files>
    src/lib/initiative-group-utils.ts
    src/lib/initiative-kpi-utils.ts
    src/lib/initiative-date-utils.ts
  </files>
  <action>
Create 3 new pure-function utility files in `src/lib/`. Each file defines its own TypeScript interfaces (no shared types directory -- follows existing codebase pattern where each component/utility defines what it needs).

DO NOT modify existing files: `src/lib/date-utils.ts`, `src/lib/utils.ts`, or any other existing file.

**File 1: `src/lib/initiative-group-utils.ts`**

Purpose: Normalize keyResult strings and group initiatives by objective/keyResult hierarchy.

Required exports:
- `normalizeKeyResult(keyResult: string): string` -- Normalizes via `value.trim().toUpperCase().replace(/\s+/g, '')`. This is critical: simple trim+uppercase would NOT handle "KR 1.1" vs "KR1.1" (space between letters and numbers). The replace removes ALL internal whitespace.
- `groupInitiativesByObjective(initiatives: InitiativeForGrouping[]): GroupedObjective[]` -- Groups by objective enum, then sub-groups by normalized keyResult. Sorts keyResults naturally (KR1.1 < KR1.2 < KR2.1 via localeCompare). Each group includes totalInitiatives, completedCount, inProgressCount, atRiskCount.

Required interfaces (define in same file):
- `InitiativeForGrouping` -- needs: id, objective (string), keyResult (string), status (string), title (string). Minimal interface.
- `GroupedKeyResult` -- keyResult (string), initiatives (InitiativeForGrouping[]), totalInitiatives (number), completedCount (number)
- `GroupedObjective` -- objective (string), keyResults (GroupedKeyResult[]), totalInitiatives (number), completedCount (number), inProgressCount (number), atRiskCount (number)

See research code example for complete implementation.

**File 2: `src/lib/initiative-kpi-utils.ts`**

Purpose: Calculate KPI metrics with null/zero-safe handling.

Required exports:
- `calculateKpi(initiative: InitiativeWithKpiAndProjects): KpiResult` -- Handles two modes:
  1. Manual override mode (kpiManualOverride true AND kpiLabel set): uses manual values. CRITICAL: if target is 0 or null, percentage must be null (never divide by zero).
  2. Auto-calculate mode: sums revenue from linked projects. No projects = return displayText "No data" and percentage null. Null revenue treated as 0 for summing.

Required interfaces (define in same file):
- `ProjectForKpi` -- needs: id (string), revenue (number | null)
- `InitiativeWithKpiAndProjects` -- needs: kpiLabel (string | null), kpiTarget (number | null), kpiActual (number | null), kpiUnit (string | null), kpiManualOverride (boolean), projects (ProjectForKpi[] | undefined)
- `KpiResult` -- label (string), target (number | null), actual (number), unit (string), percentage (number | null), source ('auto' | 'manual'), displayText (string)

See research code example for complete implementation. Note: utility accepts `number | null` (already converted from Decimal), not raw Prisma Decimal type.

**File 3: `src/lib/initiative-date-utils.ts`**

Purpose: Analyze initiative dates and produce intelligence flags.

Import from date-fns (already installed v4.1.0): `differenceInDays`, `isPast`, `isBefore`, `intervalToDuration`.

Required exports:
- `analyzeDates(startDate: string | Date, endDate: string | Date, status: string): DateIntelligence` -- Detects 5 flags:
  1. `invalid-dates`: end before start (return early with durationDays 0)
  2. `overdue`: end is past AND status not COMPLETED/CANCELLED
  3. `ending-soon`: end not past, within 14 days, not COMPLETED/CANCELLED
  4. `late-start`: start is past AND status is NOT_STARTED
  5. `long-duration`: duration > 180 days

Required types (define in same file):
- `DateFlag = 'overdue' | 'ending-soon' | 'late-start' | 'invalid-dates' | 'long-duration'`
- `DateIntelligence` -- durationDays (number), durationLabel (string), flags (DateFlag[]), isOverdue (boolean), daysUntilEnd (number | null)

Duration label: use `intervalToDuration` to get months/days, format as "3mo 15d" or "0d".
daysUntilEnd: null if end date is past, otherwise differenceInDays(end, today).

See research code example for complete implementation.
  </action>
  <verify>
1. `npx next build` succeeds (TypeScript compilation validates all 3 files)
2. Verify normalizeKeyResult handles all cases by checking the source contains `trim().toUpperCase().replace(/\s+/g, '')`
3. Verify KPI utility has zero-target guard: source contains `target && target > 0` check before division
4. Verify date utility imports from date-fns: source contains `from 'date-fns'`
5. Verify NO modifications to existing files: `git diff src/lib/date-utils.ts` and `git diff src/lib/utils.ts` should show no changes
  </verify>
  <done>
Three utility files exist in src/lib/ with correct exports:
- initiative-group-utils.ts: normalizeKeyResult resolves "KR1.1", " kr1.1 ", "KR 1.1" to same value
- initiative-kpi-utils.ts: calculateKpi handles null projects ("No data"), zero target (no division), null revenue (treated as 0)
- initiative-date-utils.ts: analyzeDates returns flags for overdue, ending-soon, late-start, invalid-dates, long-duration
All files use their own TypeScript interfaces. No existing files modified. Build passes.
  </done>
</task>

</tasks>

<verification>
1. `npx prisma db push` completed successfully (schema synced to MariaDB)
2. `npx next build` passes with zero errors
3. All 28 existing initiatives have null KPI fields (no data corruption)
4. Three new utility files exist: initiative-group-utils.ts, initiative-kpi-utils.ts, initiative-date-utils.ts
5. No existing files modified (git diff confirms date-utils.ts, utils.ts unchanged)
6. normalizeKeyResult uses aggressive normalization (trim + uppercase + remove all spaces)
7. calculateKpi never divides by zero (guards against null/zero target)
8. analyzeDates imports from date-fns and returns all 5 flag types
</verification>

<success_criteria>
- Initiative model has kpiLabel, kpiTarget, kpiActual, kpiUnit, kpiManualOverride fields
- Database migration is additive only (SCHEMA-02 satisfied)
- Three utility modules export pure functions with documented interfaces
- All edge cases from roadmap success criteria are handled in utility code
- Build compiles successfully with no TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/38-schema-utilities-foundation/38-01-SUMMARY.md`
</output>
