# Plan 67-01: Schema + Cost CRUD + AI Import for Quantity/Unit Price

## Frontmatter

- **Phase:** 67
- **Plan:** 01 of 02
- **Wave:** 1
- **Depends on:** None (first plan)
- **Autonomous:** yes
- **Files modified:**
  - `prisma/schema.prisma`
  - `src/app/api/projects/[id]/costs/route.ts`
  - `src/app/api/projects/[id]/costs/[costId]/route.ts`
  - `src/app/api/ai/import/receipt/route.ts`
  - `src/lib/ai-auto-import.ts`
  - `src/types/ai-extraction.ts`
  - `src/components/projects/cost-form.tsx`
  - `src/components/projects/cost-card.tsx`
  - `.claude/skills/ai-analyze/instructions/document-receipt.md`

## Context

Phase 67 adds quantity and unit price tracking to cost line items. This plan covers the schema migration, all API updates, form UI changes, and AI import integration. The canonical total remains `amount` -- quantity and unitPrice are optional enrichment fields.

## Tasks

<task id="1">
**Add quantity and unitPrice to Cost model in Prisma schema**

In `prisma/schema.prisma`, add two optional Decimal fields to the Cost model:

```prisma
  // Line item pricing (optional - for quantity/unit price tracking)
  quantity   Decimal? @db.Decimal(10, 2)
  unitPrice  Decimal? @map("unit_price") @db.Decimal(12, 2)
```

Add them after the `normalizedItem` field and before `supplierId`. These are both optional so existing costs remain valid.

Run `npx prisma migrate dev --name add-cost-quantity-unit-price` to create and apply the migration.

Verify: `npx prisma migrate status` shows no pending migrations.
</task>

<task id="2">
**Update POST /api/projects/[id]/costs to accept quantity and unitPrice**

In `src/app/api/projects/[id]/costs/route.ts`:

1. In the `prisma.cost.create` data block, add:
   ```typescript
   quantity: body.quantity !== undefined && body.quantity !== null ? parseFloat(body.quantity) : null,
   unitPrice: body.unitPrice !== undefined && body.unitPrice !== null ? parseFloat(body.unitPrice) : null,
   ```
2. The amount field continues to be the required canonical total.
</task>

<task id="3">
**Update PATCH /api/projects/[id]/costs/[costId] to accept quantity and unitPrice**

In `src/app/api/projects/[id]/costs/[costId]/route.ts`:

1. Add to the `updateData` type definition:
   ```typescript
   quantity?: number | null
   unitPrice?: number | null
   ```
2. Add handling in the conditional block:
   ```typescript
   if (body.quantity !== undefined) {
     updateData.quantity = body.quantity !== null ? parseFloat(body.quantity) : null
   }
   if (body.unitPrice !== undefined) {
     updateData.unitPrice = body.unitPrice !== null ? parseFloat(body.unitPrice) : null
   }
   ```
</task>

<task id="4">
**Update CostForm to support quantity and unit price with auto-calculation**

In `src/components/projects/cost-form.tsx`:

1. Add `quantity` and `unitPrice` to the `Cost` interface:
   ```typescript
   quantity?: number | null
   unitPrice?: number | null
   ```

2. Add state variables:
   ```typescript
   const [quantity, setQuantity] = useState(cost?.quantity?.toString() || '')
   const [unitPrice, setUnitPrice] = useState(cost?.unitPrice?.toString() || '')
   ```

3. Add auto-calculation effect: When both quantity and unitPrice are non-empty valid numbers, auto-set the amount field:
   ```typescript
   // Auto-calculate amount when quantity and unitPrice change
   useEffect(() => {
     const qty = parseFloat(quantity)
     const price = parseFloat(unitPrice)
     if (!isNaN(qty) && qty > 0 && !isNaN(price) && price > 0) {
       setAmount((qty * price).toFixed(2))
     }
   }, [quantity, unitPrice])
   ```
   Import `useEffect` from React.

4. Add Quantity and Unit Price fields in the form grid, in a new row between Description and Amount:
   ```tsx
   {/* Quantity */}
   <div className="space-y-2">
     <Label htmlFor="cost-quantity">Quantity</Label>
     <Input
       id="cost-quantity"
       type="number"
       step="0.01"
       min="0"
       value={quantity}
       onChange={(e) => setQuantity(e.target.value)}
       placeholder="e.g., 5"
     />
   </div>

   {/* Unit Price */}
   <div className="space-y-2">
     <Label htmlFor="cost-unit-price">Unit Price (RM)</Label>
     <Input
       id="cost-unit-price"
       type="number"
       step="0.01"
       min="0"
       value={unitPrice}
       onChange={(e) => setUnitPrice(e.target.value)}
       placeholder="0.00"
     />
   </div>
   ```

5. Update the submit payload to include quantity and unitPrice:
   ```typescript
   body: JSON.stringify({
     description: description.trim(),
     amount: parseFloat(amount),
     categoryId,
     date: date.toISOString(),
     supplierId: supplierId || null,
     quantity: quantity ? parseFloat(quantity) : null,
     unitPrice: unitPrice ? parseFloat(unitPrice) : null,
   }),
   ```

6. Add a helper text below the Amount field when qty * unitPrice is being used:
   ```tsx
   {quantity && unitPrice && !isNaN(parseFloat(quantity)) && !isNaN(parseFloat(unitPrice)) && (
     <p className="text-xs text-muted-foreground">
       Auto-calculated: {quantity} x RM {parseFloat(unitPrice).toFixed(2)}
     </p>
   )}
   ```
</task>

<task id="5">
**Update CostCard to display quantity and unit price**

In `src/components/projects/cost-card.tsx`:

1. Add `quantity` and `unitPrice` to the `Cost` interface:
   ```typescript
   quantity?: number | null
   unitPrice?: number | null
   ```

2. In the card's amount display area, when quantity and unitPrice are present, show the breakdown below the total:
   ```tsx
   {cost.quantity && cost.unitPrice && (
     <span className="text-xs text-gray-500 block">
       {cost.quantity} x {formatCurrency(cost.unitPrice)}
     </span>
   )}
   ```
   Place this after the `formatCurrency(cost.amount)` span.
</task>

<task id="6">
**Update ReceiptItem type and receipt import to support quantity and unitPrice**

1. In `src/types/ai-extraction.ts`, add to the `ReceiptItem` interface:
   ```typescript
   quantity?: number
   unitPrice?: number
   ```

2. In `src/app/api/ai/import/receipt/route.ts`:
   - Add `quantity` and `unitPrice` to the `ReceiptImportItem` interface:
     ```typescript
     quantity?: number | null
     unitPrice?: number | null
     ```
   - In the cost creation block (the `prisma.cost.create` call), add:
     ```typescript
     quantity: item.quantity ?? null,
     unitPrice: item.unitPrice ?? null,
     ```

3. In `src/lib/ai-auto-import.ts`:
   - The receipt items interface already does not have qty/unitPrice. Add them as optional:
     ```typescript
     items?: Array<{
       description: string
       amount: number
       quantity?: number
       unitPrice?: number
       suggestedCategory?: string
       confidence: ConfidenceLevel
     }>
     ```
   - In the cost creation within `autoImportReceipt`, add:
     ```typescript
     quantity: item.quantity ?? null,
     unitPrice: item.unitPrice ?? null,
     ```
</task>

<task id="7">
**Update receipt extraction instructions to include quantity and unitPrice**

In `.claude/skills/ai-analyze/instructions/document-receipt.md`:

1. Update the "Line Items (per item)" section to add:
   ```
   - **Quantity**: Number of items (if discernible)
   - **Unit Price**: Price per unit (if discernible)
   ```

2. Update the output format JSON to include quantity and unitPrice in lineItems:
   ```json
   "lineItems": [
     {
       "description": "Cable Tie 100pcs",
       "quantity": 1,
       "unitPrice": 8.90,
       "amount": 8.90,
       "confidence": "high"
     }
   ]
   ```
</task>

## Verification

- [ ] `npx prisma migrate status` shows no pending migrations
- [ ] Cost model has optional `quantity` (Decimal(10,2)) and `unitPrice` (Decimal(12,2)) fields
- [ ] POST /api/projects/[id]/costs accepts and persists quantity and unitPrice
- [ ] PATCH /api/projects/[id]/costs/[costId] accepts and persists quantity and unitPrice
- [ ] CostForm shows Quantity and Unit Price fields
- [ ] CostForm auto-calculates amount when quantity and unitPrice are filled
- [ ] CostCard shows qty x unitPrice breakdown when present
- [ ] AI receipt import persists quantity and unitPrice from extraction
- [ ] Existing costs without quantity/unitPrice continue to work unchanged
- [ ] `npx next build` completes without errors

## must_haves

- [ ] User can enter quantity and unit price when creating/editing a cost, with total auto-calculated (PRICE-01, PRICE-02)
- [ ] AI receipt import extracts and persists quantity and unit price from scanned documents (PRICE-03)
- [ ] Existing cost aggregation (sum of amount) remains unchanged -- amount is the canonical total (PRICE-06)
