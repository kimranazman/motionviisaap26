# Plan 67-02: Pricing History Views (By-Item + By-Client)

## Frontmatter

- **Phase:** 67
- **Plan:** 02 of 02
- **Wave:** 2
- **Depends on:** 67-01 (schema with quantity/unitPrice must exist)
- **Autonomous:** yes
- **Files modified:**
  - `src/app/api/pricing-history/route.ts` (NEW)
  - `src/app/(dashboard)/supplier-items/page.tsx`
  - `src/components/supplier-items/supplier-items-table.tsx`
  - `src/components/supplier-items/pricing-history-by-item.tsx` (NEW)
  - `src/components/supplier-items/pricing-history-by-client.tsx` (NEW)
  - `src/components/supplier-items/pricing-tabs.tsx` (NEW)

## Context

This plan adds two new views to the existing Price Comparison page:
1. **By-Item view** -- Select a normalized item, see all historical prices across projects/suppliers with quantity and unit price detail
2. **By-Client view** -- Select a company, see all cost items charged to their projects

These are tabs on the existing `/supplier-items` page. The existing table becomes the "All Items" tab.

## Tasks

<task id="1">
**Create pricing history API endpoint**

Create `src/app/api/pricing-history/route.ts`:

```typescript
import { NextRequest, NextResponse } from 'next/server'
import prisma from '@/lib/prisma'
import { requireAuth } from '@/lib/auth-utils'

// GET /api/pricing-history?view=by-item&item=Cement&view=by-client&companyId=xxx
export async function GET(request: NextRequest) {
  const { error } = await requireAuth()
  if (error) return error

  try {
    const searchParams = request.nextUrl.searchParams
    const view = searchParams.get('view') || 'by-item'

    if (view === 'by-item') {
      return handleByItem(searchParams)
    } else if (view === 'by-client') {
      return handleByClient(searchParams)
    }

    return NextResponse.json({ error: 'Invalid view' }, { status: 400 })
  } catch (error) {
    console.error('Error fetching pricing history:', error)
    return NextResponse.json(
      { error: 'Failed to fetch pricing history' },
      { status: 500 }
    )
  }
}
```

**handleByItem(searchParams):**
- Optional filter: `item` (normalizedItem value)
- Query: `prisma.cost.findMany` where `normalizedItem` is not null (and optionally equals `item` filter)
- Select: id, description, normalizedItem, amount, quantity, unitPrice, date, supplier (id, name), project (id, title, company { id, name })
- Order by: normalizedItem asc, date desc
- Also return: distinct normalizedItem values for the dropdown
- Serialize Decimals to Numbers

**handleByClient(searchParams):**
- Optional filter: `companyId`
- Query: `prisma.cost.findMany` where project has a company (not null), optionally where project.company.id equals `companyId`
- Select: id, description, normalizedItem, amount, quantity, unitPrice, date, category (id, name), supplier (id, name), project (id, title, company { id, name })
- Order by: date desc
- Also return: distinct companies for the dropdown
- Serialize Decimals to Numbers
</task>

<task id="2">
**Create PricingTabs component for tab navigation**

Create `src/components/supplier-items/pricing-tabs.tsx`:

A client component that renders three tabs:
- "All Items" (existing supplier items table)
- "By Item" (pricing history grouped by normalized item)
- "By Client" (costs grouped by company)

Use shadcn Tabs component:
```tsx
'use client'

import { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs'

interface PricingTabsProps {
  allItemsContent: React.ReactNode
  byItemContent: React.ReactNode
  byClientContent: React.ReactNode
}

export function PricingTabs({ allItemsContent, byItemContent, byClientContent }: PricingTabsProps) {
  return (
    <Tabs defaultValue="all" className="w-full">
      <TabsList>
        <TabsTrigger value="all">All Items</TabsTrigger>
        <TabsTrigger value="by-item">By Item</TabsTrigger>
        <TabsTrigger value="by-client">By Client</TabsTrigger>
      </TabsList>
      <TabsContent value="all">{allItemsContent}</TabsContent>
      <TabsContent value="by-item">{byItemContent}</TabsContent>
      <TabsContent value="by-client">{byClientContent}</TabsContent>
    </Tabs>
  )
}
```
</task>

<task id="3">
**Create By-Item pricing history component**

Create `src/components/supplier-items/pricing-history-by-item.tsx`:

A client component that:
1. Accepts `normalizedItems: string[]` as initial data for the dropdown
2. Has a Select dropdown to pick a normalized item (or "All Items")
3. Fetches from `/api/pricing-history?view=by-item&item=X` when selection changes (or all on initial load)
4. Shows a table with columns: Description, Qty, Unit Price, Total (amount), Supplier, Project, Date
5. Shows summary stats at top: min price, max price, average price, total entries
6. Groups visually by normalized item when showing all items

Table structure:
```
| Description | Qty | Unit Price | Total | Supplier | Project | Date |
```

If quantity and unitPrice are null for a row, show "-" in those columns.

Use `formatCurrency` from `@/lib/utils` for price formatting.
</task>

<task id="4">
**Create By-Client pricing history component**

Create `src/components/supplier-items/pricing-history-by-client.tsx`:

A client component that:
1. Accepts `companies: { id: string; name: string }[]` as initial data for the dropdown
2. Has a Select dropdown to pick a company (or "All Companies")
3. Fetches from `/api/pricing-history?view=by-client&companyId=X` when selection changes
4. Shows a table with columns: Description, Category, Qty, Unit Price, Amount, Supplier, Project, Date
5. Shows summary at top: total spend, item count

Table structure:
```
| Description | Category | Qty | Unit Price | Amount | Supplier | Project | Date |
```

If quantity and unitPrice are null for a row, show "-" in those columns.
</task>

<task id="5">
**Update supplier-items page to use tabs with all three views**

In `src/app/(dashboard)/supplier-items/page.tsx`:

1. Import `PricingTabs`, `PricingHistoryByItem`, `PricingHistoryByClient`
2. Fetch additional data needed:
   - Normalized items list (already have `categoryList`)
   - Companies list: `prisma.company.findMany({ select: { id: true, name: true }, orderBy: { name: 'asc' } })`
3. Replace the direct `SupplierItemsTable` render with `PricingTabs`:
   ```tsx
   <PricingTabs
     allItemsContent={
       <SupplierItemsTable initialItems={serializedCosts} categories={categoryList} suppliers={suppliers} />
     }
     byItemContent={
       <PricingHistoryByItem normalizedItems={categoryList} />
     }
     byClientContent={
       <PricingHistoryByClient companies={companies} />
     }
   />
   ```
4. Update the page title to "Pricing History" (was "Price Comparison")
5. Update metadata title accordingly
</task>

<task id="6">
**Update existing supplier-items table to show quantity and unit price columns**

In `src/components/supplier-items/supplier-items-table.tsx`:

1. Add `quantity` and `unitPrice` to the `SupplierItem` interface:
   ```typescript
   quantity?: number | null
   unitPrice?: number | null
   ```
2. Add two new columns to the table between Price and Project:
   - Qty column (hidden on mobile): shows quantity or "-"
   - Unit Price column (hidden on mobile): shows unitPrice formatted or "-"
3. Update the Price column header text to "Total" for clarity
4. Update the `serializedCosts` in the page.tsx to include quantity and unitPrice in the select
</task>

## Verification

- [ ] `/supplier-items` page shows three tabs: All Items, By Item, By Client
- [ ] "All Items" tab shows existing supplier items table with new Qty and Unit Price columns
- [ ] "By Item" tab has a dropdown of normalized items and shows pricing history
- [ ] "By Client" tab has a dropdown of companies and shows costs per client
- [ ] API `/api/pricing-history?view=by-item` returns costs grouped by normalized item
- [ ] API `/api/pricing-history?view=by-client` returns costs grouped by company
- [ ] Summary statistics (min/max/avg for by-item, total spend for by-client) display correctly
- [ ] Empty states show appropriate messages
- [ ] `npx next build` completes without errors

## must_haves

- [ ] User can view pricing history for a specific normalized item across all projects (PRICE-04)
- [ ] User can view all items charged to a specific company (PRICE-05)
- [ ] Existing cost aggregation (sum of amount) remains unchanged (PRICE-06)
