---
phase: 32-project-deliverables
plan: 02
type: execute
wave: 2
depends_on: ["32-01"]
files_modified:
  - src/types/ai-extraction.ts
  - src/app/api/ai/import/deliverable/route.ts
  - src/components/ai/deliverable-review-sheet.tsx
  - src/components/projects/project-detail-sheet.tsx
  - src/components/projects/documents-section.tsx
autonomous: true

must_haves:
  truths:
    - "AI extracts deliverables from uploaded Talenta/Motionvii invoices/quotes"
    - "User can review AI-extracted deliverables before import"
    - "Imported deliverables are marked with AI badge"
  artifacts:
    - path: "src/types/ai-extraction.ts"
      provides: "DeliverableExtraction type"
      contains: "DeliverableExtraction"
    - path: "src/app/api/ai/import/deliverable/route.ts"
      provides: "POST endpoint to import deliverables"
      exports: ["POST"]
    - path: "src/components/ai/deliverable-review-sheet.tsx"
      provides: "Review UI for AI-extracted deliverables"
      exports: ["DeliverableReviewSheet"]
  key_links:
    - from: "src/components/projects/project-detail-sheet.tsx"
      to: "src/components/ai/deliverable-review-sheet.tsx"
      via: "import and conditional render"
      pattern: "DeliverableReviewSheet"
    - from: "src/components/ai/deliverable-review-sheet.tsx"
      to: "/api/ai/import/deliverable"
      via: "fetch POST"
      pattern: "api/ai/import/deliverable"
---

<objective>
Enable AI extraction of deliverables from Talenta/Motionvii quotes/invoices.

Purpose: When users upload our own quotes/invoices, AI should extract line items as deliverables so users don't have to manually enter scope items.
Output: DeliverableExtraction type, import API endpoint, DeliverableReviewSheet component, integration in ProjectDetailSheet.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/32-project-deliverables/32-RESEARCH.md
@.planning/phases/32-project-deliverables/32-01-SUMMARY.md

# Existing AI patterns
@src/types/ai-extraction.ts
@src/app/api/ai/import/invoice/route.ts
@src/components/ai/ai-review-sheet.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: AI Extraction Types and Import Endpoint</name>
  <files>
    src/types/ai-extraction.ts
    src/app/api/ai/import/deliverable/route.ts
  </files>
  <action>
Extend AI extraction types and create import endpoint for deliverables.

**ai-extraction.ts additions:**
Add DeliverableItem and DeliverableExtraction types:

```typescript
// Deliverable item extracted from quote/invoice (v1.4 - Phase 32)
export interface DeliverableItem {
  title: string
  description?: string
  value: number
  confidence: ConfidenceLevel
}

// Deliverable extraction from Talenta/Motionvii quote/invoice
export interface DeliverableExtraction {
  documentId: string
  confidence: ConfidenceLevel
  documentType: 'QUOTE' | 'INVOICE'
  issuer?: string  // "Talenta" or "Motionvii"
  deliverables: DeliverableItem[]
  documentTotal: number
  notes?: string
  warnings?: string[]
}
```

Update AIAnalysisResult to include deliverables:
```typescript
export interface AIAnalysisResult {
  // ... existing fields
  deliverables?: DeliverableExtraction[]  // Optional for backward compatibility
}
```

**api/ai/import/deliverable/route.ts (follow invoice import pattern):**
- POST handler accepting: projectId, extraction (DeliverableExtraction), documentId
- Validate projectId, extraction.deliverables array
- Verify project exists
- Get max sortOrder, then create deliverables in transaction
- Set aiExtracted: true on all created deliverables
- Update document aiStatus to IMPORTED if documentId provided
- Return success with createdCount and deliverables array
- Use requireEditor() for auth
  </action>
  <verify>
```bash
# Test import endpoint with mock data
curl -X POST http://localhost:3000/api/ai/import/deliverable \
  -H "Content-Type: application/json" \
  -d '{
    "projectId": "{testProjectId}",
    "extraction": {
      "documentId": "{testDocId}",
      "confidence": "HIGH",
      "documentType": "INVOICE",
      "deliverables": [
        {"title": "Event Production", "value": 25000, "confidence": "HIGH"},
        {"title": "AV Equipment Rental", "value": 5000, "confidence": "MEDIUM"}
      ],
      "documentTotal": 30000
    }
  }' | head -30
```
Verify: Returns success with createdCount: 2, deliverables array with aiExtracted: true
  </verify>
  <done>
DeliverableExtraction type exists in ai-extraction.ts. Import endpoint creates deliverables with aiExtracted flag and updates document status.
  </done>
</task>

<task type="auto">
  <name>Task 2: Deliverable Review Sheet and Integration</name>
  <files>
    src/components/ai/deliverable-review-sheet.tsx
    src/components/projects/project-detail-sheet.tsx
    src/components/projects/documents-section.tsx
  </files>
  <action>
Create DeliverableReviewSheet and integrate into document review flow.

**deliverable-review-sheet.tsx (follow ai-review-sheet.tsx pattern):**
- Props: open, onOpenChange, projectId, document, extraction (DeliverableExtraction), onImportComplete
- State: isImporting, editableDeliverables (with selected boolean)
- Initialize items with selected = true for HIGH/MEDIUM confidence
- Display: document preview (image or PDF link), extraction summary (issuer, total, confidence)
- Editable table: checkbox, title (editable input), value (editable number), confidence badge
- Actions: Discard button, Import button (disabled if none selected)
- On import: POST to /api/ai/import/deliverable with selected items, toast success, call onImportComplete

**project-detail-sheet.tsx additions:**
- Add reviewDeliverableDocument and reviewDeliverableExtraction state
- Add isDeliverableReviewOpen state
- Add handleReviewDeliverable function (similar to handleReviewDocument but for deliverables)
- Add handleDeliverableImportComplete function
- Conditionally render DeliverableReviewSheet when reviewDeliverableExtraction exists
- After import complete, refresh deliverables list

**documents-section.tsx enhancement:**
- Add onReviewDeliverable prop alongside existing onReview
- When document is INVOICE and AI results contain deliverables, show "Import Deliverables" button
- The button calls onReviewDeliverable(document, deliverableExtraction)

NOTE: For this phase, AI extraction prompt is NOT modified. Users will use Claude Code to manually analyze documents with the deliverable extraction prompt from RESEARCH.md. The flow is:
1. User uploads invoice document (already works)
2. User runs AI analysis (Claude Code generates ai-results.json with deliverables array)
3. User clicks "Import Deliverables" on invoice document
4. DeliverableReviewSheet opens, user reviews and imports
  </action>
  <verify>
1. Upload a Talenta/Motionvii invoice to a project
2. Run AI analysis (manually or via existing workflow)
3. Ensure ai-results.json contains deliverables array for the document
4. Click "Import Deliverables" button on the document
5. DeliverableReviewSheet opens with extracted deliverables
6. Select/deselect items, verify totals update
7. Click Import, verify deliverables created with AI badge
8. Verify document status updated to IMPORTED
  </verify>
  <done>
DeliverableReviewSheet displays AI-extracted deliverables for review. Import creates deliverables marked aiExtracted. Documents section shows Import Deliverables button for invoices with deliverable extractions.
  </done>
</task>

</tasks>

<verification>
DELV-05 requirement met:
- AI extraction types exist for deliverables
- Import endpoint creates deliverables from extraction
- Review UI allows user to select/edit before import
- Imported deliverables show AI badge in DeliverableCard
</verification>

<success_criteria>
1. DeliverableExtraction type added to ai-extraction.ts
2. Import endpoint at /api/ai/import/deliverable works
3. DeliverableReviewSheet displays extraction for review
4. Users can select which deliverables to import
5. Imported deliverables marked with aiExtracted: true and show AI badge
6. Document status updates to IMPORTED after successful import
</success_criteria>

<output>
After completion, create `.planning/phases/32-project-deliverables/32-02-SUMMARY.md`
</output>
