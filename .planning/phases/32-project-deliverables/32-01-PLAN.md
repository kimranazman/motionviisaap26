---
phase: 32-project-deliverables
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/app/api/projects/[id]/deliverables/route.ts
  - src/app/api/projects/[id]/deliverables/[deliverableId]/route.ts
  - src/components/projects/deliverable-form.tsx
  - src/components/projects/deliverable-card.tsx
  - src/components/projects/project-detail-sheet.tsx
autonomous: true

must_haves:
  truths:
    - "User can create deliverable on project with title and value"
    - "User can view list of deliverables on project detail"
    - "User can edit deliverable details"
    - "User can delete deliverable with confirmation"
  artifacts:
    - path: "src/app/api/projects/[id]/deliverables/route.ts"
      provides: "GET (list) and POST (create) deliverables"
      exports: ["GET", "POST"]
    - path: "src/app/api/projects/[id]/deliverables/[deliverableId]/route.ts"
      provides: "PATCH and DELETE for single deliverable"
      exports: ["PATCH", "DELETE"]
    - path: "src/components/projects/deliverable-form.tsx"
      provides: "Form for creating/editing deliverables"
      exports: ["DeliverableForm"]
    - path: "src/components/projects/deliverable-card.tsx"
      provides: "Display card with edit/delete actions"
      exports: ["DeliverableCard"]
  key_links:
    - from: "src/components/projects/project-detail-sheet.tsx"
      to: "src/components/projects/deliverable-form.tsx"
      via: "import and render"
      pattern: "DeliverableForm"
    - from: "src/components/projects/deliverable-form.tsx"
      to: "/api/projects/[id]/deliverables"
      via: "fetch POST/PATCH"
      pattern: "fetch.*deliverables"
    - from: "src/components/projects/deliverable-card.tsx"
      to: "/api/projects/[id]/deliverables/[deliverableId]"
      via: "fetch DELETE"
      pattern: "method.*DELETE"
---

<objective>
Implement deliverable CRUD operations for project scope tracking.

Purpose: Users need to track individual scope items (deliverables) from client quotes so they can see what work was promised and its value.
Output: API routes for deliverable CRUD, DeliverableForm and DeliverableCard components, DeliverablesSection integrated into ProjectDetailSheet.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/32-project-deliverables/32-RESEARCH.md

# Existing patterns to follow
@src/app/api/projects/[id]/costs/route.ts
@src/components/projects/cost-form.tsx
@src/components/projects/cost-card.tsx
@src/components/projects/project-detail-sheet.tsx
@prisma/schema.prisma
</context>

<tasks>

<task type="auto">
  <name>Task 1: Deliverable API Routes</name>
  <files>
    src/app/api/projects/[id]/deliverables/route.ts
    src/app/api/projects/[id]/deliverables/[deliverableId]/route.ts
  </files>
  <action>
Create REST API routes for deliverable CRUD following the Cost API pattern exactly.

**route.ts (GET, POST):**
- GET: List deliverables for project, ordered by sortOrder ASC then createdAt DESC
- POST: Create deliverable with title (required), description (optional), value (optional, Decimal)
- On POST: Calculate next sortOrder as max existing + 1
- Convert Decimal value to Number in responses
- Use requireAuth() for GET, requireEditor() for POST
- Validate project exists before operations

**[deliverableId]/route.ts (PATCH, DELETE):**
- PATCH: Update title, description, value
- DELETE: Delete deliverable (Prisma cascade handles it)
- Use requireEditor() for both
- Validate both project and deliverable exist

Reference schema.prisma Deliverable model:
- id, title (required), description (optional), value (optional Decimal)
- sortOrder (default 0), projectId (FK), aiExtracted (boolean)
  </action>
  <verify>
Run curl commands to verify:
```bash
# Test GET (empty list)
curl -s http://localhost:3000/api/projects/{testProjectId}/deliverables | head -20

# Test POST
curl -X POST http://localhost:3000/api/projects/{testProjectId}/deliverables \
  -H "Content-Type: application/json" \
  -d '{"title":"Event Production","value":25000}' | head -20

# Test PATCH and DELETE via browser/curl
```
  </verify>
  <done>
GET returns deliverable list, POST creates deliverable with auto sortOrder, PATCH updates deliverable, DELETE removes deliverable.
  </done>
</task>

<task type="auto">
  <name>Task 2: Deliverable UI Components and Integration</name>
  <files>
    src/components/projects/deliverable-form.tsx
    src/components/projects/deliverable-card.tsx
    src/components/projects/project-detail-sheet.tsx
  </files>
  <action>
Create DeliverableForm and DeliverableCard components following Cost patterns, then integrate into ProjectDetailSheet.

**deliverable-form.tsx (follow cost-form.tsx):**
- Props: projectId, deliverable? (for edit), onSuccess, onCancel
- State: title, description, value, isSubmitting, error
- Form fields: title (required input), description (textarea), value (number input with RM prefix)
- Validation: title required
- POST for create, PATCH for edit
- No date/category fields (simpler than Cost)

**deliverable-card.tsx (follow cost-card.tsx):**
- Props: deliverable, projectId, onEdit, onDelete
- Display: title, value (if exists), AI badge (if aiExtracted)
- Actions: Edit button, Delete button with AlertDialog confirmation
- Delete calls API and triggers onDelete callback
- Use formatCurrency for value display

**project-detail-sheet.tsx integration:**
- Add deliverables state: useState<Deliverable[]>([])
- Fetch deliverables in useEffect when project changes
- Add Deliverables section between Financials Summary and Costs section
- Section header: "Deliverables" with count badge, Add button
- Empty state: Package icon, "No deliverables defined", Add button
- List: Map deliverables to DeliverableCard components
- Add handlers: handleDeliverablesRefresh, handleDeliverableAdded, handleEditDeliverable, handleDeleteDeliverable
- Import Package icon from lucide-react
  </action>
  <verify>
1. Open a project in the UI
2. Verify Deliverables section appears between Financials and Costs
3. Add a deliverable with title "Event Production" and value 25000
4. Verify deliverable card shows with formatted value (RM 25,000.00)
5. Edit the deliverable - change title
6. Delete the deliverable - confirm deletion works
  </verify>
  <done>
Deliverables section visible in ProjectDetailSheet with empty state. User can add deliverable with title and value. Card displays formatted value. Edit and delete work correctly.
  </done>
</task>

</tasks>

<verification>
All DELV-01 through DELV-04 requirements met:
- DELV-01: Create deliverable with title and value works
- DELV-02: View list of deliverables on project detail works
- DELV-03: Edit deliverable details works
- DELV-04: Delete deliverable with confirmation works
</verification>

<success_criteria>
1. API routes exist and respond correctly for all CRUD operations
2. DeliverableForm validates title as required, handles create and edit
3. DeliverableCard displays deliverable info with edit/delete actions
4. ProjectDetailSheet shows Deliverables section with proper empty state
5. Full CRUD flow works end-to-end in the UI
</success_criteria>

<output>
After completion, create `.planning/phases/32-project-deliverables/32-01-SUMMARY.md`
</output>
