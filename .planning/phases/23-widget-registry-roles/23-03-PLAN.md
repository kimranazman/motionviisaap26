---
phase: 23-widget-registry-roles
plan: 03
type: execute
wave: 3
depends_on: ["23-02"]
files_modified:
  - src/app/api/admin/dashboard/layout/route.ts
  - src/app/api/admin/dashboard/roles/route.ts
  - src/app/(dashboard)/page.tsx
autonomous: true

must_haves:
  truths:
    - "Admin can GET current default layout via API"
    - "Admin can PUT updated default layout via API"
    - "Admin can GET current widget role restrictions via API"
    - "Admin can PUT updated widget role restrictions via API"
    - "Non-admin users receive 403 Forbidden on admin endpoints"
    - "Dashboard page filters widgets server-side based on user role"
    - "CRM widgets only render for EDITOR+ roles"
    - "Data for hidden widgets is not fetched"
  artifacts:
    - path: "src/app/api/admin/dashboard/layout/route.ts"
      provides: "Admin API for default dashboard layout"
      exports: ["GET", "PUT"]
    - path: "src/app/api/admin/dashboard/roles/route.ts"
      provides: "Admin API for widget role restrictions"
      exports: ["GET", "PUT"]
    - path: "src/app/(dashboard)/page.tsx"
      provides: "Dashboard with server-side widget filtering"
      contains: "filterWidgetsByRole"
  key_links:
    - from: "src/app/api/admin/dashboard/layout/route.ts"
      to: "src/lib/widgets/defaults.ts"
      via: "uses getAdminDefaults and updateAdminDefaults"
      pattern: "import.*(getAdminDefaults|updateAdminDefaults).*from.*defaults"
    - from: "src/app/api/admin/dashboard/roles/route.ts"
      to: "src/lib/widgets/defaults.ts"
      via: "uses getAdminDefaults and updateAdminDefaults"
      pattern: "import.*(getAdminDefaults|updateAdminDefaults).*from.*defaults"
    - from: "src/app/(dashboard)/page.tsx"
      to: "src/lib/widgets/permissions.ts"
      via: "uses filterWidgetsByRole for server-side filtering"
      pattern: "import.*filterWidgetsByRole.*from.*permissions"
    - from: "src/app/(dashboard)/page.tsx"
      to: "src/lib/widgets/defaults.ts"
      via: "uses getAdminDefaults for role restrictions"
      pattern: "import.*getAdminDefaults.*from.*defaults"
---

<objective>
Create admin API routes for managing dashboard defaults and update the dashboard page to enforce role-based widget visibility server-side.

Purpose: Enable admins to configure default layouts and role restrictions, and enforce these restrictions server-side so VIEWER users cannot see CRM/revenue widgets.

Output: Two admin API routes (layout and roles) and updated dashboard page with server-side widget filtering.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/23-widget-registry-roles/23-RESEARCH.md
@.planning/phases/23-widget-registry-roles/23-02-SUMMARY.md

# Reference from prior plans
@src/lib/widgets/registry.ts
@src/lib/widgets/permissions.ts
@src/lib/widgets/defaults.ts
@src/lib/auth-utils.ts
@src/app/(dashboard)/page.tsx
@src/auth.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Admin Dashboard Layout API</name>
  <files>src/app/api/admin/dashboard/layout/route.ts</files>
  <action>
Create src/app/api/admin/dashboard/layout/route.ts with:

1. Imports:
   - NextRequest, NextResponse from next/server
   - requireAdmin from @/lib/auth-utils
   - getAdminDefaults, updateAdminDefaults from @/lib/widgets/defaults
   - WIDGET_REGISTRY from @/lib/widgets/registry
   - revalidatePath from next/cache

2. GET handler:
   - Call requireAdmin() and return error if not authorized
   - Call getAdminDefaults()
   - Return JSON: { dashboardLayout: defaults.dashboardLayout, widgets: [...] }
   - widgets array: map WIDGET_REGISTRY to { id, title, category, defaultSize }

3. PUT handler:
   - Call requireAdmin() and return error if not authorized
   - Parse JSON body expecting { dashboardLayout: DashboardLayout }
   - Validate all widget IDs in layout exist in WIDGET_REGISTRY
   - Call updateAdminDefaults({ dashboardLayout })
   - Call revalidatePath('/') to invalidate dashboard cache
   - Return JSON: { success: true }
   - Wrap in try/catch, return 500 on error

Create directory structure: src/app/api/admin/dashboard/layout/
  </action>
  <verify>
TypeScript compiles: `cd /Users/khairul/Documents/MyDev/Work/Motionvii/saap2026v2 && npx tsc --noEmit`

File exists: `ls -la /Users/khairul/Documents/MyDev/Work/Motionvii/saap2026v2/src/app/api/admin/dashboard/layout/route.ts`
  </verify>
  <done>
src/app/api/admin/dashboard/layout/route.ts exists with GET and PUT handlers, admin-only access, and cache revalidation.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Admin Widget Roles API</name>
  <files>src/app/api/admin/dashboard/roles/route.ts</files>
  <action>
Create src/app/api/admin/dashboard/roles/route.ts with:

1. Imports:
   - NextRequest, NextResponse from next/server
   - requireAdmin from @/lib/auth-utils
   - getAdminDefaults, updateAdminDefaults from @/lib/widgets/defaults
   - WIDGET_REGISTRY from @/lib/widgets/registry
   - WidgetRoleRestrictions from @/types/dashboard
   - revalidatePath from next/cache

2. GET handler:
   - Call requireAdmin() and return error if not authorized
   - Call getAdminDefaults()
   - Return JSON: {
       widgetRoles: defaults.widgetRoles,
       widgets: Object.values(WIDGET_REGISTRY).map(w => ({
         id: w.id,
         title: w.title,
         category: w.category,
         defaultMinRole: w.minRole
       }))
     }

3. PUT handler:
   - Call requireAdmin() and return error if not authorized
   - Parse JSON body expecting { widgetRoles: WidgetRoleRestrictions }
   - Validate all widget IDs in widgetRoles exist in WIDGET_REGISTRY
   - If unknown widget ID, return 400 with error message
   - Call updateAdminDefaults({ widgetRoles })
   - Call revalidatePath('/') to invalidate dashboard cache
   - Return JSON: { success: true }
   - Wrap in try/catch, return 500 on error

Create directory structure: src/app/api/admin/dashboard/roles/
  </action>
  <verify>
TypeScript compiles: `cd /Users/khairul/Documents/MyDev/Work/Motionvii/saap2026v2 && npx tsc --noEmit`

File exists: `ls -la /Users/khairul/Documents/MyDev/Work/Motionvii/saap2026v2/src/app/api/admin/dashboard/roles/route.ts`
  </verify>
  <done>
src/app/api/admin/dashboard/roles/route.ts exists with GET and PUT handlers, admin-only access, widget ID validation, and cache revalidation.
  </done>
</task>

<task type="auto">
  <name>Task 3: Update Dashboard Page with Server-Side Filtering</name>
  <files>src/app/(dashboard)/page.tsx</files>
  <action>
Update src/app/(dashboard)/page.tsx to:

1. Add imports at top:
   - auth from @/auth
   - redirect from next/navigation
   - filterWidgetsByRole from @/lib/widgets/permissions
   - getAdminDefaults from @/lib/widgets/defaults
   - WIDGET_IDS from @/lib/widgets/registry

2. In DashboardPage function (after existing data fetching):
   a) Get session: const session = await auth()
   b) If no session, redirect('/login')
   c) Get userRole: const userRole = session.user.role
   d) Get adminDefaults: const adminDefaults = await getAdminDefaults()
   e) Filter visible widgets:
      const visibleWidgetIds = filterWidgetsByRole(WIDGET_IDS, userRole, adminDefaults.widgetRoles)

3. Conditionally fetch CRM data:
   - Only call getCRMDashboardData() if visibleWidgetIds includes 'crm-kpi-cards' OR 'pipeline-stage-chart'
   - If not visible, set crmData = null

4. Conditionally render widgets in JSX:
   - Wrap KPICards in: {visibleWidgetIds.includes('kpi-cards') && ...}
   - Wrap StatusChart in: {visibleWidgetIds.includes('status-chart') && ...}
   - Wrap DepartmentChart in: {visibleWidgetIds.includes('department-chart') && ...}
   - Wrap TeamWorkload in: {visibleWidgetIds.includes('team-workload') && ...}
   - Wrap RecentInitiatives in: {visibleWidgetIds.includes('recent-initiatives') && ...}
   - Wrap CRMKPICards in: {crmData && visibleWidgetIds.includes('crm-kpi-cards') && ...}
   - Wrap PipelineStageChart in: {crmData && visibleWidgetIds.includes('pipeline-stage-chart') && ...}

5. Wrap Sales & Revenue section conditionally:
   - Only render the section div if at least one CRM widget is visible

Keep existing getDashboardData() and getCRMDashboardData() functions unchanged.
Maintain existing layout structure - just add conditional rendering.
  </action>
  <verify>
TypeScript compiles: `cd /Users/khairul/Documents/MyDev/Work/Motionvii/saap2026v2 && npx tsc --noEmit`

Check imports added:
`grep -E "filterWidgetsByRole|getAdminDefaults|WIDGET_IDS|auth" /Users/khairul/Documents/MyDev/Work/Motionvii/saap2026v2/src/app/\\(dashboard\\)/page.tsx`
  </verify>
  <done>
src/app/(dashboard)/page.tsx filters widgets server-side based on user role and adminDefaults.widgetRoles. CRM data only fetched if CRM widgets visible. VIEWER users see only KRI widgets.
  </done>
</task>

</tasks>

<verification>
1. TypeScript compiles: `npx tsc --noEmit`
2. Admin API routes exist and export GET/PUT handlers
3. Dashboard page imports permission utilities
4. Dashboard page conditionally renders widgets based on filterWidgetsByRole result
5. CRM data fetching is conditional (not fetched if CRM widgets not visible)

Manual verification (requires running app):
- VIEWER user should see only KRI widgets (5 widgets)
- EDITOR/ADMIN user should see all 7 widgets
- Admin API calls return proper data structure
</verification>

<success_criteria>
- /api/admin/dashboard/layout GET returns { dashboardLayout, widgets }
- /api/admin/dashboard/layout PUT updates default layout (admin only)
- /api/admin/dashboard/roles GET returns { widgetRoles, widgets }
- /api/admin/dashboard/roles PUT updates role restrictions (admin only)
- Dashboard page uses filterWidgetsByRole for server-side filtering
- CRM widgets (crm-kpi-cards, pipeline-stage-chart) hidden from VIEWER role
- CRM data not fetched when CRM widgets not visible
- No TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/23-widget-registry-roles/23-03-SUMMARY.md`
</output>
