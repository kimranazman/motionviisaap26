---
phase: 23-widget-registry-roles
plan: 02
type: execute
wave: 2
depends_on: ["23-01"]
files_modified:
  - src/lib/widgets/permissions.ts
  - src/lib/widgets/defaults.ts
autonomous: true

must_haves:
  truths:
    - "Permission utilities can check if a user role can view a widget"
    - "Role hierarchy is enforced: VIEWER < EDITOR < ADMIN"
    - "Admin overrides from widgetRoles take precedence over registry defaults"
    - "AdminDefaults singleton is created if missing (upsert pattern)"
    - "Default widget roles are derived from registry minRole values"
  artifacts:
    - path: "src/lib/widgets/permissions.ts"
      provides: "Widget permission checking utilities"
      exports: ["getRoleLevel", "hasMinimumRole", "canViewWidget", "filterWidgetsByRole", "getVisibleWidgets"]
    - path: "src/lib/widgets/defaults.ts"
      provides: "AdminDefaults management utilities"
      exports: ["DEFAULT_DASHBOARD_LAYOUT", "getDefaultWidgetRoles", "getAdminDefaults", "updateAdminDefaults", "ADMIN_DEFAULTS_ID"]
  key_links:
    - from: "src/lib/widgets/permissions.ts"
      to: "src/lib/widgets/registry.ts"
      via: "imports WIDGET_REGISTRY for permission checks"
      pattern: "import.*WIDGET_REGISTRY.*from.*registry"
    - from: "src/lib/widgets/defaults.ts"
      to: "src/lib/widgets/registry.ts"
      via: "imports WIDGET_REGISTRY for default layout generation"
      pattern: "import.*WIDGET_REGISTRY.*from.*registry"
    - from: "src/lib/widgets/defaults.ts"
      to: "@prisma/client"
      via: "prisma.adminDefaults for database operations"
      pattern: "prisma\\.adminDefaults\\.(upsert|update|findFirst)"
---

<objective>
Create permission checking utilities and AdminDefaults management functions for the widget system.

Purpose: Enable server-side widget filtering by role and provide admin defaults that new users inherit.

Output: Permission utilities (canViewWidget, filterWidgetsByRole) and AdminDefaults management (getAdminDefaults, updateAdminDefaults) with singleton upsert pattern.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/23-widget-registry-roles/23-RESEARCH.md
@.planning/phases/23-widget-registry-roles/23-01-SUMMARY.md

# Reference from Plan 01
@src/lib/widgets/registry.ts
@src/types/dashboard.ts
@src/lib/prisma.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Permission Utilities</name>
  <files>src/lib/widgets/permissions.ts</files>
  <action>
Create src/lib/widgets/permissions.ts with:

1. Imports:
   - UserRole from @prisma/client
   - WIDGET_REGISTRY from ./registry
   - WidgetRoleRestrictions from @/types/dashboard

2. Role hierarchy constant:
   const ROLE_HIERARCHY: UserRole[] = [UserRole.VIEWER, UserRole.EDITOR, UserRole.ADMIN]

3. Functions:
   a) getRoleLevel(role: UserRole): number
      - Returns index in ROLE_HIERARCHY (higher = more permissions)

   b) hasMinimumRole(userRole: UserRole, requiredRole: UserRole): boolean
      - Returns true if userRole level >= requiredRole level

   c) canViewWidget(widgetId: string, userRole: UserRole, widgetRoles?: WidgetRoleRestrictions): boolean
      - First check admin override in widgetRoles (if exists and has widgetId, check if userRole in allowed array)
      - Fall back to widget's default minRole from registry
      - Return false if widget not found in registry

   d) filterWidgetsByRole(widgetIds: string[], userRole: UserRole, widgetRoles?: WidgetRoleRestrictions): string[]
      - Filter array to only widgets user can view

   e) getVisibleWidgets(userRole: UserRole, widgetRoles?: WidgetRoleRestrictions): WidgetDefinition[]
      - Return array of widget definitions user can see
      - Import WidgetDefinition from @/types/dashboard

Export all functions.
  </action>
  <verify>
TypeScript compiles: `cd /Users/khairul/Documents/MyDev/Work/Motionvii/saap2026v2 && npx tsc --noEmit`

Test role hierarchy:
`cd /Users/khairul/Documents/MyDev/Work/Motionvii/saap2026v2 && node -e "
const { getRoleLevel, hasMinimumRole } = require('./src/lib/widgets/permissions');
console.log('VIEWER level:', getRoleLevel('VIEWER'));
console.log('EDITOR level:', getRoleLevel('EDITOR'));
console.log('ADMIN level:', getRoleLevel('ADMIN'));
console.log('VIEWER has VIEWER:', hasMinimumRole('VIEWER', 'VIEWER'));
console.log('VIEWER has EDITOR:', hasMinimumRole('VIEWER', 'EDITOR'));
console.log('EDITOR has VIEWER:', hasMinimumRole('EDITOR', 'VIEWER'));
"`
  </verify>
  <done>
src/lib/widgets/permissions.ts exports all permission functions with proper role hierarchy: VIEWER (0) < EDITOR (1) < ADMIN (2).
  </done>
</task>

<task type="auto">
  <name>Task 2: Create AdminDefaults Utilities</name>
  <files>src/lib/widgets/defaults.ts</files>
  <action>
Create src/lib/widgets/defaults.ts with:

1. Imports:
   - prisma from @/lib/prisma
   - DashboardLayout, WidgetRoleRestrictions from @/types/dashboard
   - WIDGET_REGISTRY from ./registry
   - UserRole from @prisma/client

2. Constants:
   - ADMIN_DEFAULTS_ID = 'singleton' (exported for reference)
   - DEFAULT_DASHBOARD_LAYOUT: DashboardLayout containing all 7 widgets with positions:
     - kpi-cards: x=0, y=0, w=12, h=2
     - status-chart: x=0, y=2, w=6, h=3
     - department-chart: x=6, y=2, w=6, h=3
     - team-workload: x=0, y=5, w=6, h=3
     - recent-initiatives: x=6, y=5, w=6, h=3
     - crm-kpi-cards: x=0, y=8, w=12, h=2
     - pipeline-stage-chart: x=0, y=10, w=12, h=3

3. Functions:
   a) getDefaultWidgetRoles(): WidgetRoleRestrictions
      - Iterate WIDGET_REGISTRY entries
      - For each widget, based on minRole, set allowed roles:
        - VIEWER -> ['VIEWER', 'EDITOR', 'ADMIN']
        - EDITOR -> ['EDITOR', 'ADMIN']
        - ADMIN -> ['ADMIN']
      - Use UserRole enum values as strings (they are string enums in Prisma)

   b) getAdminDefaults(): Promise<{ dashboardLayout: DashboardLayout; widgetRoles: WidgetRoleRestrictions; ... }>
      - Use prisma.adminDefaults.upsert with:
        - where: { id: ADMIN_DEFAULTS_ID }
        - update: {} (don't update if exists)
        - create: { id, dashboardLayout, widgetRoles from getDefaultWidgetRoles() }
      - Cast JSON fields to proper types before returning
      - Return typed object with dashboardLayout and widgetRoles

   c) updateAdminDefaults(updates: Partial<{ dashboardLayout: DashboardLayout; widgetRoles: WidgetRoleRestrictions }>): Promise<AdminDefaults>
      - Use prisma.adminDefaults.update
      - Only include provided fields in data
      - Cast types appropriately

Export: DEFAULT_DASHBOARD_LAYOUT, getDefaultWidgetRoles, getAdminDefaults, updateAdminDefaults, ADMIN_DEFAULTS_ID
  </action>
  <verify>
TypeScript compiles: `cd /Users/khairul/Documents/MyDev/Work/Motionvii/saap2026v2 && npx tsc --noEmit`

Check exports:
`cd /Users/khairul/Documents/MyDev/Work/Motionvii/saap2026v2 && node -e "
const d = require('./src/lib/widgets/defaults');
console.log('Layout widgets:', d.DEFAULT_DASHBOARD_LAYOUT.widgets.length);
const roles = d.getDefaultWidgetRoles();
console.log('kpi-cards roles:', roles['kpi-cards']);
console.log('crm-kpi-cards roles:', roles['crm-kpi-cards']);
"`
  </verify>
  <done>
src/lib/widgets/defaults.ts exports DEFAULT_DASHBOARD_LAYOUT with 7 widgets and getDefaultWidgetRoles() returns proper role arrays (KRI widgets allow VIEWER+, CRM widgets allow EDITOR+ only).
  </done>
</task>

</tasks>

<verification>
1. TypeScript compiles: `npx tsc --noEmit`
2. Permission checks work: VIEWER cannot view crm-kpi-cards (EDITOR required)
3. Permission checks work: EDITOR can view all widgets
4. Default roles derived correctly: KRI widgets get [VIEWER, EDITOR, ADMIN], CRM widgets get [EDITOR, ADMIN]
5. AdminDefaults layout has all 7 widgets with positions
</verification>

<success_criteria>
- src/lib/widgets/permissions.ts exports canViewWidget, filterWidgetsByRole, getVisibleWidgets
- src/lib/widgets/defaults.ts exports getAdminDefaults, updateAdminDefaults
- Role hierarchy: VIEWER(0) < EDITOR(1) < ADMIN(2)
- Admin override takes precedence over registry default
- Upsert pattern creates AdminDefaults singleton if missing
- Default layout includes all 7 widgets
- No TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/23-widget-registry-roles/23-02-SUMMARY.md`
</output>
