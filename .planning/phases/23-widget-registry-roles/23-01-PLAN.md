---
phase: 23-widget-registry-roles
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/types/dashboard.ts
  - src/lib/widgets/registry.ts
autonomous: true

must_haves:
  truths:
    - "Widget registry exists and defines all 7 dashboard widgets"
    - "Each widget has id, title, description, defaultSize, minRole, category, dataKey"
    - "TypeScript types enforce widget definition structure"
  artifacts:
    - path: "src/lib/widgets/registry.ts"
      provides: "Widget definitions for all dashboard widgets"
      exports: ["WIDGET_REGISTRY", "WIDGET_IDS", "WidgetDefinition"]
    - path: "src/types/dashboard.ts"
      provides: "Extended types including WidgetDefinition"
      contains: "interface WidgetDefinition"
  key_links:
    - from: "src/lib/widgets/registry.ts"
      to: "src/types/dashboard.ts"
      via: "imports WidgetDefinition type"
      pattern: "import.*WidgetDefinition.*from.*types/dashboard"
---

<objective>
Create the widget registry foundation that defines all dashboard widgets with their metadata and role requirements.

Purpose: Establish a centralized source of truth for widget definitions that can be used by permission checking, admin management, and dashboard rendering.

Output: TypeScript widget registry with all 7 existing widgets defined, extended dashboard types with WidgetDefinition interface.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/23-widget-registry-roles/23-RESEARCH.md

# Existing files to modify/reference
@src/types/dashboard.ts
@src/app/(dashboard)/page.tsx
@prisma/schema.prisma
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend Dashboard Types</name>
  <files>src/types/dashboard.ts</files>
  <action>
Add the WidgetDefinition interface to the existing dashboard types file. The interface should define:
- id: string (widget identifier)
- title: string (display name)
- description: string (what the widget shows)
- defaultSize: { w: number; h: number } (grid dimensions)
- minRole: UserRole (minimum role required to view - import from @prisma/client)
- category: 'kri' | 'crm' | 'financials' (widget grouping)
- dataKey?: string (optional key for data fetching)

Also add AdminDashboardSettings interface with dashboardLayout and widgetRoles fields.

Import UserRole from @prisma/client at the top of the file.

Do NOT modify existing interfaces (WidgetConfig, DashboardLayout, DateFilter, WidgetRoleRestrictions) - only add new ones.
  </action>
  <verify>
TypeScript compiles without errors: `cd /Users/khairul/Documents/MyDev/Work/Motionvii/saap2026v2 && npx tsc --noEmit`
  </verify>
  <done>
WidgetDefinition and AdminDashboardSettings interfaces exist in src/types/dashboard.ts with proper UserRole import.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Widget Registry</name>
  <files>src/lib/widgets/registry.ts</files>
  <action>
Create src/lib/widgets/registry.ts with:

1. Import WidgetDefinition from @/types/dashboard
2. Import UserRole from @prisma/client

3. Define WIDGET_REGISTRY as Record<string, WidgetDefinition> containing all 7 widgets:
   - 'kpi-cards': KPI Overview, stats, size 12x2, VIEWER, category 'kri'
   - 'status-chart': Status Distribution, byStatus, size 6x3, VIEWER, category 'kri'
   - 'department-chart': By Department, byDepartment, size 6x3, VIEWER, category 'kri'
   - 'team-workload': Team Workload, byPerson, size 6x3, VIEWER, category 'kri'
   - 'recent-initiatives': Recent Activity, recentInitiatives, size 6x3, VIEWER, category 'kri'
   - 'crm-kpi-cards': Sales KPIs, crmStats, size 12x2, EDITOR (revenue sensitive), category 'crm'
   - 'pipeline-stage-chart': Pipeline Stages, stageData, size 12x3, EDITOR (pipeline values sensitive), category 'crm'

4. Export WIDGET_IDS as array of widget ID strings derived from WIDGET_REGISTRY keys

5. Re-export WidgetDefinition type for convenience

Use UserRole.VIEWER and UserRole.EDITOR (not string literals) for minRole values.

Create the widgets directory first: src/lib/widgets/
  </action>
  <verify>
TypeScript compiles without errors: `cd /Users/khairul/Documents/MyDev/Work/Motionvii/saap2026v2 && npx tsc --noEmit`

Registry exports are correct:
`cd /Users/khairul/Documents/MyDev/Work/Motionvii/saap2026v2 && node -e "const r = require('./src/lib/widgets/registry'); console.log('Widgets:', Object.keys(r.WIDGET_REGISTRY).length); console.log('IDs:', r.WIDGET_IDS.length)"`
  </verify>
  <done>
src/lib/widgets/registry.ts exists with WIDGET_REGISTRY containing 7 widgets, WIDGET_IDS array, and proper TypeScript typing.
  </done>
</task>

</tasks>

<verification>
1. TypeScript compiles: `npx tsc --noEmit`
2. Widget count: WIDGET_REGISTRY has exactly 7 entries
3. Types match: Each widget in registry matches WidgetDefinition interface
4. Role values: minRole uses UserRole enum values (not strings)
</verification>

<success_criteria>
- src/types/dashboard.ts has WidgetDefinition and AdminDashboardSettings interfaces
- src/lib/widgets/registry.ts exports WIDGET_REGISTRY with 7 widgets
- All widgets have proper metadata (id, title, description, defaultSize, minRole, category)
- CRM widgets (crm-kpi-cards, pipeline-stage-chart) require EDITOR role
- KRI widgets require VIEWER role
- No TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/23-widget-registry-roles/23-01-SUMMARY.md`
</output>
