---
phase: 55-cross-project-task-view
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/app/(dashboard)/tasks/page.tsx
  - src/components/tasks/tasks-page-client.tsx
  - src/components/tasks/task-table-view.tsx
  - src/components/tasks/task-filter-bar.tsx
autonomous: true

must_haves:
  truths:
    - "User navigates to /tasks and sees all root tasks from all projects in a table"
    - "User sees columns for Title, Project, Status, Priority, Assignee, Due Date"
    - "User clicks column headers to sort ascending/descending"
    - "User filters by any combination of assignee, project, status, priority, due date range, and text search"
    - "User clicks a task row and sees a detail sheet with full task info"
    - "User sees a Table/Kanban view switcher; selected preference persists in localStorage"
  artifacts:
    - path: "src/app/(dashboard)/tasks/page.tsx"
      provides: "Server component fetching all root tasks with project context"
      contains: "parentId: null"
    - path: "src/components/tasks/tasks-page-client.tsx"
      provides: "Client shell with filter state, view switching, detail sheet"
      exports: ["TasksPageClient"]
    - path: "src/components/tasks/task-table-view.tsx"
      provides: "Table view with sortable column headers"
      exports: ["TaskTableView"]
    - path: "src/components/tasks/task-filter-bar.tsx"
      provides: "Filter bar with search, assignee pills, project/status/priority/due-date dropdowns"
      exports: ["TaskFilterBar"]
  key_links:
    - from: "src/app/(dashboard)/tasks/page.tsx"
      to: "prisma.task.findMany"
      via: "server-side data fetch"
      pattern: "parentId: null.*include.*project"
    - from: "src/components/tasks/tasks-page-client.tsx"
      to: "src/components/tasks/task-table-view.tsx"
      via: "renders table with filteredTasks"
      pattern: "TaskTableView"
    - from: "src/components/tasks/tasks-page-client.tsx"
      to: "src/components/projects/task-detail-sheet.tsx"
      via: "passes task.projectId as projectId prop"
      pattern: "TaskDetailSheet.*projectId"
    - from: "src/components/tasks/tasks-page-client.tsx"
      to: "localStorage"
      via: "view preference persistence"
      pattern: "tasks-view-preference"
---

<objective>
Create the /tasks page with server-side data fetching, client-side filtering/sorting, table view with sortable columns, filter bar, detail sheet integration, and view preference persistence.

Purpose: This is the foundation of the cross-project task view. Users need to see, filter, sort, and inspect tasks from all projects in one place. The table view is the default view.
Output: Working /tasks page with table view, 6-filter filter bar, sortable columns, row click -> detail sheet, and Table/Kanban view switcher (kanban view stubbed for Plan 02).
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/55-cross-project-task-view/55-RESEARCH.md

Key source files to reference for patterns:
@src/app/(dashboard)/kanban/page.tsx (server component pattern)
@src/components/kanban/kanban-board.tsx (client component with filters, view toggle)
@src/components/kanban/kanban-filter-bar.tsx (filter bar UI pattern - Apple glass style)
@src/components/initiatives/initiatives-list.tsx (table view with shadcn Table)
@src/components/projects/task-detail-sheet.tsx (existing TaskDetailSheet - reuse directly)
@src/lib/task-utils.ts (formatTaskStatus, getTaskStatusColor, formatTaskPriority, getTaskPriorityColor, TASK_STATUS_OPTIONS, TASK_PRIORITY_OPTIONS)
@src/lib/utils.ts (cn, formatTeamMember, formatDate, TEAM_MEMBER_OPTIONS)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Server page, client shell, and filter bar</name>
  <files>
    src/app/(dashboard)/tasks/page.tsx
    src/components/tasks/tasks-page-client.tsx
    src/components/tasks/task-filter-bar.tsx
  </files>
  <action>
**1. Create `src/app/(dashboard)/tasks/page.tsx`** (server component):
- Add `export const dynamic = 'force-dynamic'`
- Import prisma, Header, TasksPageClient
- Create `getAllTasks()` function:
  - `prisma.task.findMany({ where: { parentId: null }, include: { project: { select: { id: true, title: true } }, _count: { select: { children: true, comments: true } } }, orderBy: { createdAt: 'desc' } })`
  - Map results to serialize dates: `dueDate?.toISOString() || null`, `createdAt.toISOString()`, `updatedAt.toISOString()`
  - Also include `projectId`, `assignee`, `status`, `priority`, `title`, `description`, `id`, `project`, `_count`
- Create `getProjects()` function:
  - `prisma.project.findMany({ where: { tasks: { some: {} } }, select: { id: true, title: true }, orderBy: { title: 'asc' } })`
- Default export renders:
  ```
  <div className="min-h-screen bg-gray-50">
    <Header title="Tasks" description="All tasks across projects" />
    <div className="p-6">
      <TasksPageClient initialTasks={tasks} projects={projects} />
    </div>
  </div>
  ```

**2. Create `src/components/tasks/tasks-page-client.tsx`** (client component):
- `'use client'` at top
- Define `CrossProjectTask` interface matching serialized task shape (id, title, description, status, priority, dueDate, assignee, projectId, project: {id, title}, _count: {children, comments}, createdAt, updatedAt)
- Define `ProjectOption` as `{ id: string; title: string }`
- Props: `{ initialTasks: CrossProjectTask[], projects: ProjectOption[] }`
- State:
  - `tasks` (initialized from initialTasks, updated after detail sheet saves)
  - `searchQuery: string` (default '')
  - `assigneeFilter: string | null` (default null)
  - `projectFilter: string | null` (default null)
  - `statusFilter: string | null` (default null)
  - `priorityFilter: string | null` (default null)
  - `dueDateFilter: DueDateFilter` (default 'all') -- type: `'all' | 'overdue' | 'today' | 'this-week' | 'this-month' | 'no-date'`
  - `viewMode: 'table' | 'kanban'` (default 'table')
  - `selectedTask: CrossProjectTask | null`
  - `isSheetOpen: boolean`
- View preference persistence (SSR-safe): Load from `localStorage.getItem('tasks-view-preference')` in useEffect on mount. Save on change via `localStorage.setItem`.
- `filteredTasks` via useMemo: chain all 6 filters (search on title, assignee exact match, project.id exact match, status exact match, priority exact match, dueDateFilter using `matchesDueDateFilter` helper)
- `matchesDueDateFilter(task, filter)` helper inline: handles 'all' (return true), 'no-date' (dueDate === null), 'overdue' (dueDate < today AND status !== 'DONE'), 'today' (same dateString), 'this-week' (dueDate >= today AND dueDate <= endOfWeek), 'this-month' (dueDate >= today AND dueDate <= endOfMonth)
- `handleTaskClick(task)`: set selectedTask and isSheetOpen
- `handleTaskUpdate()`: refetch all tasks via `fetch('/api/tasks')` -- WAIT, there's no /api/tasks route. Instead, use `window.location.reload()` OR re-fetch server data. Actually, follow the initiatives-list pattern: call `fetch` to get fresh data. But we don't have a GET /api/tasks. SIMPLEST approach: use `router.refresh()` from `next/navigation` to re-run the server component. Import `useRouter` from 'next/navigation', call `router.refresh()` in handleTaskUpdate callback. This refreshes server data without full page reload.
- Render layout:
  - Filter bar + View toggle in a flex row (same layout as kanban-board.tsx lines 460-496)
  - Filter bar on left, Tabs (Table/Kanban) on right
  - View toggle uses `@radix-ui/react-tabs`: `<Tabs value={viewMode} onValueChange={handleViewChange}>` with `<TabsTrigger value="table">` (TableIcon + "Table") and `<TabsTrigger value="kanban">` (KanbanSquare + "Kanban"). Style: `bg-white/70 backdrop-blur-xl border border-gray-200/50`
  - Conditionally render `{viewMode === 'table' && <TaskTableView ... />}` and `{viewMode === 'kanban' && <div>Kanban view coming soon</div>}` (placeholder for Plan 02)
  - TaskDetailSheet at bottom: `<TaskDetailSheet task={selectedTask} projectId={selectedTask?.projectId || ''} open={isSheetOpen} onOpenChange={setIsSheetOpen} onTaskUpdate={handleTaskUpdate} />`
  - Summary line below views: `Showing {filteredTasks.length} of {tasks.length} tasks`
- Icons to import from lucide-react: `TableIcon` (use `import { Table2 as TableIcon } from 'lucide-react'`), `KanbanSquare`

**3. Create `src/components/tasks/task-filter-bar.tsx`**:
- Model after `src/components/kanban/kanban-filter-bar.tsx` (Apple glass style)
- Props interface:
  ```typescript
  interface TaskFilterBarProps {
    searchQuery: string
    onSearchChange: (query: string) => void
    selectedAssignee: string | null
    onAssigneeChange: (assignee: string | null) => void
    selectedProject: string | null
    onProjectChange: (projectId: string | null) => void
    projects: { id: string; title: string }[]
    selectedStatus: string | null
    onStatusChange: (status: string | null) => void
    selectedPriority: string | null
    onPriorityChange: (priority: string | null) => void
    selectedDueDate: DueDateFilter
    onDueDateChange: (filter: DueDateFilter) => void
  }
  ```
- Layout: glass bar `bg-white/70 backdrop-blur-xl border border-gray-200/50 rounded-2xl shadow-sm`
- Elements left to right:
  1. Search input with Search icon (same as kanban-filter-bar)
  2. Separator (hidden on mobile)
  3. Assignee person pills (All, KH, AZ, IZ) -- same segmented control as kanban-filter-bar
  4. Separator
  5. Project dropdown Select: "All Projects" + project options
  6. Status dropdown Select: "All Status" + TASK_STATUS_OPTIONS from task-utils
  7. Priority dropdown Select: "All Priority" + TASK_PRIORITY_OPTIONS from task-utils
  8. Due Date dropdown Select with Calendar icon: "All Dates", "Overdue", "Due Today", "This Week", "This Month", "No Date"
  9. Clear filters X button (shown when any filter active)
- On mobile: `overflow-x-auto` for horizontal scroll (same as kanban-filter-bar)
- Use TEAM_MEMBERS array inline (same as kanban-filter-bar: KHAIRUL/KH, AZLAN/AZ, IZYANI/IZ with color dots)
- Export `DueDateFilter` type

**Important anti-patterns to avoid:**
- Do NOT create a new /api/tasks GET route. Use server component data fetching (Prisma directly).
- Do NOT use TanStack Table. Use useMemo for filtering/sorting with shadcn Table components.
- Do NOT include subtasks (parentId !== null) in the cross-project view.
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - Navigate to http://localhost:3000/tasks - page loads without errors
    - Filter bar renders with search, assignee pills, project/status/priority/due-date dropdowns
    - View switcher shows Table/Kanban tabs
  </verify>
  <done>
    - /tasks page loads with all root tasks from all projects
    - All 6 filters work (search, assignee, project, status, priority, due date range)
    - View switcher is visible; table view is default
    - View preference persists in localStorage across navigations
  </done>
</task>

<task type="auto">
  <name>Task 2: Table view with sortable columns and detail sheet</name>
  <files>
    src/components/tasks/task-table-view.tsx
  </files>
  <action>
**Create `src/components/tasks/task-table-view.tsx`**:
- `'use client'`
- Import shadcn Table components (Table, TableBody, TableCell, TableHead, TableHeader, TableRow), Badge, cn
- Import task-utils: getTaskStatusColor, getTaskPriorityColor, formatTaskStatus, formatTaskPriority
- Import utils: formatTeamMember, formatDate
- Import lucide-react: ChevronUp, ChevronDown, MessageSquare, ListTree (for subtask count)

**Types:**
```typescript
type SortField = 'title' | 'project' | 'status' | 'priority' | 'assignee' | 'dueDate'
type SortDirection = 'asc' | 'desc'
```

**Props:** `{ tasks: CrossProjectTask[], onTaskClick: (task: CrossProjectTask) => void }`

Import the `CrossProjectTask` type from tasks-page-client (export it from there).

**Sort state:**
- `sortField` default 'dueDate'
- `sortDirection` default 'asc'
- `toggleSort(field)`: if same field, flip direction; otherwise set field + 'asc'

**Sorted tasks via useMemo:**
- Sort `tasks` array by sortField/sortDirection
- Comparison logic per field:
  - `title`: `localeCompare`
  - `project`: `a.project.title.localeCompare(b.project.title)`
  - `status`: use status order map `{ TODO: 0, IN_PROGRESS: 1, DONE: 2 }`
  - `priority`: use priority order map `{ HIGH: 0, MEDIUM: 1, LOW: 2 }`
  - `assignee`: null-safe `localeCompare` (nulls sort last for asc, first for desc)
  - `dueDate`: null-safe Date comparison (nulls sort last for asc, first for desc)

**SortableHeader inline component:**
```tsx
function SortableHeader({ label, field }: { label: string; field: SortField }) {
  const isActive = sortField === field
  return (
    <TableHead
      className="cursor-pointer select-none hover:bg-gray-50 transition-colors"
      onClick={() => toggleSort(field)}
    >
      <div className="flex items-center gap-1">
        {label}
        {isActive && (
          sortDirection === 'asc'
            ? <ChevronUp className="h-3.5 w-3.5 text-gray-600" />
            : <ChevronDown className="h-3.5 w-3.5 text-gray-600" />
        )}
      </div>
    </TableHead>
  )
}
```

**Table layout** (model after initiatives-list.tsx):
- Wrap in Card with `border border-gray-200`
- Table columns: Title (main), Project, Status, Priority, Assignee, Due Date
- On mobile (< md): hide Project, Status, Priority, Assignee, Due Date columns using `hidden md:table-cell`
- On mobile: show project badge and status badge inline below title (same pattern as initiatives-list line 246-250)

**Table row for each task:**
- Row: `className="group cursor-pointer hover:bg-gray-50"` with `onClick={() => onTaskClick(task)}`
- Title cell:
  - `<p className="font-medium text-gray-900">{task.title}</p>`
  - Mobile-only: show project badge + status badge below title
  - If task has subtasks (`_count.children > 0`), show small indicator: `<span className="text-xs text-gray-400"><ListTree className="inline h-3 w-3" /> {task._count.children}</span>`
  - If task has comments (`_count.comments > 0`), show: `<span className="text-xs text-gray-400"><MessageSquare className="inline h-3 w-3" /> {task._count.comments}</span>`
- Project cell: `<Badge variant="secondary" className="text-xs bg-blue-50 text-blue-700">{task.project.title}</Badge>` (TASK-11)
- Status cell: `<Badge variant="secondary" className={getTaskStatusColor(task.status)}>{formatTaskStatus(task.status)}</Badge>`
- Priority cell: `<Badge variant="outline" className={getTaskPriorityColor(task.priority)}>{formatTaskPriority(task.priority)}</Badge>`
- Assignee cell: `formatTeamMember(task.assignee)`
- Due Date cell: `formatDate(task.dueDate)` with overdue highlighting: if dueDate is before today AND status !== 'DONE', add `text-red-500 font-medium`

**Empty state:** "No tasks found" centered (same as initiatives-list)

**Summary line:** Not needed here -- rendered by parent component.

**Important:** Export the CrossProjectTask type from tasks-page-client.tsx so this file can import it. Alternatively, define a shared type. The cleanest approach: define the type in tasks-page-client.tsx and export it, then import in task-table-view.tsx.
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - Navigate to /tasks - table displays with all columns
    - Click "Title" column header - tasks sort alphabetically
    - Click "Due Date" column header - tasks sort by date (nulls at end)
    - Click a task row - detail sheet opens with correct task data
    - On mobile viewport - only Title column visible with inline badges
  </verify>
  <done>
    - Table view shows Title, Project, Status, Priority, Assignee, Due Date columns (TASK-02)
    - All 6 columns are sortable via header click (TASK-10)
    - Project badge shows on each row (TASK-11)
    - Clicking a row opens TaskDetailSheet with full task info (TASK-12)
    - Overdue dates highlighted in red
    - Responsive: mobile shows title with inline badges, desktop shows full table
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` -- no TypeScript errors
2. Navigate to /tasks -- page loads, shows all root tasks in table view
3. Click column headers -- sorting works for all 6 columns
4. Use each filter -- search, assignee pills, project dropdown, status dropdown, priority dropdown, due date dropdown all filter correctly
5. Combine filters -- multiple filters work together
6. Click a task row -- TaskDetailSheet opens with correct project context
7. Save changes in detail sheet -- task list refreshes
8. Switch to Kanban tab -- placeholder renders (ready for Plan 02)
9. Refresh page -- view preference (table/kanban) persists from localStorage
10. Mobile viewport -- filter bar scrolls horizontally, table collapses to title + inline badges
</verification>

<success_criteria>
- TASK-01: /tasks page accessible and shows all cross-project tasks
- TASK-02: Table view with Title, Project, Status, Priority, Assignee, Due Date columns
- TASK-04: View switcher visible (kanban view placeholder for Plan 02)
- TASK-05: Assignee filter works (All, Khairul, Azlan, Izyani)
- TASK-06: Project filter works (dropdown of projects with tasks)
- TASK-07: Status filter works (TODO, IN_PROGRESS, DONE)
- TASK-08: Priority filter works (LOW, MEDIUM, HIGH)
- TASK-09: Text search filters by title in real time
- TASK-10: Column headers sortable (ascending/descending toggle)
- TASK-11: Project name shown as badge on each row/card
- TASK-12: Click row opens detail sheet with subtasks and comments
- TASK-14: Due date range filter works (Overdue, Due Today, This Week, This Month, No Date)
- TASK-15: View preference persists in localStorage
</success_criteria>

<output>
After completion, create `.planning/phases/55-cross-project-task-view/55-01-SUMMARY.md`
</output>
