---
phase: 55-cross-project-task-view
plan: 02
type: execute
wave: 2
depends_on: ["55-01"]
files_modified:
  - src/components/tasks/tasks-page-client.tsx
  - src/components/tasks/task-kanban-view.tsx
  - src/components/tasks/task-kanban-column.tsx
  - src/components/tasks/task-kanban-card.tsx
autonomous: true

must_haves:
  truths:
    - "User toggles to Kanban view and sees tasks in three columns: To Do, In Progress, Done"
    - "User drags a task card between columns and the status change persists"
    - "User clicks a kanban card and sees the detail sheet with full task info"
    - "Kanban cards show project name badge, priority, assignee avatar, and due date"
    - "Filters from Plan 01 apply to kanban view (same filteredTasks)"
  artifacts:
    - path: "src/components/tasks/task-kanban-view.tsx"
      provides: "Kanban board with DndContext, 3 columns, drag overlay"
      exports: ["TaskKanbanView"]
    - path: "src/components/tasks/task-kanban-column.tsx"
      provides: "Droppable kanban column with title, count, color dot"
      exports: ["TaskKanbanColumn"]
    - path: "src/components/tasks/task-kanban-card.tsx"
      provides: "Draggable task card with project badge, priority, assignee"
      exports: ["TaskKanbanCard"]
  key_links:
    - from: "src/components/tasks/tasks-page-client.tsx"
      to: "src/components/tasks/task-kanban-view.tsx"
      via: "renders kanban when viewMode === 'kanban'"
      pattern: "TaskKanbanView"
    - from: "src/components/tasks/task-kanban-view.tsx"
      to: "/api/projects/[projectId]/tasks/[taskId]"
      via: "PATCH on drag end to update status"
      pattern: "fetch.*api/projects.*tasks.*PATCH"
    - from: "src/components/tasks/task-kanban-card.tsx"
      to: "useSortable"
      via: "dnd-kit sortable for drag behavior"
      pattern: "useSortable"
---

<objective>
Add the kanban view to the /tasks page with drag-and-drop status changes using dnd-kit, completing the cross-project task view.

Purpose: Users need a visual kanban board to manage task status across projects by dragging cards between To Do, In Progress, and Done columns.
Output: Fully functional kanban view with 3 columns, drag-and-drop, project badges on cards, and optimistic status updates via existing project-scoped API.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/55-cross-project-task-view/55-RESEARCH.md
@.planning/phases/55-cross-project-task-view/55-01-SUMMARY.md

Key source files to reference for dnd-kit patterns:
@src/components/kanban/kanban-board.tsx (DndContext, sensors, collision detection, handleDragStart/Over/End)
@src/components/kanban/kanban-column.tsx (useDroppable pattern)
@src/components/kanban/kanban-card.tsx (useSortable, CSS.Transform, touch handling, drag handle)
@src/components/tasks/tasks-page-client.tsx (from Plan 01 - wire kanban view here)
@src/lib/task-utils.ts (getTaskStatusColor, getTaskPriorityColor, formatTaskPriority)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Kanban column and card components</name>
  <files>
    src/components/tasks/task-kanban-column.tsx
    src/components/tasks/task-kanban-card.tsx
  </files>
  <action>
**1. Create `src/components/tasks/task-kanban-column.tsx`:**
- Model directly after `src/components/kanban/kanban-column.tsx`
- `'use client'`
- Import `useDroppable` from `@dnd-kit/core`, `cn` from `@/lib/utils`
- Props: `{ id: string; title: string; colorDot: string; count: number; children: React.ReactNode }`
- Use `useDroppable({ id })` for drop target
- Layout (same as kanban-column.tsx):
  - Outer div: `w-[75vw] min-w-[280px] max-w-[320px] md:w-80 md:min-w-0 md:max-w-none shrink-0 rounded-2xl bg-gray-50/50 backdrop-blur-sm snap-start`
  - Add `isOver && 'ring-2 ring-blue-400/50'` highlight
  - Header: color dot + title + count badge
  - Cards container: `p-3 pt-0 space-y-3 min-h-[200px]`

**2. Create `src/components/tasks/task-kanban-card.tsx`:**
- Model after `src/components/kanban/kanban-card.tsx` but SIMPLER (no initiative-specific features like department borders, reassign, status change menu)
- `'use client'`
- Import `useSortable` from `@dnd-kit/sortable`, `CSS` from `@dnd-kit/utilities`
- Import Badge, Avatar, AvatarFallback from shadcn
- Import `cn` from `@/lib/utils`
- Import `getTaskPriorityColor`, `formatTaskPriority` from `@/lib/task-utils`
- Import `GripVertical` from lucide-react
- Import the `CrossProjectTask` type from `tasks-page-client`

- Define inline constants:
  ```typescript
  const TEAM_INITIALS: Record<string, string> = { KHAIRUL: 'KH', AZLAN: 'AZ', IZYANI: 'IZ' }
  const TEAM_COLORS: Record<string, string> = { KHAIRUL: 'bg-blue-600', AZLAN: 'bg-green-600', IZYANI: 'bg-purple-600' }
  ```

- Props: `{ task: CrossProjectTask; isDragging?: boolean; onClick?: () => void }`
- Use `useSortable({ id: task.id })`
- Touch handling: same pattern as kanban-card.tsx (touchStartRef, handleTouchStart, handleTouchEnd for tap detection on mobile)
- handleClick: same as kanban-card.tsx (check not clicking button, then call onClick)

- Card layout:
  ```
  <div ref={setNodeRef} style={style} {...attributes}
    className="group relative bg-white rounded-2xl border-0 shadow-apple
    hover:shadow-apple-hover hover:scale-[1.02] transition-all duration-200 ease-out select-none
    {isDragging && 'opacity-60 shadow-xl scale-105 rotate-1'}">

    <div className="p-4 pl-10 md:pl-4 cursor-pointer" onClick={handleClick} onTouchStart/End>
      {/* Title */}
      <div className="text-sm font-medium text-gray-900 line-clamp-2 mb-2">
        {task.title}
      </div>

      {/* Project badge + Due date */}
      <div className="flex items-center gap-2 text-xs text-gray-500 mb-2">
        <Badge variant="secondary" className="text-[10px] px-1.5 py-0 h-5 bg-blue-50 text-blue-700">
          {task.project.title}
        </Badge>
        {task.dueDate && (
          <>
            <span className="text-gray-300">.</span>
            <span className={cn(isOverdue && 'text-red-500 font-medium')}>
              {format(new Date(task.dueDate), 'MMM d')}
            </span>
          </>
        )}
      </div>

      {/* Priority + Assignee */}
      <div className="flex items-center justify-between">
        <Badge variant="outline" className={cn('text-xs', getTaskPriorityColor(task.priority))}>
          {formatTaskPriority(task.priority)}
        </Badge>
        {task.assignee && (
          <Avatar className="h-6 w-6">
            <AvatarFallback className={cn('text-[10px] text-white font-medium', TEAM_COLORS[task.assignee] || 'bg-gray-400')}>
              {TEAM_INITIALS[task.assignee] || '??'}
            </AvatarFallback>
          </Avatar>
        )}
      </div>

      {/* Subtask/comment counts if present */}
      {(task._count.children > 0 || task._count.comments > 0) && (
        <div className="flex items-center gap-3 mt-2 text-xs text-gray-400">
          {task._count.children > 0 && <span>subtasks: {task._count.children}</span>}
          {task._count.comments > 0 && <span>comments: {task._count.comments}</span>}
        </div>
      )}
    </div>

    {/* Drag Handle - visible on mobile, hover on desktop */}
    <div {...listeners} className="absolute left-0 top-0 bottom-0 w-8 flex items-center justify-center
      cursor-grab active:cursor-grabbing touch-none rounded-l-2xl
      bg-gray-50/80 hover:bg-gray-100/80
      md:opacity-0 md:group-hover:opacity-100 transition-opacity">
      <GripVertical className="h-4 w-4 text-gray-400" />
    </div>
  </div>
  ```

- Compute `isOverdue`: `task.dueDate && new Date(task.dueDate) < new Date() && task.status !== 'DONE'`
- Import `format` from `date-fns` for date display
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - Components export correctly (no runtime errors when imported)
  </verify>
  <done>
    - TaskKanbanColumn renders as a droppable zone with header (color dot, title, count)
    - TaskKanbanCard renders task with project badge, priority badge, assignee avatar, due date, drag handle
    - Card supports tap-to-open on mobile and click-to-open on desktop
    - Overdue dates shown in red
  </done>
</task>

<task type="auto">
  <name>Task 2: Kanban view with dnd-kit and wire into page client</name>
  <files>
    src/components/tasks/task-kanban-view.tsx
    src/components/tasks/tasks-page-client.tsx
  </files>
  <action>
**1. Create `src/components/tasks/task-kanban-view.tsx`:**
- `'use client'`
- Model the DndContext setup directly after `src/components/kanban/kanban-board.tsx`

**Imports:**
- From `@dnd-kit/core`: DndContext, DragOverlay, pointerWithin, rectIntersection, KeyboardSensor, MouseSensor, TouchSensor, useSensor, useSensors, DragStartEvent, DragEndEvent, DragOverEvent, CollisionDetection
- From `@dnd-kit/sortable`: SortableContext, sortableKeyboardCoordinates, verticalListSortingStrategy
- TaskKanbanColumn, TaskKanbanCard, CrossProjectTask type

**Constants:**
```typescript
const TASK_COLUMNS = [
  { id: 'TODO', title: 'To Do', colorDot: 'bg-gray-400' },
  { id: 'IN_PROGRESS', title: 'In Progress', colorDot: 'bg-blue-500' },
  { id: 'DONE', title: 'Done', colorDot: 'bg-green-500' },
]
const COLUMN_IDS = TASK_COLUMNS.map(c => c.id)
```

**Props:**
```typescript
interface TaskKanbanViewProps {
  tasks: CrossProjectTask[]
  onTaskClick: (task: CrossProjectTask) => void
  onTasksChange: (tasks: CrossProjectTask[]) => void
}
```
NOTE: `onTasksChange` lets the parent update its tasks state after optimistic drag updates (so filtered views stay correct). The parent passes its `setTasks` or a wrapper.

**Sensors (same as kanban-board.tsx):**
- MouseSensor with distance: 5
- TouchSensor with delay: 250, tolerance: 5
- KeyboardSensor with sortableKeyboardCoordinates

**Collision detection (same as kanban-board.tsx):**
- Custom: prioritize column collisions (pointerWithin for columns, rectIntersection fallback for items)

**State:**
- `activeId: string | null`
- `isDragging: boolean`

**Helper functions:**
- `getColumnTasks(columnId)`: filter tasks where `task.status === columnId`
- `getActiveTask()`: find task by activeId

**Drag handlers:**
- `handleDragStart`: set activeId and isDragging
- `handleDragOver`: determine target column from over.id (if column) or over item's status. If task moved to different column, call `onTasksChange` with optimistic status update
- `handleDragEnd`: Finalize the drop. Determine final column. Call `onTasksChange` to update status. Then persist via PATCH to the EXISTING project-scoped API:
  ```typescript
  const task = tasks.find(t => t.id === activeId)
  if (task && task.status !== finalStatus) {
    try {
      await fetch(`/api/projects/${task.projectId}/tasks/${task.id}`, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ status: finalStatus }),
      })
    } catch (error) {
      console.error('Failed to update task status:', error)
    }
  }
  ```
  NOTE: Use `task.projectId` to construct the correct URL. This is the key pitfall from research.

**Render:**
```tsx
<DndContext
  sensors={sensors}
  collisionDetection={collisionDetection}
  onDragStart={handleDragStart}
  onDragOver={handleDragOver}
  onDragEnd={handleDragEnd}
  autoScroll={{ threshold: { x: 0.1, y: 0.1 }, acceleration: 5, interval: 10 }}
>
  <div className={cn(
    "flex gap-4 pb-4 pl-1",
    "overflow-x-auto scroll-pl-1",
    !isDragging && "snap-x snap-mandatory",
    "[&::-webkit-scrollbar]:hidden [-webkit-overflow-scrolling:touch]",
    "md:min-w-max md:snap-none md:pl-0 md:scroll-pl-0"
  )}>
    {TASK_COLUMNS.map(column => {
      const columnTasks = getColumnTasks(column.id)
      return (
        <TaskKanbanColumn
          key={column.id}
          id={column.id}
          title={column.title}
          colorDot={column.colorDot}
          count={columnTasks.length}
        >
          <SortableContext
            items={columnTasks.map(t => t.id)}
            strategy={verticalListSortingStrategy}
          >
            {columnTasks.map(task => (
              <TaskKanbanCard
                key={task.id}
                task={task}
                onClick={() => onTaskClick(task)}
              />
            ))}
          </SortableContext>
        </TaskKanbanColumn>
      )
    })}
  </div>

  <DragOverlay>
    {activeId ? (
      <TaskKanbanCard
        task={getActiveTask()!}
        isDragging
      />
    ) : null}
  </DragOverlay>
</DndContext>
```

**2. Update `src/components/tasks/tasks-page-client.tsx`:**
- Import `TaskKanbanView` from `./task-kanban-view`
- Replace the kanban placeholder `<div>Kanban view coming soon</div>` with:
  ```tsx
  {viewMode === 'kanban' && (
    <TaskKanbanView
      tasks={filteredTasks}
      onTaskClick={handleTaskClick}
      onTasksChange={(updatedTasks) => {
        // Merge updated tasks back into full tasks array
        setTasks(prev => prev.map(t => {
          const updated = updatedTasks.find(u => u.id === t.id)
          return updated || t
        }))
      }}
    />
  )}
  ```
  IMPORTANT: The kanban receives `filteredTasks` (already filtered by parent's useMemo). When drag changes status, `onTasksChange` updates the parent's full `tasks` state, which triggers re-filter via useMemo.

- Also ensure the `tasks` state is mutable (useState, not just props). It should already be from Plan 01: `const [tasks, setTasks] = useState(initialTasks)`

**Anti-patterns to avoid:**
- Do NOT create a `/api/tasks/[taskId]` route. Use existing `PATCH /api/projects/${task.projectId}/tasks/${task.id}`
- Do NOT add position/reorder tracking. Cross-project kanban only changes status, not card ordering within columns.
- Within columns, tasks appear in the same relative order as the filtered list (no custom sort within columns).
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - Navigate to /tasks, switch to Kanban view
    - Three columns visible: To Do, In Progress, Done
    - Tasks appear in correct columns based on their status
    - Drag a task card from "To Do" to "In Progress" -- card moves, no console errors
    - Refresh page -- task stays in new column (persisted via API)
    - Click a kanban card -- detail sheet opens
    - Apply a filter (e.g., assignee) -- kanban only shows matching tasks
    - On mobile -- horizontal scroll, drag handle visible, tap to open card
  </verify>
  <done>
    - TASK-03: Kanban view displays tasks in three columns (To Do, In Progress, Done)
    - TASK-04: View switcher toggles between Table and Kanban
    - TASK-13: Drag task cards between columns to change status, change persists
    - Kanban cards show project badge (TASK-11), priority, assignee, due date
    - All filters from Plan 01 apply to kanban view
    - Mobile responsive: horizontal scroll, snap, drag handle, tap-to-open
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` -- no TypeScript errors
2. Navigate to /tasks -- default table view loads
3. Click "Kanban" tab -- kanban view renders with 3 columns
4. Tasks appear in correct columns (TODO -> To Do, IN_PROGRESS -> In Progress, DONE -> Done)
5. Drag a card from To Do to In Progress -- card moves immediately (optimistic)
6. Check Network tab -- PATCH request sent to /api/projects/{projectId}/tasks/{taskId}
7. Refresh page -- task remains in new column (persisted)
8. Click a kanban card -- TaskDetailSheet opens with correct task data
9. Apply assignee filter -- kanban shows only that person's tasks
10. Apply multiple filters -- kanban respects all active filters
11. Switch back to Table view -- table reflects the status change
12. Mobile viewport -- columns scroll horizontally with snap, drag handle visible, tap opens card
13. View preference persists across page navigation (localStorage)
</verification>

<success_criteria>
- TASK-03: Kanban view with To Do, In Progress, Done columns
- TASK-04: View switcher toggles between Table and Kanban (both fully functional)
- TASK-13: Drag-and-drop status changes persist via existing project-scoped API
- TASK-11: Project name badge visible on kanban cards
- All filters (TASK-05 through TASK-09, TASK-14) work in kanban view
- Mobile-responsive kanban with horizontal scroll and touch support
</success_criteria>

<output>
After completion, create `.planning/phases/55-cross-project-task-view/55-02-SUMMARY.md`
</output>
