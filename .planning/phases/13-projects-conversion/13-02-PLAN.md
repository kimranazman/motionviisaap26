---
phase: 13-projects-conversion
plan: 02
type: execute
wave: 2
depends_on: ["13-01"]
files_modified:
  - src/app/api/deals/reorder/route.ts
  - src/app/api/potential-projects/reorder/route.ts
  - src/components/pipeline/pipeline-board.tsx
  - src/components/potential-projects/potential-board.tsx
autonomous: true

must_haves:
  truths:
    - "Moving deal to Won auto-creates linked Project"
    - "Moving potential to Confirmed auto-creates linked Project"
    - "Project inherits title, value/revenue, company, contact from source"
    - "Source deal/potential gets projectId link set"
    - "Re-dragging to Won/Confirmed does not create duplicate project"
    - "Project detail shows source (deal, potential, or direct)"
  artifacts:
    - path: "src/app/api/deals/reorder/route.ts"
      provides: "Enhanced reorder with auto-project creation on WON"
      contains: "ProjectStatus"
    - path: "src/app/api/potential-projects/reorder/route.ts"
      provides: "Enhanced reorder with auto-project creation on CONFIRMED"
      contains: "ProjectStatus"
  key_links:
    - from: "src/app/api/deals/reorder/route.ts"
      to: "prisma.project.create"
      via: "transaction when stage=WON"
      pattern: "tx\\.project\\.create"
    - from: "src/app/api/potential-projects/reorder/route.ts"
      to: "prisma.project.create"
      via: "transaction when stage=CONFIRMED"
      pattern: "tx\\.project\\.create"
    - from: "pipeline-board.tsx"
      to: "reorder endpoint"
      via: "fetch PATCH with updates"
      pattern: "fetch.*api/deals/reorder"
---

<objective>
Implement auto-conversion from deals and potentials to projects when they reach terminal stages.

Purpose: When a deal is won or a potential is confirmed, automatically create a linked Project to track the actual work, ensuring data integrity and traceability.
Output: Modified reorder endpoints that create projects atomically, with UI feedback on successful conversion.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-projects-conversion/13-RESEARCH.md
@.planning/phases/13-projects-conversion/13-01-SUMMARY.md
@src/app/api/deals/reorder/route.ts
@src/app/api/potential-projects/reorder/route.ts
@src/components/pipeline/pipeline-board.tsx
@src/components/potential-projects/potential-board.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Deal to Project conversion on WON</name>
  <files>
    src/app/api/deals/reorder/route.ts
    src/components/pipeline/pipeline-board.tsx
  </files>
  <action>
Enhance the deals reorder endpoint to auto-create a Project when a deal moves to WON stage:

1. **src/app/api/deals/reorder/route.ts** - Modify to handle conversion:
- Import `ProjectStatus` from '@prisma/client'
- Expand currentDeals query to include: title, value, companyId, contactId, projectId
- Change from `prisma.$transaction(updates.map(...))` to `prisma.$transaction(async (tx) => {...})` for sequential operations
- For each update, check:
  - Is stage changing to WON?
  - Does the deal NOT already have a projectId? (prevent duplicates)
- If both true, within the transaction:
  ```typescript
  const project = await tx.project.create({
    data: {
      title: currentDeal.title,
      description: null,
      revenue: currentDeal.value,
      status: ProjectStatus.DRAFT,
      companyId: currentDeal.companyId,
      contactId: currentDeal.contactId,
    },
  })
  await tx.deal.update({
    where: { id: update.id },
    data: {
      position: update.position,
      stage: 'WON',
      stageChangedAt: new Date(),
      projectId: project.id,
    },
  })
  ```
- If deal already has projectId (re-drag scenario), just update position/stage without creating new project
- Return `{ success: true, projectCreated?: { id, title } }` to indicate conversion happened

2. **src/components/pipeline/pipeline-board.tsx** - Add conversion feedback:
- After successful reorder response for WON stage move, check if `projectCreated` in response
- If projectCreated, show toast notification: "Project created: [title]" (use sonner if available, or console.log placeholder)
- No blocking dialog needed - just informational toast

Note: Do NOT prevent moving deals out of WON stage. If deal moves from WON to another stage, the projectId link remains (project was already created).
  </action>
  <verify>
1. Drag a deal (without existing project) to WON stage
2. Check database: project table should have new entry with matching title/revenue/company
3. Check database: deal should have projectId set to the new project
4. Navigate to /projects - new project appears with source showing the deal
5. Drag the same deal to WON again (or out and back) - no duplicate project created
  </verify>
  <done>
Moving deal to WON auto-creates linked Project with deal data. Re-dragging does not duplicate. UI shows toast on conversion.
  </done>
</task>

<task type="auto">
  <name>Task 2: Potential to Project conversion on CONFIRMED</name>
  <files>
    src/app/api/potential-projects/reorder/route.ts
    src/components/potential-projects/potential-board.tsx
  </files>
  <action>
Apply the same conversion pattern to potential projects:

1. **src/app/api/potential-projects/reorder/route.ts** - Modify for conversion:
- Import `ProjectStatus` from '@prisma/client'
- Expand currentProjects query to include: title, description, estimatedValue, companyId, contactId, projectId
- Change to interactive transaction pattern (same as deals)
- For each update, check:
  - Is stage changing to CONFIRMED?
  - Does the potential NOT already have a projectId?
- If both true, within the transaction:
  ```typescript
  const project = await tx.project.create({
    data: {
      title: currentProject.title,
      description: currentProject.description,
      revenue: currentProject.estimatedValue,
      status: ProjectStatus.DRAFT,
      companyId: currentProject.companyId,
      contactId: currentProject.contactId,
    },
  })
  await tx.potentialProject.update({
    where: { id: update.id },
    data: {
      position: update.position,
      stage: 'CONFIRMED',
      stageChangedAt: new Date(),
      projectId: project.id,
    },
  })
  ```
- Return `{ success: true, projectCreated?: { id, title } }` on conversion

2. **src/components/potential-projects/potential-board.tsx** - Add conversion feedback:
- Check response for projectCreated after successful CONFIRMED move
- Show toast notification: "Project created: [title]"
- Same pattern as pipeline-board

Note: Potential description is also copied to project (unlike deal which sets null).
  </action>
  <verify>
1. Drag a potential project (without existing project) to CONFIRMED stage
2. Check database: project table has new entry with matching title/description/revenue/company
3. Check database: potentialProject should have projectId set
4. Navigate to /projects - new project appears with source showing the potential
5. Drag same potential to CONFIRMED again - no duplicate project
  </verify>
  <done>
Moving potential to CONFIRMED auto-creates linked Project with potential data. Re-dragging does not duplicate. UI shows toast on conversion.
  </done>
</task>

</tasks>

<verification>
1. **Deal conversion flow:**
   - Create or select existing deal in pipeline
   - Drag to WON stage
   - Check project created in /projects page
   - Project shows "Converted from deal: [title]" in source

2. **Potential conversion flow:**
   - Create or select existing potential in potential projects
   - Drag to CONFIRMED stage
   - Check project created in /projects page
   - Project shows "Converted from potential: [title]" in source

3. **Duplicate prevention:**
   - Move deal/potential away from WON/CONFIRMED and back
   - No second project created
   - Original project link preserved

4. **Data inheritance:**
   - Project title matches source title
   - Project revenue matches source value/estimatedValue
   - Project company/contact matches source company/contact
</verification>

<success_criteria>
- PIPE-06: When deal moves to Won, system auto-creates a Project linked to deal
- PTNL-06: When potential moves to Confirmed, system auto-creates a Project linked to potential
- PROJ-07: Project detail page shows source (deal, potential) - this was built in 13-01, now has actual data
- Conversion is atomic (transaction) - no orphaned states
- Re-conversion prevented - projectId check before create
</success_criteria>

<output>
After completion, create `.planning/phases/13-projects-conversion/13-02-SUMMARY.md`
</output>
