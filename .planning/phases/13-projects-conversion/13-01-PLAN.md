---
phase: 13-projects-conversion
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/app/api/projects/route.ts
  - src/app/api/projects/[id]/route.ts
  - src/lib/project-utils.ts
  - src/components/projects/initiative-select.tsx
  - src/components/projects/project-form-modal.tsx
  - src/components/projects/project-card.tsx
  - src/components/projects/project-detail-sheet.tsx
  - src/components/projects/project-list.tsx
  - src/app/(dashboard)/projects/page.tsx
autonomous: true

must_haves:
  truths:
    - "User can view list of all projects"
    - "User can create project directly with company, contact, revenue, and optional KRI link"
    - "User can edit project details (title, description, revenue, status)"
    - "User can change project status (Draft, Active, Completed, Cancelled)"
    - "User can delete project with confirmation"
    - "Project detail shows linked KRI if present"
  artifacts:
    - path: "src/app/api/projects/route.ts"
      provides: "GET all projects, POST create project"
      exports: ["GET", "POST"]
    - path: "src/app/api/projects/[id]/route.ts"
      provides: "GET single, PATCH update, DELETE project"
      exports: ["GET", "PATCH", "DELETE"]
    - path: "src/lib/project-utils.ts"
      provides: "Status formatting, colors, source label helpers"
      exports: ["PROJECT_STATUSES", "formatProjectStatus", "getProjectStatusColor", "getSourceLabel"]
    - path: "src/components/projects/project-list.tsx"
      provides: "Filterable project list with status filter"
    - path: "src/app/(dashboard)/projects/page.tsx"
      provides: "Projects page with server-side data fetch"
  key_links:
    - from: "src/app/(dashboard)/projects/page.tsx"
      to: "/api/projects"
      via: "Prisma direct query"
      pattern: "prisma\\.project\\.findMany"
    - from: "src/components/projects/project-form-modal.tsx"
      to: "/api/projects"
      via: "fetch POST"
      pattern: "fetch.*api/projects.*POST"
    - from: "src/components/projects/project-detail-sheet.tsx"
      to: "/api/projects/[id]"
      via: "fetch PATCH/DELETE"
      pattern: "fetch.*api/projects.*PATCH|DELETE"
---

<objective>
Create Project entity CRUD with direct creation capability, KRI linking, and list view.

Purpose: Establish the Project entity as the destination for won deals and confirmed potentials, while also allowing direct project creation without a source.
Output: Working projects page with create/edit/delete functionality and optional KRI linking.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-projects-conversion/13-RESEARCH.md
@prisma/schema.prisma
@src/app/api/deals/route.ts
@src/components/pipeline/company-select.tsx
@src/components/pipeline/contact-select.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Project API routes and utility functions</name>
  <files>
    src/app/api/projects/route.ts
    src/app/api/projects/[id]/route.ts
    src/lib/project-utils.ts
  </files>
  <action>
Create project API routes following existing patterns from deals API:

1. **src/lib/project-utils.ts** - Status utilities:
```typescript
export const PROJECT_STATUSES = [
  { id: 'DRAFT', title: 'Draft', colorDot: 'bg-gray-400' },
  { id: 'ACTIVE', title: 'Active', colorDot: 'bg-blue-500' },
  { id: 'COMPLETED', title: 'Completed', colorDot: 'bg-green-500' },
  { id: 'CANCELLED', title: 'Cancelled', colorDot: 'bg-red-400' },
] as const

export function formatProjectStatus(status: string): string
export function getProjectStatusColor(status: string): string
export function getSourceLabel(sourceDeal, sourcePotential): { type: 'deal'|'potential'|'direct'; label: string }
```

2. **src/app/api/projects/route.ts** - List and create:
- GET: Return all projects with includes (company, contact, sourceDeal, sourcePotential, initiative)
- POST: Create project with validation (title required, companyId required), optional contactId, initiativeId, revenue

3. **src/app/api/projects/[id]/route.ts** - Single project operations:
- GET: Return single project with full includes
- PATCH: Update project fields (title, description, revenue, status, companyId, contactId, initiativeId)
- DELETE: Delete project

Use requireAuth for GET, requireEditor for POST/PATCH/DELETE (same pattern as deals).
  </action>
  <verify>
Run `curl http://localhost:3000/api/projects` returns empty array (or existing projects).
Run TypeScript check: `npx tsc --noEmit` passes.
  </verify>
  <done>
Project API routes handle full CRUD operations with proper auth guards.
  </done>
</task>

<task type="auto">
  <name>Task 2: Project components and page</name>
  <files>
    src/components/projects/initiative-select.tsx
    src/components/projects/project-form-modal.tsx
    src/components/projects/project-card.tsx
    src/components/projects/project-detail-sheet.tsx
    src/components/projects/project-list.tsx
    src/app/(dashboard)/projects/page.tsx
  </files>
  <action>
Create project UI components following existing patterns:

1. **src/components/projects/initiative-select.tsx** - KRI selector combobox:
- Search initiatives via existing `/api/initiatives/search` endpoint
- Debounced search (300ms), display title
- Allow clearing selection (optional field)
- Same pattern as CompanySelect but for initiatives

2. **src/components/projects/project-form-modal.tsx** - Create form:
- Fields: title (required), description, revenue, company (CompanySelect), contact (ContactSelect, depends on company), initiative (InitiativeSelect, optional)
- Use Dialog component (not Sheet - consistent with DealFormModal)
- Default status is DRAFT (set server-side)

3. **src/components/projects/project-card.tsx** - List card:
- Show title, company name, status badge, revenue (formatted as MYR)
- Show source indicator: small badge or icon (deal/potential/direct)
- Click triggers detail sheet
- No drag functionality (not a Kanban)

4. **src/components/projects/project-detail-sheet.tsx** - Edit sheet:
- Show all editable fields with inline editing pattern (like DealDetailSheet)
- Status dropdown (DRAFT, ACTIVE, COMPLETED, CANCELLED)
- Source display (read-only): show linked deal/potential title or "Direct creation"
- KRI link display: show initiative title if linked
- Delete button with AlertDialog confirmation

5. **src/components/projects/project-list.tsx** - Client component:
- Status filter tabs/buttons (All, Draft, Active, Completed, Cancelled)
- Grid of ProjectCards
- "Add Project" button (Editor+ only, use canEdit permission)
- Opens ProjectFormModal on add, ProjectDetailSheet on card click

6. **src/app/(dashboard)/projects/page.tsx** - Server component:
- Fetch projects via Prisma (not API route - server component pattern)
- Include company, contact, sourceDeal, sourcePotential, initiative
- Pass initialData to ProjectList
- Page title "Projects" with appropriate layout
  </action>
  <verify>
Navigate to /projects page, see empty state or project list.
Click "Add Project", fill form, submit - project appears in list.
Click project card, see detail sheet with all fields.
Edit status, see change reflected.
Delete project with confirmation.
  </verify>
  <done>
Projects page shows list of projects with full CRUD via modals/sheets, status filtering, and optional KRI linking. Source display shows deal/potential/direct origin.
  </done>
</task>

</tasks>

<verification>
1. Navigate to /projects - page loads without errors
2. Create project directly - fills in form, selects company, optionally links KRI
3. View project detail - shows source as "Direct creation" (no deal/potential)
4. Edit project - change title, status, KRI link
5. Delete project - confirmation dialog, removes from list
6. Status filter - shows correct subset of projects
</verification>

<success_criteria>
- PROJ-01: User can view list of all projects (list page with status filter)
- PROJ-02: User can create project directly (form modal with company/contact/KRI)
- PROJ-03: User can link project to KRI (InitiativeSelect in form and detail)
- PROJ-04: User can edit project details (detail sheet with inline editing)
- PROJ-05: User can change project status (status dropdown in detail)
- PROJ-06: User can delete project (AlertDialog confirmation)
- PROJ-08: Project detail shows linked KRI if present
</success_criteria>

<output>
After completion, create `.planning/phases/13-projects-conversion/13-01-SUMMARY.md`
</output>
