---
phase: 13-projects-conversion
plan: 03
type: execute
wave: 2
depends_on: ["13-01"]
files_modified:
  - src/app/api/companies/[id]/route.ts
  - src/components/companies/company-detail-modal.tsx
autonomous: true

must_haves:
  truths:
    - "Company detail page shows related deals"
    - "Company detail page shows related potentials"
    - "Company detail page shows related projects"
    - "Related items show title, status/stage, and value"
    - "Related items are limited to recent 5 with 'view more' indication"
  artifacts:
    - path: "src/app/api/companies/[id]/route.ts"
      provides: "Enhanced GET with deals, potentials, projects includes"
      contains: "deals:"
    - path: "src/components/companies/company-detail-modal.tsx"
      provides: "Related items section with deals, potentials, projects"
      contains: "Related Items"
  key_links:
    - from: "src/components/companies/company-detail-modal.tsx"
      to: "/api/companies/[id]"
      via: "fetch GET with includes"
      pattern: "fetch.*api/companies"
---

<objective>
Enhance company detail modal to show related deals, potentials, and projects.

Purpose: Give users a 360-degree view of company relationships - see all business interactions (deals, potentials, projects) from the company context.
Output: Company detail modal with a "Related Items" section showing recent deals, potentials, and projects for that company.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-projects-conversion/13-RESEARCH.md
@.planning/phases/13-projects-conversion/13-01-SUMMARY.md
@src/app/api/companies/[id]/route.ts
@src/components/companies/company-detail-modal.tsx
@src/lib/pipeline-utils.ts
@src/lib/potential-utils.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Enhance company API to return related items</name>
  <files>
    src/app/api/companies/[id]/route.ts
  </files>
  <action>
Modify the company GET endpoint to include related deals, potentials, and projects:

1. Update the Prisma query to include related items with limits:
```typescript
const company = await prisma.company.findUnique({
  where: { id },
  include: {
    contacts: {
      orderBy: [{ isPrimary: 'desc' }, { name: 'asc' }],
    },
    deals: {
      select: {
        id: true,
        title: true,
        stage: true,
        value: true,
      },
      orderBy: { createdAt: 'desc' },
      take: 5,
    },
    potentials: {
      select: {
        id: true,
        title: true,
        stage: true,
        estimatedValue: true,
      },
      orderBy: { createdAt: 'desc' },
      take: 5,
    },
    projects: {
      select: {
        id: true,
        title: true,
        status: true,
        revenue: true,
      },
      orderBy: { createdAt: 'desc' },
      take: 5,
    },
    _count: {
      select: { deals: true, projects: true, potentials: true },
    },
  },
})
```

2. The response now includes:
- contacts (full list as before)
- deals (recent 5 with title, stage, value)
- potentials (recent 5 with title, stage, estimatedValue)
- projects (recent 5 with title, status, revenue)
- _count (total counts for "view more" indicators)

Note: The _count is already present in the schema. Just ensure the includes are added.
  </action>
  <verify>
Run `curl http://localhost:3000/api/companies/{id}` returns company with deals, potentials, projects arrays.
Check that arrays are limited to 5 items max.
Check _count shows total counts.
  </verify>
  <done>
Company API returns related deals, potentials, and projects with limits and total counts.
  </done>
</task>

<task type="auto">
  <name>Task 2: Company modal related items section</name>
  <files>
    src/components/companies/company-detail-modal.tsx
  </files>
  <action>
Add a "Related Items" section to the company detail modal below the Contacts section:

1. Update the Company interface to include the new related items:
```typescript
interface Company {
  id: string
  name: string
  // ... existing fields ...
  contacts: Contact[]
  deals: { id: string; title: string; stage: string; value: number | null }[]
  potentials: { id: string; title: string; stage: string; estimatedValue: number | null }[]
  projects: { id: string; title: string; status: string; revenue: number | null }[]
  _count: {
    deals: number
    projects: number
    potentials: number
  }
}
```

2. Import formatting utilities:
```typescript
import { formatDealStage, getStageColor } from '@/lib/pipeline-utils'
import { formatPotentialStage, getPotentialStageColor } from '@/lib/potential-utils'
import { formatProjectStatus, getProjectStatusColor } from '@/lib/project-utils'
```

3. Add a new section after Contacts (before the delete footer):
```tsx
<Separator />

{/* Related Items Section */}
<div className="space-y-4">
  <h3 className="font-medium text-gray-900">Related Items</h3>

  {/* Deals */}
  {company.deals.length > 0 && (
    <div className="space-y-2">
      <h4 className="text-sm font-medium text-gray-500">
        Deals ({company._count.deals})
      </h4>
      <div className="space-y-1">
        {company.deals.map((deal) => (
          <div key={deal.id} className="flex items-center justify-between text-sm py-1">
            <span className="truncate flex-1 mr-2">{deal.title}</span>
            <div className="flex items-center gap-2">
              {deal.value && (
                <span className="text-gray-500">
                  RM {Number(deal.value).toLocaleString()}
                </span>
              )}
              <Badge variant="outline" className={getStageColor(deal.stage)}>
                {formatDealStage(deal.stage)}
              </Badge>
            </div>
          </div>
        ))}
        {company._count.deals > 5 && (
          <p className="text-xs text-muted-foreground">
            +{company._count.deals - 5} more deals
          </p>
        )}
      </div>
    </div>
  )}

  {/* Potentials - same pattern */}
  {company.potentials.length > 0 && (
    <div className="space-y-2">
      <h4 className="text-sm font-medium text-gray-500">
        Potential Projects ({company._count.potentials})
      </h4>
      {/* Similar structure with formatPotentialStage, getPotentialStageColor */}
    </div>
  )}

  {/* Projects - same pattern */}
  {company.projects.length > 0 && (
    <div className="space-y-2">
      <h4 className="text-sm font-medium text-gray-500">
        Projects ({company._count.projects})
      </h4>
      {/* Similar structure with formatProjectStatus, getProjectStatusColor */}
    </div>
  )}

  {/* Empty state if no related items */}
  {company.deals.length === 0 && company.potentials.length === 0 && company.projects.length === 0 && (
    <p className="text-sm text-muted-foreground">No deals, potentials, or projects yet.</p>
  )}
</div>
```

4. Import Badge from ui/badge if not already imported.

5. Note: The utility functions formatPotentialStage and getPotentialStageColor may need to be added to potential-utils.ts if they don't exist. Check the file first - if not present, add:
```typescript
// src/lib/potential-utils.ts (if functions missing)
export function formatPotentialStage(stage: string): string {
  const map: Record<string, string> = {
    POTENTIAL: 'Potential',
    CONFIRMED: 'Confirmed',
    CANCELLED: 'Cancelled',
  }
  return map[stage] || stage
}

export function getPotentialStageColor(stage: string): string {
  const colors: Record<string, string> = {
    POTENTIAL: 'bg-blue-100 text-blue-700',
    CONFIRMED: 'bg-green-100 text-green-700',
    CANCELLED: 'bg-red-100 text-red-700',
  }
  return colors[stage] || 'bg-gray-100 text-gray-700'
}
```
  </action>
  <verify>
1. Open company detail modal for a company with deals/potentials/projects
2. See "Related Items" section below Contacts
3. Each section shows up to 5 items with title, value, and status badge
4. "+X more" appears if count exceeds 5
5. Empty state shows if no related items
  </verify>
  <done>
Company detail modal shows related deals, potentials, and projects with status badges, values, and "view more" indicators.
  </done>
</task>

</tasks>

<verification>
1. **API response:**
   - GET /api/companies/{id} returns deals, potentials, projects arrays
   - Arrays limited to 5 items
   - _count shows total counts

2. **Modal display:**
   - Open company with related items - see all three sections
   - Deals show stage badge (Lead, Qualified, etc.)
   - Potentials show stage badge (Potential, Confirmed, Cancelled)
   - Projects show status badge (Draft, Active, Completed, Cancelled)
   - Values display formatted as MYR

3. **Edge cases:**
   - Company with no related items shows empty state
   - Company with >5 deals shows "+X more deals"
   - Company with exactly 5 deals shows no "more" text
</verification>

<success_criteria>
- COMP-05: Company detail page shows related deals, potentials, and projects
- Related items show title, status/stage, and value
- Limited to recent 5 with total count display
- Consistent badge styling with existing stage/status utilities
</success_criteria>

<output>
After completion, create `.planning/phases/13-projects-conversion/13-03-SUMMARY.md`
</output>
