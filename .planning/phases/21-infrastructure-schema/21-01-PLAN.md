---
phase: 21-infrastructure-schema
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - next.config.mjs
  - docker-compose.nas.yml
  - Dockerfile
autonomous: true

must_haves:
  truths:
    - "Next.js accepts file uploads up to 10MB without error"
    - "Docker container has /app/uploads directory accessible"
    - "Uploads directory persists across container restarts on NAS"
  artifacts:
    - path: "next.config.mjs"
      provides: "Body size limit configuration"
      contains: "bodySizeLimit"
    - path: "docker-compose.nas.yml"
      provides: "Volume mount for uploads"
      contains: "/uploads:/app/uploads"
    - path: "Dockerfile"
      provides: "Uploads directory creation with proper ownership"
      contains: "mkdir -p /app/uploads"
  key_links:
    - from: "next.config.mjs"
      to: "serverActions"
      via: "bodySizeLimit setting"
      pattern: "bodySizeLimit.*10MB"
    - from: "docker-compose.nas.yml"
      to: "Dockerfile"
      via: "volume mount matches directory created"
      pattern: "uploads:/app/uploads"
---

<objective>
Configure Next.js and Docker infrastructure to support 10MB file uploads with persistent storage on NAS.

Purpose: Enable document upload feature by removing default body size limits and creating persistent file storage that survives container restarts.

Output: Updated next.config.mjs with 10MB limit, docker-compose.nas.yml with uploads volume mount, Dockerfile with uploads directory setup.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/21-infrastructure-schema/21-RESEARCH.md
@next.config.mjs
@docker-compose.nas.yml
@Dockerfile
</context>

<tasks>

<task type="auto">
  <name>Task 1: Configure Next.js body size limit</name>
  <files>next.config.mjs</files>
  <action>
Update next.config.mjs to add bodySizeLimit configuration for 10MB file uploads.

Add to experimental.serverActions:
```javascript
bodySizeLimit: '10MB',  // CRITICAL: uppercase MB required
```

The existing config has serverActions with allowedOrigins - add bodySizeLimit at same level.

IMPORTANT: Use uppercase 'MB' not lowercase 'mb' - lowercase has been reported as inconsistent.
  </action>
  <verify>Run `cat next.config.mjs` and confirm bodySizeLimit: '10MB' is present in serverActions config</verify>
  <done>next.config.mjs contains bodySizeLimit: '10MB' in experimental.serverActions</done>
</task>

<task type="auto">
  <name>Task 2: Configure Docker volume mount and directory</name>
  <files>docker-compose.nas.yml, Dockerfile</files>
  <action>
1. Update docker-compose.nas.yml - add uploads volume mount to app service:
   Under services.app.volumes (create if needed):
   ```yaml
   volumes:
     - /volume1/Motionvii/saap2026v2/uploads:/app/uploads
   ```

   Add UPLOADS_DIR environment variable:
   ```yaml
   environment:
     - UPLOADS_DIR=/app/uploads
   ```

2. Update Dockerfile - create uploads directory with proper ownership in production stage:
   After the "Set ownership" comment block, before USER nextjs:
   ```dockerfile
   # Create uploads directory for file storage
   RUN mkdir -p /app/uploads && chown -R nextjs:nodejs /app/uploads
   ```

   This ensures the directory exists and is writable by the nextjs user.
  </action>
  <verify>
1. Run `grep -A5 'volumes:' docker-compose.nas.yml` - should show uploads mount
2. Run `grep 'UPLOADS_DIR' docker-compose.nas.yml` - should show environment variable
3. Run `grep -A1 'uploads' Dockerfile` - should show mkdir and chown
  </verify>
  <done>
- docker-compose.nas.yml has /volume1/Motionvii/saap2026v2/uploads:/app/uploads volume mount
- docker-compose.nas.yml has UPLOADS_DIR=/app/uploads environment variable
- Dockerfile creates /app/uploads directory owned by nextjs:nodejs
  </done>
</task>

</tasks>

<verification>
1. next.config.mjs has serverActions.bodySizeLimit set to '10MB'
2. docker-compose.nas.yml mounts NAS uploads path to /app/uploads
3. docker-compose.nas.yml sets UPLOADS_DIR environment variable
4. Dockerfile creates and properly owns /app/uploads directory
5. `npm run build` succeeds (config is valid)
</verification>

<success_criteria>
- Next.js config accepts 10MB body size for server actions
- Docker infrastructure ready for persistent file storage
- Build passes without errors
</success_criteria>

<output>
After completion, create `.planning/phases/21-infrastructure-schema/21-01-SUMMARY.md`
</output>
