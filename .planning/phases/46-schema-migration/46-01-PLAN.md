---
phase: 46-schema-migration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - prisma/schema.prisma
autonomous: true

must_haves:
  truths:
    - "Prisma client has KeyResult model with all required fields (krId, objective, description, metricType, target, actual, unit, progress, deadline, status, owner, howWeMeasure, notes, weight)"
    - "Prisma client has SupportTask model with category enum, taskId, task, owner, frequency, priority, notes"
    - "Prisma client has SupportTaskKeyResult join table with composite unique on [supportTaskId, keyResultId]"
    - "Initiative model has keyResultId FK (nullable String) to KeyResult, plus budget and resources fields"
    - "Initiative model no longer has kpiLabel, kpiTarget, kpiActual, kpiUnit, kpiManualOverride, monthlyObjective, weeklyTasks fields"
    - "MetricType enum has REVENUE and COUNT values"
    - "KeyResultStatus enum has NOT_STARTED, ON_TRACK, AT_RISK, BEHIND, ACHIEVED values"
    - "SupportTaskCategory enum has DESIGN_CREATIVE, BUSINESS_ADMIN, TALENTA_IDEAS, OPERATIONS values"
  artifacts:
    - path: "prisma/schema.prisma"
      provides: "Complete v2.0 OKR schema with KeyResult, SupportTask, SupportTaskKeyResult models, MetricType/KeyResultStatus/SupportTaskCategory enums, modified Initiative model"
      contains: "model KeyResult"
    - path: "node_modules/.prisma/client/index.d.ts"
      provides: "Generated Prisma client with all new models and enums"
  key_links:
    - from: "Initiative.keyResultId"
      to: "KeyResult.id"
      via: "@relation(fields: [keyResultId], references: [id])"
      pattern: "keyResultId.*String.*@map.*key_result_id"
    - from: "SupportTaskKeyResult.supportTaskId"
      to: "SupportTask.id"
      via: "@relation(fields: [supportTaskId], references: [id], onDelete: Cascade)"
      pattern: "supportTaskId.*String.*@map.*support_task_id"
    - from: "SupportTaskKeyResult.keyResultId"
      to: "KeyResult.id"
      via: "@relation(fields: [keyResultId], references: [id], onDelete: Cascade)"
      pattern: "keyResultId.*String.*@map.*key_result_id"
---

<objective>
Edit prisma/schema.prisma to add the full OKR hierarchy (KeyResult, SupportTask, SupportTaskKeyResult models + MetricType, KeyResultStatus, SupportTaskCategory enums), modify Initiative to use KeyResult FK and remove KPI fields, then push to database and regenerate client.

Purpose: Foundation for all v2.0 phases -- every downstream phase (seed, API, UI) depends on this schema existing.
Output: Updated schema.prisma, database tables created, Prisma client generated with new types.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md
@.planning/phases/46-schema-migration/46-RESEARCH.md
@prisma/schema.prisma
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add OKR models, enums, and modify Initiative in schema.prisma</name>
  <files>prisma/schema.prisma</files>
  <action>
Edit prisma/schema.prisma to make all the following changes in ONE pass. The research doc (46-RESEARCH.md) has complete, verified code for every model and enum -- use those exact definitions.

**A) Add 3 new enums** (place them after the existing enums section, before models):

1. `MetricType` with values: REVENUE, COUNT
2. `KeyResultStatus` with values: NOT_STARTED, ON_TRACK, AT_RISK, BEHIND, ACHIEVED
3. `SupportTaskCategory` with values: DESIGN_CREATIVE, BUSINESS_ADMIN, TALENTA_IDEAS, OPERATIONS

**B) Add KeyResult model** with ALL these fields:
- `id String @id @default(cuid())`
- `krId String @unique @db.VarChar(20)` -- human-readable ID like "KR1.1"
- `objective Objective` -- reuses existing Objective enum
- `description String @db.VarChar(500)`
- `metricType MetricType`
- `target Decimal @db.Decimal(12, 2)`
- `actual Decimal @default(0) @db.Decimal(12, 2)`
- `unit String @db.VarChar(50)` -- "RM", "clients", "programs"
- `progress Decimal @default(0) @db.Decimal(5, 2)` -- 0.00-100.00
- `deadline String @db.VarChar(50)` -- String not DateTime (flexible format)
- `status KeyResultStatus @default(NOT_STARTED)`
- `owner String @db.VarChar(100)` -- String per requirements, not TeamMember enum
- `howWeMeasure String? @map("how_we_measure") @db.Text`
- `notes String? @db.Text`
- `weight Decimal @default(1) @db.Decimal(5, 2)`
- Relations: `initiatives Initiative[]`, `supportTaskLinks SupportTaskKeyResult[]`
- Timestamps: `createdAt DateTime @default(now())`, `updatedAt DateTime @updatedAt`
- Indexes: `@@index([objective])`, `@@index([status])`
- Map: `@@map("key_results")`

**C) Add SupportTask model** with ALL these fields:
- `id String @id @default(cuid())`
- `taskId String @unique @db.VarChar(20)` -- "ST-001"
- `category SupportTaskCategory`
- `task String @db.VarChar(500)`
- `owner String @db.VarChar(100)` -- String per requirements
- `frequency String? @db.VarChar(50)` -- too many variations for enum
- `priority TaskPriority @default(MEDIUM)` -- reuses existing TaskPriority enum
- `notes String? @db.Text`
- Relations: `keyResultLinks SupportTaskKeyResult[]`
- Timestamps: `createdAt DateTime @default(now())`, `updatedAt DateTime @updatedAt`
- Indexes: `@@index([category])`, `@@index([priority])`
- Map: `@@map("support_tasks")`

**D) Add SupportTaskKeyResult join table** (follows existing TaskTag pattern at lines 756-773):
- `id String @id @default(cuid())`
- `supportTaskId String @map("support_task_id")`
- `supportTask SupportTask @relation(fields: [supportTaskId], references: [id], onDelete: Cascade)`
- `keyResultId String @map("key_result_id")`
- `keyResult KeyResult @relation(fields: [keyResultId], references: [id], onDelete: Cascade)`
- `createdAt DateTime @default(now())`
- Constraints: `@@unique([supportTaskId, keyResultId])`
- Indexes: `@@index([supportTaskId])`, `@@index([keyResultId])`
- Map: `@@map("support_task_key_results")`

**E) Modify Initiative model:**

ADD these fields (after the `position` field, before the KPI fields comment):
- `keyResultId String? @map("key_result_id")` -- nullable so migration applies to existing rows
- `keyResult KeyResult? @relation(fields: [keyResultId], references: [id])` -- note: relation name is implicit since only one relation
- `budget String? @db.VarChar(255)` -- String per requirements (may contain non-numeric text)
- `resources String? @db.Text`

ADD this index (in the @@index block):
- `@@index([keyResultId])`

REMOVE these 7 fields from Initiative:
- `keyResult String @db.VarChar(20)` -- line 46, replaced by keyResultId FK
- `monthlyObjective String? @db.Text` -- line 49
- `weeklyTasks String? @db.Text` -- line 50
- `kpiLabel String? @map("kpi_label") @db.VarChar(100)` -- line 62
- `kpiTarget Decimal? @map("kpi_target") @db.Decimal(12, 2)` -- line 63
- `kpiActual Decimal? @map("kpi_actual") @db.Decimal(12, 2)` -- line 64
- `kpiUnit String? @map("kpi_unit") @db.VarChar(50)` -- line 65
- `kpiManualOverride Boolean @default(false) @map("kpi_manual_override")` -- line 66

REMOVE the KPI fields comment block (line 61: `// KPI fields (v1.5 - Initiative Intelligence)`)

**IMPORTANT conventions (from research):**
- Use `String @id @default(cuid())` for all PKs (NOT Int autoincrement)
- Use `String` FKs with `@map("snake_case")`
- Use `@@map("snake_case_plural")` on every model
- Use `PascalCase` enum names, `SCREAMING_SNAKE_CASE` enum values
- Place new models in a clearly commented v2.0 section

**DO NOT** touch any models other than Initiative. Keep all existing models, enums, and their fields exactly as they are.
  </action>
  <verify>
Run `npx prisma validate` to confirm schema syntax is correct. Expected: no errors.
Run `npx prisma format` to auto-format the schema file.
Verify the schema contains: "model KeyResult", "model SupportTask", "model SupportTaskKeyResult", "enum MetricType", "enum KeyResultStatus", "enum SupportTaskCategory".
Verify Initiative has "keyResultId" and does NOT have "kpiTarget", "kpiActual", "monthlyObjective", "weeklyTasks".
  </verify>
  <done>
prisma/schema.prisma contains all 3 new models with correct fields and relations, all 3 new enums, Initiative has keyResultId FK + budget/resources fields, and Initiative no longer has the 7 removed fields. Schema validates without errors.
  </done>
</task>

<task type="auto">
  <name>Task 2: Push schema to database and generate Prisma client</name>
  <files>prisma/schema.prisma</files>
  <action>
Push the updated schema to the database and regenerate the Prisma client.

**Step 1: Push schema to database**
Run `npx prisma db push` to apply the schema changes.

This will:
- Create `key_results` table
- Create `support_tasks` table
- Create `support_task_key_results` table
- Add `key_result_id`, `budget`, `resources` columns to `initiatives` table
- Drop `key_result` (old string), `monthly_objective`, `weekly_tasks`, `kpi_label`, `kpi_target`, `kpi_actual`, `kpi_unit`, `kpi_manual_override` columns from `initiatives` table
- Create all indexes

Use `prisma db push` (NOT `prisma migrate dev`) per research recommendation -- the project has always used db push, and switching to migrate risks the MariaDB FK drift loop (C3 pitfall). Since this is wipe-and-reseed, versioned migration history adds no value.

If the push warns about data loss from column drops (kpi fields, monthlyObjective, weeklyTasks, keyResult string), accept it -- data loss is expected and acceptable per prior decisions (C4 pitfall). The seed script in Phase 47 will repopulate all data.

**Step 2: Generate Prisma client**
Run `npx prisma generate` to regenerate the client types.

**Step 3: Verify models exist in generated client**
Check that the generated types include KeyResult, SupportTask, SupportTaskKeyResult, MetricType, KeyResultStatus, SupportTaskCategory by inspecting the generated index file or running a quick TypeScript check.
  </action>
  <verify>
`npx prisma db push` completes without errors.
`npx prisma generate` completes without errors.
Run `npx tsx -e "import { PrismaClient } from '@prisma/client'; const p = new PrismaClient(); console.log('KeyResult' in p ? 'OK' : 'MISSING'); console.log('supportTask' in p ? 'OK' : 'MISSING'); console.log('supportTaskKeyResult' in p ? 'OK' : 'MISSING'); p.$disconnect();"` -- all print OK (note: Prisma uses lowercase first letter for model accessors: p.keyResult, p.supportTask, p.supportTaskKeyResult).

Alternative verification: `npx prisma studio` opens without errors and shows key_results, support_tasks, support_task_key_results tables in the sidebar.
  </verify>
  <done>
Database has key_results, support_tasks, support_task_key_results tables. initiatives table has key_result_id, budget, resources columns and no longer has kpi_label, kpi_target, kpi_actual, kpi_unit, kpi_manual_override, monthly_objective, weekly_tasks, key_result columns. Prisma client is generated with KeyResult, SupportTask, SupportTaskKeyResult models and MetricType, KeyResultStatus, SupportTaskCategory enums available for import.
  </done>
</task>

</tasks>

<verification>
1. `npx prisma validate` -- schema syntax is correct
2. `npx prisma db push` -- schema applied to database without errors
3. `npx prisma generate` -- client generated successfully
4. Database inspection confirms: 3 new tables exist, initiatives table has new columns and lacks old columns
5. TypeScript import of new models/enums works without errors
</verification>

<success_criteria>
1. `npx prisma generate` produces a client with KeyResult, SupportTask, SupportTaskKeyResult models and MetricType, KeyResultStatus, SupportTaskCategory enums
2. Initiative model has keyResultId FK (nullable) and budget/resources fields; kpiTarget, kpiActual, kpiUnit, kpiLabel, kpiManualOverride, monthlyObjective, weeklyTasks are removed
3. KeyResult model has all 15 fields: krId (unique), objective, description, metricType, target, actual, unit, progress, deadline, status, owner, howWeMeasure, notes, weight
4. SupportTask model has category (SupportTaskCategory enum), taskId (unique), task, owner, frequency, priority (TaskPriority), notes
5. SupportTaskKeyResult has composite unique on [supportTaskId, keyResultId] with cascade deletes
</success_criteria>

<output>
After completion, create `.planning/phases/46-schema-migration/46-01-SUMMARY.md`
</output>
