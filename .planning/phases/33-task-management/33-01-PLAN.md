---
phase: 33-task-management
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/app/api/projects/[id]/tasks/route.ts
  - src/app/api/projects/[id]/tasks/[taskId]/route.ts
  - src/components/projects/task-form.tsx
  - src/components/projects/task-card.tsx
  - src/components/projects/project-detail-sheet.tsx
autonomous: true
user_setup: []

must_haves:
  truths:
    - "User can create task on project with title, description, status, priority, due date, and assignee"
    - "User can view list of tasks on project detail"
    - "User can edit task details"
    - "User can delete task"
  artifacts:
    - path: "src/app/api/projects/[id]/tasks/route.ts"
      provides: "GET (list) and POST (create) endpoints for tasks"
      exports: ["GET", "POST"]
    - path: "src/app/api/projects/[id]/tasks/[taskId]/route.ts"
      provides: "GET, PATCH, DELETE endpoints for single task"
      exports: ["GET", "PATCH", "DELETE"]
    - path: "src/components/projects/task-form.tsx"
      provides: "Form for creating/editing tasks"
      min_lines: 100
    - path: "src/components/projects/task-card.tsx"
      provides: "Task display card with edit/delete actions"
      min_lines: 80
  key_links:
    - from: "src/components/projects/project-detail-sheet.tsx"
      to: "/api/projects/[id]/tasks"
      via: "fetch in useEffect"
      pattern: "fetch.*api/projects.*tasks"
    - from: "src/components/projects/task-form.tsx"
      to: "/api/projects/[id]/tasks"
      via: "POST/PATCH request on submit"
      pattern: "fetch.*tasks.*method.*POST|PATCH"
---

<objective>
Create Task CRUD API and basic UI components for project task management.

Purpose: Establish the foundation for task management - users need to create, view, edit, and delete tasks on projects before we can add hierarchy and advanced features.

Output: Task API routes, TaskForm component, TaskCard component, Tasks section in ProjectDetailSheet (flat list initially).
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/33-task-management/33-RESEARCH.md

# Pattern references
@src/app/api/projects/[id]/deliverables/route.ts
@src/app/api/projects/[id]/deliverables/[deliverableId]/route.ts
@src/components/projects/deliverable-form.tsx
@src/components/projects/deliverable-card.tsx
@src/components/projects/project-detail-sheet.tsx
@prisma/schema.prisma
</context>

<tasks>

<task type="auto">
  <name>Task 1: Task API Routes</name>
  <files>
    src/app/api/projects/[id]/tasks/route.ts
    src/app/api/projects/[id]/tasks/[taskId]/route.ts
  </files>
  <action>
Create Task API routes following the Deliverable API pattern exactly.

**GET /api/projects/[id]/tasks** (list):
- Require auth
- Verify project exists, return 404 if not
- Return all tasks for projectId ordered by depth ASC, sortOrder ASC, createdAt ASC
- Include `_count: { children: true, comments: true }` for UI indicators
- Include `tags: { include: { tag: true } }` for tag display

**POST /api/projects/[id]/tasks** (create):
- Require editor role
- Validate title is required (trim and check)
- If parentId provided:
  - Fetch parent task, return 404 if not found
  - Check parent.depth >= 4, return 400 "Maximum nesting depth (5 levels) reached"
  - Set depth = parent.depth + 1
  - Copy parent's tags with inherited: true (in transaction)
- Calculate next sortOrder for siblings (aggregate max + 1)
- Create task with: projectId, parentId, title, description, status (default TODO), priority (default MEDIUM), dueDate, assignee, depth, sortOrder
- Return 201 with created task

**GET /api/projects/[id]/tasks/[taskId]** (single):
- Require auth
- Return task with tags and comments count

**PATCH /api/projects/[id]/tasks/[taskId]** (update):
- Require editor role
- Allow updating: title, description, status, priority, dueDate, assignee
- Do NOT allow changing parentId (restructuring is separate operation)
- Return updated task

**DELETE /api/projects/[id]/tasks/[taskId]** (delete):
- Require editor role
- Implement cascade delete in app code (per STATE.md decision):
  1. Get all descendant task IDs recursively
  2. Delete in transaction: TaskTag, TaskComment, then Tasks (deepest first)
- Return 204 on success

Use the descendant collection pattern from RESEARCH.md for cascade delete.
  </action>
  <verify>
Run `npm run lint` - no errors in new files.
Test with curl or API client:
- POST creates task, returns 201
- GET lists tasks for project
- PATCH updates task fields
- DELETE removes task and descendants
  </verify>
  <done>
All four CRUD operations work. Depth validation enforced on create. Cascade delete removes descendants.
  </done>
</task>

<task type="auto">
  <name>Task 2: TaskForm and TaskCard Components</name>
  <files>
    src/components/projects/task-form.tsx
    src/components/projects/task-card.tsx
    src/components/projects/project-detail-sheet.tsx
  </files>
  <action>
Create TaskForm and TaskCard following DeliverableForm/DeliverableCard patterns.

**TaskForm (src/components/projects/task-form.tsx):**
- Props: projectId, parentId?, task? (for edit), onSuccess, onCancel
- Fields:
  - title (required) - Input
  - description - Textarea
  - status - Select with TODO/IN_PROGRESS/DONE options
  - priority - Select with LOW/MEDIUM/HIGH options
  - dueDate - Input type="date"
  - assignee - Select with TEAM_MEMBER_OPTIONS from utils.ts (include empty option)
- Submit to POST (create) or PATCH (edit) task API
- Show error messages on validation failure
- Loading state on submit button

**TaskCard (src/components/projects/task-card.tsx):**
- Props: task, projectId, onEdit, onDelete
- Display: title, status badge (color-coded), priority badge, due date (if set), assignee (if set)
- Status colors: TODO=gray, IN_PROGRESS=blue, DONE=green
- Priority colors: LOW=gray, MEDIUM=yellow, HIGH=red
- Show comment count icon if comments > 0
- Show children count badge if has subtasks
- Edit button (pencil icon) -> calls onEdit(task)
- Delete button (trash icon) with AlertDialog confirmation -> calls API then onDelete()

**ProjectDetailSheet integration:**
- Add tasks state: `useState<Task[]>([])`
- Add fetchTasks function (like fetchDeliverables)
- Call fetchTasks in useEffect when projectId changes
- Add Tasks section AFTER Deliverables section (before Documents):
  - Label "Tasks" with count badge
  - "Add Task" button (when tasks exist)
  - Empty state with ListTodo icon and "Add your first task" button
  - List of TaskCard components
  - TaskForm for add/edit modes (editingTask state)
- Add refreshTasks to refresh callback

Use TEAM_MEMBER_OPTIONS and formatTeamMember from @/lib/utils for assignee display.
  </action>
  <verify>
Run `npm run build` - no type errors.
Open project detail sheet in browser:
- Tasks section visible below Deliverables
- Can create task with all fields
- Task displays with badges for status/priority
- Can edit and delete tasks
  </verify>
  <done>
Tasks section appears in project detail with full CRUD. Status/priority/assignee selectable. Edit and delete work with confirmation.
  </done>
</task>

</tasks>

<verification>
Run `npm run build && npm run lint` - no errors.

Manual testing:
1. Open any project detail
2. Scroll to Tasks section (should be below Deliverables)
3. Click "Add your first task"
4. Fill form: title, description, select status/priority, set due date, pick assignee
5. Submit - task appears in list
6. Click edit - form populates with task data
7. Update and save - changes reflected
8. Click delete - confirmation dialog - confirm - task removed
</verification>

<success_criteria>
- TASK-01: Create task with title, description - DONE
- TASK-02: Set task status - DONE
- TASK-03: Set task due date - DONE
- TASK-04: Assign task to team member - DONE
- TASK-10: Set task priority - DONE
- TASK-13: Edit task details - DONE
- TASK-14: Delete task - DONE (cascade delete implemented)
</success_criteria>

<output>
After completion, create `.planning/phases/33-task-management/33-01-SUMMARY.md`
</output>
