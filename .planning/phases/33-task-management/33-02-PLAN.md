---
phase: 33-task-management
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/app/api/tags/route.ts
  - src/app/api/tags/[tagId]/route.ts
  - src/components/projects/task-tag-select.tsx
  - src/lib/task-utils.ts
autonomous: true
user_setup: []

must_haves:
  truths:
    - "User can create global tags with name and color"
    - "User can view list of available tags"
    - "User can select existing tag or create new tag when tagging a task"
  artifacts:
    - path: "src/app/api/tags/route.ts"
      provides: "GET (list) and POST (create) endpoints for tags"
      exports: ["GET", "POST"]
    - path: "src/app/api/tags/[tagId]/route.ts"
      provides: "PATCH, DELETE endpoints for single tag"
      exports: ["PATCH", "DELETE"]
    - path: "src/components/projects/task-tag-select.tsx"
      provides: "Tag selection component with create-new capability"
      min_lines: 80
    - path: "src/lib/task-utils.ts"
      provides: "Task tree utilities (buildTaskTree, calculateProgress, getDescendantIds)"
      min_lines: 50
  key_links:
    - from: "src/components/projects/task-tag-select.tsx"
      to: "/api/tags"
      via: "fetch on mount"
      pattern: "fetch.*api/tags"
---

<objective>
Create Tags API and TaskTagSelect component for task tagging functionality.

Purpose: Tags need their own CRUD (global resource) and a reusable selection component before we can integrate tagging into the task tree UI. Also create task utility functions needed by tree view.

Output: Tags API routes, TaskTagSelect component, task-utils.ts with tree/progress helpers.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/33-task-management/33-RESEARCH.md

# Pattern references
@src/app/api/projects/[id]/deliverables/route.ts
@prisma/schema.prisma
</context>

<tasks>

<task type="auto">
  <name>Task 1: Tags API Routes</name>
  <files>
    src/app/api/tags/route.ts
    src/app/api/tags/[tagId]/route.ts
  </files>
  <action>
Create Tags API for global tag management.

**GET /api/tags** (list):
- Require auth
- Return all tags ordered by name ASC
- No filtering needed (global tags, flat list)

**POST /api/tags** (create):
- Require editor role
- Validate name is required, trim whitespace
- Check for duplicate name (case-insensitive), return 409 if exists
- Default color to "#6B7280" (gray) if not provided
- Validate color is valid hex format (#RRGGBB)
- Return 201 with created tag

**PATCH /api/tags/[tagId]** (update):
- Require editor role
- Allow updating: name, color
- Validate name uniqueness if changed
- Return updated tag

**DELETE /api/tags/[tagId]** (delete):
- Require admin role (tags are shared resource)
- Delete tag - TaskTag relations cascade automatically via schema
- Return 204 on success

Define a preset color palette for the UI (8 colors):
```typescript
const TAG_COLORS = [
  '#6B7280', // Gray
  '#EF4444', // Red
  '#F97316', // Orange
  '#EAB308', // Yellow
  '#22C55E', // Green
  '#06B6D4', // Cyan
  '#3B82F6', // Blue
  '#8B5CF6', // Purple
]
```

Export TAG_COLORS from the route file or a separate constants file.
  </action>
  <verify>
Run `npm run lint` - no errors.
Test with curl:
- GET /api/tags returns empty array initially
- POST creates tag, returns 201
- POST with duplicate name returns 409
- DELETE removes tag
  </verify>
  <done>
Tags CRUD works. Duplicate names rejected. Color defaults applied.
  </done>
</task>

<task type="auto">
  <name>Task 2: TaskTagSelect Component and Task Utilities</name>
  <files>
    src/components/projects/task-tag-select.tsx
    src/lib/task-utils.ts
  </files>
  <action>
Create TaskTagSelect component and task utility functions.

**TaskTagSelect (src/components/projects/task-tag-select.tsx):**
Props:
- taskId: string
- projectId: string
- selectedTags: { tag: { id: string; name: string; color: string }; inherited: boolean }[]
- onTagsChange: () => void

Behavior:
- Use Popover with Command (shadcn combobox pattern)
- Fetch available tags on popover open (lazy load)
- Show search input for filtering
- List available tags as checkboxes with color dot
- Selected tags show checkmark
- Inherited tags show lock icon (cannot be removed from this task)
- "Create new tag" button at bottom when search doesn't match existing
- Create new tag dialog: name input + color picker (preset palette from TAG_COLORS)

Tag add/remove logic:
- When adding tag: POST to /api/projects/[id]/tasks/[taskId]/tags with { tagId }
- When removing tag: DELETE to /api/projects/[id]/tasks/[taskId]/tags/[tagId]
- (Note: These endpoints will be created in Plan 33-03 when integrating with tree - for now just structure the component)

For now, just structure the component with TODO comments for the actual API calls.

**task-utils.ts (src/lib/task-utils.ts):**
Create utility functions for task tree operations:

```typescript
// Task type with children for tree structure
export interface TaskWithChildren extends Task {
  children: TaskWithChildren[]
}

// Build tree from flat list
export function buildTaskTree(tasks: Task[]): TaskWithChildren[]
// - First pass: create map of id -> node with empty children
// - Second pass: connect parent-child relationships
// - Sort children by sortOrder
// - Return root nodes (parentId === null)

// Calculate subtask progress for a task
export function calculateProgress(task: TaskWithChildren): { completed: number; total: number }
// - Recursively count children
// - completed = children with status === 'DONE'
// - total = all children

// Get all descendant task IDs (for cascade operations)
export function getDescendantIds(tasks: Task[], taskId: string): string[]
// - From flat list, recursively find all children
// - Return array of descendant IDs (not including the root)
```

Use patterns from RESEARCH.md for the implementations.
  </action>
  <verify>
Run `npm run build` - no type errors.
Unit test task-utils manually:
- buildTaskTree correctly nests tasks
- calculateProgress counts subtasks
- getDescendantIds returns all descendants
  </verify>
  <done>
TaskTagSelect UI component ready for integration. task-utils.ts provides tree building and progress calculation.
  </done>
</task>

</tasks>

<verification>
Run `npm run build && npm run lint` - no errors.

Check:
1. Tags API works via curl/API client
2. TaskTagSelect renders without errors (can test in isolation)
3. task-utils functions work correctly with sample data
</verification>

<success_criteria>
- TASK-08: Add tags to task - Partial (API ready, integration in Plan 03)
- Foundation for TASK-09: Tag inheritance ready in task-utils
- Foundation for TASK-11: Progress calculation ready in task-utils
</success_criteria>

<output>
After completion, create `.planning/phases/33-task-management/33-02-SUMMARY.md`
</output>
