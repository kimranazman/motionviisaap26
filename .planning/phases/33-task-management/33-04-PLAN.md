---
phase: 33-task-management
plan: 04
type: execute
wave: 2
depends_on: ["33-01"]
files_modified:
  - src/app/api/projects/[id]/tasks/[taskId]/comments/route.ts
  - src/components/projects/task-detail-sheet.tsx
  - src/components/projects/task-comments.tsx
  - src/components/projects/task-tree-node.tsx
autonomous: true
user_setup: []

must_haves:
  truths:
    - "User can add comment on task"
    - "User can view comments on task"
    - "Task detail sheet shows full task info with comments section"
  artifacts:
    - path: "src/app/api/projects/[id]/tasks/[taskId]/comments/route.ts"
      provides: "GET (list) and POST (create) endpoints for task comments"
      exports: ["GET", "POST"]
    - path: "src/components/projects/task-detail-sheet.tsx"
      provides: "Sheet for viewing/editing task details with comments"
      min_lines: 150
    - path: "src/components/projects/task-comments.tsx"
      provides: "Comments section component for tasks"
      min_lines: 80
  key_links:
    - from: "src/components/projects/task-detail-sheet.tsx"
      to: "/api/projects/[id]/tasks/[taskId]/comments"
      via: "fetch in TaskComments"
      pattern: "fetch.*tasks.*comments"
    - from: "src/components/projects/task-tree-node.tsx"
      to: "src/components/projects/task-detail-sheet.tsx"
      via: "onClick opens sheet"
      pattern: "TaskDetailSheet|setSelectedTask"
---

<objective>
Create task comments API and TaskDetailSheet for full task detail view with comments.

Purpose: Tasks have many fields and need a dedicated detail view rather than inline editing. Comments require their own section with user avatars and timestamps. Clicking a task in the tree should open a detail sheet.

Output: Task comments API, TaskDetailSheet component, TaskComments component, integration with TaskTreeNode.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/33-task-management/33-RESEARCH.md
@.planning/phases/33-task-management/33-01-SUMMARY.md

# Pattern references
@src/app/api/initiatives/[id]/comments/route.ts
@src/components/initiatives/initiative-detail.tsx
@src/components/projects/project-detail-sheet.tsx
@prisma/schema.prisma
</context>

<tasks>

<task type="auto">
  <name>Task 1: Task Comments API</name>
  <files>
    src/app/api/projects/[id]/tasks/[taskId]/comments/route.ts
  </files>
  <action>
Create Task Comments API following the Initiative Comments pattern.

**GET /api/projects/[id]/tasks/[taskId]/comments** (list):
- Require auth
- Verify task exists, return 404 if not
- Return comments ordered by createdAt DESC (newest first)
- Include user relation: { id, name, email, image }

**POST /api/projects/[id]/tasks/[taskId]/comments** (create):
- Require auth (any authenticated user can comment)
- Validate content is required, trim whitespace
- Get userId from session
- Create TaskComment with taskId, userId, content
- Return 201 with created comment including user

Use the pattern from @src/app/api/initiatives/[id]/comments/route.ts as reference.
  </action>
  <verify>
Run `npm run lint` - no errors.
Test with curl:
- GET returns empty array initially
- POST creates comment with user info
- Comments ordered newest first
  </verify>
  <done>
Task comments CRUD works. User info included in response.
  </done>
</task>

<task type="auto">
  <name>Task 2: TaskDetailSheet and TaskComments Components</name>
  <files>
    src/components/projects/task-detail-sheet.tsx
    src/components/projects/task-comments.tsx
    src/components/projects/task-tree-node.tsx
  </files>
  <action>
Create TaskDetailSheet and TaskComments, integrate with TaskTreeNode.

**TaskComments (src/components/projects/task-comments.tsx):**
Props:
- projectId: string
- taskId: string

Behavior:
- Fetch comments on mount from /api/projects/[id]/tasks/[taskId]/comments
- Display comments with:
  - User avatar (Avatar with AvatarFallback using initials)
  - User name
  - Comment content
  - Relative time (use formatDistanceToNow from date-fns)
- Add comment form at top:
  - Textarea for new comment
  - Send button (Send icon)
  - Loading state while submitting
- After submit, prepend new comment to list
- Empty state if no comments: "No comments yet"

Follow the comment section pattern from InitiativeDetail.

**TaskDetailSheet (src/components/projects/task-detail-sheet.tsx):**
Props:
- task: Task | null
- projectId: string
- open: boolean
- onOpenChange: (open: boolean) => void
- onTaskUpdate: () => void

Use Sheet (side: "right", size like ProjectDetailSheet).

Content:
- SheetHeader with task title (editable)
- Status select (TODO/IN_PROGRESS/DONE)
- Priority select (LOW/MEDIUM/HIGH)
- Due date picker
- Assignee select
- Description textarea (editable)
- Tags section with TaskTagSelect
- Separator
- Comments section with TaskComments

Save changes:
- Use controlled form fields
- "Save Changes" button if any field changed
- Call PATCH /api/projects/[id]/tasks/[taskId] on save
- Call onTaskUpdate after save

**TaskTreeNode integration:**
- Add onClick to task title/card area -> opens TaskDetailSheet
- Pass through selectedTask state from TaskTree
- Lift selectedTask state to TaskTree, pass down as props
- Or: Use a simpler approach - add onSelectTask callback, manage sheet in TaskTree

**Updated TaskTree:**
- Add selectedTask state
- Add TaskDetailSheet at bottom of component
- Pass onSelectTask to TaskTreeNode
- When task selected, open sheet with that task

**UI details:**
- Sheet width: "w-[400px] sm:w-[540px]" or similar
- Use the same form fields styling as TaskForm
- Comments section scrollable if many comments
  </action>
  <verify>
Run `npm run build` - no type errors.
Test in browser:
1. Click on a task in the tree -> TaskDetailSheet opens
2. Edit status/priority -> changes reflect
3. Click Save Changes -> API called, task updates
4. Type comment -> click Send -> comment appears
5. Close sheet -> reopen -> comment persists
  </verify>
  <done>
Full task detail sheet with editable fields and comments section. Click task in tree to open.
  </done>
</task>

</tasks>

<verification>
Run `npm run build && npm run lint` - no errors.

Full workflow test:
1. Open project with tasks
2. Click on a task row -> TaskDetailSheet opens
3. See all task details (title, status, priority, due date, assignee, description, tags)
4. Change status to IN_PROGRESS -> Save -> badge updates in tree
5. Add a comment "Testing comments"
6. Comment appears with your avatar and "just now"
7. Close sheet and reopen -> comment still there
8. Add another comment -> appears at top (newest first)
</verification>

<success_criteria>
- TASK-05: Add comment on task - DONE
- TASK-13: Edit task details - Enhanced (full detail sheet)
- All task fields editable in detail view
</success_criteria>

<output>
After completion, create `.planning/phases/33-task-management/33-04-SUMMARY.md`
</output>
