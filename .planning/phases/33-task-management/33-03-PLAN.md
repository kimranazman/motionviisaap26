---
phase: 33-task-management
plan: 03
type: execute
wave: 2
depends_on: ["33-01", "33-02"]
files_modified:
  - src/components/ui/collapsible.tsx
  - src/app/api/projects/[id]/tasks/[taskId]/tags/route.ts
  - src/app/api/projects/[id]/tasks/[taskId]/tags/[tagId]/route.ts
  - src/components/projects/task-tree.tsx
  - src/components/projects/task-tree-node.tsx
  - src/components/projects/project-detail-sheet.tsx
autonomous: true
user_setup: []

must_haves:
  truths:
    - "User can create subtask under existing task"
    - "Subtasks can be nested up to 5 levels deep"
    - "User can collapse/expand subtasks in tree view"
    - "Task shows progress indicator (X of Y subtasks complete)"
    - "User can add tags to task"
    - "Tags inherit to subtasks automatically when added"
  artifacts:
    - path: "src/components/ui/collapsible.tsx"
      provides: "shadcn Collapsible component"
      min_lines: 20
    - path: "src/components/projects/task-tree.tsx"
      provides: "Container for task tree with overall progress"
      min_lines: 80
    - path: "src/components/projects/task-tree-node.tsx"
      provides: "Recursive tree node with collapse/expand"
      min_lines: 100
    - path: "src/app/api/projects/[id]/tasks/[taskId]/tags/route.ts"
      provides: "POST endpoint to add tag to task"
      exports: ["POST"]
    - path: "src/app/api/projects/[id]/tasks/[taskId]/tags/[tagId]/route.ts"
      provides: "DELETE endpoint to remove tag from task"
      exports: ["DELETE"]
  key_links:
    - from: "src/components/projects/task-tree-node.tsx"
      to: "src/components/projects/task-tree-node.tsx"
      via: "recursive rendering"
      pattern: "TaskTreeNode.*TaskTreeNode"
    - from: "src/components/projects/task-tree.tsx"
      to: "src/lib/task-utils.ts"
      via: "buildTaskTree import"
      pattern: "import.*buildTaskTree.*task-utils"
---

<objective>
Build the task tree view with hierarchy, collapse/expand, progress indicators, and tag management.

Purpose: Transform the flat task list into an interactive tree view where users can visualize subtask nesting, expand/collapse branches, see progress at a glance, and manage tags with inheritance.

Output: Collapsible component, TaskTree/TaskTreeNode, task tag APIs, integrated into ProjectDetailSheet.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/33-task-management/33-RESEARCH.md
@.planning/phases/33-task-management/33-01-SUMMARY.md
@.planning/phases/33-task-management/33-02-SUMMARY.md

# Pattern references
@src/lib/task-utils.ts
@src/components/projects/task-card.tsx
@prisma/schema.prisma
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Collapsible and Create Task Tag APIs</name>
  <files>
    src/components/ui/collapsible.tsx
    src/app/api/projects/[id]/tasks/[taskId]/tags/route.ts
    src/app/api/projects/[id]/tasks/[taskId]/tags/[tagId]/route.ts
  </files>
  <action>
Install shadcn Collapsible component and create task tag management APIs.

**Install Collapsible:**
```bash
npx shadcn@latest add collapsible
```
This creates `src/components/ui/collapsible.tsx` with Collapsible, CollapsibleTrigger, CollapsibleContent.

**POST /api/projects/[id]/tasks/[taskId]/tags** (add tag):
- Require editor role
- Body: { tagId: string }
- Verify task exists, return 404 if not
- Verify tag exists, return 404 if not
- Get all descendant task IDs using getDescendantIds from task-utils
- In transaction:
  - Create TaskTag for the task with inherited: false
  - Create TaskTag for each descendant with inherited: true (upsert to handle existing)
- Return 201 with created TaskTag

**DELETE /api/projects/[id]/tasks/[taskId]/tags/[tagId]** (remove tag):
- Require editor role
- Verify task exists
- Check if TaskTag exists and is NOT inherited, return 400 "Cannot remove inherited tag" if inherited
- Get all descendant task IDs
- In transaction:
  - Delete TaskTag from task
  - Delete TaskTag from all descendants where inherited: true
- Return 204

Import getDescendantIds from @/lib/task-utils.

Use the tag inheritance pattern from RESEARCH.md.
  </action>
  <verify>
Run `npm run lint` - no errors.
Check Collapsible component exists at src/components/ui/collapsible.tsx.
Test tag APIs:
- Add tag to task -> tag appears on task and subtasks
- Remove tag -> removed from task and subtasks
- Cannot remove inherited tag directly
  </verify>
  <done>
Collapsible installed. Tag add/remove with inheritance propagation works.
  </done>
</task>

<task type="auto">
  <name>Task 2: TaskTree and TaskTreeNode Components</name>
  <files>
    src/components/projects/task-tree.tsx
    src/components/projects/task-tree-node.tsx
    src/components/projects/project-detail-sheet.tsx
  </files>
  <action>
Create recursive tree components and replace flat list in ProjectDetailSheet.

**TaskTree (src/components/projects/task-tree.tsx):**
Props:
- projectId: string
- tasks: Task[] (flat list from API)
- onTasksChange: () => void

Behavior:
- Use useMemo with buildTaskTree(tasks) to construct tree
- Store expandedIds as Set<string> in state (start with all IDs expanded)
- toggleExpanded function adds/removes from Set
- Calculate overall progress: totalTasks/completedTasks from flat list
- Render:
  - Header with "Tasks" label + overall progress badge (e.g., "3/5")
  - "Add Task" button (root level)
  - Empty state if no tasks (ListTodo icon + "Add your first task")
  - Map over tree roots, render TaskTreeNode for each
- Pass expandedIds and toggleExpanded down to nodes
- Add root-level TaskForm when adding (no parentId)

**TaskTreeNode (src/components/projects/task-tree-node.tsx):**
Props:
- task: TaskWithChildren
- projectId: string
- level: number (for indentation, starting at 0)
- expandedIds: Set<string>
- onToggleExpanded: (taskId: string) => void
- onTaskUpdate: () => void

Behavior:
- Indentation: marginLeft = level * 24px (or use pl-6 Tailwind per level)
- Use Collapsible component for expand/collapse
- Render row with:
  - Expand/collapse button (ChevronRight/ChevronDown) if hasChildren
  - Spacer (w-6) if no children (for alignment)
  - Task content: title, status badge, priority badge, due date, assignee, tags
  - Progress indicator if hasChildren: "X/Y" badge showing completed/total subtasks
  - Comment count badge if comments > 0
  - Actions: Add Subtask button (if level < 4), Edit, Delete
- CollapsibleContent renders children recursively: map task.children -> TaskTreeNode
- "Add Subtask" shows TaskForm with parentId set (inline below the task or in a small form area)

**Key patterns:**
- Use calculateProgress from task-utils for subtask progress
- canAddSubtask = level < 4 (allows 5 levels: 0,1,2,3,4)
- Recursive render: TaskTreeNode renders TaskTreeNode for children
- Keep collapse state in parent (TaskTree) to preserve across data refreshes

**ProjectDetailSheet update:**
- Replace flat task list with TaskTree component
- Pass tasks, projectId, onTasksChange to TaskTree
- Remove individual TaskCard rendering (now inside tree)
- Remove TaskForm from sheet (now inside TaskTree)

**UI details:**
- Status badges: TODO (gray bg), IN_PROGRESS (blue bg), DONE (green bg)
- Priority badges: LOW (gray text), MEDIUM (yellow/amber), HIGH (red)
- Tag badges: use tag.color as background with white text
- Inherited tags show slightly faded (opacity-75)
- Progress badge: secondary variant with "3/5" text

Include TaskTagSelect in the task row for tag management. When tags change, call onTaskUpdate.
  </action>
  <verify>
Run `npm run build` - no type errors.
Test in browser:
1. Open project with tasks
2. Create task at root level
3. Click "Add Subtask" on a task -> subtask appears nested
4. Repeat to 5 levels -> 6th level "Add Subtask" button not shown
5. Click collapse chevron -> subtasks hidden
6. Click expand -> subtasks shown
7. Complete subtask -> parent progress updates
8. Add tag to parent -> tag appears on subtasks with inherited indicator
  </verify>
  <done>
Full tree view with collapse/expand, nesting up to 5 levels, progress indicators, and tag inheritance.
  </done>
</task>

</tasks>

<verification>
Run `npm run build && npm run lint` - no errors.

Full workflow test:
1. Open project detail
2. Create root task
3. Add subtask to root task
4. Add another level of subtask (3 deep)
5. Collapse the root -> all nested hidden
6. Expand -> all visible again
7. Mark deepest subtask as DONE -> progress shows 1/2 on parent
8. Add tag to middle task -> tag inherits to children
9. Try to remove inherited tag from child -> blocked
10. Remove tag from middle task -> removed from children too
</verification>

<success_criteria>
- TASK-06: Create subtask under existing task - DONE
- TASK-07: Subtasks nested up to 5 levels - DONE
- TASK-08: Add tags to task - DONE
- TASK-09: Tags inherit to subtasks - DONE
- TASK-11: Progress indicator - DONE
- TASK-12: Collapse/expand subtasks - DONE
</success_criteria>

<output>
After completion, create `.planning/phases/33-task-management/33-03-SUMMARY.md`
</output>
