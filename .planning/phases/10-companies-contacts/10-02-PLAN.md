---
phase: 10-companies-contacts
plan: 02
type: execute
wave: 2
depends_on: ["10-01"]
files_modified:
  - src/app/api/companies/[id]/contacts/route.ts
  - src/app/api/companies/[id]/contacts/[contactId]/route.ts
  - src/components/companies/contact-card.tsx
  - src/components/companies/contact-form.tsx
  - src/components/companies/company-detail-modal.tsx
autonomous: true

must_haves:
  truths:
    - "User can see contacts listed as cards within company modal"
    - "User can add a new contact to a company"
    - "User can edit contact details inline"
    - "User can delete a contact with confirmation"
    - "User can mark one contact as primary"
    - "Primary contact is visually distinguished and listed first"
    - "Empty company shows 'Add your first contact' prompt"
  artifacts:
    - path: "src/app/api/companies/[id]/contacts/route.ts"
      provides: "GET list and POST create contact endpoints"
      exports: ["GET", "POST"]
    - path: "src/app/api/companies/[id]/contacts/[contactId]/route.ts"
      provides: "PATCH update and DELETE contact endpoints"
      exports: ["PATCH", "DELETE"]
    - path: "src/components/companies/contact-card.tsx"
      provides: "Contact card with inline editing"
      min_lines: 60
    - path: "src/components/companies/contact-form.tsx"
      provides: "Add contact form"
      min_lines: 40
    - path: "src/components/companies/company-detail-modal.tsx"
      provides: "Modal updated with contacts section"
      contains: "ContactCard|contact-card"
  key_links:
    - from: "src/components/companies/company-detail-modal.tsx"
      to: "/api/companies/[id]/contacts"
      via: "POST to create contact"
      pattern: "fetch.*contacts.*POST"
    - from: "src/components/companies/contact-card.tsx"
      to: "/api/companies/[id]/contacts/[contactId]"
      via: "PATCH on edit, DELETE on remove"
      pattern: "fetch.*contacts.*PATCH|DELETE"
---

<objective>
Implement contact management within company modal - display contacts as cards, CRUD operations, primary contact designation.

Purpose: Enable users to manage contacts in the context of their company
Output: Contacts shown as cards in company modal with inline editing, add/delete, and primary designation
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/10-companies-contacts/10-CONTEXT.md
@.planning/phases/10-companies-contacts/10-RESEARCH.md
@.planning/phases/10-companies-contacts/10-01-SUMMARY.md

@prisma/schema.prisma
@src/components/companies/company-detail-modal.tsx
@src/components/companies/company-inline-field.tsx
@src/app/api/companies/[id]/route.ts
@src/components/admin/delete-user-button.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create contact API routes</name>
  <files>
    src/app/api/companies/[id]/contacts/route.ts
    src/app/api/companies/[id]/contacts/[contactId]/route.ts
  </files>
  <action>
1. Create src/app/api/companies/[id]/contacts/route.ts:
   - GET: List contacts for company, order by isPrimary desc, name asc
   - POST: Create contact with name (required), email, phone, role
     * Validate companyId exists first
     * If no contacts exist yet, auto-set isPrimary true
   - Use requireAuth for GET, requireEditor for POST
   - Return 404 if company not found

2. Create src/app/api/companies/[id]/contacts/[contactId]/route.ts:
   - PATCH: Partial update (name, email, phone, role, isPrimary)
     * If setting isPrimary=true, use transaction to unset isPrimary on all other contacts for this company first
     * Then set isPrimary=true on this contact
   - DELETE: Remove contact
     * If deleting the primary contact, set isPrimary on next contact (by name order) if any remain
   - Use requireEditor for both
   - Return 404 if contact not found

Follow patterns from:
- src/app/api/initiatives/[id]/route.ts for structure
- 10-RESEARCH.md for isPrimary transaction pattern
  </action>
  <verify>
- POST /api/companies/[id]/contacts with {name: "Test"} creates contact
- First contact auto-gets isPrimary=true
- PATCH with isPrimary=true updates correctly (old primary unset)
- DELETE removes contact
- If deleting primary, next contact becomes primary
  </verify>
  <done>
Contact API routes working: create, update (including isPrimary toggle), delete with primary reassignment.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create contact card and form components</name>
  <files>
    src/components/companies/contact-card.tsx
    src/components/companies/contact-form.tsx
  </files>
  <action>
1. Create src/components/companies/contact-card.tsx:
   - Props: contact, companyId, onUpdate, onDelete
   - Card layout showing: name (larger), role, email, phone
   - Primary badge next to name if isPrimary
   - Each field inline editable (use InlineEditField pattern)
   - Star icon button to set as primary (filled if primary, outline if not)
     * On click: PATCH with isPrimary=true, call onUpdate
   - Trash icon button in corner (smaller, red on hover)
     * Uses AlertDialog for confirmation
     * On confirm: DELETE, call onDelete
   - Visual distinction for primary: subtle border color or background tint

2. Create src/components/companies/contact-form.tsx:
   - Props: companyId, onSuccess, onCancel
   - Simple form with fields: name (required), email, phone, role
   - "Add Contact" and "Cancel" buttons
   - On submit: POST to /api/companies/[id]/contacts
   - Clear form and call onSuccess on success
   - Show validation error if name empty
   - Use Input components, not inline edit (this is a create form)
  </action>
  <verify>
- ContactCard renders with all fields visible
- Clicking star sets contact as primary
- Editing field and blurring saves change
- Delete shows confirmation, removes card on confirm
- ContactForm submits new contact successfully
  </verify>
  <done>
Contact card shows all info with inline editing, primary toggle, delete. Form creates new contacts.
  </done>
</task>

<task type="auto">
  <name>Task 3: Integrate contacts into company detail modal</name>
  <files>
    src/components/companies/company-detail-modal.tsx
  </files>
  <action>
1. Update src/components/companies/company-detail-modal.tsx:
   - Replace placeholder "Contacts will be added in the next plan" with actual contacts section
   - After Separator, add section:
     * Header row: "Contacts" heading + "Add Contact" button (Plus icon)
     * If no contacts: Empty state card with message "No contacts yet" and "Add your first contact" button
     * If contacts: Grid/list of ContactCard components
   - State for showAddForm (boolean)
   - When "Add Contact" clicked, toggle showAddForm
   - If showAddForm, render ContactForm above contact list
   - ContactForm onSuccess: refetch company data, hide form
   - ContactForm onCancel: hide form
   - ContactCard onUpdate: refetch company data
   - ContactCard onDelete: refetch company data
   - Contacts already come from the company fetch (via include: contacts)
  </action>
  <verify>
- Company modal shows "Contacts" section with contact count
- Empty company shows "Add your first contact" prompt
- Click "Add Contact" shows inline form
- Submit form adds contact, card appears
- Edit contact field in card, blur, value persists
- Click star to set primary, badge moves to that contact
- Delete contact removes card from list
- Primary contact always listed first
  </verify>
  <done>
Company modal shows contacts as cards with full CRUD, primary designation, and empty state.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. API verification:
   - GET /api/companies/[id]/contacts returns contacts ordered by isPrimary, name
   - POST creates contact, first contact auto-primary
   - PATCH updates fields, isPrimary toggle works correctly
   - DELETE removes contact, reassigns primary if needed

2. UI verification:
   - Open company modal with no contacts: sees "Add your first contact"
   - Click add: form appears
   - Submit: contact card appears
   - Card shows name, role, email, phone
   - First contact has primary badge
   - Edit any field on card, blur: persists
   - Click star on non-primary: becomes primary, old primary loses badge
   - Delete contact: confirmation, then removed
   - Add second contact: appears in list
   - Delete primary: next contact becomes primary

3. Requirements coverage:
   - CONT-01: Add contact to company - WORKING
   - CONT-02: View contacts for company - WORKING
   - CONT-03: Edit contact details - WORKING
   - CONT-04: Delete contact - WORKING
</verification>

<success_criteria>
- CONT-01: User can add contact to a company - WORKING
- CONT-02: User can view contacts for a company - WORKING (cards in modal)
- CONT-03: User can edit contact details - WORKING (inline on cards)
- CONT-04: User can delete contact - WORKING (with confirmation)
- Primary contact designation works (star toggle)
- Empty state prompts user to add first contact
- Contacts displayed as cards per CONTEXT.md decision
- Contact fields: name, role, email, phone per requirements
</success_criteria>

<output>
After completion, create `.planning/phases/10-companies-contacts/10-02-SUMMARY.md`
</output>
