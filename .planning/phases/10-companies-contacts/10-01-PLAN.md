---
phase: 10-companies-contacts
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - prisma/schema.prisma
  - src/app/(dashboard)/companies/page.tsx
  - src/app/api/companies/route.ts
  - src/app/api/companies/[id]/route.ts
  - src/components/companies/company-list.tsx
  - src/components/companies/company-detail-modal.tsx
  - src/components/companies/company-inline-field.tsx
  - src/components/companies/industry-combobox.tsx
  - src/components/layout/sidebar.tsx
  - src/lib/industry-presets.ts
autonomous: true

must_haves:
  truths:
    - "User can see list of all companies in table view"
    - "User can search companies by name"
    - "User can filter companies by industry"
    - "User can create a new company"
    - "User can click company row to open detail modal"
    - "User can edit company fields inline (auto-save on blur)"
    - "User can delete company with confirmation dialog"
  artifacts:
    - path: "prisma/schema.prisma"
      provides: "Company model with website, address, phone fields; Contact model with isPrimary field"
      contains: "website.*VarChar|isPrimary.*Boolean"
    - path: "src/app/(dashboard)/companies/page.tsx"
      provides: "Companies page server component"
      exports: ["default"]
    - path: "src/app/api/companies/route.ts"
      provides: "GET list and POST create endpoints"
      exports: ["GET", "POST"]
    - path: "src/app/api/companies/[id]/route.ts"
      provides: "GET one, PATCH update, DELETE endpoints"
      exports: ["GET", "PATCH", "DELETE"]
    - path: "src/components/companies/company-list.tsx"
      provides: "Table with search, filter, create button"
      min_lines: 100
    - path: "src/components/companies/company-detail-modal.tsx"
      provides: "Modal with inline editing for company fields"
      min_lines: 80
    - path: "src/components/companies/company-inline-field.tsx"
      provides: "Reusable inline edit component with blur save"
      min_lines: 40
  key_links:
    - from: "src/components/companies/company-list.tsx"
      to: "/api/companies"
      via: "fetch on filter/search change"
      pattern: "fetch.*api/companies"
    - from: "src/components/companies/company-detail-modal.tsx"
      to: "/api/companies/[id]"
      via: "PATCH on blur"
      pattern: "fetch.*PATCH"
    - from: "src/components/layout/sidebar.tsx"
      to: "/companies"
      via: "navigation link"
      pattern: "href.*companies"
---

<objective>
Implement company management with list page, search/filter, and inline-editable detail modal.

Purpose: Enable users to manage client companies with a modern inline-editing experience
Output: Company list page with table, filters, create dialog, and detail modal with auto-save
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/10-companies-contacts/10-CONTEXT.md
@.planning/phases/10-companies-contacts/10-RESEARCH.md

@prisma/schema.prisma
@src/components/initiatives/initiatives-list.tsx
@src/app/api/initiatives/[id]/route.ts
@src/components/admin/delete-user-button.tsx
@src/components/ui/dialog.tsx
@src/components/layout/sidebar.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend schema and add shadcn components</name>
  <files>
    prisma/schema.prisma
    (run shadcn add command for command, skeleton)
  </files>
  <action>
1. Update prisma/schema.prisma - Add fields to Company model:
   - website: String? @db.VarChar(255)
   - address: String? @db.Text
   - phone: String? @db.VarChar(50)

2. Update Contact model - Add isPrimary field:
   - isPrimary: Boolean @default(false) @map("is_primary")

3. Run `pnpm dlx shadcn@latest add command skeleton` to add Command (for combobox) and Skeleton components

4. Run `npx prisma db push` to apply schema changes

Note: Use db push (not migrate) since we're in development and just adding nullable fields.
  </action>
  <verify>
- `npx prisma validate` passes
- `npx prisma db push` applies without errors
- Command and Skeleton components exist in src/components/ui/
  </verify>
  <done>
Schema extended with website/address/phone on Company and isPrimary on Contact. UI components installed.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create company API routes and list page</name>
  <files>
    src/lib/industry-presets.ts
    src/app/api/companies/route.ts
    src/app/api/companies/[id]/route.ts
    src/app/(dashboard)/companies/page.tsx
    src/components/companies/company-list.tsx
    src/components/layout/sidebar.tsx
  </files>
  <action>
1. Create src/lib/industry-presets.ts:
   - Export INDUSTRY_PRESETS array: ['Technology', 'Healthcare', 'Finance', 'Manufacturing', 'Retail', 'Education', 'Government', 'Media', 'Energy', 'Other']

2. Create src/app/api/companies/route.ts:
   - GET: List all companies with _count of contacts, optional search (name contains) and industry filter via query params
   - POST: Create company with name (required), industry, notes (COMP-01)
   - Use requireAuth for GET, requireEditor for POST
   - Follow existing pattern from initiatives/route.ts

3. Create src/app/api/companies/[id]/route.ts:
   - GET: Single company with contacts included (order by isPrimary desc, name asc)
   - PATCH: Partial update (name, industry, website, address, phone, notes)
   - DELETE: Check for linked deals/projects/potentials first, return 400 if any exist, else delete
   - Use requireAuth for GET, requireEditor for PATCH/DELETE
   - Follow pattern from initiatives/[id]/route.ts

4. Create src/app/(dashboard)/companies/page.tsx:
   - Server component that fetches companies list
   - Pass to CompanyList client component
   - Accept searchParams for search and industry filter

5. Create src/components/companies/company-list.tsx:
   - Client component with table (follow initiatives-list.tsx pattern)
   - Columns: Name, Industry, Contacts (count), Added (createdAt)
   - Search input filtering by name
   - Industry filter dropdown (use Select with "All Industries" + INDUSTRY_PRESETS)
   - "Add Company" button opens Dialog with simple form (name, industry via Select, notes via Textarea)
   - Click row to select (store selectedCompanyId state)
   - When selectedCompanyId set, open CompanyDetailModal (implement in next task)
   - Empty state: "No companies yet. Add your first company."

6. Update src/components/layout/sidebar.tsx:
   - Add "Companies" link under a new "CRM" section heading
   - Use Building2 icon from lucide-react
   - Position after existing navigation, before Admin section
  </action>
  <verify>
- `curl http://localhost:3000/api/companies` returns empty array []
- Navigate to /companies shows empty state message
- Creating a company via the form adds it to the table
- Search filters the list by name
- Industry filter works correctly
- "Companies" appears in sidebar navigation
  </verify>
  <done>
Company list page shows table with search/filter, can create companies, sidebar has Companies link.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create company detail modal with inline editing</name>
  <files>
    src/components/companies/company-inline-field.tsx
    src/components/companies/industry-combobox.tsx
    src/components/companies/company-detail-modal.tsx
    src/components/companies/company-list.tsx (update)
  </files>
  <action>
1. Create src/components/companies/company-inline-field.tsx:
   - Reusable inline edit component for text fields
   - Props: value, onSave, placeholder, multiline (for textarea)
   - Shows transparent input, gains border/ring on focus
   - On blur or Enter: if value changed, call onSave(newValue)
   - On Escape: revert to original value and blur
   - Show subtle loading state during save (use isPending pattern)
   - Handle save error by reverting value
   - CSS: bg-transparent, border-0, focus:border, hover:bg-muted/50, rounded px-2 py-1

2. Create src/components/companies/industry-combobox.tsx:
   - Combobox using Popover + Command components
   - Props: value, onValueChange
   - Allows selecting from INDUSTRY_PRESETS OR typing custom value
   - Shows "Use [custom value]" option when no preset matches
   - On select/custom: call onValueChange and close popover
   - See pattern from 10-RESEARCH.md

3. Create src/components/companies/company-detail-modal.tsx:
   - Props: companyId (string | null), open, onOpenChange
   - Fetch company from /api/companies/[id] when companyId changes
   - Show Skeleton loader while loading
   - Layout:
     * DialogHeader with inline-editable company name (larger font)
     * Grid of fields: Industry (combobox), Website, Phone, Address (inputs)
     * Notes section (multiline inline field)
     * Separator
     * Contacts section: placeholder text "Contacts will be added in the next plan"
   - Each field uses InlineEditField (or IndustryCombobox)
   - onSave calls PATCH /api/companies/[id] with changed field
   - DialogFooter with Delete button (red, uses AlertDialog for confirmation)
   - Delete calls DELETE /api/companies/[id], on success close modal and refresh list

4. Update src/components/companies/company-list.tsx:
   - Add CompanyDetailModal component at bottom of return
   - Pass selectedCompanyId, open state, and onOpenChange handler
   - When modal closes, clear selectedCompanyId
   - On successful delete, refetch companies list
  </action>
  <verify>
- Click company row opens detail modal
- Company name shown in modal header, editable inline
- Edit any field (name, industry, website, phone, address, notes) and blur - value persists after refresh
- Industry combobox shows presets AND allows custom value
- Delete button shows confirmation dialog
- Confirm delete removes company, closes modal, updates list
  </verify>
  <done>
Company detail modal opens on row click, all fields inline-editable with auto-save, delete with confirmation.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. Schema verification:
   - `npx prisma validate` passes
   - Company has website, address, phone fields
   - Contact has isPrimary field

2. API verification:
   - GET /api/companies returns list with contact counts
   - POST /api/companies creates company
   - GET /api/companies/[id] returns company with contacts
   - PATCH /api/companies/[id] updates specific fields
   - DELETE /api/companies/[id] removes company (after checking links)

3. UI verification:
   - /companies page loads with table view
   - Search filters by name
   - Industry filter works
   - "Add Company" creates new company
   - Click row opens modal
   - All fields editable inline
   - Changes persist after modal close/reopen
   - Delete with confirmation works
   - Sidebar shows "Companies" under CRM section
</verification>

<success_criteria>
- COMP-01: User can create company with name, industry, notes - WORKING
- COMP-02: User can view list of all companies - WORKING
- COMP-03: User can edit company details - WORKING (inline in modal)
- COMP-04: User can delete company with confirmation - WORKING
- All fields from CONTEXT.md implemented: name, industry, website, address, phone, notes
- Inline editing pattern feels immediate (no save button needed)
- Skeleton loading while fetching company details
</success_criteria>

<output>
After completion, create `.planning/phases/10-companies-contacts/10-01-SUMMARY.md`
</output>
