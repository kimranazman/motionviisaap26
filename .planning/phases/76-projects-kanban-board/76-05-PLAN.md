# Plan 76-05: Update Projects Page with Enhanced Data

```yaml
wave: 4
depends_on:
  - 76-04
files_modified:
  - src/app/(dashboard)/projects/page.tsx
autonomous: true
```

## Objective

Update the projects page to fetch enhanced data (task counts, cost totals) and render the new client component.

## Tasks

<task id="1">
Read and modify `src/app/(dashboard)/projects/page.tsx`:

Add queries for task counts and cost totals:
```typescript
// Get task counts per project
const taskCounts = await prisma.task.groupBy({
  by: ['projectId'],
  _count: { id: true },
  where: { parentId: null }, // Only top-level tasks
})

// Get completed task counts per project
const taskDoneCounts = await prisma.task.groupBy({
  by: ['projectId'],
  _count: { id: true },
  where: { parentId: null, status: 'DONE' },
})

// Get cost totals per project
const costTotals = await prisma.cost.groupBy({
  by: ['projectId'],
  _sum: { amount: true },
})
```
</task>

<task id="2">
Create lookup maps for efficient merging:
```typescript
const taskCountMap = new Map(taskCounts.map(t => [t.projectId, t._count.id]))
const taskDoneCountMap = new Map(taskDoneCounts.map(t => [t.projectId, t._count.id]))
const costTotalMap = new Map(costTotals.map(c => [c.projectId, Number(c._sum.amount || 0)]))
```
</task>

<task id="3">
Update serializedProjects to include new fields:
```typescript
const serializedProjects = projects.map((project) => ({
  ...project,
  revenue: project.revenue ? Number(project.revenue) : null,
  potentialRevenue: project.potentialRevenue ? Number(project.potentialRevenue) : null,
  startDate: project.startDate ? project.startDate.toISOString() : null,
  endDate: project.endDate ? project.endDate.toISOString() : null,
  // NEW: Task counts
  taskCount: taskCountMap.get(project.id) || 0,
  taskDoneCount: taskDoneCountMap.get(project.id) || 0,
  // NEW: Total cost
  totalCost: costTotalMap.get(project.id) || 0,
  sourceDeal: project.sourceDeal
    ? {
        ...project.sourceDeal,
        stageChangedAt: project.sourceDeal.stageChangedAt
          ? project.sourceDeal.stageChangedAt.toISOString()
          : undefined,
      }
    : null,
}))
```
</task>

<task id="4">
Update import and render to use new client component:
```typescript
import { ProjectsPageClient } from '@/components/projects/projects-page-client'

// In return:
return (
  <div className="flex flex-col h-screen">
    <Header
      title="Projects"
      description="Manage active projects and track deliverables"
    />
    <main className="flex-1 overflow-auto p-6">
      <ProjectsPageClient
        initialData={serializedProjects}
        initialShowArchived={showArchived === 'true'}
        openProjectId={open}
      />
    </main>
  </div>
)
```
</task>

<task id="5">
Run all queries in parallel using Promise.all:
```typescript
const [projects, taskCounts, taskDoneCounts, costTotals] = await Promise.all([
  prisma.project.findMany({ /* existing query */ }),
  prisma.task.groupBy({ /* task count query */ }),
  prisma.task.groupBy({ /* done count query */ }),
  prisma.cost.groupBy({ /* cost total query */ }),
])
```
</task>

## Verification

```bash
# Has new imports
grep "ProjectsPageClient" src/app/\(dashboard\)/projects/page.tsx

# Has task count queries
grep "task.groupBy" src/app/\(dashboard\)/projects/page.tsx

# Has cost total query
grep "cost.groupBy" src/app/\(dashboard\)/projects/page.tsx

# Has new fields in serialization
grep "taskCount\|taskDoneCount\|totalCost" src/app/\(dashboard\)/projects/page.tsx

# Uses Promise.all for parallel queries
grep "Promise.all" src/app/\(dashboard\)/projects/page.tsx

# Renders new client
grep "ProjectsPageClient" src/app/\(dashboard\)/projects/page.tsx
```

## must_haves

- [ ] Fetches task counts per project (total and done)
- [ ] Fetches cost totals per project
- [ ] Queries run in parallel with Promise.all
- [ ] Serialized data includes taskCount, taskDoneCount, totalCost
- [ ] Renders ProjectsPageClient instead of ProjectList directly
- [ ] Passes initialShowArchived and openProjectId props
