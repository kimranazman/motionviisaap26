# Plan 66-02: Sidebar Filtering + Settings UI

## Frontmatter
- **Phase:** 66 — Customizable Sidebar Navigation
- **Plan:** 02 of 02
- **Wave:** 2 (depends on 66-01)
- **Depends on:** 66-01
- **Autonomous:** yes
- **Files modified:**
  - `src/components/layout/sidebar.tsx`
  - `src/components/layout/mobile-sidebar.tsx`
  - `src/components/layout/nav-group.tsx`
  - `src/app/(dashboard)/settings/page.tsx`

## Objective

Wire the nav visibility hook into both sidebars to filter out hidden items, add auto-reveal on navigation, and build the Settings UI for toggling sidebar items on/off.

## Tasks

<task id="01">
**Filter sidebar items by visibility**

In `src/components/layout/sidebar.tsx`:

1. Import `useNavVisibility` from `@/lib/hooks/use-nav-visibility`
2. Call `const { isVisible, autoReveal } = useNavVisibility()`
3. Call `autoReveal(pathname)` in a `useEffect` that runs when pathname changes. This handles NAV-04 (auto-reveal on direct URL navigation).
4. For nav groups: filter each group's items to only those where `isVisible(item.href)` is true. If a group has zero visible items after filtering, hide the entire group (don't render the NavGroupComponent).
5. For top-level items: filter `topLevelItems` to only visible ones.
6. Settings item is always rendered (it's always-visible).

**Important:** During loading (before preferences are fetched), show ALL items to avoid a flash of missing items. The hook's `isLoading` state controls this — when `isLoading` is true, `isVisible()` should return true for everything.

**Verify:** When no items are hidden, sidebar renders identically to before. When "/timeline" is hidden, the Timeline link does not appear. Navigating to /timeline directly causes the item to auto-reveal.
</task>

<task id="02">
**Filter mobile sidebar items by visibility**

In `src/components/layout/mobile-sidebar.tsx`:

Apply the same filtering logic as task 01:

1. Import `useNavVisibility`
2. Call `const { isVisible } = useNavVisibility()` (no need for autoReveal here — the desktop sidebar handles it)
3. Filter group items and top-level items by `isVisible(item.href)`
4. Hide empty groups

The MobileNav (bottom tab bar) is NOT affected — it has hardcoded items and stays unchanged.

**Verify:** Hidden items don't appear in mobile sidebar sheet. MobileNav bottom bar is unchanged.
</task>

<task id="03">
**Update NavGroupComponent to show filtered count**

In `src/components/layout/nav-group.tsx`:

Currently the group header shows `{group.label} ({group.items.length})`. After filtering, the count should reflect visible items, not total items.

Add an optional prop `visibleCount?: number` to NavGroupProps. When provided, display `({visibleCount})` instead of `({group.items.length})`.

The parent (sidebar.tsx and mobile-sidebar.tsx) passes this after computing filtered items.

**Verify:** Group header count matches the number of visible items shown.
</task>

<task id="04">
**Build Settings page sidebar customization section**

In `src/app/(dashboard)/settings/page.tsx`:

Add a new Card section below the existing "Detail View Mode" card:

**"Sidebar Navigation" Card:**

1. Title: "Sidebar Navigation"
2. Description: "Choose which items to show in the sidebar. Dashboard and Settings are always visible."
3. Import `useNavVisibility` and `navGroups`, `topLevelItems`, `isAlwaysVisible` from nav-config
4. Render each nav group as a labeled section:
   - Group label as a sub-heading (e.g., "SAAP", "CRM")
   - Each item as a row with: icon, name, and a Switch toggle (on = visible, off = hidden)
   - Dashboard and Settings rows show the switch as always-on and disabled
5. Render top-level items (Tasks, Members) under a "General" sub-heading with the same toggle pattern
6. When a switch is toggled, call `toggleItem(href)` from the hook

**UI specifics:**
- Use the Switch component from `@/components/ui/switch` (shadcn)
- Each row: `flex items-center justify-between py-2`
- Icon + name on left: `flex items-center gap-3`
- Switch on right
- Disabled switches for always-visible items should appear grayed out with a tooltip or subtle "(always visible)" text
- Show loading skeleton while `isLoading` (same height placeholder)

**Verify:** Settings page shows all nav items grouped correctly. Toggling an item off immediately hides it from the sidebar. Refreshing the page preserves the toggle state. Dashboard and Settings toggles are always on and disabled.
</task>

## must_haves
- [ ] Hidden nav items do not appear in the desktop sidebar
- [ ] Hidden nav items do not appear in the mobile sidebar sheet
- [ ] Navigating directly to a hidden item's URL auto-reveals it in the sidebar (NAV-04)
- [ ] Settings page shows toggles for all nav items grouped by section
- [ ] Dashboard and Settings cannot be toggled off (always visible, disabled switch)
- [ ] Toggle state persists across page refreshes (database-backed)
- [ ] Group headers show correct count of visible items
- [ ] No flash of missing items on initial page load (show all during loading)
