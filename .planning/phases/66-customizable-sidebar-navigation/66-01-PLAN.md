# Plan 66-01: Schema + API + Nav Visibility Hook

## Frontmatter
- **Phase:** 66 — Customizable Sidebar Navigation
- **Plan:** 01 of 02
- **Wave:** 1 (no dependencies)
- **Autonomous:** yes
- **Files modified:**
  - `prisma/schema.prisma`
  - `src/app/api/user/preferences/route.ts`
  - `src/lib/hooks/use-nav-visibility.ts` (NEW)
  - `src/lib/nav-config.ts`

## Objective

Add the `hiddenNavItems` field to UserPreferences, update the preferences API to read/write it, add a helper to nav-config for always-visible items, and create a React hook that manages nav visibility state with auto-reveal support.

## Tasks

<task id="01">
**Add hiddenNavItems to UserPreferences schema**

In `prisma/schema.prisma`, add to the UserPreferences model:

```prisma
hiddenNavItems Json? @map("hidden_nav_items") @db.Json
```

Add it after the `detailViewMode` field. This stores an array of href strings for hidden nav items (e.g., `["/timeline", "/kanban"]`).

Then run `npx prisma db push` to sync.

**Verify:** `npx prisma db push` succeeds without errors.
</task>

<task id="02">
**Add always-visible config to nav-config.ts**

In `src/lib/nav-config.ts`, add:

1. An exported constant `ALWAYS_VISIBLE_HREFS` — a `Set<string>` containing `'/'` (Dashboard) and `'/settings'` (Settings). These can never be hidden.

2. An exported helper function `getAllNavHrefs(): string[]` that returns all href values from navGroups items, topLevelItems, and settingsItem. This is used by the Settings UI to enumerate all toggleable items.

3. An exported helper function `isAlwaysVisible(href: string): boolean` that returns true if the href is in `ALWAYS_VISIBLE_HREFS`.

**Verify:** The exports compile without errors. `ALWAYS_VISIBLE_HREFS` contains exactly `'/'` and `'/settings'`.
</task>

<task id="03">
**Update preferences API to handle hiddenNavItems**

In `src/app/api/user/preferences/route.ts`:

1. In the `GET` handler, add `hiddenNavItems` to the response:
   ```ts
   hiddenNavItems: prefs?.hiddenNavItems ?? [],
   ```

2. In the `PATCH` handler, accept `hiddenNavItems` from the request body:
   ```ts
   const { dashboardLayout, dateFilter, detailViewMode, hiddenNavItems } = body as {
     dashboardLayout?: DashboardLayout
     dateFilter?: DateFilter
     detailViewMode?: string
     hiddenNavItems?: string[]
   }
   ```

3. Add to the data object:
   ```ts
   if (hiddenNavItems !== undefined) {
     data.hiddenNavItems = hiddenNavItems
   }
   ```

**Verify:** `GET /api/user/preferences` returns `hiddenNavItems: []` for existing users. `PATCH` with `{ hiddenNavItems: ["/timeline"] }` persists and returns on next GET.
</task>

<task id="04">
**Create useNavVisibility hook**

Create `src/lib/hooks/use-nav-visibility.ts`:

This is a client-side hook that:

1. **Fetches** hidden items from `/api/user/preferences` on mount (using SWR or a simple fetch + state pattern matching the existing `useDetailViewMode` approach — check how that hook works).

2. **Exposes:**
   - `hiddenItems: string[]` — array of hidden href strings
   - `isLoading: boolean` — true while fetching
   - `isVisible(href: string): boolean` — returns false only if href is in hiddenItems AND not always-visible
   - `toggleItem(href: string): void` — adds/removes href from hiddenItems, PATCHes API
   - `autoReveal(pathname: string): void` — if pathname matches a hidden item, removes it from hiddenItems and PATCHes API

3. **Implementation details:**
   - Use `useState` for `hiddenItems` and `isLoading`
   - Fetch on mount with `useEffect`
   - `toggleItem` optimistically updates state, then PATCHes
   - `autoReveal` only fires once per pathname change (use a ref to track last revealed path)
   - Import `isAlwaysVisible` from nav-config to guard against hiding always-visible items
   - Export the hook as a named export

**Pattern reference:** Look at how `src/lib/detail-view-context.tsx` provides `useDetailViewMode` — it uses a React context with fetch-on-mount. For this hook, a simpler standalone fetch pattern is fine since it's only used in sidebar + settings.

**Verify:** Hook compiles. Calling `isVisible('/timeline')` returns true when hiddenItems is empty. Returns false when hiddenItems contains `'/timeline'`. `isVisible('/')` always returns true regardless of hiddenItems.
</task>

## must_haves
- [ ] `hiddenNavItems` field exists in UserPreferences model and database
- [ ] GET /api/user/preferences returns hiddenNavItems (defaults to [])
- [ ] PATCH /api/user/preferences accepts and persists hiddenNavItems
- [ ] useNavVisibility hook provides isVisible, toggleItem, autoReveal
- [ ] Dashboard (/) and Settings (/settings) are always visible regardless of hiddenNavItems
