# Plan 65-01: Schema + API for Internal Projects

## Frontmatter
- **Phase:** 65
- **Plan:** 01
- **Wave:** 1
- **Depends on:** None
- **Files modified:**
  - `prisma/schema.prisma`
  - `src/app/api/projects/route.ts`
  - `src/app/api/projects/[id]/route.ts`
  - `src/app/api/ai/pending/route.ts`
  - `src/lib/manifest-utils.ts`
- **Autonomous:** yes

## Goal
Add isInternal flag and internalEntity field to the Project model, make companyId nullable, update all API endpoints to support internal projects, and ensure null-safe company access across all server-side code.

## Tasks

<task id="1">
**Update Prisma schema to support internal projects**

In `prisma/schema.prisma`, modify the Project model:

1. Make `companyId` optional by changing `String` to `String?`:
   ```
   companyId String? @map("company_id")
   company   Company? @relation(fields: [companyId], references: [id])
   ```
   Note: The `Company` relation must also become `Company?` (optional).

2. Add `isInternal` field after `isArchived`:
   ```
   isInternal    Boolean @default(false) @map("is_internal")
   ```

3. Add `internalEntity` field after `isInternal`:
   ```
   internalEntity String? @map("internal_entity") @db.VarChar(50)
   ```

4. Add index on `isInternal`:
   ```
   @@index([isInternal])
   ```

The index block should be placed alongside existing indexes.
</task>

<task id="2">
**Run Prisma migration**

Run: `npx prisma migrate dev --name add-internal-project-flag`

This will:
- Make company_id nullable in the projects table
- Add is_internal column (default false)
- Add internal_entity column (nullable varchar 50)
- Add index on is_internal

Then generate the Prisma client: `npx prisma generate`
</task>

<task id="3">
**Update POST /api/projects to support internal project creation**

In `src/app/api/projects/route.ts`:

1. Modify the GET handler to support `type` query parameter:
   - `type=client` -> `where: { isInternal: false }`
   - `type=internal` -> `where: { isInternal: true }`
   - `type=all` or omitted -> no filter on isInternal
   - Include `isInternal` and `internalEntity` in the response (they are returned automatically by Prisma)

2. Modify the POST handler:
   - Remove the hard requirement for `companyId`
   - Add validation: if `body.isInternal` is true:
     - `companyId` is NOT required (set to null)
     - `internalEntity` is required (must be "MOTIONVII" or "TALENTA")
   - If `body.isInternal` is false or not provided:
     - `companyId` IS required (existing behavior)
     - `internalEntity` should be null
   - Include `isInternal` and `internalEntity` in the create data
</task>

<task id="4">
**Update PATCH /api/projects/[id] for internal projects**

In `src/app/api/projects/[id]/route.ts`:

1. In the PATCH handler, update the validation:
   - When updating, check if the project is/will be internal
   - If `body.isInternal` is provided and true, companyId can be null
   - If `body.isInternal` is provided and false, companyId is required
   - If `body.isInternal` is not provided, check existing project state
   - Allow updating `isInternal` and `internalEntity` fields

2. Add `isInternal` and `internalEntity` to the update data spread:
   ```
   ...(body.isInternal !== undefined && { isInternal: body.isInternal }),
   ...(body.internalEntity !== undefined && { internalEntity: body.internalEntity || null }),
   ```

3. When `isInternal` changes to true, clear companyId and contactId:
   ```
   ...(body.isInternal === true && { companyId: null, contactId: null }),
   ```
</task>

<task id="5">
**Fix null-safe company access in ai/pending route**

In `src/app/api/ai/pending/route.ts`:

Line 75 accesses `doc.project.company.name` directly. Change to:
```typescript
company: doc.project.company?.name || 'Internal',
```

This prevents crash when a project has no company (internal project).
</task>

<task id="6">
**Fix null-safe company access in manifest-utils**

In `src/lib/manifest-utils.ts`:

Line 88 accesses `project.company.name` directly. Change to:
```typescript
company: project.company?.name || 'Internal',
```

Also update the TypeScript type for the manifest project to allow company to be a string (it already is, but ensure it handles null gracefully).
</task>

## Verification

After completing all tasks:

1. **Schema check**: Run `npx prisma validate` to verify schema is valid
2. **Type check**: Run `npx tsc --noEmit` to verify no TypeScript errors across the codebase
3. **API test**: The GET /api/projects endpoint should accept `?type=client`, `?type=internal`, `?type=all` query params
4. **Migration**: Verify the migration file was created and applied successfully

## must_haves
- companyId is nullable in schema (String? not String)
- isInternal Boolean field exists with default false
- internalEntity String? field exists
- POST /api/projects accepts isInternal=true without companyId
- POST /api/projects rejects isInternal=true without internalEntity
- GET /api/projects supports type=client|internal|all filter
- No null pointer crashes on company access in ai/pending or manifest-utils
- TypeScript compiles without errors
