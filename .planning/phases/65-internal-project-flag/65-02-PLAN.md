# Plan 65-02: UI for Internal Projects

## Frontmatter
- **Phase:** 65
- **Plan:** 02
- **Wave:** 2
- **Depends on:** 65-01
- **Files modified:**
  - `src/components/projects/project-form-modal.tsx`
  - `src/components/projects/project-card.tsx`
  - `src/components/projects/project-list.tsx`
  - `src/components/projects/project-detail-sheet.tsx`
  - `src/app/(dashboard)/projects/[id]/project-detail-page-client.tsx`
  - `src/app/(dashboard)/projects/page.tsx`
  - `src/components/dashboard/pending-analysis-widget.tsx`
- **Autonomous:** yes

## Goal
Update all project UI components to support internal projects: creation form with internal toggle, type filter on project list, Internal badge on cards and detail views, and null-safe company display across all components.

## Tasks

<task id="1">
**Add internal project toggle to project-form-modal.tsx**

In `src/components/projects/project-form-modal.tsx`:

1. Add state variables:
   ```typescript
   const [isInternal, setIsInternal] = useState(false)
   const [internalEntity, setInternalEntity] = useState<string | null>(null)
   ```

2. Reset these in the useEffect when modal closes:
   ```typescript
   setIsInternal(false)
   setInternalEntity(null)
   ```

3. Add an "Internal Project" switch/toggle BEFORE the Company field. Use a simple checkbox or Switch component:
   ```tsx
   <div className="flex items-center gap-2">
     <input
       type="checkbox"
       id="isInternal"
       checked={isInternal}
       onChange={(e) => {
         setIsInternal(e.target.checked)
         if (e.target.checked) {
           setCompanyId(null)
           setContactId(null)
           setContacts([])
         } else {
           setInternalEntity(null)
         }
       }}
       className="rounded border-gray-300"
     />
     <Label htmlFor="isInternal">Internal Project</Label>
   </div>
   ```

4. When `isInternal` is true:
   - HIDE the Company and Contact fields
   - SHOW an Entity selector with options: "Motionvii" and "Talenta"
   - Use a simple Select component:
     ```tsx
     {isInternal && (
       <div className="space-y-2">
         <Label>Entity <span className="text-red-500">*</span></Label>
         <Select value={internalEntity || ''} onValueChange={setInternalEntity}>
           <SelectTrigger>
             <SelectValue placeholder="Select entity..." />
           </SelectTrigger>
           <SelectContent>
             <SelectItem value="MOTIONVII">Motionvii</SelectItem>
             <SelectItem value="TALENTA">Talenta</SelectItem>
           </SelectContent>
         </Select>
       </div>
     )}
     ```

5. When `isInternal` is false:
   - Show Company and Contact fields as before (existing behavior)
   - Hide Entity selector

6. Update validation in handleSubmit:
   - If `isInternal`: require internalEntity, don't require companyId
   - If not internal: require companyId (existing behavior)

7. Update the POST body to include `isInternal` and `internalEntity`:
   ```typescript
   body: JSON.stringify({
     title: title.trim(),
     isInternal,
     internalEntity: isInternal ? internalEntity : null,
     companyId: isInternal ? null : companyId,
     contactId: isInternal ? null : contactId || null,
     initiativeId: initiativeId || null,
     revenue: revenue ? parseFloat(revenue) : null,
     description: description.trim() || null,
   }),
   ```

Import Select components at the top: `import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select'`
</task>

<task id="2">
**Add Internal badge to project-card.tsx**

In `src/components/projects/project-card.tsx`:

1. Update the Project interface to include:
   ```typescript
   isInternal?: boolean
   internalEntity?: string | null
   ```

2. When project has no company but is internal, show entity name instead:
   ```tsx
   {project.company ? (
     <div className="flex items-center gap-1.5 mt-1 text-sm text-gray-500">
       <Building2 className="h-3.5 w-3.5" />
       <span className="truncate">{project.company.name}</span>
     </div>
   ) : project.isInternal && project.internalEntity ? (
     <div className="flex items-center gap-1.5 mt-1 text-sm text-gray-500">
       <Building2 className="h-3.5 w-3.5" />
       <span className="truncate">{project.internalEntity === 'MOTIONVII' ? 'Motionvii' : 'Talenta'}</span>
     </div>
   ) : null}
   ```

3. Add "Internal" badge in the badges row (after source badge, before KRI):
   ```tsx
   {project.isInternal && (
     <Badge
       variant="outline"
       className="text-xs bg-amber-50 text-amber-700 border-amber-200"
     >
       Internal
     </Badge>
   )}
   ```
</task>

<task id="3">
**Add type filter to project-list.tsx**

In `src/components/projects/project-list.tsx`:

1. Update the Project interface to include:
   ```typescript
   isInternal?: boolean
   internalEntity?: string | null
   ```

2. Add type filter state:
   ```typescript
   const [selectedType, setSelectedType] = useState<'ALL' | 'CLIENT' | 'INTERNAL'>('ALL')
   ```

3. Add type filter tabs BEFORE the status filter tabs. Use the same styling pattern as the status tabs:
   ```tsx
   <div className="flex items-center gap-1 p-1 bg-gray-100 rounded-lg">
     {[
       { id: 'ALL' as const, label: 'All' },
       { id: 'CLIENT' as const, label: 'Client' },
       { id: 'INTERNAL' as const, label: 'Internal' },
     ].map((tab) => (
       <button
         key={tab.id}
         onClick={() => setSelectedType(tab.id)}
         className={cn(
           'px-3 py-1.5 text-sm font-medium rounded-md transition-colors',
           selectedType === tab.id
             ? 'bg-white text-gray-900 shadow-sm'
             : 'text-gray-600 hover:text-gray-900'
         )}
       >
         {tab.label}
       </button>
     ))}
   </div>
   ```

4. Update the filteredProjects logic to apply both type and status filters:
   ```typescript
   const filteredProjects = projects.filter((p) => {
     // Type filter
     if (selectedType === 'CLIENT' && p.isInternal) return false
     if (selectedType === 'INTERNAL' && !p.isInternal) return false
     // Status filter
     if (selectedType !== 'ALL' || selectedStatus !== 'ALL') {
       if (selectedStatus !== 'ALL' && p.status !== selectedStatus) return false
     }
     return selectedStatus === 'ALL' || p.status === selectedStatus
   })
   ```

   Simplified version:
   ```typescript
   const filteredProjects = projects.filter((p) => {
     if (selectedType === 'CLIENT' && p.isInternal) return false
     if (selectedType === 'INTERNAL' && !p.isInternal) return false
     if (selectedStatus !== 'ALL' && p.status !== selectedStatus) return false
     return true
   })
   ```
</task>

<task id="4">
**Update project-detail-sheet.tsx for internal project editing**

In `src/components/projects/project-detail-sheet.tsx`:

1. Update the Project interface to include:
   ```typescript
   isInternal?: boolean
   internalEntity?: string | null
   ```

2. Add state variables for internal project fields:
   ```typescript
   const [isInternal, setIsInternal] = useState(false)
   const [internalEntity, setInternalEntity] = useState<string | null>(null)
   ```

3. Initialize from project in the useEffect:
   ```typescript
   setIsInternal(project.isInternal || false)
   setInternalEntity(project.internalEntity || null)
   ```

4. Update the form UI (Company section):
   - Add internal toggle checkbox before the Company field (same pattern as form modal)
   - When isInternal is true: hide Company/Contact fields, show Entity selector
   - When isInternal is false: show Company/Contact fields (existing behavior)

5. Update validation in handleSave:
   - If isInternal: don't require companyId
   - If not internal: require companyId

6. Update the PATCH body to include isInternal and internalEntity:
   ```typescript
   body: JSON.stringify({
     title: title.trim(),
     status,
     isInternal,
     internalEntity: isInternal ? internalEntity : null,
     companyId: isInternal ? null : companyId,
     contactId: isInternal ? null : contactId || null,
     initiativeId: initiativeId || null,
     description: description.trim() || null,
     startDate: startDate ? startDate.toISOString() : null,
     endDate: endDate ? endDate.toISOString() : null,
   }),
   ```

7. Update hasChanges to include isInternal and internalEntity:
   ```typescript
   isInternal !== (project.isInternal || false) ||
   internalEntity !== (project.internalEntity || null) ||
   ```

8. Import Select components if not already imported (they are already imported in this file).

9. When toggling isInternal on, clear company/contact state. When toggling off, clear internalEntity.
</task>

<task id="5">
**Update project-detail-page-client.tsx for internal display**

In `src/app/(dashboard)/projects/[id]/project-detail-page-client.tsx`:

1. Update the Project interface:
   ```typescript
   isInternal?: boolean
   internalEntity?: string | null
   ```

2. In the header section where company is displayed (around line 348):
   Replace:
   ```tsx
   {project.company && (
     <p className="text-sm text-gray-500 mt-0.5">
       {project.company.name}
     </p>
   )}
   ```
   With:
   ```tsx
   {project.company ? (
     <p className="text-sm text-gray-500 mt-0.5">
       {project.company.name}
     </p>
   ) : project.isInternal && project.internalEntity ? (
     <p className="text-sm text-gray-500 mt-0.5">
       {project.internalEntity === 'MOTIONVII' ? 'Motionvii' : 'Talenta'}
     </p>
   ) : null}
   ```

3. Add "Internal" badge next to status badge in header (around line 336):
   ```tsx
   {project.isInternal && (
     <Badge className="shrink-0 bg-amber-50 text-amber-700 border-amber-200">
       Internal
     </Badge>
   )}
   ```

4. In the Details card, Company section (around line 384):
   Replace:
   ```tsx
   {project.company?.name || 'No company'}
   ```
   With:
   ```tsx
   {project.company?.name || (project.isInternal && project.internalEntity
     ? (project.internalEntity === 'MOTIONVII' ? 'Motionvii' : 'Talenta')
     : 'No company')}
   ```
   Also change the label from "Company" to show "Entity" when internal.
</task>

<task id="6">
**Update projects/page.tsx to pass isInternal fields**

In `src/app/(dashboard)/projects/page.tsx`:

The server component already includes all project fields via Prisma. Since `isInternal` and `internalEntity` are simple boolean/string fields, they will be serialized automatically by the spread operator in `serializedProjects`. No additional serialization is needed.

Verify that the existing code correctly passes through the new fields. The `...project` spread already handles this.
</task>

<task id="7">
**Update pending-analysis-widget.tsx for null-safe company**

In `src/components/dashboard/pending-analysis-widget.tsx`:

Around line 158, the widget displays `{project.company}`. This is a string from the API (not an object). The API route was already fixed in Plan 65-01 to return 'Internal' when company is null, so this will work. But for extra safety, update:

```tsx
{project.company || 'Internal'}
```

This ensures graceful display even if the API returns empty string.
</task>

## Verification

After completing all tasks:

1. **Type check**: Run `npx tsc --noEmit` -- no TypeScript errors
2. **Visual check**: The project form modal should show an "Internal Project" toggle
3. **Visual check**: Internal projects should display amber "Internal" badge on cards
4. **Visual check**: Project list should have All / Client / Internal type filter tabs
5. **Visual check**: Internal project detail page should show entity name instead of company
6. **Visual check**: Internal project detail sheet should hide company/contact when internal, show entity selector

## must_haves
- Project creation form has Internal Project toggle
- When internal, entity selector (Motionvii/Talenta) appears and company/contact fields are hidden
- When not internal, company remains required (existing behavior preserved)
- Project cards show amber "Internal" badge for internal projects
- Project list has type filter tabs: All / Client / Internal
- Internal project detail page shows Internal badge and entity name
- Internal project detail sheet allows editing isInternal and internalEntity
- pending-analysis-widget handles null company gracefully
- TypeScript compiles without errors
