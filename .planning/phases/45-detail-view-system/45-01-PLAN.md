---
phase: 45-detail-view-system
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - prisma/schema.prisma
  - src/app/api/user/preferences/route.ts
  - src/lib/detail-view-context.tsx
  - src/lib/hooks/use-detail-view-mode.ts
  - src/components/ui/detail-view.tsx
  - src/components/providers.tsx
autonomous: true

must_haves:
  truths:
    - "DetailView component renders content inside Dialog when mode is 'dialog'"
    - "DetailView component renders content inside Sheet when mode is 'drawer'"
    - "DetailView shows Expand button linking to full page when expandHref is provided"
    - "User preference for detailViewMode is persisted in the database"
    - "DetailViewProvider loads preference from API on mount and exposes mode/toggle"
    - "Drawer slides from right on desktop, bottom on mobile"
  artifacts:
    - path: "src/components/ui/detail-view.tsx"
      provides: "DetailView wrapper component that conditionally renders Dialog or Sheet"
      exports: ["DetailView"]
    - path: "src/lib/detail-view-context.tsx"
      provides: "React context provider for detail view mode preference"
      exports: ["DetailViewProvider"]
    - path: "src/lib/hooks/use-detail-view-mode.ts"
      provides: "Hook to access detail view mode from context"
      exports: ["useDetailViewMode"]
    - path: "prisma/schema.prisma"
      provides: "detailViewMode column on UserPreferences model"
      contains: "detailViewMode"
    - path: "src/app/api/user/preferences/route.ts"
      provides: "GET returns detailViewMode, PATCH accepts detailViewMode"
    - path: "src/components/providers.tsx"
      provides: "DetailViewProvider wrapping children"
  key_links:
    - from: "src/components/ui/detail-view.tsx"
      to: "src/lib/hooks/use-detail-view-mode.ts"
      via: "useDetailViewMode() hook call"
      pattern: "useDetailViewMode"
    - from: "src/lib/detail-view-context.tsx"
      to: "/api/user/preferences"
      via: "fetch on mount and on setMode"
      pattern: "fetch.*api/user/preferences"
    - from: "src/components/providers.tsx"
      to: "src/lib/detail-view-context.tsx"
      via: "DetailViewProvider import and wrapping"
      pattern: "DetailViewProvider"
---

<objective>
Build the detail view infrastructure: a DetailView wrapper component that conditionally renders Dialog or Sheet based on user preference, a React context for the preference, the database schema addition, and API updates.

Purpose: Creates the foundation that all 7 detail view components will use. Without this, no detail view can switch between drawer and dialog modes.
Output: DetailView component, context provider, hook, schema update, API update -- all wired into the existing Providers component.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/45-detail-view-system/45-RESEARCH.md
@prisma/schema.prisma
@src/components/ui/dialog.tsx
@src/components/ui/sheet.tsx
@src/components/providers.tsx
@src/app/api/user/preferences/route.ts
@src/app/layout.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Schema, API, and Context Provider</name>
  <files>
    prisma/schema.prisma
    src/app/api/user/preferences/route.ts
    src/lib/detail-view-context.tsx
    src/lib/hooks/use-detail-view-mode.ts
    src/components/providers.tsx
  </files>
  <action>
  1. **Prisma schema** -- Add `detailViewMode` field to the existing `UserPreferences` model (line ~590 in schema.prisma, between `dateFilter` and `createdAt`):
     ```
     detailViewMode  String  @default("dialog") @map("detail_view_mode") @db.VarChar(20)
     ```
     Then run `npx prisma db push` to sync the schema (this project uses db push, NOT migrations).

  2. **Preferences API** -- Modify `src/app/api/user/preferences/route.ts`:
     - In the GET handler, add `detailViewMode: prefs?.detailViewMode ?? 'dialog'` to the response JSON (alongside dashboardLayout and dateFilter).
     - In the PATCH handler, destructure `detailViewMode` from the request body alongside `dashboardLayout` and `dateFilter`. Add the same pattern: `if (detailViewMode !== undefined) { data.detailViewMode = detailViewMode }`.

  3. **Context provider** -- Create `src/lib/detail-view-context.tsx`:
     - Define type `DetailViewMode = 'dialog' | 'drawer'`
     - Define context type with `mode: DetailViewMode`, `setMode: (mode: DetailViewMode) => void`, `toggle: () => void`, `isLoading: boolean`
     - Create context with default `mode: 'dialog'`
     - `DetailViewProvider` component:
       - State: `mode` (default 'dialog'), `isLoading` (default true)
       - useEffect on mount: fetch `/api/user/preferences`, extract `detailViewMode`, call `setModeState` if present, set isLoading false in finally
       - `setMode` callback: update state immediately, then fire-and-forget PATCH to `/api/user/preferences` with `{ detailViewMode: newMode }`. Use `.catch(console.error)` -- no need to roll back on API failure.
       - `toggle` callback: calls `setMode(mode === 'dialog' ? 'drawer' : 'dialog')`
     - Export `DetailViewProvider` and `useDetailViewMode` (which is `useContext(DetailViewContext)`)

  4. **Hook re-export** -- Create `src/lib/hooks/use-detail-view-mode.ts` that re-exports `useDetailViewMode` from `@/lib/detail-view-context`. This follows the hooks directory pattern already used by `use-debounce.ts` and `use-dashboard-layout.ts`.

  5. **Wire provider** -- Modify `src/components/providers.tsx`:
     - Import `DetailViewProvider` from `@/lib/detail-view-context`
     - Wrap children: `<SessionProvider><DetailViewProvider>{children}</DetailViewProvider></SessionProvider>`
     - The DetailViewProvider MUST be inside SessionProvider because it calls the preferences API which requires auth.
  </action>
  <verify>
    - `npx prisma db push` completes without error
    - `npx prisma generate` completes
    - `npm run build` compiles without TypeScript errors
    - The GET `/api/user/preferences` response now includes `detailViewMode: "dialog"` (default)
    - The PATCH `/api/user/preferences` with `{ "detailViewMode": "drawer" }` returns success, and subsequent GET shows `detailViewMode: "drawer"`
  </verify>
  <done>
    UserPreferences table has detailViewMode column with default "dialog". API reads and writes it. Context provider loads and persists preference. Hook is available for any component to consume.
  </done>
</task>

<task type="auto">
  <name>Task 2: DetailView Wrapper Component</name>
  <files>
    src/components/ui/detail-view.tsx
  </files>
  <action>
  Create `src/components/ui/detail-view.tsx` as a 'use client' component:

  **Props interface (DetailViewProps):**
  - `open: boolean`
  - `onOpenChange: (open: boolean) => void`
  - `title: React.ReactNode` -- rendered inside DialogTitle/SheetTitle
  - `children: React.ReactNode` -- the body content
  - `className?: string` -- applied to DialogContent/SheetContent for custom max-width
  - `expandHref?: string` -- if provided, shows an Expand button next to the title
  - `footer?: React.ReactNode` -- if provided, renders below content (for DialogFooter/SheetFooter)
  - `headerClassName?: string` -- extra classes for the header section
  - `contentClassName?: string` -- extra classes for the scrollable content area

  **Expand button:**
  - Import `Expand` from `lucide-react` and `Link` from `next/link`
  - Create a small internal `ExpandButton` component: renders `<Link href={expandHref}><Button variant="ghost" size="icon" className="h-7 w-7"><Expand className="h-4 w-4" /><span className="sr-only">Open full page</span></Button></Link>`
  - Only render when `expandHref` is provided

  **Responsive drawer direction (VIEW-07):**
  - Use a simple `useState` + `useEffect` with `window.matchMedia('(min-width: 768px)')` to detect desktop vs mobile
  - On desktop: `side="right"` for Sheet
  - On mobile: `side="bottom"` for Sheet
  - Listen for changes with `matchMedia.addEventListener('change', ...)` and clean up

  **Dialog mode rendering:**
  ```tsx
  <Dialog open={open} onOpenChange={onOpenChange}>
    <DialogContent className={cn("md:max-w-[650px] p-0 flex flex-col", className)}>
      <DialogHeader className={cn("p-6 pb-4 border-b shrink-0 pr-12", headerClassName)}>
        <div className="flex items-center justify-between">
          <DialogTitle className="text-left text-lg leading-snug flex-1">
            {title}
          </DialogTitle>
          {expandHref && <ExpandButton href={expandHref} />}
        </div>
      </DialogHeader>
      <ScrollArea className={cn("flex-1 min-h-0", contentClassName)}>
        {children}
      </ScrollArea>
      {footer && (
        <DialogFooter className="p-4 border-t shrink-0">
          {footer}
        </DialogFooter>
      )}
    </DialogContent>
  </Dialog>
  ```

  **Drawer mode rendering:**
  ```tsx
  <Sheet open={open} onOpenChange={onOpenChange}>
    <SheetContent side={isMobile ? 'bottom' : 'right'} resizable={!isMobile} className={cn(
      isMobile && "h-[85vh] rounded-t-2xl",
      !isMobile && "flex flex-col",
      className
    )}>
      <SheetHeader className={cn("pr-8", headerClassName)}>
        <div className="flex items-center justify-between">
          <SheetTitle className="text-left text-lg leading-snug flex-1">
            {title}
          </SheetTitle>
          {expandHref && <ExpandButton href={expandHref} />}
        </div>
      </SheetHeader>
      <ScrollArea className={cn("flex-1 mt-4", contentClassName)}>
        {children}
      </ScrollArea>
      {footer && (
        <div className="p-4 border-t shrink-0 mt-auto">
          {footer}
        </div>
      )}
    </SheetContent>
  </Sheet>
  ```

  **Key implementation notes:**
  - Import `useDetailViewMode` from `@/lib/hooks/use-detail-view-mode`
  - Do NOT modify the base `dialog.tsx` or `sheet.tsx` primitives
  - Both modes use ScrollArea for consistent scrolling behavior
  - The `p-0` on DialogContent removes default padding so children can control their own padding (matching existing initiative-detail-sheet.tsx pattern)
  - For Sheet on mobile with `side="bottom"`, add `h-[85vh] rounded-t-2xl` to match Dialog's mobile appearance
  - Export only `DetailView` from this file
  </action>
  <verify>
    - `npm run build` compiles without TypeScript errors
    - The component file exports `DetailView`
    - Component imports resolve correctly (Dialog, Sheet, ScrollArea, useDetailViewMode, Link)
  </verify>
  <done>
    DetailView component exists and can render content in either Dialog or Sheet mode based on user preference. Expand button renders when expandHref is provided. Drawer is responsive (right on desktop, bottom on mobile).
  </done>
</task>

</tasks>

<verification>
- `npx prisma db push` succeeds (schema valid)
- `npm run build` passes (all TypeScript compiles)
- The preferences API handles detailViewMode field (GET returns it, PATCH accepts it)
- DetailView component is importable and renders without errors
- DetailViewProvider is wired into the Providers component tree
</verification>

<success_criteria>
1. UserPreferences model has `detailViewMode` column with default "dialog"
2. Preferences API GET returns and PATCH accepts `detailViewMode`
3. DetailViewProvider loads preference on mount and persists changes to API
4. DetailView component conditionally renders Dialog or Sheet based on mode from context
5. Expand button appears in header when expandHref prop is provided
6. Sheet uses side="right" on desktop, side="bottom" on mobile
7. `npm run build` passes cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/45-detail-view-system/45-01-SUMMARY.md`
</output>
