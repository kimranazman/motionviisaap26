---
phase: 45-detail-view-system
plan: 02
type: execute
wave: 2
depends_on: ["45-01"]
files_modified:
  - src/components/kanban/initiative-detail-sheet.tsx
  - src/components/companies/company-detail-modal.tsx
  - src/components/pipeline/deal-detail-sheet.tsx
  - src/components/potential-projects/potential-detail-sheet.tsx
  - src/components/projects/project-detail-sheet.tsx
  - src/components/projects/task-detail-sheet.tsx
  - src/components/suppliers/supplier-detail-modal.tsx
  - src/components/layout/header.tsx
  - src/app/(dashboard)/settings/page.tsx
autonomous: true

must_haves:
  truths:
    - "All 7 detail views render in drawer mode when user preference is 'drawer'"
    - "All 7 detail views render in dialog mode when user preference is 'dialog'"
    - "InitiativeDetailSheet shows Expand button linking to /initiatives/{id}"
    - "Settings page at /settings shows detail view mode toggle"
    - "User menu dropdown has a toggle item to switch between drawer and dialog"
    - "Toggling mode in user menu immediately changes how next detail view opens"
    - "Detail views with footer sections (deals, suppliers, companies, projects) still show their action buttons"
  artifacts:
    - path: "src/app/(dashboard)/settings/page.tsx"
      provides: "Settings page with detail view mode preference"
    - path: "src/components/layout/header.tsx"
      provides: "User menu with detail view mode toggle"
      contains: "useDetailViewMode"
    - path: "src/components/kanban/initiative-detail-sheet.tsx"
      provides: "Initiative detail using DetailView wrapper"
      contains: "DetailView"
    - path: "src/components/pipeline/deal-detail-sheet.tsx"
      provides: "Deal detail using DetailView wrapper"
      contains: "DetailView"
    - path: "src/components/companies/company-detail-modal.tsx"
      provides: "Company detail using DetailView wrapper"
      contains: "DetailView"
  key_links:
    - from: "src/components/kanban/initiative-detail-sheet.tsx"
      to: "src/components/ui/detail-view.tsx"
      via: "DetailView import"
      pattern: "from.*detail-view"
    - from: "src/components/layout/header.tsx"
      to: "src/lib/hooks/use-detail-view-mode.ts"
      via: "useDetailViewMode hook"
      pattern: "useDetailViewMode"
    - from: "src/app/(dashboard)/settings/page.tsx"
      to: "src/lib/hooks/use-detail-view-mode.ts"
      via: "useDetailViewMode hook"
      pattern: "useDetailViewMode"
---

<objective>
Refactor all 7 detail view components to use the DetailView wrapper (switching from direct Dialog usage), add a settings page at /settings with the detail view mode preference, and add a quick toggle in the user menu dropdown.

Purpose: Completes the user-facing feature. After this plan, users can choose between drawer and dialog for all detail views, configure it on the settings page, and quick-toggle from the user menu.
Output: All 7 detail views use DetailView, settings page exists, user menu has toggle. Phase 45 is complete.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/45-detail-view-system/45-RESEARCH.md
@.planning/phases/45-detail-view-system/45-01-SUMMARY.md
@src/components/kanban/initiative-detail-sheet.tsx
@src/components/pipeline/deal-detail-sheet.tsx
@src/components/companies/company-detail-modal.tsx
@src/components/potential-projects/potential-detail-sheet.tsx
@src/components/projects/project-detail-sheet.tsx
@src/components/projects/task-detail-sheet.tsx
@src/components/suppliers/supplier-detail-modal.tsx
@src/components/layout/header.tsx
@src/components/layout/sidebar.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Refactor all 7 detail views to use DetailView</name>
  <files>
    src/components/kanban/initiative-detail-sheet.tsx
    src/components/companies/company-detail-modal.tsx
    src/components/pipeline/deal-detail-sheet.tsx
    src/components/potential-projects/potential-detail-sheet.tsx
    src/components/projects/project-detail-sheet.tsx
    src/components/projects/task-detail-sheet.tsx
    src/components/suppliers/supplier-detail-modal.tsx
  </files>
  <action>
  For each of the 7 detail view components, apply this mechanical refactoring pattern:

  **Step 1: Change imports**
  - Remove: `Dialog, DialogContent, DialogHeader, DialogTitle` (and `DialogFooter` if used) from `@/components/ui/dialog`
  - Add: `import { DetailView } from '@/components/ui/detail-view'`
  - Keep: `ScrollArea` import ONLY if used for inner scrolling within content sections (the DetailView handles outer scrolling). Most can be removed.

  **Step 2: Replace JSX structure**

  Each component currently has this pattern:
  ```tsx
  <Dialog open={open} onOpenChange={onOpenChange}>
    <DialogContent className="md:max-w-[650px] p-0 flex flex-col">
      <DialogHeader className="p-6 pb-4 border-b shrink-0 pr-12">
        {/* title content */}
      </DialogHeader>
      <ScrollArea className="flex-1 min-h-0">
        {/* body content */}
      </ScrollArea>
      {/* optional DialogFooter */}
    </DialogContent>
  </Dialog>
  ```

  Replace with:
  ```tsx
  <DetailView
    open={open}
    onOpenChange={onOpenChange}
    title={/* title content from DialogHeader, WITHOUT the DialogTitle wrapper */}
    expandHref={/* only for components with full pages */}
    className="md:max-w-[650px]"
    footer={/* content from DialogFooter if it exists, otherwise omit */}
  >
    {/* body content from ScrollArea, just the inner div */}
  </DetailView>
  ```

  **Per-component specifics:**

  1. **InitiativeDetailSheet** (`initiative-detail-sheet.tsx`):
     - Title: The flex div with Badge + title text
     - expandHref: `` `/initiatives/${initiative.id}` `` (this entity has a full page at `/initiatives/[id]`)
     - Footer: None (save button is inside content)
     - Keep: The `<PermissionDeniedDialog>` and `<AlertDialog>` that are siblings of the main Dialog -- they remain outside `<DetailView>` as separate components
     - headerClassName: `"pr-12"` -- to leave room for close button
     - Remove the outer `<Dialog>` and `<DialogContent>` wrappers, remove `<DialogHeader>`, remove the outer `<ScrollArea>` wrapper
     - The inner content (`<div className="p-6 space-y-6">...</div>`) becomes the children of DetailView

  2. **CompanyDetailModal** (`company-detail-modal.tsx`):
     - Title: Company name text
     - expandHref: omit (no full page exists for companies)
     - Footer: Has DialogFooter with delete button -- pass as `footer` prop
     - className: Check what className the DialogContent uses and preserve

  3. **DealDetailSheet** (`deal-detail-sheet.tsx`):
     - Title: The flex div with stage Badge + title text
     - expandHref: omit (no full page for deals)
     - Footer: Has DialogFooter with archive/delete/save buttons -- pass as `footer` prop
     - The footer content should be extracted as-is (the flex layout with buttons)

  4. **PotentialDetailSheet** (`potential-detail-sheet.tsx`):
     - Title: Stage badge + title
     - expandHref: omit (no full page)
     - Footer: Check if it has one; if so, pass as prop

  5. **ProjectDetailSheet** (`project-detail-sheet.tsx`):
     - Title: Project title
     - expandHref: `` `/projects/${project.id}` `` (projects have a full page)
     - Footer: Check if it has one; if so, pass as prop

  6. **TaskDetailSheet** (`task-detail-sheet.tsx`):
     - Title: Task title
     - expandHref: omit (no full page for tasks)
     - Footer: Check if it has one; if so, pass as prop

  7. **SupplierDetailModal** (`supplier-detail-modal.tsx`):
     - Title: Supplier name
     - expandHref: omit (no full page for suppliers)
     - Footer: Check if it has one; if so, pass as prop

  **Important considerations:**
  - Do NOT change any component logic, state management, or event handlers -- only the container/wrapper
  - Some components render `AlertDialog` as siblings of the main `Dialog` -- these must remain as separate root-level elements, NOT inside `DetailView`
  - The `title` prop to DetailView should be the CONTENT that was inside DialogTitle, not the DialogTitle component itself (DetailView renders its own DialogTitle/SheetTitle)
  - If a component has custom header content beyond just a title (like badges), pass the entire header content as the `title` prop -- DetailView accepts `React.ReactNode`
  - Remove `Dialog`, `DialogContent`, `DialogHeader`, `DialogTitle`, `DialogFooter` from imports ONLY if they are no longer used elsewhere in the file. Some components use `AlertDialog` from the same `@/components/ui/alert-dialog` import -- do not remove those.
  </action>
  <verify>
    - `npm run build` compiles without TypeScript errors
    - All 7 detail view files contain `import { DetailView }` from `@/components/ui/detail-view`
    - No detail view file imports `Dialog` from `@/components/ui/dialog` (they may still import `AlertDialog` from `@/components/ui/alert-dialog`)
    - Grep for `<Dialog ` in the 7 files returns 0 matches (AlertDialog is OK)
  </verify>
  <done>
    All 7 detail view components use DetailView wrapper instead of direct Dialog. They automatically render as drawer or dialog based on user preference. InitiativeDetailSheet and ProjectDetailSheet show Expand buttons linking to their full pages.
  </done>
</task>

<task type="auto">
  <name>Task 2: Settings page and user menu toggle</name>
  <files>
    src/app/(dashboard)/settings/page.tsx
    src/components/layout/header.tsx
  </files>
  <action>
  1. **Settings page** -- Create `src/app/(dashboard)/settings/page.tsx`:
     - 'use client' component
     - Import: `Header` from `@/components/layout/header`, `Card` from `@/components/ui/card`, `Label` from `@/components/ui/label`, `Switch` from `@/components/ui/switch`, `useDetailViewMode` from `@/lib/hooks/use-detail-view-mode`, `PanelRight` and `Columns2` from `lucide-react`
     - Page layout follows dashboard pattern: `<Header title="Settings" description="Configure your preferences" />` at top
     - Content: A card-based layout with a "Display" section
     - The detail view mode setting:
       ```tsx
       <Card className="p-6">
         <h2 className="text-base font-semibold mb-4">Display</h2>
         <div className="flex items-center justify-between">
           <div className="space-y-1">
             <Label htmlFor="detail-view-mode" className="text-sm font-medium">Detail View Style</Label>
             <p className="text-sm text-muted-foreground">
               Choose how detail views appear when you click on items
             </p>
           </div>
           <div className="flex items-center gap-3">
             <div className="flex items-center gap-1.5 text-sm text-muted-foreground">
               <Columns2 className="h-4 w-4" />
               <span>Dialog</span>
             </div>
             <Switch
               id="detail-view-mode"
               checked={mode === 'drawer'}
               onCheckedChange={(checked) => setMode(checked ? 'drawer' : 'dialog')}
             />
             <div className="flex items-center gap-1.5 text-sm text-muted-foreground">
               <PanelRight className="h-4 w-4" />
               <span>Drawer</span>
             </div>
           </div>
         </div>
       </Card>
       ```
     - Wrap content in `<div className="p-4 md:p-6 space-y-6 max-w-2xl">` for consistent page padding
     - Show a toast on mode change using `sonner`: `toast.success('Detail view set to ${mode}')`

  2. **User menu toggle** -- Modify `src/components/layout/header.tsx`:
     - Add import: `import { useDetailViewMode } from '@/lib/hooks/use-detail-view-mode'`
     - Add import: `import { PanelRight, Columns2, Settings } from 'lucide-react'`
     - Add import: `import Link from 'next/link'`
     - Inside the Header component, call `const { mode, toggle } = useDetailViewMode()`
     - In the `<DropdownMenuContent>`, BEFORE the sign-out button and its separator, add:

     ```tsx
     <DropdownMenuItem onClick={(e) => { e.preventDefault(); toggle(); }}>
       {mode === 'dialog' ? (
         <>
           <PanelRight className="h-4 w-4 mr-2" />
           Switch to Drawer
         </>
       ) : (
         <>
           <Columns2 className="h-4 w-4 mr-2" />
           Switch to Dialog
         </>
       )}
     </DropdownMenuItem>
     <DropdownMenuItem asChild>
       <Link href="/settings">
         <Settings className="h-4 w-4 mr-2" />
         Settings
       </Link>
     </DropdownMenuItem>
     <DropdownMenuSeparator />
     ```

     The order in the dropdown should be:
     1. User name/email label
     2. Separator
     3. Detail view toggle
     4. Settings link
     5. Separator
     6. Sign Out

  **Why no sidebar link for Settings:** Settings is a user-level page (not a primary navigation destination). It's accessible from the user menu, which is the standard UX pattern for user preferences. This keeps the sidebar focused on content areas.
  </action>
  <verify>
    - `npm run build` compiles without TypeScript errors
    - Navigate to `/settings` -- page renders with Header and detail view mode toggle
    - Click the Switch on settings page -- mode changes, toast appears
    - Open user menu dropdown -- "Switch to Drawer/Dialog" item and "Settings" link are visible
    - Click the toggle in user menu -- subsequent detail views open in the new mode
  </verify>
  <done>
    Settings page at /settings exists with detail view mode toggle. User menu dropdown has quick toggle and Settings link. Users can configure their preferred detail view mode from two places.
  </done>
</task>

</tasks>

<verification>
- `npm run build` passes with zero errors
- All 7 detail view components import and use `DetailView` instead of `Dialog`
- Opening any detail view (initiative, company, deal, potential, project, task, supplier) respects the user's mode preference
- InitiativeDetailSheet shows Expand button when opened (links to /initiatives/{id})
- ProjectDetailSheet shows Expand button when opened (links to /projects/{id})
- Settings page at /settings loads and shows detail view mode toggle
- Switching mode on settings page persists across page refresh
- User menu dropdown shows toggle and Settings link
- All detail view footers (save, delete, archive buttons) still render correctly
</verification>

<success_criteria>
1. All 7 detail views use DetailView wrapper and respond to mode preference
2. InitiativeDetailSheet and ProjectDetailSheet have Expand buttons
3. Settings page at /settings has working detail view mode toggle
4. User menu dropdown has working quick toggle item
5. User menu dropdown has Settings link
6. Mode preference persists in database (survives page refresh)
7. `npm run build` passes cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/45-detail-view-system/45-02-SUMMARY.md`
</output>
