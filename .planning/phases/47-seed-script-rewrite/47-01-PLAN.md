---
phase: 47-seed-script-rewrite
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - prisma/seed.ts
autonomous: true

must_haves:
  truths:
    - "Running npx prisma db seed completes without errors"
    - "Database contains exactly 6 KeyResult records after seeding"
    - "Database contains exactly 37 Initiative records, each with a valid keyResultId FK"
    - "Database contains exactly 30 SupportTask records"
    - "SupportTaskKeyResult join table contains 58 entries (30 from All-KRs + 14 multi + 14 single)"
    - "4 Parent-company support tasks have zero join table entries"
    - "EventsToAttend records are seeded from old Excel file"
    - "Validation summary prints counts and flags any warnings"
  artifacts:
    - path: "prisma/seed.ts"
      provides: "Complete v2.0 OKR seed script"
      min_lines: 300
      contains: "keyResult.create"
  key_links:
    - from: "prisma/seed.ts"
      to: "MotionVii_SAAP_2026_v2.xlsx"
      via: "XLSX.readFile for Key Results, Initiatives, Support Tasks sheets"
      pattern: "SAAP_2026_v2"
    - from: "prisma/seed.ts"
      to: "MotionVii_SAAP_2026.xlsx"
      via: "XLSX.readFile for Events to Attend sheet"
      pattern: "SAAP_2026\\.xlsx"
    - from: "prisma/seed.ts"
      to: "prisma.keyResult.create"
      via: "KR lookup map for FK resolution"
      pattern: "krMap\\.set"
    - from: "prisma/seed.ts"
      to: "prisma.supportTaskKeyResult.create"
      via: "parseSupportsColumn for join table entries"
      pattern: "supportTaskKeyResult\\.create"
---

<objective>
Rewrite prisma/seed.ts to populate the database with all OKR data from the v2 Excel file (6 KeyResults, 37 Initiatives with FK linkage, 30 SupportTasks with join table entries, Events from old Excel) with validation summary.

Purpose: Phase 47 provides the seeded data that Phase 48 (API Layer) needs for testing endpoints, and that Phases 49-51 (UI phases) need for displaying real data.

Output: A working seed script that passes `npx prisma db seed` and produces the exact expected record counts.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/REQUIREMENTS.md
@.planning/phases/47-seed-script-rewrite/47-RESEARCH.md
@.planning/phases/46-schema-migration/46-01-SUMMARY.md
@prisma/schema.prisma
@prisma/seed.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Rewrite seed.ts for v2.0 OKR data</name>
  <files>prisma/seed.ts</files>
  <action>
Rewrite `prisma/seed.ts` to seed from `MotionVii_SAAP_2026_v2.xlsx` (3 data sheets) and `MotionVii_SAAP_2026.xlsx` (Events to Attend only). Follow the exact architecture from 47-RESEARCH.md.

**Imports:** Add KeyResultStatus, MetricType, SupportTaskCategory, TaskPriority to the Prisma import. Keep all existing imports (InitiativeStatus, Objective, InitiativeDepartment, TeamMember, EventPriority, EventCategory, EventStatus).

**Keep existing helper functions:** normalizeStatus, normalizeObjective, normalizeDepartment, normalizeTeamMember, parseExcelDate, parseCost, normalizeEventPriority, normalizeEventCategory, normalizeEventStatus. Update normalizeDepartment to add `'business dev': InitiativeDepartment.BIZ_DEV` mapping (Pitfall 7 from research).

**Add new helper functions (exact code in 47-RESEARCH.md "Enum Normalization Functions" section):**
- `normalizeMetricType(value)` -> MetricType
- `normalizeKeyResultStatus(value)` -> KeyResultStatus
- `normalizeSupportTaskCategory(value)` -> SupportTaskCategory
- `normalizeTaskPriority(value)` -> TaskPriority
- `parseProgress(value)` -> number (strips % sign, parses to float)
- `validateHeaders(actual, expected, sheetName)` -> void (warns on mismatches)
- `parseSupportsColumn(value, krMap, warnings)` -> string[] (handles "All KRs", "Parent company", comma-separated KR IDs)

**Excel column mappings (verified in 47-RESEARCH.md "Excel Column Mappings" section):**
- Key Results sheet: Header row index 2, data starts row index 3. 13 columns: [0]KR ID, [1]Objective, [2]Key Result Description, [3]Metric Type, [4]Target, [5]Actual, [6]Unit, [7]Progress %, [8]Deadline, [9]Status, [10]Owner, [11]How We Measure, [12]Notes
- Initiatives sheet: Header row index 2, data starts row index 3. 14 columns: [0]ID, [1]KR, [2]Objective, [3]Initiative, [4]Department, [5]Start Date, [6]End Date, [7]Budget (RM), [8]Resources, [9]Person In Charge, [10]Accountable, [11]Status, [12]Progress, [13]Remarks
- Support Tasks sheet: Header row index 3, data starts row index 4. 8 columns: [0]ID, [1]Category, [2]Task, [3]Supports, [4]Owner, [5]Frequency, [6]Priority, [7]Notes

**Main function flow -- follow this exact order:**

1. **Read both Excel files:**
   - v2 file: `path.join(__dirname, '../MotionVii_SAAP_2026_v2.xlsx')` -- for Key Results, Initiatives, Support Tasks
   - v1 file: `path.join(__dirname, '../MotionVii_SAAP_2026.xlsx')` -- for Events to Attend only

2. **Wipe OKR data** (exact code in 47-RESEARCH.md "Complete Wipe Sequence"):
   - `SET FOREIGN_KEY_CHECKS = 0`
   - Delete in order: SupportTaskKeyResult, SupportTask, Comment (all comments), null out Project.initiativeId, Initiative, KeyResult, EventToAttend
   - `SET FOREIGN_KEY_CHECKS = 1`
   - Log deletion counts

3. **Seed KeyResults** (6 records from Key Results sheet):
   - Validate headers against KR_EXPECTED_HEADERS
   - For each data row: create KeyResult with all 13 fields mapped
   - CRITICAL: Trim all strings with `.trim()` to handle trailing \r\n (Pitfall 1)
   - Build `krMap: Map<string, string>` mapping krId ("KR1.1") to cuid (database id)
   - Progress: use `parseProgress()` to handle "0%" format (Pitfall 4)
   - Budget/target: these are Decimal fields, convert with `parseFloat()` or pass as number

4. **Seed Initiatives** (37 records from Initiatives sheet):
   - Validate headers against INIT_EXPECTED_HEADERS
   - For each data row: create Initiative with keyResultId FK from krMap lookup
   - sequenceNumber: use the ID column [0] parsed as int, or auto-increment
   - keyResultId: look up row[1] (KR column, e.g. "KR1.1") in krMap. If not found, log warning and skip FK (set null)
   - objective: normalizeObjective(row[2]) -- TRIM first for \r\n
   - title: row[3]
   - department: normalizeDepartment(row[4])
   - startDate/endDate: parseExcelDate(row[5]), parseExcelDate(row[6])
   - budget: `row[7] != null ? String(row[7]) : null` (numeric -> string, Pitfall 3)
   - resources: `row[8]?.toString() || null`
   - personInCharge: normalizeTeamMember(row[9])
   - accountable: normalizeTeamMember(row[10])
   - status: normalizeStatus(row[11]) -- handles "Pending" -> NOT_STARTED (Pitfall 5)
   - position: auto-increment
   - remarks: `row[13]?.toString() || null`
   - Do NOT set monthlyObjective, weeklyTasks, kpiTarget, kpiActual, kpiUnit (removed fields)
   - Do NOT set resourcesFinancial, resourcesNonFinancial (old fields, keep null)

5. **Seed SupportTasks** (30 records from Support Tasks sheet):
   - Validate headers against ST_EXPECTED_HEADERS
   - For each data row: create SupportTask with category, task, owner, frequency, priority, notes
   - taskId: format from row[0], e.g. "ST-001" (pad to 3 digits if numeric)
   - category: normalizeSupportTaskCategory(row[1])
   - task: row[2]?.toString()
   - owner: row[4]?.toString()
   - frequency: row[5]?.toString() || null
   - priority: normalizeTaskPriority(row[6])
   - notes: row[7]?.toString() || null

6. **Seed SupportTaskKeyResult join records:**
   - After all SupportTasks are created, process the Supports column (row[3])
   - For each task, call `parseSupportsColumn(row[3], krMap, warnings)`
   - For each returned keyResultId, create SupportTaskKeyResult join entry
   - Must store the SupportTask cuid during creation to use as FK here
   - Expected: 58 total join entries (5 tasks x 6 "All KRs" = 30, 7 x 2 multi = 14, 14 x 1 single = 14)

7. **Seed EventsToAttend** from old v1 Excel file:
   - Check if v1 workbook has 'Events to Attend' sheet
   - If present: parse exactly like existing seed.ts (data starts at row index 4, same column mapping)
   - If absent: log "Events to Attend sheet not found" and continue
   - Keep ALL existing event parsing code (normalizeEventPriority, normalizeEventCategory, normalizeEventStatus, parseCost for estimatedCost)

8. **Print validation summary** (exact code pattern in 47-RESEARCH.md "Seed Validation Summary"):
   - Query counts for KeyResult, Initiative, SupportTask, SupportTaskKeyResult, EventToAttend
   - Show expected vs actual: KRs=6, Initiatives=37, SupportTasks=30, Join entries=58
   - Check for unlinked initiatives (keyResultId null)
   - Show initiatives-per-KeyResult breakdown
   - Print any accumulated warnings

**Error handling:** Wrap main() in try/catch with process.exit(1) on error, prisma.$disconnect() in finally block (same pattern as existing seed.ts).
  </action>
  <verify>
TypeScript compiles without errors:
```bash
npx tsc --noEmit prisma/seed.ts
```
If tsc does not work directly (ts-node project), verify by running the seed (Task 2).
  </verify>
  <done>prisma/seed.ts is rewritten with all 8 steps above, reads from v2 Excel for OKR data and v1 Excel for events, includes all helper functions, header validation, KR lookup map, support task join table parsing, and validation summary</done>
</task>

<task type="auto">
  <name>Task 2: Run seed and verify record counts</name>
  <files>prisma/seed.ts</files>
  <action>
Run `npx prisma db seed` and verify the output matches expected counts.

**Expected seed output:**
- 6 KeyResult records created
- 37 Initiative records created (all with valid keyResultId FK)
- 30 SupportTask records created
- 58 SupportTaskKeyResult join entries created
- EventsToAttend records created (count from old file -- existing behavior)
- Validation summary shows 0 unlinked initiatives
- No parsing warnings (or only expected ones like "Parent company" info)

**If seed fails:** Debug the error, fix the issue in seed.ts, and re-run. Common failure modes:
- Prisma type errors: check field types match schema (Decimal fields need numbers, not strings)
- FK constraint errors: ensure FK_CHECKS=0 wipe runs before inserts
- Column index errors: verify header validation output matches expected headers
- "Parent company" warning: this is expected behavior, not an error -- just skip join table entries

**After successful seed, verify with Prisma queries:**
```bash
npx prisma db execute --stdin <<< "SELECT COUNT(*) as count FROM key_results;"
npx prisma db execute --stdin <<< "SELECT COUNT(*) as count FROM initiatives;"
npx prisma db execute --stdin <<< "SELECT COUNT(*) as count FROM support_tasks;"
npx prisma db execute --stdin <<< "SELECT COUNT(*) as count FROM support_task_key_results;"
npx prisma db execute --stdin <<< "SELECT COUNT(*) as count FROM initiatives WHERE key_result_id IS NULL;"
```

Expected: 6, 37, 30, 58, 0 (zero unlinked initiatives).
  </action>
  <verify>
`npx prisma db seed` completes without errors AND database counts match: 6 KRs, 37 initiatives, 30 support tasks, 58 join entries, 0 unlinked initiatives.
  </verify>
  <done>Seed runs successfully, validation summary prints correct counts, database contains exactly 6 KeyResults, 37 Initiatives (all FK-linked), 30 SupportTasks, 58 join entries, and EventsToAttend records</done>
</task>

</tasks>

<verification>
Phase 47 is complete when ALL of the following are true:
1. `npx prisma db seed` completes with exit code 0
2. Validation summary shows: 6 KRs, 37 Initiatives, 30 SupportTasks, 58 join entries
3. Zero initiatives have null keyResultId (all linked to a valid KR)
4. SupportTasks with "Parent company" supports have zero join entries (4 tasks)
5. SupportTasks with "All KRs" supports have 6 join entries each (5 tasks)
6. EventsToAttend records are present (from old Excel file)
7. No unexpected parsing warnings in the validation summary
</verification>

<success_criteria>
- SEED-01: OKR data wiped cleanly using FK_CHECKS=0 without destroying non-OKR data
- SEED-02: 6 KeyResult records created with all fields from Key Results sheet
- SEED-03: 37 Initiative records created with keyResultId FK, budget, resources from Initiatives sheet
- SEED-04: 30 SupportTask records created with 58 join table entries from Support Tasks sheet
- SEED-05: EventsToAttend seeded from old Excel file (or gracefully skipped if absent)
- SEED-06: Validation summary printed with counts and warnings
</success_criteria>

<output>
After completion, create `.planning/phases/47-seed-script-rewrite/47-01-SUMMARY.md`
</output>
