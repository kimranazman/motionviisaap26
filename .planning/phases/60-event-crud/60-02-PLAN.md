# Plan 60-02: Event Form Modal & Card Actions

## Frontmatter

- **Phase**: 60 — Event CRUD
- **Plan**: 60-02
- **Wave**: 2
- **Depends on**: 60-01
- **Files modified**:
  - `src/components/events/event-form-modal.tsx` (new — create/edit form)
  - `src/components/events/events-view.tsx` (add button, card actions, modal wiring)
- **Autonomous**: true

## Objective

Add UI for creating, editing, and deleting events: an "Add Event" button, edit/delete buttons on event cards, a form modal for create/edit, and a delete confirmation dialog.

## Tasks

<task id="1" name="Create event form modal component">
Create `src/components/events/event-form-modal.tsx` — a Dialog-based form that handles both creating and editing events.

**Interface:**
```typescript
interface EventFormModalProps {
  open: boolean
  onOpenChange: (open: boolean) => void
  onSuccess: () => void
  event?: EventToAttend | null  // null/undefined = create mode, provided = edit mode
}
```

**Form fields** (map to EventToAttend model):
1. `name` — Input (required)
2. `priority` — Select with options: Tier 1, Tier 2, Tier 3, Energy (values: TIER_1, TIER_2, TIER_3, ENERGY) (required)
3. `category` — Select with options: Events, AI Training, Both (values: EVENTS, AI_TRAINING, BOTH) (required)
4. `eventDate` — Input type text (it's a string field, not DateTime) (required). Placeholder: "e.g. 15-17 Mar 2026"
5. `location` — Input (required)
6. `estimatedCost` — CurrencyInput component (optional)
7. `whyAttend` — Textarea (optional)
8. `targetCompanies` — Textarea (optional)
9. `actionRequired` — Input (optional)
10. `status` — Select with options: Planned, Registered, Attended, Cancelled, Skipped (values: PLANNED, REGISTERED, ATTENDED, CANCELLED, SKIPPED) (required, default PLANNED)
11. `remarks` — Textarea (optional)

**Behavior:**
- **Create mode** (no event prop): Empty form, submits POST to `/api/events-to-attend`
- **Edit mode** (event prop): Pre-fills all fields, submits PATCH to `/api/events-to-attend/{id}`
- Title: "New Event" (create) or "Edit Event" (edit)
- Submit button: "Create Event" (create) or "Save Changes" (edit)
- Reset form when modal closes
- Show error message on failure
- Call `onSuccess()` on successful submit, then close modal
- Loading spinner on submit button (Loader2)

**Layout:** Use 2-column grid for priority+category and eventDate+location pairs. Full width for textareas.

Reference patterns:
- `src/components/pipeline/deal-form-modal.tsx` for Dialog form structure
- `src/components/ui/select.tsx` for Select components
- `src/components/ui/currency-input.tsx` for CurrencyInput
</task>

<task id="2" name="Add create button and card actions to events-view">
Modify `src/components/events/events-view.tsx` to add CRUD capabilities:

**1. Add imports:**
- Import `Plus`, `Pencil`, `Trash2` from lucide-react
- Import `EventFormModal` from `./event-form-modal`
- Import `AlertDialog`, `AlertDialogAction`, `AlertDialogCancel`, `AlertDialogContent`, `AlertDialogDescription`, `AlertDialogFooter`, `AlertDialogHeader`, `AlertDialogTitle` from `@/components/ui/alert-dialog`
- Import `useRouter` from `next/navigation`

**2. Add state to EventsView:**
```typescript
const router = useRouter()
const [formOpen, setFormOpen] = useState(false)
const [editingEvent, setEditingEvent] = useState<EventToAttend | null>(null)
const [deletingEvent, setDeletingEvent] = useState<EventToAttend | null>(null)
const [isDeleting, setIsDeleting] = useState(false)
```

**3. Add "Add Event" button** in the filters row (left side, before the Select filters):
```tsx
<Button onClick={() => { setEditingEvent(null); setFormOpen(true) }}>
  <Plus className="mr-2 h-4 w-4" />
  Add Event
</Button>
```

**4. Add edit/delete action buttons to each event card:**
In the CardHeader, add a small dropdown or two icon buttons (Pencil, Trash2) for edit and delete. Use a `div` with flex layout at the top-right of the card header, alongside the existing priority badge.

Edit button: Opens form modal with event data pre-filled.
Delete button: Opens delete confirmation dialog.

```tsx
<div className="flex items-center gap-1">
  <Button
    variant="ghost"
    size="icon"
    className="h-6 w-6"
    onClick={() => { setEditingEvent(event); setFormOpen(true) }}
  >
    <Pencil className="h-3 w-3" />
  </Button>
  <Button
    variant="ghost"
    size="icon"
    className="h-6 w-6 text-red-500 hover:text-red-700"
    onClick={() => setDeletingEvent(event)}
  >
    <Trash2 className="h-3 w-3" />
  </Button>
</div>
```

**5. Add delete handler function:**
```typescript
const handleDelete = async () => {
  if (!deletingEvent) return
  setIsDeleting(true)
  try {
    const response = await fetch(`/api/events-to-attend/${deletingEvent.id}`, {
      method: 'DELETE',
    })
    if (response.ok) {
      setDeletingEvent(null)
      router.refresh()
    }
  } catch (error) {
    console.error('Failed to delete event:', error)
  } finally {
    setIsDeleting(false)
  }
}
```

**6. Add success handler:**
```typescript
const handleSuccess = () => {
  router.refresh()
}
```

**7. Render modals at bottom of component:**
- `<EventFormModal>` with open/onOpenChange/onSuccess/event props
- `<AlertDialog>` for delete confirmation (same pattern as SupplierDetailModal):
  - Title: "Delete Event"
  - Description: `Are you sure you want to delete "{event.name}"? This action cannot be undone.`
  - Cancel + Delete buttons
  - Delete button has red styling and loading state

**8. Update EventToAttend interface** to include `remarks` field (currently missing) so it can be passed to the form modal:
```typescript
interface EventToAttend {
  id: string
  priority: string
  name: string
  category: string
  eventDate: string
  location: string
  estimatedCost: number | null
  whyAttend: string | null
  targetCompanies: string | null
  actionRequired: string | null
  status: string
  remarks: string | null  // ADD THIS
}
```

Also update the events page query to include remarks in the data passed to EventsView. In `src/app/(dashboard)/events/page.tsx`, the Prisma query already returns all fields via `findMany()` without a select clause, so remarks is already included.
</task>

## Verification

- [ ] Events page shows an "Add Event" button
- [ ] Clicking "Add Event" opens an empty form modal with all fields
- [ ] Filling and submitting the form creates a new event (new event appears in grid after page refresh)
- [ ] Each event card shows edit (pencil) and delete (trash) icon buttons
- [ ] Clicking edit opens the form modal with event data pre-filled
- [ ] Editing and saving updates the event
- [ ] Clicking delete shows a confirmation dialog with event name
- [ ] Confirming delete removes the event from the list
- [ ] TypeScript compiles without errors
- [ ] Form validates required fields (name, priority, category, eventDate, location)

## Must Haves

1. "Add Event" button visible on events page
2. Form modal with all EventToAttend fields (name, priority, category, eventDate, location, estimatedCost, whyAttend, targetCompanies, actionRequired, status, remarks)
3. Edit button on each event card that opens pre-filled form
4. Delete button on each event card with confirmation dialog
5. Successful create/edit/delete refreshes the event list
