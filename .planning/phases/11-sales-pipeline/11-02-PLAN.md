---
phase: 11-sales-pipeline
plan: 02
type: execute
wave: 2
depends_on: ["11-01"]
files_modified:
  - src/components/pipeline/pipeline-board.tsx
  - src/components/pipeline/deal-form-modal.tsx
  - src/components/pipeline/deal-detail-sheet.tsx
  - src/components/pipeline/lost-reason-dialog.tsx
  - src/components/pipeline/company-select.tsx
  - src/components/pipeline/contact-select.tsx
  - src/components/pipeline/pipeline-metrics.tsx
autonomous: true

must_haves:
  truths:
    - "User can create deal with title, company, contact (optional), value (optional), and description (optional)"
    - "User can edit deal details by clicking on deal card"
    - "Moving deal to Lost prompts for reason before completing move"
    - "Pipeline metrics show total value and deal count by stage"
    - "User can delete deal with confirmation"
  artifacts:
    - path: "src/components/pipeline/deal-form-modal.tsx"
      provides: "Create deal modal with company/contact selection"
      exports: ["DealFormModal"]
    - path: "src/components/pipeline/deal-detail-sheet.tsx"
      provides: "Edit deal slide-out sheet"
      exports: ["DealDetailSheet"]
    - path: "src/components/pipeline/lost-reason-dialog.tsx"
      provides: "Alert dialog for Lost stage reason capture"
      exports: ["LostReasonDialog"]
    - path: "src/components/pipeline/pipeline-metrics.tsx"
      provides: "Stage value and count summary bar"
      exports: ["PipelineMetrics"]
  key_links:
    - from: "src/components/pipeline/pipeline-board.tsx"
      to: "src/components/pipeline/lost-reason-dialog.tsx"
      via: "state pendingLostDeal triggers dialog"
      pattern: "pendingLostDeal.*LostReasonDialog"
    - from: "src/components/pipeline/deal-form-modal.tsx"
      to: "/api/deals"
      via: "POST on form submit"
      pattern: "fetch.*api/deals.*POST"
    - from: "src/components/pipeline/contact-select.tsx"
      to: "/api/companies/[id]"
      via: "fetch contacts when company changes"
      pattern: "fetch.*api/companies"
---

<objective>
Add deal CRUD operations, Lost stage reason capture, and pipeline metrics.

Purpose: Complete the sales pipeline feature by enabling users to create and edit deals, capture reasons when deals are lost, and view pipeline value summaries. This fulfills the remaining Phase 11 requirements.

Output: Full deal management UI with create modal, edit sheet, lost reason prompt, and metrics bar.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-sales-pipeline/11-RESEARCH.md
@.planning/phases/11-sales-pipeline/11-01-SUMMARY.md

# Existing patterns to follow
@src/components/companies/company-detail-modal.tsx
@src/components/companies/industry-combobox.tsx
@src/components/kanban/initiative-detail-sheet.tsx
@src/components/ui/alert-dialog.tsx
@src/components/ui/command.tsx
@src/components/ui/sheet.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create deal form modal with company/contact selection</name>
  <files>
    src/components/pipeline/company-select.tsx
    src/components/pipeline/contact-select.tsx
    src/components/pipeline/deal-form-modal.tsx
    src/components/pipeline/pipeline-board.tsx
  </files>
  <action>
Create company and contact selection components, then the deal form modal:

**src/components/pipeline/company-select.tsx:**
- Adapt from industry-combobox.tsx pattern using shadcn Command component
- Props: value (companyId), onValueChange, disabled
- Fetch companies from /api/companies on mount
- Display company name, searchable
- Return selected companyId

**src/components/pipeline/contact-select.tsx:**
- Similar to company-select but receives contacts as prop (not fetched)
- Props: value (contactId), onValueChange, contacts array, disabled
- Disable when no contacts available
- Display "(No contacts)" placeholder when empty

**src/components/pipeline/deal-form-modal.tsx:**
- Use Dialog from shadcn
- Props: open, onOpenChange, onSuccess (callback with new deal)
- Form fields:
  - Title (required, Input)
  - Company (required, CompanySelect) - when changed, clear contact and fetch contacts
  - Contact (optional, ContactSelect) - disabled until company selected
  - Value (optional, Input type number, step 0.01)
  - Description (optional, Textarea)
- On company change: fetch /api/companies/{id} to get contacts, store in state
- On submit: POST to /api/deals, call onSuccess with response, close modal
- Handle loading state, validation errors

**Update src/components/pipeline/pipeline-board.tsx:**
- Add "Add Deal" button in header (top right, Button with Plus icon)
- Add state for modal: isCreateModalOpen
- Render DealFormModal
- onSuccess: Add new deal to deals state (will appear in Lead column)
  </action>
  <verify>
1. Click "Add Deal" button - modal opens
2. Company dropdown loads companies from database
3. Select company - contact dropdown becomes enabled and shows company contacts
4. Submit with title and company - deal created, appears in Lead column
5. Form validates required fields (title, company)
  </verify>
  <done>
Users can create new deals via modal with company/contact cascading selection. New deals automatically appear in Lead stage.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add deal detail sheet, lost reason dialog, and pipeline metrics</name>
  <files>
    src/components/pipeline/deal-detail-sheet.tsx
    src/components/pipeline/lost-reason-dialog.tsx
    src/components/pipeline/pipeline-metrics.tsx
    src/components/pipeline/pipeline-board.tsx
    src/components/pipeline/pipeline-card.tsx
  </files>
  <action>
Create the remaining UI components:

**src/components/pipeline/deal-detail-sheet.tsx:**
- Use Sheet from shadcn (side="right", similar to initiative-detail-sheet)
- Props: deal (full deal object or null), open, onOpenChange, onUpdate, onDelete
- Display deal details in editable form (same fields as create modal)
- Include stage indicator (Badge with stage color from pipeline-utils)
- Show lostReason field only when stage is LOST
- Save changes via PATCH to /api/deals/{id}
- Delete button with AlertDialog confirmation
- Include company/contact selection with same cascading behavior
- Call onUpdate with updated deal on save
- Call onDelete on successful deletion

**src/components/pipeline/lost-reason-dialog.tsx:**
- Use AlertDialog from shadcn
- Props: open, onConfirm (reason: string), onCancel
- Textarea for reason input
- "Confirm" button calls onConfirm with reason
- "Cancel" button calls onCancel
- Title: "Deal Lost"
- Description: "Please provide a reason for marking this deal as lost."

**src/components/pipeline/pipeline-metrics.tsx:**
- Props: deals array
- Calculate per-stage: count and total value (sum of non-null values)
- Display horizontal bar with stage columns showing:
  - Stage name with color dot
  - Deal count
  - Total value (formatted with formatCurrency, or "-" if 0)
- Exclude Won/Lost from "open pipeline" total, show separately
- Style: Compact bar above Kanban board, light background

**Update src/components/pipeline/pipeline-board.tsx:**
- Add selectedDeal and isSheetOpen state
- When PipelineCard clicked: setSelectedDeal, setIsSheetOpen(true)
- Render DealDetailSheet with handlers
- Add pendingLostDeal state for Lost interception
- In handleDragEnd: If target stage is LOST, set pendingLostDeal and return early (don't complete move)
- Render LostReasonDialog when pendingLostDeal is set
- onConfirm: Complete the move with lostReason, call reorder API with lostReason field
- onCancel: Clear pendingLostDeal, revert visual position if needed
- Render PipelineMetrics above the board
- Handle onUpdate: update deal in deals state
- Handle onDelete: remove deal from deals state

**Update src/components/pipeline/pipeline-card.tsx:**
- Add onClick prop, call it when card clicked (not during drag)
- Use onPointerDown stopPropagation pattern for click vs drag distinction
  </action>
  <verify>
1. Click on deal card - detail sheet opens with deal info
2. Edit deal title in sheet, save - title updates in card
3. Delete deal from sheet - confirmation dialog, then deal removed from board
4. Drag deal to Lost column - Lost reason dialog appears
5. Enter reason and confirm - deal moves to Lost, reason saved
6. Cancel lost dialog - deal returns to original position
7. Metrics bar shows count and value per stage
8. Refresh page - all changes persisted
  </verify>
  <done>
Full deal management: edit via slide-out sheet, delete with confirmation, Lost stage prompts for reason, metrics bar displays pipeline values.
  </done>
</task>

</tasks>

<verification>
After both tasks complete:
1. "Add Deal" button creates new deals in Lead stage
2. Clicking deal opens edit sheet
3. Deals can be edited (title, company, contact, value, description)
4. Deals can be deleted with confirmation
5. Dragging to Lost prompts for reason before completing
6. Lost deals show their reason in detail sheet
7. Metrics bar shows count and total value per stage
8. All changes persist after page refresh
9. TypeScript compiles without errors
</verification>

<success_criteria>
- PIPE-02: User can create deal with title, description, value, company, and contact (COMPLETE)
- PIPE-03 (full): User can drag deal between stages including Lost with reason prompt (COMPLETE)
- PIPE-04: User can edit deal details (COMPLETE)
- PIPE-05: User can delete deal with confirmation (COMPLETE)
- PIPE-07: When deal moves to Lost, user prompted for lost reason (COMPLETE)
- PIPE-08: User can view pipeline metrics - total value by stage, deal count (COMPLETE)
</success_criteria>

<output>
After completion, create `.planning/phases/11-sales-pipeline/11-02-SUMMARY.md`
</output>
