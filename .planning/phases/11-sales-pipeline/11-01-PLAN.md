---
phase: 11-sales-pipeline
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/app/(dashboard)/pipeline/page.tsx
  - src/app/api/deals/route.ts
  - src/app/api/deals/[id]/route.ts
  - src/app/api/deals/reorder/route.ts
  - src/components/pipeline/pipeline-board.tsx
  - src/components/pipeline/pipeline-column.tsx
  - src/components/pipeline/pipeline-card.tsx
  - src/lib/pipeline-utils.ts
  - src/components/layout/sidebar.tsx
autonomous: true

must_haves:
  truths:
    - "User sees deals organized in Kanban columns by stage (Lead, Qualified, Proposal, Negotiation, Won, Lost)"
    - "User can drag deals between stages"
    - "Deal cards show title, value, company name, and contact name"
    - "Pipeline navigation appears in sidebar under CRM section"
  artifacts:
    - path: "src/app/(dashboard)/pipeline/page.tsx"
      provides: "Pipeline page with server-fetched deals"
      min_lines: 20
    - path: "src/components/pipeline/pipeline-board.tsx"
      provides: "DndContext with 6 stage columns"
      exports: ["PipelineBoard"]
    - path: "src/components/pipeline/pipeline-column.tsx"
      provides: "Droppable column component"
      exports: ["PipelineColumn"]
    - path: "src/components/pipeline/pipeline-card.tsx"
      provides: "Sortable deal card component"
      exports: ["PipelineCard"]
    - path: "src/app/api/deals/reorder/route.ts"
      provides: "Batch update for position and stage"
      exports: ["PATCH"]
  key_links:
    - from: "src/components/pipeline/pipeline-board.tsx"
      to: "/api/deals/reorder"
      via: "fetch in handleDragEnd"
      pattern: "fetch.*api/deals/reorder"
    - from: "src/app/(dashboard)/pipeline/page.tsx"
      to: "prisma.deal.findMany"
      via: "server component data fetch"
      pattern: "prisma\\.deal\\.findMany"
---

<objective>
Create the Sales Pipeline Kanban board with drag-and-drop functionality.

Purpose: Enable users to visually track deals through 6 stages (Lead, Qualified, Proposal, Negotiation, Won, Lost) using a familiar Kanban interface. This is the core UI for the sales pipeline feature.

Output: Working Kanban board at /pipeline with draggable deal cards, stage columns, and optimistic updates.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-sales-pipeline/11-RESEARCH.md

# Existing patterns to follow
@src/components/kanban/kanban-board.tsx
@src/components/kanban/kanban-column.tsx
@src/components/kanban/kanban-card.tsx
@src/app/api/initiatives/reorder/route.ts
@src/components/layout/sidebar.tsx
@prisma/schema.prisma
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Deal API routes and pipeline utilities</name>
  <files>
    src/app/api/deals/route.ts
    src/app/api/deals/[id]/route.ts
    src/app/api/deals/reorder/route.ts
    src/lib/pipeline-utils.ts
  </files>
  <action>
Create API routes for deals following the companies API pattern:

**src/app/api/deals/route.ts:**
- GET: Fetch all deals ordered by stage then position, include company (name) and contact (name)
- POST: Create deal with title, description, value, companyId, contactId (optional). Auto-assign to LEAD stage with next position. Require title and companyId.
- Use requireAuth for GET, requireEditor for POST

**src/app/api/deals/[id]/route.ts:**
- GET: Single deal with company and contact
- PATCH: Update deal fields (title, description, value, companyId, contactId, stage, lostReason). Update stageChangedAt when stage changes.
- DELETE: Delete deal (no linked record check needed for deals)
- Use requireAuth for GET, requireEditor for PATCH/DELETE

**src/app/api/deals/reorder/route.ts:**
- PATCH: Accept { updates: [{ id, position, stage?, lostReason? }] }
- Use Prisma $transaction for batch update
- Update stageChangedAt when stage changes
- Follow initiatives/reorder pattern exactly

**src/lib/pipeline-utils.ts:**
- Export STAGES array: [{ id: 'LEAD', title: 'Lead', colorDot: 'bg-gray-400' }, { id: 'QUALIFIED', title: 'Qualified', colorDot: 'bg-blue-400' }, { id: 'PROPOSAL', title: 'Proposal', colorDot: 'bg-purple-400' }, { id: 'NEGOTIATION', title: 'Negotiation', colorDot: 'bg-amber-400' }, { id: 'WON', title: 'Won', colorDot: 'bg-green-500' }, { id: 'LOST', title: 'Lost', colorDot: 'bg-red-400' }]
- Export formatDealStage(stage: string): string for display labels
- Export getStageColor(stage: string): string for badge colors
  </action>
  <verify>
Run TypeScript check: `npx tsc --noEmit`
Test API with curl:
- `curl http://localhost:3000/api/deals` returns 200 with empty array
- `curl -X POST http://localhost:3000/api/deals -H "Content-Type: application/json" -d '{"title":"Test Deal","companyId":"<valid-id>"}' returns 201
  </verify>
  <done>
Deal CRUD API routes exist and handle all operations. Pipeline utilities export stage configuration.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Pipeline Kanban components and page</name>
  <files>
    src/components/pipeline/pipeline-board.tsx
    src/components/pipeline/pipeline-column.tsx
    src/components/pipeline/pipeline-card.tsx
    src/app/(dashboard)/pipeline/page.tsx
    src/components/layout/sidebar.tsx
  </files>
  <action>
Create pipeline components by adapting existing Kanban patterns:

**src/components/pipeline/pipeline-column.tsx:**
- Copy kanban-column.tsx structure
- Props: id, title, colorDot, count, children
- Use useDroppable from @dnd-kit/core
- Add value total display (sum of deals in column)

**src/components/pipeline/pipeline-card.tsx:**
- Adapt from kanban-card.tsx but simpler (no quick actions menu yet)
- Props: deal (id, title, value, company, contact), onClick, isDragging
- Use useSortable from @dnd-kit/sortable
- Display: title (primary), value in green if exists, company name with Building2 icon, contact name with User icon if exists
- Use formatCurrency from lib/utils for value display
- Respect canEdit from useSession for drag enable/disable

**src/components/pipeline/pipeline-board.tsx:**
- Adapt from kanban-board.tsx structure
- Import STAGES from lib/pipeline-utils
- Use DndContext with same collision detection pattern
- Simpler than initiatives board - no filters, no swimlane view, no date filtering
- handleDragEnd: Calculate new positions, optimistic update, POST to /api/deals/reorder
- Map deals by stage, render PipelineColumn for each stage with SortableContext
- Include DragOverlay with PipelineCard

**src/app/(dashboard)/pipeline/page.tsx:**
- Server component that fetches deals from prisma.deal.findMany
- Include company (id, name) and contact (id, name)
- Order by stage, position
- Render Header with title "Sales Pipeline" and description "Track deals through stages"
- Render PipelineBoard with initialData

**src/components/layout/sidebar.tsx:**
- Add "Pipeline" link under CRM section (after Companies)
- Use PanelLeftIcon from lucide-react (or Funnel for pipeline metaphor)
- href="/pipeline"
  </action>
  <verify>
1. Navigate to http://localhost:3000/pipeline - page loads without errors
2. Sidebar shows Pipeline link under CRM section
3. Create a test deal via API, refresh page - card appears in Lead column
4. Drag deal from Lead to Qualified - card moves, refresh confirms persistence
  </verify>
  <done>
Pipeline page displays Kanban board with 6 stage columns. Deals can be dragged between stages with optimistic updates and persistence. Pipeline navigation appears in sidebar.
  </done>
</task>

</tasks>

<verification>
After both tasks complete:
1. Pipeline page accessible at /pipeline
2. Six columns visible: Lead, Qualified, Proposal, Negotiation, Won, Lost
3. Deals display with title, value (formatted as currency), company name, contact name
4. Drag and drop works between columns
5. Position and stage changes persist after refresh
6. TypeScript compiles without errors
7. Sidebar shows Pipeline under CRM section
</verification>

<success_criteria>
- PIPE-01: User can view deals in Kanban board by stage (COMPLETE)
- PIPE-03 (partial): User can drag deal between stages (drag works, but Lost reason prompt is in Plan 02)
- Deals display company and contact associations
- Navigation integrates with existing CRM section
</success_criteria>

<output>
After completion, create `.planning/phases/11-sales-pipeline/11-01-SUMMARY.md`
</output>
