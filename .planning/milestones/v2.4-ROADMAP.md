# Milestone v2.4: Settings, Sidebar & Bug Fixes

**Status:** SHIPPED 2026-01-28
**Phases:** 68-71
**Total Plans:** 8

## Overview

Fix sidebar settings persistence bugs, add nested Company/Departments/Contacts sidebar links, sidebar drag-and-drop reordering, allow task creation on completed projects, configure internal project field visibility, and fix dashboard revenue accuracy.

## Phases

### Phase 68: Sidebar Fixes & Quick Wins

**Goal**: Users can reliably hide sidebar items and see accurate dashboard revenue, with task creation working on completed projects
**Depends on**: Nothing (first phase of v2.4)
**Plans**: 2 plans

Plans:
- [x] 68-01: Sidebar bug fixes — remove autoReveal, add Save button with dirty detection and toast
- [x] 68-02: Fix dashboard revenue accuracy, verify task CRUD on completed projects

**Requirements**: SIDE-01, SIDE-02, SIDE-03, SIDE-04, SIDE-05, REV-01, REV-02, REV-03, REV-04, TASK-01, TASK-02, TASK-03

**Success Criteria**:
1. User hides a nav item in Settings, clicks Save, and the item stays hidden across all page navigations and browser refreshes
2. Save button appears only when sidebar visibility state has unsaved changes, and a toast confirms successful save
3. Dashboard CRM Revenue KPI shows the sum of per-project `revenue ?? potentialRevenue` for ACTIVE and COMPLETED projects without double-counting
4. User can create tasks and subtasks on projects with COMPLETED status, and can edit existing tasks on those projects

### Phase 69: Nested Sidebar Links

**Goal**: Users can navigate to Departments and Contacts via nested sub-items under Companies in the sidebar
**Depends on**: Phase 68
**Plans**: 2 plans

Plans:
- [x] 69-01: Nav config & sidebar nested rendering — extend NavItem with children, split click zones
- [x] 69-02: Settings page nested display — indentation, cascade hide logic

**Requirements**: NEST-01, NEST-02, NEST-03, NEST-04, NEST-05, NEST-06, NEST-07

**Success Criteria**:
1. Companies nav item shows an expand/collapse chevron; clicking the label navigates to /companies while clicking the chevron toggles sub-items
2. Companies parent is highlighted when the user is on /companies, /departments, or /contacts
3. Sub-items can be individually hidden via Settings, and hiding parent hides all sub-items
4. Mobile sidebar renders nested items with same hierarchy and behavior
5. Settings page shows nested items with visual indentation under parent

### Phase 70: Sidebar Drag-and-Drop Reorder

**Goal**: Users can personalize sidebar navigation order by dragging items within groups on the Settings page
**Depends on**: Phase 69
**Plans**: 2 plans

Plans:
- [x] 70-01: Nav order backend & hook — navItemOrder field, API extension, hook support
- [x] 70-02: Settings DnD UI & sidebar order rendering — @dnd-kit sortable, reset order, dirty detection

**Requirements**: REORD-01, REORD-02, REORD-03, REORD-04, REORD-05, REORD-06, REORD-07

**Success Criteria**:
1. Settings page shows drag handles on nav items and user can drag to reorder within a group
2. Custom order persists per-user across sessions and sidebar renders in saved order
3. Reset Order button restores default order from nav-config.ts
4. New nav items added in future deploys appear at end for users with custom order

### Phase 71: Internal Project Field Config

**Goal**: Admin can control which fields are visible on internal projects via a system-wide configuration
**Depends on**: Nothing (independent of sidebar chain)
**Plans**: 2 plans

Plans:
- [x] 71-01: Internal field config backend — schema, types, API, hook
- [x] 71-02: Internal field config UI & integration — settings toggles, form/detail conditional rendering

**Requirements**: INTL-01, INTL-02, INTL-03, INTL-04, INTL-05, INTL-06

**Success Criteria**:
1. Admin settings shows toggles for internal project fields with sensible defaults
2. Configuration stored in AdminDefaults (system-wide)
3. Project form and detail view dynamically hide configured fields for internal projects

---

## Milestone Summary

**Key Decisions:**
- Removed autoReveal entirely rather than restricting it — cleaner solution
- Batch save pattern for sidebar settings instead of fire-and-forget per-toggle
- NavItem children array for nesting rather than separate config structure
- DndContext per nav group to prevent cross-group drags without axis modifiers
- GET internal-fields uses requireAuth (not requireAdmin) since all users need read access
- Toggle "checked" = "hidden" for intuitive admin UX in field config

**Issues Resolved:**
- Sidebar autoReveal bug causing hidden items to reappear on navigation
- Dashboard revenue double-counting / inaccuracy with potentialRevenue
- No save feedback on sidebar settings changes

**Issues Deferred:**
- Unsaved changes browser prompt (SIDE-V2-01)
- Live sidebar drag reorder (SIDE-V2-02)
- Revenue breakdown tooltip (REV-V2-01)
- Per-user field visibility overrides (INTL-V2-01)

**Technical Debt Incurred:**
- None identified

---

_For current project status, see .planning/ROADMAP.md_
