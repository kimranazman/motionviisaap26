# Milestone v2.8: AI Analyze Button

**Status:** SHIPPED 2026-01-29
**Phases:** 80-83
**Total Plans:** 5

## Overview

Add a UI button in the header that triggers Claude Code's /ai-analyze command on the Mac via SSH from the NAS deployment. Admin-only, with pending count badge, dropdown menu, and hybrid polling for completion feedback.

## Phases

### Phase 80: SSH Setup & Test

**Goal**: Verify NAS can SSH to Mac and run Claude without password prompt.
**Depends on**: None (infrastructure prerequisite)
**Plans**: 1 plan

Plans:
- [x] 80-01: SSH Setup Documentation

**Details:**
Manual infrastructure setup phase. Created documentation for SSH setup between NAS Docker container and Mac. Detected Mac IP (192.168.100.148), documented environment variables (MAC_SSH_HOST, MAC_SSH_USER, MAC_PROJECT_PATH), updated deployment.md with setup instructions.

---

### Phase 81: Pending Count API Enhancement

**Goal**: Extend /api/ai/pending to return granular counts for badge display.
**Depends on**: None
**Plans**: 1 plan

Plans:
- [x] 81-01: Enhance Pending API with Granular Counts

**Details:**
Extended `/api/ai/pending` endpoint to return counts by type: costs (with supplierId but no normalizedItem), invoices (PENDING status), receipts (PENDING status), deliverables (projects with invoices but no aiExtracted deliverables), and total. All queries run in parallel via Promise.all().

---

### Phase 82: AI Trigger API (SSH to Mac)

**Goal**: Create endpoint that SSHs to Mac and runs Claude /ai-analyze command.
**Depends on**: Phase 80 (SSH must work)
**Plans**: 1 plan

Plans:
- [x] 82-01: AI Trigger API Endpoint

**Details:**
Created POST /api/ai/trigger endpoint. Accepts type parameter (all, costs, invoice, receipt, deliverables). Admin-only via requireAdmin(). SSHs to Mac using MAC_SSH_HOST, MAC_SSH_USER, MAC_PROJECT_PATH environment variables. Runs Claude command in background via nohup. Returns 202 Accepted on success, 500 with descriptive error on SSH failure.

---

### Phase 83: AiAnalyzeButton Component

**Goal**: Create header button with dropdown, badge, and polling.
**Depends on**: Phase 81 (pending counts), Phase 82 (trigger API)
**Plans**: 2 plans

Plans:
- [x] 83-01: Create AiAnalyzeButton Component
- [x] 83-02: Integrate AiAnalyzeButton into Header

**Details:**
Created AiAnalyzeButton component with Sparkles icon, badge showing total pending count, dropdown menu with analysis options (All, Costs, Invoices, Receipts, Deliverables) each showing their count. Hybrid polling: after trigger, polls /api/ai/pending every 15s for up to 90s. Success toast when count decreases, info toast on timeout. Integrated into header for admin users only.

---

## Milestone Summary

**Key Decisions:**
- SSH to Mac approach (vs running Claude on NAS) - simpler initial implementation
- Fire-and-forget trigger with polling - avoids long-running HTTP requests
- 15s poll interval, 90s max - balance between responsiveness and server load

**Issues Resolved:**
- None

**Issues Deferred:**
- Run Claude directly on NAS (FUT-01) - requires Docker Claude Code setup
- Real-time log streaming (FUT-02) - fire-and-forget is sufficient for now
- Analysis history (FUT-03) - not needed for 3-person team

**Technical Debt Incurred:**
- SSH setup is manual (Phase 80) - infrastructure prerequisite outside application code

---

*For current project status, see .planning/ROADMAP.md*
