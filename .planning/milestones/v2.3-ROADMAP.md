# Milestone v2.3: CRM & UX Improvements

**Status:** SHIPPED 2026-01-28
**Phases:** 62-67
**Total Plans:** 13

## Overview

v2.3 is a consolidation milestone that fixes persistent UX bugs, expands CRM browsing with standalone entity pages, adds missing CRUD entry points, introduces internal project support, enables sidebar personalization, and adds line item pricing history. Six phases deliver these features in dependency order: modal fixes first (every feature renders in modals), then additive CRM pages, independent task creation, the high-impact internal project schema change, sidebar customization (after nav config is stable), and finally the most complex integration -- line item pricing.

## Phases

### Phase 62: Modal Scroll + Expand Fixes

**Goal**: Users can scroll through all modal content and expand any detail view to a full page
**Depends on**: Nothing (first phase -- fixes foundation before building on it)
**Plans**: 2 plans

Plans:
- [x] 62-01: Fix Modal Scroll in All Detail Views (DialogContent overflow-hidden, drawer flex-col)
- [x] 62-02: Fix Expand-to-Page for Detail Views (full-page project detail rewrite)

**Details:**
Changed DialogContent from overflow-y-auto to overflow-hidden so Radix ScrollArea handles scrolling. Added flex-col to mobile drawer. Rewrote project detail page from modal-on-empty-page to a proper card-based full page layout.

### Phase 63: Standalone CRM Pages

**Goal**: Users can browse, filter, and manage departments and contacts as standalone pages without navigating through company detail
**Depends on**: Phase 62 (detail modals must scroll correctly before adding new modal content)
**Plans**: 3 plans

Plans:
- [x] 63-01: API Routes + Sidebar Navigation (departments/contacts APIs, nav config)
- [x] 63-02: Departments Page + Detail Modal (table, search, company filter, create, detail modal)
- [x] 63-03: Contacts Page + Detail Modal (table, cascading filters, create, detail modal)

**Details:**
Created standalone /departments and /contacts pages with server components, client list components with search and filtering, create dialogs, and detail modals with inline editing and related entity display. Cascading company/department filters on contacts page.

### Phase 64: Task Creation on /tasks

**Goal**: Users can create tasks directly from the cross-project /tasks page
**Depends on**: Nothing (independent feature)
**Plans**: 2 plans

Plans:
- [x] 64-01: Add Task Dialog with Project Selector (ProjectSelect combobox, all-projects data flow, Add Task dialog)
- [x] 64-02: Subtask Creation from Task Detail View (inline subtask title input, depth validation)

**Details:**
Created searchable ProjectSelect combobox component. Added "Add Task" button to /tasks toolbar with dialog requiring project selection. Added inline subtask creation in task detail sheet with Enter/Escape keyboard shortcuts and depth validation.

### Phase 65: Internal Project Flag

**Goal**: Users can create and manage internal projects (Motionvii / Talenta) without an external company
**Depends on**: Phase 63 (CRM pages stable before schema change that makes companyId nullable)
**Plans**: 2 plans

Plans:
- [x] 65-01: Schema + API for Internal Projects (isInternal, internalEntity fields, nullable companyId, type filter)
- [x] 65-02: UI for Internal Projects (creation form toggle, badges, type filter tabs, detail views)

**Details:**
Added isInternal boolean and internalEntity string to Project model. Made companyId nullable. Updated all APIs for type filtering and internal project support. Added Internal badge to cards and detail views. Fixed 26+ files for null-safe company access.

### Phase 66: Customizable Sidebar Navigation

**Goal**: Users can personalize which sidebar links are visible
**Depends on**: Phase 63 (nav config must include new Departments and Contacts items before customization)
**Plans**: 2 plans

Plans:
- [x] 66-01: Schema + API + Nav Visibility Hook (hiddenNavItems field, preferences API, useNavVisibility hook)
- [x] 66-02: Sidebar Filtering + Settings UI (desktop/mobile filtering, auto-reveal, Settings toggle card)

**Details:**
Added hiddenNavItems JSON field to UserPreferences. Created useNavVisibility hook with isVisible, toggleItem, and autoReveal functions. Filtered both desktop and mobile sidebars. Added Settings page card with grouped Switch toggles. Dashboard and Settings always visible.

### Phase 67: Line Item Pricing History

**Goal**: Users can track and compare item pricing with quantity and unit price detail
**Depends on**: Phase 65 (all schema changes settled before adding more fields)
**Plans**: 2 plans

Plans:
- [x] 67-01: Schema + Cost CRUD + AI Import (quantity/unitPrice fields, CostForm auto-calc, CostCard display, receipt extraction)
- [x] 67-02: Pricing History Views (PricingTabs, By-Item with stats, By-Client with spend, renamed from Price Comparison)

**Details:**
Added quantity and unitPrice Decimal fields to Cost model. CostForm auto-calculates amount from qty x unitPrice. AI receipt import extracts and persists quantity/unitPrice. Created /api/pricing-history endpoint with by-item and by-client views. Replaced Price Comparison page with three-tab Pricing History page.

---

## Milestone Summary

**Key Decisions:**
- DialogContent overflow-hidden (let ScrollArea handle scrolling, not the dialog itself)
- Full-page project detail rewrite (card-based layout vs modal-on-empty-page)
- Cascading filters for contacts (company -> department cascading selection)
- isPrimary contact transaction handling (unset all, set one atomically)
- ProjectSelect combobox for task creation (searchable, follows CompanySelect pattern)
- canAddSubtask depth validation (hide button at max nesting level 5)
- Nullable companyId for internal projects (schema-level support)
- Internal entity as string field (MOTIONVII/TALENTA values)
- hiddenNavItems as JSON field (array of href strings)
- ALWAYS_VISIBLE_HREFS constant (Dashboard and Settings cannot be hidden)
- autoReveal on direct navigation (hidden items auto-show when URL accessed)
- Quantity/unitPrice as optional Decimal fields (backward compatible)
- Price Comparison renamed to Pricing History (broader scope with tabs)

**Issues Resolved:**
- Modal scroll conflict between DialogContent overflow-y-auto and Radix ScrollArea
- Project expand-to-page showing modal-on-empty-page instead of dedicated page
- No standalone way to browse departments and contacts outside company detail
- No task creation entry point on cross-project /tasks page
- Internal projects required selecting an external company
- Sidebar navigation was fixed (no customization possible)
- Cost entries lacked quantity and unit price detail

**Issues Deferred:**
- Contact quick-search in header (CRM-V2-01, deferred to v2.4+)
- Bulk contact import via CSV (CRM-V2-02, deferred to v2.4+)
- Drag-to-reorder sidebar items (NAV-V2-01, deferred to v2.4+)
- Pricing trend visualization (PRICE-V2-01, deferred to v2.4+)

**Technical Debt Incurred:**
- Used `prisma db push` instead of `prisma migrate dev` (shadow database permission issue)
- Pre-existing unused Badge import in contact-list.tsx (fixed during Phase 67)

---

_For current project status, see .planning/ROADMAP.md_
