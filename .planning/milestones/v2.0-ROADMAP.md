# Milestone v2.0: OKR Restructure & Support Tasks

**Status:** SHIPPED 2026-01-27
**Phases:** 46-53
**Total Plans:** 13

## Overview

Promote KeyResult from a free-text string to a first-class tracked entity with metrics, add support task management with KR linkage, reseed from updated Excel, and add a revenue target dashboard widget. The build follows a strict schema-first, seed-second, UI-last order because every downstream phase depends on the data model and seeded data. Phases 49-51 are parallelizable once the foundation (46-48) is in place.

**Phases:** 8 (46-53)
**Depth:** Quick
**Coverage:** 40/40 requirements mapped

## Phases

### Phase 46: Schema Migration

**Goal:** Database supports the full OKR hierarchy (Objective > KeyResult > Initiative) and support task model with all required fields, enums, and relations.
**Depends on:** None (foundation phase)
**Plans:** 1 plan

Plans:
- [x] 46-01-PLAN.md -- Add KeyResult, SupportTask, SupportTaskKeyResult models + enums, modify Initiative, push to DB

**Details:**
- Requirements: SCHEMA-01, SCHEMA-02, SCHEMA-03, SCHEMA-04, SCHEMA-05, SCHEMA-06, SCHEMA-07, SCHEMA-08
- Success: `prisma db push` applies cleanly; KeyResult, SupportTask, SupportTaskKeyResult models created; Initiative gains keyResultId FK and budget/resources; KPI fields removed
- Pitfalls: C3 (MariaDB drift loop), C4 (KPI field removal)

---

### Phase 47: Seed Script Rewrite

**Goal:** Running `npx prisma db seed` populates the database with all OKR data from the v2 Excel file (6 KRs, 37 initiatives, 30 support tasks, events) with correct FK linkages.
**Depends on:** Phase 46
**Plans:** 1 plan

Plans:
- [x] 47-01-PLAN.md -- Rewrite seed.ts to parse v2 Excel (KeyResults, Initiatives, SupportTasks + join table) and v1 Excel (Events), with validation summary

**Details:**
- Requirements: SEED-01, SEED-02, SEED-03, SEED-04, SEED-05, SEED-06
- Success: 6 KR, 37 Initiative, 30 SupportTask records; 59 join table entries; "All KRs" handling; validation summary
- Pitfalls: C2 (cascade deletes), H2 ("All KRs" parsing), M5 (delimiter inconsistency)

---

### Phase 48: API Layer + Utilities

**Goal:** Application has working CRUD endpoints for KeyResults and SupportTasks, updated initiative endpoints, real revenue dashboard stats, and utility functions that group/calculate using the new relational model.
**Depends on:** Phase 47
**Plans:** 3 plans

Plans:
- [x] 48-01-PLAN.md -- Create KeyResult CRUD and SupportTask list API routes (3 new files)
- [x] 48-02-PLAN.md -- Fix initiative routes and export to remove deleted field references, use keyResultId FK
- [x] 48-03-PLAN.md -- Fix dashboard revenue, rewrite grouping utility, stub KPI utility, add KR progress utility

**Details:**
- Requirements: API-01, API-02, API-03, API-04, UTIL-01, UTIL-02, UTIL-03
- Success: KR CRUD + SupportTask list APIs; Initiative routes updated for FK; dashboard revenue from KR actuals; FK-based grouping; weighted objective rollup
- Pitfalls: H3 (grouping breakage)

---

### Phase 49: OKR Hierarchy UI

**Goal:** Users see the objectives page with real KR-level metrics (target, actual, progress bar, status, owner) instead of aggregated initiative KPIs, with simplified initiative rows and updated forms.
**Depends on:** Phase 48
**Parallelizable with:** Phase 50, Phase 51
**Plans:** 3 plans

Plans:
- [x] 49-01-PLAN.md -- Overhaul objectives page: KR metrics display, objective rollup progress, simplified initiative rows
- [x] 49-02-PLAN.md -- Update initiative forms and detail views: KR dropdown, budget/resources, remove KPI
- [x] 49-03-PLAN.md -- Update kanban/calendar/timeline views: keyResult string-to-FK migration, full build verification

**Details:**
- Requirements: UI-OKR-01, UI-OKR-02, UI-OKR-03, UI-OKR-04, UI-OKR-05, UI-OKR-06, UI-OKR-07
- Success: KR row metrics from model; weighted objective rollup; simplified initiative rows; KR dropdown in forms; all 22+8 files migrated
- Pitfalls: C1 (22-file string-to-FK migration), C4 (8-file KPI removal), M2 (stale KPI aggregation)

---

### Phase 50: Support Tasks UI

**Goal:** Users can view and filter all 30 support tasks grouped by category, see which KRs each task supports, and navigate to support tasks from the sidebar.
**Depends on:** Phase 48
**Parallelizable with:** Phase 49, Phase 51
**Plans:** 1 plan

Plans:
- [x] 50-01-PLAN.md -- Support tasks page with category grouping, filtering, KR badge links, and sidebar navigation

**Details:**
- Requirements: UI-ST-01, UI-ST-02, UI-ST-03, UI-ST-04
- Success: /support-tasks page with 4 categories; category filter; sidebar nav entry; clickable KR badges

---

### Phase 51: Revenue Target Widget

**Goal:** Dashboard shows a revenue target widget displaying RM1,000,000 total target with Events (RM800K) and AI Training (RM200K) breakdown, using real KR actual values.
**Depends on:** Phase 48
**Parallelizable with:** Phase 49, Phase 50
**Plans:** 1 plan

Plans:
- [x] 51-01-PLAN.md -- Create revenue-target widget component, register in widget registry, wire data flow from server component

**Details:**
- Requirements: UI-REV-01, UI-REV-02
- Success: RM1M total target widget with Events/AI Training breakdown; registered in widget registry with EDITOR role restriction

---

### Phase 52: Cleanup & Polish

**Goal:** Codebase has no dead code from the v1.5 KPI/string-keyResult system, export reflects the new data model, and all file migrations are verified complete.
**Depends on:** Phase 49, Phase 50, Phase 51
**Plans:** 2 plans

Plans:
- [x] 52-01-PLAN.md -- Delete dead code (initiative-kpi-utils.ts, kpi-progress-bar.tsx), remove deprecated resourcesFinancial/resourcesNonFinancial fields, update export KR column to show description
- [x] 52-02-PLAN.md -- Comprehensive migration audit: verify all 32 Appendix A+B files migrated, full Next.js build verification

**Details:**
- Requirements: CLEAN-01, CLEAN-02, CLEAN-03
- Success: No remaining KPI/keyResult-as-string references; export has correct columns; all 30 files verified migrated

---

### Phase 53: Timeline Enhancements

**Goal:** Timeline gantt chart supports drag-to-edit dates, displays full initiative titles, and defaults to Objective > KeyResult grouping hierarchy.
**Depends on:** Phase 52
**Plans:** 1 plan

Plans:
- [x] 53-01-PLAN.md -- Extend PATCH API for dates, remove title truncation, add objective/KR grouping hierarchy, implement drag-to-edit bars

**Details:**
- Requirements: TIMELINE-01, TIMELINE-02, TIMELINE-03
- Success: Drag center to shift dates, drag edges to resize; full titles; Objective > KR default grouping
- Pitfalls: Click vs drag discrimination (3px threshold), permission gating (canEdit check)

---

## Milestone Summary

**Key Decisions:**
- Used `prisma db push` not `prisma migrate dev` (Rationale: Avoids MariaDB FK drift loop)
- String owner fields on KeyResult/SupportTask (Rationale: Owners may include team names)
- KeyResult.id is cuid string, not Int (Rationale: Prisma @default(cuid()) convention)
- KPI utils stubbed during Phase 48, deleted in Phase 52 (Rationale: Gradual migration)
- Server pages flatten keyResult to string for list/kanban (Rationale: Zero client interface changes)
- 'kri' category for revenue-target widget (Rationale: Avoids updating WidgetDefinition union)
- 3px drag threshold for click vs drag discrimination (Rationale: Preserves Link navigation)
- Drag handles conditional on canEdit (Rationale: Consistent with kanban edit gating)

**Issues Resolved:**
- 22-file keyResult string-to-FK migration completed systematically across all views
- 8-file KPI field removal completed with verified replacements
- MariaDB FK drift loop avoided by using db push instead of migrate dev
- "All KRs" support task parsing handled with KR lookup map
- Export column count updated from 20 to 17 (removed KPI, added budget/resources/accountable)

**Issues Deferred:**
- Seed validation summary hardcodes "expected: 58" join entries but actual is 59 (cosmetic)
- Export utils comment says "20 columns" but actual count is 17 (stale comment)

**Technical Debt Incurred:**
- None significant. All stubs created during transition were resolved in Phase 52.

---

_For current project status, see .planning/MILESTONES.md_

---
*Archived: 2026-01-27*
*Milestone: v2.0 OKR Restructure & Support Tasks*
