# Milestone v1.2: CRM & Project Financials

**Status:** SHIPPED 2026-01-22
**Phases:** 9-15
**Total Plans:** 13

## Overview

Add sales pipeline and project tracking with cost breakdowns to forecast revenue and calculate net profit.

## Phases

### Phase 9: Foundation

**Goal**: Database schema supports CRM and project financials
**Depends on**: Nothing (first phase of v1.2)
**Plans**: 1 plan

Plans:
- [x] 09-01-PLAN.md - Add CRM and project financials schema to database

**Details:**
- Added 7 CRM/project models to Prisma schema: Company, Contact, Deal, PotentialProject, Project, Cost, CostCategory
- Added 3 enums: DealStage, PotentialStage, ProjectStatus
- All currency fields use Decimal(12,2) for precision
- CostCategory seeded with 6 categories (Labor, Materials, Vendors, Travel, Software, Other)

### Phase 10: Companies & Contacts

**Goal**: Users can manage companies and their contacts
**Depends on**: Phase 9
**Plans**: 2 plans

Plans:
- [x] 10-01-PLAN.md - Company list, detail modal, inline editing, search/filter
- [x] 10-02-PLAN.md - Contact cards in company modal, CRUD, primary designation

**Details:**
- Extended Company model with website, address, phone fields
- Extended Contact model with isPrimary field for primary contact designation
- Created full CRUD API for companies with search and industry filter
- Built company list page with table, search, and industry filter dropdown
- Implemented inline editing pattern with auto-save on blur
- Created industry combobox that allows presets OR custom values
- Contact management within company modal with star toggle for primary

### Phase 11: Sales Pipeline

**Goal**: Users can track new business deals through stages
**Depends on**: Phase 10
**Plans**: 2 plans

Plans:
- [x] 11-01-PLAN.md - Pipeline Kanban board with deal API routes and drag-and-drop
- [x] 11-02-PLAN.md - Deal CRUD modals, Lost reason prompt, and pipeline metrics

**Details:**
- Deal CRUD API with GET/POST/PATCH/DELETE and reorder endpoint
- Pipeline Kanban board with 6 stages (Lead, Qualified, Proposal, Negotiation, Won, Lost)
- Deal cards display title, value (formatted currency), company name, contact name
- Stage columns show deal count and total value
- Drag-and-drop with optimistic updates and server persistence
- Lost stage interception prompts for reason before completing move
- Pipeline metrics bar shows open pipeline value and per-stage count/value

### Phase 12: Potential Projects

**Goal**: Users can track repeat client opportunities
**Depends on**: Phase 10
**Plans**: 1 plan

Plans:
- [x] 12-01-PLAN.md - PotentialProject Kanban board with CRUD and drag-and-drop

**Details:**
- Built Kanban board with Potential, Confirmed, Cancelled columns
- Full CRUD operations via API routes
- Drag-and-drop stage transitions with position persistence
- Metrics bar showing open pipeline value and per-stage counts
- Reused CompanySelect and ContactSelect from pipeline components

### Phase 13: Projects & Conversion

**Goal**: Projects can be created from deals, potentials, or directly
**Depends on**: Phase 11, Phase 12
**Plans**: 3 plans

Plans:
- [x] 13-01-PLAN.md - Project CRUD and direct creation with KRI linking
- [x] 13-02-PLAN.md - Deal/Potential to Project auto-conversion on stage change
- [x] 13-03-PLAN.md - Company detail page with related deals, potentials, projects

**Details:**
- Full Project CRUD via API routes with proper auth guards
- Projects page with status filter tabs (All/Draft/Active/Completed/Cancelled)
- Direct project creation with company, contact, revenue, and optional KRI link
- Project detail sheet with inline editing, status dropdown, and source display
- Auto-conversion: Deal to WON creates linked Project
- Auto-conversion: Potential to CONFIRMED creates linked Project
- Company detail shows related deals, potentials, and projects (limited to 5 most recent)

### Phase 14: Project Costs

**Goal**: Users can track project costs and see profit
**Depends on**: Phase 13
**Plans**: 2 plans

Plans:
- [x] 14-01-PLAN.md - Cost CRUD infrastructure and reusable components
- [x] 14-02-PLAN.md - Integrate costs into project detail with profit calculation

**Details:**
- Cost CRUD API routes with category selection
- CostForm and CostCard components for adding/editing costs
- Financial Summary section with Revenue (green), Total Costs (red), Profit (blue/orange) cards
- Automatic total and profit recalculation when costs change
- Categories: Labor, Materials, Vendors, Travel, Software, Other

### Phase 15: Dashboard Widgets

**Goal**: Dashboard shows pipeline and financial summaries
**Depends on**: Phase 14
**Plans**: 2 plans

Plans:
- [x] 15-01-PLAN.md - Pipeline widgets (stage chart, open pipeline, weighted forecast, win rate)
- [x] 15-02-PLAN.md - Revenue and profit widgets

**Details:**
- Added STAGE_PROBABILITY and STAGE_CHART_COLORS constants for pipeline calculations
- Created getCRMDashboardData function with Prisma aggregations for pipeline metrics
- Built CRMKPICards component displaying 6 KPIs: Open Pipeline, Weighted Forecast, Win Rate, Total Deals, Revenue, Profit
- Built PipelineStageChart component with horizontal bar chart and custom tooltip
- Revenue counts completed projects only; profit shows blue (positive) or orange (negative)

---

## Milestone Summary

**Key Decisions:**
- List view with status tabs (not Kanban) for projects since status is lifecycle not pipeline
- CompanySelect fetches on mount; ContactSelect receives contacts as prop for efficiency
- Lost reason capture uses AlertDialog modal on drag interception
- Interactive transaction for auto-conversion (project creation + source linking atomic)
- STAGE_PROBABILITY: Lead 10%, Qualified 25%, Proposal 50%, Negotiation 75%
- Win rate calculated from closed deals only (Won + Lost)

**Issues Resolved:**
- Fixed DATABASE_URL port in .env (3308 to 3307) to match DEPLOYMENT.md
- Added ESLint disable comment for unused request parameter in GET handlers
- Added missing shadcn Label component for forms

**Technical Debt Incurred:**
- Toast notifications use console.log (Sonner not installed) - cosmetic, defer to v1.3

---

*For current project status, see .planning/PROJECT.md*
