---
milestone: v1.3.2
audited: 2026-01-24T05:15:00Z
status: gaps_found
scores:
  requirements: 8/9
  phases: 1/1
  integration: 4/6
  flows: 3/4
gaps:
  requirements:
    - CONV-01: Conversion badge not visible on initial page load (project relation missing from server query)
  integration:
    - pipeline/page.tsx: Missing project include in Prisma query
    - potential-projects/page.tsx: Missing project include in Prisma query
  flows:
    - "Deal Conversion Visibility: Badge not rendered on initial load, only after archive toggle"
tech_debt: []
---

# Milestone v1.3.2: Conversion Visibility & Archive Audit Report

**Milestone Goal:** Show conversion status on deals/potentials with links to converted projects, display estimate vs actual variance, make converted items read-only, and add archive system to reduce clutter.

**Audited:** 2026-01-24T05:15:00Z
**Status:** ⚠ GAPS FOUND

## Scores Summary

| Category | Score | Status |
|----------|-------|--------|
| Requirements | 8/9 | PARTIAL |
| Phases | 1/1 | PASS |
| Integration | 4/6 | GAPS |
| E2E Flows | 3/4 | PARTIAL |

## Phase Verification

### Phase 27: Conversion Visibility & Archive

**Status:** VERIFIED (9/9 truths from phase-level verification)
**Plans:** 3/3 complete

Phase-level verification passed all criteria, but integration check found issue with page-level queries that affects initial page load.

## Requirements Coverage

| Requirement | Status | Notes |
|-------------|--------|-------|
| CONV-01 | ⚠ PARTIAL | Badge logic correct, but missing project relation in server query breaks initial page load |
| CONV-02 | ✓ SATISFIED | `/projects?open={id}` navigation works correctly |
| CONV-03 | ✓ SATISFIED | Variance correctly compares deal.value/estimatedValue vs project.revenue |
| CONV-04 | ✓ SATISFIED | `isConverted` and `isLost` flags disable all inputs |
| CONV-05 | ✓ SATISFIED | Both deals and potentials have identical conversion visibility |
| ARCH-01 | ✓ SATISFIED | API supports isArchived PATCH |
| ARCH-02 | ✓ SATISFIED | WHERE clause filters out archived by default |
| ARCH-03 | ✓ SATISFIED | Toggle button with URL sync and data refetch |
| ARCH-04 | ✓ SATISFIED | Unarchive button toggles to restore items |

**Unsatisfied:** 1 requirement
**Satisfied:** 8 requirements

## Critical Gap: Project Relation Missing from Page Queries

### Issue Description

The server-side page queries in `pipeline/page.tsx` and `potential-projects/page.tsx` do **NOT** include the `project` relation in their Prisma queries. The API routes correctly include it, but the initial data loaded by the page does not.

**Impact:**
- On initial page load, `deal.project` and `potentialProject.project` are undefined
- Conversion badges (`{deal.project && deal.stage === 'WON'}`) won't render
- After user toggles "Show Archived", client fetches via API which DOES include project, and conversion badges appear

### Evidence

**`/src/app/(dashboard)/pipeline/page.tsx` lines 18-25:**
```typescript
include: {
  company: { select: { id: true, name: true } },
  contact: { select: { id: true, name: true } },
  // MISSING: project relation
},
```

**`/src/app/(dashboard)/potential-projects/page.tsx` lines 18-25:**
```typescript
include: {
  company: { select: { id: true, name: true } },
  contact: { select: { id: true, name: true } },
  // MISSING: project relation
},
```

### Required Fix

Add `project` relation to include clause in both files:

```typescript
include: {
  company: { select: { id: true, name: true } },
  contact: { select: { id: true, name: true } },
  project: {                    // ADD THIS
    select: {
      id: true,
      title: true,
      revenue: true,
      potentialRevenue: true,
    },
  },
},
```

Also need to serialize Decimal values from project (revenue, potentialRevenue) like the API routes do.

## E2E Flow Analysis

### Flow 1: Deal Conversion Visibility — ⚠ BROKEN ON INITIAL LOAD

| Step | Status | Details |
|------|--------|---------|
| Deal exists with stage=WON and projectId | ✓ | Schema and data correct |
| API route includes project relation | ✓ | deals/route.ts lines 26-32 |
| pipeline-card.tsx has badge logic | ✓ | Lines 198-207 |
| deal-detail-sheet.tsx has View Project | ✓ | Lines 332-379 |
| Page query includes project relation | ✗ | **MISSING** - badges only appear after toggle |

### Flow 2: Potential Conversion Visibility — ⚠ BROKEN ON INITIAL LOAD

| Step | Status | Details |
|------|--------|---------|
| Potential exists with stage=CONFIRMED and projectId | ✓ | Schema and data correct |
| API route includes project relation | ✓ | potential-projects/route.ts lines 26-32 |
| potential-card.tsx has badge logic | ✓ | Lines 198-207 |
| potential-detail-sheet.tsx has View Project | ✓ | Lines 328-376 |
| Page query includes project relation | ✗ | **MISSING** - badges only appear after toggle |

### Flow 3: Archive Deal/Potential/Project — ✓ COMPLETE

All archive functionality works end-to-end:
- Toggle buttons in board headers
- URL sync with data refetch
- isArchived filter in queries
- Archive/Unarchive buttons with toast feedback
- Archived badge displays on cards
- Drag disabled for archived items

### Flow 4: View Project Navigation — ✓ COMPLETE

- View Project button uses `/projects?open=${id}`
- projects/page.tsx accepts `open` query param
- project-list.tsx opens detail sheet on mount

## Cross-Phase Wiring

### Phase 26 → Phase 27 (potentialRevenue field)

| Connection | Status |
|------------|--------|
| Schema: potentialRevenue field exists | ✓ |
| API: deals/route.ts includes in project select | ✓ |
| API: potential-projects/route.ts includes in project select | ✓ |
| UI: deal-detail-sheet accesses potentialRevenue | ✓ |
| UI: potential-detail-sheet accesses potentialRevenue | ✓ |
| UI: FinancialsSummary uses potentialRevenue | ✓ |

## Human Verification Notes

The following tests from phase verification still require manual testing:

1. **Conversion Badge Visual Test** - Verify green badge with arrow appears (will fail until fix applied)
2. **View Project Navigation Test** - Click "View Project" navigates correctly
3. **Variance Calculation Test** - Verify color-coded variance display
4. **Read-Only Mode Test** - Verify disabled inputs on converted items
5. **Archive Toggle Test** - Verify items appear/disappear with toggle
6. **Unarchive Test** - Verify unarchive flow works

## Recommendation

**Fix the gap before completing milestone:**

The missing project relation is a straightforward fix (2 files, add project include). This affects core functionality (CONV-01: conversion badges not visible on initial load).

Run `/gsd:plan-milestone-gaps` to create a fix phase, or manually fix the two page files.

---

*Audited: 2026-01-24T05:15:00Z*
*Auditor: Claude (gsd-integration-checker)*
